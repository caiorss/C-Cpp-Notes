<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-05-04 Tue 19:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux and Unix system programming</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="Linux, unix and posix system programming"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux and Unix system programming</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org783dbfe">1. Unix System Programming focused on Linux</a>
<ul>
<li><a href="#org196ae04">1.1. Overview</a>
<ul>
<li><a href="#org66be6a8">1.1.1. Unix-like Operating Systems</a></li>
<li><a href="#org1e13b1c">1.1.2. Common Features of Unix-like Operating Systems</a></li>
<li><a href="#org6ddc5c7">1.1.3. Components of Linux-based operating systems (Linux Distros)</a></li>
</ul>
</li>
<li><a href="#org4a7e7e2">1.2. Command Line Essentials</a>
<ul>
<li><a href="#orge16e3e1">1.2.1. Overview</a></li>
<li><a href="#orgbaeda78">1.2.2. Fundamentals</a></li>
<li><a href="#orgfec5a63">1.2.3. Creating files and directories from command line</a></li>
<li><a href="#orgc0604f8">1.2.4. Files and executables</a></li>
<li><a href="#orga38ae7e">1.2.5. System information</a></li>
</ul>
</li>
<li><a href="#org8edca68">1.3. Widely used functions for strings and buffers in low level codes</a></li>
<li><a href="#orgc712d24">1.4. Map of user-space APIs of Unix-like Operating Systems</a></li>
<li><a href="#orgf426ad2">1.5. Creating Portable Binaries for Linux / GLIBC Dependency Hell</a>
<ul>
<li><a href="#org38fe854">1.5.1. Overview</a></li>
<li><a href="#orgf3d7e7e">1.5.2. The GLIBC Problem</a></li>
<li><a href="#orgaa0a25d">1.5.3. Solution 1 - via linking against older GLIBC</a></li>
<li><a href="#orga8e92b7">1.5.4. Solution 2 - via linking against MUSL libC</a></li>
<li><a href="#org31415b3">1.5.5. Portable binary using Golang</a></li>
</ul>
</li>
<li><a href="#orgeea53f9">1.6. Fully Statically linked executables for embedded Linux systems</a>
<ul>
<li><a href="#org4859d7f">1.6.1. Overview</a></li>
<li><a href="#org495b4a8">1.6.2. Project Files</a></li>
<li><a href="#org3b95b67">1.6.3. Building and running</a></li>
</ul>
</li>
<li><a href="#org9450e62">1.7. Creating command line applications with CLI11 C++ Library</a>
<ul>
<li><a href="#orgc65b120">1.7.1. Overview</a></li>
<li><a href="#orgd52d06f">1.7.2. Sample application with multiple sub-comamnds</a></li>
</ul>
</li>
<li><a href="#org78b2665">1.8. System information via virtual file systems</a>
<ul>
<li><a href="#orgad2f14b">1.8.1. Overview</a></li>
<li><a href="#orgf4a682a">1.8.2. Sample Code</a></li>
<li><a href="#org1292d5e">1.8.3. Running</a></li>
</ul>
</li>
<li><a href="#org40314f8">1.9. Disk Space Usage on Linux and BSD-variants</a></li>
<li><a href="#org8275a2d">1.10. Low level open, read, write, close - IO sycalls overview</a></li>
<li><a href="#orgd220f65">1.11. Low level IO - read() syscall</a></li>
<li><a href="#org638348e">1.12. Low level IO - open(), read(), write() syscall functions</a></li>
<li><a href="#org171870a">1.13. Low level IO - creat()</a></li>
<li><a href="#org7a84944">1.14. Reading/Listings directory contents</a></li>
<li><a href="#orge522a69">1.15. Process Inputs, Outputs and States and PROCFS on Linux</a></li>
<li><a href="#orga0452c5">1.16. Information about file permissions, owner and group - fstat and stat syscalls</a>
<ul>
<li><a href="#org01493b8">1.16.1. Overview</a></li>
<li><a href="#org65cbf08">1.16.2. Sample code</a></li>
</ul>
</li>
<li><a href="#org7ca3572">1.17. Information about current process</a></li>
<li><a href="#org6ed645a">1.18. Dynamic Loading Shared Libraries / dlopen() API</a>
<ul>
<li><a href="#orgb660424">1.18.1. Overview</a></li>
<li><a href="#org515d9dc">1.18.2. GTK3/GTK2 GUI using dynamic loading - low level</a></li>
<li><a href="#org7244c5c">1.18.3. GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</a></li>
</ul>
</li>
<li><a href="#org41ea4ec">1.19. Library calls hooking/interception with LD_PRELOAD</a>
<ul>
<li><a href="#org6da7f85">1.19.1. Overview</a></li>
<li><a href="#org0db7d4d">1.19.2. Intercepting open() and fopen() library calls</a></li>
<li><a href="#org71ee415">1.19.3. Intercepting dlopen() library calls</a></li>
</ul>
</li>
<li><a href="#org394982e">1.20. Launching processes with exec and fork system-call wrappers</a></li>
<li><a href="#org7ae26fb">1.21. Reading subprocess output via Popen()</a></li>
<li><a href="#orgb4e4a45">1.22. Unix Pipes - Inter Process Communication</a></li>
<li><a href="#org9096607">1.23. Monitor file system changes with Inotify API</a>
<ul>
<li><a href="#orgfecc012">1.23.1. Overview</a></li>
<li><a href="#orga74b544">1.23.2. Sample code</a></li>
</ul>
</li>
<li><a href="#org8021256">1.24. mmap - Memory Mapping</a>
<ul>
<li><a href="#org1011bbe">1.24.1. Overview</a></li>
<li><a href="#org64e002d">1.24.2. Example (C) - mmap for reading Windows PE32 files</a></li>
<li><a href="#orgfb4c6ee">1.24.3. Example (C++) - mmap for reading Windows PE32 files</a></li>
<li><a href="#orgf1e13c7">1.24.4. Example (C++) - mmap for reading Windows PE32 with class</a></li>
<li><a href="#org5688fea">1.24.5. Example - mmap - Running machine code at runtime</a></li>
</ul>
</li>
<li><a href="#org0a8395a">1.25. POSIX Shared Memory</a>
<ul>
<li><a href="#org4fa900a">1.25.1. Overview</a></li>
<li><a href="#orgcde77bc">1.25.2. Sample Code</a></li>
</ul>
</li>
<li><a href="#org254ec69">1.26. Syslog - System Message Logging</a>
<ul>
<li><a href="#org8be5677">1.26.1. Overview</a></li>
<li><a href="#orgb62098c">1.26.2. Usage example</a></li>
</ul>
</li>
<li><a href="#org1de310c">1.27. Sockets - TCP/IP and Unix Domain Sockets</a>
<ul>
<li><a href="#org561a6af">1.27.1. Overview</a></li>
<li><a href="#org0300261">1.27.2. BSD Socket API</a></li>
<li><a href="#org09ab76a">1.27.3. Network Programming Pitfalls [DRAFT]</a></li>
<li><a href="#orge5a4bd2">1.27.4. Command Line Tools for Network Debugging</a></li>
<li><a href="#org917df03">1.27.5. Simple TCP/IP client socket</a></li>
<li><a href="#orgc2d2902">1.27.6. Simple TCP/IP socket echo server</a></li>
<li><a href="#org632e784">1.27.7. Simple Unix-domain socket echo server</a></li>
<li><a href="#org754849d">1.27.8. Telnet-like application</a></li>
<li><a href="#org512a4a5">1.27.9. Telnet-like application with pseudo-terminal devices</a></li>
</ul>
</li>
<li><a href="#org18084eb">1.28. Sockets with SSL/TSL - Secure Communication</a>
<ul>
<li><a href="#org4a92c9c">1.28.1. Overview</a></li>
<li><a href="#org24d42aa">1.28.2. Open SSL commands</a></li>
<li><a href="#orgd9c4eab">1.28.3. TCP/IP Client Socket with TLS (OpenSSL)</a></li>
</ul>
</li>
<li><a href="#orgf142a6a">1.29. Sockets with Multiplexed IO APIs (poll, epoll) [DRAFT]</a>
<ul>
<li><a href="#org118b0b3">1.29.1. Overview</a></li>
<li><a href="#orgc3c8776">1.29.2. Poll()  multiplexed IO API</a></li>
<li><a href="#org27c17c3">1.29.3. Poll() sample code</a></li>
<li><a href="#org30f3247">1.29.4. Epoll() multiplexed IO API</a></li>
<li><a href="#org8ac500d">1.29.5. Epoll() example - sample code</a></li>
</ul>
</li>
<li><a href="#orgac516b7">1.30. Ptrace - system call</a>
<ul>
<li><a href="#org627ee36">1.30.1. Overview</a></li>
<li><a href="#orga63cca8">1.30.2. Linux Ptrace-related functions</a></li>
<li><a href="#org8b46cbf">1.30.3. Example - trace system calls of a running process</a></li>
</ul>
</li>
<li><a href="#orgb2afd46">1.31. X11 - X Windows System</a>
<ul>
<li><a href="#org49a82e5">1.31.1. Overview</a></li>
<li><a href="#org0d5c703">1.31.2. X11 Utilities</a></li>
<li><a href="#org8a7b935">1.31.3. Setting  keyboard mode via setxkbmap</a></li>
<li><a href="#orgf3e27a1">1.31.4. Sample X11 Window via Xlib</a></li>
<li><a href="#orge29ac61">1.31.5. Query X11 information via Xlib</a></li>
<li><a href="#org4bfbcce">1.31.6. Further reading and references</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-org783dbfe" class="outline-2">
<h2 id="org783dbfe"><span class="section-number-2">1</span> Unix System Programming focused on Linux</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org196ae04" class="outline-3">
<h3 id="org196ae04"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org66be6a8" class="outline-4">
<h4 id="org66be6a8"><span class="section-number-4">1.1.1</span> Unix-like Operating Systems</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Unix-like operating system are a family of operating system based on
the AT&amp;T Unix operating system, developed in the 1970's by <a href="https://en.m.wikipedia.org/wiki/Ken_Thompson">Ken Thompson</a>, 
<a href="https://en.m.wikipedia.org/wiki/Dennis_Ritchie">Dennis Ritchie</a> and others. Later AT&amp;T licensed Unix to third-party
vendors, what lead to many proprietary Unix variants. 
</p>

<p>
<b>Some Unix-like operating systems are</b>
</p>

<p>
<span class="underline">Desktop or Server</span>
</p>

<ul class="org-ul">
<li><b>Linux-based or GNU-Linux based</b> operating systems.  (Note: Linux is
NOT an operating system, it is just the kernel.) Although, the
kernel is an essential component of an O.S., it is useless on its
own, without all the additional supporting software such as: the
GNU userland tools, bootloaders (Grub, Syslinux, Das U-boot),
X11 - Windows Systems and so on. Some GNU-Linux operating systems
are:  Debian Linux; Ubuntu Linux; Fedora Linux; Centos Linux;
Gentoo Linux; Arch Linux and more.
<ul class="org-ul">
<li>Somes places where Linux-based operating system is found:
<ul class="org-ul">
<li>Data centers</li>
<li>Most cloud virtualized servers.</li>
<li>Super Computers for HPC - High Performance Computing</li>
<li>HPC clusters - High Performance Computing cluster</li>
<li>Some embedded systems with network connectivity such as: high
end routers - wifi access point; security cameras; payment
terminals; network printers and so on.</li>
<li>Billions of mobile devices since Andoid is also based on Linux Kernel.</li>
<li>Desktop computers of enthusiasts.</li>
</ul></li>
<li>Advantages:
<ul class="org-ul">
<li>Largest server and cloud virtual machines install-base.</li>
<li>Best hardware support among Unix-like operating systems.</li>
<li>Largest open source community.</li>
<li>Good support from embedded systems vendors.</li>
<li>Transparency: the system exposes many of its internals as
virtual-file systems, which only exist on the main memory
(volatile memory).</li>
<li>Stable and well documented system-calls.</li>
<li>The kernel receives significant contribution from many large
companies, such as Intel, AMD, Nvidia, Red Hat, IBM, Google,
Linar, Samsung and so on.</li>
</ul></li>
<li>Drawbacks:
<ul class="org-ul">
<li><span class="underline">GLIBC</span> - The GLIBC, which that encapsulates kernel system calls
and implements basic C functions, such as memcpy and strcpy,
which is relied by almost all applications, does not expose
all kernel system call. Other significant problem, is the lack
of backward compatibility as GLIBC has breaking changes on
every release, as a result native code applications or native
executables may not work when moved or copied to other Linux
machines.</li>
<li><span class="underline">Lack of C API for many functionalities</span> =&gt; Unlike other
Unix-like operating systems and BSD-variants, Linux kernel
lacks user-space C APIs (subroutines) for many of its
functionalities. Instead of exposing these facilities as C
APIs through the GlibC library, the kernel exposes them as
virtual-file systems. For instance, instead of providing an
user-space API (C subroutine) for listing all processes, the
kernel exposes all processes via /proc virtual file system,
which allows user-space applications to query process
information just by reading and parsing files. Besides process
information API, the Cgroups functionality also lcaks a
user-space C API, instead it only has a virtual file system
API.</li>
<li><span class="underline">Fragmentation</span> among Linux distributions which makes
harder to develop software for Linux-based systems as every
distribution has different versions of GLIBC, different
versions of shared libraries and different package
managers. The fragmentation could be reduced if Linux
distributions could share binaries without recompilation and
applications were developed in a self-contained way.</li>
<li><span class="underline">Dependency hell</span>: On most Linux distributions, it is only
possible to install a single version of some application from
package managers. Applications are also installed in a
scattered way on many directories, for instance executables on
/bin, /usr/bin, libraries on /lib, /lib64 and so on. If one
install an application that relies on shared libraries newer
from the ones installed on the system and the older libraries
are overriden, applications relying on the older libraries may
no longer work as the symbols which they need may no longer be
available on the newer libraries.</li>
</ul></li>
</ul></li>
</ul>


<ul class="org-ul">
<li><span class="underline">Mac OSX</span> / Apple Inc. (Desktop-only) [BSD Variant]
<ul class="org-ul">
<li>Most successful and widespread Unix-like operating system on
Desktop. MacOSX is based on NeXTSETEP operating system, which is
derived from BSD Unix (BSD - Berkley Software Distribution) and
Mach Kernel, created at Carnegie Mellon University. Even though
the graphics stack is built on top of Objective-C, MacOSX still
shares a great deal of user-space APIs (Application Programming
Interfaces) with BSD derived operating systems, such as: basic
Unix system calls, open(), read(), write(); KQueue and poll() io
multiplexing; pthread - POSIX threads and so on.</li>
<li>Advantages:
<ul class="org-ul">
<li>One of the best graphical user interfaces among Unix-like
operating systems; consistent UX - user experience; high level
GUI graphical user interface stack, that does not rely on X11.
Unlike other unix-like, which applications are installed with
files scattered in many different directories such as /bin,
/lib, /usr/lib and so on, MacOSX uses self-contained
applications app bundles, which are directories ending with
.app suffix containing the application and executables and all
dependencies in a single directory. App bundles allows
installation by dragging and dropping its folder to the
/Applications directory and uninstall by just removing the app
bundle directory.</li>
</ul></li>
<li>Drawbacks:
<ul class="org-ul">
<li>Proprietary.</li>
<li>Operating system is bundled with the hardware. A potential user cannot
choose his or her own hardware.</li>
<li>Not allowed to be virtualized on the cloud on non-Apple
hardware.</li>
<li>Little care about backward and forward compatibility,
applications that works today, may not work tomorrow without
active maintenance as the operating system vendor is not
afraid of breaking backward compatibility.</li>
</ul></li>
</ul></li>
</ul>


<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/FreeBSD">FreeBSD</a>
<ul class="org-ul">
<li>Unix-style operating system based on Unix BSD (Berkeley Software
Distribution). Unlike Linux, the FreeBSD is a full-featured
operating system, with almost everything maintained by the same
team. Some noteworthy features of FreeBSD are: BSD permissive
license; the high quality <span class="underline">network stack</span> that still outmatches
Linux one, for instance BSD was used by Whatsapp, Yahoo and
Netflix; <a href="https://en.wikipedia.org/wiki/PF_(firewall)">PF - Firewall</a> - Packet Filter firewall; <a href="https://en.wikipedia.org/wiki/ZFS">ZFS</a> highly
reliable and scalable file system; <a href="https://en.wikipedia.org/wiki/Kqueue">kqueue</a> scalable IO
multiplexing API; full-featured documentation; <a href="https://en.wikipedia.org/wiki/Ports_collection">Ports collection</a>;
<a href="https://en.m.wikipedia.org/wiki/FreeBSD_jail">BSD Jails</a> sandboxing which is similar to Docker and other Linux
containers; <a href="https://wiki.freebsd.org/bhyve">bhyve</a> - hypervisor for visualization; own userland
tooling; <a href="https://www.freebsd.org/doc/handbook/linuxemu.html">Linux Emulation</a> - FreeBSD is able to run Linux native
executables without recompilation via system call emulation;
more cohesive and less fragmented than Linux-systems as
everything is almost maintained by the same team.</li>
<li>Potential Problems: less hardware support than GNU/Linux
systems; smaller community; less corporate support and less
developers than Linux, for instance Linux Kernel often receives
signifcant contribution from large companies such as Red Hat,
IBM, Intel, Nvidia, Qualcom and so on; SVN version control
system (note: FreeBDS is slowly moving to GIT). The hardware
compatibility drawback that affects Desktop is not significant
for usage of FreeBDS on server machines or on cloud virtual
machines.</li>
<li>See:
<ul class="org-ul">
<li><a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/index.html">FreeBSD Handbook</a> for end-users.</li>
<li><a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/developers-handbook/index.html">FreeBSD Developers' Handbook</a></li>
<li><a href="https://www.leidinger.net/blog/2010/09/28/the-freebsd-linuxulator-explained-for-users/">The FreeBSD-linuxulator explained (for users)</a></li>
<li><a href="https://papers.freebsd.org/2019/fosdem/looney-netflix_and_freebsd/">Netflix and FreeBSD - Using Open Source to Deliver Streaming Video</a></li>
<li><a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=mtm5ndi">Sony's PlayStation 4 Is Running Modified FreeBSD 9 - Phoronix</a></li>
</ul></li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/OpenBSD">OpenBSD</a> - Similar to FreeBSD, but with security-aware design.</li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/DragonFly_BSD">DragonFly BSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a> - Open source small operating system created for teaching
about operating system concepts and designed to be understandable
by a single person.</li>

<li><a href="https://en.wikipedia.org/wiki/OpenIndiana">OpenIndiana</a> - Derived from Illumos operating system, which is a
fork of Sun Microsystem's Open Solaris.</li>

<li><a href="https://www.redox-os.org/">Redox-OS</a> (Written in Rust language) - "Redox is a Unix-like
Operating System written in Rust, aiming to bring the innovations
of Rust to a modern microkernel and full set of applications."
<ul class="org-ul">
<li>Unlike, Linux and other Unix-like flavours, Redox-OS has its own
graphical user interface, which is not based on x11 - X Windows
System.</li>
</ul></li>

<li><a href="https://dahliaos.io/">Dahlia OS (dahaliaOS)</a> - Operating system based on GNU/Linux and
Google's (Alphabet Inc) Fuchsia OS, which one of the main
noteworthy feature is the capability-based security.</li>

<li><a href="https://9p.io/plan9/about.html">Plan 9 (Bell Labs)</a> [EXPERIMENTAL] - "Plan 9 from Bell Labs is a
experimental operating system developed at Bell Labs at 1980s by
Ken Thompson, Rob Pike, Dave Presotto, and Phil
Winterbottom. Plan9 takes the concept of "everything is a file" to
the next level. What sets Plan9 apart from other Unix variants is
that "everything is almost a file", sockets are represented as
files in PROCFS file system; GUI - graphical user interfaces are
also represented as files.
<ul class="org-ul">
<li>See: <a href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">Plan 9 from Bell Labs - Wikipedia</a></li>
</ul></li>

<li><a href="https://bitbucket.org/inferno-os/inferno-os/src/master/">Inferno-OS</a> (Plan-9 variant) [EXPERIMENTAL] - "Inferno® is a
distributed operating system, originally developed at Bell Labs,
but now developed and maintained by Vita Nuova® as Free
Software. Applications written in Inferno's concurrent programming
language, Limbo, are compiled to its portable virtual machine code
(Dis), to run anywhere on a network in the portable environment
that Inferno provides. Unusually, that environment looks and acts
like a complete operating system. Inferno represents services and
resrouces in a file-like name hiearchy. Programs access them using
only the file operations open, read/write, and close. `Files' are
not just stored data, but represent devices, network and protocol
interfaces, dynamic data sources, and services."</li>
</ul>

<p>
<span class="underline">Server or Mainframes</span> (mostly discontinued)
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Solaris_(operating_system)">Solaris</a> (from Sun Microsystems)</li>

<li><a href="https://en.m.wikipedia.org/wiki/Z/OS">z/OS</a> / IBM - Unix-variant for mainframes.</li>

<li>AIX / IBM</li>

<li><a href="https://en.m.wikipedia.org/wiki/HP-UX">HP-UX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/IRIX">IRIX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Xenix">Xenix</a> - Discontinued Microsoft Unix variant.</li>
</ul>

<p>
<span class="underline">Mobile (touch devices)</span>
</p>

<ul class="org-ul">
<li><b>Android</b> (Linux-based OS, but without GPL on the userland).
<ul class="org-ul">
<li>Unlike Desktop Linux distributions, Android uses the C runtime
library <a href="https://en.wikipedia.org/wiki/Bionic_(software)">bionic</a>, derived from BSD, instead of GLIBC. Other
significant differences is that Android does not uses <a href="https://en.wikipedia.org/wiki/X_Window_System">X11</a> (X
Windows System) as graphical user interface, instead the
operating system uses the framebuffer directly. Shell command
line tools, such as mv, ls, cp, and others, come from <a href="http://landley.net/toybox/about.html">toybox</a>
(BSD license), instead of <a href="https://busybox.net/about.html">busybox</a> or other GNU tools.</li>
</ul></li>

<li>iOS / Apple</li>
</ul>

<p>
<span class="underline">Embedded Systems</span>
</p>

<ul class="org-ul">
<li>Embedded-Linux 

<ul class="org-ul">
<li>Embedded Linux is not a single distribution or operating
system. It is a highly customized Linux-based system comprised
of many custom components, namely: bootloaders (das uboot, most
popular); busybox or toybox as replacement for GNU coreutils
(command line tolls: bash, ls, mv, &#x2026;).</li>

<li>Embedded Linux systems can be found in: network routers; network
printers; many devices with web interface; security cameras;
Amazon's Alexa; Mobile devices (Android can be regarded as an
embedded Linux system) and on many other devices.</li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/QNX">QNX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/LynxOS">LynxOS</a></li>
</ul>
</div>
</div>
<div id="outline-container-org1e13b1c" class="outline-4">
<h4 id="org1e13b1c"><span class="section-number-4">1.1.2</span> Common Features of Unix-like Operating Systems</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
Nowadays, there may be many difference between Unix-like operating
systems, but they still have the following features in common: 
</p>

<ul class="org-ul">
<li><span class="underline">Command line shell</span>
<ul class="org-ul">
<li>In the early days of computing, the shell or command line
interpreter was the primary means of interaction between users
and computers. A unix shell is used both as a scripting language
and as an interactive command line interpreter for
user interaction, launching processes, launching daemons (aka
services), manipulating files and controlling the operating system.</li>

<li>Common Unix shells:
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Almquist_shell">ash</a>  (Almiquistt Shell)</li>
<li><a href="https://en.wikipedia.org/wiki/C_shell">c-shell</a></li>
<li><a href="https://en.wikipedia.org/wiki/Debian_Almquist_shell">dash</a> (Debian Almiquist Shell)</li>
<li>tcsh</li>
<li>ksh  (Korn Shell)</li>
<li>Tcl</li>
<li><a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">bash</a> (Bourn Shell) [Most used, most popular]</li>
<li>zsh                [Most popular]</li>
<li>fish               [Most popular]</li>
</ul></li>
</ul></li>

<li><span class="underline">Command Line Applications</span> (Command-Line Centric)
<ul class="org-ul">
<li>mv; cp; rm; mkdir; ls; telnet; ssh; &#x2026; and so on.</li>
</ul></li>

<li><span class="underline">Terminal Emulation</span>
<ul class="org-ul">
<li>Early Unix-like operating systems only ran in big and expensive
<span class="underline">mainframe</span> computers that were simultaneously shared by many
users via physical dumb terminals attached through serial cables
(RS232 - UART). The first terminals were <span class="underline">teletype printers</span> (tty)
where users could type commands and the teletype printer would
print the the command output in a paper type. Later, dumb CRT
(Cathode-Ray Tube) terminals were adopted. Those machines were
comprised of a keyboard attached to a CRT video display as
single unit attached to a mainframe via a serial cable. Physical
Terminals, such as the once popular <a href="https://en.wikipedia.org/wiki/VT100">DEC VT100</a>, are long gone,
but the are still <span class="underline">emulated</span> by unix-based operating systems. For
instance, most of those systems provide the following types of
terminal emulation:</li>

<li>=&gt; <i>Virtual console</i> =&gt; Kernel built-in terminal emulator, which can
be accessed without any graphical user interface by typing
Ctrl + Alt + F1, Ctrl + Alt + F[N] on Linux. BSD has different
keybinds for the <i>virtual console</i>. Note: Mac-OSX does not have
virtual console.</li>

<li>=&gt; <i>Graphical Terminal Emulator</i> =&gt; Example: Xterm (X11); Gnome
Terminal; Terminator; iTerm (MacOSX).</li>

<li>=&gt; <i>Serial console</i> =&gt; Allows accessing a command line shell
(bash, for instance) through a serial cable (RS232 /
UART). Serial console is still used for accessing servers or
embedded systems.</li>
</ul></li>

<li><span class="underline">Multiple Simultaneous Users</span>
<ul class="org-ul">
<li>Most unix-based systems support multiple simultaneous user
accounts through: serial terminal (serial RS232 cable); serial
dumb terminals (mainframe heritage); telnet obsolete and unsafe;
SSH (Secure Shell Server) protocol over the internet or intranet
or X11 (X Windows Systems) for graphical remote access. Most
editions of Windows NT operating systems also support remote
access via remote desktop, but do not support multiple
simultaneous users like Unix systems, this feature is only
available on Windows NT server edition.</li>
</ul></li>

<li><span class="underline">Text-centric</span>

<ul class="org-ul">
<li>Unix-like operating system has the tradition of storing
configuration in human-readable text files, instead of binary files as
Windows does. The benefits of using text files are the better
reusability, searchability and reproducibility of
configurations. All that one needs to reproduce the configuration
in another machine is to copy the configuration file.</li>

<li>Many applications also use text for configuration instead of
graphical user interfaces.</li>

<li>Examples:
<ul class="org-ul">
<li>Linux-based operating system store many of their configuration
as text files in the '/etc' directory. For instance, the file
'/etc/fstab' controls the disk partitions mounted during boot
time. As opposite to Unix-tradition, Windows and most of its
applications store configuration in the registry file which
is a binary file.</li>

<li>Applications such as bash, vi, emacs store configuration in
text files placed in default locations which are read during
the initialization.</li>
</ul></li>
</ul></li>

<li><span class="underline">POSIX Features</span> / <a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX</a> - (Portable Operating System Interface) standard

<ul class="org-ul">
<li>POSIX System Calls
<ul class="org-ul">
<li>open(), read(), close() &#x2026;</li>
</ul></li>

<li>POSIX Functions encapsulating system calls 
<ul class="org-ul">
<li>open(), read(), close(), mmap(), dlopen(), dlclose() &#x2026;</li>
</ul></li>

<li>POSIX Threads (_PThreads_) - Thread C API</li>

<li>POSIX Shells</li>
</ul></li>

<li><span class="underline">BSD TCP/IP Sockets</span> =&gt; The TCP/IP network technology stack was
first implemented on Unix BSD (Berkley Software Distribution) and
later became the reference implementation for network stacks.</li>

<li><span class="underline">Hierarchical file system</span>
<ul class="org-ul">
<li>File system with paths like: '/' (root directory); '.' (dot) as
the current directory; '/home/user/data' (Linux);
'/home/Users/somthing' (MacOSX) and so on.</li>
</ul></li>

<li><span class="underline">Dynamic Link</span> (Symlink)
<ul class="org-ul">
<li>Allows file and directories to be accessed from other
directories as they were in that location.</li>
</ul></li>

<li><span class="underline">Virtual File Systems</span>
<ul class="org-ul">
<li>Many unix-like operating system provide virtual file-system
(in-memory file systems) which exposes kernel and system
information to user-space applications as human-readable text
files. For instance, Linux has the <span class="underline">PROCFS</span> (/proc directory) file
system which exposes information about all the running
processes. PROCFS also has the file <span class="underline">/proc/cpuinfo</span> which contains
information about the current machine microprocessor, such as:
CPU cores; number of hyper threads; CPU features and
capabilities.</li>
</ul></li>

<li><span class="underline">Everything is a file</span> (or better everything is a file descriptor)
<ul class="org-ul">
<li>Many operating such as reading/writing sockets, pipes and so on,
use the same read/write system-calls for file descriptors.</li>
<li>Hardware represented as device-files</li>
<li>Kernel exposes information as text files (Linux)</li>
<li>Disk partitions are represented as files /dev/sda, /dev/sdb1,
/dev/sdb2 &#x2026;</li>
<li>see: <a href="https://en.wikipedia.org/wiki/File_descriptor">file descriptor</a></li>
</ul></li>

<li><span class="underline">Device Files</span> (a.k.a device nodes)
<ul class="org-ul">
<li>Device files are pseudo-files created in virtual file systems
which allows user-space applications to interact with the
<span class="underline">hardware peripherals</span> by using reading and writing system-calls
or just by reading and writing files. This feature is
particularly important for industrial and embedded system
applications as it allows reading sensor data, such as ADC  -
Analog-To-Digital Converters or digital input, just by reading
files and controlling actuators, such as motors, solenoids or
valves just by writing to files.</li>

<li>Note A: On Linux-based, operating systems, most device files are
in the virtual file systems <span class="underline">devfs</span> (/dev) and and <span class="underline">sysfs</span> (/sys)
directory.</li>

<li>Note B: Not all device files are associated to real hardware
devices. The device-files /dev/null, /dev/zero, /dev/random,
/dev/urandom, /dev/kmsg, /dev/tty0 are not associated to any
real hardware.</li>

<li>Example 1: It allows user-space application to read and write
from/to serial port devices by just reading or writing to the
device file /dev/ttyS1, /dev/ttyUSB0, &#x2026;</li>

<li>Example 2: In single-board computers SBCs (embedded systems)
such as Beagle Bone Black or Raspberry PI, both which contains
SOC (System-On-Chip) embedded processors, it is possible to
control GPIOs (General Purpose IO) which are digital IOs, and
consequently any device attached to them, such as lights, LEDs,
motors or valves, just by writing to the corresponding GPIO
device file (/sys/class/gpio/gpio10/value). By writing 1 to the
this file, the LED is turned on, by writing 0, the LED is turned
off. The device-file feature allows controlling the hardware
with any programming language, including, shell scripts, python,
ruby, standard C++ (without volatile and embedded bare-metal
restrictions) and so on.</li>

<li>Common Linux Device Files associated to hardware 
<ul class="org-ul">
<li><span class="underline">/dev/mem</span>
<ul class="org-ul">
<li>=&gt; Device file that represents the physical RAM
memory. It can be used for reading MMIO (Memory-Mapped IO)
devices.</li>
</ul></li>
<li>/dev/lp0, /dev/lp1 =&gt; Parallel ports</li>
<li>/dev/ttyS0, /dev/ttyS1, &#x2026; =&gt; Serial Ports</li>
<li>/dev/ttyUSB0, /dev/ttyUSB1, &#x2026; =&gt; USB-to-serial converters such as FTDI</li>
<li>/dev/sys/class/gpio/gpio10/export =&gt; GPIO / General Purpose Digital IO</li>
<li>/dev/sys/class/gpio/gpio10/value</li>
<li>&#x2026; &#x2026; &#x2026;</li>
<li>/dev/input/mice =&gt; Binary file contains mouse position, mouse
buttons and and so on. The mouse position can be obtained by
reading this file, without any special API.</li>
<li>/dev/fb0, /dev/fb1 &#x2026; =&gt; <a href="https://www.kernel.org/doc/Documentation/fb/framebuffer.txt">Framebuffer</a> - allows user-space
applications to control the graphics card and draw on the
screen by just writing to a file. The framebuffer is the
lowest level GUI in Linux kernel. Most embedded linux
applications draw directly on framebuffer without X11
(X-Windows System).</li>
</ul></li>

<li>Linux Device Files not associated to hardware:
<ul class="org-ul">
<li><span class="underline">/dev/kmsg</span> 
<ul class="org-ul">
<li>=&gt; charavter device file containing kernel messages. The
file is read by the command line tool '$ dmesg'.</li>
</ul></li>
<li>/dev/stdout =&gt; Console stdout</li>
<li>/dev/stdin  =&gt; Console stdin</li>
<li>/dev/stderr =&gt; Console stderr</li>
<li>/dev/random =&gt; File which generates random numbers</li>
<li>/dev/urandom =&gt; File which generates random numbers</li>
<li>/dev/null =&gt; File used for discarding stdout or stderr of
command line applications.</li>
<li>/dev/zero =&gt; Generate zero-values</li>
<li>/dev/null</li>
</ul></li>
</ul></li>
</ul>

<p>
<b>Quotes</b> 
</p>


<ul class="org-ul">
<li>Ken Thompson</li>
</ul>

<blockquote>
<p>
I think the major good idea in Unix was its clean and simple
interface: open, close, read, and write.
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Doug_McIlroy">Doug Mcllroy</a> - Creator of Unix Pipes</li>
</ul>

<blockquote>
<p>
This is the Unix philosophy: Write programs that do one thing and
do it well. Write programs to work together. Write programs to
handle text streams, because that is a universal interface.
</p>
</blockquote>


<ul class="org-ul">
<li>Brian Kernighan</li>
</ul>

<blockquote>
<p>
Unix has, I think for many years, had a reputation as being
difficult to learn and incomplete. Difficult to learn means that
the set of shared conventions, and things that are assumed about
the way it works, and the basic mechanisms, are just different from
what they are in other systems.
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Rob_Pike">Rob Pike</a> - Member of the Unix design team; creator of GO (Golang)
and Plan-9 operating system.</li>
</ul>

<blockquote>
<p>
Even though the UNIX system introduces a number of innovative
programs and techniques, no single program or idea makes it work
well. Instead, what makes it effective is the approach to
programming, a philosophy of using the computer. Although that
philosophy can't be written down in a single sentence, at its
heart is the idea that the power of a system comes more from the
relationships among programs than from the programs
themselves. Many UNIX programs do quite trivial things in
isolation, but, combined with other programs, become general and
useful tools.
</p>
</blockquote>


<p>
<b>See also</b> 
</p>

<p>
Unix History: 
</p>

<ul class="org-ul">
<li><a href="https://multicians.org/shell.html">The Origin of the Shell</a> - Multics</li>

<li><a href="https://github.com/yvesnrb/Thompson-Shell">GitHub - yvesnrb/Thompson-Shell</a>
<ul class="org-ul">
<li>Original source code for the Sixth Edition (V6) UNIX Thompson
shell.</li>
</ul></li>

<li><a href="https://github.com/susam/tucl">GitHub - susam/tucl</a>
<ul class="org-ul">
<li>The first-ever paper on the Unix shell written by Ken Thompson
in 1976 scanned, transcribed, and redistributed with permissio.</li>
</ul></li>

<li><a href="https://susam.github.io/tucl/the-unix-command-language.html">THE UNIX COMMAND LANGUAGE | The UNIX Command Language</a> (Ken Thompson)</li>

<li><a href="https://github.com/dspinellis/unix-history-repo">GitHub - dspinellis/unix-history-repo</a> 
<ul class="org-ul">
<li>"The history and evolution of the Unix operating system is made
available as a revision management repository, covering the
period from its inception in 1970 as a 2.5 thousand line kernel
and 26 commands, to 2018 as a widely-used 30 million line
system. The 1.5GB repository contains about half a million
commits and more than two thousand merges. The repository
employs Git system for its storage and is hosted on GitHub. It
has been created by synthesizing with custom software 24
snapshots of systems developed at Bell Labs, the University of
California at Berkeley, and the 386BSD team, two legacy
repositories, and the modern repository of the open source
FreeBSD system. In total, about one thousand individual
contributors are identified, the early ones through primary
research. The data set can be used for empirical research in
software engineering, information systems, and software
archaeology."</li>
</ul></li>

<li><a href="https://www.youtube.com/watch?v=tc4ROCJYbm0">AT&amp;T Archives: The UNIX Operating System</a></li>

<li><a href="https://www.youtube.com/watch?v=XvDZLjaCJuw">UNIX: Making Computers Easier To Use</a> -
<ul class="org-ul">
<li>AT&amp;T Archives film from 1982, Bell Laboratories</li>
</ul></li>

<li><a href="https://www.cs.cmu.edu/~awb/linux.history.html">LINUX's History by Linus Torvalds</a></li>

<li><a href="https://www.youtube.com/watch?app=desktop&amp;v=9-IWMbJXoLM">"What UNIX Cost Us" - Benno Rice (LCA 2020)</a>
<ul class="org-ul">
<li>"UNIX is a hell of a thing. From starting as a skunkworks
project in Bell Labs to accidentally dominating the computer
industry it's a huge part of the landscape that we work
within. The thing is, was it the best thing we could have had?
What could have been done better? Join me for a bit of
meditation on what else existed then, what was gained, what was
lost, and what could (and should) be re-learned."</li>
<li>=&gt; Criticism of the mindset: "Everything is a file or a file
descriptor. Not everything should be a file."</li>
</ul></li>
</ul>

<p>
General Unix Concepts: 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Unix">Unix concept</a></li>

<li><a href="http://www.catb.org/~esr/writings/taoup/">Book: The Art of Unix Programming</a> - Eric Raymond 
<ul class="org-ul">
<li>'The Art of Unix Programming attempts to capture the engineering
wisdom and philosophy of the Unix community as it's applied
today — not merely as it has been written down in the past, but
as a living "special transmission, outside the scriptures"
passed from guru to guru. Accordingly, the book doesn't focus so
much on "what" as on "why", showing the connection between Unix
philosophy and practice through case studies in widely available
open-source software.'</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix-like">Unix-like operating systems</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX - Portable Operating System Interface</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix_philosophy">Unix philosophy</a></li>

<li><a href="https://en.wikipedia.org/wiki/Unix_shell">Unix Shell Scripting</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Symbolic_link">Symbolic Link / symlink</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Pipeline, Pipes - IPC (Inter Process Communication)</a></li>

<li><a href="https://www.bottomupcs.com/file_descriptors.xhtml">Unix File Descriptors</a></li>

<li><a href="https://en.wikipedia.org/wiki/File_descriptor">File Descriptors</a></li>

<li><a href="https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/12_FileSystemImplementation.html">Operating Systems - File System Implementation</a></li>
</ul>

<p>
Papers and mail lists: 
</p>

<ul class="org-ul">
<li><a href="https://people.eecs.berkeley.edu/~brewer/cs262/unix.pdf">The UNIX Time Sharing System {PDF}</a> - Dennis M. Ritchie and Ken Thompson - Bell Laboratories</li>

<li><a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix03/tech/freenix03/full_papers/appavoo/appavoo_html/node18.html">Files, file descriptors, and name space</a></li>

<li><a href="https://yarchive.net/comp/linux/everything_is_file.html">Linux kernel mail list discussion - Everything is a file</a></li>
</ul>

<p>
Usage of <span class="underline">Linux Device Files</span> for controlling hardware (reading Sensors
and manipulating actuators):
</p>

<ul class="org-ul">
<li>/dev/mem -  <a href="https://stackoverflow.com/questions/12040303/how-to-access-physical-addresses-from-user-space-in-linux">memory - How to access physical addresses from user space in Linux? - Stack Overflow</a></li>

<li>/dev/mem - <a href="https://elinux.org/EBC_GPIO_via_mmap">EBC GPIO via mmap - eLinux.org</a></li>

<li>/dev/mem - <a href="https://github.com/tchebb/memdump">GitHub - tchebb/memdump: A simple /dev/mem dumper for Linux</a></li>

<li>/dev/mem - <a href="https://man7.org/linux/man-pages/man4/kmem.4.html">kmem(4) - Linux manual page</a></li>

<li><a href="https://lwn.net/Articles/147901/">Who needs /dev/kmem? - LWN.net</a></li>

<li><a href="https://unix.stackexchange.com/questions/101759/difference-between-device-file-and-device-drivers">Difference between Device file and device drivers</a></li>

<li><a href="http://ibgwww.colorado.edu/~lessem/psyc5112/usail/peripherals/devices/devintro.html">Introduction to device drivers and device nodes</a></li>

<li><a href="https://thehackerdiary.wordpress.com/2017/04/21/exploring-devinput-1/">The hacker diary - exploring /dev/input</a> =&gt; Shows how to read the
device file /dev/input/mice which contains mouse information such
as position and buttons state.</li>

<li><a href="https://www.ics.com/blog/how-control-gpio-hardware-c-or-c">How to Control GPIO Hardware from C or C++</a>
<ul class="org-ul">
<li>Note: It only works in PCs with <span class="underline">industrial IO cards</span> or systems
with SOC processors (System-On-Chip) with GPIO devices; SBC -
Single Board Computers, which are PCBs - printed circuit boards
containin SOC microprocessors or MCU - Microcontrollers and all
necessary supporting ICs (Integrated Circuits) such as RAM
memory chips; flash memory chips; voltage regulators; USB
connectors; &#x2026;</li>
</ul></li>

<li><a href="https://blog.mbedded.ninja/programming/operating-systems/linux/linux-serial-ports-using-c-cpp/">Linux Serial Ports Using C/C++</a></li>

<li><a href="https://stackoverflow.com/questions/6947413/how-to-open-read-and-write-from-serial-port-in-c">How to open, read, and write from serial port in C?</a></li>

<li><a href="https://www.iot-programmer.com/index.php/books/22-raspberry-pi-and-the-iot-in-c/chapters-raspberry-pi-and-the-iot-in-c/57-raspberry-pi-and-the-iot-in-c-sysfs-the-linux-way-to-gpio?start=1">Raspberry Pi And The IoT In C - SYSFS The Linux Way To GPIO</a></li>
</ul>


<p>
Terminal Emulation and Serial Console
</p>

<ul class="org-ul">
<li><a href="https://www.ttwin.com/blog/270-history-terminal-emulation">A Brief History of Terminal Emulation</a></li>

<li><a href="https://en.wikipedia.org/wiki/VT100">DEC VT100 CRT Terminal</a></li>

<li><a href="https://en.wikipedia.org/wiki/Computer_terminal">Computer Terminal</a></li>

<li><a href="https://www.kernel.org/doc/html/v4.15/admin-guide/serial-console.html">Linux Kernel Docs / Linux Serial Console</a></li>

<li><a href="https://www.tldp.org/HOWTO/Remote-Serial-Console-HOWTO/intro-why.html">Remote Serial Console HOWTO Prev / Chapter 1. Introduction</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Working_with_the_serial_console">Arch Linux / Working with the serial console</a></li>

<li><a href="https://elinux.org/Serial_console">Elinux - Serial Console</a></li>

<li><a href="https://bootlin.com/doc/legacy/serial-drivers/linux-serial-drivers.pdf">Bootlin - Linux Serial Driver</a></li>

<li><a href="https://developer.toradex.com/knowledge-base/how-to-disable-enable-debug-messages-in-linux">Configuring Serial Port Debug Console (Linux/U-Boot)</a></li>

<li><a href="https://wiki.alpinelinux.org/wiki/Enable_Serial_Console_on_Boot">Alpine Linux - Enable Serial Console</a></li>

<li><a href="https://www.linuxjournal.com/article/7206">Linux Serial Consoles for Servers and Clusters</a></li>

<li><a href="https://roll.urown.net/server/serial-console.html">Roll Your Own Network / Serial Console</a> (for servers, data-centers)</li>
</ul>

<p>
Plan 9 Operating System 
</p>

<ul class="org-ul">
<li><a href="https://css.csail.mit.edu/6.824/2014/papers/plan9.pdf">Plan 89 from Bell Labs</a> [PAPER] - Ken Thompson, Rob Pike, Dave Presotto, and others.</li>

<li><a href="https://www.cs.kent.ac.uk/people/staff/srk21/research/papers/kell19unix-personal.pdf">Unix, Plan 9 and the Lurking Smalltak</a> [PAPER]</li>

<li><a href="https://woozle.org/papers/plan9.html">Making Unix a little more Plan9-like</a></li>

<li><a href="https://wiki.installgentoo.com/wiki/Plan_9">Plan 9 - Gentoo Wiki</a></li>

<li><a href="http://www.catb.org/esr/writings/taoup/html/plan9.html">Plan 9: The Way the Future Was - Chapter 20. Futures</a></li>

<li><a href="https://www.slideshare.net/anantn/unix-plan9-from-bell-labs?qid=024d0f21-1e4b-4414-91a8-2d7d8a88ebba&amp;v=&amp;b=&amp;from_search=2">Plan 9 - from Bell Labs - Unix++ Anyone?</a></li>

<li><a href="http://groups.di.unipi.it/~nids/docs/the_plan-9_effect.html">The Plan-9 Effect or why you should not fix it if it ain't broken</a></li>

<li><a href="https://www.slideshare.net/anantn/glendix-the-why-and-the-how?qid=024d0f21-1e4b-4414-91a8-2d7d8a88ebba&amp;v=&amp;b=&amp;from_search=30">Glendix - A Plan 9/Linux Distribution</a></li>

<li><a href="https://www.cs.cmu.edu/~davide/p9.html">Dr. David A. Eckhardt &#x2013; Plan 9</a></li>

<li><a href="https://www.slideshare.net/jserv/plan-9-not-only-a-better-unix?qid=cab7305a-e78c-44bb-8b7f-88925f3717b4&amp;v=&amp;b=&amp;from_search=17">Plan 9: Not (Only) A better UNIX</a> - Jim Huang</li>

<li><a href="https://www.slideshare.net/twopoint718/rc-the-plan-9-shell?qid=cab7305a-e78c-44bb-8b7f-88925f3717b4&amp;v=&amp;b=&amp;from_search=18">Rc - The Plan 9 Shell</a></li>

<li><a href="https://www.slideshare.net/oraccha/plan-9">Plan-9 from the outer space</a> (Presentation, In Japanese)</li>

<li><a href="https://9p.io/wiki/plan9/Unix_to_Plan_9_command_translation/index.html">UNIX to Plan 9 command translation</a></li>

<li><a href="https://docs.huihoo.com/plan9/Plan9.pdf">The Unix Spirit set Free: Plan 9 from Bell Labs</a></li>

<li><a href="http://fqa.9front.org/fqa0.html">Introduction to Plan 9</a></li>

<li><a href="https://sigkill.dk/writings/guides/plan_9_tools.html#running-plan-9-userland-tools-on-unix">Running Plan 9 Userland Tools On Unix</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6ddc5c7" class="outline-4">
<h4 id="org6ddc5c7"><span class="section-number-4">1.1.3</span> Components of Linux-based operating systems (Linux Distros)</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
<b>Widely Used GNU and Kernel-Organization Tools</b> 
</p>

<p>
<a href="https://en.m.wikipedia.org/wiki/GNU_Project">GNU</a> tools are pervarsive on most Linux distributions either as
essential command line utilities or building tools:
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/GNU_toolchain">GNU Toolchain</a> (GNU Compilers and GDB Debugger)
<ul class="org-ul">
<li>GDB =&gt; GNU Debugger</li>
<li>GCC =&gt; C, ObjectiveC and C++ compiler</li>
<li>GFortran =&gt; GNU Fortran Compiler</li>
<li>Ada =&gt; GNU Ada compiler</li>
<li>&#x2026; &#x2026;</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/GNU_Binutils">GNU Binutils</a> - Collection of tools for manipulating object-files:
<ul class="org-ul">
<li>ld =&gt; GNU linke</li>
<li>nm =&gt; Shows symbols exported by object code file or shared library.</li>
<li>as =&gt; GNU assembler</li>
<li>objdump =&gt; Dump object file symbols, can be used for disassembly
ELF object-files.</li>
<li>c++-filt =&gt; Demangle (aka decode) C++ symbols</li>
<li>readelf =&gt; Red information about ELF object-files.</li>
<li>strings =&gt; List printable strings from any binary file.</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/GNU_build_system">GNU Building System</a> (GNU Autotools, GNU automake and Libtool)</li>

<li><a href="https://en.m.wikipedia.org/wiki/GNU_Core_Utilities">GNU Core Utils (coreutils)</a> - GNU Core Utilities - Comprises
essential Unix command line utilities such as: ls, cat, grep,
less and so on.</li>

<li><a href="https://github.com/karelzak/util-linux">util-linux</a> (Maintened by Linux Kernel Organization) =&gt; Set of
command applications not provided by GNU tools:
<ul class="org-ul">
<li>$ mount   =&gt; Command line application for mounting file systems</li>
<li>$ fdisk   =&gt; Command for creating and manipulating disk partitions</li>
<li>$ getopt  =&gt; Parse command line arguments</li>
<li>$ cal     =&gt; Prints calendar</li>
<li>$ hexdump =&gt; Dump binary files in hexadecimal format.</li>
<li>$ logger  =&gt; Sends message to syslog</li>
<li>$ chcpu   =&gt; Configure CPUs in a multi-processor system.</li>
<li>$ dmesg   =&gt; Display kernel messages (content of device file /dev/kmsg)</li>
<li>$ findmnt =&gt; Find mounted file systems.</li>
<li>$ lsmode  =&gt; List loaded kernel modules</li>
<li>$ lsblk   =&gt; List block devices (disks and partitions) and mount points.</li>
<li>$ lsscsi  =&gt; List SCSI devices, hard disks.</li>
<li>$ lscpu   =&gt; Display CPU information: architecture, operating
mode, number of cores and so on. This information comes from the
file /proc/cpuinfo</li>
<li>$ lslocks =&gt; List local file system locks.</li>
<li>$ lsusbs  =&gt; List USB devices</li>
<li>$ lspci   =&gt; Show information about devices attached to PCI bus.</li>
<li>$ lslogin =&gt; Display information about known users in the system.</li>
<li>$ lsof    =&gt; List open files.</li>
<li>&#x2026; and much more &#x2026;</li>
</ul></li>
</ul>


<p>
<b>Components of a Linux-based Operating System</b> (Generic <a href="https://en.wikipedia.org/wiki/IBM_PC_compatible">IBM-PC</a> Architecture)
</p>

<ul class="org-ul">
<li>First-stage Boot Loader (Built-in, firmware)
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> - Basic Input/Output System</li>
<li><a href="https://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">UEFI</a> - Unified Extensible Firmware Interface</li>
</ul></li>

<li>Second-stage Boot Loader =&gt; Loads the operating system
<ul class="org-ul">
<li>Examples:
<ul class="org-ul">
<li>Grub (Mostly used on Desktop)</li>
<li><a href="https://en.wikipedia.org/wiki/SYSLINUX">Syslinux</a> (Mostly used for booting CDROM ISO images, Linux
Live CDs)</li>
</ul></li>
</ul></li>

<li><b>Linux Kernel</b> (Written in C with proprietary GNU GCC compiler extension)
<ul class="org-ul">
<li>One of the most important parts of GNU/Linux desktop and server
distribution. The kernel provides many essential services that
user-space applications take for granted such as: standardized
and documented system-calls; process and thread scheduling; network stack; virtual memory management;
virtual file systems; uniform interfaces for accessing
hardware either as character device, block device or network
device for network cards.</li>
</ul></li>

<li>CRT - C-Runtime Library
<ul class="org-ul">
<li>Encapsulates kernel system-calls and basic services as C APIs
for user-space applications and implements C functions required
by C standards.</li>
<li>Example:
<ul class="org-ul">
<li>GLIBC (GNU C-library, most used C library by Linux Desktop
and server distributions). Maintained by: FSF - Free Software
Foundation.</li>
<li>Bionic - CRT library used by Android.</li>
<li>MUSL - CRT library used for embedded systems and static linking.</li>
</ul></li>
</ul></li>

<li>User-space utilities

<ul class="org-ul">
<li>Shell - command line interpreter.
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Almquist_shell">ASH</a></li>
<li><a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">Bash</a></li>
<li><a href="https://en.wikipedia.org/wiki/Z_shell">ZSH</a></li>
<li><a href="https://fishshell.com/">Fish</a></li>
<li><a href="https://xon.sh/">Xonsh</a> (Alternative, Python powersed shell)</li>
</ul></li>

<li>Basic Command Line Tools (ls, mv, pwd, ln, rm, file, &#x2026;)
<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/GNU_Core_Utilities">GNU Coreutils</a></li>
<li>Busybox =&gt; Is a single binary containing all command line
tools as sub-commands. Busybox is widely used on
Embedded-Linux systems.</li>
</ul></li>

<li>GUI - Graphical User Interface Stack (Not part of Kernel) - all
GUI applications are built on top of kernel <span class="underline">framebuffer</span>.
<ul class="org-ul">
<li>X11 - X Windows System</li>
<li>GTK - Gimp Toolkit</li>
<li>QT</li>
</ul></li>

<li>Package Managers
<ul class="org-ul">
<li>Examples:
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Dpkg">Dpkg</a> (Debian)</li>
<li><a href="https://en.wikipedia.org/wiki/Aptitude_(software)">Aptitude</a> (APT - Debian, Ubuntu)</li>
<li><a href="https://en.wikipedia.org/wiki/RPM_Package_Manager">RPM Package Manager</a> (Read-Hat Package Manager) =&gt; Used by Fedora.</li>
<li>Pacman =&gt; Arch Linux Distribution</li>
<li><a href="https://en.wikipedia.org/wiki/Portage_(software)">Portage</a> =&gt; Gentoo Distribution</li>
<li>More: <a href="https://en.wikipedia.org/wiki/List_of_software_package_management_systems">List of package managers</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>


<p>
<b>Components of a Embedded Linux System</b> 
</p>

<ul class="org-ul">
<li><span class="underline">Cross Compiler Toolchain</span>: Mostly GCC - GNU C Compiler
<ul class="org-ul">
<li>Note: The Linux Kernel uses many C proprietary extensions of
GCC compiler, therefore it is almost impossible to compile the
kernel using any other compiler.</li>
</ul></li>

<li><span class="underline">Boot Loader</span> =&gt; Loads the operating system 
<ul class="org-ul">
<li><a href="https://github.com/littlekernel/lk/wiki/Introduction">Lk - Little Kernel</a> (Android Bootloader)</li>
<li><a href="https://en.wikipedia.org/wiki/Das_U-Boot">U-Boot</a> (Most popular)</li>
<li><a href="https://en.wikipedia.org/wiki/Barebox">Barebox</a></li>
<li><a href="https://en.wikipedia.org/wiki/RedBoot">RedBoot</a></li>
<li><a href="https://en.wikipedia.org/wiki/Yaboot">Yaboot</a></li>
</ul></li>

<li><span class="underline">Linux Kernel</span> (GPL v2 License)
<ul class="org-ul">
<li>Among other-things, the kernel provides: virtual memory
management; processes; kernel-space (native) threads; kernel
modules (device drivers) API and many other essential
features.</li>
</ul></li>

<li><span class="underline">CRT - C Runtime Library</span>
<ul class="org-ul">
<li>uLibC</li>
<li>MUSL</li>
<li>Bionic (Android C library)</li>
<li>GLIBC</li>
</ul></li>

<li><span class="underline">User-Space Utilities</span> (Replacemente for GNU CoreUtils)

<ul class="org-ul">
<li><a href="https://busybox.net/about.html">busybox</a> (GPL v2 License) - Single binary executable containing
many common unix command line utitlities in a single
executable, such as: unix shell, ls, mv, cp, rm, zip, unzip, &#x2026; and so
on. 
<ul class="org-ul">
<li>"BusyBox combines tiny versions of many common UNIX utilities
into a single small executable. It provides replacements for
most of the utilities you usually find in GNU fileutils,
shellutils, etc. The utilities in BusyBox generally have
fewer options than their full-featured GNU cousins; however,
the options that are included provide the expected
functionality and behave very much like their GNU
counterparts. BusyBox provides a fairly complete environment
for any small or embedded system."</li>
</ul></li>

<li><a href="http://landley.net/toybox/about.html">toybox</a> (BSD License) =&gt; Used on Android. 
<ul class="org-ul">
<li>"Toybox combines many common Linux command line utilities
together into a single BSD-licensed executable. It's simple,
small, fast, and reasonably standards-compliant (POSIX-2008
and LSB 4.1). Toybox's main goal is to make Android
self-hosting by improving Android's command line utilities so
it can build an installable Android Open Source Project image
entirely from source under a stock Android system. After a
talk at the 2013 Embedded Linux Conference explaining this
plan (outline, video), Google merged toybox into AOSP and
began shipping toybox in Android Mashmallow."</li>
</ul></li>
</ul></li>

<li><span class="underline">BSP - Board Support Package</span>

<ul class="org-ul">
<li>Device drivers or kernel modules provided by SOC
(System-On-Chip) manafucaturer. Most device drivers maps
on-board peripherals, such as UART (serial communication
device); GPIO - General Purporse IO; CAN - Controller Area
Network or ADC - Analog-To-Digital Converter, to device files
which allows user-space applications to control the hardware by
just reading and writing files.</li>

<li>The device-files feature allows using <span class="underline">standard C or C++</span> for
interacting the aforementioned peripherals and any physical
devices attached to them such as pumps, electric motors,
, valves, sensors, accelerometers or gyroscopes. The
device-file feature also allows controling the hardware with
any scripting language such as: ruby, python, unix shell script
(bash, ash, sh, &#x2026;) &#x2026;</li>
</ul></li>

<li><span class="underline">GUI - Graphical User Interface</span>
<ul class="org-ul">
<li>Framebuffer - Linux Kernel Device file which allows user-space
applications to control graphical display.</li>
<li>In-house GUI on top framebuffer (Lowest level)</li>
<li>SDL (LGPL) - <a href="http://www.libsdl.org/">http://www.libsdl.org/</a> - Library that came from Game Development.</li>
<li>QT on top of framebuffer</li>
<li>X11 - X Windows System (Rarely used, too heavy.)</li>
</ul></li>
</ul>

<p>
<b>See</b> 
</p>

<ul class="org-ul">
<li><a href="https://elinux.org/DirectFB">Direct FB</a> - Elinux</li>

<li><a href="https://doc.qt.io/qt-5/embedded-linux.html">QT For Embedded Linux</a> (QT Company)</li>

<li><a href="https://doc.qt.io/archives/qt-4.8/qt-embedded-displaymanagement.html">Qt for Embedded Linux Display Management</a></li>

<li><a href="https://bootlin.com/blog/building-a-linux-system-for-the-stm32mp1-enabling-qt5-for-graphical-applications/">Building a Linux system for the STM32MP1: enabling Qt5 for graphical applications - Bootlin's blog</a></li>

<li><a href="https://elinux.org/images/6/64/Choosing-embedded-graphical-libraries.pdf">Choosing Embedded Graphical Libraries</a></li>

<li><a href="https://itnext.io/top-five-libraries-for-creating-gui-on-embedded-linux-5ce03903be32">Top Five Libraries for creating GUI on Embedded Linux | by Kevin Muhuri | ITNEXT</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org4a7e7e2" class="outline-3">
<h3 id="org4a7e7e2"><span class="section-number-3">1.2</span> Command Line Essentials</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orge16e3e1" class="outline-4">
<h4 id="orge16e3e1"><span class="section-number-4">1.2.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Useful reminder of common built-in command line applications for many
unix-like operating systems, including Linux-distros; BSD-variants and
MacOSX.
</p>
</div>
</div>
<div id="outline-container-orgbaeda78" class="outline-4">
<h4 id="orgbaeda78"><span class="section-number-4">1.2.2</span> Fundamentals</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>=&gt; Change current prompt (works for Bash and ZSH shells)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">PS1</span>=<span class="org-string">" $ &gt;&gt; "</span>

$ &gt;&gt; command typed by user  
output line 0 
output line 1 
... ... ... 
output line N-1
</pre>
</div>

<ul class="org-ul">
<li><b>pwd</b> =&gt; Get current working directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ pwd
/home/mxpkf8/Downloads
</pre>
</div>

<ul class="org-ul">
<li><b>cd</b> - Change the current directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cd /Applications <span class="org-comment-delimiter"># </span><span class="org-comment">OSX </span>
$ cd ~/Downloads 
$ cd /home/user/Downloads 
$ cd /Users/user/Downloads

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter in Home directory: </span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">/Users/&lt;USER&gt; in Mac OSX </span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">/home/&lt;USER/ in Linux                 </span>
$ cd $<span class="org-variable-name">HOME</span> 
</pre>
</div>

<ul class="org-ul">
<li><b>ls</b> - List directory</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls /

bin@   dev/  home/  lib64@       media/  opt/   root/  sbin@  sys/  usr/
boot/  etc/  lib@   lost+found/  mnt/    proc/  run/   srv/   tmp/  var/
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l /System/Applications/Utilities/Terminal.app/Contents

total 32
-rw-r--r--   1 root  wheel  7998 Apr 17 22:57 Info.plist
drwxr-xr-x   3 root  wheel    96 May 27 20:40 MacOS
-rw-r--r--   1 root  wheel     8 Apr 17 22:57 PkgInfo
drwxr-xr-x  74 root  wheel  2368 May 27 20:30 Resources
drwxr-xr-x   3 root  wheel    96 Apr 17 22:57 _CodeSignature
-rw-r--r--   1 root  wheel   510 Apr 17 22:58 version.plist
</pre>
</div>

<ul class="org-ul">
<li><b>rm</b> - Delete files or directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Delete file </span>
$ rm file.txt 

<span class="org-comment-delimiter"># </span><span class="org-comment">Delete directory dir2 and all sub-directories of dir2 </span>
$ rm -rf ./dir1/dir2

<span class="org-comment-delimiter"># </span><span class="org-comment">Delete directory dir2 and all sub-directories of dir2 in verbose mode </span>
$ rm -rf -v ./dir1/dir2
</pre>
</div>

<ul class="org-ul">
<li><b>cat</b> - Display text file content</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/uptime 
11960.35 36214.14

$ cat /proc/filesystems 
nodev   sysfs
nodev   tmpfs
nodev   bdev
nodev   proc
nodev   cgroup
nodev   cgroup2
.. ... ... ... 
... ... ... .. 
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ cat /System/Applications/Utilities/Terminal.app/Contents/Info.plist  

&lt;?xml <span class="org-variable-name">version</span>=<span class="org-string">"1.0"</span> <span class="org-variable-name">encoding</span>=<span class="org-string">"UTF-8"</span>?&gt;
&lt;!DOCTYPE plist PUBLIC <span class="org-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="org-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;
&lt;plist <span class="org-variable-name">version</span>=<span class="org-string">"1.0"</span>&gt;
&lt;dict&gt;
        &lt;key&gt;ATSApplicationFontsPath&lt;/key&gt;
        &lt;string&gt;Fonts&lt;/string&gt;
        &lt;key&gt;BuildMachineOSBuild&lt;/key&gt;
        &lt;string&gt;18A391024&lt;/string&gt;
  ... ...   ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
  ... ...   ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfec5a63" class="outline-4">
<h4 id="orgfec5a63"><span class="section-number-4">1.2.3</span> Creating files and directories from command line</h4>
<div class="outline-text-4" id="text-1-2-3">
<ul class="org-ul">
<li><b>mkdir</b> - Create directory (aka folder)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create single directory/folder 'somedir' at current directory</span>
$ mkdir somedir

<span class="org-comment-delimiter"># </span><span class="org-comment">Create single directory/folder 'somedir' at /tmp path</span>
$ mkdir -p /tmp/somedir

<span class="org-comment-delimiter"># </span><span class="org-comment">Create directory-tree root-folder, root-folder/sub1 and root-folder/sub1/sub2 </span>
$ mkdir -p /Users/unix/root-folder/sub1/sub2

<span class="org-comment-delimiter"># </span><span class="org-comment">Create directory tree </span>
$ mkdir -p mydir/{subA,subB}/d1/d2

$ tree mydir
mydir
&#9500;&#9472;&#9472; subA
&#9474;&#160;&#160; &#9492;&#9472;&#9472; d1
&#9474;&#160;&#160;     &#9492;&#9472;&#9472; d2
&#9492;&#9472;&#9472; subB
    &#9492;&#9472;&#9472; d1
        &#9492;&#9472;&#9472; d2
</pre>
</div>

<ul class="org-ul">
<li><b>touch</b> - Create empty files:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ touch file1.txt somefile.cpp CMakeLists.txt 
</pre>
</div>

<ul class="org-ul">
<li>Create multi-line file with echo</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo line1 &gt; file.txt
$ echo line1 &gt; file.txt
$ echo line3 &gt;&gt; file.txt

$ cat file.txt 
line1
line2
line3
</pre>
</div>

<ul class="org-ul">
<li>Create multi-line files with cat-EOF trick.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create a file with some content </span>
$ cat &gt; script.sh &lt;&lt;EOF
<span class="org-sh-heredoc">#!/usr/bin/env sh </span>

<span class="org-sh-heredoc">echo " =&gt; Showing root directory"</span>
<span class="org-sh-heredoc">ls /</span>

<span class="org-sh-heredoc">EOF</span>

$ cat script.sh 
<span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env sh </span>

<span class="org-builtin">echo</span> <span class="org-string">" =&gt; Showing root directory"</span>
ls /

$ sh script.sh 
 =&gt; Showing root directory
bin   dev  home  lib64       media  opt   root  sbin  sys  usr
boot  etc  lib   lost+found  mnt    proc  run   srv   tmp  var
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0604f8" class="outline-4">
<h4 id="orgc0604f8"><span class="section-number-4">1.2.4</span> Files and executables</h4>
<div class="outline-text-4" id="text-1-2-4">
<ul class="org-ul">
<li><b>which</b> - Get path to executable in $PATH environment variable.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ which xdg-open
/usr/bin/xdg-open

$ which zsh
/usr/bin/zsh

$ which brave
/home/mxpkf8/Applications/brave/brave
</pre>
</div>

<ul class="org-ul">
<li><b>file</b> - Identify text or binary files by they "magic-number"
(uniquely identifying byte sequence)</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ file /usr/bin/bash
 /usr/bin/bash: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
 , dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2
 .. ... ... ... ... ... 

$ file vs_buildtools__80950065.1591646379.exe 
<span class="org-function-name">vs_buildtools__80950065.1591646379.exe</span>: PE32 executable (GUI) Intel 80386, for MS Windows
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file /bin/zsh 
<span class="org-function-name">/bin/zsh</span>: Mach-O 64-bit executable x86_64

$ file $<span class="org-variable-name">HOME</span>/Desktop/Console 
<span class="org-function-name">/Users/unix/Desktop/Console</span>: MacOS Alias file

$ file /System/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal
<span class="org-function-name">/System/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal</span>: Mach-O 64-bit executable x86_64
</pre>
</div>


<ul class="org-ul">
<li>Open file with default system Application / <b>xdg-open</b> (Linux with
X11, BSD with X11); <b>open</b> (MacOSX)</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Open Desktop directory with default system file manager </span>
$ xdg-open $<span class="org-variable-name">HOME</span>/Desktop 

<span class="org-comment-delimiter"># </span><span class="org-comment">Open file image.png with default system image viewer </span>
$ xdg-open image.png 
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Open /Volumes directory with default system file manager (finder)</span>
$ open /Volumes 

<span class="org-comment-delimiter"># </span><span class="org-comment">Open file CmakeLists.txt with default system text editor </span>
$ open CMakeLists.txt 

$ open disk-image.dmg 
</pre>
</div>
</div>
</div>

<div id="outline-container-orga38ae7e" class="outline-4">
<h4 id="orga38ae7e"><span class="section-number-4">1.2.5</span> System information</h4>
<div class="outline-text-4" id="text-1-2-5">
<ul class="org-ul">
<li><b>uname</b> =&gt; Get Kernel Version</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ uname -a
Linux localhost.localdomain 5.6.6-300.fc32.x86_64 <span class="org-comment-delimiter">#</span><span class="org-comment">1 SMP Tue Apr 21 13:44:19 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</pre>
</div>

<p>
Mac OSX Catalina: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ uname -a 
Darwin ghosts-iMac-Pro.local 19.5.0 Darwin Kernel Version 19.5.0: Tue May 26 20:41:44 PDT 2020; root:xnu-6153.121.2~2/RELEASE_X86_64 x86_64
</pre>
</div>

<ul class="org-ul">
<li><b>uptime</b> - Shows how long the machine is running.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Linux </span>
$ &gt;&gt; uptime
<span class="org-function-name">13</span>:43:36 up  2:22,  1 user,  load average: 1.31, 1.00, 0.99

<span class="org-comment-delimiter"># </span><span class="org-comment">Mac OSX</span>
<span class="org-function-name">13</span>:44  up  1:48, 2 users, load averages: 1.17 1.30 1.35
</pre>
</div>

<ul class="org-ul">
<li><b>whoami</b> - Show current user (Note: it also works on Windows)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ whoami
user_ml7abfg
</pre>
</div>

<ul class="org-ul">
<li><b>w</b> - Show logged users</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ w
 13:37:31 up  2:16,  1 user,  load average: 0.63, 0.87, 0.98
USER     TTY        LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="org-function-name">user_ml7abfg</span>   :0        11:22   ?xdm?  43:26   0.00s /usr/libexec/gdm-x-session --register-session --
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ w 
<span class="org-function-name">13</span>:38  up  1:42, 2 users, load averages: 1.86 1.53 1.44
USER     TTY      FROM              LOGIN@  IDLE WHAT
unix     console  -                11:58    1:39 -
unix     s000     -                13:32       - w
</pre>
</div>

<ul class="org-ul">
<li><b>ps</b> - Show running processes</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ps -ef 
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 11:21 ?        00:00:18 /usr/lib/systemd/systemd --switched-root --system --deserialize 29
root           2       0  0 11:21 ?        00:00:00 [kthreadd]
root           3       2  0 11:21 ?        00:00:00 [rcu_gp]
root           4       2  0 11:21 ?        00:00:00 [rcu_par_gp]
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
mxpkf8      2383    2382  0 11:22 ?        00:00:00 dbus-broker --log 4 --controller 9 --machine-
mxpkf8      2387    1946  0 11:22 ?        00:00:01 /usr/libexec/at-spi2-registryd --use-gnome-se
mxpkf8      2392       1  0 11:22 ?        00:00:00 /usr/bin/gpg-agent --sh --daemon --write-env-
mxpkf8      2393    2149  0 11:22 tty2     00:01:18 xfwm4
 ... ... ... ... ... ...  ... ... ... ... ... ... 
 ... ... ... ... ... ...  ... ... ... ... ... ... 
</pre>
</div>

<p>
Mac OSX:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ps -ef 
  UID   PID  PPID   C STIME   TTY           TIME CMD
    0     1     0   0 11:56AM ??         0:16.58 /sbin/launchd
    0    86     1   0 11:58AM ??         0:01.13 /usr/sbin/syslogd
    0    87     1   0 11:58AM ??         0:03.44 /usr/libexec/UserEventAgent (System)
    0    90     1   0 11:58AM ??         0:01.11 /System/Library/PrivateFrameworks/Uninstall.framework/Resources/uninstalld
    0    91     1   0 11:58AM ??         0:05.95 /usr/libexec/kextd
    0    92     1   0 11:58AM ??         0:09.31 /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/Support/fseventsd
    0    93     1   0 11:58AM ??         0:00.32 /System/Library/PrivateFrameworks/MediaRemo
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
  501  6102     1   0  1:29PM ??         0:00.26 /System/Library/CoreServices/CoreServicesUIAgent.app/Contents/MacOS/CoreServicesUIAgent
  501  6813     1   0  1:45PM ??         0:01.12 /System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/CVMCompiler 2
    0  6795   319   0  1:32PM ttys000    0:00.06 login -pf unix
  501  6796  6795   0  1:32PM ttys000    0:00.38 -zsh
    0  6816  6796   0  1:46PM ttys000    0:00.01 ps -ef
</pre>
</div>

<ul class="org-ul">
<li><b>env</b> - Show environment variables</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ env
<span class="org-variable-name">IMSETTINGS_INTEGRATE_DESKTOP</span>=yes
<span class="org-variable-name">SHELL</span>=/bin/bash
<span class="org-variable-name">SESSION_MANAGER</span>=local/unix:@/tmp/.ICE-unix/2149,unix/unix:/tmp/.ICE-unix/2149
<span class="org-variable-name">WINDOWID</span>=52428803
<span class="org-variable-name">COLORTERM</span>=truecolor
<span class="org-variable-name">XDG_CONFIG_DIRS</span>=/etc/xdg
<span class="org-variable-name">HISTCONTROL</span>=ignoredups
<span class="org-variable-name">XDG_MENU_PREFIX</span>=xfce-
 ... .. ... ..  ... .. ... ..  ... .. ...
 ... .. ... ..  ... .. ... ..  ... .. ...
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ env 

<span class="org-variable-name">TMPDIR</span>=/var/folders/jh/w00bgbps79bddlbqwkv31d9m0000gn/T/
<span class="org-variable-name">XPC_FLAGS</span>=0x0
<span class="org-variable-name">LaunchInstanceID</span>=433A53AA-AB93-4CF7-9700-BA15B57FFDAC
<span class="org-variable-name">TERM</span>=xterm-256color
<span class="org-variable-name">LANG</span>=en_US.UTF-8
 ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... 
<span class="org-variable-name">SHELL</span>=/bin/zsh
<span class="org-variable-name">HOME</span>=/Users/unix
<span class="org-variable-name">LOGNAME</span>=unix
<span class="org-variable-name">USER</span>=unix
<span class="org-variable-name">PATH</span>=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
<span class="org-variable-name">SHLVL</span>=1
<span class="org-variable-name">PWD</span>=/Volumes/data/unix-explore
<span class="org-variable-name">OLDPWD</span>=/Volumes/data
<span class="org-variable-name">PS1</span>= $&gt; 
<span class="org-variable-name">_</span>=/usr/bin/env
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8edca68" class="outline-3">
<h3 id="org8edca68"><span class="section-number-3">1.3</span> Widely used functions for strings and buffers in low level codes</h3>
<div class="outline-text-3" id="text-1-3">
<p>
This section provides a recapitulation of the most widely used C
functions in low level code bases and legacy C codes. Those functions
are in the header &lt;string.h&gt; for C or &lt;cstring&gt; for C++.
</p>


<p>
<b>String Manipulation</b> 
</p>

<ul class="org-ul">
<li><span class="underline">strlen()</span> =&gt; Get length of null-terminated character array.
<ul class="org-ul">
<li>Docs: $ man strlen</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">size_t</span> <span class="org-function-name">strlen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>39<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st1 = <span class="org-string">"unix posix irix linux"</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>40<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st2 = <span class="org-string">"bsd msdos"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>41<span class="org-rainbow-delimiters-depth-1">]</span> strlen<span class="org-rainbow-delimiters-depth-1">(</span>st1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 21

root <span class="org-rainbow-delimiters-depth-1">[</span>42<span class="org-rainbow-delimiters-depth-1">]</span> strlen<span class="org-rainbow-delimiters-depth-1">(</span>st2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 9
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strdup()</span> =&gt; Copy a C-string allocating the copy with malloc.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strdup</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>39<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st1 = <span class="org-string">"unix posix irix linux"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>43<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* p_copy = strdup<span class="org-rainbow-delimiters-depth-1">(</span>st1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"unix posix irix linux"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Release memory for heap-allocated string </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>47<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>p_copy<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcmp()</span> =&gt; Compare two C-strings null-terminated (terminated with
'\0' or 0x00 null char) array of characters. This function returns
0 if the two strings are equal.
<ul class="org-ul">
<li>Docs: $ man strcmp</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">strcmp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s2</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------- USAGE --------------------------//</span>
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span> strmcp<span class="org-rainbow-delimiters-depth-2">(</span>STRING_A, STRING_B<span class="org-rainbow-delimiters-depth-2">)</span> == 0 <span class="org-rainbow-delimiters-depth-1">)</span>
    puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" =&gt; Strings are equal"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">else</span> 
    puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" =&gt; Strins are not equal"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------ CERN's Root REPL Session -------// </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> #<span class="org-type">include</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span>string.h<span class="org-rainbow-delimiters-depth-1">&gt;</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s1 = <span class="org-string">"hello"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s2 = <span class="org-string">"world"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s3 = <span class="org-string">"world C++17 c11 ADA spark"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s4 = <span class="org-string">"hello"</span>; 

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -15

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s3<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -15

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s4<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcasecmp()</span> =&gt; Compare two string ignoring case sensitivity. This
function returns 0 if the string arguments are equal. Othewise, it
returns anything other than 0.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">strcasecmp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">string1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">string2</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- USAGE ------------------------------------------// </span>

<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> strcasecmp<span class="org-rainbow-delimiters-depth-2">(</span>stringA, stringB<span class="org-rainbow-delimiters-depth-2">)</span> == 0 <span class="org-rainbow-delimiters-depth-1">)</span>
   printf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" Strings are equal Ok. \n"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">else</span> 
   printf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" Strings are not equal. \n"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----- CERN's ROOT REPL session ----------------------// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Strings not equal </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>21<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"app"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -108

<span class="org-comment-delimiter">// </span><span class="org-comment">Strings are equal </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>22<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"application"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>23<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"AppLiCatION"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
root <span class="org-rainbow-delimiters-depth-1">[</span>24<span class="org-rainbow-delimiters-depth-1">]</span> 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">sprintf()</span> =&gt; Print string to a buffer. (Headers: &lt;cstdio&gt; in C++ or
&lt;stdio.h&gt; in C). Note: this function is vulnerable to buffer
overflow, if the data copied to the buffer is larger than its
size.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">sprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">str</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">format</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- CERN's ROOT REPL session ----------------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>300<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buffer, 0x00, 300<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> sprintf<span class="org-rainbow-delimiters-depth-1">(</span>buffer, <span class="org-string">"The root of %d is equal to %f"</span>, 2, 2.0<span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>300<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The root of 2 is equal to 2.000000\0\0\0\0\0\0\0\.... ... \0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" buffer = &lt;"</span> &lt;&lt; buffer &lt;&lt; <span class="org-string">"&gt;"</span> &lt;&lt; <span class="org-string">'\n'</span>;
buffer = <span class="org-rainbow-delimiters-depth-1">&lt;</span>The <span class="org-type">root</span> <span class="org-variable-name">of</span> 2 is equal to 2.000000<span class="org-rainbow-delimiters-depth-1">&gt;</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">snprintf()</span> =&gt; Print string to a buffer limiting the number of
characters that are copied to the buffer. The limitation of the
number characters copied helps protecting against buffer overflow
vulnerabilities.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">snprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">str</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">format</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- CERN's ROOT REPL session ----------------------------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf<span class="org-rainbow-delimiters-depth-1">[</span>200<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buf, <span class="org-string">'\0'</span>, 200<span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 10, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The squar\0\0\0\0\0... ...\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 25, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The square root of 10.00\0\0\0...\0\0"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 125, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The square root of 10.000000 is equal to 3.162 \0\0\0..\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">dprintf</span> =&gt; Print to file descriptor. It can be used for formatted
printing to any file descriptor, including sockets, pipes, regular
files and standard streams (stdout and stderr).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">format</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-- EXAMPLE =&gt;&gt; CERN's ROOT REPL Session ---------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> dprintf<span class="org-rainbow-delimiters-depth-1">(</span>STDOUT_FILENO, <span class="org-string">" [INFO] x = %d ; sqrt(3) = %.3f \n"</span>, 100, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>3.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">[</span>INFO<span class="org-rainbow-delimiters-depth-1">]</span> x = 100 ; sqrt<span class="org-rainbow-delimiters-depth-1">(</span>3<span class="org-rainbow-delimiters-depth-1">)</span> = 1.732 

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> dprintf<span class="org-rainbow-delimiters-depth-1">(</span>STDERR_FILENO, <span class="org-string">" [INFO] x = %d ; sqrt(3) = %.3f \n"</span>, 100, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>3.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">[</span>INFO<span class="org-rainbow-delimiters-depth-1">]</span> x = 100 ; sqrt<span class="org-rainbow-delimiters-depth-1">(</span>3<span class="org-rainbow-delimiters-depth-1">)</span> = 1.732 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 35
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">asprintf</span> =&gt; Print allocated string. Similar to snprintf, but it
stores the output in a large enough heap-allocated (dynamically
allocated) buffer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">asprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> **<span class="org-variable-name">strp</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">fmt</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">==&gt;&gt; EXAMPLE =&gt;&gt; CERN's ROOT REPL Session ============//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Output </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* output;

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> asprintf<span class="org-rainbow-delimiters-depth-1">(</span>&amp;output, <span class="org-string">" [TRACE] x = %d ; sin(3.1415) = %.5f ; s = %s \n"</span>, -261, sin<span class="org-rainbow-delimiters-depth-2">(</span>3.1415<span class="org-rainbow-delimiters-depth-2">)</span>, <span class="org-string">"Hello world"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 61

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> output 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">" [TRACE] x = -261 ; sin(3.1415) = 0.00009 ; s = Hello world "</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> puts<span class="org-rainbow-delimiters-depth-1">(</span>output<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> x = -261 ; sin<span class="org-rainbow-delimiters-depth-1">(</span>3.1415<span class="org-rainbow-delimiters-depth-1">)</span> = 0.00009 ; s = Hello world 

<span class="org-comment-delimiter">// </span><span class="org-comment">Release allocated memory., </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>output<span class="org-rainbow-delimiters-depth-1">)</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcpy()</span> =&gt; Copy string 'src' parameter (null-terminated array of
characters) to a buffer.
<ul class="org-ul">
<li>Docs: $ man strcpy</li>
<li>Note: It is vulnerable to buffer
overflow, if the size of the string is bigger than the
buffer. This function is often used to for copying string literals
to a buffer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strcpy</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">char</span>*       <span class="org-variable-name">p_buffer</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (array of chars)</span>
             ,<span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">c_string_src</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">C-string </span>
           <span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>200<span class="org-rainbow-delimiters-depth-1">]</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0 ...... \0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> strcpy<span class="org-rainbow-delimiters-depth-1">(</span>buffer, <span class="org-string">"Hello world C++17 C++20 ADA Rust"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 C++20 ADA Rust"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 C++20 ADA Rust\0\0\0\0\0\0\0 ... ... \0\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strncpy()</span> =&gt; Copy N characters from string to buffer.
<ul class="org-ul">
<li>Docs: $ man strncpy</li>
<li>Linux mapage: "The strcpy() function copies the string pointed
to by src, including the terminating null byte ('\0'), to the
buffer pointed to by dest.  The strings may not overlap, and the
destination string dest must be large enough to receive the
copy. Beware of buffer overruns!  (See BUGS.)"</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strncpy</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">char</span>*       <span class="org-variable-name">dest</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer </span>
             , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">src</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">C-string (null-terminated) that will be copied </span>
             , <span class="org-type">size_t</span>      <span class="org-variable-name">n</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Number of chars (bytes) from src that will be copied</span>
             <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---------- CERN's ROOT Repl Session ------------//</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff1<span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff2<span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* cstr = <span class="org-string">"Hello world C++17 embedded systems real time control systems"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>16<span class="org-rainbow-delimiters-depth-1">]</span> buff1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>17<span class="org-rainbow-delimiters-depth-1">]</span> buff2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>18<span class="org-rainbow-delimiters-depth-1">]</span> strncpy<span class="org-rainbow-delimiters-depth-1">(</span>buff1, cstr, 10<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>19<span class="org-rainbow-delimiters-depth-1">]</span> buff1 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>20<span class="org-rainbow-delimiters-depth-1">]</span> strncpy<span class="org-rainbow-delimiters-depth-1">(</span>buff2, cstr, 25<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 embedde"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>21<span class="org-rainbow-delimiters-depth-1">]</span> buff2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 embedde\0\0\0"</span>
</pre>
</div>


<ul class="org-ul">
<li><span class="underline">strcat()</span> =&gt; Manpage: "The strcat() function appends the src string
to the dest string, over‐ writing the terminating null byte ('\0')
at the end of dest, and then adds a terminating null byte.  The
strings may not overlap, and the dest string must have enough
space for the result.  If dest is not large enough, program
behavior is unpredictable; buffer overruns (aka buffer overflow)
are a favorite avenue for attacking secure program"

<ul class="org-ul">
<li>Note: This function is unsafe and can introduce buffer overflow
vulnerability if the size of the <span class="underline">src</span> string is not limited.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span> *<span class="org-function-name">strcat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">src</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------- CERN Root REPL  ------------------//</span>
<span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">null_terminated_char_array1</span>= <span class="org-string">"C++1z KALMAN FILTER sensor fusion data"</span>;
<span class="org-type">char</span> <span class="org-variable-name">buffer1</span><span class="org-rainbow-delimiters-depth-1">[</span>100<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-string">"Append cstring: "</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> buffer1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: \0\0\0\0\0\0\0\0\0\0\0\0\0...\0\0"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> strcat<span class="org-rainbow-delimiters-depth-1">(</span>buffer1, null_terminated_char_array1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data\0\0....\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> strcat<span class="org-rainbow-delimiters-depth-1">(</span>buffer1, <span class="org-string">" string literal "</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data string literal "</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buffer1 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data string literal \0\0\0\0...\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strncat()</span> =&gt; Similar to strcat, but it limits the number of
character to be copied from <span class="underline">src</span> to a buffer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strncat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">src</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------ CERN's Root REPL session ----------------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Stack-allocated buffer </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff<span class="org-rainbow-delimiters-depth-1">[</span>100<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buff, 100, 0x00<span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* str1 = <span class="org-string">"Hello world APL C++1z ADA RUST DLang OCaml"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0...\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1, 10<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0 .. \0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>16<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1, 20<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>17<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0....\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>18<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1 + 25, 30<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1 RUST DLang OCaml"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>19<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1 RUST DLang OCaml\0\0...\0\0"</span>
</pre>
</div>


<ul class="org-ul">
<li><span class="underline">strtok</span> =&gt; Break string into tokens.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strtok</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span>* <span class="org-variable-name">str</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">delim</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Usage Example ------------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* sep = <span class="org-string">","</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Separators</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> text<span class="org-rainbow-delimiters-depth-1">[</span>500<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-string">"BRL , CAD ,, USD ,,, EUR , YEN , JPY"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* tok = strtok<span class="org-rainbow-delimiters-depth-1">(</span>text, sep<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"BRL "</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-1">(</span> tok != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" =&gt; token = %s \n"</span>, tok<span class="org-rainbow-delimiters-depth-2">)</span>; tok = strtok<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, sep<span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
 =&gt; token = BRL  
 =&gt; token =  CAD  
 =&gt; token =  USD  
 =&gt; token =  EUR  
 =&gt; token =  YEN  
 =&gt; token =  JPY 
</pre>
</div>


<ul class="org-ul">
<li><span class="underline">strtoul()</span> =&gt; Attempt to parse an unsigned integer from a
string. On failure, this function sets the <span class="underline">errno</span> variable to
ERANGE.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-function-name">strtoul</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">str</span>, <span class="org-type">char</span>** <span class="org-variable-name">endptr</span>, <span class="org-type">int</span> <span class="org-variable-name">base</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">--------------- Example -----------------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>42<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"1001001"</span>, <span class="org-constant">nullptr</span>, 2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 73

root <span class="org-rainbow-delimiters-depth-1">[</span>43<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"1001001"</span>, <span class="org-constant">nullptr</span>, 10<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 1001001

root <span class="org-rainbow-delimiters-depth-1">[</span>44<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"1001001"</span>, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 16781313

root <span class="org-rainbow-delimiters-depth-1">[</span>45<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"1001001"</span>, <span class="org-constant">nullptr</span>, 8<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 262657

root <span class="org-rainbow-delimiters-depth-1">[</span>46<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"AFBC01"</span>, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 11516929

<span class="org-comment-delimiter">// </span><span class="org-comment">Failure </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>47<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"XAFBC01"</span>, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>54<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"AFBC01 rest of text"</span>, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 11516929

root <span class="org-rainbow-delimiters-depth-1">[</span>55<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">auto</span> n = strtoul<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"  AFBC01 rest of text"</span>, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 11516929
</pre>
</div>

<p>
<b>Buffer Manipulation</b> 
</p>

<ul class="org-ul">
<li><span class="underline">memchr()</span> =&gt; Locate a byte in a buffer or memory region. This
function returns a pointer to the first occurency of the search
byte and returns null pointer if the byte is not found.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-type">void</span>* <span class="org-function-name">memchr</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">int</span> <span class="org-variable-name">byte_searched</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Example: CERN's ROOT REPL Session ----------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>19<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> mybuffer<span class="org-rainbow-delimiters-depth-1">[</span>200<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-string">"hello world 9 10 36 buffer byte array 9 0 %"</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to first occurrency of character '9' (byte)</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>22<span class="org-rainbow-delimiters-depth-1">]</span> p 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"9 10 36 buffer byte array 9 0 %"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>23<span class="org-rainbow-delimiters-depth-1">]</span> p<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'9'</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>24<span class="org-rainbow-delimiters-depth-1">]</span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Position (aka index) where the byte is found </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>35<span class="org-rainbow-delimiters-depth-1">]</span> ptrdiff_t idx = p - mybuffer 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 12

root <span class="org-rainbow-delimiters-depth-1">[</span>37<span class="org-rainbow-delimiters-depth-1">]</span> mybuffer<span class="org-rainbow-delimiters-depth-1">[</span>idx<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'9'</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Next ocurrency </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>41<span class="org-rainbow-delimiters-depth-1">]</span> p = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-1">)</span> memchr<span class="org-rainbow-delimiters-depth-1">(</span>mybuffer + idx + 1, <span class="org-string">'9'</span>, 200 - idx<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"9 0 %"</span>

</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memset()</span> =&gt; Fill some memory area (buffer) with a constant byte.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>*  <span class="org-function-name">memset</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">s</span>, <span class="org-type">int</span> <span class="org-variable-name">c</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------ CERN's ROOT REPL session -------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Create a heap-allocated buffer containing 6 characters. </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* char_heap_buffer = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-1">)</span> malloc<span class="org-rainbow-delimiters-depth-1">(</span>6 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"@\x0e"</span> <span class="org-string">"e\x01"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'@'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-warning">'</span>0x0e<span class="org-warning">'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'e'</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Intialize buffer char_hepa_buffer </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>char_heap_buffer, <span class="org-string">'z'</span>, 6<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x128c760

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"zzzzzz"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>char_heap_buffer<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memcmp()</span>  =&gt; Compare the first N bytes of two buffers. It returns
0 if all the first N bytes from two buffers are equal. Note: This
function can only compare buffers containing POD data (Plain-Old
Data) without any internal pointer or heap-allocated data.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">  <span class="org-type">int</span> <span class="org-function-name">memcmp</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">s1</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to the beginning of buffer 1 </span>
             , <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">s2</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to the beginning of buffer 2 </span>
             , <span class="org-type">size_t</span> <span class="org-variable-name">n</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">Number of bytes that will be compared </span>
           <span class="org-rainbow-delimiters-depth-1">)</span>;  

<span class="org-comment-delimiter">// </span><span class="org-comment">-------- CERN's ROOT REPL Session -----------------------// </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>22<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bf1<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x01, 0xAB, 0x2C, 0x3C, 0xFF <span class="org-rainbow-delimiters-depth-1">}</span>;
 root <span class="org-rainbow-delimiters-depth-1">[</span>26<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bf2<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x01, 0xAB, 0x2C, 0x3C, 0xFF, 0x85, 0x2A, 0x45 <span class="org-rainbow-delimiters-depth-1">}</span>;
 root <span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bfx<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x3A, 0xF8, 0x25 <span class="org-rainbow-delimiters-depth-1">}</span> 

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Non-zero =&gt; First 3 bytes of two buffers are not equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>32<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bfx, 3<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -57

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Zero =&gt; First 5 bytes of two buffers are equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>36<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bf2, 5<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Zero =&gt; First 2 bytes of two buffers are equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>37<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bf2, 2<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

 root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>heap_buffer<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memcpy()</span> =&gt; Copy N bytes from a memory area (or buffer) src to a
memory area dest. This function can only copy POD (Plain Old Data)
types, it cannot copy anything which contains pointers or
heap-allocated data.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">memcpy</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">src</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------- CERN's ROOT Repl session ---------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Char array --------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>51<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf1<span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-string">'h'</span>, <span class="org-string">'e'</span>, <span class="org-string">'l'</span>, <span class="org-string">'l'</span>, <span class="org-string">'o'</span>, <span class="org-string">' '</span>, <span class="org-string">'c'</span>, <span class="org-string">'p'</span>, <span class="org-string">'p'</span>, <span class="org-string">'\0'</span> <span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"hello cpp"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>53<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf2<span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>15<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>54<span class="org-rainbow-delimiters-depth-1">]</span> memcpy<span class="org-rainbow-delimiters-depth-1">(</span>buf2, buf1, 10 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x7f5c5cd7d1b5

root <span class="org-rainbow-delimiters-depth-1">[</span>55<span class="org-rainbow-delimiters-depth-1">]</span> buf2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>15<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"hello cpp\0\0\0\0"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Int array -------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>56<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span> arr1<span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>5<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2 <span class="org-rainbow-delimiters-depth-1">}</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>57<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span> arr2<span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 <span class="org-rainbow-delimiters-depth-1">}</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>58<span class="org-rainbow-delimiters-depth-1">]</span> memcpy<span class="org-rainbow-delimiters-depth-1">(</span>arr2, arr1, 5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x7f5c5cd7d1f0

root <span class="org-rainbow-delimiters-depth-1">[</span>59<span class="org-rainbow-delimiters-depth-1">]</span> arr2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2, 0, 0, 0, 0, 0 <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">bzero()</span> =&gt; Zero-initialize some memory area. In the words of
manpage: "The bzero() function erases the data in the n bytes of
the memory starting at the location pointed to by s, by writing
zeros (bytes containing '\0') to that area."</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">bzero</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">s</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------ CERN's ROOT REPL session --------------//</span>
<span class="org-comment-delimiter">//    </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Heap-allocated buffer with 5 integers</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span>* heap_buffer = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span>*<span class="org-rainbow-delimiters-depth-1">)</span> malloc<span class="org-rainbow-delimiters-depth-1">(</span>5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x2c50ea0

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 37832720

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 51513872

<span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer, filling it with zeroes. </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> bzero<span class="org-rainbow-delimiters-depth-1">(</span>heap_buffer, 5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x2c50ea0

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">bcopy()</span> =&gt; Manpage: "The bcopy() function copies n bytes from src
to dest.  The result is correct, even when both areas overlap."
<ul class="org-ul">
<li>Note: Despite the manpage state that the function is deprecated
it is still used by many legacy codes, so it is still worth
knowing about it.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">bcopy</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">src</span>, <span class="org-type">void</span> *<span class="org-variable-name">dest</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- CERN's ROOT Repl Session --------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>50<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> bzero<span class="org-rainbow-delimiters-depth-1">(</span>buffer, 50 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> buffer 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0... ...\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Null terminated array of chars</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* src1 = <span class="org-string">"This is the buffer 1"</span>; 

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span>src1, buffer, 10<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"This is th\0\0\0\0\0\0\0\0... ...0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span>src1, buffer, 25<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"This is the buffer 1\0\0\0\0\x14\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"control system Modelica / state space model / SIMULINK"</span>, buffer, 40<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"control system Modelica / state space mo\0\0\0\0\0\0\0\0"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc712d24" class="outline-3">
<h3 id="orgc712d24"><span class="section-number-3">1.4</span> Map of user-space APIs of Unix-like Operating Systems</h3>
<div class="outline-text-3" id="text-1-4">
<p>
It is worth knowing where to find common Unix and POSIX (Portable
Operatin System Interface) C APIs, which are common to many UNIX-based
operating systems, such as Linux, BSD-variants, MacOSX, QNX and so
on. In order to enhance the discoverability, this section lists
selected bookmarks to widely used Unix, POSIX and system-specific
Application Programing Interfaces (APIS). 
</p>


<p>
<b>Primitive IO (Read, Open, Close - Sytem Calls)</b>
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/open.2.html">open(2)</a> - Open a file returning a file descriptor.</li>

<li><a href="https://man7.org/linux/man-pages/man2/read.2.html">read(2)</a> - Read data from a file descriptor to a buffer.</li>

<li><a href="https://www.man7.org/linux/man-pages/man2/write.2.html">write(2)</a> - Write data from buffer to file descriptor.</li>

<li><a href="https://man7.org/linux/man-pages/man2/close.2.html">close(2)</a> - Close file descriptor.</li>

<li><a href="https://www.man7.org/linux/man-pages/man2/lseek.2.html">lseek(2)</a> - Position offset for reading writing operation. This
useful for binary files, where some data are located at specific
positions.</li>

<li><a href="https://man7.org/linux/man-pages/man2/readv.2.html">Scatter, gather IO</a> - (reav, writev) - Scatter, Gatter or <a href="https://en.wikipedia.org/wiki/Vectored_I/O">Vectored IO</a>.</li>
</ul>

<p>
<b>File Descriptor Manipulation</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.man7.org/linux/man-pages/man2/dup.2.html">dup, dup2, dup3</a> - Duplicate file descriptors for IO redirection.</li>

<li><a href="https://www.man7.org/linux/man-pages/man2/fcntl.2.html">fcntl(2)</a> - Manipulate file descriptor.</li>
</ul>

<p>
<b>System Information and User Accounts</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=uname&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.2-RELEASE+and+Ports">uname(3)</a> - Get system information, operating system, kernel
version, network name and so on.</li>

<li><a href="https://linux.die.net/man/2/getdomainname">getdomainname(2)</a> - Get/Set domain name.</li>

<li><a href="https://linux.die.net/man/3/getpwnam">getpwnam(3)</a> - Password file entry.</li>

<li><a href="https://linux.die.net/man/3/getgrgid">getgrgid(3)</a> - Group file entry.</li>

<li><a href="https://linux.die.net/man/2/gethostname">gethostname(2)</a> - Get/Set machine hostname.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getpwuid&amp;sektion=3">getpwuid(3)</a> - Get information about current user.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getlogin&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.2-RELEASE+and+Ports">getlogin(2)</a></li>
</ul>

<p>
<b>Network / BSD Sockets</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ip&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">IPv4 Protocol</a> - Internet Protocol Version 4</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ip6&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">IPv6 Protocol</a> - Internet Protocol Version 6</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=unix&amp;sektion=4">Unix Domain Socket</a> - Inter-process communication which is a
replacement for IP protocol on local machine. Unix Domain Sockets
has less overhead than IP protocol on local host. This protocl is
useful for providing network transparency. This API is used by
Docker daemon on local machine, DBUS (Inter Process Communication
BUS common on Linux Desktops systems) and X11 (X Windows
Systems).</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=tcp&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">TCP Protocol</a> - Transmission Control Protocol (Most used protocol over the internet.)</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=udp&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">UDP Protocol</a> - User Datagram Protocol</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=sctp&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">SCTP Protocol</a> - (Internet Stream Control Transmission Protocol) -
New protocol, combining the realibility of TCP with message
boundary feature of UDP. Note: This type of protocol is still not
availability on Windows NT or Windows CE operating systems,
therefore the usage of SCTP is not portable yet.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=socket&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">socket(2)</a> - Create a socket endpoint.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=recv&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">recv(2)</a> - (read) Receive data from socket.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=send&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">send(2)</a> - (write) Send data to socket</li>

<li><a href="https://man7.org/linux/man-pages/man2/read.2.html">read(2)</a> - The read() system call also works with sockets.</li>

<li><a href="https://www.man7.org/linux/man-pages/man2/write.2.html">write(2)</a> - Write sycall also works with sockets. It sends data
from some buffer to socket.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=connect&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">connect(2)</a> - Used by a TCP client socket to initiate connection
to a TCP server socket (a.k.a passive socket or listening socket)
running in local or remote machine.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=accept&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">accept(2)</a> - Used by a TCP server socket (a.k.a passive socket) to
accept connection from a client socket.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=bind&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">bind(2)</a> - Used by a TCP server socket to bind to some TCP port
(16 bits unsigned number from 0 to 65535). Note: Ports which
number is less than 1024 requires administrative or root
privilege.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=listen&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">listen(2)</a> - (Server socket) - Listen connection.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getsockopt&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getsockopt(2)</a> - Get and set socket options.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=gethostbyname&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">gethostbyname(3)</a> - Query DNS, get IPv4 or IPv6 network address from hostname.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=byteorder&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">byteorder(3)</a> (htonl, htons, nothl, ntohs) - Convert from/to
network and host machine endianess for numerical values.</li>
</ul>

<p>
<b>IO Multiplexing</b> (aka non-blocking IO)
</p>

<p>
Note: As most of those APIs are not standardized. In order to ensure
code portability, it is better to use C++ libraries that encapsulates
multiplexed IO (Input/Output) APIs rather than use them directly. Some
of those libraries are: Boost.ASIO (C++ library) and LibUV (C library).
</p>

<p>
Standardized APIs:
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/select.2.html">select(2)</a> - (Standardized, common to Linux, BSD and MacOSX)</li>

<li><a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll(2)</a> (Linux Docs); <a href="https://www.freebsd.org/cgi/man.cgi?poll">poll</a> (BSD Docs) - (Standardized, common to
Linux, BSD and MacOSX)</li>
</ul>

<p>
Non-standardized APIs: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man7/epoll.7.html">epoll(7)</a> - [BEST] Linux-only API for IO multiplexing API.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?kqueue">kqueue</a> - [BEST] BSD-Only API for IO multiplexing. This API is
available at: FreeBSD; NetBSD; OpenBSD; DragonFlyBSD and MacOSX.</li>
</ul>

<p>
<b>Threads and Concurrency</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/clone.2.html">clone(2)</a> [LINUX ONLY] - clone() system call wrapper used for
creating processes or threads. This API is also a fundamental
building block of Linux container runtimes, such as Docker and
Podman.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=pthread&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+12.2-RELEASE&amp;arch=default&amp;format=html">pthread</a> (BSD Docs) - Posix API Threads and concurrency primitives.</li>

<li><a href="https://man7.org/linux/man-pages/man7/pthreads.7.html">pthreads(7)</a> (Linux Docs)</li>

<li><a href="https://linux.die.net/man/3/pthread_create">pthread_create(3)</a> - Create new thread.</li>

<li><a href="https://linux.die.net/man/3/pthread_join">pthread_join(3)</a></li>

<li><a href="https://linux.die.net/man/3/pthread_detach">pthread_detach(3)</a></li>

<li><a href="https://linux.die.net/man/3/pthread_exit">pthread_exit(3)</a> - terminate calling thread</li>

<li><a href="https://linux.die.net/man/3/pthread_cancel">pthread_cancel(3)</a></li>
</ul>

<p>
<b>Process Control APIs</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=execve&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">execve(2)</a> =&gt; Run a process (Execv system call)</li>

<li><a href="https://man7.org/linux/man-pages/man3/fexecve.3.html">fexecve(3)</a> =&gt; Similar to execve, but executes program (any Unix
native-code executable or script starting with shebgang #! such
as #!/usr/bin/python &#x2026;) from file descriptor.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=fork&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">fork()</a> =&gt; Fork system call, often used alongside Execv.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=exit&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">exit(3)</a> =&gt; Exit system call. Force termination of current process.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=wait&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">wait(2)</a> =&gt; Wait for a process.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getpid&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getpid()</a> =&gt; Get process unique identifier, PID</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getppid&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getppid()</a> =&gt; Get parent process PID.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getpgrp&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getpgrp()</a> =&gt; Get process group IDs</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getsid&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getsid(2)</a> =&gt; Get process session ID.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=chdir&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">chdir</a> =&gt; Current working directory</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=environ&amp;sektion=7&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">environ(7)</a> =&gt; All environment variables from current process.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=kill&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">kill(2)</a> =&gt; Send UNIX signal to process. It can also be used to
request or force process termination.</li>
</ul>

<p>
<b>IPC - Inter Process Communication</b>  (Except socket)
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=mmap&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">mmap(2)</a> (BSD Docs) =&gt; Map file descriptor to process virtual
memory or allocate memory. This API can also be used for shared
memory inter-process communication.</li>

<li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2)</a> (Linux Docs)</li>

<li><a href="https://developer.blackberry.com/native/reference/core/com.qnx.doc.neutrino.lib_ref/topic/m/mmap.html">mmap</a> (Blackberry)</li>
</ul>

<p>
<b>Memory Management</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/getpagesize.2.html">getpagesize(2)</a>  =&gt; Get memory page size.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=mmap&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">mmap(2)</a> (BSD Docs) =&gt; Map file descriptor to virtual memory or
allocate memory.</li>

<li><a href="https://man7.org/linux/man-pages/man2/msync.2.html">msync(2)</a> - Synchronize file with memory mapping.</li>

<li><a href="https://man7.org/linux/man-pages/man2/mremap.2.html">mremap(2)</a> =&gt; Remap virtual memory region.</li>

<li><a href="https://man7.org/linux/man-pages/man2/mprotect.2.html">mprotect(2)</a> =&gt; Change protection for some memory region.</li>

<li><a href="https://man7.org/linux/man-pages/man2/mlock.2.html">mlock(2)</a>  =&gt; Lock/ulock memory.</li>

<li><a href="https://man7.org/linux/man-pages/man2/brk.2.html">brk, sbrk</a> (Linux) =&gt;  Change data segment. (Process Heap)</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=sbrk&amp;sektion=2&amp;manpath=FreeBSD+12.2-RELEASE+and+Ports">brk, sbrk</a> (Free BSD)</li>

<li><a href="https://man7.org/linux/man-pages/man3/memalign.3.html">memalign(3)</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/malloc.3.html">malloc, calloc, realloc, free</a> - Dynamic memory allocation. (High Level)</li>
</ul>


<p>
<b>Dynamic Loading of Shared Libraries at Runtime</b> 
</p>

<p>
Note: shared libraries (Windows DLLs - Dynamic Linked Libraries) are
called SO (Shared Object) or DSO (Dynamic Shared Object) on Unix-based
systems. 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dlopen&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">dlopen(3)</a> - Load shared library in process address space.</li>

<li><a href="https://man7.org/linux/man-pages/man3/dlclose.3.html">dlclose(3)</a> - Close shared library.</li>

<li><a href="https://man7.org/linux/man-pages/man3/dlerror.3.html">dlerror(3)</a> - Get error diagnostics for dlopen() API.</li>

<li><a href="https://man7.org/linux/man-pages/man3/dlsym.3.html">dlsym(3)</a>  - Load symbol, function pointer or variable, from shared library.</li>

<li><a href="https://man7.org/linux/man-pages/man3/dlvsym.3.html">dlvsym(3)</a> - Similar to dlsym, but allows loading an specific version of a symbol.</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dlinfo&amp;sektion=3&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">dlinfo(3)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dladdr&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">dladdr(3)</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/dl_iterate_phdr.3.html">dl_iterate_phdr(3)</a> - Iterate over the list of shared libraries
loaded by the current process.</li>
</ul>

<p>
<b>Functionalities for supporting containers and sandboxing</b> 
</p>

<p>
Containers are a lightweight virtualization alternative to virtual
machines, that uses fewer system resources, such as memory and CPU
time as unlike virtual machines, containers share the same
kernel. Containers are nothing more than <span class="underline">sandboxed processes</span> with
restricted access to system resources. On Linux, container runtimes,
such as Docker, Podman (Red-Hat) or LXC implement containers with the
following APIs: <span class="underline">cgroups</span> API for restricting CPU time and memory usage;
<span class="underline">chroot</span> or restricting the directories that a sandboxed processes can
access and making them look like the process' root directory; Linux
user, pid, mount, network and <span class="underline">namespaces</span> for restricting user
privilege, access to system directories and network. 
</p>


<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/clone.2.html">clone(2)</a> [LINUX ONLY] - clone() system call for creating
processes with Linux namespaces, which can restrict a process
capability and system access. This system call is also the
primitive for creating new processes or threads.</li>

<li><a href="https://man7.org/linux/man-pages/man2/unshare.2.html">unshare(2)</a></li>

<li><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities(7)</a> - Capability-based security feature which allows
limiting what executables with SETUID bit set can do.</li>

<li><a href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroups(7) - Linux manual page</a></li>

<li><a href="https://8gwifi.org/docs/linux-namespace.jsp">Linux namespaces pid,network,mount,ipc,uts,user,cgroup</a></li>

<li><a href="https://man7.org/linux/man-pages/man2/setns.2.html">setns(2) - Linux manual page</a></li>

<li><a href="https://man7.org/linux/man-pages/man7/ipc_namespaces.7.html">ipc_namespaces(7) - Linux manual page</a></li>
</ul>

<p>
<b>Low Level Terminal API</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=termios&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">termios(4)</a></li>

<li><a href="https://man7.org/linux/man-pages/man5/terminfo.5.html">terminfo(5)</a> - Terminal capability database.</li>

<li><a href="https://man7.org/linux/man-pages/man5/termcap.5.html">termcap(5)</a> - Terminal capability database.</li>

<li><a href="https://man7.org/linux/man-pages/man3/isatty.3.html">isatty(3)</a> =&gt; Check whether file descriptor is a terminal (pseudo
terminal). This function is used in this way:
isatty(STDIN_FILENO), if this expression returns true (1), the
current process is running a terminal emulator, otherwise it is
not running in a terminal.  Note: STDIN_FILENO, has value 1, and
refers to standard input (stdin).</li>

<li><a href="https://man7.org/linux/man-pages/man3/ttyname.3.html">ttyname(3)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=tty&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">tty(4)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=pty&amp;sektion=4&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">pty(4)</a> - BSD-style and System V-style compatibility pseudo-terminal driver</li>

<li><a href="https://man7.org/linux/man-pages/man4/pts.4.html">pts(4)</a> - Pseudo Terminal Pairs</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=pty&amp;apropos=0&amp;sektion=3&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports&amp;arch=default&amp;format=html">pty(3)</a> (BSD) - openpty, forkpty</li>

<li><a href="https://man7.org/linux/man-pages/man7/pty.7.html">pty(7)</a> (Linux) - Pseudo Terminal Interfaces</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=posix_openpt&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">posix_openpt(2)</a></li>

<li><a href="https://man7.org/linux/man-pages/man4/console_ioctl.4.html">console_ioctl(4)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=login_tty&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">login_tty(3)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=unlockpt&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">unlockpt(3)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ptsname&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">ptsname(3)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ioctl&amp;sektion=2&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">ioctl(2)</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=tcsetattr&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">tcsetattr(3)</a></li>

<li><a href="https://man7.org/linux/man-pages/man1/tput.1.html">tput(1)</a> - Query terminal database</li>
</ul>


<p>
<b>Terminal Escape and Control Sequences</b> 
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/7990989775/xbd/termios.html">General Terminal Interface</a>
<ul class="org-ul">
<li>Open Group, Single UNIX specification.</li>
</ul></li>

<li><a href="https://espterm.github.io/docs/VT100%20escape%20codes.html">VT100 escape codes</a></li>

<li><a href="https://wiki-dev.bash-hackers.org/scripting/terminalcodes">Terminal codes (ANSI/VT100) introduction - Bash Hackers Wiki (DEV 20200708T2203)</a></li>

<li><a href="https://gist.github.com/justinmk/a5102f9a0c1810437885a04a07ef0a91">XTerm-Control-Sequences.txt · GitHub</a></li>

<li><a href="https://iterm2.com/documentation-escape-codes.html">Proprietary Escape Codes / iTerm2</a>
<ul class="org-ul">
<li>Listing of iTerm2 (MacOSX-only terminal emulator) proprietary escap sequences.</li>
</ul></li>

<li><a href="https://solarianprogrammer.com/2019/04/08/c-programming-ansi-escape-codes-windows-macos-linux-terminals/">C Programming - using ANSI escape codes on Windows, macOS and Linux terminals | Solarian Programmer</a></li>

<li><a href="https://tldp.org/HOWTO/Bash-Prompt-HOWTO/x405.html">Colours and Cursor Movement With tput</a></li>
</ul>


<p>
<b>Articles related to pseudo-terminal device API:</b>
</p>

<ul class="org-ul">
<li>[BEST] <a href="https://devblogs.microsoft.com/commandline/windows-command-line-introducing-the-windows-pseudo-console-conpty/">Windows Command-Line: Introducing the Windows Pseudo Console (ConPTY) | Windows Command Line</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Line_discipline">Line discipline - Wikipedia</a></li>

<li><a href="https://linux.die.net/man/7/pty">pty - pseudoterminal interfaces / Linux Manpage</a></li>

<li><a href="https://docs.oracle.com/cd/E19253-01/816-4855/index.html">Streams Programming Guide - Oracle</a></li>

<li><a href="https://pubs.opengroup.org/onlinepubs/007908775/xbd/termios.html">General Terminal Interface - UNIX Open Group</a></li>

<li><a href="https://www.feyrer.de/NetBSD/ttys.html">TTYs and X Windows - Unix User Interaction now and then</a></li>

<li><a href="https://jdebp.eu/FGA/bernstein-on-ttys/cttys.html">Controlling TTYs: A Unix Horror Story</a></li>

<li><a href="https://www.linusakesson.net/programming/tty/">The TTY desmystified.</a></li>

<li><a href="https://blog.nelhage.com/2009/12/a-brief-introduction-to-termios/">A brief introduction to Termios</a></li>

<li><a href="https://blog.nelhage.com/2009/12/a-brief-introduction-to-termios-termios3-and-stty/">A brief introduction to termios:(3) and stty</a></li>

<li><a href="http://poincare.matf.bg.ac.rs/~ivana/courses/ps/sistemi_knjige/pomocno/apue/APUE/0201433079/ch09lev1sec6.html">Controlling terminal</a></li>

<li><a href="https://www.freebsd.org/doc/handbook/consoles.html">Virtual Consoles and Terminals</a></li>

<li><a href="https://justaguyinphilly.wordpress.com/2011/09/04/tty-session-leader-terminal-controlling-terminal-stdout-and-stdin-foreground-and-background/">tty, session leader, terminal, controlling terminal, stdout and stdin, foreground and background</a></li>

<li><a href="https://docs.oracle.com/cd/E19504-01/802-5893/termsub15-20749/index.html">Terminal Packet Mode - STREAMS Programming Guide - Oracle</a></li>

<li><a href="https://uw714doc.xinuos.com/en/SDK_sysprog/_Pseudo-tty_Drivers_em_ptm_and_p.html">Pseudo-tty drivers &#x2013; ptm and pts</a></li>

<li><a href="https://uw714doc.xinuos.com/en/SDK_sysprog/TermDevCntl.html">Terminal device control</a></li>

<li><a href="https://en.m.wikibooks.org/wiki/Serial_Programming/termios">Serial Programming/termios - Wikibooks, open books for an open world</a></li>

<li><a href="https://codereview.stackexchange.com/questions/119165/terminal-esc-sequence-decoder">c++ - Terminal ESC Sequence Decoder - Code Review Stack Exchange</a></li>

<li><a href="https://ttssh2.osdn.jp/manual/4/en/reference/sourcecode.html">Tera Term Source Code Overview</a></li>
</ul>


<p>
<b>Utilities for PTY - Pseudo-Terminal Interface</b> 
</p>


<ul class="org-ul">
<li><a href="https://metacpan.org/pod/Expect">Expect</a> (Perl) - - automate interactions with command line programs
that expose a text terminal interface. - metacpan.org</li>

<li><a href="https://www.tecmint.com/record-and-replay-linux-terminal-session-commands-using-script/">How to Record and Replay Linux Terminal Sessions using 'script' and 'scriptreplay' Commands</a></li>

<li><a href="https://terminal.sexy/">terminal.sexy - Terminal Color Scheme Designer</a> (Online Tool)</li>

<li><a href="https://blog.nelhage.com/2011/02/changing-ctty/">reptyr: Changing a process's controlling terminal</a></li>

<li><a href="http://www.kermitproject.org/">Open-Source Kermit Project</a> 
<ul class="org-ul">
<li>"Kermit is a robust transport-independent file-transfer protocol
and a large collection of software programs that implement it on
a wide variety of platforms. In addition to file transfer, many
of these programs also make network, dialed, and/or serial-port
connections and also offer features such as terminal emulation,
character-set conversion, and scripting for automation of any
communication or file-management task. The Kermit Project
originated at Columbia University in New York City in 1981 and
remained there for 30 years. Since 2011 it is independent. CLICK
HERE for more about the Kermit Project."</li>
</ul></li>

<li><a href="https://www.thehumblelab.com/anatomy-of-my-macos-terminal/">Anatomy of My MacOS Terminal</a></li>
</ul>

<p>
<b>Linux-specific (VFS) Virtual File System APIs</b> 
</p>

<p>
GENERAL: 
</p>

<ul class="org-ul">
<li><a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html">Overview of the Linux Virtual File System — The Linux Kernel documentation</a></li>

<li><a href="https://www.starlab.io/blog/introduction-to-the-linux-virtual-filesystem-vfs-part-i-a-high-level-tour">Introduction to the Linux Virtual Filesystem (VFS) &#x2013; Part I: A High-Level Tour — Star Lab Software</a></li>

<li><a href="https://www.win.tue.nl/~aeb/linux/lk/lk-8.html">The Linux kernel: The Linux Virtual File System</a></li>

<li><a href="https://www.kernel.org/doc/gorman/html/understand/understand015.html">Shared Memory Virtual Filesystem</a></li>
</ul>

<p>
SYSFS VFS: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man5/sysfs.5.html">SYSFS</a> - VFS that exports Kernel objects. Some files in SYSFS are
mapped to real hardware such as GPIOs; I2C; CAN bus; PCI Bus; USB
bus and so on.</li>

<li><a href="https://www.kernel.org/doc/ols/2005/ols2005v1-pages-321-334.pdf">The sysfs Filesystem</a> - Patrick Mochel</li>
</ul>

<p>
PROCFS VFS:
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man5/proc.5.html">PROCFS</a> - Procfs /proc file system.</li>

<li><a href="http://www.linux-admins.net/2010/09/all-you-need-to-know-about-procsys.html">/PROC/SYS</a> - Directory for manipulating Kernel runtime parameters
(sysctl tool)</li>
</ul>

<p>
TMPFS VFS: 
</p>

<ul class="org-ul">
<li>Brief: Virtual file system stored in volatime memory. This VSF
allows files to be manipulated entirely on RAM volatile memory
with just ordinary open(), read(), close(), write() system calls
without touching the disk and without incurring on any IO
overhead. The directories <span class="underline">/dev/shm</span> and <span class="underline">/tmp</span> are TMPFS VSFs, are
entirely mounted on RAM memory. Any files stored on those
directories are lost after system reboot.</li>

<li><a href="https://www.kernel.org/doc/html/latest/filesystems/tmpfs.html">Tmpfs — The Linux Kernel documentation</a></li>

<li><a href="https://developpaper.com/about-tmpfs-dev-shm-and-oracle/">About tmpfs, /dev/shm and Oracle | Develop Paper</a></li>

<li><a href="https://docs.observium.org/persistent_ramdisk/">Persistent RAM disk - Observium</a></li>

<li><a href="https://kb.virtubox.net/knowledgebase/improve-nginx-cache-performance-with-tmpfs/">Improve Nginx cache performance with tmpfs - VirtuBox</a></li>

<li><a href="https://www.howtoforge.com/storing-files-directories-in-memory-with-tmpfs">Storing Files/Directories In Memory With tmpfs</a></li>

<li><a href="https://2bits.com/articles/reduce-your-servers-resource-usage-moving-mysql-temporary-directory-ram-disk.html">Reduce your server's resource usage by moving MySQL temporary directory to tmpfs</a></li>
</ul>


<p>
<b>Linux System Calls</b> (Assembly)
</p>

<ul class="org-ul">
<li><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">Linux System Call Table for x86 64 · Ryan A. Chapman</a></li>

<li><a href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md">Chromium OS Docs - Linux System Call Table</a></li>

<li><a href="https://gist.github.com/yamnikov-oleg/454f48c3c45b735631f2">Linux Syscalls Reference · GitHub</a></li>
</ul>


<p>
<b>System V Calling Conventions</b>  
</p>

<p>
Calling conventions adopted by most Unix-like Operating Systems for
C-compatible APIs.
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions">x86 calling conventions - Wikipedia</a></li>

<li><a href="https://wiki.osdev.org/System_V_ABI">System V ABI - OSDev Wiki</a></li>

<li><a href="https://www.uclibc.org/docs/psABI-x86_64.pdf">System V Application Binary Interface</a>  - AMD64 Architecture
Processor Supplement - Draft Version 0.99.7</li>

<li>(Aaron Bloomfield) - <a href="https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf">Chapter 1 - The 64 bit x86 C Calling Convention</a></li>

<li>(Agner Fog) - <a href="https://www.agner.org/optimize/calling_conventions.pdf">Calling conventions for different C++ compilers and operating systems</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf426ad2" class="outline-3">
<h3 id="orgf426ad2"><span class="section-number-3">1.5</span> Creating Portable Binaries for Linux / GLIBC Dependency Hell</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org38fe854" class="outline-4">
<h4 id="org38fe854"><span class="section-number-4">1.5.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
One of the greatest challenges of Linux desktop is building and
deploying portable applications and native executable which work on
any Linux distribution. Even if an application totally statically
linked against all dependencies or it is bundled with all its shared
libraries dependencies via LD_LIBRARY_PATH environment variable or
RPATH, the program may still fail to run in other Linux distribution
due to the GLIBC (GNU C library runtime) dependency. A GLIBC is <span class="underline">forward</span>
<span class="underline">compatible</span>, but not <span class="underline">backward compatible</span>, the GLIBC runtime failure is
more likely to happen if the application was built on a Linux
distribution using a newer version of GLIBC, but the program is
deployed in a distribution using an older version of GLIBC.
</p>


<ul class="org-ul">
<li>Side Note 1:
<ul class="org-ul">
<li>Applications built with GO (Golang) programming
language are less likely to be affected by the GLIBC-issue, as GO
compiler often does not link against the GLIBC and builds
statically linked binaries which can be deployed everywhere.</li>
</ul></li>

<li>Side Note 2:
<ul class="org-ul">
<li>The GLIBC issue does not only affect C++, all programming
languages which generate native Linux executable, for
instance, D-lang, Rust, OCaml, Haskell may also be affected
due to the GLIBC compatibility problem. Besides executables, the
GLIBC-dependency hell can also impact shared libraries, also
known as share objects, and consequently native libraries used
by programming languages such as Python, Ruby, Java and so on.</li>
</ul></li>

<li>Side Note 3:
<ul class="org-ul">
<li>Even <a href="https://appimage.org/">AppImage</a>, which is a solution for distributing binaries on
Linux is affected by the GLIBC-problem. As a result, the
AppImage documentation recommends building AppImage on Linux
distributions with older versions of GlibC.</li>
</ul></li>

<li>Side Node 4:
<ul class="org-ul">
<li>The GLIBC can be bypassed if the application invokes
system-calls directly by using assembly or inline assembly. On
Linux, this is possible because the system calls are stable and
well documented. This might be the approach used by Golang for
avoiding the GLIBC dependency.</li>
</ul></li>
</ul>

<p>
Possible Solutions: 
</p>

<ol class="org-ol">
<li>Link against an older version of GLIBC
<ul class="org-ul">
<li>Build the application in a system with the oldest possible version
of GLIBC. <span class="underline">System</span> in this context means: a linux virtual machine; a
chroot environment or a docker image with an older version of
GLIBC.</li>
</ul></li>

<li>Link against MUSL (CRT - C Runtime Library)
<ul class="org-ul">
<li>The MUSL library, is an alternative to GLIBC, which was
designed for embedded systems and static linking, allows
building statically linked binaries that does not suffer from
the GLIBC compatibility problems. The drawback of this
procedure is that dynamic loading with <span class="underline">dlopen</span> API (dlopen,
dlclose, dlsym functions) is still not supported.</li>
</ul></li>

<li>Deploy via Docker
<ul class="org-ul">
<li>Deploy the application via docker image. While this solution is
acceptable for compilers, building environments, servers and
command line applications, Docker is not suitable for games or
Desktop GUI (Graphical User Interface) applications intended
to be used by non-technical users.</li>
<li>Advantage:
<ul class="org-ul">
<li>Pack application, dependencies and configuration.</li>
<li>The deployment environment can be reproduced everywhere.</li>
</ul></li>
</ul></li>

<li>Distribute as source and recompile from source on every
deployment machine.</li>

<li>Distribute the application via Linux distribution repositories
<ul class="org-ul">
<li>Distribute the application via official Linux distribution
repositories by creating distribution-specific packages for
every supported distribution. It means creating (.deb) Debian packages for
Debian-based distributions; (.rpm) packages for Fedora and
Centos; (.apk) alpine packages for Alpine.</li>
</ul></li>
</ol>

<p>
<b>Further Reading</b> 
</p>

<p>
General reading about Linux CRT (C Runtime Library), GlibC and alternatives:
</p>

<ul class="org-ul">
<li><a href="https://abi-laboratory.pro/index.php?view=timeline&amp;l=glibc">API/ABI changes review for glibc</a></li>

<li><a href="https://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a>
<ul class="org-ul">
<li>Brief: "The table below and notes which follow are a comparison
of some of the different standard library implementations
available for Linux, with a particular focus on the balance
between feature-richness and bloat. I have tried to be fair and
objective, but as I am the author of musl, that may have
influenced my choice of which aspects to compare. Future
directions for this comparison include detailed performance
benchmarking and inclusion of additional library
implementations, especially Google's Bionic and other BSD libc
ports."</li>
</ul></li>

<li><a href="https://lwn.net/Articles/488847/">A turning point for GNU libc - LWN.net</a> - Jonathan Corbet
<ul class="org-ul">
<li>Brief: "The kernel may be the core of a Linux system, but neither
users nor applications deal with the kernel directly. Instead,
almost all interactions with the kernel are moderated through the
C library, which is charged with providing a standards-compliant
interface to the kernel's functionality. There are a number of C
library implementations available, but, outside of the embedded
sphere, most Linux systems use the GNU C library, often just
called "glibc." The development project behind glibc has a long
and interesting history which took a new turn with the
dissolution of its steering committee on March 26. &#x2026; &#x2026;"</li>
</ul></li>

<li><a href="https://lwn.net/Articles/771441/">C library system-call wrappers, or the lack thereof = LWN.net</a> - Jonathan Corbet
<ul class="org-ul">
<li>Brief: "User-space developers may be accustomed to thinking of
system calls as direct calls into the kernel. Indeed, the first
edition of The C Programming Language described read() and
write() as "a direct entry into the operating system". In
truth, user-level "system calls" are just functions in the C
library like any other. But what happens when the developers of
the C library refuse to provide access to system calls they
don't like? &#x2026; "</li>
</ul></li>

<li><a href="https://akkadia.org/drepper/symbol-versioning">ELF Symbol Versioning</a> - <span class="underline">Ulrich Drepper</span>
<ul class="org-ul">
<li>Brief: "The symbol versioning implementation used on Linux with glibc
2.1 o up is an extension of Sun's versioning.  It provides most
of the functionality Sun has plus one decisive new element:
symbol-level versioning with multiple definitions of a
symbol. The implementation allows every DSO to either use
versions for their symbols or not. &#x2026; &#x2026;"</li>
</ul></li>

<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/libc-talk.pdf">Choosing System C library</a> - Khem Raj (Comcast) - Embedded Linux
Conference	Europe 2014 Düsseldorf Germany.</li>

<li><a href="https://wiki.osdev.org/C_Library">Wikidev - C Library</a>
<ul class="org-ul">
<li>Brief: "The C standard library provides string manipulation
(string.h), basic I/O (stdio.h), memory allocation (stdlib.h),
and other basic functionality to C programs. The interface is
described in the C standard, with further additions described
in POSIX as well as vendor extensions. On Unix platforms, the
library is named libc and is linked automatically into every
executable. &#x2026; ."</li>
</ul></li>

<li><a href="https://www.lightofdawn.org/wiki/wiki.cgi/NewAppsOnOldGlibc">Running new applications on old glibc - (lightofdawn)</a>
<ul class="org-ul">
<li>Brief: "Glibc (short for GNU Libc, or GNU C Library) is a
library that provides the interface between application
programs and the Linux kernel. Although its official name is
the "C" library (library for programs written in the "C"
language), virtually all dynamically linked program binaries
depend on it - it is the de-facto system library in almost all
Linux operating systems. &#x2026; "</li>
</ul></li>

<li><a href="https://stackoverflow.com/questions/847179/multiple-glibc-libraries-on-a-single-host">linux - Multiple glibc libraries on a single host - Stack Overflow</a>
<ul class="org-ul">
<li>Brief: "Multiple glibc libraries on a single host. My linux
(SLES-8) server currently has glibc-2.2.5-235, but I have a
program which won't work on this version and requires
glibc-2.3.3. Is it possible to have multiple glibcs installed
on the same host? This is the error I get when I run my program
on the old glibc: &#x2026;"</li>
</ul></li>

<li><a href="https://wiki.musl-libc.org/">musl libc Wiki</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC - allows
creating fully statically linked and self-contained binaries)
<ul class="org-ul">
<li>Brief: "musl is a C standard library implementation for
Linux. This is a wiki maintained by the enthusiastic user
community of musl. Some of musl’s major advantages over glibc
and uClibc/uClibc-ng are its size, correctness, static
linking support, and clean code."</li>
</ul></li>

<li><a href="https://github.com/ifduyue/musl">GitHub - ifduyue/musl</a> - Unofficial mirror of MUSL (CRT)</li>

<li><a href="https://wiki.musl-libc.org/projects-using-musl.html">musl libc - Projects using musl</a> - List of projects using MUSL
libC instead of GLIBC (GNU C Library)</li>

<li><a href="https://sourceware.org/newlib/">The Newlib Homepage</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC)
<ul class="org-ul">
<li>Brief: "Newlib is a C library intended for use on embedded
systems. It is a conglomeration of several library parts, all
under free software licenses that make them easily usable on
embedded products. Newlib is only available in source form. It
can be compiled for a wide array of processors, and will
usually work on any architecture with the addition of a few
low-level routines."</li>
</ul></li>

<li><a href="https://github.com/hwoarang/uClibc">GitHub - hwoarang/uClibc</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC)
<ul class="org-ul">
<li>Brief: "uClibc (aka µClibc/pronounced yew-see-lib-see) is a C
library for developing embedded Linux systems.  It is much
smaller than the GNU C Library, but nearly all applications
supported by glibc also work perfectly with uClibc.  Porting
applications from glibc to uClibc typically involves just
recompiling the source code. uClibc even supports shared
libraries and threading.  It currently runs on standard Linux
and MMU-less (also known as µClinux) systems with support for
alpha, ARM, cris, e1, h8300, i386, i960, m68k, microblaze,
mips/mipsel, PowerPC, SH, SPARC, and v850 processors. &#x2026;"</li>
</ul></li>
</ul>

<p>
System Calls and GlibC: 
</p>

<ul class="org-ul">
<li><a href="https://sys.readthedocs.io/en/latest/doc/07_calling_system_calls.html">Calling System Calls — Glibc and System Calls 1.0 documentation</a></li>

<li><a href="https://www.linuxplumbersconf.org/event/7/contributions/703/attachments/687/1271/lpc-syscalls-20200828.pdf">glibc and system call wrappers</a> - Florian Weimer, Red Hat Platform Tools Team</li>

<li><a href="https://lwn.net/Articles/655028/">Glibc wrappers for (nearly all) Linux system calls - LWN.net</a> - Jonathan Corbet
<ul class="org-ul">
<li>Brief: " &#x2026; A C programmer working with glibc now would look in vain
for for a straightforward way to invoke a number of Linux system
calls, including futex(), gettid(), getrandom(), renameat2(),
execveat(), bpf(), kcmp(), seccomp(), and a number of
others. The only way to get at these system calls is via the
syscall() function. Over the years, there have been requests to
add wrappers for a number of these system calls; in some cases,
such as gettid() and futex(), the requests were summarily
rejected by the (at-the-time) glibc maintainer in fairly typical
style. &#x2026;"</li>
</ul></li>

<li><a href="https://12000.org/my_notes/system_calls_in_linux/system_call_in_linux.htm">How system calls work in Linux</a> - Nasser M. Abbasi.</li>
</ul>

<p>
Utilities to Patch and modify ELF binaries and other general utilities: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/NixOS/patchelf">GitHub - NixOS/patchelf</a>
<ul class="org-ul">
<li>Brief: "PatchELF is a simple utility for modifying existing ELF
executables and libraries. In particular, it can do the
following: Change the dynamic loader ("ELF interpreter") of
executables; Change the RPATH of executables and libraries;
Shrink the RPATH of executables and libraries."</li>
</ul></li>

<li><a href="https://github.com/wheybags/glibc_version_header/">GitHub - wheybags/glibc_version_header</a> (Utility for ignoring ELF
symbol version - note: it is not safe). 
<ul class="org-ul">
<li>Brief: "Build portable Linux binaries, no more linker errors on users'
older machines from incompatible glibc versions. Essentially,
this is a tool that allows you to specify the glibc version
that you want to link against, regardless of what version is
installed on your machine. This allows you to make portable
Linux binaries, without having to build your binaries on an
ancient distro (which is the current standard practice). "</li>
</ul></li>

<li><a href="https://github.com/emk/rust-musl-builder">GitHub - emk/rust-musl-builder</a>
<ul class="org-ul">
<li>Brief: ": Docker images for compiling static Rust binaries
using musl-libc and musl-gcc, with static versions of useful C
libraries. Supports openssl and diesel crates. "</li>
</ul></li>
</ul>

<p>
Reports of GLIBC dependency hell (Version mismatch): 
</p>

<ul class="org-ul">
<li><a href="https://users.rust-lang.org/t/i-often-run-into-issues-with-glibc-versions-on-the-target-machine-is-there-anything-i-can-do-to-prevent-that/32242">I often run into issues with glibc versions on the target machine is there anything i can do to prevent that?</a></li>

<li><a href="https://web.archive.org/save/https://www.dropboxforum.com/t5/Dropbox-installs-integrations/Cannot-run-latest-dropboxd-on-Centos-7-with-glibc-2-17-and/td-p/431544">Cannot run latest dropboxd on Centos 7 with glibc 2.17, and flatpak version crashes</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3d7e7e" class="outline-4">
<h4 id="orgf3d7e7e"><span class="section-number-4">1.5.2</span> The GLIBC Problem</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
<b>GLIBC - Problem Illustration with a Sample Project</b> 
</p>

<p>
GIST Containing all files used in this experiment: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">https://gist.github.com/0557cd0fa1d5370723b015e443a7c036</a></li>
</ul>

<p>
File: Makefile
</p>

<div class="org-src-container">
<pre class="src src-make">build:
        cmake --config Debug -H. -B_build2
        cmake --build _build2 --target 
</pre>
</div>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment">#========== Targets Configurations ============#</span>
        <span class="org-function-name">add_executable</span>( filesys filesys.cpp )
<span class="org-function-name">target_link_libraries</span>( filesys stdc++fs)
</pre>
</div>

<p>
File: filesys.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iterator</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Range</span>, <span class="org-keyword">typename</span> <span class="org-type">Function</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">dotimes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span>, <span class="org-type">Range</span>&amp;&amp; <span class="org-variable-name">iterable</span>, <span class="org-type">Function</span> <span class="org-variable-name">fun</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0;
    <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = <span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">end</span> = <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>i &lt; n &amp;&amp; it != end <span class="org-rainbow-delimiters-depth-2">){</span>
            fun<span class="org-rainbow-delimiters-depth-3">(</span>it<span class="org-rainbow-delimiters-depth-3">)</span>;
            ++it;
            i++;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
     dotimes<span class="org-rainbow-delimiters-depth-2">(</span>10, <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-3">)</span>,
             <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span>
                  <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p-&gt;path<span class="org-rainbow-delimiters-depth-4">()</span>;
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                            &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>0<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-4">()</span>.string<span class="org-rainbow-delimiters-depth-4">()</span>
                            &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>35<span class="org-rainbow-delimiters-depth-4">)</span>
                            &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>40<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path
                            &lt;&lt; <span class="org-constant">std</span>::endl;               
             <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Steps for reproducing the problem</b> 
</p>

<p>
STEP 1: Get current machine infomation. 
</p>

<ul class="org-ul">
<li>GLIBC Version is: 2.34-2.fc32</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Current machine </span>
$ cat /etc/fedora-release 
Fedora release 32 (Thirty Two)

<span class="org-comment-delimiter"># </span><span class="org-comment">Current GLIBC Version </span>
$ ld --version
GNU ld version 2.34-2.fc32
... ... ... ... 
</pre>
</div>

<p>
STEP 2: Build the application. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake --config Debug -H. -B_build1
$ cmake --build _build1 --target 

$ file _build1/filesys 
<span class="org-function-name">_build1/filesys</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, 
interpreter /lib64/ld-linux-x86-64.so.2, <span class="org-variable-name">BuildID</span>[sha1]=d1a3628f794c66bcfb29303cfa4a528910f4e3e2
, for GNU/Linux 3.2.0, not stripped
</pre>
</div>

<p>
STEP 3: Run in the current machine (newer version of GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build1/filesys 

 ===== Listing directory /etc =====
chrony.conf                       <span class="org-string">"/etc/chrony.conf"</span>
xl2tpd                            <span class="org-string">"/etc/xl2tpd"</span>
group                             <span class="org-string">"/etc/group"</span>
profile.d                         <span class="org-string">"/etc/profile.d"</span>
kde4rc                            <span class="org-string">"/etc/kde4rc"</span>
resolv.conf.8LUAL0                <span class="org-string">"/etc/resolv.conf.8LUAL0"</span>
geoclue                           <span class="org-string">"/etc/geoclue"</span>
bash_completion.d                 <span class="org-string">"/etc/bash_completion.d"</span>
cups                              <span class="org-string">"/etc/cups"</span>
mime.types                        <span class="org-string">"/etc/mime.types"</span>
</pre>
</div>

<p>
STEP 4: Attempt to run the binary in a distribution using an older
version of GLIBC. The distribution used was a QEMU-KVM virtual
machine running MX-Linux 19.2, distribution based on Debian, with
GLIBC version .
</p>

<p>
GLIBC Failure on MX-Linux Virtual Machine: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">---------- Failure!! GLIC Incompa ------------------------------------#</span>
 $ _build1/filesys 
 _build1/filesys: /lib/x86_64-linux-gnu/libstdc++.so.6: version 
  <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)
</pre>
</div>

<p>
Virtual Machine Information: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">----------- Machine Info (MX Linux 19.2) -------------#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kernel version </span>
$ uname -r
4.19.0-9-amd64

<span class="org-comment-delimiter"># </span><span class="org-comment">Distro name </span>
$ cat /etc/issue 
Welcome to MX 19.2 (patito feo) 64-bit! Powered by Debian.
... ... ... ... ............ .... ... ... .. 

$ ld --version
GNU ld (GNU Binutils for Debian) 2.31.1
... ... ... ... ... ... ... ... ... ... ... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaa0a25d" class="outline-4">
<h4 id="orgaa0a25d"><span class="section-number-4">1.5.3</span> Solution 1 - via linking against older GLIBC</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
As GLIBC is <span class="underline">forward compatible</span>, but not <span class="underline">backward compatible</span>. The
solution for this issue is to build the application on a <span class="underline">system</span> with
the oldest possible version of GLIBC. System in this context, means: a
Linux virtual machine; a Chroot environment; or Docker image with an
older version of GLIBC. Other alternative is to replace GLIBC with
<span class="underline">MUSL</span> CRT (C Runtime library), but the drawback is that MUSL does not
support dynamic loading (_dlopen_, <span class="underline">dlsym</span> APIs). 
</p>

<p>
The solution adopted for solving this issue was to use a Docker image
based on <a href="https://github.com/phusion/holy-build-box">holy-build-box</a>, which is a Docker image based on Centos 6
Linux distribution containing a modern version of GCC compiler, CMake
and an older version of GLIBC.
</p>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/phusion/holy-build-box">https://github.com/phusion/holy-build-box</a></li>
</ul>

<p>
<span class="underline">File: Dockerfile</span> (Available at <a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">gist url</a>)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ docker run -it --rm -v $PWD:/work -w /work phusion/holy-build-box-64:latest bash </span>
FROM phusion/holy-build-box-64:latest

ENTRYPOINT [ <span class="org-string">"/hbb_exe/activate-exec"</span>, <span class="org-string">"bash"</span>  ]
</pre>
</div>

<p>
Build docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run at the directory where is Dockerfile </span>
$ docker build -f Dockerfile -t linux-build . 
</pre>
</div>

<p>
Enter in the docker image shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd linux-build 
Holy build box activated
<span class="org-function-name">Prefix</span>: /hbb_exe
<span class="org-function-name">CFLAGS/CXXFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++
<span class="org-function-name">STATICLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++

[root@88c9630a2008 cwd]# ls
_build1  CMakeLists.txt   Dockerfile   filesys.cpp   Makefile
</pre>
</div>

<p>
Building the application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@88c9630a2008 cwd]# make 
cmake --config Debug -H. -B_build2
-- Configuring done
-- Generating done
-- Build files have been written to: /cwd/_build2
cmake --build _build2 --target 
<span class="org-function-name">gmake</span>[<span class="org-compilation-line-number">1</span>]: Entering directory <span class="org-string">'/cwd/_build2'</span>
/hbb/bin/cmake -S/cwd -B/cwd/_build2 --check-build-system CMakeFiles/Makefile.cmake 0
... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 

[root@88c9630a2008 cwd]# ls _build2
CMakeCache.txt  CMakeFiles  cmake_install.cmake  filesys  Makefile
</pre>
</div>

<p>
Running the application _build2/filesys in MX-Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Built on Fedora 32 with newer version of GLIBC [FAILURE]</span>
$ _build1/filesys
<span class="org-function-name">_build1/filesys</span>: /lib/x86_64-linux-gnu/libstdc++.so.6: 
version <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)


<span class="org-comment-delimiter"># </span><span class="org-comment">Built on Centos6 docker with older version of GLIBC [OK, WORKS]</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------</span>
$ _build2/filesys

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga8e92b7" class="outline-4">
<h4 id="orga8e92b7"><span class="section-number-4">1.5.4</span> Solution 2 - via linking against MUSL libC</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
Other alternative to avoid the GLIBC dependency problem is to build
the application statically linking against <a href="https://www.musl-libc.org/">MUSL - LibC</a> which is an CRT
(C runtime library), initially developed for embedded systems, but that has
become an alternative to GLIBC. The easiest way to build statically
linking against MUSL is to use an Alpine docker image: 
</p>

<ul class="org-ul">
<li>Note: CRT - is a central component of Unix-like operating
systems. It encapsulates system-calls and other operating system
services for user-space applications.</li>
</ul>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Musl">Musl - Wikipedia</a></li>
<li><a href="https://wiki.debian.org/musl">Musl - Debian</a></li>
<li><a href="https://www.arangodb.com/2018/04/static-binaries-c-plus-plus-application/">Static Binaries for a C++ Application - ArangoDB</a></li>
<li><a href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/musl-support-for-fully-static-binaries.html">MUSL support for fully static binaries - Rust Docs</a></li>
<li><a href="http://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a></li>
<li><a href="https://elinux.org/images/8/8b/Room_For_Cooperation-_Bionic_and_musl.pdf">Elinux/Linaro - Bionic and musl - room for cooperation?</a></li>
</ul>

<p>
File: MuslBuilder.docker (<a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">Available at gist</a>)
</p>

<div class="org-src-container">
<pre class="src src-docker">FROM alpine:latest
RUN apk add musl cmake make g++
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<p>
Buildilg the docker containing MUSL and development tools:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 &amp;&amp; <span class="org-builtin">cd</span> gist 
$ docker build -f MuslBuilder.docker -t musl-builder . 
</pre>
</div>

<p>
Running a container of this docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -it --rm -v $(<span class="org-sh-quoted-exec">pwd</span>):/cwd -w /cwd -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) musl-builder 
/cwd $ cmake --config Debug -H. -B_build-musl -DCMAKE_EXE_LINKER_FLAGS=<span class="org-string">"-static -Os"</span>
/cwd $ cmake --build _build-musl --target 
</pre>
</div>

<p>
Exiting from the container and check the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ du -h _build-musl/filesys 
8.7M    _build-musl/filesys
8.7M    total

$ file _build-musl/filesys 
<span class="org-function-name">_build-musl/filesys</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
, statically linked, with debug_info, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check dependencies </span>
$ ldd _build-musl/filesys 
        statically linked
</pre>
</div>

<p>
Attempt to run from MX-Linux 19.2 (Older GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-musl/filesys 

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org31415b3" class="outline-4">
<h4 id="org31415b3"><span class="section-number-4">1.5.5</span> Portable binary using Golang</h4>
<div class="outline-text-4" id="text-1-5-5">
<p>
Applications built with GO programming language are not affect by
GLIBC compatibility problems since the GO compiler implementation
performs system calls without relying on the GLIBC. This feature
allows deploying GO binaries in any Linux distribution without
worrying about GLIBC binary compatibility. 
</p>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/55735864/how-does-go-make-system-calls">How does Go make system calls? - Stack Overflow</a></li>

<li><a href="https://news.ycombinator.com/item?id=21736342">The Go runtime scheduler's way of dealing with system calls | Hacker News</a></li>

<li id="[[<a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls">https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls</a>][Chris's Wiki">blog/programming/GoSchedulerAndSyscalls]]</li>

<li><a href="https://stackoverflow.com/questions/41720090/does-golang-depend-on-c-runtime">go - Does golang depend on c runtime? - Stack Overflow</a></li>

<li><a href="https://lwn.net/Articles/806776/">OpenBSD system-call-origin verification - LWN.net</a></li>

<li><a href="https://github.com/golang/go/issues/36435">all: stop using direct syscalls on OpenBSD · Issue #36435 · golang/go · GitHub</a></li>

<li><a href="https://golang.org/src/syscall/">src/syscall/ - The Go Programming Language</a> (GOLang Source Code - Syscalls)</li>

<li><a href="http://garrett.damore.org/2015/09/on-go-portability-and-system-interfaces.html">/dev/dump: On Go, Portability, and System Interfaces</a></li>

<li><a href="http://lsub.org/export/gort.html">Notes on the Go 1.4 Run-Time</a> - Francisco J. Ballesteros - TR LSUB-15-2 (rev 1)
<ul class="org-ul">
<li>"This TR contains notes about the Go run time as of Go
1.4. They are intended to aid in the construction of a kernel
for Clive. The description here will be updated in the future
without publising a new TR, the TR revision number can be used
to see if the version is up to date or not."</li>
</ul></li>
</ul>

<p>
<b>Demonstration</b> 
</p>

<p>
File: <span class="underline">goapp.go</span> 
</p>

<div class="org-src-container">
<pre class="src src-c++">package <span class="org-type">main</span> 

<span class="org-variable-name">import</span> <span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-string">"fmt"</span>
    <span class="org-string">"io/ioutil"</span>
    <span class="org-string">"net/http"</span>
    _ <span class="org-string">"bufio"</span>
    _ <span class="org-string">"log"</span>
<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-type">func</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>

    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" =&gt; Started Ok"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------- List root directory ---------//</span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ---- List Root Directory ------"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">No error handler for the sake of breviety. </span>
    files, _ := ioutil.ReadDir<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-keyword">for</span> _, fn := range files <span class="org-rainbow-delimiters-depth-2">{</span> 
        fmt.Println<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" =&gt; "</span> + fn.Name<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>         
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-comment-delimiter">// </span><span class="org-comment">---- Http Request ------------------// </span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ------- Http Request -------------"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    resp, _ := http.Get<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"https://www.httpbin.org/get"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    body, _ := ioutil.ReadAll<span class="org-rainbow-delimiters-depth-2">(</span>resp.Body<span class="org-rainbow-delimiters-depth-2">)</span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">body</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Compile sample GO application: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> <span class="org-comment-delimiter"># </span><span class="org-comment">Compiled  </span>
 $ go build goapp.go    

 <span class="org-comment-delimiter"># </span><span class="org-comment">Remove debug symbols </span>
 $ strip goapp 

 <span class="org-comment-delimiter"># </span><span class="org-comment">Get file size in megabytes    </span>
 $ &gt;&gt; du -h goapp
 4.9M    goapp

 <span class="org-comment-delimiter"># </span><span class="org-comment">Check binary </span>
 $ &gt;&gt; file goapp
 goapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter 
 /lib64/ld-linux-x86-64.so.2, 
 Go <span class="org-variable-name">BuildID</span>=rXh5UDymAYyqH6QHp4N5/KktyZonaNBes2MLq_8eV/4lmCJtW64uAqpYg_AIb_/5S4-otZPFzRnjGyq3bBL
, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check shared libraries dependencies </span>
 $ &gt;&gt; ldd goapp
        linux-vdso.so.1 (0x00007ffee9b99000)
        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fc87c0c6000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc87befc000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc87c10d000)
</pre>
</div>

<p>
Run application in Fedora 32 distribution (Newer version of GLIBC): 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./goapp 
 =&gt; Started Ok
 ---- List Root Directory ------
 =&gt; .autorelabel
 =&gt; bin
 =&gt; boot
 =&gt; dev
 =&gt; etc
 ... ... ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... ... ... 
 =&gt; usr
 =&gt; var
 ------- Http Request -------------
{
  <span class="org-string">"args"</span>: {}, 
  <span class="org-string">"headers"</span>: {
    <span class="org-string">"Accept-Encoding"</span>: <span class="org-string">"gzip"</span>, 
    <span class="org-string">"Host"</span>: <span class="org-string">"www.httpbin.org"</span>, 
    <span class="org-string">"User-Agent"</span>: <span class="org-string">"Go-http-client/2.0"</span>, 
    <span class="org-string">"X-Amzn-Trace-Id"</span>: <span class="org-string">"Root=2-5f5650e9-4830a22ac821b598c22defbc"</span>
  }, 
  <span class="org-string">"url"</span>: <span class="org-string">"https://www.httpbin.org/get"</span>
}
</pre>
</div>

<p>
Run application in MX-Linux distribution, based on Debian (Older version of GLIBC):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./goapp
 =&gt; Started Ok
 ---- List Root Directory ------
 =&gt; .cache
 =&gt; .config
 =&gt; .fehbg
 =&gt; bin
 =&gt; boot
 ... ... ... ... .... ... ... ... ... .... ... 
 ... ... ... ... .... ... ... ... ... .... ... 
 =&gt; var
 =&gt; vmlinuz
 ------- Http Request -------------
{
  <span class="org-string">"args"</span>: {}, 
  <span class="org-string">"headers"</span>: {
    <span class="org-string">"Accept-Encoding"</span>: <span class="org-string">"gzip"</span>, 
    <span class="org-string">"Host"</span>: <span class="org-string">"www.httpbin.org"</span>, 
    <span class="org-string">"User-Agent"</span>: <span class="org-string">"Go-http-client/2.0"</span>, 
    <span class="org-string">"X-Amzn-Trace-Id"</span>: <span class="org-string">"Root=1-5f56523a-6cfd5015acb4421e26947afe"</span>
  }, 
  <span class="org-string">"url"</span>: <span class="org-string">"https://www.httpbin.org/get"</span>
}

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgeea53f9" class="outline-3">
<h3 id="orgeea53f9"><span class="section-number-3">1.6</span> Fully Statically linked executables for embedded Linux systems</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org4859d7f" class="outline-4">
<h4 id="org4859d7f"><span class="section-number-4">1.6.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
This sections presents a procedure for cross-compiling a fully
statically linked executable, without any dependency, that can be
deployed on any ARMV7-based Embedded Linux system, including
Beaglebone Black development board and Android (Armv7 based
processor).
</p>

<p>
This procedure uses  <a href="https://hub.docker.com/layers/muslcc/i686/arm-linux-musleabi/images/sha256-818ac763b91e0112f7a38e34949c69a91d24852dc794372e905c70bb48370d0b?context=explore">muslcc/i686:arm-linux-musleabi</a> docker image
which contains a cross-compiling toolchain capable of compiling
C or C++ applications for Linux kernel running on Armv7 based
processors. This toolchain also uses Musl libC, instead of glibC (GNU
C runtime library). Musl allows building fully statically applications
that does not rely on any system dependency. As a result,
applications, built with  Musl, can be run on any Linux
distribution without being affected by GNU GlibC mismatch problems which
arises when an application or object-code, that was built linked
against an newer version of GlibC, is run on a system using an older
version of GlibC resulting in a runtime linking error.
</p>

<p>
References and reading: 
</p>

<ul class="org-ul">
<li><a href="https://hub.docker.com/r/muslcc/i686/tags">https://hub.docker.com/r/muslcc/i686/tags</a></li>

<li>More toolchains at: <a href="https://elinux.org/Toolchains">https://elinux.org/Toolchains</a></li>

<li><a href="https://cmake.org/pipermail/cmake/2011-October/046743.html">CMake - Fwd: Save stripped debugging information</a></li>

<li><a href="https://stackoverflow.com/questions/6687630/how-to-remove-unused-c-c-symbols-with-gcc-and-ld">How to remove unused C/C++ symbols with GCC and ld? - Stack Overflow</a></li>

<li><a href="https://ownyourbits.com/2018/06/13/transparently-running-binaries-from-any-architecture-in-linux-with-qemu-and-binfmt_misc/">Transparently running binaries from any architecture in Linux with QEMU and binfmt_misc – Own your bits</a></li>
</ul>
</div>
</div>

<div id="outline-container-org495b4a8" class="outline-4">
<h4 id="org495b4a8"><span class="section-number-4">1.6.2</span> Project Files</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
All files are available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3">https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3</a></li>
</ul>


<p>
File: <span class="underline">Dockerfil.docker</span>
</p>

<div class="org-src-container">
<pre class="src src-sh">FROM muslcc/i686:armv7l-linux-musleabihf
RUN  apk add make cmake 

<span class="org-comment-delimiter"># </span><span class="org-comment">ENTRYPOINT ["cmake"]</span>
</pre>
</div>

<p>
File: <span class="underline">Makefile</span> 
</p>

<ul class="org-ul">
<li>Makefile for running project commands and documenting the building
process.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-variable-name">DOCKER_COMMAND</span>=docker run -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">shell</span> id -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">shell</span> id -g) --volume=$(<span class="org-sh-quoted-exec">shell</span> pwd):/cwd  --workdir=/cwd musl-armv7

<span class="org-comment-delimiter"># </span><span class="org-comment">Builds docker image: musl-armv7</span>
<span class="org-function-name">docker</span>:
        docker build -f Dockerfile.docker -t musl-armv7 .

<span class="org-comment-delimiter"># </span><span class="org-comment">Build testing application </span>
<span class="org-function-name">build</span>:
        ${<span class="org-variable-name">DOCKER_COMMAND</span>} cmake -H. -B_build-armv7 -DCMAKE_BUILD_TYPE=Debug
        ${<span class="org-variable-name">DOCKER_COMMAND</span>} cmake --build _build-armv7 --target 

<span class="org-function-name">clean</span>:
        rm -rf -v _build-armv7
</pre>
</div>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(embedded-linux-armv7)

<span class="org-builtin">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-builtin">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment-delimiter">#</span><span class="org-comment">====== Global compiler and linker settings ======#</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">(-static)           =&gt; Fully statically link Musl-LibC</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">(-Wl,--gc-sections) =&gt; Remove unused code</span>
<span class="org-comment-delimiter">#                        </span><span class="org-comment">(requires: -fdata-sections and -ffunction-sections)</span>
<span class="org-builtin">set</span>(CMAKE_EXE_LINKER_FLAGS <span class="org-string">"-static -Wl,--gc-sections"</span>)

<span class="org-comment-delimiter"># </span><span class="org-comment">Separate data and code sections in order to reduce binary size. </span>
<span class="org-function-name">add_definitions</span>( -fdata-sections -ffunction-sections )

<span class="org-comment-delimiter"># </span><span class="org-comment">Copy target executable, for instance my-exe to my-exe.debug </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">and strip debugging symbols from my-exe.</span>
<span class="org-comment-delimiter"># </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Reference: https://cmake.org/pipermail/cmake/2011-October/046743.html</span>
<span class="org-function-name">macro</span>(STRIP_DEBUG_SYMBOLS target)
  ADD_CUSTOM_COMMAND(TARGET ${<span class="org-variable-name">target</span>} POST_BUILD
    COMMAND ${<span class="org-variable-name">CMAKE_COMMAND</span>} -E copy $&lt;TARGET_FILE:${<span class="org-variable-name">target</span>}&gt; ${<span class="org-variable-name">CMAKE_BINARY_DIR</span>}/${<span class="org-variable-name">target</span>}.debug
    COMMAND ${<span class="org-variable-name">CMAKE_STRIP</span>} -g $&lt;TARGET_FILE:${<span class="org-variable-name">target</span>}&gt;
  )
<span class="org-function-name">endmacro</span>()

<span class="org-comment-delimiter">#</span><span class="org-comment">========== Targets Configurations ============#</span>

        add_executable( app portable-app.cpp )
 target_link_libraries( app stdc++fs)
   STRIP_DEBUG_SYMBOLS( app )

</pre>
</div>

<p>
File: <span class="underline">portable-app.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  assert<span class="org-rainbow-delimiters-depth-2">(</span> argc &gt;= 2 &amp;&amp; <span class="org-string">"Supposed to have at least one arguments"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">command</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span> 
      <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/version"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      assert<span class="org-rainbow-delimiters-depth-3">(</span> ifs.good<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-string">"File supposed to exist"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;  
      <span class="org-constant">std</span>::cout &lt;&lt; ifs.rdbuf<span class="org-rainbow-delimiters-depth-3">()</span>;
      <span class="org-keyword">return</span> EXIT_SUCCESS;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"list"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">iter</span> = <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-constant">std</span>::for_each<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-4">(</span>iter<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-4">(</span>iter<span class="org-rainbow-delimiters-depth-4">)</span>
                 ,<span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-4">){</span>
                   <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p.path<span class="org-rainbow-delimiters-depth-5">()</span>;
                   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                             &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>0<span class="org-rainbow-delimiters-depth-5">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-5">()</span>.string<span class="org-rainbow-delimiters-depth-5">()</span>
                             &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>35<span class="org-rainbow-delimiters-depth-5">)</span>
                             &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>40<span class="org-rainbow-delimiters-depth-5">)</span> &lt;&lt; path
                             &lt;&lt; <span class="org-constant">std</span>::endl;              
                 <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;    
    <span class="org-keyword">return</span> EXIT_FAILURE;    
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b95b67" class="outline-4">
<h4 id="org3b95b67"><span class="section-number-4">1.6.3</span> Building and running</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
<b>STEP 1:</b> Downloading the source code. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3 musl-armv7 &amp;&amp; <span class="org-builtin">cd</span> musl-armv7
</pre>
</div>

<p>
<b>STEP 2:</b> Building the docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker build -f Dockerfile.docker -t musl-armv7 .

Sending build context to Docker daemon  7.168kB
Step 1/2 : FROM muslcc/i686:armv7l-linux-musleabihf
 ---&gt; 4141d3dcca3f
Step 2/2 : RUN  apk add make cmake
 ---&gt; Using cache
 ---&gt; c18ba0aa2335
Successfully built c18ba0aa2335
Successfully tagged musl-armv7:latest
</pre>
</div>

<p>
<b>STEP 3:</b> Cross-compile the sample application: 
</p>

<p>
Cross-compiling from command line: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run the docker shell (sh)</span>
$ docker run --interactive --tty -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) --volume=$(<span class="org-sh-quoted-exec">pwd</span>):/cwd  --workdir=/cwd musl-armv7
/cwd <span class="org-comment-delimiter"># </span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Build the application </span>
/cwd $ cmake -H. -B_build-armv7 -DCMAKE_BUILD_TYPE=Debug
/cwd $ cmake --build _build-armv7 --target

<span class="org-comment-delimiter"># </span><span class="org-comment">Exit the docker shell </span>
/cwd $ cmake --build _build-armv7 --target
</pre>
</div>

<p>
Cross-compile in a single step using the helper Makefile: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ make build 
</pre>
</div>

<p>
Check the compiled executables: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls _build-armv7/
CMakeFiles/  app*  app.debug*  CMakeCache.txt  cmake_install.cmake  Makefile

<span class="org-comment-delimiter"># </span><span class="org-comment">Version with debug symbols </span>
$ file _build-armv7/app
<span class="org-function-name">_build-armv7/app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped

$ du -h _build-armv7/app
736K    _build-armv7/app
736K    total

<span class="org-comment-delimiter"># </span><span class="org-comment">Version without debugging symbols </span>
$ file _build-armv7/app.debug 
<span class="org-function-name">_build-armv7/app.debug</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV)
, statically linked, with debug_info, not stripped

$ du -h _build-armv7/app.debug 
9.4M    _build-armv7/app.debug
9.4M    total
</pre>
</div>

<p>
<b>STEP 4:</b> Attempt to run the built executable on different machines.
</p>

<p>
Attempt to run the previous executables on the host machine (x86-64
processor - 64 bits):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-armv7/app
<span class="org-function-name">bash</span>: _build-armv7/app: cannot execute binary file: Exec format error

$ _build-armv7/app.debug 
<span class="org-function-name">bash</span>: _build-armv7/app.debug: cannot execute binary file: Exec format error
</pre>
</div>

<p>
Run ARMv7 Linux binary on a x86-64 host machine using <a href="https://www.qemu.org/">QEMU</a> emulator: <a href="https://ownyourbits.com/2018/06/13/transparently-running-binaries-from-any-architecture-in-linux-with-qemu-and-binfmt_misc/">(OwnYourBits)</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Install Fedora Packages </span>
$ sudo dnf install -y qemu-user.x86_64 qemu-user-static.x86_64

<span class="org-comment-delimiter"># </span><span class="org-comment">Run the Armv7 binary using QEMU-user </span>
$ qemu-arm ./_build-armv7/app version 
Linux version 5.8.4-200.fc32.x86_64 (mockbuild@bkernel01.iad2.fedoraproject.org) ... ... 

$ qemu-arm ./_build-armv7/app list /

 ===== Listing directory /etc =====
srv                                   <span class="org-string">"/srv"</span>
sys                                   <span class="org-string">"/sys"</span>
opt                                   <span class="org-string">"/opt"</span>
run                                   <span class="org-string">"/run"</span>
media                                 <span class="org-string">"/media"</span>
bin                                   <span class="org-string">"/bin"</span>
.autorelabel                          <span class="org-string">"/.autorelabel"</span>
root                                  <span class="org-string">"/root"</span>
var                                   <span class="org-string">"/var"</span>
etc                                   <span class="org-string">"/etc"</span>
tmp                                   <span class="org-string">"/tmp"</span>
</pre>
</div>

<p>
Run application in <span class="underline">Beaglebone Black</span> (Armv7) embedded linux development
board, similar to Raspberry-Pi, but with more IO ports, peripherals
and ADC analog-to-digital converters: 
</p>

<div class="org-src-container">
<pre class="src src-sh">debian@beaglebone:~$ file app
<span class="org-function-name">app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped

debian@beaglebone:~$ du -h app
736K    app

debian@beaglebone:~$ file app
<span class="org-function-name">app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app 
Assertion failed: argc &gt;= 2 &amp;&amp; <span class="org-string">"Supposed to have at least one arguments"</span> (/cwd/portable-app.cpp: main: 14)
Aborted
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app version 
Linux version 4.14.71-ti-r80 (root@b2-am57xx-beagle-x15-2gb) (gcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1)) <span class="org-comment-delimiter">#</span><span class="org-comment">1 SMP PREEMPT Fri Oct 5 23:50:11 UTC 2018</span>
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app list /

 ===== Listing directory /etc =====
sys                                   <span class="org-string">"/sys"</span>
opt                                   <span class="org-string">"/opt"</span>
sbin                                  <span class="org-string">"/sbin"</span>
home                                  <span class="org-string">"/home"</span>
dev                                   <span class="org-string">"/dev"</span>
nfs-uEnv.txt                          <span class="org-string">"/nfs-uEnv.txt"</span>
usr                                   <span class="org-string">"/usr"</span>
bin                                   <span class="org-string">"/bin"</span>
etc                                   <span class="org-string">"/etc"</span>
proc                                  <span class="org-string">"/proc"</span>
boot                                  <span class="org-string">"/boot"</span>
 ... ... ...  ... ... ...  ... ... ... 
 ... ... ...  ... ... ...  ... ... ... 

</pre>
</div>

<p>
Run in Android Armv-7 phone via <a href="https://developer.android.com/studio/command-line/adb">ADB</a> (Android Debug Bridge): 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Transver application to phone via ADB </span>
 $ adb push _build-armv7/app.debug /data/local/tmp 
<span class="org-function-name">_build-armv7/app.debug</span>: 1 file pushed. 11.1 MB/s (9793936 bytes<span class="org-keyword"> in</span> 0.842s)

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter ADB shell and run the application. </span>
 $ &gt;&gt; adb shell 
<span class="org-function-name">bali</span>:/ $ cd /data/local/tmp

<span class="org-function-name">bali</span>:/data/local/tmp $ file app.debug                                                                                                       
<span class="org-function-name">app.debug</span>: ELF executable, 32-bit LSB arm, static, not stripped

<span class="org-function-name">bali</span>:/data/local/tmp $ du -h app.debug
9.3M    app.debug

134|bali:/data/local/tmp $ ./app.debug version                                                                                              
Linux version 4.4.146+ (jenkins@jenkins-bali-wxg)  ... ... 
<span class="org-function-name">bali</span>:/data/local/tmp $ 


1|bali:/data/local/tmp $ ./app.debug list /dev                                                                                              

 ===== Listing directory /etc =====
wmtWifi                           <span class="org-string">"/dev/wmtWifi"</span>
stpgps                            <span class="org-string">"/dev/stpgps"</span>
fm                                <span class="org-string">"/dev/fm"</span>
stpbt                             <span class="org-string">"/dev/stpbt"</span>
stpwmt                            <span class="org-string">"/dev/stpwmt"</span>
wmtdetect                         <span class="org-string">"/dev/wmtdetect"</span>
radio                             <span class="org-string">"/dev/radio"</span>
ttyGS3                            <span class="org-string">"/dev/ttyGS3"</span>
ttyGS2                            <span class="org-string">"/dev/ttyGS2"</span>
ttyGS1                            <span class="org-string">"/dev/ttyGS1"</span>
ttyGS0                            <span class="org-string">"/dev/ttyGS0"</span>
mtp_usb                           <span class="org-string">"/dev/mtp_usb"</span>
usb_accessory                     <span class="org-string">"/dev/usb_accessory"</span>
 ... ... ...  ... ... ...  ... ... ...  ... ... ... 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9450e62" class="outline-3">
<h3 id="org9450e62"><span class="section-number-3">1.7</span> Creating command line applications with CLI11 C++ Library</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-orgc65b120" class="outline-4">
<h4 id="orgc65b120"><span class="section-number-4">1.7.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
Despite that GUI Graphical user interfaces applications are more used
nowadays than CLI command line applications, it still worth developing
CLI applications. Among other things, the benefits of CLI applications
over GUI can be summarized as: 
</p>

<ul class="org-ul">
<li>More precision
<ul class="org-ul">
<li>They are more precise than GUI for performing task. It is easier
to guide someone by showing the command line steps rather than
describing all buttons, menus, context menus that someone should
click in order to accomplish some task.</li>
</ul></li>

<li>Scriptability
<ul class="org-ul">
<li>CLI applications are scriptable and they can be automated;
called from other applications or scripts.</li>
</ul></li>

<li>Reproducibility 
<ul class="org-ul">
<li>Unlike GUIs, CLI applications are reproducible and the sequence
of steps for performing some task can be stored as text and
later replayed by pasting the commands in a terminal or running
them from a script.</li>
</ul></li>

<li>They can be combined
<ul class="org-ul">
<li>Unlike GUI, CLI applications can be combined with each other via
stdout, stderr redirection. Example: CLI tools such as 'grep',
'echo', 'ls', 'find', 'awk', 'sed' are often combined with each
other in shell scripts for system configuration or automation.</li>
</ul></li>
</ul>


<p>
<b>Anotomy of CLI Applications</b> 
</p>

<p>
Simple command line application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; --flag0 --flag1 --switch0 value0 --switch1 value1 --switch value2 ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Or: </span>
$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0 value0 --switch1 value1 --switch value2 ... 

$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0=value0 --switch1=value1 --switch=value2 ... 
</pre>
</div>

<p>
Command line application with multiple subcommands: (i.e: git, docker)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./&lt;COMMAND&gt; &lt;SUBCOMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0 value0 --switch1 value1 --switch value2 ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">OR: </span>
$ ./&lt;COMMAND&gt; &lt;SUBCOMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0=value0 --switch1=value1 --switch=value2 ... 
</pre>
</div>

<p>
Where: 
</p>

<ul class="org-ul">
<li>&lt;COMMAND&gt;
<ul class="org-ul">
<li>Appplication or executable.</li>
</ul></li>

<li>&lt;SUBCOMMAND&gt;
<ul class="org-ul">
<li>Metaphor: an action or verb performed on subjects (positional
arguments).</li>
<li>Subcommand, similar to 'git checkout' or'docker run'. A
subcommand or command represents an</li>
</ul></li>

<li>&lt;P0&gt;, &lt;P1&gt;, &#x2026;, &lt;PN&gt;
<ul class="org-ul">
<li>Metaphor: subjects</li>
<li>Positional arguments (without '-' dash prefix) - they are
essential (required) arguments for running an application. If
they are not provided, an error happens.</li>
</ul></li>

<li>-flag0 -flag1 &#x2026;.
<ul class="org-ul">
<li>Metaphor: adjectives</li>
<li>A flag is an optional command line switch which represents a
boolean value. The usage of a flag sets the represented value
as true and absence, sets the represented value as false.</li>
</ul></li>

<li>&#x2013;switch0=value0 &#x2013;switch1=value1 &#x2026;.
<ul class="org-ul">
<li>Metaphor: adjectives</li>
<li>Switches are optional command line arguments associated to some
program state.</li>
</ul></li>
</ul>

<p>
<b>Example</b> - Breaking down command line parts:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -i -t --rm --volume=$<span class="org-variable-name">PWD</span>:/cwd -w=/cwd xdxd/docker-binwalk bash     
</pre>
</div>

<ul class="org-ul">
<li>Command:
<ul class="org-ul">
<li>docker</li>
</ul></li>

<li>Sub-command:
<ul class="org-ul">
<li>run</li>
</ul></li>

<li>Positional arguments:
<ul class="org-ul">
<li>(xdxd/docker-binwalk) and (bash)</li>
</ul></li>

<li>Flags:
<ul class="org-ul">
<li>(-i), (-t), (&#x2013;rm)</li>
</ul></li>

<li>Switches:
<ul class="org-ul">
<li>(&#x2013;volume), (-w)</li>
</ul></li>
</ul>


<p>
<b>General recommendations</b> 
</p>

<ul class="org-ul">
<li><span class="underline">DO ONLY ONE THING</span> =&gt; The application should only do one thing. If
it needs to perform more than one task, the best choice is to
create a subcommand for every task.</li>

<li><span class="underline">STATUS CODE</span> =&gt; The status code allows scripts or any other
application calling the current one to know whether the process
execution was successful. 
<ul class="org-ul">
<li>=&gt; Return status code '0' (EXIT_SUCCESS) when the
applications is terminated successfully</li>
<li>=&gt; Return any other value different than zero in case of failure.</li>
</ul></li>

<li><span class="underline">DEFAULT VALUES</span>
<ul class="org-ul">
<li>Use reasonable default values for command line switches values
and flags.</li>
<li>Show the default values of command line switches</li>
</ul></li>

<li><span class="underline">EXAMPLES</span>
<ul class="org-ul">
<li>Add commands that shows usage examples.</li>
</ul></li>

<li><span class="underline">SIMPLE TASKS SHOULD BE SIMPLE</span>
<ul class="org-ul">
<li>Create subcommands for the most common use-cases for making
simple tasks simple: make simple things simple and complex
things possible (borrowed from Alan Kay).</li>
</ul></li>

<li><span class="underline">STDERR</span> - for non essential information
<ul class="org-ul">
<li>Print non essential, logging or debug information to <span class="underline">stderr</span>,
standard error output as it allows discarding separating the
stdout (standard output) from stderr, redirecting stderr to
file or discarding it by redirecting stderr to /dev/null.</li>
</ul></li>

<li><span class="underline">VERSION</span> (&#x2013;version)
<ul class="org-ul">
<li>Add switch for printing application version.</li>
</ul></li>

<li><span class="underline">DRY-RUN</span> (&#x2013;dry-run)
<ul class="org-ul">
<li>Create a flag option (&#x2013;dry-run) if the command performs any
permanent non-reversible change, such as remove file. When the
application receives the &#x2013;dry-run option, the application only shows the
non-reversible actions that would be executed, without actually
performing them.</li>
</ul></li>
</ul>

<p>
Subcommand for common tasks (Simple tasks should be simple): 
</p>

<p>
For instance, an alternative docker client could have a subcommand
'shell' for just running the shell as entrypoint. <span class="underline">$ dockw shell IMAGE</span> could
be translated as the following docker command line. The subcommand
'shell' could assume that the current directory ($PWD) is mounted to
the directory /cwd in the docker image and this option could be
changed using the command line switch <code>--workdir=&lt;SOME_DIR&gt;</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">'dockw shell MY_DOCKER_IMAGE ' subcommand from a hypothetical dockw tool </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">is translated as: </span>
$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd --entrypoint=sh MY_DOCKER_IMAGE 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd52d06f" class="outline-4">
<h4 id="orgd52d06f"><span class="section-number-4">1.7.2</span> Sample application with multiple sub-comamnds</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
The following code contains a sample CLI application containing
multiple sub-commands:. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e">https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e</a></li>
</ul>

<p>
CLI11 Library Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://cliutils.gitlab.io/CLI11Tutorial/">Introduction · CLI11 Tutorial</a></li>

<li><a href="https://cliutils.gitlab.io/CLI11Tutorial/chapters/subcommands.html">Subcommands and the App · CLI11 Tutorial</a></li>

<li><a href="https://indico.cern.ch/event/619465/contributions/2507949/attachments/1448567/2232649/20170424-diana-2.pdf">CLI11: Command line parsing made simple</a></li>
</ul>

<p>
<b>Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(cliapp)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)
<span class="org-function-name">set</span>(CMAKE_CXX_EXTENSIONS OFF)

<span class="org-comment"># ------------ Download CPM CMake Script ----------------#</span>

<span class="org-comment">## Automatically donwload and use module CPM.cmake</span>
<span class="org-function-name">file</span>(DOWNLOAD https://raw.githubusercontent.com/TheLartians/CPM.cmake/v0.26.2/cmake/CPM.cmake
                 <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)
<span class="org-function-name">include</span>(<span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)

<span class="org-comment">#----------- Add dependencies --------------------------#</span>

<span class="org-function-name">CPMAddPackage</span>(
    NAME cli11
    URL  https://github.com/CLIUtils/CLI11/archive/v1.9.0.zip
    DOWNLOAD_ONLY YES
)

<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">cli11_SOURCE_DIR</span>}/include )

<span class="org-function-name">message</span>([TRACE] <span class="org-string">" cli11_SOURCE_DIR =  ${</span><span class="org-variable-name">cli11_SOURCE_DIR</span><span class="org-string">} "</span>)

<span class="org-comment">#----------- Set targets -------------------------------#</span>

<span class="org-function-name">add_executable</span>(cliapp cliapp.cpp)
<span class="org-function-name">target_link_libraries</span>(cliapp stdc++fs)

<span class="org-function-name">install</span>( TARGETS cliapp 
         RUNTIME DESTINATION bin)

</pre>
</div>

<p>
File: cliapp.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">CLI/CLI.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">std</span>::<span class="org-constant">string_literals</span>;
<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">struct</span> <span class="org-type">Command_list</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_path</span> = <span class="org-string">"."</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">m_filter_file</span> = <span class="org-constant">false</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">m_filter_dir</span>  = <span class="org-constant">false</span>; 
    <span class="org-type">bool</span> <span class="org-variable-name">m_recursive</span>   = <span class="org-constant">false</span>; 

    <span class="org-function-name">Command_list</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp; <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;install<span class="org-rainbow-delimiters-depth-3">(</span>app, name<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">install</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp; <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">CLI</span>::<span class="org-type">App</span>* <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-3">(</span>
            name, <span class="org-string">"List directory"</span>
        <span class="org-rainbow-delimiters-depth-3">)</span>;

        cmd-&gt;callback<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">[</span><span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-4">](){</span>
            <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-5">{</span>
                <span class="org-keyword">this</span>-&gt;list_directory<span class="org-rainbow-delimiters-depth-6">()</span>;
                <span class="org-comment-delimiter">// </span><span class="org-comment">Status code  0 =&gt; OK finished successfuly </span>
                <span class="org-keyword">return</span> <span class="org-constant">true</span>; 
            <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::<span class="org-type">exception</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">{</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Error: "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-6">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
                <span class="org-keyword">return</span> <span class="org-constant">false</span>; 
            <span class="org-rainbow-delimiters-depth-5">}</span>
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        cmd-&gt;add_option<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"&lt;PATH&gt;"</span>,        m_path,        <span class="org-string">"Directory to be listed."</span> <span class="org-rainbow-delimiters-depth-3">)</span>-&gt;required<span class="org-rainbow-delimiters-depth-3">()</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-f,--file"</span>,       m_filter_file, <span class="org-string">"Only list files"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-d,--directory"</span>,  m_filter_dir,  <span class="org-string">"Only list directories"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-r,--recursive"</span>,  m_recursive,   <span class="org-string">"List direcotyr in recursive way"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">private</span>:

    <span class="org-type">void</span> <span class="org-function-name">list_directory</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_file &amp;&amp; m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: --file and --dir flags cannot be simultaneously true."</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">using</span> <span class="org-type">Predfun</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">predicate</span> = Predfun<span class="org-rainbow-delimiters-depth-3">{}</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">iterate_dir</span> = <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">predicate</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span>&amp;&amp; <span class="org-variable-name">iterable</span><span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span> :  iterable <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>predicate<span class="org-rainbow-delimiters-depth-6">(</span>path<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"  =&gt; %s\n"</span>, path.path<span class="org-rainbow-delimiters-depth-6">()</span>.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>; 
            <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">using</span> <span class="org-type">ptr</span> = <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>m_filter_file &amp;&amp; <span class="org-negation-char">!</span>m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span> 
            predicate = <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_file<span class="org-rainbow-delimiters-depth-3">)</span> 
            predicate = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">ptr</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;<span class="org-constant">fs</span>::is_regular_file;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span>
            predicate = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">ptr</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;<span class="org-constant">fs</span>::is_directory;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>m_recursive<span class="org-rainbow-delimiters-depth-3">)</span>
            iterate_dir<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">fs</span>::<span class="org-type">directory_iterator</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-variable-name">m_path</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">else</span> 
            iterate_dir<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">fs</span>::<span class="org-type">recursive_directory_iterator</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-variable-name">m_path</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">MiniWebServer</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>         <span class="org-variable-name">m_port</span> = 8080; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_host</span> = <span class="org-string">"0.0.0.0"</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_path</span> = <span class="org-string">"."</span>; 
    <span class="org-type">bool</span>        <span class="org-variable-name">m_auth</span> = <span class="org-constant">false</span>; 
<span class="org-function-name">public</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set server TCP Port </span>
    <span class="org-type">void</span> <span class="org-function-name">set_port</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">port</span>         <span class="org-rainbow-delimiters-depth-2">){</span> m_port = port; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Hostnames that server will listen to </span>
    <span class="org-type">void</span> <span class="org-function-name">set_host</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">host</span> <span class="org-rainbow-delimiters-depth-2">){</span> m_host = host; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set path containing server data </span>
    <span class="org-type">void</span> <span class="org-function-name">set_path</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span> <span class="org-rainbow-delimiters-depth-2">){</span> m_path = path; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">set_auth</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">bool</span> <span class="org-variable-name">flag</span>        <span class="org-rainbow-delimiters-depth-2">){</span> m_auth = flag; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span>  <span class="org-function-name">get_port</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">return</span> m_port; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">run_server</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Running web server =&gt; port = %d ; host = %s; path = %s \n"</span>
            , m_port, m_host.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, m_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Server has authentication =&gt; %s \n"</span>, m_auth ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span>, <span class="org-keyword">typename</span> <span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">bind_setter</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Klass</span>&amp; <span class="org-variable-name">cls</span>, <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">Klass</span>::* <span class="org-function-name">setter</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span>&amp;&amp;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">](</span><span class="org-type">T</span>&amp;&amp; <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-2">){</span> 
        <span class="org-rainbow-delimiters-depth-3">(</span>cls.*setter<span class="org-rainbow-delimiters-depth-3">)(</span> <span class="org-constant">std</span>::forward<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span>, <span class="org-keyword">typename</span> <span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">bind_setter</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">cls</span>, <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">Klass</span>::* <span class="org-function-name">setter</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">[</span>cls, setter<span class="org-rainbow-delimiters-depth-2">](</span><span class="org-type">T</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>*cls<span class="org-rainbow-delimiters-depth-4">)</span>.*setter<span class="org-rainbow-delimiters-depth-3">)(</span>q<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">command_server</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp;  <span class="org-variable-name">app</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    

    <span class="org-constant">CLI</span>::<span class="org-type">App</span>* <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-2">(</span>
        <span class="org-string">"server"</span>, <span class="org-string">"Run HTTP server for sharing files from some folder."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;footer<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Run local file sharing web server"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Created with shared_ptr in order to the object survive this scope</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">and avoid reference to destroyed object when it is referenced from callback. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">server</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">MiniWebServer</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>;

    cmd-&gt;callback<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] ----- Callback invoked OK ------ \n"</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>server-&gt;get_port<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-5">&lt;</span> 0 || server-&gt;get_port<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">&gt;</span> 65535<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] "</span> &lt;&lt; <span class="org-string">" Invalid TCP port range. "</span> &lt;&lt; <span class="org-string">'\n'</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Returns non-zero status code</span>
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span>
        server-&gt;run_server<span class="org-rainbow-delimiters-depth-4">()</span>;
        <span class="org-keyword">return</span> <span class="org-constant">true</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>
          <span class="org-string">"&lt;PATH&gt;"</span>
        , bind_setter<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>server, &amp;<span class="org-constant">MiniWebServer</span>::set_path<span class="org-rainbow-delimiters-depth-3">)</span>
        , <span class="org-string">"Directory to be shared in the web server."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>-&gt;required<span class="org-rainbow-delimiters-depth-2">()</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> 
        <span class="org-string">"-p,--port"</span>
      , <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-3">){</span> server-&gt;set_port<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
      , <span class="org-string">"Server TCP port, default: 8080"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> 
        <span class="org-string">"--host"</span>
      , <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-3">){</span> server-&gt;set_host<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
      , <span class="org-string">"Hostname that server will listen to (default: 0.0.0.0)"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-2">(</span> 
        <span class="org-string">"-a,--auth"</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">, [](auto q){ server-&gt;set_auth(q); }        </span>
       , bind_setter<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>server, &amp;<span class="org-constant">MiniWebServer</span>::set_auth<span class="org-rainbow-delimiters-depth-3">)</span>
       , <span class="org-string">"Shows the command line parameters passed to QEMU."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;   
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">command_version</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp;  <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-2">(</span>name, <span class="org-string">"Show application version."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;callback<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">]{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"cliapp version 0.1 - Your favorite U-NIX swiss army knife \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Return true for idnicating successful status code </span>
        <span class="org-keyword">return</span> <span class="org-constant">true</span>; 
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">CLI</span>::<span class="org-type">App</span> <span class="org-variable-name">app</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"cliapp"</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
    app.footer<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n Command line demo toolbox."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    command_version<span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    command_version<span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"v"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Command_list</span> <span class="org-variable-name">cmd_list1</span><span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"ls"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Command_list</span> <span class="org-variable-name">cmd_list2</span><span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"list"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    command_server<span class="org-rainbow-delimiters-depth-2">(</span>app<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Parse Arguments ---------------//</span>
    <span class="org-keyword">try</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc == 1<span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::cout &lt;&lt; app.help<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
            <span class="org-keyword">return</span> 0;
         <span class="org-rainbow-delimiters-depth-3">}</span>
        app.require_subcommand<span class="org-rainbow-delimiters-depth-3">()</span>;
        app.validate_positionals<span class="org-rainbow-delimiters-depth-3">()</span>;
        app.parse<span class="org-rainbow-delimiters-depth-3">(</span>argc, argv<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">CLI</span>::<span class="org-type">ParseError</span> &amp;<span class="org-variable-name">e</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-keyword">return</span> app.exit<span class="org-rainbow-delimiters-depth-3">(</span>e<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building on MacOSX</b> 
</p>

<p>
Install GCC 9.0 via <b>brew</b>. Note: Apple's default Clang compiler does
not have the C++17 file system library. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ brew install gcc@9
</pre>
</div>

<p>
Get the code: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e src 
$ cd src 
</pre>
</div>

<p>
Override CMake default compiler: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">CC</span>=/usr/local/Cellar/gcc@9/9.3.0/bin/gcc-9
$ export <span class="org-variable-name">CXX</span>=/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9
</pre>
</div>

<p>
Configuration step: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake --config Release -H. -B_build
  ... .... ... ... .. ... ...
-- Checking whether CXX compiler supports OSX deployment target flag - yes
-- Check for working CXX compiler: /usr/local/Cellar/gcc@9/9.3.0/bin/g++-9
-- Check for working CXX compiler: /usr/local/Cellar/gcc@9/9.3.0/bin/g++-9 - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- CPM: adding package cli11@ ()

[TRACE] cli11_SOURCE_DIR =  /Volumes/data/cliapp/_build/_deps/cli11-src 
-- Configuring done
-- Generating done
-- Build files have been written to: /Volumes/data/cliapp/_build
</pre>
</div>

<p>
Building step: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake --build _build --target 
 ... ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... ... 
[ 50%] Building CXX object CMakeFiles/cliapp.dir/cliapp.cpp.o
/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9   -I/Volumes/data/cliapp/_build/_deps/cli11-src/include  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk   -std=c++17 -o <span class="org-keyword">CMakeFiles/cliapp.dir/cliapp.cpp.o</span> -c /Volumes/data/cliapp/cliapp.cpp
[100%] Linking CXX executable cliapp
/usr/local/Cellar/cmake/3.17.3/bin/cmake -E cmake_link_script CMakeFiles/cliapp.dir/link.txt --verbose=1
/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9   -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -Wl,-search_paths_first -Wl,-headerpad_max_install_names  CMakeFiles/cliapp.dir/cliapp.cpp.o  -o <span class="org-keyword">cliapp</span>  -lstdc++fs 
[100%] Built target cliapp
/usr/local/Cellar/cmake/3.17.3/bin/cmake -E cmake_progress_start /Volumes/data/cliapp/_build/CMakeFiles 0
</pre>
</div>

<p>
Check executable: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file _build/cliapp
<span class="org-function-name">_build/cliapp</span>: Mach-O 64-bit executable x86_64
</pre>
</div>

<p>
Show command line help: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp 

cliapp
<span class="org-function-name">Usage</span>: [OPTIONS] [SUBCOMMAND]

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit

<span class="org-function-name">Subcommands</span>:
  version                     Show application version.
  ls                          List directory
  list                        List directory
  server                      Run HTTP server for sharing files from some folder.


 Command line demo toolbox.
</pre>
</div>

<p>
Show help for 'server' subcommands: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp server -h
Run HTTP server for sharing files from some folder.
<span class="org-function-name">Usage</span>: _build/cliapp server [OPTIONS] &lt;PATH&gt;

<span class="org-function-name">Positionals</span>:
  &lt;PATH&gt; TEXT REQUIRED        Directory to be shared<span class="org-keyword"> in</span> the web server.

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit
  -p,--port INT               Server TCP port, default: 8080
  --host TEXT                 Hostname that server will listen to (default: 0.0.0.0)
  -a,--auth                   Shows the command line parameters passed to QEMU.

Run local file sharing web server
</pre>
</div>

<p>
Show help for 'ls' subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp ls -h
List directory
<span class="org-function-name">Usage</span>: _build/cliapp ls [OPTIONS] &lt;PATH&gt;

<span class="org-function-name">Positionals</span>:
  &lt;PATH&gt; TEXT REQUIRED        Directory to be listed.

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit
  -f,--file                   Only list files
  -d,--directory              Only list directories
  -r,--recursive              List direcotyr<span class="org-keyword"> in</span> recursive way


 Command line demo toolbox.
</pre>
</div>

<p>
Run <span class="underline">server</span> subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp server /var/www 
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 8080 ; host = 0.0.0.0; path = /var/www 
 [INFO] Server has authentication =&gt; FALSE 

$ _build/cliapp server /var/www --port 9010 --host 127.0.0.1
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; FALSE 

$ _build/cliapp server /var/www --port 9010 --host 127.0.0.1 --auth
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; TRUE 

$ _build/cliapp server /var/www --port=9010 --host=127.0.0.1 --auth
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; TRUE 
</pre>
</div>

<p>
Run <span class="underline">ls</span> subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp ls
&lt;PATH&gt; is required
Run with --help for more information.


$ _build/cliapp ls /System/Applications
  =&gt; /System/Applications/Siri.app
  =&gt; /System/Applications/Music.app
  =&gt; /System/Applications/FindMy.app
  =&gt; /System/Applications/QuickTime Player.app
  =&gt; /System/Applications/Chess.app
  =&gt; /System/Applications/Photo Booth.app
  =&gt; /System/Applications/Books.app
... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... 

$ _build/cliapp ls /System/Applications/Utilities/Terminal.app --file --recursive
... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... 

  =&gt; /System/Applications/Utilities/Terminal.app/Contents/Resources/ca.lproj/TTFindPanel.strings
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/Info.plist
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/PkgInfo
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/version.plist


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org78b2665" class="outline-3">
<h3 id="org78b2665"><span class="section-number-3">1.8</span> System information via virtual file systems</h3>
<div class="outline-text-3" id="text-1-8">
</div>
<div id="outline-container-orgad2f14b" class="outline-4">
<h4 id="orgad2f14b"><span class="section-number-4">1.8.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-8-1">
<p>
The Linux kernel provides two official APIs (Application Programming
Interfaces) for user-space applications. The system-calls, that are
stable and well documented and often made available via GLIBC (GNU C
library). And VSF - virtual file system, which are in-memory pseudo
file systems which allow user-space applications to retrieve system
information; tune kernel runtime parameters and control device drivers
by reading and writing VSF files. 
</p>

<p>
The following code demonstrates, retrives several system information
by reading files in Linux's /proc (procfs) and /sys (sysfs) virtual
file systems.
</p>

<p>
<b>Useful files in procfs or (/proc) file system</b> 
</p>

<p>
Some files that contains useful system information are: 
</p>

<ul class="org-ul">
<li><b>/proc/version</b>
<ul class="org-ul">
<li>=&gt; Linux Kernel Version</li>
</ul></li>

<li><b>/proc/cpuinfo</b>
<ul class="org-ul">
<li>=&gt; Contains information about current CPU, such as vendor;
architecture; supported vector (SIMD) extensions; number of
cores and so on.</li>
</ul></li>

<li><b>/proc/mounts</b> (command: $ mounts )
<ul class="org-ul">
<li>=&gt; Lists all mount points and mounted file systems.</li>
</ul></li>

<li><b>/proc/partitions</b>
<ul class="org-ul">
<li>=&gt; Contain all system partitons (sda, sda1, &#x2026;, sda[N])</li>
</ul></li>

<li><b>/proc/filesystems</b>
<ul class="org-ul">
<li>=&gt; Lists all supported file system types by the current kernel.</li>
</ul></li>

<li><b>/proc/modules</b> (command: $ lsmod)
<ul class="org-ul">
<li>=&gt; Contains listing of all kernel modules loaded by the
kernel. The CLI tool <span class="underline">lsmod</span> uses this file to display the loaded
modules.</li>
</ul></li>

<li><b>/proc/meminfo</b> (command: $ free -m)
<ul class="org-ul">
<li>=&gt; Contains information about current memory.</li>
</ul></li>

<li><b>/proc/uptime</b> (command: $ uptime)
<ul class="org-ul">
<li>=&gt; Stores the CPU uptime, how long the machine is running since
boot time.</li>
</ul></li>

<li><b>/proc/loadvg</b> (command: $ uptime)
<ul class="org-ul">
<li>=&gt; Shows system load average.</li>
<li>See:</li>
</ul></li>

<li><b><i>proc/sys/kernel</i></b> (Directory) - The tool <a href="https://wiki.archlinux.org/index.php/sysctl">sysctl</a>, for tweaking
Kernel parameters, manipulates the file in this directory.

<ul class="org-ul">
<li>=&gt; This directory contains, several files which allows tuning
kernel parameters at runtime, by just reading or writing to
those files.</li>
</ul></li>

<li><b>/proc/sys/kernel/hostname</b>
<ul class="org-ul">
<li>=&gt; Contains current machine hostname, that can be changed by
writiing to this file.</li>
</ul></li>

<li><b>/proc/sys/kernel/ostype</b>
<ul class="org-ul">
<li>=&gt; Operating system type, always set to "Linux".</li>
</ul></li>

<li><b>/proc/sys/kernel/osrelease</b>
<ul class="org-ul">
<li>=&gt; Linux kernel version.</li>
</ul></li>

<li><b>/proc/sys/kernel/sysrq</b>
<ul class="org-ul">
<li>=&gt; If this file is set to '1', it allows using the magic SysRQ
key makes possible to kill hogging processes when the machine
hangs or freeze due to high memory usage.</li>
</ul></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<p>
General: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man5/proc.5.html">proc(5) - Linux manual page</a> - PROCFS - pseudo file sytem.</li>

<li><a href="https://web.mit.edu/rhel-doc/5/RHEL-5-manual/Deployment_Guide-en-US/s1-proc-directories.html">3.3. Directories within <i>proc</i></a></li>

<li><a href="https://source.android.com/devices/architecture/kernel/reqs-interfaces">Interface Requirements  |  Android Open Source Project</a></li>

<li><a href="https://wiki.gentoo.org/wiki/Procfs">procfs - Gentoo Wiki</a></li>

<li><a href="http://0pointer.de/blog/projects/ids.html">On IDs</a> (Forensic information from Linux machines)</li>
</ul>

<p>
Kernel Runtime Settings (/proc/sys/kernel) and sysctl tool:
</p>

<ul class="org-ul">
<li><a href="http://www.linux-admins.net/2010/09/all-you-need-to-know-about-procsys.html">Linux Administration: All you need to know about /proc/sys to manipulate a running kernel</a></li>

<li><a href="https://linuxreviews.org/Kernel_panic">Kernel panic - LinuxReviews</a></li>

<li><a href="https://www.thegeekdiary.com/how-to-use-sysrq-tool-in-centos-rhel/">How to use Magic SysRq tool in CentOS / RHEL – The Geek Diary</a></li>

<li><a href="https://wiki.archlinux.org/index.php/sysctl">sysctl - ArchWiki</a> (Manipulates kernel parameters at runtime - directory: /proc/sys/kernel)</li>

<li><a href="https://linux-audit.com/linux-hardening-with-sysctl/">Linux hardening with sysctl settings - Linux Audit</a></li>
</ul>

<p>
Linux Load Average (/proc/loadavg)
</p>

<ul class="org-ul">
<li><a href="http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html">Linux Load Averages: Solving the Mystery</a> (Brendan Gregg)</li>

<li><a href="https://stackoverflow.com/questions/11987495/linux-proc-loadavg">linux /proc/loadavg - Stack Overflow</a> (How to interpret the file
/proc/loadavg)</li>

<li><a href="https://docs.fedoraproject.org/en-US/Fedora/17/html/System_Administrators_Guide/s2-proc-loadavg.html">E.2.15.  /proc/loadavg</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf4a682a" class="outline-4">
<h4 id="orgf4a682a"><span class="section-number-4">1.8.2</span> Sample Code</h4>
<div class="outline-text-4" id="text-1-8-2">
<p>
Code available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/2527d1402ea1469f67fba9ab172f05e5">https://gist.github.com/2527d1402ea1469f67fba9ab172f05e5</a></li>
</ul>

<p>
File: <span class="underline">linux-info.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/* </span><span class="org-comment">Summary: Gets Linux runtime information from VSF virtual file system. </span>
<span class="org-comment"> *</span>
<span class="org-comment"> */</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">std::seprecision, std::fixed </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">See: https://man7.org/linux/man-pages/man2/sysinfo.2.html</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/sysinfo.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>        <span class="org-function-name">get_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_sysinfo1</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_uptime</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_mount_points</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_kernel_runtime_config</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-function-name">std</span>::string readFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Usage: $ "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;COMMAND&gt; "</span> &lt;&lt; <span class="org-string">'\n'</span>;
          <span class="org-keyword">return</span> EXIT_FAILURE;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">){</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== Kernel Version ===================================="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">version</span> = readFile<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/version"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" System version = "</span> &lt;&lt; version &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"memory"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==== Memory (Reported by command $ free -m ) ========"</span> &lt;&lt; <span class="org-string">'\n'</span>;
           get_memory_info<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
       <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-comment-delimiter">// </span><span class="org-comment">Using the header: &lt;sys/sysinfo.h&gt;  </span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Note: this information is reported by the command $ free -m </span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"sysinfo1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== System Info 1 (Reported by $ free -m and $ uptime ) === "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_sysinfo1<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"uptime"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== System uptime since boot (Reported by $ uptime) ===="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_uptime<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"load-avg"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==== System Load Average ================================"</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">loadavg</span> = readFile<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/loadavg"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Load average = "</span> &lt;&lt; loadavg &lt;&lt; <span class="org-string">'\n'</span>;   
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"mount"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ====== System mount points ( Reported by command $ mount ) ===== "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_mount_points<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"sysctl"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== Kernel Runtime Information (Reported by $ sysctl ) ======= "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_kernel_runtime_config<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"dmesg"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== Kernel debug message (Reported by $ dmesg ) =========="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/dev/kmsg"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-4">(</span>ifs, line<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">){</span>
                   <span class="org-constant">std</span>::cout &lt;&lt; line &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"cpuinfo"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"======= CPU Information ====================================="</span> &lt;&lt; <span class="org-string">'\n'</span>;

           <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/cpuinfo"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-4">(</span>ifs, line<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">){</span>
                   <span class="org-constant">std</span>::cout &lt;&lt; line &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>        
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">get_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">meminfo_file</span> = <span class="org-string">"/proc/meminfo"</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">factor = 1 Gigabytes = 1024 * 1024 kbytes </span>
     <span class="org-keyword">constexpr</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1024 * 1024;

     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">{</span>meminfo_file<span class="org-rainbow-delimiters-depth-2">}</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs.good<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">){</span>
             <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to memory-info file."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">label</span>;
     <span class="org-constant">std</span>::<span class="org-type">uint64_t</span> <span class="org-variable-name">value</span>; 
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>      
          <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-3">{</span>line<span class="org-rainbow-delimiters-depth-3">}</span>;   
          ss &gt;&gt; label &gt;&gt; value;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>label == <span class="org-string">"MemTotal:"</span><span class="org-rainbow-delimiters-depth-3">)</span>
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"     Total memory (Gb) = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>value / factor<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>label == <span class="org-string">"MemAvailable:"</span><span class="org-rainbow-delimiters-depth-3">)</span>      
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Memory Available (Gb) = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>value / factor<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_sysinfo1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">struct</span> <span class="org-type">sysinfo</span> <span class="org-variable-name">info</span>;
     ::sysinfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;info<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">1 Gigabyte = 1024 megabytes = 1024 * 1024 kbytes = 1024 * 1024 * 1024 bytes;</span>
     <span class="org-keyword">constexpr</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1024 * 1024 * 1024;
     <span class="org-keyword">constexpr</span> <span class="org-constant">std</span>::<span class="org-type">uint64_t</span> <span class="org-variable-name">one_day_to_seconds</span> = 24 * 60 * 60;

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] System uptime since boot (seconds) = "</span> &lt;&lt; info.uptime &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*] System uptime since boot    (days) = "</span> &lt;&lt; info.uptime    / one_day_to_seconds &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]              Total RAM memory (Gb) = "</span> &lt;&lt; info.totalram  / factor &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]              Free  RAM memory (Gb) = "</span> &lt;&lt; info.freeram   / factor &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]                    Total SWAP (Gb) = "</span> &lt;&lt; info.totalswap / factor &lt;&lt; <span class="org-string">'\n'</span>                 
                       &lt;&lt; <span class="org-string">" [*]                     Free SWAP (Gb) = "</span> &lt;&lt; info.freeswap  / factor &lt;&lt; <span class="org-string">'\n'</span>                                 
                       &lt;&lt; <span class="org-string">" [*]        Number of processes running = "</span> &lt;&lt; info.procs &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Reported by command $ uptime </span>
<span class="org-type">void</span> <span class="org-function-name">show_uptime</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/uptime"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>ifs.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to open uptime file "</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-type">double</span> <span class="org-variable-name">seconds</span>;
     ifs &gt;&gt; seconds; 
     <span class="org-type">uint64_t</span> <span class="org-variable-name">factor</span> = 24 * 60 * 60;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"   Uptime in hours = "</span> &lt;&lt; seconds / <span class="org-rainbow-delimiters-depth-2">(</span> 60 * 60<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    Uptime in days = "</span> &lt;&lt; seconds / factor &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">show_kernel_runtime_config</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">show_field</span>= <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">label</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] "</span> 
                   &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>40<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>label + <span class="org-string">" =&gt; "</span><span class="org-rainbow-delimiters-depth-3">)</span>
                   &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>50<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-constant">std</span>::left  &lt;&lt; readFile<span class="org-rainbow-delimiters-depth-3">(</span>file<span class="org-rainbow-delimiters-depth-3">)</span>
                   &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">'\n'</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Machine Hostname"</span>,                <span class="org-string">"/proc/sys/kernel/hostname"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Kernel Version"</span>,                  <span class="org-string">"/proc/sys/kernel/osrelease"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Os type"</span>,                         <span class="org-string">"/proc/sys/kernel/ostype"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Boot unique ID identifier"</span>,       <span class="org-string">"/proc/sys/kernel/random/boot_id"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Date which kernel was compiled"</span>,  <span class="org-string">"/proc/sys/kernel/version"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Sysrq enabled (Emergency keys)"</span>,  <span class="org-string">"/proc/sys/kernel/sysrq"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Max number of Cgroups namespaces"</span>, <span class="org-string">"/proc/sys/user/max_cgroup_namespaces"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Max number of Mount namespaces"</span>,   <span class="org-string">"/proc/sys/user/max_net_namespaces"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">show_network_interfaces</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: not implemented yet."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Show mounted file systems, but ignore 'cgroup', 'overlay', 'fusectl'   </span>
<span class="org-type">void</span> <span class="org-function-name">show_mount_points</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs<span class="org-rainbow-delimiters-depth-2">){</span> 
             <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to open file /proc/mounts"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    "</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"File system"</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"Type"</span>
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>10<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"Mount point"</span>
               &lt;&lt; <span class="org-string">'\n'</span>;

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    "</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"------------"</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"----"</span>
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>10<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"-----------"</span>
               &lt;&lt; <span class="org-string">'\n'</span>;

     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">fsystem</span>, <span class="org-variable-name">type</span>, <span class="org-variable-name">mount_directory</span>;  

     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-3">(</span>line<span class="org-rainbow-delimiters-depth-3">)</span>;
        ss &gt;&gt; fsystem &gt;&gt; mount_directory &gt;&gt; type;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> type != <span class="org-string">"cgroup"</span> &amp;&amp; type != <span class="org-string">"overlay"</span> &amp;&amp; type != <span class="org-string">"cgroup2"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"   "</span> 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>20<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; fsystem 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>20<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; type 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>10<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; mount_directory 
                      &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Requires: &lt;string&gt;, &lt;stream&gt;, &lt;sstream&gt;</span>
<span class="org-function-name">std</span>::string readFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">ifstream</span> <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-2">(</span>file<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>is.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stream has errors."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
    ss &lt;&lt; is.rdbuf<span class="org-rainbow-delimiters-depth-2">()</span>;   
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove ending line character '\n' or '\r\n'.</span>
        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-2">(</span>ss, m<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> m;
<span class="org-rainbow-delimiters-depth-1">}</span> 

</pre>
</div>
</div>
</div>

<div id="outline-container-org1292d5e" class="outline-4">
<h4 id="org1292d5e"><span class="section-number-4">1.8.3</span> Running</h4>
<div class="outline-text-4" id="text-1-8-3">
<p>
<b>Building:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ linux-info.cpp -o <span class="org-keyword">linux-info</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
<b>Running</b>  (Tested on Linux distribution <a href="https://pop.system76.com/">PopOS</a> Live CD running in a virtual machine)
</p>

<p>
Get Kernel Version: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info 
 [ERROR] Usage: $ ./linux-info &lt;COMMAND&gt; 

 $ &gt;&gt; ./linux-info version <span class="org-comment-delimiter"># </span><span class="org-comment">Get Kernel version</span>
===== Kernel Version ====================================
 System version = Linux version 5.4.0-7634-generic (buildd@lcy01-amd64-003) (gcc version 9.3.0 (Ubuntu 9.3.0-10ubuntu2)) <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2</span>
 $ &gt;&gt; 
</pre>
</div>

<p>
Get RAM memory available (equivalent to $ free -m)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info memory <span class="org-comment-delimiter"># </span><span class="org-comment">RAM memory </span>
==== Memory (Reported by command $ free -m ) ========
    Total memory (Gb) = 1.9175
Memory Available (Gb) = 1.01926
</pre>
</div>

<p>
System uptime and RAM memory available: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info sysinfo1 
===== System Info 1 (Reported by $ free -m and $ uptime ) === 
[*] System uptime since boot (seconds) = 760
[*] System uptime since boot    (days) = 0
[*]              Total RAM memory (Gb) = 1.9175
[*]              Free  RAM memory (Gb) = 0.20657
[*]                    Total SWAP (Gb) = 0
[*]                     Free SWAP (Gb) = 0
[*]        Number of processes running = 444
</pre>
</div>

<p>
Load average: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info load-avg
 ==== System Load Average ================================
Load average = 0.27 0.28 0.28 4/443 2532

</pre>
</div>

<p>
Mounted file systems (file: /proc/mounts)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info mount 
====== System mount points ( Reported by command $ mount ) ===== 

   File system         Type                Mount point
   ------------        ----                -----------
  sysfs               sysfs               /sys      
  proc                proc                /proc     
  udev                devtmpfs            /dev      
  devpts              devpts              /dev/pts  
  tmpfs               tmpfs               /run      
  /dev/sr0            iso9660             /cdrom    
  /dev/loop0          squashfs            /rofs     
  securityfs          securityfs          /sys/kernel/security
  tmpfs               tmpfs               /dev/shm  
  tmpfs               tmpfs               /run/lock 

 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 

  debugfs             debugfs             /sys/kernel/debug
  tracefs             tracefs             /sys/kernel/tracing
  fusectl             fusectl             /sys/fs/fuse/connections
  configfs            configfs            /sys/kernel/config
  tmpfs               tmpfs               /tmp      
  tmpfs               tmpfs               /run/user/999
  gvfsd-fuse          fuse.gvfsd-fuse     /run/user/999/gvfs
  /dev/fuse           fuse                /run/user/999/doc
  /dev/fuse           fuse                /root/.cache/doc
  gvfsd-fuse          fuse.gvfsd-fuse     /root/.cache/gvfs
  binfmt_misc         binfmt_misc         /proc/sys/fs/binfmt_misc
</pre>
</div>

<p>
Kernel runtime information (directory <span class="underline">/proc/sys/kernel</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info sysctl <span class="org-comment-delimiter"># </span><span class="org-comment">Show some kernel runtime options</span>
===== Kernel Runtime Information (Reported by $ sysctl ) ======= 

[*]                     Machine Hostname =&gt; pop-os                                            
[*]                       Kernel Version =&gt; 5.4.0-7634-generic                                
[*]                              Os type =&gt; Linux                                             
[*]            Boot unique ID identifier =&gt; 756989d9-f596-4e4f-ac50-d5c3026d041a              
[*]       Date which kernel was compiled =&gt; <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2</span>
[*]       Sysrq enabled (Emergency keys) =&gt; 176                                               
[*]     Max number of Cgroups namespaces =&gt; 7490                                              
[*]       Max number of Mount namespaces =&gt; 7490                                              
</pre>
</div>

<p>
Kernel messages (file: <span class="underline">/dev/kmsg</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info dmesg

 ===== Kernel debug message (Reported by $ dmesg ) ==========
5,0,0,-;Linux version 5.4.0-7634-generic (buildd@lcy01-amd64-003) (gcc version 9.3.0 (Ubuntu 9.3.0-10ubuntu2)) <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2 (Ubuntu 5.4.0-7634.38~1591219791~20.04~6b1c5de-generic 5.4.41)</span>
6,1,0,-;Command line: <span class="org-variable-name">BOOT_IMAGE</span>=/casper_pop-os_20.04_amd64_intel_debug_19/vmlinuz.efi <span class="org-variable-name">initrd</span>=/casper_pop-os_20.04_amd64_intel_debug_19/initrd.gz <span class="org-variable-name">boot</span>=casper live-media-path=/casper_pop-os_20.04_amd64_intel_debug_19 <span class="org-variable-name">hostname</span>=pop-os <span class="org-variable-name">username</span>=pop-os noprompt  ---
6,2,0,-;KERNEL supported cpus:
6,3,0,-;  Intel GenuineIntel
  ....   ....   ....   ....   ....   ....   .... 
  ....   ....   ....   ....   ....   ....   .... 

 <span class="org-variable-name">DEVICE</span>=+hdaudio:hdaudioC0D0
6,649,16644546,-;snd_hda_codec_generic hdaudioC0D0:    inputs:
 <span class="org-variable-name">SUBSYSTEM</span>=hdaudio
 <span class="org-variable-name">DEVICE</span>=+hdaudio:hdaudioC0D0
7,650,25338660,-;rfkill: input handler disabled
5,651,40422354,-;random: crng init done
5,652,40422357,-;random: 7 urandom warning(s) missed due to ratelimiting
</pre>
</div>

<p>
<b>Testing with Fedora 32 x86-64 (64 bits)</b> 
</p>

<p>
Get mount points (file: <span class="underline">/proc/mounts</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./linux-info mount
 ====== System mount points ( Reported by command $ mount ) ===== 

    File system         Type                Mount point
    ------------        ----                -----------
   sysfs               sysfs               /sys      
   proc                proc                /proc     
   devtmpfs            devtmpfs            /dev      
   securityfs          securityfs          /sys/kernel/security
   tmpfs               tmpfs               /dev/shm  
   devpts              devpts              /dev/pts  
   tmpfs               tmpfs               /run      
   tmpfs               tmpfs               /sys/fs/cgroup
   pstore              pstore              /sys/fs/pstore
   efivarfs            efivarfs            /sys/firmware/efi/efivars
   none                bpf                 /sys/fs/bpf
   configfs            configfs            /sys/kernel/config
   /dev/sda3           ext4                /         
   systemd-1           autofs              /proc/sys/fs/binfmt_misc
   tmpfs               tmpfs               /tmp      
   fusectl             fusectl             /sys/fs/fuse/connections
   /dev/sda1           vfat                /boot/efi 
   sunrpc              rpc_pipefs          /var/lib/nfs/rpc_pipefs
   tmpfs               tmpfs               /run/user/42
   tmpfs               tmpfs               /run/user/1000
   gvfsd-fuse          fuse.gvfsd-fuse     /run/user/1000/gvfs
   nsfs                nsfs                /run/docker/netns/77290c7a4863
   binfmt_misc         binfmt_misc         /proc/sys/fs/binfmt_misc
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org40314f8" class="outline-3">
<h3 id="org40314f8"><span class="section-number-3">1.9</span> Disk Space Usage on Linux and BSD-variants</h3>
<div class="outline-text-3" id="text-1-9">
<p>
The following code gets the disk space usage on Linux-derived
operating systems by iterating over the file <span class="underline">/proc/mounts</span> for
determining mounted file systems and then uses the <span class="underline">statfs()</span> function
for getting disk usage information from each file system mount
point. Unlike, Linux On BSD variants such, as FreeBSD, OpenBSD and
Mac-OSX, there is no PROCFS virtual file system. On those operating
systems, the information about disk space usage can be obtained in a
single step by using the function <a href="https://www.freebsd.org/cgi/man.cgi?query=getmntinfo&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getmntinfo()</a>.
</p>

<p>
<b>Functions used</b> 
</p>

<ul class="org-ul">
<li>Documentation: $ man statfs</li>
<li>The functions <span class="underline">statfs</span> and <span class="underline">fstatfs</span> provide information about
mounted file systems. The parameter buf, must be allocated by the
caller. When the function fails, it returns (-1).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/vfs.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">/* </span><span class="org-comment">or &lt;sys/statfs.h&gt; */</span>

<span class="org-type">int</span> <span class="org-function-name">statfs</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">statfs</span> *<span class="org-variable-name">buf</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span> <span class="org-function-name">fstatfs</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">struct</span> <span class="org-type">statfs</span> *<span class="org-variable-name">buf</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">struct</span> <span class="org-type">statfs</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_type</span>;    <span class="org-comment-delimiter">/* </span><span class="org-comment">Type of filesystem (see below) */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_bsize</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Optimal transfer block size */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_blocks</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Total data blocks in filesystem */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_bfree</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Free blocks in filesystem */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_bavail</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Free blocks available to</span>
<span class="org-comment">                             unprivileged user */</span>
    <span class="org-type">fsfilcnt_t</span> <span class="org-variable-name">f_files</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Total file nodes in filesystem */</span>
    <span class="org-type">fsfilcnt_t</span> <span class="org-variable-name">f_ffree</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Free file nodes in filesystem */</span>
    <span class="org-type">fsid_t</span>     <span class="org-variable-name">f_fsid</span>;    <span class="org-comment-delimiter">/* </span><span class="org-comment">Filesystem ID */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_namelen</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">Maximum length of filenames */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_frsize</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Fragment size (since Linux 2.6) */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_flags</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Mount flags of filesystem</span>
<span class="org-comment">                             (since Linux 2.6.36) */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_spare</span><span class="org-rainbow-delimiters-depth-2">[</span>xxx<span class="org-rainbow-delimiters-depth-2">]</span>;
                    <span class="org-comment-delimiter">/* </span><span class="org-comment">Padding bytes reserved for future use */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>Sample Code</b> 
</p>

<p>
File: <span class="underline">df-size.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">----- Get Disk Space Usage -------------// </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cmath</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">------ Unix Headers ----//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/vfs.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">/* </span><span class="org-comment">Get statfs() */</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">struct</span> <span class="org-type">mount_point</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">File System </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">fsystem</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Mounting directroy </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">mount_directory</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">File system type </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">type</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">MountpointConsumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-type">void</span> <span class="org-function-name">iterate_mount_points</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MountpointConsumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> ;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

   iterate_mount_points<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">mount_point</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">mnt</span><span class="org-rainbow-delimiters-depth-3">)</span>
   <span class="org-rainbow-delimiters-depth-3">{</span>
       <span class="org-keyword">struct</span> <span class="org-type">statfs</span> <span class="org-variable-name">fs</span>;
       <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">mount_dir</span> = mnt.mount_directory.c_str<span class="org-rainbow-delimiters-depth-4">()</span>;

       <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt;&gt;&gt; List of file system that will be ignored. </span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">'static' keyworkd =&gt;  Variable allocated only once, when </span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">this function is called for the first time. </span>
       <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">auto</span> ignored_fsystem = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-4">&gt;{</span>
             <span class="org-string">"cgroup"</span>, <span class="org-string">"cgroup2"</span>, <span class="org-string">"proc"</span>, <span class="org-string">"sysfs"</span>, <span class="org-string">"tmpfs"</span>, <span class="org-string">"devtmpfs"</span>
           , <span class="org-string">"configfs"</span>, <span class="org-string">"bpf"</span>, <span class="org-string">"mqueue"</span>, <span class="org-string">"hugetlbfs"</span>, <span class="org-string">"tracefs"</span>
           , <span class="org-string">"fuse.gvfsd-fuse"</span>, <span class="org-string">"rpc_pipefs"</span>, <span class="org-string">"debugfs"</span>
           , <span class="org-string">"overlay"</span>, <span class="org-string">"securityfs"</span>, <span class="org-string">"devpts"</span>, <span class="org-string">"pstore"</span>, <span class="org-string">"efivarfs"</span>
           , <span class="org-string">"autofs"</span>, <span class="org-string">"binfmt_misc"</span>, <span class="org-string">"tmpfs"</span>, <span class="org-string">"fusectl"</span>, <span class="org-string">"nsfs"</span>
           , <span class="org-string">"selinuxfs"</span>, <span class="org-string">"functionfs"</span>
        <span class="org-rainbow-delimiters-depth-4">}</span>;

       <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore the following types of file-system, mostly VSF (Virtual File Systems)</span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">or in-memory file systems.</span>
       <span class="org-keyword">auto</span> <span class="org-variable-name">iter</span> = <span class="org-constant">std</span>::find<span class="org-rainbow-delimiters-depth-4">(</span>ignored_fsystem.cbegin<span class="org-rainbow-delimiters-depth-5">()</span>, ignored_fsystem.cend<span class="org-rainbow-delimiters-depth-5">()</span>, mnt.type <span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> iter != ignored_fsystem.end<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-variable-name">statfs</span><span class="org-rainbow-delimiters-depth-5">(</span>mount_dir, &amp;fs<span class="org-rainbow-delimiters-depth-5">)</span> == -1 <span class="org-rainbow-delimiters-depth-4">)</span>
       <span class="org-rainbow-delimiters-depth-4">{</span>
           <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Unable to get file system statistics for: "</span> 
                     &lt;&lt; <span class="org-string">" Mount point =&gt; "</span> &lt;&lt; mnt.mount_directory 
                     &lt;&lt; <span class="org-string">" / "</span> &lt;&lt; mnt.fsystem.c_str<span class="org-rainbow-delimiters-depth-5">()</span> 
                     &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">return</span>;
       <span class="org-rainbow-delimiters-depth-4">}</span>

       <span class="org-keyword">const</span> <span class="org-type">size_t</span> <span class="org-variable-name">block_size</span> = fs.f_bsize;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Total disk space in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">total_space</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>fs.f_blocks<span class="org-rainbow-delimiters-depth-4">)</span> * block_size / <span class="org-rainbow-delimiters-depth-4">(</span>1024 * 1024 * 1024<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-comment-delimiter">// </span><span class="org-comment">Free disk space in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">available_space</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>fs.f_bavail<span class="org-rainbow-delimiters-depth-4">)</span> * block_size / <span class="org-rainbow-delimiters-depth-4">(</span>1024 * 1024 * 1024<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-comment-delimiter">// </span><span class="org-comment">Disk space usage in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">used_space</span> = total_space - available_space;

       <span class="org-comment-delimiter">// </span><span class="org-comment">Disk space usage in percent (%) </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">used_space_pct</span> = <span class="org-rainbow-delimiters-depth-4">(</span>1.0 - available_space / total_space<span class="org-rainbow-delimiters-depth-4">)</span> * 100.0;

       <span class="org-keyword">auto</span> <span class="org-variable-name">fsystem_abspath</span> = read_symlink<span class="org-rainbow-delimiters-depth-4">(</span>mnt.fsystem<span class="org-rainbow-delimiters-depth-4">)</span>;

       <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"      File System: "</span> &lt;&lt; fsystem_abspath      &lt;&lt; <span class="org-string">'\n'</span>
                 &lt;&lt; <span class="org-string">"             Type: "</span> &lt;&lt; mnt.type             &lt;&lt; <span class="org-string">'\n'</span>       
                 &lt;&lt; <span class="org-string">"      Mount Point: "</span> &lt;&lt; mnt.mount_directory  &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>total_space &gt; 1.0<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Total space (Gb): "</span> &lt;&lt; total_space            &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Free space (Gb): "</span> &lt;&lt; available_space        &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Used space (Gb): "</span> &lt;&lt; used_space             &lt;&lt; <span class="org-string">'\n'</span>                      
                      &lt;&lt; <span class="org-string">"   Used space (%): "</span> &lt;&lt; used_space_pct &lt;&lt;  <span class="org-string">"%"</span> &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  Free space (Mb): "</span> &lt;&lt; available_space * 1024  &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">" Total space (Mb): "</span> &lt;&lt; total_space * 1024      &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Used space (Gb): "</span> &lt;&lt; used_space * 1024       &lt;&lt; <span class="org-string">'\n'</span>                                            
                      &lt;&lt; <span class="org-string">"   Used space (%): "</span> &lt;&lt; used_space_pct &lt;&lt; <span class="org-string">"%"</span>   &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-rainbow-delimiters-depth-4">}</span>
   <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">----------------------------------------------------------------------//</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">MountpointConsumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-type">void</span> <span class="org-function-name">iterate_mount_points</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MountpointConsumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to open file /proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;     
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">fsystem</span>, <span class="org-variable-name">mount_directory</span>, <span class="org-variable-name">type</span>; 

    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-3">(</span>line<span class="org-rainbow-delimiters-depth-3">)</span>;
        ss &gt;&gt; fsystem &gt;&gt; mount_directory &gt;&gt; type;
        consumer<span class="org-rainbow-delimiters-depth-3">(</span> mount_point<span class="org-rainbow-delimiters-depth-4">{</span> fsystem, mount_directory, type <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">if( type != "cgroup" &amp;&amp; type != "overlay" &amp;&amp; type != "cgroup2")        </span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Get absolute path to file or symbolic link </span>
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> path; <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building and Running on Fedora Linux 32 x86-64</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ df-size.cpp -o <span class="org-keyword">df-size.bin</span> -std=c++1z -Wall -Wextra -g 

$ &gt;&gt; ./df-size.bin 
     File System: /dev/sda3
            Type: ext4
     Mount Point: /
Total space (Gb): 49.06
 Free space (Gb): 23.9494
 Used space (Gb): 25.1106
  Used space (%): 51.1835%

     File System: /dev/sda4
            Type: ext4
     Mount Point: /home
Total space (Gb): 846.607
 Free space (Gb): 510.182
 Used space (Gb): 336.424
  Used space (%): 39.738%

     File System: /dev/sda1
            Type: vfat
     Mount Point: /boot/efi
 Free space (Mb): 279.422
Total space (Mb): 299.82
 Used space (Gb): 20.3984
  Used space (%): 6.80355%
</pre>
</div>

<p>
Disk space via (df) command line tool: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; df -h 
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        7.8G     0  7.8G   0% /dev
tmpfs           7.8G  315M  7.5G   4% /dev/shm
tmpfs           7.8G  2.1M  7.8G   1% /run
tmpfs           7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/sda3        50G   23G   24G  49% /
tmpfs           7.8G   11M  7.8G   1% /tmp
/dev/sda4       847G  294G  511G  37% /home
/dev/sda1       300M   21M  280M   7% /boot/efi
tmpfs           1.6G   16K  1.6G   1% /run/user/42
tmpfs           1.6G   80K  1.6G   1% /run/user/1000
</pre>
</div>

<p>
<b>Cross-compiling to Linux Armv7 and run on Android via ADB</b>
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">DOCKER_COMMAND</span>=<span class="org-string">"docker run -e UID=$(</span><span class="org-sh-quoted-exec">id</span><span class="org-string"> -u) -e GID=$(</span><span class="org-sh-quoted-exec">id</span><span class="org-string"> -g) --volume=$PWD:/cwd --workdir=/cwd muslcc/i686:armv7l-linux-musleabihf "</span>
$ $<span class="org-variable-name">DOCKER_COMMAND</span> g++ df-size.cpp -o <span class="org-keyword">df-size.armv7</span> -std=c++1z -static -Wall -Wextra
$ $<span class="org-variable-name">DOCKER_COMMAND</span> strip df-size.armv7 

$ file df-size.armv7 
<span class="org-function-name">df-size.armv7</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, stripped

$ du -h df-size.armv7 
820K    df-size.armv7
820K    total
</pre>
</div>

<p>
Transfer executable to Android: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ adb push df-size.armv7 /data/local/tmp
<span class="org-function-name">df-size.armv7</span>: 1 file pushed. 12.1 MB/s (839348 bytes<span class="org-keyword"> in</span> 0.066s)
</pre>
</div>

<p>
Running on Android vai adb shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ adb shell
<span class="org-function-name">bali</span>:/ $ 
<span class="org-function-name">bali</span>:/ $ cd /data/local/tmp
<span class="org-function-name">bali</span>:/data/local/tmp $ 

<span class="org-comment-delimiter"># </span><span class="org-comment">Confirm disk space usage metrics </span>
<span class="org-function-name">bali</span>:/data/local/tmp $ df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/root             2.6G  2.2G  450M  84% /
tmpfs                 931M  1.3M  930M   1% /dev
tmpfs                 931M     0  931M   0% /mnt
/dev/block/dm-1       1.4G  207M  1.2G  15% /vendor
/dev/block/mmcblk0p39  23G   12G   11G  53% /data
/dev/block/mmcblk0p38 402M  6.4M  383M   2% /cache
/data/media            23G   12G   11G  53% /storage/emulated

<span class="org-comment-delimiter"># </span><span class="org-comment">Run application </span>
<span class="org-function-name">bali</span>:/data/local/tmp $ ./df-size.armv7  2&gt; /dev/null                                                         
      File System: /dev/root
             Type: ext4
      Mount Point: /
 Total space (Gb): 2.66402
  Free space (Gb): 0.439049
  Used space (Gb): 2.22497
   Used space (%): 83.5193%

      File System: /dev/block/dm-1
             Type: ext4
      Mount Point: /vendor
 Total space (Gb): 1.45304
  Free space (Gb): 1.23495
  Used space (Gb): 0.218094
   Used space (%): 15.0094%

      File System: /dev/block/mmcblk0p39
             Type: f2fs
      Mount Point: /data
 Total space (Gb): 23.4941
  Free space (Gb): 11.2018
  Used space (Gb): 12.2923
   Used space (%): 52.3209%

      File System: /dev/block/mmcblk0p38
             Type: ext4
      Mount Point: /cache
  Free space (Mb): 383.078
 Total space (Mb): 402.445
  Used space (Gb): 19.3672
   Used space (%): 4.81238%

      File System: /dev/block/mmcblk0p35
             Type: ext4
      Mount Point: /product
  Free space (Mb): 444.348
 Total space (Mb): 476.59
  Used space (Gb): 32.2422
   Used space (%): 6.76519%

      File System: /data/media
             Type: sdcardfs
      Mount Point: /storage/emulated
 Total space (Gb): 23.4941
  Free space (Gb): 11.2018
  Used space (Gb): 12.2923
   Used space (%): 52.3209%
</pre>
</div>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/statvfs.html">Unix OpenGroup - fstatvfs</a></li>

<li><a href="https://utcc.utoronto.ca/~cks/space/blog/unix/StatfsPeculiarities">Chris's Wiki - blog/unix/StatfsPeculiarities</a></li>

<li><a href="https://ownyourbits.com/2018/05/02/understanding-disk-usage-in-linux/">Understanding disk usage in Linux – Own your bits</a></li>

<li><a href="https://ownyourbits.com/2018/05/02/understanding-disk-usage-in-linux/">Understanding disk usage in Linux – Own your bits</a> (Web Archive)</li>

<li><a href="https://unix.stackexchange.com/questions/429155/how-is-free-disk-space-on-ext4-calculated">filesystems - How is free disk space on ext4 calculated? - Unix &amp; Linux Stack Exchange</a></li>

<li><a href="https://stackoverflow.com/questions/3899894/how-to-obtain-total-available-disk-space-in-posix-systems">c++ - How to obtain total available disk space in Posix systems? - Stack Overflow</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getmntinfo&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">FreeBSD Docs / getmntinfo()</a> =&gt; get information about mounted file systems</li>

<li><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/getmntinfo.3.html">MacOSX / getmntinfo()</a></li>

<li><a href="http://www.edenwaith.com/blog/index.php?p=67">Edenwaith : Blog - Calculating Free Space on macOS</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8275a2d" class="outline-3">
<h3 id="org8275a2d"><span class="section-number-3">1.10</span> Low level open, read, write, close - IO sycalls overview</h3>
<div class="outline-text-3" id="text-1-10">
<p>
The open(), read(), write() and close() system calls are the hallmark
of Unix-based operating system as they embody the concept "every is a
file" or "everything is a file descriptor". Those fundamental system
calls are able to operate over any type of file descriptors such as
regular files; symbolic links; in-memory files; anonymous pipes; named
pipes; sockets; unix domain sockets IPC (Inter-Process Communication);
character device files representing hardware; block device files, which
represents non-volatile storage device and so on.
</p>

<p>
It is worth noting that, those system-calls are not used directly by
user-space applications. Instead, applications uses C function
wrappers provided by the CRT (C Runtime Library), which is GLIBC in
most Linux distributions. 
</p>

<p>
<b>Special File Descriptors</b> 
</p>

<ul class="org-ul">
<li>STDOUT_FILENO =&gt; File descritor for stdout (process standard output)</li>

<li>STDERR_FILENO =&gt; File descritor for stderr (process standard error output)</li>

<li>STDIN_FILENO  =&gt; File descritor for stdin (process standard input)</li>
</ul>

<p>
<b>Headers</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
</pre>
</div>

<p>
<b>Functions</b> 
</p>

<ul class="org-ul">
<li>close() =&gt; Close a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 close</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>open() =&gt; Encapsulates open system call =&gt; Returns a file descritor
number. When fails, it returns (-1) setting the global variable
<span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 open</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>creat() =&gt; Create file. Note: the name is not misspelled. There is
really a missing 'e' letter. 
<ul class="org-ul">
<li>Doc: $ man 2 creat</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">creat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<ul class="org-ul">
<li>read() =&gt; Read bytes from a file descriptor into a buffer, returning the
number of bytes read. If there is an error, the functions returns
(-1) setting the global variable <span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 read</li>

<li>Note: If the number of bytes returned is zero, it means that no
more bytes can be read in the case of file or that socket
connection was closed by the counterpart (socket server or client).</li>

<li>Note: The number of bytes returned can smaller than the buffer
size in the case of socket file descriptors (partial read).</li>

<li>Note: The buffer argument can be a pointer to any POD (Plain-Old
Data) type allocated by the calling code. A POD type, does not
have any internal pointers or STL containers.</li>

<li>Note: A negative return value (-1), as in most Unix APIs, indicates
an error. In order to get more information about the error, the
calling code must check the <span class="underline">errno</span> global variable.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>write() =&gt; Write N bytes from a buffer to a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 write</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd220f65" class="outline-3">
<h3 id="orgd220f65"><span class="section-number-3">1.11</span> Low level IO - read() syscall</h3>
<div class="outline-text-3" id="text-1-11">
<p>
<b>Summary:</b>
</p>

<ul class="org-ul">
<li>Read data from file descriptor to a buffer. Where buffer a
pointer to any storage location within the process virtual
memory. The 'buffer' argument can be a pointer to any POD type
plain-old data, which continuous allocated in the memory, without
any internal pointer.</li>
</ul>
<ul class="org-ul">
<li>This system call can be used with any type of file descriptors,
namely: ordinary file descriptors; standard input from terminal,
stdin (character device); sockets; unix domain sockets; anonymous
pipes; named pipes; character device files, which often represent
hardware; and block devices which represent mounted file systems.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">len</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span>    <span class="org-variable-name">fd</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt; File descriptor          </span>
             , <span class="org-type">void</span>*  <span class="org-variable-name">buf</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt; Pointer to buffer </span>
                             <span class="org-comment-delimiter">//   </span><span class="org-comment">It can be a pointer to any POD type, plain-old data.</span>
                             <span class="org-comment-delimiter">//   </span><span class="org-comment">without any internal pointers.                                  </span>
             , <span class="org-type">size_t</span> <span class="org-variable-name">len</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt; Buffer size or length in bytes.</span>
           <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Possible Return Values</b>   
</p>

<p>
The system call wrapper function read() can return the following
results:
</p>

<ol class="org-ol">
<li>Number of bytes read, which may be less or equal to the buffer
size. The bytes read are stored in the buffer.</li>

<li>Return value: (0) indicating EOF (End-Of-File) - there is nor
more bytes to be read.</li>

<li>Return value: (-1) and <span class="underline">errno</span> set to <span class="underline">EINTR</span> indicating that
before any byte was read, a signal was set to the current
process. In this case, read() can be called again.</li>

<li>Return value: (-1) and <span class="underline">errno</span> set to <span class="underline">EAGAIN</span> with a file descriptor in
non-blocking mode. This case indicates that a read operation on
the file descriptor would block the current thread while there
is no data available.</li>

<li>Return value: (-1) in the case of failure, in this case, the
thread-local storage variable <span class="underline">errno</span> is set.</li>
</ol>

<p>
<b>Semantics of read()</b>
</p>

<ul class="org-ul">
<li>Ordinary file descriptor
<ul class="org-ul">
<li>A call to read() never blocks the current thread and returns 0
indicating (EOF) when the end of file is reached.</li>
</ul></li>

<li>STDIN_FILENO (value 0) file descriptor, which represents the
console/terminal input.
<ul class="org-ul">
<li>A call to read() blocks the current
thread while there is no bytes to be read and returns (0)
indicating EOF when the user types the (CTRL D) sequence.</li>
</ul></li>

<li>Sockets file descriptors in blocking mode (default):
<ul class="org-ul">
<li>A call to read blocks the curren thread while there is no bytes
available in the kernel-side buffer. When a read() call returns
0, it indicates that no more bytes can be read as the other
side (client or server) has closed the connection and  by
using close() or shutdown() calls.</li>
</ul></li>
</ul>

<p>
<b>Handling partial-reads</b> 
</p>

<p>
The following algorithm reads all bytes until the buffer is filled for
handling <span class="underline">partial reads</span> which can happen with socket file descriptors
in blocking mode. Example about partial read: The server-side socket
sends 1000 bytes, then the client-side socket counterpart performs a
read(fd_server, buffer, 1000) call. The number of bytes returned on
the first call may be less than the buffer size, for instance it could
be 200. Then the client-side socket would have to continue to read all
bytes until the buffer is filled. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------//</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">Inputs                                //</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------//</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer length in bytes </span>
 <span class="org-keyword">const</span> <span class="org-type">size_t</span> <span class="org-variable-name">buffer_len</span> = 400;
 <span class="org-type">char</span>  <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-1">[</span>buffer_len<span class="org-rainbow-delimiters-depth-1">]</span>;

 <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------//</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">Algorithm                             //</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------//</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Pre-condition </span>
 assert<span class="org-rainbow-delimiters-depth-1">(</span> bufffer_len &lt;= SSIZE_MAX  <span class="org-rainbow-delimiters-depth-1">)</span>;
 <span class="org-type">size_t</span>  <span class="org-variable-name">len</span>  = buffer_len;
 <span class="org-type">ssize_t</span> <span class="org-variable-name">nr</span>   = -1;
 <span class="org-type">char</span>*   <span class="org-variable-name">pbuf</span> = buffer; 

 <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Stop iterations when buffer is filled.</span>
         len != 0  
         <span class="org-comment-delimiter">// </span><span class="org-comment">Stop interations when 'nr' is EOF, there is no more bytes left </span>
         <span class="org-comment-delimiter">// </span><span class="org-comment">or the socket connection has been closed. </span>
         &amp;&amp; <span class="org-rainbow-delimiters-depth-2">(</span> nr = read<span class="org-rainbow-delimiters-depth-3">(</span>fd, pbuf, len<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> != 0 <span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ret == -1 &amp;&amp; errno == EINTR<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ret == -1<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
         perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" An error has happened, check ERRNO variable. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">break</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     len  = len - nr; 
     pbuf = pbuf + nr;
 <span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org638348e" class="outline-3">
<h3 id="org638348e"><span class="section-number-3">1.12</span> Low level IO - open(), read(), write() syscall functions</h3>
<div class="outline-text-3" id="text-1-12">
<p>
This code demonstrates the usage of the open(), read(), write(),
close() low-level IO library-calls for file descriptors which
encapsulates system-calls with the same name. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae">https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae</a></li>
</ul>

<p>
File: unix-low-level-io.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-keyword">const</span> <span class="org-type">char</span>* 
<span class="org-function-name">errno_to_cstring</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">No such file or directory </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == ENOENT<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"ENOENT"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Operation not permitted </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Onput/Output error </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EIO<span class="org-rainbow-delimiters-depth-2">)</span>    <span class="org-keyword">return</span> <span class="org-string">"EIO"</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EAGAIN<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"EAGAIN"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPIPE<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPIPE"</span>;

    <span class="org-keyword">return</span> <span class="org-string">"&lt;UNKNOWN&gt;"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>   


<span class="org-comment-delimiter">/** </span><span class="org-comment">Check whether file descriptor is regular file */</span>
<span class="org-type">bool</span> <span class="org-function-name">fd_is_regular_file</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>       
     <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
     <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> S_ISREG<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">fd_is_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
    <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> S_ISDIR<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                          <span class="org-string">"\n   =&gt;    errno(str) = %s"</span>
                          <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                          , err, errno_to_cstring<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage:                             \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read a file:                \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file &lt;FILE&gt;                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read stdin (console input): \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file -stdin                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> 0;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Compare two c-strings return 0 (zero) when they are equal.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">int strcmp(const char *s1, const char *s2)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"file"</span><span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Expected command file. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Variable for holding a file descriptor </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">The library-call open() attempts to open a file  and returns a "file-descriptor" </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(integer number ) when the operation is successful. The library-call </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">returns (-1) when the operation fails. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It encapsulates the 'open' system call. </span>
    <span class="org-comment-delimiter">//  </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"-stdin"</span><span class="org-rainbow-delimiters-depth-3">)</span> == 0<span class="org-rainbow-delimiters-depth-2">)</span>
            fd = STDIN_FILENO; 
    <span class="org-keyword">else</span> 
            fd = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Get error flag 'errno' to get more details about current error.</span>
            <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr ,<span class="org-string">" [ERROR] Failed to open file. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is regular file = %s \n"</span>
                              , fd_is_regular_file<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is directory file = %s \n"</span>
                              , fd_is_directory<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;                
    <span class="org-comment-delimiter">// </span><span class="org-comment">Flush file =&gt; Force changes to be immeditely written.</span>
    <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stdout<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer maximum size in bytes </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_MAX_SIZE</span> = 200;     
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Stream BUFFER_MAX_SIZE bytes from file descriptor </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to STDOUT_FILENO (file descriptor).</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">ret</span>; 
    <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            ret = read<span class="org-rainbow-delimiters-depth-3">(</span>fd, buffer, BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;        
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ret == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                    <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno; 
                    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] An error has happened =&gt; "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                    print_errno_details<span class="org-rainbow-delimiters-depth-4">(</span>err<span class="org-rainbow-delimiters-depth-4">)</span>;
                    close<span class="org-rainbow-delimiters-depth-4">(</span>fd<span class="org-rainbow-delimiters-depth-4">)</span>;
                    <span class="org-keyword">return</span> EXIT_FAILURE;
            <span class="org-rainbow-delimiters-depth-3">}</span>       
            ::write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, ret<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> ret != 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close the file descriptor.</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-low-level-io.cpp -o <span class="org-keyword">unix-low-level-io.bin</span> -std=c++1z -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<ul class="org-ul">
<li>Run 1</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin 
[INFO] Program started. 
<span class="org-function-name">Usage</span>:                             
 =&gt; To read a file:                
   $ ./unix-low-level-io.bin file &lt;FILE&gt;                
 =&gt; To read stdin (console input): 
   $ ./unix-low-level-io.bin file -stdin                
</pre>
</div>

<ul class="org-ul">
<li>Run 2:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-low-level-io.bin file /proc/filesystems 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
nodev   sysfs
nodev   tmpfs
nodev   bdev
nodev   proc
nodev   cgroup
nodev   cgroup2
... ... ... 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/resolv.conf 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
<span class="org-comment-delimiter"># </span><span class="org-comment">Generated by NetworkManager</span>
nameserver 194.165.12.10
</pre>
</div>

<ul class="org-ul">
<li>Run 3: (Error)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin file /etc/resosad
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 2
  =&gt;    errno(str) = ENOENT
  =&gt; errno message = No such file or directory 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/shadow
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 13
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Permission denied 

$ &gt;&gt; ./unix-low-level-io.bin file /
[INFO] Program started. 
[INFO] ?? File is regular file = FALSE 
[INFO] ?? File is directory file = TRUE 
[ERROR] An error has happened =&gt; 
  =&gt;    errno(int) = 21
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Is a directory 
</pre>
</div>

<ul class="org-ul">
<li>Run 4 - read stdin file descriptor <span class="underline">STDIN_FILENO</span></li>
</ul>

<pre class="example">
 $ &gt;&gt; ./unix-low-level-io.bin file -stdin
 [INFO] Program started. 
 [INFO] ?? File is regular file = FALSE 
 [INFO] ?? File is directory file = FALSE 


Hello world
Hello world
 Unix-linux file descriptors - Low level IO
 Unix-linux file descriptors - Low level IO

# User types Ctrl+D to close STDIN 
</pre>
</div>
</div>

<div id="outline-container-org171870a" class="outline-3">
<h3 id="org171870a"><span class="section-number-3">1.13</span> Low level IO - creat()</h3>
<div class="outline-text-3" id="text-1-13">
<p>
Creates a file using Unix-low level IO function creat() which
encapsulates the creat() system-call.
</p>

<p>
File: unix-creat.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">File is created with read, write permissions for owner </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">,groups and others</span>
    <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span> = S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = creat<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/tmp/my-sample-file.txt"</span>, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd  == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fill the whole buffer with '\0' null char characters</span>
    memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'\0'</span>, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">strcpy =&gt; Copy string literal to buffer. </span>
    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 0] Write this message to buffer\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer content = '%s' \n"</span>, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Ruires: #include &lt;string&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                              <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-creat.cpp -o <span class="org-keyword">unix-creat.bin</span> -std=c++1z -Wall -Wextra -g 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-creat.bin 
 Buffer size (non blank chars) = 39 
 Buffer size (non blank chars) = 44 
 Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span>
</pre>
</div>

<p>
Content of generated file: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; cat /tmp/my-sample-file.txt 
[LINE 0] Write this message to buffer
[LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX
[LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX
</pre>
</div>

<p>
Trace library-calls with <span class="underline">ltrace</span> application: 
</p>

<ul class="org-ul">
<li>$ ltrace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ltrace ./unix-creat.bin

<span class="org-function-name">_ZNSt8ios_base4InitC1Ev</span>(0x4040a9, 0xffff, 0x7ffcfe326598, 224) = 0
<span class="org-function-name">__cxa_atexit</span>(0x4010e0, 0x4040a9, 0x402008, 6)                  = 0
<span class="org-function-name">creat</span>(0x402010, 420, 0x7ffcfe326598, 256)                      = 3
<span class="org-function-name">memset</span>(0x7ffcfe326280, <span class="org-string">'\0'</span>, 500)                              = 0x7ffcfe326280
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 39 Buffer size (non blank chars) = 39 
) = 37
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39)            = 39
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 44 Buffer size (non blank chars) = 44 
) = 37
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer content = '%s' \n"</span>, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>... Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span> 
) = 66
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44)            = 44
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>...)                  = 50
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50)            = 50
<span class="org-function-name">close</span>(3)                                                       = 0
<span class="org-function-name">_ZNSt8ios_base4InitD1Ev</span>(0x4040a9, 0, 0x4010e0, 1)              = 0x7f95f2965e40
+++ exited (status 0) +++

</pre>
</div>

<p>
Trace system-calls with <span class="underline">strace</span> application: 
</p>

<ul class="org-ul">
<li>$ strace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ strace ./unix-creat.bin 

<span class="org-function-name">execve</span>(<span class="org-string">"./unix-creat.bin"</span>, [<span class="org-string">"./unix-creat.bin"</span>], 0x7fff489b8e40 /* 83 vars */) = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">arch_prctl</span>(0x3001 /* ARCH_??? */, 0x7fff751bd910) = -1 EINVAL (Invalid argument)
<span class="org-function-name">access</span>(<span class="org-string">"/etc/ld.so.preload"</span>, R_OK)      = -1 ENOENT (No such file or directory)
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...

<span class="org-function-name">mprotect</span>(0x7fed4e032000, 4096, PROT_READ) = 0
<span class="org-function-name">munmap</span>(0x7fed4dfe4000, 136250)          = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">brk</span>(0x59d000)                           = 0x59d000
<span class="org-function-name">creat</span>(<span class="org-string">"/tmp/my-sample-file.txt"</span>, 0644)  = 3
<span class="org-function-name">fstat</span>(1, {<span class="org-variable-name">st_mode</span>=S_IFCHR|0620, <span class="org-variable-name">st_rdev</span>=makedev(0x88, 0xc), ...}) = 0
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39) = 39
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer content = ' [LINE 1] Uni"</span>..., 63) = 63
<span class="org-function-name">write</span>(1, <span class="org-string">"' \n"</span>, 3)                     = 3
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44) = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50) = 50
<span class="org-function-name">close</span>(3)                                = 0
<span class="org-function-name">exit_group</span>(0)                           = ?
+++ exited with 0 +++
</pre>
</div>
</div>
</div>

<div id="outline-container-org7a84944" class="outline-3">
<h3 id="org7a84944"><span class="section-number-3">1.14</span> Reading/Listings directory contents</h3>
<div class="outline-text-3" id="text-1-14">
<p>
API Documentations: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man3/opendir.3.html">Linux Manpage - opendir()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=opendir&amp;sektion=3">FreeBSD manpage - opendir()</a></li>

<li><a href="https://www.man7.org/linux/man-pages/man3/readdir.3.html">Linux manpage - readdir()</a></li>
</ul>

<p>
Functions used: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DIR</span> *<span class="org-function-name">opendir</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">readdir</span><span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">fd</span>
             , <span class="org-keyword">struct</span> <span class="org-type">old_linux_dirent</span>* <span class="org-variable-name">dirp</span>,
             , <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
File: unix-readdir.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;string&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dirent.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Get function opendir</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">errno.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Callback</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">iterate_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">Callback</span>&amp;&amp; <span class="org-variable-name">callback</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DIR</span> *<span class="org-variable-name">dir</span>;
    <span class="org-keyword">struct</span> <span class="org-type">dirent</span> *<span class="org-variable-name">dp</span>;

    dir = opendir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> ;

    <span class="org-comment-delimiter">// </span><span class="org-comment">To determine the cause of error - It is necessary to check the error code.</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>dir == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: Cannot read directory"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>dp = readdir<span class="org-rainbow-delimiters-depth-4">(</span>dir<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>path == <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-3">)</span>
            callback<span class="org-rainbow-delimiters-depth-3">(</span>dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">else</span> 
            callback<span class="org-rainbow-delimiters-depth-3">(</span>path + <span class="org-string">"/"</span> + dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;      
    <span class="org-rainbow-delimiters-depth-2">}</span>;
    closedir<span class="org-rainbow-delimiters-depth-2">(</span>dir<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" List directory contents "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Usage: ./unix-readdir &lt;DIRECTORY&gt;"</span> &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-type">int</span> <span class="org-variable-name">idx</span> = 0;
     iterate_directory<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">idx</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">)</span>
     <span class="org-rainbow-delimiters-depth-3">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; idx++  &lt;&lt; <span class="org-string">"] path =&gt; "</span> &lt;&lt; path &lt;&lt; <span class="org-string">"\n"</span>;
     <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Building on Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-readdir.cpp -o <span class="org-keyword">unix-readdir.bin</span> -std=c++1z -g -Wall -Wextra 
</pre>
</div>

<p>
Building on MacOSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Note: It is not (GNU GCC), g++ command refers to CLang </span>
$ g++ unix-readdir.cpp -o <span class="org-keyword">unix-readdir.bin</span> -std=c++1z -g -Wall -Wextra 

<span class="org-comment-delimiter"># </span><span class="org-comment">Same as previous command (CLang compiler)</span>
$ clang++ unix-readdir.cpp -o <span class="org-keyword">unix-readdir.bin</span> -std=c++1z -g -Wall -Wextra 

$ file unix-readdir.bin 
<span class="org-function-name">unix-readdir.bin</span>: Mach-O 64-bit executable x86_64

$ du -h unix-readdir.bin
 44K    unix-readdir.bin

<span class="org-comment-delimiter"># </span><span class="org-comment">List shared libraries dependencies: </span>
$ otool -L unix-readdir.bin 
<span class="org-function-name">unix-readdir.bin</span>:
        /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 902.1.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.100.1)
</pre>
</div>


<p>
Running on Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-readdir.bin /
 List directory contents 
  [0] path =&gt; srv
  [1] path =&gt; sys
  [2] path =&gt; ..
  [3] path =&gt; opt
  [4] path =&gt; .
  [5] path =&gt; run
  [6] path =&gt; media
  ... ... ... 
  ... .. .... ... ... 

 $ &gt;&gt; ./unix-readdir.bin /boot 
 List directory contents 
  [0] path =&gt; /boot/..
  [1] path =&gt; /boot/.
  [2] path =&gt; /boot/initramfs-5.6.12-300.fc32.x86_64.img
  [3] path =&gt; /boot/grub2
  [4] path =&gt; /boot/vmlinuz-0-rescue-a1ac43b933e24659bba5edf2b9cec1e1
    ... ... ...     ... ... ...     ... ... ...     ... ... ...     
</pre>
</div>

<p>
Running on MacOSX Catalina VM: 
</p>

<ul class="org-ul">
<li>Note: on MacOSX, the command g++ is not GCC, it refers to Clang.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">./unix-readdir /
 List directory contents 
  [0] path =&gt; .
  [1] path =&gt; ..
  [2] path =&gt; home
  [3] path =&gt; usr
  [4] path =&gt; .DS_Store
  [5] path =&gt; bin
  [6] path =&gt; sbin
  [7] path =&gt; .file
  [8] path =&gt; etc
  [9] path =&gt; var
  [10] path =&gt; Library
  [11] path =&gt; System
  [12] path =&gt; .VolumeIcon.icns
  [13] path =&gt; .fseventsd
  [14] path =&gt; private
  [15] path =&gt; .vol
  [16] path =&gt; Users
  [17] path =&gt; Applications
  [18] path =&gt; opt
  [19] path =&gt; dev
  [20] path =&gt; Volumes
  [21] path =&gt; tmp
  [22] path =&gt; cores

 ./unix-readdir /Applications/iTerm.app/Contents
  List directory contents 
   [0] path =&gt; /Applications/iTerm.app/Contents/.
   [1] path =&gt; /Applications/iTerm.app/Contents/..
   [2] path =&gt; /Applications/iTerm.app/Contents/CodeResources
   [3] path =&gt; /Applications/iTerm.app/Contents/_CodeSignature
   [4] path =&gt; /Applications/iTerm.app/Contents/MacOS
   [5] path =&gt; /Applications/iTerm.app/Contents/Resources
   [6] path =&gt; /Applications/iTerm.app/Contents/XPCServices
   [7] path =&gt; /Applications/iTerm.app/Contents/Frameworks
   [8] path =&gt; /Applications/iTerm.app/Contents/Info.plist
   [9] path =&gt; /Applications/iTerm.app/Contents/PkgInfo
</pre>
</div>
</div>
</div>
<div id="outline-container-orge522a69" class="outline-3">
<h3 id="orge522a69"><span class="section-number-3">1.15</span> Process Inputs, Outputs and States and PROCFS on Linux</h3>
<div class="outline-text-3" id="text-1-15">
<p>
Any process may have the following inputs, outputs and states: 
</p>

<p>
<b>Some Processes States:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Native executable</span> used for creating the process. Every
process has a native executable. A python process is the Python
interpreter (python.exe on Windows) running python scripts. A Java
process is the Java virtual machine (java.exe) running java
*.class bytecodes or *.jar java packages.</li>

<li><span class="underline">CWD</span> =&gt; Current Working Directory
<ul class="org-ul">
<li>There is a single current working directory for every
process. On Unix, the functions <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/getcwd.html">getcwd()</a> and <a href="http://man7.org/linux/man-pages/man2/chdir.2.html">chdir()</a> gets and
sets the current working directory.</li>
</ul></li>

<li><span class="underline">IP</span> =&gt; Instruction Pointer (process context) =&gt; CPU registry that
stores the current machine instruction to be run.</li>

<li><span class="underline">SP</span> =&gt; Stack Poitner (process context) =&gt; CPU registry used for
keeping track of the process call stack.</li>

<li>Note: all thoses states can be viewed and manipulated with a
debugger, such as GDB, LLDB or Windows Debugger. A debugger can
monitor, explore and manipulate the virtual memory of any process.</li>
</ul>

<p>
<b>Inputs:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Stdin</span> (Standard Input) =&gt; User input read from console in some
shell (cmd.exe on Windows) or bash, zsh on Unix-like OSes.</li>

<li>Command line argument passed to main function</li>

<li>Environment variables set during the process instantiation with env
or export commands on Unix-like operating systems.</li>

<li>Configuration files =&gt; read at a default fixed location such as
<code>/.bashrc (bash configuration file at ~/home/user/.bashrc/</code> on Linux
); ~/.vimrc (vim configuration file)</li>

<li>Windows Registry entry for configuration during process
initialization</li>

<li>Input files read after initialization.</li>
</ul>

<p>
<b>Outputs:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Stdout</span> (Standard Output) =&gt; Process output print by functions such
as printf; std::cout &lt;&lt; &#x2026; visible in a terminal. (Unix heritage)</li>

<li><span class="underline">Stderr</span> (Standard Error Ouput) =&gt; Process error or logging output
print by default in a terminal. stderr exists for allowing
separating the output (stdout) from the error or logging output (stderr).</li>

<li>Statuds code =&gt; Value returned by function <span class="underline">int main(int argc, char** argv)</span>
<ul class="org-ul">
<li>Value 0 indicates success and that the process terminated
successfuly.</li>
<li>Value different than zero indicates that the process terminated
with errors.</li>
</ul></li>

<li>Output file(s)</li>
</ul>

<p>
<b>Both Input/Output:</b>
</p>

<ul class="org-ul">
<li>Sockets</li>

<li>IPC Inter Process Communication</li>

<li>GUI - Graphical User Interface</li>
</ul>


<div class="org-src-container">
<pre class="src src-text">         Command line arguments            
         int arc, char** argv (input)                  Configuration file: 
           &gt;&gt;-------+                         +--&lt;&lt;--  Input file read at fixed location
                     \                       /         Or Windows Registry entry 
                      \                      |
                      |                      |    
                      \/                    \ /   
                     +---------------------------------+
                     |   Process:                      |      
                     |                                 +---------&gt;&gt; Stdout (output)
         ----------&gt;&gt;|     EXE = /bin/some/executable  |            
       Stdin (input) |     PID = 9381 (Unique ID)      +---------&gt;&gt; Stderr (output)
                     |     CWD = /home/user/some/data  |       
                     |                                 |
                     |     IP - Instruction Pointer    +---------&gt;&gt;&gt; Process status code: (output)
         ----------&gt;&gt;|     SP - Stack pointer          |    
Environment          +-----------------------+--------+    int main(int argc, char** argv)
Variables (input)                            |              {
                                             |                  .... ... ...
export PATH=$PATH:/opt/bin/program/bin       |                  int status_code = 0 
export APP_LOG_LEVEL=INFO                    |                  return status_code;
                                            \ /              }
                                      Output File 
</pre>
</div>

<p>
<b>Example: View Process Information on Linux</b> 
</p>

<p>
All mentioned process internal states can be viewed with a debugger
such as GDB (GNU Debugger). On Linux, they can also be accessed with
the <b>/proc</b> pseudo-file system created by the Linux kernel which exposes
many processes informations. 
</p>

<p>
Example: View information about the process which the PID is <b>19529</b> 
</p>

<ul class="org-ul">
<li>Start a Kotlin REPL process and get a PID:</li>
</ul>

<div class="org-src-container">
<pre class="src src-java">$ kotlinc-jvm
Welcome to Kotlin version 1.3.50 <span class="org-rainbow-delimiters-depth-1">(</span>JRE 1.8.0_162-b12<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-function-name">Type</span> :help <span class="org-keyword">for</span> help, :quit <span class="org-keyword">for</span> quit
&gt;&gt;&gt; 
&gt;&gt;&gt; <span class="org-constant">java</span>.<span class="org-constant">lang</span>.<span class="org-constant">management</span>.ManagementFactory.getRuntimeMXBean<span class="org-rainbow-delimiters-depth-1">()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-function-name">res1</span>: <span class="org-constant">kotlin</span>.String<span class="org-negation-char">!</span> = 23127@localhost.localdomain
&gt;&gt;&gt; 
</pre>
</div>

<ul class="org-ul">
<li>Proc-File system for PID <span class="underline">23127</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls /proc/23127
attr/       cmdline          loginuid       personality   statm
fd/         comm             maps           projid_map    status
fdinfo/     coredump_filter  mem            root@         syscall
map_files/  cpuset           mountinfo      sched         timers
net/        cwd@             mounts         schedstat     timerslack_ns
ns/         environ          mountstats     sessionid     uid_map
task/       exe@             numa_maps      setgroups     wchan
autogroup   gid_map          oom_adj        smaps
auxv        io               oom_score      smaps_rollup
cgroup      latency          oom_score_adj  stack
clear_refs  limits           pagemap        stat
</pre>
</div>

<ul class="org-ul">
<li>Get process executable: 
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/exe</span> is a symbolic link to the process' native executable.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ readlink /proc/23127/exe 
/home/archbox/opt/java/bin/java
</pre>
</div>

<ul class="org-ul">
<li>Get process current directory:
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/cwd</span> is a symbolic link to process' current directory.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ readlink /proc/23127/cwd
/home/archbox/projects/appdroid/build
</pre>
</div>

<ul class="org-ul">
<li>Get command line arguments used to start the process.
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/cmdline</span> contains the command line arguments
used to start the process, passed to main(int argc, char** argv).</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/cmdline | strings -1

/home/archbox/opt/java/bin/java
-Xmx256M
-Xms32M
-noverify
-cp
/home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-preloader.jar
org.jetbrains.kotlin.preloading.Preloader
-cp
/home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-compiler.jar
org.jetbrains.kotlin.cli.jvm.K2JVMCompiler
</pre>
</div>

<ul class="org-ul">
<li>Get process environment variables.
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/environ</span> contains process' environment
variables.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/environ | strings -1

<span class="org-variable-name">QTINC</span>=/usr/lib64/qt-3.3/include
<span class="org-variable-name">LC_ALL</span>=en_US.UTF-8
...    ...    ...    ...    ... 
...    ...    ...    ...    ... 
<span class="org-variable-name">USERNAME</span>=archbox
<span class="org-variable-name">JAVA_HOME</span>=/home/archbox/opt/java
<span class="org-variable-name">KDEDIRS</span>=/usr
<span class="org-variable-name">KOTLIN_HOME</span>=/home/archbox/.sdkman/candidates/kotlin/1.3.50
<span class="org-variable-name">XDG_VTNR</span>=2
<span class="org-variable-name">SSH_AUTH_SOCK</span>=/tmp/ssh-7z2L0gyqQeeP/agent.3961
<span class="org-variable-name">ROOTSYS</span>=/home/archbox/opt/root
<span class="org-variable-name">XDG_SESSION_ID</span>=2
<span class="org-variable-name">MODULES_CMD</span>=/usr/share/Modules/libexec/modulecmd.tcl
<span class="org-variable-name">ENV</span>=/usr/share/Modules/init/profile.sh
<span class="org-variable-name">DESKTOP_SESSION</span>=lxqt
<span class="org-variable-name">IMSETTINGS_MODULE</span>=none
<span class="org-variable-name">PWD</span>=/home/archbox/projects/appdroid/build
</pre>
</div>

<ul class="org-ul">
<li>List all process' file descriptors.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls /proc/23127/fd
0@  10@  12@  14@  16@  18@  2@   21@  24@  28@  3@   31@  4@  6@  8@
1@  11@  13@  15@  17@  19@  20@  22@  27@  29@  30@  33@  5@  7@  9@

$ ls -l /proc/23127/fd
total 0
lrwx------ 1 archbox archbox 64 Nov  4 12:11 0 -&gt; /dev/pts/4
lrwx------ 1 archbox archbox 64 Nov  4 12:11 1 -&gt; /dev/pts/4
lr-x------ 1 archbox archbox 64 Nov  4 12:11 10 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-script-runtime.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 11 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/trove4j.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 12 -&gt; /home/archbox/opt/java/jre/lib/jsse.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 13 -&gt; /dev/random
lr-x------ 1 archbox archbox 64 Nov  4 12:11 14 -&gt; /dev/urandom
... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... 
lr-x------ 1 archbox archbox 64 Nov  4 12:11 8 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-stdlib.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 9 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-reflect.jar
</pre>
</div>

<ul class="org-ul">
<li>List shared libraries loaded by process: <a href="https://stackoverflow.com/questions/5103443/how-to-check-what-shared-libraries-are-loaded-at-run-time-for-a-given-process">(Reference 5103443)</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/maps | awk <span class="org-string">'{print $6}'</span> | grep <span class="org-string">'\.so'</span> | sort | uniq

/home/archbox/opt/java/jre/lib/amd64/libjava.so
/home/archbox/opt/java/jre/lib/amd64/libmanagement.so
...    ...    ...    ...    ...    ... 
...    ...    ...    ...    ...    ... 
/usr/lib64/libc-2.27.so
/usr/lib64/libdl-2.27.so
/usr/lib64/libm-2.27.so
/usr/lib64/libnss_files-2.27.so
/usr/lib64/libpthread-2.27.so
/usr/lib64/librt-2.27.so
/usr/lib64/libutil-2.27.so
</pre>
</div>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5) - Linux manual page</a></li>

<li><a href="https://www.tecmint.com/exploring-proc-file-system-in-linux/">Exploring /proc File System in Linux</a></li>

<li><a href="https://www.geeksforgeeks.org/proc-file-system-linux/">proc file system in Linux - GeeksforGeeks</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga0452c5" class="outline-3">
<h3 id="orga0452c5"><span class="section-number-3">1.16</span> Information about file permissions, owner and group - fstat and stat syscalls</h3>
<div class="outline-text-3" id="text-1-16">
</div>
<div id="outline-container-org01493b8" class="outline-4">
<h4 id="org01493b8"><span class="section-number-4">1.16.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-16-1">
<p>
The following family of common UNIX functions allows obtaining
information about file permissions, owner, group and stick bits,
namely, set-uid and set-gid special bits. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file path </span>
<span class="org-type">int</span> <span class="org-function-name">stat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> * <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span>* <span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file path </span>
<span class="org-type">int</span> <span class="org-function-name">lstat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span>* <span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file-descriptor </span>
<span class="org-type">int</span> <span class="org-function-name">fstat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span> *<span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">fstatat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span> *<span class="org-variable-name">sb</span>, <span class="org-type">int</span> <span class="org-variable-name">flag</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Fstat manpage: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">dev_t</span>     <span class="org-variable-name">st_dev</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">ID of device containing file */</span>
    <span class="org-type">ino_t</span>     <span class="org-variable-name">st_ino</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">Inode number */</span>
    <span class="org-type">mode_t</span>    <span class="org-variable-name">st_mode</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">File type and mode */</span>
    <span class="org-type">nlink_t</span>   <span class="org-variable-name">st_nlink</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">Number of hard links */</span>
    <span class="org-type">uid_t</span>     <span class="org-variable-name">st_uid</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">User ID of owner */</span>
    <span class="org-type">gid_t</span>     <span class="org-variable-name">st_gid</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">Group ID of owner */</span>
    <span class="org-type">dev_t</span>     <span class="org-variable-name">st_rdev</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">Device ID (if special file) */</span>
    <span class="org-type">off_t</span>     <span class="org-variable-name">st_size</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">Total size, in bytes */</span>
    <span class="org-type">blksize_t</span> <span class="org-variable-name">st_blksize</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">Block size for filesystem I/O */</span>
    <span class="org-type">blkcnt_t</span>  <span class="org-variable-name">st_blocks</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">Number of 512B blocks allocated */</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Since Linux 2.6, the kernel supports nanosecond</span>
<span class="org-comment">       precision for the following timestamp fields.</span>
<span class="org-comment">       For the details before Linux 2.6, see NOTES. */</span>

    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_atim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last access */</span>
    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_mtim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last modification */</span>
    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_ctim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last status change */</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_atime</span> st_atim.tv_sec      <span class="org-comment-delimiter">/* </span><span class="org-comment">Backward compatibility */</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_mtime</span> st_mtim.tv_sec
<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_ctime</span> st_ctim.tv_sec
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="https://www.liquidweb.com/kb/how-do-i-set-up-setuid-setgid-and-sticky-bits-on-linux/">How Do I Set Up Setuid, Setgid, and Sticky Bits on Linux? | Liquid Web</a></li>
</ul>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/2/fstat">Linux Manpage - fstat</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=stat&amp;sektion=2">FreeBSD sytem calls - stat, lstat, fstat - Get file status</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/getgrgid.3p.html">Linux Manpage - getgrgid()</a> - Query /etc/group database</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getgrgid">FreeBSD - getgrid()</a> - Query /etc/group database.</li>

<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/getpwuid.html">OpenGroup - Unix Specification  - getpwuid()</a></li>
</ul>
</div>
</div>
<div id="outline-container-org65cbf08" class="outline-4">
<h4 id="org65cbf08"><span class="section-number-4">1.16.2</span> Sample code</h4>
<div class="outline-text-4" id="text-1-16-2">
<p>
<b>File:</b> file-info.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">-- Unix-specific Headers -------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">pwd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">grp.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-function-name">std</span>::string 
get_descriptor_type<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">fs</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">ftype</span> = fs.st_mode &amp; S_IFMT;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFDIR<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Directory"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFREG<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Regular file"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFLNK<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Symbolic link"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFBLK<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Block device file"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFCHR<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Character device file"</span>;    
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFIFO<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"FIFO or pipe"</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFSOCK<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"Socket"</span>;
    <span class="org-keyword">return</span> <span class="org-string">"Unknown"</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>; 

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc != 2<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Usage: %s &lt;FILE&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> 0;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fs</span>; 
    <span class="org-keyword">struct</span> <span class="org-type">passwd</span>* <span class="org-variable-name">fs_user</span> = <span class="org-constant">nullptr</span>; 
    <span class="org-keyword">struct</span> <span class="org-type">group</span>*  <span class="org-variable-name">fs_group</span> = <span class="org-constant">nullptr</span>;


    <span class="org-comment-delimiter">//</span><span class="org-comment">int fd = open(argv[1], O_RDONLY);</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::stat<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;fs <span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to open file =&gt; error = %s \n"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>errno<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span> fs_user = ::getpwuid<span class="org-rainbow-delimiters-depth-4">(</span>fs.st_uid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get owner information \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span> fs_group = ::getgrgid<span class="org-rainbow-delimiters-depth-4">(</span>fs.st_gid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get group information \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Print boolean as 'true' or 'false'</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in bytes: "</span> &lt;&lt; fs.st_size &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in Kilo bytes: "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>fs.st_size<span class="org-rainbow-delimiters-depth-2">)</span> / 1024 &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in Mega bytes: "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>fs.st_size<span class="org-rainbow-delimiters-depth-2">)</span> / <span class="org-rainbow-delimiters-depth-2">(</span>1024 * 1024<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]           File type: "</span> &lt;&lt; get_descriptor_type<span class="org-rainbow-delimiters-depth-2">(</span>fs<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n TEST FILE TYPE \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?      Is regular file =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISREG<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?         Is directory =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISDIR<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?     Is symbolic link =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISLNK<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?     Is block device  =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISBLK<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ? Is character device  =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISCHR<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ACCESS TIME \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt;   last change: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_ctime<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt;   last access: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_atime<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt; last modified: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_mtime<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt;  <span class="org-string">"\n OWNER and GROUP \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Owner: uid = "</span> &lt;&lt; fs.st_uid &lt;&lt; <span class="org-string">" ;  user = "</span> &lt;&lt; fs_user-&gt;pw_name  &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Group: gid = "</span> &lt;&lt; fs.st_gid &lt;&lt; <span class="org-string">" ; group = "</span> &lt;&lt; fs_group-&gt;gr_name  &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n FILE PERMISSIONS \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Stick Bits: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_ISUID ? <span class="org-string">"suid"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span> 
              &lt;&lt; <span class="org-string">"  "</span>                  &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_ISGID ? <span class="org-string">"sgid"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Owner: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IRUSR  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">File is readable   (can be read)</span>
              &lt;&lt; <span class="org-string">" "</span>         &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWUSR  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">File is writeable  (can be written)</span>
              &lt;&lt; <span class="org-string">" "</span>         &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXUSR  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">File is executable (can be executed - execv syscall)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Group: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IRGRP  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>            &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWGRP  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>            &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXGRP  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt; Others: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IROTH  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>             &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWOTH  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>             &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXOTH  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;    
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" \n- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) \n"</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Build using GNU GCC (G++) compiler </span>
$ g++ file-info.cpp -o <span class="org-keyword">file-info</span> -std=c++1z -g -Wall -Wextra

<span class="org-comment-delimiter"># </span><span class="org-comment">Build using LLVM/Clang compiler </span>
$ clang++ file-info.cpp -o <span class="org-keyword">file-info</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<ul class="org-ul">
<li>Inspect directory /etc</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /etc
  [*]  File size<span class="org-keyword"> in</span> bytes: 12288
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 12
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0.0117188
  [*]           File type: Directory

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; true
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Sun Aug  2 05:19:31 2020
  [*] Time =&gt;   last access: Wed Aug  5 04:50:20 2020
  [*] Time =&gt; last modified: Sun Aug  2 05:19:31 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 0 ; group = root

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w x
  =&gt;&gt;  Group: r - x
  =&gt;&gt; Others: r - x

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect executable file: /bin/sudo</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /bin/sudo
  [*]  File size<span class="org-keyword"> in</span> bytes: 182456
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 178.18
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0.174004
  [*]           File type: Regular file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; true
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Tue May 12 01:52:08 2020
  [*] Time =&gt;   last access: Sun Aug  2 05:20:57 2020
  [*] Time =&gt; last modified: Fri Mar 27 05:50:36 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 0 ; group = root

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: suid  -
  =&gt;&gt;  Owner: - - x
  =&gt;&gt;  Group: - - x
  =&gt;&gt; Others: - - x

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect regular file: ~/bin/fserver.jsh</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info ~/bin/fserver.jsh 
  [*]  File size<span class="org-keyword"> in</span> bytes: 9968346
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 9734.71
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 9.50656
  [*]           File type: Regular file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; true
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Tue May 12 12:35:32 2020
  [*] Time =&gt;   last access: Tue Aug  4 03:21:06 2020
  [*] Time =&gt; last modified: Mon May 11 22:52:14 2020

 OWNER and GROUP 
  [*] Owner: uid = 1000 ;  user = myuser 
  [*] Group: gid = 1000 ; group = myuser 

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w x
  =&gt;&gt;  Group: r w -
  =&gt;&gt; Others: r - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect block <span class="underline">device file</span> /dev/sda that represets the main disk
partition.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /dev/sda
  [*]  File size<span class="org-keyword"> in</span> bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0
  [*]           File type: Block device file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; true
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Wed Jul  8 13:48:48 2020
  [*] Time =&gt;   last access: Wed Jul  8 13:49:09 2020
  [*] Time =&gt; last modified: Wed Jul  8 13:48:48 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 6 ; group = disk

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w -
  =&gt;&gt;  Group: r w -
  =&gt;&gt; Others: - - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 

</pre>
</div>

<ul class="org-ul">
<li>Inspect character <span class="underline">device file</span>  /dev/mem that represents the
physical memory (RAM memory).</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /dev/mem
  [*]  File size<span class="org-keyword"> in</span> bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0
  [*]           File type: Character device file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; true

 ACCESS TIME 
  [*] Time =&gt;   last change: Wed Jul  8 13:48:49 2020
  [*] Time =&gt;   last access: Wed Jul  8 13:48:49 2020
  [*] Time =&gt; last modified: Wed Jul  8 13:48:49 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 9 ; group = kmem

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w -
  =&gt;&gt;  Group: r - -
  =&gt;&gt; Others: - - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7ca3572" class="outline-3">
<h3 id="org7ca3572"><span class="section-number-3">1.17</span> Information about current process</h3>
<div class="outline-text-3" id="text-1-17">
<p>
File: current-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">PATH_MAX constant (macro)</span>

<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Unique process ID (identifier) number </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">PID for parent process</span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getppid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"\n Change the curren directory to /etc \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    set_cwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It only works on Linux. The directory /proc/self is a pseudo-directory </span>
    <span class="org-comment-delimiter">//       </span><span class="org-comment">whith pseudo-files containing information about the current process. </span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">the file /proc/self/exe is a symbolic link to the current executable.</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_file</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/exe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Absolute Path of current executable = %s \n"</span>, exe_file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_dir</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/cwd"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Current directory of this executable = %s \n"</span>, exe_dir.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] Finish Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Functions Implementations ------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Get current working directory of current process */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>* <span class="org-variable-name">buffer</span> = ::getcwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">cwd</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note buffer was allocated with malloc </span>
    free<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> cwd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Set current working directory for current process. */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = ::chdir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>status &lt; 0<span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Failed to change directory."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Read value of symbolic link </span>
<span class="org-comment"> *  </span>
<span class="org-comment"> * Requires: &lt;limits.h&gt;, &lt;sys/types.h&gt;, &lt;sys/stats.h&gt;</span>
<span class="org-comment"> */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: %s \n"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>errno<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to read symlink. Check 'errno' variable"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ current-process.cpp -o <span class="org-keyword">current-process.elf</span> -Wall -Wextra -ggdb
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./current-process.elf 
  =&gt; Process PID = 719155 
  =&gt; Process PID = 678179 
  =&gt; Current directory = /home/mxpkf8/temp-projects/unix-explore 

Change the curren directory to /etc 
  =&gt; Current directory = /etc 
 =&gt; Absolute Path of current executable = /home/mxpkf8/temp-projects/unix-explore/current-process.elf 
 =&gt; Current directory of this executable = /etc 
[INFO] Finish Ok.
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ed645a" class="outline-3">
<h3 id="org6ed645a"><span class="section-number-3">1.18</span> Dynamic Loading Shared Libraries / dlopen() API</h3>
<div class="outline-text-3" id="text-1-18">
</div>
<div id="outline-container-orgb660424" class="outline-4">
<h4 id="orgb660424"><span class="section-number-4">1.18.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-18-1">
<p>
The dlopen API provide access to the <span class="underline">dynamic linker</span> services allowing
the current process to load and unload shared objects or shared
libraries in its address space (virtual memory).
</p>

<p>
This API for loading shared libraries is not only available on Linux,
it also can be found in FreeBSD, NetBSD, MacOSX, Android and so on.
</p>

<p>
Use cases: 
</p>

<ul class="org-ul">
<li>Load new code at-runtime</li>

<li>Load third-party code a runtime</li>

<li>Plugin systems, extensions or addons.</li>

<li>Load native code extensions in languages with interpreters written
in C, such as Python, Ruby, Lua and so on. Note: Python native
extensions are shared libraries.</li>
</ul>

<p>
The Dlopen() API is available on most Unix-like operating systems,
such as: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>MacOSX</li>
<li>FreeBDS</li>
<li>NetBSD</li>
<li>OpenBSD</li>
<li>QNX</li>
</ul>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="http://gnu.wiki/man3/dlopen.3.php">http://gnu.wiki/man3/dlopen.3.php</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/dlopen.3.html">Dlopen API - Linux Manpages</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dlopen&amp;apropos=0&amp;sektion=0&amp;manpath=SuSE+Linux%2Fi386+7.3&amp;format=html">Free BSD - dlopen API documentation</a></li>

<li><a href="https://docs.oracle.com/cd/E19048-01/chorus5/806-7014/6jftsjfdq/index.html">Dlopen - Oracle Documentation</a></li>

<li><a href="http://www.qnx.com/developers/docs/6.5.0SP1.update/com.qnx.doc.neutrino_lib_ref/d/dlopen.html">Dlopen - QNX documentation</a></li>

<li><a href="https://dwheeler.com/program-library/Program-Library-HOWTO/x172.html">Dynamically Loaded (DL) Libraries</a></li>
</ul>


<p>
Further Reading: 
</p>

<ul class="org-ul">
<li><a href="https://cseweb.ucsd.edu/~gbournou/CSE131/the_inside_story_on_shared_libraries_and_dynamic_loading.pdf">Inside the history on shared libraries and dynamic loading</a></li>

<li><a href="https://hackaday.com/2018/07/12/its-all-in-the-libs-building-a-plugin-system-using-dynamic-loading/">It 's all in the libs - Building a Plugin system using Dynamic Loading</a></li>

<li><a href="http://docencia.ac.upc.edu/FIB/USO/Bibliografia/unix-c-libraries.html">Building And Using Static And Shared "C" Libraries</a></li>

<li><a href="https://www.informit.com/articles/article.aspx?p=22435">More Shared Libraries-Dynamic Loading and Unloading</a></li>

<li><a href="https://grugq.github.io/docs/subversiveld.pdf">https://grugq.github.io/docs/subversiveld.pdf</a></li>

<li><a href="https://github.com/mgood7123/universal-dynamic-loader">universal-dynamic-loader</a> for Linux - "min-dl: minimal dynamic linker implementation"</li>
</ul>


<p>
Headers and libraries: 
</p>

<ul class="org-ul">
<li>Header:  #include &lt;dlfcn.h&gt;</li>
<li>Linking: (-ldl) flag</li>
</ul>

<p>
<span class="underline">Function dlopen()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlopen</li>
<li>Loads a shared library and returns a <span class="underline">handle</span> or <span class="underline">opaque pointer</span>
casted as void pointer. The term <span class="underline">opaque</span> means that the
implementation is hidden and the pointer is only meant to be
passed around to other functions.</li>
<li>Note: When this function fails, it returns null pointer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlsym</li>
<li>Obtains address of a shared library symbol from <span class="underline">handle</span> (from
dlopen).</li>
<li>Params:
<ul class="org-ul">
<li>handle =&gt; Shared library handle obtained from <span class="underline">dlopen</span></li>
<li>symbol  =&gt; Name of symbol to be loaded.</li>
</ul></li>
<li>Return:
<ul class="org-ul">
<li>Address of symbol casted as void*. It can be a function-pointer
or a pointer to global variable. If the symbol is not found, the
function returns a null pointer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlvsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlvsym
<ul class="org-ul">
<li>Loads a specific version of a symbol.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlclose()</span>: 
</p>

<ul class="org-ul">
<li>Doc: $ man dlclose()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlerror()</span> 
</p>
<ul class="org-ul">
<li>Obtaines error messages from dlopen API.</li>
<li>Doc: $ man dlerror()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">dlerror</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Simplified type signatures with a C++-friendly notation</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">HND</span>  <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>   <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>  <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Usage example</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">void</span> <span class="org-function-name">load_library</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Load shared library </span>
    <span class="org-type">HND</span> <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/path/to/shared-library.so"</span>, RTLD_LAZY | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [ERROR] "</span> &lt;&lt; dlerror<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to load shared library"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load symbol </span>
    <span class="org-type">SYM</span> <span class="org-variable-name">hsym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"name_of_function"</span><span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">if(!hsym)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hsym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: symbol not found"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in modern C++ </span>
    <span class="org-comment-delimiter">//  </span><span class="org-comment">=&gt; Note: The function to be loaded can only have C-linkage. </span>
    <span class="org-keyword">using</span> <span class="org-type">name_of_function_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in old C++ (C++98)</span>
    <span class="org-keyword">typedef</span> <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;       

    <span class="org-keyword">auto</span> <span class="org-variable-name">name_of_function_ptr</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call loaded function (Function pointer)</span>
    name_of_function_ptr<span class="org-rainbow-delimiters-depth-2">(</span>100, 2.51, <span class="org-string">"string"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unload shared library </span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org515d9dc" class="outline-4">
<h4 id="org515d9dc"><span class="section-number-4">1.18.2</span> GTK3/GTK2 GUI using dynamic loading - low level</h4>
<div class="outline-text-4" id="text-1-18-2">
<p>
The following sample code is a GTk3 or GTK2 GUI graphical user
interface application with GTK functions loaded from a GTK shared
library, without any compile-time linking. The advantage of this
approach is the greater portability across different versions of GTk
and the ability to switch between GT3 and GT2.
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf">https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf</a></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-sample)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

       <span class="org-function-name">add_executable</span>( gtk-dlopen gtk-dlopen.cpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dlopen dl )   
</pre>
</div>

<p>
File: gtk-dlopen.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Copied from GTK headers ------// </span>
<span class="org-keyword">typedef</span> <span class="org-type">char</span>            <span class="org-type">gchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">short</span>           <span class="org-type">gshort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">long</span>            <span class="org-type">glong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">int</span>             <span class="org-type">gint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">gint</span>            <span class="org-type">gboolean</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">char</span>   <span class="org-type">guchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">short</span>  <span class="org-type">gushort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">long</span>   <span class="org-type">gulong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">int</span>    <span class="org-type">guint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">float</span>           <span class="org-type">gfloat</span>;
<span class="org-keyword">typedef</span> <span class="org-type">double</span>          <span class="org-type">gdouble</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*           <span class="org-type">gpointer</span>;
<span class="org-keyword">typedef</span> <span class="org-keyword">const</span> <span class="org-type">void</span>*     <span class="org-type">gconstpointer</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
    <span class="org-variable-name">GTK_WINDOW_POPUP</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-variable-name">G_CONNECT_AFTER</span>   = 1 &lt;&lt; 0,
  <span class="org-variable-name">G_CONNECT_SWAPPED</span> = 1 &lt;&lt; 1
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">TFun</span> <span class="org-function-name">load_symbol</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">hnd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, symbol.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hSym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [Error] symbol not found: "</span><span class="org-rainbow-delimiters-depth-3">)</span> + symbol;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque type (aka incomplete type)</span>
<span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------- Function Pointers type aliases -------------------//</span>
<span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">gpointer</span> <span class="org-variable-name">instance</span>
                                              , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                              , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                              , <span class="org-type">gpointer</span>        <span class="org-variable-name">data</span>
                                              , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                              , <span class="org-type">GConnectFlags</span>   <span class="org-variable-name">connect_flags</span>
                                          <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-comment-delimiter">//  </span><span class="org-comment">void *dlopen(const char *filename, int flags);</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to shared library </span>
    <span class="org-type">void</span>* <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span>shared_lib.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span> fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"%s\n"</span>, dlerror<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> hnd != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = <span class="org-constant">nullptr</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Load gtk_init_check function pointer ------- // </span>
    hSym = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>hSym != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_init_check</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Load remaining function pointers (symbols) --------// </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">opaque pointer </span>
    <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;

    <span class="org-keyword">using</span> <span class="org-type">gkt_window_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_new</span>  = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gkt_window_new_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_new"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_show</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>*<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_show"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main</span>        = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_set_title</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_widget_set_size_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>*, gint, gint<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_set_size</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_widget_set_size_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_set_size_request"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main_quit</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_signal_connect_data</span> 
          = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">g_signal_connect_data_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"g_signal_connect_data"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">------- Build Window GUI - Graphical User Interface ----------**/</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call function pointer </span>
    gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span> = gtk_window_new<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-constant">GtkWindowType</span>::GTK_WINDOW_TOPLEVEL<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_set_size<span class="org-rainbow-delimiters-depth-2">(</span>window, 400, 500<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_window_set_title<span class="org-rainbow-delimiters-depth-2">(</span>window, <span class="org-string">"My GTK Window"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_show<span class="org-rainbow-delimiters-depth-2">(</span>window<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk_signal_connect_data<span class="org-rainbow-delimiters-depth-2">(</span>  window         <span class="org-comment-delimiter">// </span><span class="org-comment">Widget </span>
                            , <span class="org-string">"destroy"</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Event name </span>
                            , gtk_main_quit  <span class="org-comment-delimiter">// </span><span class="org-comment">Callback                             </span>
                            , <span class="org-constant">nullptr</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to data (closure )</span>
                            , <span class="org-constant">nullptr</span> 
                            , <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GConnectFlags</span><span class="org-rainbow-delimiters-depth-3">)</span> 0 <span class="org-comment-delimiter">// </span><span class="org-comment">GConnect flags </span>
                            <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Window running. OK! "</span> &lt;&lt; <span class="org-string">"\n"</span>;
    gtk_main<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close shared library handler.</span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf &amp;&amp; <span class="org-builtin">cd</span> gist 
$ g++ gtk-dlopen.cpp -o <span class="org-keyword">gtk-dlopen.bin</span> -std=c++1z -ldl -ggdb -Wall -Wextra   
</pre>
</div>

<p>
Checking the dependencies of gtk-dlopen.bin 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ldd gtk-dlopen.bin 
       linux-vdso.so.1 (0x00007ffd23fc4000)
       libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6a78428000)
       libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007f6a78238000)
       libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f6a780f2000)
       libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f6a780d7000)
       libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6a77f0d000)
       /lib64/ld-linux-x86-64.so.2 (0x00007f6a78453000)
</pre>
</div>

<p>
Running: (load GTK shared library /lib64/libgtk-3.so.0)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin 
[INFO] Loading shared library: /lib64/libgtk-3.so.0
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Running: (load GK2 shared library )
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin /usr/lib64/libgtk-x11-2.0.so 
[INFO] Loading shared library: /usr/lib64/libgtk-x11-2.0.so
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Verify exported symbols by gtk3 shared library: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; nm -D /lib64/libgtk-3.so.0 | grep init
       ... ... ... ... ..
       ... ... ... ... ..
       U g_async_initable_new_async
       U g_async_initable_new_finish
       U g_datalist_init
       U g_hash_table_iter_init
       U g_initable_get_type
       U g_initable_new
       U g_initially_unowned_get_type
       U g_mutex_init
       U g_once_init_enter
      ... ... ... ... ..
      ... ... ... ... ..
</pre>
</div>

<p>
Screenshot: 
</p>


<div class="figure">
<p><a href="images/gtk-dlopen-screen1.png"><img src="images/gtk-dlopen-screen1.png" alt="gtk-dlopen-screen1.png" /></a>
</p>
<p><span class="figure-number">Figure 1: </span>Screenshot of GTk Window created using dlopen() API</p>
</div>
</div>
</div>

<div id="outline-container-org7244c5c" class="outline-4">
<h4 id="org7244c5c"><span class="section-number-4">1.18.3</span> GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</h4>
<div class="outline-text-4" id="text-1-18-3">
<p>
This proof-of-concept code contains a high-level wrapper class
SharedLibrary for abstracting away the dlopen() API. This class is
used for loading GTK3 or GTk2 shared library at runtime and then
showing modal notifications dialogs. The advantage of the dynamic
loading approach is the flexibility, portability and easier deployment
as the binary does not depends on any particular GTK shared library
version.
</p>

<p>
Note: 
</p>

<ul class="org-ul">
<li>The code of the class SharedLibrary can be reused on any other
unix-like operating system with dlopen() API, such as FreeBDS,
NetBSD, MacOSX and so on.</li>

<li>The Windows API for dynamic loading is LoadLibrary(),
GetProcAddress().</li>
</ul>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b">https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b</a></li>
</ul>

<p>
<b>Project Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-dynamic-load-dialog)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment"># ---- TARGETS Configuration ---------------#</span>
       <span class="org-function-name">add_executable</span>( gtk-dialog gtk-dialog.cpp gtk_types.hpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dialog dl ) 
</pre>
</div>

<p>
File: gtk-dialog.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string">"gtk_types.hpp"</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Requires header: &lt;dlfcn.h&gt; and linking flag (-ldl) */</span>
<span class="org-keyword">class</span> <span class="org-type">SharedLibrary</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">using</span> <span class="org-type">HND</span>  = <span class="org-type">void</span>*; 
    <span class="org-keyword">using</span> <span class="org-type">HSYM</span> = <span class="org-type">void</span>*;
<span class="org-function-name">private</span>:
    <span class="org-type">HND</span>         <span class="org-variable-name">m_hnd</span>  = <span class="org-constant">nullptr</span>; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_lib</span> = <span class="org-string">""</span> ; 
    <span class="org-type">int</span>         <span class="org-variable-name">m_flags</span> = 0;
<span class="org-function-name">public</span>:
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){}</span>    
    ~<span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Constructor delegation </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : SharedLibrary<span class="org-rainbow-delimiters-depth-2">(</span>library, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>library, flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor and copy-assignment operator </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move constructor </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move assignment operator </span>
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">HND</span>         <span class="org-function-name">handler</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-type">bool</span>        <span class="org-function-name">is_loaded</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd != <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">library</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_lib; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Retrieve symbol from shared library */</span>
    <span class="org-type">HSYM</span> <span class="org-function-name">symbol_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Get symbol from shared library</span>
<span class="org-comment">     * Note: The caller is resposible for checking if the symbol is (null) nullptr.</span>
<span class="org-comment">     */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Attempts to load symbol and throws exception, if symbol is not found. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol_or_fail</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>sym<span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] Dlopen / dlsym() =&gt; unable find symbol"</span>;
            msg = msg + <span class="org-string">" &lt;"</span> + name + <span class="org-string">"&gt;"</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">load</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        m_lib   = library;
        m_flags = flags;
        m_hnd = dlopen<span class="org-rainbow-delimiters-depth-3">(</span>library.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] DlopenError: "</span>;
            msg = msg + dlerror<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>    

    <span class="org-type">void</span> <span class="org-function-name">reload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">unload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        ::dlclose<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;        
        m_hnd = <span class="org-constant">nullptr</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class SharedLibrary() ---- //</span>

<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">fpointer</span>;
<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">enums</span>;

<span class="org-keyword">struct</span> <span class="org-type">GtkLib</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">SharedLibrary</span> <span class="org-variable-name">slib</span>;

    <span class="org-function-name">GtkLib</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : slib<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-3">(</span>SharedLibrary<span class="org-rainbow-delimiters-depth-4">(</span>library<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        gtk_init_check         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-3">)</span>;       
        gtk_main_quit          = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_main_quit_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main               = slib.symbol_or_fail&lt;void (*) ()&gt;("gtk_main");</span>
        gtk_message_dialog_new = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_message_dialog_new_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_message_dialog_new"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_widget_destroy     = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_widget_destroy_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_widget_destroy"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_dialog_run         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_dialog_run_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_dialog_run"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_window_set_title   = slib.symbol<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">gtk_init_check_t</span>         <span class="org-variable-name">gtk_init_check</span>; 
    <span class="org-type">gtk_main_quit_t</span>          <span class="org-variable-name">gtk_main_quit</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main_t               gtk_main;</span>
    <span class="org-type">gtk_message_dialog_new_t</span> <span class="org-variable-name">gtk_message_dialog_new</span>;
    <span class="org-type">gtk_widget_destroy_t</span>     <span class="org-variable-name">gtk_widget_destroy</span>;
    <span class="org-type">gtk_dialog_run_t</span>         <span class="org-variable-name">gtk_dialog_run</span>;
    <span class="org-type">gtk_window_set_title_t</span>   <span class="org-variable-name">gtk_window_set_title</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Message box notification </span>
    <span class="org-type">void</span> <span class="org-function-name">msgbox</span><span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">title</span>
                , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> 
                , <span class="org-type">GtkMessageType</span> <span class="org-variable-name">mtype</span> = <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO 
                <span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-type">GtkWidget</span>* <span class="org-variable-name">dialog</span> = <span class="org-keyword">this</span>-&gt;gtk_message_dialog_new<span class="org-rainbow-delimiters-depth-3">(</span>  <span class="org-constant">nullptr</span> 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkDialogFlags</span>::GTK_DIALOG_MODAL
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> mtype 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkButtonsType</span>::GTK_BUTTONS_OK
                                                , text.c_str<span class="org-rainbow-delimiters-depth-4">()</span>
                                                <span class="org-rainbow-delimiters-depth-3">)</span>;                                            
        assert<span class="org-rainbow-delimiters-depth-3">(</span> dialog != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;    
        <span class="org-keyword">this</span>-&gt;gtk_window_set_title<span class="org-rainbow-delimiters-depth-3">(</span>dialog, title.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">this</span>-&gt;gtk_dialog_run<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Dialog destroyed OK "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">this</span>-&gt;gtk_widget_destroy<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;   
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>        
    <span class="org-comment-delimiter">// </span><span class="org-comment">User can select his own GTK shared library, if it is not </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">found. He can also select GTK2 shared library. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;   
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk</span> = GtkLib<span class="org-rainbow-delimiters-depth-2">{</span>shared_lib<span class="org-rainbow-delimiters-depth-2">}</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Alwas start the library before calling any GTK function </span>
    gtk.gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"User notification"</span>, <span class="org-string">"Download completed. Ok."</span>,     <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO <span class="org-rainbow-delimiters-depth-2">)</span>;    
    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Runtime error"</span>,     <span class="org-string">"KERNEL PANIC!! Reboot NOW!!"</span>, <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_ERROR <span class="org-rainbow-delimiters-depth-2">)</span>;        

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: gtk_types.hpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ C++ Wrappers for dynamically loading GTK ----- //</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _GTK_TYPES_HPP
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_GTK_TYPES_HPP</span>

<span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">base</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-type">gchar</span>    = <span class="org-type">char</span>;
        <span class="org-keyword">using</span> <span class="org-type">gshort</span>   = <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">glong</span>    = <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">gint</span>     = <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gboolean</span> = gint;
        <span class="org-keyword">using</span> <span class="org-type">guchar</span>   = <span class="org-type">unsigned</span> <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">gulong</span>   = <span class="org-type">unsigned</span> <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">guint</span>    = <span class="org-type">unsigned</span> <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gfloat</span>   = <span class="org-type">float</span>;
        <span class="org-keyword">using</span> <span class="org-type">gdouble</span>  = <span class="org-type">double</span>;
        <span class="org-keyword">using</span> <span class="org-type">gpointer</span> = <span class="org-type">void</span>*;          
        <span class="org-keyword">using</span> <span class="org-type">gconstpointer</span> = <span class="org-keyword">const</span> <span class="org-type">void</span>*;

    <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Opaque Types / incomplete types ---------//</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">widget</span> <span class="org-rainbow-delimiters-depth-2">{</span>        
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWindow</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkDialog</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">namespace</span> <span class="org-constant">enums</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
            <span class="org-variable-name">GTK_WINDOW_POPUP</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">G_CONNECT_AFTER</span> = 1 &lt;&lt; 0,
        <span class="org-variable-name">G_CONNECT_SWAPPED</span>   = 1 &lt;&lt; 1
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkMessageType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_MESSAGE_INFO</span>,
        <span class="org-variable-name">GTK_MESSAGE_WARNING</span>,
        <span class="org-variable-name">GTK_MESSAGE_QUESTION</span>,
        <span class="org-variable-name">GTK_MESSAGE_ERROR</span>,
        <span class="org-variable-name">GTK_MESSAGE_OTHER</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkButtonsType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_BUTTONS_NONE</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK</span>,
        <span class="org-variable-name">GTK_BUTTONS_CLOSE</span>,
        <span class="org-variable-name">GTK_BUTTONS_CANCEL</span>,
        <span class="org-variable-name">GTK_BUTTONS_YES_NO</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK_CANCEL</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkDialogFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_DIALOG_MODAL</span>               = 1 &lt;&lt; 0,
        <span class="org-variable-name">GTK_DIALOG_DESTROY_WITH_PARENT</span> = 1 &lt;&lt; 1,
        <span class="org-variable-name">GTK_DIALOG_USE_HEADER_BAR</span>      = 1 &lt;&lt; 2
        <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Function pointers type aliases  */</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">fpointer</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">base</span>;
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">widget</span>;
        <span class="org-keyword">using</span> <span class="org-constant">enums</span>::<span class="org-type">GConnectFlags</span>;

        <span class="org-keyword">using</span> <span class="org-type">GtkDialogFlags_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkMessageType_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkButtonsType_t</span> = <span class="org-type">int</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_dialog_run_t</span>       = gint <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>* <span class="org-variable-name">dialog</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_widget_destroy_t</span>   = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">widget</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_main_quit_t</span>        = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">gpointer</span>        <span class="org-variable-name">instance</span>
                                                    , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                                    , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                                    , <span class="org-type">gpointer</span>          <span class="org-variable-name">data</span>
                                                    , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                                    , <span class="org-type">GConnectFlags</span> <span class="org-variable-name">connect_flags</span>
                                                    <span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">gtk_message_dialog_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">GtkWindow</span>       *<span class="org-variable-name">parent</span>,
                                                          <span class="org-type">GtkDialogFlags_t</span>  <span class="org-variable-name">flags</span>,
                                                          <span class="org-type">GtkMessageType_t</span>  <span class="org-variable-name">type</span>,
                                                          <span class="org-type">GtkButtonsType_t</span>  <span class="org-variable-name">buttons</span>,
                                                          <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">message_format</span>
                                                        <span class="org-rainbow-delimiters-depth-3">)</span>;


    <span class="org-rainbow-delimiters-depth-2">}</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-preprocessor">#endif</span> 
</pre>
</div>

<p>
Building and running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Download </span>
$ &gt;&gt; git clone https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b gtk-dialog &amp;&amp; <span class="org-builtin">cd</span> gtk-dialog 

<span class="org-comment-delimiter"># </span><span class="org-comment">Configure </span>
$ &gt;&gt; cmake --config Debug -H. -B_build

<span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ &gt;&gt; cmake --build _build --target 

<span class="org-comment-delimiter"># </span><span class="org-comment">Run </span>
$ &gt;&gt; _build/gtk-dialog 
[INFO] Loading shared library: libgtk-3.so.0
[INFO] Dialog destroyed OK 
[INFO] Dialog destroyed OK 
[INFO] Shutdown gracefully. Ok. 

</pre>
</div>

<p>
Screenshots: 
</p>


<div class="figure">
<p><a href="images/gtk-dlopen-screen2.png"><img src="images/gtk-dlopen-screen2.png" alt="gtk-dlopen-screen2.png" /></a>
</p>
<p><span class="figure-number">Figure 2: </span>Gtk modal dialog screenshot 1</p>
</div>


<div class="figure">
<p><a href="images/gtk-dlopen-screen3.png"><img src="images/gtk-dlopen-screen3.png" alt="gtk-dlopen-screen3.png" /></a>
</p>
<p><span class="figure-number">Figure 3: </span>Gtk modal dialog screenshot 2</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org41ea4ec" class="outline-3">
<h3 id="org41ea4ec"><span class="section-number-3">1.19</span> Library calls hooking/interception with LD_PRELOAD</h3>
<div class="outline-text-3" id="text-1-19">
</div>
<div id="outline-container-org6da7f85" class="outline-4">
<h4 id="org6da7f85"><span class="section-number-4">1.19.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-19-1">
<p>
The dynamic linker of many Unix-like operating systems, including
Linux-based ones and BSD variants, provide a LD_PRELOAD mechanism,
which allows intercepting and overriding (aka hooking) library calls
performed by applications withou any source code modification. A
library call can be overriden by setting the LD_PRELOAD environment
variable with a colon (':') separated list containing full paths of
shared libraries containing symbols with the same name as the
overriden functions.
</p>

<p>
Some use-cases of this feature are: 
</p>

<ul class="org-ul">
<li>Override library calls and modify the behavior of library calls.</li>
<li>Performance analysis.</li>
<li>Instrument library calls.</li>
<li>Log library-calls</li>
<li>Trace memory allocation by overrading calloc, malloc and free
functions.</li>
<li>Patch executables without any source code modification or
recompilation.</li>
</ul>

<p>
Notes and limitations: 
</p>

<ul class="org-ul">
<li>The dynamic linker LD_PRELOAD feature do not intercept kernel's
system-calls, it can only intercept library calls (aka function
calls) or GlibC (GNU C library) or any other CRT (C - Runtime
Library) wrappers for <span class="underline">system calls</span>, informally called
<span class="underline">syscalls</span>.</li>

<li>LD_PRELOAD trick cannot intercept functions of executables owned
by root and with SETUID bit set.</li>
</ul>
</div>
</div>

<div id="outline-container-org0db7d4d" class="outline-4">
<h4 id="org0db7d4d"><span class="section-number-4">1.19.2</span> Intercepting open() and fopen() library calls</h4>
<div class="outline-text-4" id="text-1-19-2">
<p>
All sources available at GIST: 
</p>

<ul class="org-ul">
<li>GIST: <a href="https://gist.github.com/751fad7bf7707949e824ed2c19a73752">https://gist.github.com/751fad7bf7707949e824ed2c19a73752</a></li>
</ul>

<p>
File: <span class="underline">build.sh</span> (Build script)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> sh</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Build unix/Linux executable</span>
gcc unix-executable.c -o unix-executable.bin

<span class="org-comment-delimiter"># </span><span class="org-comment">Build Linux shared library: hook-files-a.so</span>
gcc hook-files-a.c -o <span class="org-keyword">hook-files-a.so</span> -fpic -shared -ldl -Wall

<span class="org-comment-delimiter"># </span><span class="org-comment">Build Linux shared library: hook-files-b.so</span>
g++ hook-files-b.cpp -o <span class="org-keyword">hook-files-b.so</span> -fpic -Wall -shared -ldl
</pre>
</div>


<p>
File: <span class="underline">hook-files-a.c</span>  / C-version  (Shared library, aka shared object, hook-files-a.so)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-variable-name">_GNU_SOURCE</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Enables RTLD_NEXT constant.</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">assert.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdint.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix-specific headers ------- //</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotation for internal symbols not visible outside</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">this compilation unit (static storage class).</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">HIDDEN</span> <span class="org-keyword">static</span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Anotation for calling function whenever the shared library</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">is loaded by some process. Note: this is a specific GNU </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">language extension. </span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ON_LIBRARY_LOADED</span> <span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">pid_t</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">mode_t</span>;

<span class="org-keyword">extern</span>  <span class="org-type">pid_t</span> <span class="org-function-name">getpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">static</span> 
<span class="org-type">void</span> <span class="org-function-name">init_library1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [INFO] init_library1() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

HIDDEN ON_LIBRARY_LOADED 
<span class="org-type">void</span> <span class="org-function-name">init_library2</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [INFO] init_library2() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Intercepts (aka hooks) and overrides open() function </span>
<span class="org-comment"> *  from libC (GLIBC) that encapsulates open() system-call </span>
<span class="org-comment"> *  (aka syscall).</span>
<span class="org-comment"> *---------------------------------------------------------*/</span>
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer with same</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">signature as the open() function. </span>
   <span class="org-keyword">typedef</span> <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>* <span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>
                           , <span class="org-type">int</span>         <span class="org-variable-name">flags</span>
                           , <span class="org-type">mode_t</span>      <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Load old symbol of original C function that was overriden</span>
   <span class="org-type">open_t</span> <span class="org-variable-name">open_real</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"open"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Sanity checking =&gt; calls abort() if symbol is not found.</span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> open_real <span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Log intercepted functional call</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">pid =&gt;&gt; Process ID of process that loaded this</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">shared library. </span>
   fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
            , <span class="org-string">" [TRACE] pid = %d / open() -&gt;&gt; File = %s \n"</span>
            , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, pathname<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Pass control back to intercepted (hooked) function. </span>
   <span class="org-keyword">return</span> open_real<span class="org-rainbow-delimiters-depth-2">(</span>pathname, flags, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">FILE</span>* <span class="org-function-name">fopen64</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">typedef</span> <span class="org-type">FILE</span>* <span class="org-rainbow-delimiters-depth-2">(</span>* <span class="org-type">fopen64_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>
                                   , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-type">fopen64_t</span> <span class="org-variable-name">old_fun</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">fopen64_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"fopen64"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      assert<span class="org-rainbow-delimiters-depth-2">(</span> old_fun != <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
               , <span class="org-string">" [TRACE] pid = %d / fopen64() -&gt;&gt; File = %s \n"</span>
               , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, filename<span class="org-rainbow-delimiters-depth-2">)</span>;     

      <span class="org-keyword">return</span> old_fun<span class="org-rainbow-delimiters-depth-2">(</span>filename, type<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
File: <span class="underline">hook-files-b.cpp</span>  / C++-version  (Shared library <i>hook-files-b.so</i> )
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to C-header &lt;stdint.h&gt; std::uint32_t ... and so on.</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix-specific headers ------- //</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotqtion for defining functions with C-linkage</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">that must conform to C ABI and calling conventions.</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">EXTERN_C</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotation for internal symbols not visible outside</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">this compilation unit (static storage class).</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">HIDDEN</span> <span class="org-keyword">static</span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Anotation for calling function whenever the shared library</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">is loaded by some process. Note: this is a specific GNU </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">language extension. </span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ON_LIBRARY_LOADED</span> <span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">This symbol will be resolved at linking-time by the Linker </span>
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">pid_t</span> <span class="org-function-name">getpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">static</span> 
<span class="org-type">void</span> <span class="org-function-name">init_library1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr,<span class="org-string">" [INFO] init_library1() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

HIDDEN ON_LIBRARY_LOADED 
<span class="org-type">void</span> <span class="org-function-name">init_library2</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [INFO] init_library2() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Intercepts (aka hooks) and overrides open() function </span>
<span class="org-comment"> *  from libC (GLIBC) that encapsulates open() system-call </span>
<span class="org-comment"> *  (aka syscall).</span>
<span class="org-comment"> *---------------------------------------------------------*/</span>
EXTERN_C
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer with same</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">signature as the open() function. </span>
   <span class="org-keyword">using</span> <span class="org-type">open_t</span> = <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>
                           , <span class="org-type">int</span>         <span class="org-variable-name">flags</span>
                           , <span class="org-type">mode_t</span>      <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Load old symbol of original C function that was overriden</span>
   <span class="org-type">open_t</span> <span class="org-variable-name">open_real</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"open"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Sanity checking =&gt; calls abort() if symbol is not found.</span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> open_real != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Log intercepted functional call</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">pid =&gt;&gt; Process ID of process that loaded this</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">shared library. </span>
   <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
                , <span class="org-string">" [TRACE] pid = %d / open() -&gt;&gt; File = %s \n"</span>
                , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, pathname<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Pass control back to intercepted (hooked) function. </span>
   <span class="org-keyword">return</span> open_real<span class="org-rainbow-delimiters-depth-2">(</span>pathname, flags, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

EXTERN_C
<span class="org-type">FILE</span>* <span class="org-function-name">fopen64</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">using</span> <span class="org-type">fopen64_real</span> = FILE* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>
                                   , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">old_fun</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">fopen64_real</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"fopen64"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> old_fun != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
                , <span class="org-string">" [TRACE] pid = %d / fopen64() -&gt;&gt; File = %s \n"</span>
                , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, filename<span class="org-rainbow-delimiters-depth-2">)</span>;     

    <span class="org-keyword">return</span> old_fun<span class="org-rainbow-delimiters-depth-2">(</span>filename, type<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building executable and shared libraries (aka shared objects - 'unix
terminology'):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; git clone https://gist.github.com/751fad7bf7707949e824ed2c19a73752 api-hooking &amp;&amp; <span class="org-builtin">cd</span> api-hooking 
$ &gt;&gt; sh build.sh

$ ls
build.sh  hook-files-a.c  hook-files-b.cpp  unix-executable.c

<span class="org-comment-delimiter"># </span><span class="org-comment">Check generated object-codes:</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">------------------------------------------------------------------#</span>
$ &gt;&gt; file hook-files-a.so 
<span class="org-function-name">hook-files-a.so</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV) ... ...

$ &gt;&gt; file hook-files-b.so
<span class="org-function-name">hook-files-b.so</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV) ... ...

$ &gt;&gt; file unix-executable.bin 
<span class="org-function-name">unix-executable.bin</span>: ELF 64-bit LSB executable, x86-64, ... ... ...
</pre>
</div>

<p>
Running executable <span class="underline">unix-executable.bin</span> 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-executable.bin  
<span class="org-function-name">unix-executable.bin</span>: unix-executable.c:8: main: Assertion <span class="org-sh-quoted-exec">`argc == 2 &amp;&amp; "Missing file argument"' failed.</span>
<span class="org-sh-quoted-exec">fish: &#8220;./unix-executable.bin&#8221; terminated by signal SIGABRT (Abort)</span>

<span class="org-sh-quoted-exec">$ &gt;&gt; ./unix-executable.bin /proc/devices </span>
<span class="org-sh-quoted-exec">[LINE] 1 = Character devices:</span>
<span class="org-sh-quoted-exec"> [LINE] 2 =   1 mem</span>
<span class="org-sh-quoted-exec"> [LINE] 3 =   4 /dev/vc/0</span>
<span class="org-sh-quoted-exec"> [LINE] 4 =   4 tty</span>
<span class="org-sh-quoted-exec">... ... ... ... ... </span>
<span class="org-sh-quoted-exec">... ... ... ... ... </span>
<span class="org-sh-quoted-exec"> [LINE] 67 = 253 device-mapper</span>
<span class="org-sh-quoted-exec"> [LINE] 68 = 254 mdp</span>
<span class="org-sh-quoted-exec"> [LINE] 69 = 259 blkext</span>
</pre>
</div>

<p>
Intercepting library-call (ak function) <span class="underline">fopen64()</span> using LD_PRELOAD.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Using hook-files-a.so (C version)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">-------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-a.so ./unix-executable.bin /proc/devices 
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231690 / fopen64() -&gt;&gt; File = /proc/devices 
[LINE] 1 = Character devices:
 [LINE] 2 =   1 mem
 [LINE] 3 =   4 /dev/vc/0
 [LINE] 4 =   4 tty
 [LINE] 5 =   4 ttyS
 [LINE] 6 =   5 /dev/tty
 [LINE] 7 =   5 /dev/console
 ... ... ... ... 
... ... ... ... ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Using hook-files-b.so (C++ version)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">-------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so ./unix-executable.bin /proc/devices
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231790 / fopen64() -&gt;&gt; File = /proc/devices 
[LINE] 1 = Character devices:
 [LINE] 2 =   1 mem
 [LINE] 3 =   4 /dev/vc/0
 [LINE] 4 =   4 tty
 [LINE] 5 =   4 ttyS
 [LINE] 6 =   5 /dev/tty
 [LINE] 7 =   5 /dev/console
... ...  ... ...  ... ...  ... ...  ... ... 
... ...  ... ...  ... ...  ... ...  ... ... 
</pre>
</div>

<p>
Intercepting library-call (ak function) <span class="underline">fopen64()</span> using LD_PRELOAD,
but discarding <span class="underline">stdout</span> (standard console output) by redirecting it to
/dev/null in order to only display the <span class="underline">stderr</span> logged by the
replacement functions. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">C version </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-a.so ./unix-executable.bin /proc/devices &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231957 / fopen64() -&gt;&gt; File = /proc/devices 

<span class="org-comment-delimiter"># </span><span class="org-comment">C+++ version </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so ./unix-executable.bin /proc/devices &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231994 / fopen64() -&gt;&gt; File = /proc/devices 
</pre>
</div>

<p>
Tracing library calls with <span class="underline">ltrace</span> utility: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ltrace ./unix-executable.bin /proc/devices
<span class="org-function-name">fopen64</span>(<span class="org-string">"/proc/devices"</span>, <span class="org-string">"r"</span>)                         = 0x19722a0
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 19
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 1, <span class="org-string">"Character devices:\n"</span> [LINE] 1 = Character devices:
) = 32
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 8
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 2, <span class="org-string">"  1 mem\n"</span>  [LINE] 2 =   1 mem
) = 21
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 14
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 3, <span class="org-string">"  4 /dev/vc/0\n"</span>  [LINE] 3 =   4 /dev/vc/0
) = 27
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 8
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 4, <span class="org-string">"  4 tty\n"</span>  [LINE] 4 =   4 tty
  ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ... 
  ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ... 
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = -1
<span class="org-function-name">free</span>(0x1972480)                                       = &lt;void&gt;
<span class="org-function-name">fclose</span>(0x19722a0)                                     = 0
 +++ exited (status 0) +++
</pre>
</div>

<p>
Tracing system-calls calls with <span class="underline">strace</span> utility: 
</p>

<pre class="example">
$ &gt;&gt; strace ./unix-executable.bin /proc/devices

execve("./unix-executable.bin", ["./unix-executable.bin", "/proc/devices"], 0x7ffc6f5c0ba8 /* 83 vars */) = 0
 ... ... ... ...  ... ... ... ... ... ... ... ... 
 ... ... ... ...  ... ... ... ... ... ... ... ... 

openat(AT_FDCWD, "/proc/devices", O_RDONLY) = 3
fstat(3, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
read(3, "Character devices:\n  1 mem\n  4 /"..., 1024) = 694
fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0xa), ...}) = 0
write(1, " [LINE] 1 = Character devices:\n", 31 [LINE] 1 = Character devices:
) = 31
write(1, "  [LINE] 2 =   1 mem\n", 21  [LINE] 2 =   1 mem
)  = 21
write(1, "  [LINE] 3 =   4 /dev/vc/0\n", 27  [LINE] 3 =   4 /dev/vc/0
) = 27
write(1, "  [LINE] 4 =   4 tty\n", 21  [LINE] 4 =   4 tty
)  = 21
 ... ... ...  ... ... ...  ... ... ...  ... ... ...  ... ... ... 
 ... ... ...  ... ... ...  ... ... ...  ... ... ...  ... ... ... 
</pre>

<p>
Determining files opened by <i>uptime</i> executable. 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ which uptime
 /usr/bin/uptime

 $ file $(<span class="org-sh-quoted-exec">which</span> uptime)
 /usr/bin/uptime: ELF 64-bit LSB shared object, x86-64, ... ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Indicates how long the machine is running: </span>
$ &gt;&gt; uptime 
<span class="org-function-name">15</span>:45:45 up 3 days, 19:39,  1 user,  load average: 0.32, 0.59, 0.58

<span class="org-comment-delimiter"># </span><span class="org-comment">Run 1 </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so uptime
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 232426 / open() -&gt;&gt; File = /proc/uptime 
[TRACE] pid = 232426 / open() -&gt;&gt; File = /proc/loadavg 
<span class="org-function-name">15</span>:46:39 up 3 days, 19:40,  1 user,  load average: 0.55, 0.61, 0.59

<span class="org-comment-delimiter"># </span><span class="org-comment">Run 2 - Discard stdout, preserving only stderr </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so uptime &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 232456 / open() -&gt;&gt; File = /proc/uptime 
[TRACE] pid = 232456 / open() -&gt;&gt; File = /proc/loadavg 

$ &gt;&gt; cat /proc/uptime 
330114.72 1249234.16

$ &gt;&gt; cat /proc/loadavg 
0.40 0.55 0.57 1/1838 232504
</pre>
</div>

<p>
Determining files opened by <i>free</i> executable which indicates the amount
of free RAM memory in megabytes in the current machine:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ free -m
              total        used        free      shared  buff/cache   available
<span class="org-function-name">Mem</span>:          15897        6603        2236        1768        7057        7378
<span class="org-function-name">Swap</span>:             0           0           0

<span class="org-comment-delimiter"># </span><span class="org-comment">Intercept library calls </span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so free -m
 [INFO] init_library1() / Library loaded Ok. 
 [INFO] init_library2() / Library loaded Ok. 
 [TRACE] pid = 232965 / open() -&gt;&gt; File = /proc/meminfo 
              total        used        free      shared  buff/cache   available
<span class="org-function-name">Mem</span>:          15897        6601        2238        1768        7058        7380
<span class="org-function-name">Swap</span>:             0           0           0

<span class="org-comment-delimiter"># </span><span class="org-comment">Intercept library calls and discard stdout</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">, keeping only stderr (standard error output)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
 $ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so free -m &gt; /dev/null 
 [INFO] init_library1() / Library loaded Ok. 
 [INFO] init_library2() / Library loaded Ok. 
 [TRACE] pid = 233016 / open() -&gt;&gt; File = /proc/meminfo

<span class="org-comment-delimiter"># </span><span class="org-comment">Inspect file /proc/meminfo </span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
 $ &gt;&gt; cat /proc/meminfo 
<span class="org-function-name">MemTotal</span>:       16279408 kB
<span class="org-function-name">MemFree</span>:         2271428 kB
<span class="org-function-name">MemAvailable</span>:    7552036 kB
<span class="org-function-name">Buffers</span>:         1178620 kB
 ... ... ... ... ... ... 
 ... ... ... ... ... ... 
<span class="org-function-name">HugePages_Surp</span>:        0
<span class="org-function-name">Hugepagesize</span>:       2048 kB
<span class="org-function-name">Hugetlb</span>:               0 kB
<span class="org-function-name">DirectMap4k</span>:      604380 kB
<span class="org-function-name">DirectMap2M</span>:    12916736 kB
<span class="org-function-name">DirectMap1G</span>:     4194304 kB

</pre>
</div>
</div>
</div>
<div id="outline-container-org71ee415" class="outline-4">
<h4 id="org71ee415"><span class="section-number-4">1.19.3</span> Intercepting dlopen() library calls</h4>
<div class="outline-text-4" id="text-1-19-3">
<p>
The subroutine dlopen() is used for loading shared libraries, plugins
and native libraries, in the case of languages such as Python, Ruby,
Java, TCL and so on. By intercepting library calls to dlopen(), it is
possible check the shared libraries loaded by a given process. 
</p>

<p>
File: <span class="underline">dlopen_hook.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to C-header &lt;stdint.h&gt; std::uint32_t ... and so on.</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix-specific headers ------- //</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotation for defining functions with C-linkage</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">that must conform to C ABI and calling conventions.</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">EXTERN_C</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">This symbol will be resolved at linking-time by the Linker </span>
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">pid_t</span> <span class="org-function-name">getpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">static</span> 
<span class="org-type">void</span> <span class="org-function-name">init_library1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Library loaded on process =&gt;&gt; pid = %d \n\n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">/** </span><span class="org-comment">Intercept dlopen() library call. </span>
<span class="org-comment"> *</span>
<span class="org-comment"> ********************************************/</span>
<span class="org-preprocessor">#if</span> 1
EXTERN_C
<span class="org-type">void</span>* <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Function type signature - must have the same type signature of</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">the intercepted function. </span>
   <span class="org-keyword">using</span> <span class="org-type">fun_t</span> = <span class="org-type">void</span>* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-comment-delimiter">// </span><span class="org-comment">Load old symbol of original C function that was overriden</span>
   <span class="org-type">fun_t</span> <span class="org-variable-name">dlopen_real</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">fun_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"dlopen"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>  stderr, <span class="org-string">" [TRACE] dlopen() [PID = %d] - library = '%s'  Ok \n"</span>
                            , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, filename<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-keyword">return</span> dlopen_real<span class="org-rainbow-delimiters-depth-2">(</span>filename, flags<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-preprocessor">#endif</span> 
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; g++ dlopen_hook.cpp -o <span class="org-keyword">dlopen_hook.so</span> -fpic -Wl,--soname=./dlopen_hook.so -shared -Wall -ldl     

 <span class="org-comment-delimiter"># </span><span class="org-comment">Identify binary format </span>
 $ &gt;&gt; file dlopen_hook.so 
<span class="org-function-name">dlopen_hook.so</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked
, <span class="org-variable-name">BuildID</span>[sha1]=e31a1a84b50c2a4e8c72f4de484f8e245be59b67, not stripped

 <span class="org-comment-delimiter">#  </span><span class="org-comment">View dependencies </span>
 $ &gt;&gt; ldd dlopen_hook.so 
        linux-vdso.so.1 (0x00007ffcb6da7000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f64bb201000)
        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f64bb020000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f64bae2e000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f64bb227000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f64bacdf000)
        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f64bacc4000)
</pre>
</div>

<p>
Experiment 1: View shared libraries loaded by a Python process (python
rpl - read-print-eval-loop). 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/dlopen_hook.so python3
 [TRACE] Library loaded on process =&gt;&gt; pid = 53633 

Python 3.8.5 (default, Jul 28 2020, 12:59:40) 
[GCC 9.3.0] on linux
Type <span class="org-string">"help"</span>, <span class="org-string">"copyright"</span>, <span class="org-string">"credits"</span> or <span class="org-string">"license"</span> for more information.
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/usr/lib/python3.8/lib-dynload/readline.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
&gt;&gt;&gt; 


&gt;&gt;&gt; import os 
&gt;&gt;&gt; 
&gt;&gt;&gt; os.getpid()
53633

&gt;&gt;&gt; import dbus
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/usr/lib/python3/dist-packages/_dbus_bindings.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
&gt;&gt;&gt; 

&gt;&gt;&gt; import numpy
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/core/_multiarray_umath.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/core/_multiarray_tests.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/usr/lib/python3.8/lib-dynload/_ctypes.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'(null)'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/linalg/lapack_lite.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/linalg/_umath_linalg.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/fft/_pocketfft_internal.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/mtrand.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/bit_generator.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_common.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_bounded_integers.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_mt19937.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_philox.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_pcg64.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_sfc64.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/home/h03f8/.local/lib/python3.8/site-packages/numpy/random/_generator.cpython-38-x86_64-linux-gnu.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53633] - library = <span class="org-string">'/usr/lib/python3.8/lib-dynload/_opcode.cpython-38-x86_64-linux-gnu.so'</span>  Ok 

</pre>
</div>

<p>
Experiment 2: View shared libraries loaded by a Ruby process (Ruby repl irb).
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/dlopen_hook.so irb
 [TRACE] Library loaded on process =&gt;&gt; pid = 53705 

 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/enc/encdb.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/enc/trans/transdb.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/monitor.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/ripper.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/readline.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/io/console.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/pathname.so'</span>  Ok 
 [TRACE] dlopen() [PID = 53705] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/ruby/2.7.0/etc.so'</span>  Ok 
<span class="org-function-name">irb</span>(main):001:0&gt; 
</pre>
</div>

<p>
Experiment 3: View shared libraries loaded by <a href="https://kate-editor.org/">Kate editor</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/dlopen_hook.so kate
[TRACE] Library loaded on process =&gt;&gt; pid = 54041 

[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/platforms/libqxcb.so.avx2'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/platforms/libqxcb.so'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'libXcursor.so.1'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/platformthemes/KDEPlasmaPlatformTheme.so.avx2'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/platformthemes/KDEPlasmaPlatformTheme.so'</span>  Ok 

...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 

[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'libGLX_mesa.so.0'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'libGLX_mesa.so.0'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/dri/tls/iris_dri.so'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/dri/iris_dri.so'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/konsolepart.so.avx2'</span>  Ok 
[TRACE] dlopen() [PID = 54041] - library = <span class="org-string">'/usr/lib/x86_64-linux-gnu/qt5/plugins/konsolepart.so'</span>  Ok 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org394982e" class="outline-3">
<h3 id="org394982e"><span class="section-number-3">1.20</span> Launching processes with exec and fork system-call wrappers</h3>
<div class="outline-text-3" id="text-1-20">
<p>
This code demonstrates the usage of exec and fork system-calls wrapper
functions, namely, execvp() and fork() functions. 
</p>

<p>
<b>Relevant functions signature</b> 
</p>

<p>
Fork
</p>
<ul class="org-ul">
<li>Linux Manpage: "fork() creates a new process by duplicating the
calling process.  The new process is referred to as the child
process.  The calling process is referred to as the parent
process."</li>
<li>Note: The function 'fork' is not the system call fork, but a
C wrapper around this sytem call provided by the C runtime
library. (GLIBC - GNU C library in the machine where this was tested.)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">fork</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Execvp (wraps exec system call)
</p>
<ul class="org-ul">
<li>The exec system calls is always called when a new process is
launched/created. It replaces the process image of the current
process with a new one from the launched executable.</li>
<li>Note: In addition to native executables, on Unix-like operating
systems, an executable can also be any scripting file starting
with shebang as first line such as "#!/usr/bin/env sh"</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">execvp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">file</span>, <span class="org-type">char</span> *<span class="org-keyword">const</span> <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Waitpid =&gt; Waits for a state of change of a process.
</p>
<ul class="org-ul">
<li>It can be used for waiting for process termination.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">waitpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-type">int</span> *<span class="org-variable-name">wstatus</span>, <span class="org-type">int</span> <span class="org-variable-name">options</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork() Linux Manpage</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=execvp">Execvp() =&gt; FreeBSD Manpage</a></li>
</ul>

<p>
<b>Further Reading</b>
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Fork_(system_call)">Fork (system call) - Wikipedia</a></li>

<li><a href="http://people.cs.pitt.edu/~aus/cs449/ts-lecture14.pdf">Fork() System Calland ProcessesCS449 Spring 2016</a></li>

<li><a href="https://www.cs.columbia.edu/~junfeng/11sp-w4118/lectures/unix.pdf">Chapter 0 - Operating system interfaces {PDF}</a></li>
</ul>

<p>
<b>Sample Code</b> 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/133e91ba3732718cb228310173368674">https://gist.github.com/133e91ba3732718cb228310173368674</a></li>
</ul>

<p>
File: unix-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ File: unix-process.cpp -----------------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Description: Shows hows to launch processes on Unix with Exec and Fork syscall wrappers.</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------------------------//</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------- Declarations --------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Launch a new process without terminate this process. </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It combines fork + exec system-calls. </span>
<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Usage:  ./unix-process &lt;OPTION&gt;"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">opt</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"0"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
        execvp_test<span class="org-rainbow-delimiters-depth-3">()</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Test execvp </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"thunar"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"/etc"</span> <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Fork-exec </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"2"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fork_exec<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"konsole"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"-e"</span>, <span class="org-string">"tmux"</span>, <span class="org-string">"a"</span><span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>  

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Finish execution. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">------------- Definitions ------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr ,<span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                             <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Test exec system-call wrapper function (execvp)</span>
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span>    = <span class="org-string">"thunar"</span>;

        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>  app     <span class="org-comment-delimiter">// </span><span class="org-comment">Process name, can be anything </span>
                               , <span class="org-string">"/etc"</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments passed to the process </span>
                               , <span class="org-constant">nullptr</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Always terminate the argument array with null pointer </span>
                              <span class="org-rainbow-delimiters-depth-2">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulates execv system call. </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">int execvp(const char *file, char *const argv[]);</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
              <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
              print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
              <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">C++ wrapper for the exevp() library-call </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It replaces the current process image with a new one </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">from other executable. </span>
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>
                , <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">const</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">pargs</span>;
     pargs.reserve<span class="org-rainbow-delimiters-depth-2">(</span>args.size<span class="org-rainbow-delimiters-depth-3">()</span> + 1<span class="org-rainbow-delimiters-depth-2">)</span>;
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">a</span>: args<span class="org-rainbow-delimiters-depth-2">){</span> pargs.push_back<span class="org-rainbow-delimiters-depth-3">(</span>a.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Signature: int execvp(const char *file, char *const argv[]);</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">execvp(app.c_str(), execvp(app.c_str(), (char* const *) pargs.data() )</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = execvp<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>* <span class="org-keyword">const</span>*<span class="org-rainbow-delimiters-depth-3">)</span> pargs.data<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> status == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;BEFORE FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">PID of child process (copy of this process)</span>
     <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == 0<span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Running on child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  

          <span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptors, in order to disconnect the process from the terminal.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">This procedure allows the process to be launched as a daemon (aka service).</span>
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDERR_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Execvp system call, replace the image of this process with a new one</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">from an executable. </span>
          execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span>app, args<span class="org-rainbow-delimiters-depth-3">)</span>;        
          <span class="org-keyword">return</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">pid_t waitpid(pid_t pid, int *wstatus, int options);</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process to finish. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">From header: #include &lt;sys/wait.h&gt;</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>waitpid<span class="org-rainbow-delimiters-depth-3">(</span>pid, &amp;status, 0<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: cannot wait for child process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Child process has been terminated Ok."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">-------- Parent process ----------------//</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ unix-process.cpp -o <span class="org-keyword">unix-process.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 0
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 1
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 2
[INFO] Program started. 
[TRACE] &lt;BEFORE FORK&gt; PID of parent process = 774929 
[TRACE] &lt;AFTER FORK&gt; PID of parent process = 774929 
[TRACE] Running on child process =&gt; PID_CHILD = 774930 
[TRACE] Waiting for child process to finish.  [TRACE] Child process has been terminated Ok. [TRACE] Finish execution. 
</pre>
</div>
</div>
</div>
<div id="outline-container-org7ae26fb" class="outline-3">
<h3 id="org7ae26fb"><span class="section-number-3">1.21</span> Reading subprocess output via Popen()</h3>
<div class="outline-text-3" id="text-1-21">
<p>
The convenience function popen(), which is a combination of fork() +
exec() and pipe() functions, allows reading a subprocess
output. Note: this function is also available on Windows.
</p>

<p>
Header: 
</p>
<ul class="org-ul">
<li>&lt;stdio.h&gt; in C</li>
<li>&lt;cstdio&gt; in C++</li>
</ul>

<p>
<b>Documentation</b>
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/popen.html">Popen - opengroup()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=popen&amp;sektion=3&amp;manpath=freebsd-release-ports">FreeBSD Documentation</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Ppeline (Unix)</a></li>
</ul>

<p>
<b>Functions</b>
</p>

<p>
Popen: 
</p>
<ul class="org-ul">
<li>This function executes: 'sh -c &lt;COMMAND&gt;' via, fork() + exec()
and pipe(), returning a file stream. Note: sh is a unix-shell.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FILE</span>* <span class="org-function-name">popen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">command</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Pclose
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span>  <span class="org-function-name">pclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FILE</span>* <span class="org-variable-name">stream</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Application</b> 
</p>

<p>
File: popen-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Provides; popen(), pclose()</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdio</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 1 - popen() using buffer ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to: fork() + exec() + pipe()</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ls /"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>fd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">"Error: failed to run command. Check ERRNO variable. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
         <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer initialized with null char </span>
         <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">]</span> = <span class="org-rainbow-delimiters-depth-3">{</span>0<span class="org-rainbow-delimiters-depth-3">}</span>;

         <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> fgets<span class="org-rainbow-delimiters-depth-4">(</span>buffer, BUFFER_SIZE, fd<span class="org-rainbow-delimiters-depth-4">)</span> != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">"%s"</span>, buffer<span class="org-rainbow-delimiters-depth-4">)</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;        
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 2 - popen() reading line-by-line ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ps -ef"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-type">char</span>*   <span class="org-variable-name">pline</span> = <span class="org-constant">nullptr</span>; 
         <span class="org-type">size_t</span>  <span class="org-variable-name">size</span>  = 0; 
         <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
         <span class="org-type">int</span>     <span class="org-variable-name">count</span> = 0;
         <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-3">{</span>
            nread = getdelim<span class="org-rainbow-delimiters-depth-4">(</span>&amp;pline, &amp;size, <span class="org-string">'\n'</span>, fd<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; count++ &lt;&lt; <span class="org-string">"]"</span> &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; pline;
         <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> nread != -1 &amp;&amp; count &lt; 8<span class="org-rainbow-delimiters-depth-3">)</span>;
         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ popen-test.cpp -o <span class="org-keyword">popen-test</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">  $ ./popen-test 

   === EXPERIMENT 1 - popen() using buffer ========

  bin
  boot
  dev
  etc
  home
<span class="org-builtin">.</span> .... ... ... ... 
  ... ... ... ... ...
  usr
  var

   === EXPERIMENT 2 - popen() reading line-by-line ========

    [0] =&gt; UID          PID    PPID  C STIME TTY          TIME CMD
    [1] =&gt; root           1       0  0 Jun08 ?        00:48:25 /usr/lib/systemd/systemd ... ... ...
    [2] =&gt; root           2       0  0 Jun08 ?        00:00:00 [kthreadd]
    [3] =&gt; root           3       2  0 Jun08 ?        00:00:00 [rcu_gp]
    [4] =&gt; root           4       2  0 Jun08 ?        00:00:00 [rcu_par_gp]
    [5] =&gt; root           6       2  0 Jun08 ?        00:00:00 [kworker/0:0H-events_highpri]
    [6] =&gt; root           9       2  0 Jun08 ?        00:00:00 [mm_percpu_wq]
    [7] =&gt; root          10       2  0 Jun08 ?        00:00:54 [ksoftirqd/0]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4e4a45" class="outline-3">
<h3 id="orgb4e4a45"><span class="section-number-3">1.22</span> Unix Pipes - Inter Process Communication</h3>
<div class="outline-text-3" id="text-1-22">
<p>
Unix pipe is an inter-process communication facility which allows the
output of a process to be the input of a another. It can be used for
reading the output of a subprocess. 
</p>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?pipe(2)">FreeBSD - pipe()</a></li>

<li><a href="https://linuxhint.com/dup2_system_call_c/">Dup2 - system call</a></li>

<li><a href="https://en.wikipedia.org/wiki/Dup_(system_call)">Dup (system call)</a></li>

<li><a href="https://www.gnu.org/software/libc/manual/html_node/Duplicating-Descriptors.html">Duplicating Descriptors - GNU GlibC</a></li>

<li><a href="https://www-users.cs.umn.edu/~kauffman/4061/05-io-files-pipes.pdf">CSCI 4061: Input/Output with Files, Pipes</a></li>

<li><a href="http://unixwiz.net/techtips/remap-pipe-fds.html">http://unixwiz.net/techtips/remap-pipe-fds.html</a></li>

<li><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/node23.html">Inter Process Communication (IPC), pipes</a></li>

<li><a href="http://perugini.cps.udayton.edu/teaching/books/SPUC/www/lecture_notes/pipes.html">IPC - I/O Redirection &amp; IPC, &amp; Special Files: Unamed &amp; Named Pipes, FIFOs</a></li>

<li><a href="https://www.cs.purdue.edu/homes/grr/SystemsProgrammingBook/Book/Chapter5-WritingYourOwnShell.pdf">Chapter 5 - Writing Your Own Shell</a></li>
</ul>

<p>
<b>Main Functions</b> 
</p>

<p>
Function pipe()
</p>

<ul class="org-ul">
<li>Encapsulates: pipe() system-call</li>

<li>Linux Manpage: "pipe() creates a pipe, a unidirectional data
channel that can be used for interprocess communication.  The
array pipefd is used to return two file descriptors referring to
the ends of the pipe.  pipefd[0] refers to the read end of the
pipe.  pipefd[1] refers to the write end of the pipe."</li>

<li>pipefd[0] =&gt; File descriptor for reading the pipe.</li>

<li>pipefd[1] =&gt; File descriptor for writing to the pipe.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">pipe</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pipefd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Function dup2()
</p>

<ul class="org-ul">
<li>Encapsulates: dup2() system-call</li>

<li>Duplicate file descriptor, used for IO redirection.</li>

<li>dup2( fd1, STDOUT_FILENO ) =&gt; Example: redirect current process'
stdout to file descriptor fd1.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dup2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">oldfd</span>, <span class="org-type">int</span> <span class="org-variable-name">newfd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Code</b> 
</p>

<p>
This code spawns a subprocess using fork() + exec() and uses pipes to
read the subprocess output which are stdout and stderr of the "ls -l -a /".  
</p>

<p>
File: pipe-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Unix headers --------// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Application to be called or its absolute path */</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span> = <span class="org-string">"ls"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments ('-l' '-a' '/') for ls -l -a /</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">First argument - process name (can be anything)   */</span>  
                             <span class="org-string">"ls"</span> 
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Arguments passed to application */</span>
                            , <span class="org-string">"-l"</span>, <span class="org-string">"-a"</span>, <span class="org-string">"/"</span>
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Sentinel value - always nullptr */</span>
                            , <span class="org-constant">nullptr</span>  
                         <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_READ</span> = 0;
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_WRITE</span> = 1;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Create pipe IPC channel --------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> pipe<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">){</span>
       <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: cannot create pipe \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Fork() ----------------//</span>

    <span class="org-type">pid_t</span> <span class="org-variable-name">cpid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;         
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == 0<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">/** </span><span class="org-comment">------- BEGIN of child process ------ **/</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;       

        <span class="org-comment-delimiter">// </span><span class="org-comment">Connect child process' stdin to read-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stdout (STDOUT_FILENO) to the write-end of the pipe. </span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDOUT_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stderr to write-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDERR_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Run process - exec() syscall =&gt; the new process image </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">has the same PID as the child process. </span>
        execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> 0;          
        <span class="org-comment-delimiter">/** </span><span class="org-comment">------- END of child process ------ **/</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">---- Continue parent process ---------//</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFSIZE</span> = 200;
     <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
     <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFSIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Close unnused end of the pipe.</span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Write bytes read from the pipe (write-end), written by child process</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">, to the stdout.</span>
     <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>   
          nread = read<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;buffer, BUFSIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
          write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, nread<span class="org-rainbow-delimiters-depth-3">)</span>;      
     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span> nread &gt; 0<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process termination. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination </span>
     ::wait<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;

     <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">-- End of main() --- //</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ &gt;&gt; g++ pipe-test.cpp -o <span class="org-keyword">pipe-test.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">
<pre class="src src-cpp"> $ &gt;&gt; ./pipe-test.bin 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">AFTER</span> <span class="org-variable-name">FORK</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> PID of parent process = 1352693 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Child process =&gt; PID_CHILD = 1352694 
total 72
dr-xr-xr-x.  18 root root  4096 May 17 21:36 .
dr-xr-xr-x.  18 root root  4096 May 17 21:36 ..
-rw-r--r--    1 root root     0 May 17 21:36 .autorelabel
lrwxrwxrwx.   1 root root     7 Jan 28 15:30 bin -&gt; usr/bin
dr-xr-xr-x.   6 root root  4096 May 17 15:17 boot
drwxr-xr-x   21 root root  4200 Jun 28 19:22 dev
... ... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 
lrwxrwxrwx.   1 root root     8 Jan 28 15:30 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root  4096 May 12 14:50 srv
dr-xr-xr-x   13 root root     0 Jun  8 11:58 sys
drwxrwxrwt   31 root root   680 Jun 30 04:02 tmp
drwxr-xr-x.  12 root root  4096 Apr 22 19:35 usr
drwxr-xr-x.  22 root root  4096 Apr 22 19:39 var
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Waiting <span class="org-keyword">for</span> child process termination. 
</pre>
</div>
</div>
</div>

<div id="outline-container-org9096607" class="outline-3">
<h3 id="org9096607"><span class="section-number-3">1.23</span> Monitor file system changes with Inotify API</h3>
<div class="outline-text-3" id="text-1-23">
</div>
<div id="outline-container-orgfecc012" class="outline-4">
<h4 id="orgfecc012"><span class="section-number-4">1.23.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-23-1">
<p>
Inotify is an exclusive Linux kernel API for file monitoring, which
allows watching file system changes events such as file copy, moving,
creation, renaming and deletion without any wasteful and inefficient
polling. BSD-variants, such as MacOSX and FreeBSD use the <a href="https://www.freebsd.org/cgi/man.cgi?kqueue">kqueue</a> API. 
</p>

<p>
Inotify API limitations: 
</p>

<ul class="org-ul">
<li>Cannot monitor network mounted file systems.</li>

<li>Unable to watch /proc (PROCFS) virtual file systems (VSF)</li>

<li>Cannot monitor sub-directories. It is necessary to add new Inotify
watch instances for every sub-directory to be monitored.</li>
</ul>

<p>
Some use-cases of file system monitoring via Inotify API are:
</p>

<ul class="org-ul">
<li>File system automation</li>

<li>Building system automation</li>

<li>Automatic recompilation whenever a dependency changes</li>

<li>Reloading application if some configuration file changes.</li>

<li>Reloading of game asset if some file change.</li>

<li>Executing some action, command or process when a file system event happens.</li>
</ul>


<p>
<b>Functions and Structures</b> 
</p>

<p>
Headers: 
</p>

<ul class="org-ul">
<li>&lt;sys/inotify.h&gt; - See manpage: ( <a href="https://manpages.ubuntu.com/manpages/xenial/man7/inotify.7.html">Ubuntu Inotify Manpage</a> )</li>
</ul>

<p>
Functions: 
</p>

<ul class="org-ul">
<li><span class="underline">inotify_init()</span> =&gt; Returns a file descriptor (numerical value) for
an <span class="underline">inotify</span> instance. On failure, returns -1 and sets the <i>errno</i>
thread-local-storage global variable.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">inotify_init</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-type">int</span> <span class="org-function-name">inotify_init1</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">inotify_watch_add()</span> =&gt; Add new file system watch.
<ul class="org-ul">
<li>Parameters:
<ul class="org-ul">
<li>fd       =&gt; File descriptor of inotify instance, created with
<span class="underline">inotify_init</span> function.</li>
<li>pathname =&gt; Path to directory or file what will be monitored.</li>
<li>mask     =&gt; bitwise mask of flags that selects the types of
events that will be monitored.</li>
<li>RETURN =&gt; Returns (-1) on failure and any other value when the
operation is successful.</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">inotify_add_watch</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>, <span class="org-type">uint32_t</span> <span class="org-variable-name">mask</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">inotify_rm_watch()</span> =&gt; Removes file system watch.
<ul class="org-ul">
<li>Parameters:
<ul class="org-ul">
<li>fd =&gt; Inotify file descritor created with inotify_init() function.</li>
<li>wd =&gt; Watch file descriptor created with inotify_watch_add.</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">inotify_rm_watch</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">int</span> <span class="org-variable-name">wd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Structure: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">inotify_event</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>      <span class="org-variable-name">wd</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">Watch (watcher file descriptor) descriptor */</span>
    <span class="org-type">uint32_t</span> <span class="org-variable-name">mask</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">Mask of events */</span>
    <span class="org-type">uint32_t</span> <span class="org-variable-name">cookie</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Unique cookie associating related</span>
<span class="org-comment">                          events (for rename(2)) */</span>
    <span class="org-type">uint32_t</span> <span class="org-variable-name">len</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of name field =&gt; File or directory name. */</span>
    <span class="org-type">char</span>     <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">[]</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Optional null-terminated name */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>References</b> 
</p>

<ul class="org-ul">
<li><i>inotify(7) - Linux man page</i>
<ul class="org-ul">
<li><a href="https://linux.die.net/man/7/inotify">https://linux.die.net/man/7/inotify</a></li>
</ul></li>

<li><i>Ubuntu Manpage - inotify - monitoring filesystem events</i>
<ul class="org-ul">
<li><a href="https://manpages.ubuntu.com/manpages/xenial/man7/inotify.7.html">https://manpages.ubuntu.com/manpages/xenial/man7/inotify.7.html</a></li>
</ul></li>

<li><i>inotify - a powerful yet simple file change notification system</i>
<ul class="org-ul">
<li><a href="https://www.kernel.org/doc/Documentation/filesystems/inotify.txt">https://www.kernel.org/doc/Documentation/filesystems/inotify.txt</a></li>
</ul></li>

<li><i>Inotify: Efficient, Real-Time Linux File System Event Monitoring</i>
<ul class="org-ul">
<li><a href="https://www.infoq.com/articles/inotify-linux-file-system-event-monitoring/">https://www.infoq.com/articles/inotify-linux-file-system-event-monitoring/</a></li>
</ul></li>

<li><i>Filesystem notification, part 1: An overview of dnotify and inotify</i>
<ul class="org-ul">
<li><a href="https://lwn.net/Articles/604686/">https://lwn.net/Articles/604686/</a></li>
</ul></li>

<li><i>What is the proper way to use inotify?</i>
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/4062806">https://stackoverflow.com/questions/4062806</a></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga74b544" class="outline-4">
<h4 id="orga74b544"><span class="section-number-4">1.23.2</span> Sample code</h4>
<div class="outline-text-4" id="text-1-23-2">
<p>
All files available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/6e3fc8a39a3a6089ad7002738e4d509a">https://gist.github.com/6e3fc8a39a3a6089ad7002738e4d509a</a></li>
</ul>


<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">inotify-test.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">strerror()</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">map</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Unix-specific headers ----------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Linux-specific headers --------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/inotify.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">FAILURE</span> = -1;

<span class="org-type">void</span> <span class="org-function-name">exit_on_failure</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">error_message</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd != FAILURE<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [ERROR] %s ; errno = %d ; errno-msg = %s \n"</span>
                  , error_message, err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Execute exit system call and terminate this process.</span>
    exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Create inotify instance, returning file descriptor </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd_inotify</span> = ::inotify_init<span class="org-rainbow-delimiters-depth-2">()</span>;
    exit_on_failure<span class="org-rainbow-delimiters-depth-2">(</span>fd_inotify, <span class="org-string">"Cannot create Inotify instance"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">WatcheFileDescriptor</span> = <span class="org-type">int</span>;
    <span class="org-keyword">using</span> <span class="org-type">DirectoryPath</span>       = <span class="org-constant">std</span>::string;
    <span class="org-keyword">auto</span> <span class="org-variable-name">watch_table</span>          = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">WatcheFileDescriptor</span>, <span class="org-type">DirectoryPath</span><span class="org-rainbow-delimiters-depth-2">&gt;{}</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Requires one or more directories to be watched. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 1; i &lt; argc; i++<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">directory</span> = argv<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Create watch instance, returning a file descriptor for the watcher </span>
        <span class="org-type">int</span> <span class="org-variable-name">fd_watch</span> = inotify_add_watch<span class="org-rainbow-delimiters-depth-3">(</span>fd_inotify, directory, IN_ALL_EVENTS<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Error checking </span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">error_msg</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Cannot create watcher for this directory: "</span><span class="org-rainbow-delimiters-depth-3">)</span> + directory;
        exit_on_failure<span class="org-rainbow-delimiters-depth-3">(</span>fd_watch, error_msg.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        watch_table<span class="org-rainbow-delimiters-depth-3">[</span>fd_watch<span class="org-rainbow-delimiters-depth-3">]</span> = directory; 

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span> stdout, <span class="org-string">" [INFO] Watching directory =&gt; wd = %d ; directory = %s \n"</span>
                    , fd_watch, directory<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Maximum number of events </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_EVENTS</span> = 1024;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Size of data structure inotify_event in bytes </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">EVENT_SIZE</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">struct</span> <span class="org-type">inotify_event</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Lenght of buffer for events storage in bytes </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_LENGTH</span> = MAX_EVENTS * <span class="org-rainbow-delimiters-depth-2">(</span> EVENT_SIZE + NAME_MAX + 1 <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::<span class="org-type">uint8_t</span>     <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_LENGTH<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">-------------- Inotify event loop ----------------//</span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [INFO] Waiting for Inotify event \n");        </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">nn_read =&gt; signed number of bytes read from the file descriptor</span>
        <span class="org-comment-delimiter">//            </span><span class="org-comment">It is (-1) in the case of errrors.</span>
        <span class="org-type">ssize_t</span> <span class="org-variable-name">nn_read</span> = read<span class="org-rainbow-delimiters-depth-3">(</span>fd_inotify, buffer, BUFFER_LENGTH<span class="org-rainbow-delimiters-depth-3">)</span>;
        assert<span class="org-rainbow-delimiters-depth-3">(</span>nn_read != -1 &amp;&amp; <span class="org-string">"Placeholder for future error handling."</span><span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-type">ssize_t</span> <span class="org-variable-name">offset</span> = 0;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Iterate over all events </span>
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> offset &lt; nn_read <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">event</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">inotify_event</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>buffer + offset<span class="org-rainbow-delimiters-depth-4">)</span>;        
            <span class="org-keyword">auto</span> <span class="org-variable-name">directory</span> = watch_table<span class="org-rainbow-delimiters-depth-4">[</span>event-&gt;wd<span class="org-rainbow-delimiters-depth-4">]</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Create file</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>event-&gt;mask &amp; IN_CREATE &amp;&amp;  <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-5">(</span>event-&gt;mask &amp; IN_ISDIR<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout
                            , <span class="org-string">" [INFO] CREATE file event =&gt; (file = %s ) ; (dir = %s) \n"</span>
                            , event-&gt;name, directory.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Create directory event </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>event-&gt;mask &amp; IN_CREATE &amp;&amp; event-&gt;mask &amp; IN_ISDIR <span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stdout
                            , <span class="org-string">" [INFO] CREATE directory  event =&gt; (file = %s ) ; (dir = %s)  \n"</span>
                            , event-&gt;name, directory.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Delete file or directory event. </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>event-&gt;mask &amp; IN_DELETE<span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stdout, <span class="org-string">" [INFO] DELETE file event  =&gt; (file = %s ) ; (dir = %s)  \n"</span>
                            , event-&gt;name, directory.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Modify file </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> event-&gt;mask &amp; IN_MODIFY  &amp;&amp; <span class="org-negation-char">!</span><span class="org-rainbow-delimiters-depth-5">(</span>event-&gt;mask &amp; IN_ISDIR<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stdout
                            , <span class="org-string">" [INFO] MODIFY file event   =&gt; (file = %s ) ; (dir = %s) \n"</span>
                            , event-&gt;name, directory.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event happens when file system is unmounted. </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>event-&gt;mask &amp; IN_IGNORED<span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stdout
                            , <span class="org-string">" [INFO] IGNRED file monitor removed or file system unmounted =&gt; dir = %s \n"</span>
                            , directory.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            offset = offset + EVENT_SIZE + event-&gt;len;
        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--------- End of Inotify event loop() --------------//</span>

    <span class="org-comment-delimiter">//</span><span class="org-comment">free(event);</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] Terminate application gracefully \n\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd_inotify<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/6e3fc8a39a3a6089ad7002738e4d509a inotify-gist &amp;&amp; <span class="org-builtin">cd</span> inotify-gist 
$ g++ inotify-test.cpp -o <span class="org-keyword">inotify-test.bin</span> -std=c++1z -Wall -Wextra -g

$ file inotify-test.bin 
<span class="org-function-name">inotify-test.bin</span>: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), .... ...
</pre>
</div>

<p>
<b>Running:</b> 
</p>

<p>
Run the following command from terminal emulator 1:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./inotify-test.bin /tmp/testing  ~/Downloads 
 [INFO] Watching directory =&gt; wd = 1 ; directory = /tmp/testing 
 [INFO] Watching directory =&gt; wd = 2 ; directory = /home/unixuser/Downloads 

 [INFO] CREATE file event =&gt; (file = file1.txt ) ; (dir = /tmp/testing) 
 [INFO] CREATE file event =&gt; (file = file2.txt ) ; (dir = /tmp/testing) 
 [INFO] CREATE file event =&gt; (file = file3.txt ) ; (dir = /tmp/testing) 
 [INFO] CREATE file event =&gt; (file = file4.txt ) ; (dir = /tmp/testing) 
 [INFO] DELETE file event  =&gt; (file = file1.txt ) ; (dir = /tmp/testing)  
 [INFO] CREATE file event =&gt; (file = testing-files1.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] CREATE file event =&gt; (file = testing-files2.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] CREATE file event =&gt; (file = testing-files3.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] CREATE file event =&gt; (file = testing-files4.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] DELETE file event  =&gt; (file = file2.txt ) ; (dir = /tmp/testing)  
 [INFO] DELETE file event  =&gt; (file = file3.txt ) ; (dir = /tmp/testing)  
 [INFO] DELETE file event  =&gt; (file = file4.txt ) ; (dir = /tmp/testing)  
 [INFO] MODIFY file event   =&gt; (file = testing-files1.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] MODIFY file event   =&gt; (file = testing-files2.txt ) ; (dir = /home/unixuser/Downloads) 
 [INFO] MODIFY file event   =&gt; (file = testing-files2.txt ) ; (dir = /home/unixuser/Downloads) 
</pre>
</div>

<p>
Manipulate the watched directories from terminal emulator 2: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ mkdir -p /tmp/testing &amp; <span class="org-builtin">cd</span> /tmp/testing 

$ &gt;&gt; touch file1.txt file2.txt file3.txt file4.txt

$ &gt;&gt; rm -rf file1.txt 

$ &gt;&gt; touch ~/Downloads/testing-files{1, 2, 3, 4}.txt 

$ &gt;&gt; rm -rf -v *.txt  
removed <span class="org-string">'file2.txt'</span>
removed <span class="org-string">'file3.txt'</span>
removed <span class="org-string">'file4.txt'</span>

$ &gt;&gt; echo <span class="org-string">"change file"</span> &gt;&gt; ~/Downloads/testing-files1.txt 

$ &gt;&gt; echo <span class="org-string">"change file"</span> &gt;&gt; ~/Downloads/testing-files2.txt

$ &gt;&gt; echo <span class="org-string">"change file"</span> &gt;&gt; ~/Downloads/testing-files2.txt
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8021256" class="outline-3">
<h3 id="org8021256"><span class="section-number-3">1.24</span> mmap - Memory Mapping</h3>
<div class="outline-text-3" id="text-1-24">
</div>
<div id="outline-container-org1011bbe" class="outline-4">
<h4 id="org1011bbe"><span class="section-number-4">1.24.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-24-1">
<p>
File mapping is an operating system mechanism which maps a disk file
to a process virtual memory. This operating system feature allows
accessing the file as it was in the process memory. 
</p>

<p>
Benefits: 
</p>

<ul class="org-ul">
<li>Transparent access to file, allows accessing the file as it was an
ordinary memory. (the file is accessible by pointer)</li>

<li>Good for processing large files which does not fit in the machine
RAM memory.</li>
</ul>

<p>
Use-cases: 
</p>

<ul class="org-ul">
<li>Read large files</li>

<li>IPC - Inter-Process Communication</li>

<li>Process complicated binary files</li>

<li>Modify complex binary files. The file can be modified by just
changing a memory, in other words, modifying the contents of a
memory address.</li>

<li>Implement JIT - Just-In-Time compiler and execute assembly code at runtime.</li>
</ul>

<p>
The <span class="underline">mmap API</span> is available in most Unix-like operating systems: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>BSD-family: MacOSX, FreeBDS, NetBSD, OpenBSD</li>
<li>Solaris</li>
<li>QNX, AIX</li>
</ul>

<p>
<b>Mmap API functions</b>
</p>

<p>
File descriptors: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Returns file descriptor of a disk-file </span>
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptor (release resource)</span>
<span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Mmap: 
</p>

<ul class="org-ul">
<li>Doc: $ man mmap</li>
<li>Linux Manpage Description: "mmap() creates a new mapping in the
virtual address space of the calling process.  The starting
address for the new mapping is specified in addr.  The length
argument speci‐ fies the length of the mapping (which must be
greater than 0)"</li>

<li>Argument: <span class="underline">prot</span> (Memory Protection)
<ul class="org-ul">
<li>PROT_READ  =&gt; Pages may be written (most used)</li>
<li>PROT_WRITE =&gt; Pages may be written (allows changing the file by writing to the mapped memory)</li>
<li>PROT_NONE  =&gt; Pages may not be accessed</li>
<li>PROT_EXEC  =&gt; Pages may be executed =&gt; Allows executing machine
code (assembly) at runtime. Use case: JIT - Just-In-Time
compiler</li>
</ul></li>

<li>Argument: <span class="underline">flags</span>
<ul class="org-ul">
<li>MAP_SHARED  =&gt; Multiple processes can share the same <span class="underline">file</span>
<span class="underline">mapping</span>. This flag is used for IPC - Inter Process
Communication.</li>
<li>MAP_PRIVATE =&gt; Only the current process can access the file mapping.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>* <span class="org-function-name">mmap</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">void</span>*   <span class="org-variable-name">addr</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">(often nullptr) Address that the file will be mapped </span>
           , <span class="org-type">size_t</span>  <span class="org-variable-name">length</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Length of file mapping (often the file size)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">prot</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for memory protection </span>
           , <span class="org-type">int</span>     <span class="org-variable-name">flags</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for process access conttrol (private | shared)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">fd</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor to be mapped into virtual memory</span>
           , <span class="org-type">off_t</span>   <span class="org-variable-name">offset</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">(often zero) Offset from the beginning of the file </span>
          <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
munmap:
</p>

<ul class="org-ul">
<li>Doc: $ man munmap</li>
<li>Linux Manpage doc: "The munmap() system call deletes the mappings
for the specified address range, and causes further references to
addresses within the range to generate invalid memory ref‐
erences.  The region is also automatically unmapped when the
process is terminated.  On the other hand, closing the file
descriptor does not unmap the region."</li>

<li>Param <span class="underline">addr</span>: Address of memory mapping (value returned by mmap)</li>

<li>Param <span class="underline">length:</span> length of file mapping, often it is the file size.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">For mmap and munmap </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>     

<span class="org-type">int</span> <span class="org-function-name">munmap</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">void</span> *<span class="org-variable-name">addr</span>, <span class="org-type">size_t</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Hyperlinks to manpage documentation of related-functions: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/2/mmap">mmap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/remap_file_pages">remap_file_pages</a></li>

<li><a href="https://linux.die.net/man/2/mremap">mremap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/msync">msync</a></li>
</ul>


<p>
<b>References and further reading</b> 
</p>

<p>
General: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Mmap">mmap - Wikipedia</a></li>

<li><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemAdvancedPT/MappingFilesIntoMemory/MappingFilesIntoMemory.html">Apple - Mapping Files Into Memory</a></li>

<li><a href="https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Programmation SystèmeCours 5 — Memory Mapping</a> (<a href="http://web.archive.org/web/20200622232258/https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Web Archive</a>)</li>

<li><a href="https://unix.stackexchange.com/questions/474926/how-does-memory-mapping-a-file-have-significant-performance-increases-over-the-s/475014">How does memory mapping a file have significant performance increases over the standard I/O system calls?</a></li>

<li><a href="https://courses.engr.illinois.edu/cs241/sp2014/lecture/27-IPC.pdf">Interprocess Communication: Memory mapped files and pipes</a></li>

<li><a href="http://web.cs.ucla.edu/honors/UPLOADS/kousha/thesis.pdf">Linux Memory Mapped System Call Performance</a></li>

<li><a href="https://w3.cs.jmu.edu/kirkpams/OpenCSF/Books/csf/html/MMap.html">Shared Memory with Memory-Mapped Files</a></li>

<li><a href="https://www.sublimetext.com/blog/articles/use-mmap-with-care">Use mmap With Care - Sublime HQ</a></li>

<li><a href="http://www.idryman.org/blog/2017/06/28/opic-a-memory-allocator-for-fast-serialization/">Writing a Memory Allocator for Fast Serialization</a></li>

<li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2044.html">Paper: Memory Mapped Files And Shared Memory For C++</a></li>

<li><a href="https://indico.cern.ch/event/658060/contributions/2898569/attachments/1622526/2582399/pivarski-serialization.pdf">Overview of Serialization Technologies</a> - CERN</li>

<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/hotstorage17_slides_choi.pdf">Efficient Memory Mapped File I/O for In-Memory File Systems</a></li>

<li><a href="https://engineering.mongodb.com/post/getting-storage-engines-ready-for-fast-storage-devices">Getting storage engines ready for fast storage devices</a></li>

<li><a href="http://blogs.networkingfutures.co.uk/post/2015/12/28/Windows-Services-Implementing-Non-Persisted-Memory-Mapped-Files-Exposing-IPC-Style-Communications.aspx">Introduction to Memory Mapped Files</a> (.NET Specific)</li>
</ul>


<p>
MMAP - File Memory Mapping for other programming languages
</p>

<ul class="org-ul">
<li><a href="https://docs.rs/flatdata/0.5.0/flatdata/">https://docs.rs/flatdata/0.5.0/flatdata/</a> (Rust library for mmap)</li>

<li><a href="https://www.red-gate.com/simple-talk/dotnet/net-development/sharing-caring-using-memory-mapped-files-net/">Sharing is Caring: Using Memory Mapped Files in .NET</a></li>

<li><a href="https://coders-corner.net/2013/03/22/inter-process-communication-with-memory-mapped-files-part-01-transfer-a-data-structure-and-an-object/">Inter-Process Communication with Memory-Mapped Files, Part 01</a></li>

<li><a href="https://github.com/jampp/sharedbuffers/">Python SharedBuffer - library for mmap</a></li>

<li><a href="https://docs.julialang.org/en/v1/stdlib/Mmap/">https://docs.julialang.org/en/v1/stdlib/Mmap/</a> - Julia Language library for mmap (memory-mapped files)</li>

<li><a href="https://engineering.indeedblog.com/blog/2015/02/memory-mapping-with-util-mmap/">Memory Mapping with util-mmap</a> - mmap for Java.</li>
</ul>
</div>
</div>
<div id="outline-container-org64e002d" class="outline-4">
<h4 id="org64e002d"><span class="section-number-4">1.24.2</span> Example (C) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-24-2">
<p>
This code uses mmap API (memory mapped files) for reading metadata
from PE (Portable Executable) - Windows native executable files or
windows object-code. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.c 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdint.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">assert.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span>            8
<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span>  16

<span class="org-keyword">typedef</span> <span class="org-type">int32_t</span>  <span class="org-type">LONG</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint16_t</span> <span class="org-type">WORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">DWORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint8_t</span>  <span class="org-type">BYTE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint64_t</span> <span class="org-type">ULONGLONG</span>;;

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">IMAGE_DOS_HEADER</span>;

 <span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">PE_HEADER</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> -1;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>size == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get file size \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">NULL</span>        <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-type">unsigned</span> <span class="org-type">char</span>* <span class="org-variable-name">bmap</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap + dos_header-&gt;e_lfanew;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ gcc unix-mmap.c -o <span class="org-keyword">unix-mmap-c.bin</span> -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-c.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 

</pre>
</div>
</div>
</div>
<div id="outline-container-orgfb4c6ee" class="outline-4">
<h4 id="orgfb4c6ee"><span class="section-number-4">1.24.3</span> Example (C++) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-24-3">
<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">nullptr</span>     <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> bmap = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-3">)</span> fmap + dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ unix-mmap.cpp -o <span class="org-keyword">unix-mmap.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap.bin ipconfig.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xE8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 6 


$ ./unix-mmap.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf1e13c7" class="outline-4">
<h4 id="orgf1e13c7"><span class="section-number-4">1.24.4</span> Example (C++) - mmap for reading Windows PE32 with class</h4>
<div class="outline-text-4" id="text-1-24-4">
<p>
This code uses a class FileMapping for encapsulating Unix
memory-mapped files which simplifies the usage of the mmap feature and
makes the code cleaner and safer. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap-class.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Class for encapsulating memory mapped files*/</span>
<span class="org-keyword">class</span> <span class="org-type">FileMapping</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>   <span class="org-variable-name">m_fd</span>      = -1; 
    <span class="org-type">void</span>* <span class="org-variable-name">m_addr</span>    = <span class="org-constant">nullptr</span>; 
    <span class="org-type">ssize_t</span> <span class="org-variable-name">m_size</span>  = -1;

    <span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> fstat<span class="org-rainbow-delimiters-depth-4">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-4">)</span> == -1 <span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> file_stat.st_size;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">public</span>: 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor </span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy assignment operator </span>
    <span class="org-type">FileMapping</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;    

    <span class="org-comment-delimiter">/** </span>
<span class="org-comment">     * @param file_path - File to be memory-mapped to current process. </span>
<span class="org-comment">     */</span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file_path</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
        m_fd = open<span class="org-rainbow-delimiters-depth-3">(</span>file_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_fd == -1<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Unable to open file"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>      

        m_size = get_file_size<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_size == -1<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        m_addr = ::mmap<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">nullptr</span>     
                        , m_size       
                        , PROT_READ   
                        , MAP_PRIVATE 
                        , m_fd        
                        , 0x00        
                    <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> m_addr == MAP_FAILED<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: failed to map file to memory"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span>

    ~<span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
        munmap<span class="org-rainbow-delimiters-depth-3">(</span>m_addr, m_size<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
        close<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;

        m_fd = -1;
        m_addr = <span class="org-constant">nullptr</span>;
        m_size = -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Returns pointer file mapping address. */</span>
    <span class="org-type">void</span>* <span class="org-function-name">addr</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_addr; <span class="org-rainbow-delimiters-depth-2">}</span>  

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief  Get casted pointer to an offset of the file mapping address. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">T</span> <span class="org-function-name">addr_rel</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">ptrdiff_t</span> <span class="org-variable-name">offset</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>m_addr<span class="org-rainbow-delimiters-depth-4">)</span> + offset<span class="org-rainbow-delimiters-depth-3">)</span>;  
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class FileMapping ---- //</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">FileMapping</span> <span class="org-variable-name">fmap</span><span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> bmap = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-mmap-class.cpp -o <span class="org-keyword">unix-mmap-class.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-class.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
<div id="outline-container-org5688fea" class="outline-4">
<h4 id="org5688fea"><span class="section-number-4">1.24.5</span> Example - mmap - Running machine code at runtime</h4>
<div class="outline-text-4" id="text-1-24-5">
<p>
The <span class="underline">mmap</span> posix system call and the APIs <span class="underline">mprotect</span> can be used for
allocating memory with executable permission which allows writing and
executing machine code at runtime. This feature is widely used by JIT
(Just-In-Time) compilers of interpreted languages such as Julia and 
Javascript Engine V8, from Chrome browser, for improving the
runtime performance and reducing the interpretation overhead.
</p>

<p>
Additional notes related to: mmap, assembly and machine code.
</p>

<ul class="org-ul">
<li>Note 1: The function mmap is also available on other Unix-like
operating systems such as MacOSx, BSD-variants (FreeBSD, OpenBSD,
NetBSD, DragonFly BSD) and so on.</li>

<li>Note 2: The the assembly x64 ISA (x86-64 AMD or Intel) is the same
on all operating system that supports this ISA (Instruction Set
Architecture). However, an object-code (machine code) from one
operating system will not be compatible with another different
operating system due the difference between the object-code binary
format (Linux uses ELF; MacOSX uses MachO; Windows uses PE32);
<span class="underline">system calls</span>; <span class="underline">calling conventions</span> and system shared libraries.</li>

<li>Note 3: On Windows NT kernels the equivalent functions are:
<a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc</a> (equivalent to mmap) and <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a> (mprotect).</li>

<li>Note 4: Most Unix system uses the System V calling convention for
x86-64 bits while Windows NT 64 bits uses a different callng
convention.</li>
</ul>

<p>
<b>Sample Code</b>
</p>

<p>
The following sample application mmap-loader.cpp loads machine code
(compiled assembly) for two functions, at runtime. The machine codes
were extract from compiled C application with objdump GNU binutils
tool.
</p>

<p>
GIST (Sources files): 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/4baf7dab5728d0e8f5a475967c0846b5">https://gist.github.com/4baf7dab5728d0e8f5a475967c0846b5</a></li>
</ul>

<p>
File: <span class="underline">mmap-loader.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-comment-delimiter">// </span><span class="org-comment">=======&gt;&gt;&gt; Load and execute machine code at runtime with mmap &lt;&lt;&lt;======</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdlib</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">using</span> <span class="org-type">byte</span> = uint8_t;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Load machine code into process virtual memory */</span>
<span class="org-type">void</span>* <span class="org-function-name">load_machine_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">byte</span>* <span class="org-variable-name">buffer</span>, <span class="org-constant">std</span>::<span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>* <span class="org-function-name">load_machine_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
hexstr_to_bytes<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">hexcode</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">inline</span> <span class="org-type">T</span> <span class="org-function-name">load_mcode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> load_machine_code<span class="org-rainbow-delimiters-depth-3">(</span>data<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ====== Load add_numbers from machine code ================"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">'extern' means that the variable will be resolved by the Linker</span>
    <span class="org-keyword">extern</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">add_numbers_str</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer</span>
    <span class="org-keyword">using</span> <span class="org-type">add_numbers_t</span> = <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span>, <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">add_numbers_code</span> = hexstr_to_bytes<span class="org-rainbow-delimiters-depth-2">(</span>add_numbers_str<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load machine code for function add_numbers() at runtime.</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">add_numbers</span>  = load_mcode<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">add_numbers_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>add_numbers_code<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] add_numbers(20, 100) = "</span> &lt;&lt; add_numbers<span class="org-rainbow-delimiters-depth-2">(</span>20, 100<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] add_numbers(206, 782) = "</span> &lt;&lt; add_numbers<span class="org-rainbow-delimiters-depth-2">(</span>206, 782<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;


    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== Load factorial() from machine code ============="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">extern</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">factorial_code</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Function pointer alias</span>
    <span class="org-keyword">using</span> <span class="org-type">factorial_t</span> = <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">factorial_func</span> = load_mcode<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">factorial_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>factorial_code<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] factorial(5) = "</span> &lt;&lt; factorial_func<span class="org-rainbow-delimiters-depth-2">(</span>5<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] factorial(6) = "</span> &lt;&lt; factorial_func<span class="org-rainbow-delimiters-depth-2">(</span>6<span class="org-rainbow-delimiters-depth-2">)</span>  &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] factorial(7) = "</span> &lt;&lt; factorial_func<span class="org-rainbow-delimiters-depth-2">(</span>7<span class="org-rainbow-delimiters-depth-2">)</span>  &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [TRACE] Process terminated gracefully Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">===========================================================//</span>
<span class="org-comment-delimiter">//          </span><span class="org-comment">I M P L E M E N T A T I O N S                    //</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">===========================================================//</span>

<span class="org-type">void</span>* <span class="org-function-name">load_machine_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">byte</span>* <span class="org-variable-name">buffer</span>, <span class="org-constant">std</span>::<span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create anonymous mapping (not backed by file), a memory that will</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">be later marked as executable.</span>
    <span class="org-type">void</span>* <span class="org-variable-name">pmap</span> = ::mmap<span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-constant">nullptr</span>
                        , size
                        , PROT_READ | PROT_WRITE
                        , MAP_PRIVATE | MAP_ANONYMOUS
                        , -1, 0 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Failed create memory map"</span><span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Copy machine code to memory map</span>
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span> pmap, buffer, size<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Mark memory as executable, but not writable.</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> mprotect<span class="org-rainbow-delimiters-depth-3">(</span>pmap, size, PROT_READ | PROT_EXEC <span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Faile to change memory protection flags"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> pmap;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-function-name">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
hexstr_to_bytes<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">hexcode</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">bytes</span>;
    bytes.reserve<span class="org-rainbow-delimiters-depth-2">(</span>hexcode.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">char</span>* <span class="org-variable-name">token</span> = strtok<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">)</span> hexcode.data<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-string">"\\x"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> token != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-type">char</span> <span class="org-variable-name">byte</span> = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-3">)</span> strtol<span class="org-rainbow-delimiters-depth-3">(</span>token, <span class="org-constant">nullptr</span>, 16<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">ss &lt;&lt; byte;</span>
        bytes.push_back<span class="org-rainbow-delimiters-depth-3">(</span>byte<span class="org-rainbow-delimiters-depth-3">)</span>;
        token  = strtok<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">nullptr</span>, <span class="org-string">"\\x"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> bytes;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span>* <span class="org-function-name">load_machine_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> load_machine_code<span class="org-rainbow-delimiters-depth-2">(</span>&amp;data<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, data.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">int add_numners(int x, int y)</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">0000000000401152 &lt;add_numbers&gt;:</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">401152:       55                      push   %rbp</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">401153:       48 89 e5                mov    %rsp,%rbp</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">401156:       48 89 f8                mov    %rdi,%rax</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">401159:       48 01 f0                add    %rsi,%rax</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">40115c:       5d                      pop    %rbp</span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">40115d:       c3                      retq</span>
<span class="org-comment-delimiter">//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Machine encoded as ASCII string</span>
<span class="org-function-name">std</span>::string add_numbers_str = <span class="org-string">"\\x55\\x48\\x89\\xe5\\x48\\x89\\xf8\\x48\\x01\\xf0\\x5d\\xc3"</span>;

<span class="org-function-name">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">byte</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> factorial_code = <span class="org-rainbow-delimiters-depth-1">{</span>
          0x55                                      <span class="org-comment-delimiter">// </span><span class="org-comment">push   rbp</span>
        , 0x48, 0x89, 0xe5                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    rbp,rsp</span>
        , 0x89, 0x7d, 0xec                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    DWORD PTR [rbp-0x14],edi</span>
        , 0xc7, 0x45, 0xfc, 0x01, 0x00, 0x00, 0x00  <span class="org-comment-delimiter">// </span><span class="org-comment">mov    DWORD PTR [rbp-0x4],0x1</span>
        , 0xc7, 0x45, 0xf8, 0x01, 0x00, 0x00, 0x00  <span class="org-comment-delimiter">// </span><span class="org-comment">mov    DWORD PTR [rbp-0x8],0x1</span>
        , 0xeb, 0x0e                                <span class="org-comment-delimiter">// </span><span class="org-comment">jmp    40115b &lt;factorial+0x25&gt;</span>
        , 0x8b, 0x45, 0xfc                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    eax,DWORD PTR [rbp-0x4]</span>
        , 0x0f, 0xaf, 0x45, 0xf8                    <span class="org-comment-delimiter">// </span><span class="org-comment">imul   eax,DWORD PTR [rbp-0x8]</span>
        , 0x89, 0x45, 0xfc                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    DWORD PTR [rbp-0x4],eax</span>
        , 0x83, 0x45, 0xf8, 0x01                    <span class="org-comment-delimiter">// </span><span class="org-comment">add    DWORD PTR [rbp-0x8],0x1</span>
        , 0x8b, 0x45, 0xf8                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    eax,DWORD PTR [rbp-0x8]</span>
        , 0x3b, 0x45, 0xec                          <span class="org-comment-delimiter">// </span><span class="org-comment">cmp    eax,DWORD PTR [rbp-0x14]</span>
        , 0x7c, 0xea                                <span class="org-comment-delimiter">// </span><span class="org-comment">jl     40114d &lt;factorial+0x17&gt;</span>
        , 0x8b, 0x45, 0xfc                          <span class="org-comment-delimiter">// </span><span class="org-comment">mov    eax,DWORD PTR [rbp-0x4]</span>
        , 0x5d                                      <span class="org-comment-delimiter">// </span><span class="org-comment">pop    rbp</span>
        , 0xc3                                      <span class="org-comment-delimiter">// </span><span class="org-comment">ret </span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>Building and running on Linux</b> 
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ mmap-loader.cpp -o <span class="org-keyword">mmap-loader.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./mmap-loader.bin

====== Load add_numbers from machine code ================
[RESULT] add_numbers(20, 100) = 120
[RESULT] add_numbers(206, 782) = 988

======== Load factorial() from machine code =============
[RESULT] factorial(5) = 24
[RESULT] factorial(6) = 120
[RESULT] factorial(7) = 720
[TRACE] Process terminated gracefully Ok. 
</pre>
</div>

<p>
<b>Building Running on MacOSX</b> 
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ mmap-loader.cpp -o <span class="org-keyword">mmap-loader.bin</span> -std=c++1z -Wall -Wextra -g


$ file mmap-loader.bin
<span class="org-function-name">mmap-loader.bin</span>: Mach-O 64-bit executable x86_64

$ otool -L mmap-loader.bin
<span class="org-function-name">mmap-loader.bin</span>:
        /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 902.1.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.100.1)
</pre>
</div>

<p>
Running: 
</p>
<ul class="org-ul">
<li>Note: It works on MacOSX because the Linux, MacOSX and other
Unix-based sytems use the System V x86-64 calling convention and
the machine code does not use any C library function.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./mmap-loader.bin

====== Load add_numbers from machine code ================
[RESULT] add_numbers(20, 100) = 120
[RESULT] add_numbers(206, 782) = 988

======== Load factorial() from machine code =============
[RESULT] factorial(5) = 24
[RESULT] factorial(6) = 120
[RESULT] factorial(7) = 720
[TRACE] Process terminated gracefully Ok. 
</pre>
</div>

<p>
<b>Running the application in GDB debugger on Linux</b> 
</p>

<p>
Load application in debugger: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; gdb ./mmap-loader.bin --silent
Reading symbols from ./mmap-loader.bin...
</pre>
</div>

<p>
Set breaking point: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Set breaking point </span>
(gdb) b main
Breakpoint 1 at 0x4023f6: file mmap-loader.cpp, line 30.
</pre>
</div>

<p>
Start running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">(gdb) r
Starting program: /home/user/asm-projects/asm/mmap-loader.bin 
Missing separate debuginfos, use: dnf debuginfo-install glibc-2.31-2.fc32.x86_64

Breakpoint 1, main (<span class="org-variable-name">argc</span>=1, <span class="org-variable-name">argv</span>=0x7fffffffd348) at mmap-loader.cpp:30
30              std::puts(<span class="org-string">"\n ====== Load add_numbers from machine code ================"</span>);
Missing separate debuginfos, use: dnf debuginfo-install libgcc-10.2.1-1.fc32.x86_64 libstdc++-10.2.1-1.fc32.x86_64
</pre>
</div>

<p>
Execute multiple steps: 
</p>

<div class="org-src-container">
<pre class="src src-sh">(gdb) n

 ====== Load add_numbers from machine code ================
37              auto add_numbers_code = hexstr_to_bytes(add_numbers_str);
(gdb) 
40              auto add_numbers  = load_mcode&lt;add_numbers_t&gt;(add_numbers_code);

(gdb) n
42              std::cout &lt;&lt; <span class="org-string">" [RESULT] add_numbers(20, 100) = "</span> &lt;&lt; add_numbers(20, 100) &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-sh-heredoc">(gdb) </span>

<span class="org-sh-heredoc">(gdb) p add_numbers_code </span>
<span class="org-sh-heredoc">$1 = std::vector of length 12, capacity 48 = {85 'U', 72 'H', 137 '\211', 229 '\345', 72 'H', 137 '\211', </span>
<span class="org-sh-heredoc">  248 '\370', 72 'H', 1 '\001', 240 '\360', 93 ']', 195 '\303'}</span>

<span class="org-sh-heredoc">(gdb) p add_numbers.size()</span>
<span class="org-sh-heredoc">Attempt to extract a component of a value that is not a struct or union</span>

<span class="org-sh-heredoc">(gdb) p add_numbers_code.size()</span>
<span class="org-sh-heredoc">$2 = 12</span>

<span class="org-sh-heredoc">(gdb) ptype add_numbers</span>
<span class="org-sh-heredoc">type = int (*)(int, int)</span>

<span class="org-sh-heredoc">(gdb) ptype add_numbers_code </span>
<span class="org-sh-heredoc">type = std::vector&lt;unsigned char&gt;</span>
</pre>
</div>

<p>
Call the function pointer add_numbers()
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gdb</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">call</span> <span class="org-variable-name">add_numbers</span><span class="org-rainbow-delimiters-depth-1">(</span>20, 100<span class="org-rainbow-delimiters-depth-1">)</span>
$3 = 120

<span class="org-rainbow-delimiters-depth-1">(</span>gdb<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">call</span> <span class="org-variable-name">add_numbers</span><span class="org-rainbow-delimiters-depth-1">(</span>222, -100<span class="org-rainbow-delimiters-depth-1">)</span>
$4 = 122

<span class="org-rainbow-delimiters-depth-1">(</span>gdb<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">call</span> <span class="org-variable-name">add_numbers</span><span class="org-rainbow-delimiters-depth-1">(</span>222, -1000<span class="org-rainbow-delimiters-depth-1">)</span>
$5 = -778
</pre>
</div>

<p>
Show memory contents as machine code at function pointer memory
location: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Bytes at the function pointer memory location </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">(memory allocated with mmap)</span>
(gdb) x/12b add_numbers
<span class="org-function-name">0x7ffff7ffb000</span>: 0x55    0x48    0x89    0xe5    0x48    0x89    0xf8    0x48
<span class="org-function-name">0x7ffff7ffb008</span>: 0x01    0xf0    0x5d    0xc3

<span class="org-comment-delimiter"># </span><span class="org-comment">Show assembly x86-64 (64 bits) in AT&amp;T syntax </span>
(gdb) x/6i add_numbers
   0x7ffff7ffb000:      push   %rbp
   0x7ffff7ffb001:      mov    %rsp,%rbp
   0x7ffff7ffb004:      mov    %rdi,%rax
   0x7ffff7ffb007:      add    %rsi,%rax
   0x7ffff7ffb00a:      pop    %rbp
   0x7ffff7ffb00b:      retq   
(gdb) 

(gdb) <span class="org-builtin">set</span> disassembly-flavor intel

<span class="org-comment-delimiter"># </span><span class="org-comment">Show assembly x86-64 (64 bits) in Intel syntax </span>
(gdb) x/6i add_numbers
   0x7ffff7ffb000:      push   rbp
   0x7ffff7ffb001:      mov    rbp,rsp
   0x7ffff7ffb004:      mov    rax,rdi
   0x7ffff7ffb007:      add    rax,rsi
   0x7ffff7ffb00a:      pop    rbp
   0x7ffff7ffb00b:      ret    
(gdb) 
</pre>
</div>

<p>
Continue execution until process termination: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gdb</span><span class="org-rainbow-delimiters-depth-1">)</span> n
 <span class="org-rainbow-delimiters-depth-1">[</span>RESULT<span class="org-rainbow-delimiters-depth-1">]</span> add_numbers<span class="org-rainbow-delimiters-depth-1">(</span>20, 100<span class="org-rainbow-delimiters-depth-1">)</span> = 120
43      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] add_numbers(206, 782) = "</span> &lt;&lt; add_numbers<span class="org-rainbow-delimiters-depth-1">(</span>206, 782<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gdb</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-type">c</span>
<span class="org-variable-name">Continuing</span>.
 <span class="org-rainbow-delimiters-depth-1">[</span>RESULT<span class="org-rainbow-delimiters-depth-1">]</span> add_numbers<span class="org-rainbow-delimiters-depth-1">(</span>206, 782<span class="org-rainbow-delimiters-depth-1">)</span> = 988

 ======== Load factorial<span class="org-rainbow-delimiters-depth-1">()</span> from <span class="org-type">machine</span> <span class="org-variable-name">code</span> =============
 <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-constant">RESULT</span><span class="org-rainbow-delimiters-depth-1">]</span> factorial<span class="org-rainbow-delimiters-depth-1">(</span>5<span class="org-rainbow-delimiters-depth-1">)</span> = 24
 <span class="org-rainbow-delimiters-depth-1">[</span>RESULT<span class="org-rainbow-delimiters-depth-1">]</span> factorial<span class="org-rainbow-delimiters-depth-1">(</span>6<span class="org-rainbow-delimiters-depth-1">)</span> = 120
 <span class="org-rainbow-delimiters-depth-1">[</span>RESULT<span class="org-rainbow-delimiters-depth-1">]</span> factorial<span class="org-rainbow-delimiters-depth-1">(</span>7<span class="org-rainbow-delimiters-depth-1">)</span> = 720
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Process terminated gracefully Ok. 
<span class="org-rainbow-delimiters-depth-1">[</span>Inferior 1 <span class="org-rainbow-delimiters-depth-2">(</span>process 933348<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-type">exited</span> <span class="org-variable-name">normally</span><span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span>gdb<span class="org-rainbow-delimiters-depth-1">)</span> 
</pre>
</div>

<p>
<b>Procedure for Extracting the sample machine code with Objdump</b> 
</p>

<p>
This procedure presents how the sample machine code was extracted with
objdump tool. 
</p>

<p>
File: <span class="underline">functions.c</span>  
</p>

<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">factorial</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">prod</span> = 1; 
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 1; i &lt; n; i++<span class="org-rainbow-delimiters-depth-2">){</span> 
        prod = prod * i;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> prod;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" factorial(5) = %d \n"</span>, factorial<span class="org-rainbow-delimiters-depth-3">(</span>5<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" factorial(6) = %d \n"</span>, factorial<span class="org-rainbow-delimiters-depth-3">(</span>6<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; gcc functions.c -o <span class="org-keyword">functions.bin</span> -Wall -Wextra -O0

~/t/asm
$ &gt;&gt; ./functions.bin
<span class="org-function-name">factorial</span>(5) = 24 
<span class="org-function-name">factorial</span>(6) = 120 
</pre>
</div>

<p>
Extract assembly and machine code (encoded as hexadecimal bytes): 
</p>

<pre class="example">
 $ objdump functions.bin -M intel -d 

functions.bin:     file format elf64-x86-64


Disassembly of section .init:

0000000000401000 &lt;_init&gt;:
  401000:	f3 0f 1e fa          	endbr64 
  401004:	48 83 ec 08          	sub    rsp,0x8
  401008:	48 8b 05 e9 2f 00 00 	mov    rax,QWORD PTR [rip+0x2fe9]        # 403ff8 &lt;__gmon_start__&gt;

 ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ... 

0000000000401126 &lt;factorial&gt;:
  401126:	55                   	push   rbp
  401127:	48 89 e5             	mov    rbp,rsp
  40112a:	89 7d ec             	mov    DWORD PTR [rbp-0x14],edi
  40112d:	c7 45 fc 01 00 00 00 	mov    DWORD PTR [rbp-0x4],0x1
  401134:	c7 45 f8 01 00 00 00 	mov    DWORD PTR [rbp-0x8],0x1
  40113b:	eb 0e                	jmp    40114b &lt;factorial+0x25&gt;
  40113d:	8b 45 fc             	mov    eax,DWORD PTR [rbp-0x4]
  401140:	0f af 45 f8          	imul   eax,DWORD PTR [rbp-0x8]
  401144:	89 45 fc             	mov    DWORD PTR [rbp-0x4],eax
  401147:	83 45 f8 01          	add    DWORD PTR [rbp-0x8],0x1
  40114b:	8b 45 f8             	mov    eax,DWORD PTR [rbp-0x8]
  40114e:	3b 45 ec             	cmp    eax,DWORD PTR [rbp-0x14]
  401151:	7c ea                	jl     40113d &lt;factorial+0x17&gt;
  401153:	8b 45 fc             	mov    eax,DWORD PTR [rbp-0x4]
  401156:	5d                   	pop    rbp
  401157:	c3                   	ret    

 .... ...  .... ...  .... ...  .... ...  .... ...  .... ... 
 .... ...  .... ...  .... ...  .... ...  .... ...  .... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a8395a" class="outline-3">
<h3 id="org0a8395a"><span class="section-number-3">1.25</span> POSIX Shared Memory</h3>
<div class="outline-text-3" id="text-1-25">
</div>
<div id="outline-container-org4fa900a" class="outline-4">
<h4 id="org4fa900a"><span class="section-number-4">1.25.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-25-1">
<p>
POSIX (Portable Operarting System Interface) shared memory is a IPC
inter-process communication API which allows multiple processes to
share the same physical memory segment and transfer data without any
copying overhead, unlike pipes, message queues, TCP/IP sockets, UDP/IP
sockets or unix domain sockets. 
</p>

<p>
<b>Unix Shared Memory APIs</b> 
</p>

<p>
Unix-based operating systems, including Linux, BSD variants and MacOSX
have the following APIs for shared memory. 
</p>

<ul class="org-ul">
<li>MMAP - Memory Mapped Files (mmap)
<ul class="org-ul">
<li>Functions: mmap(), ftruncate(), munmap()</li>
</ul></li>

<li>System V shared memory API
<ul class="org-ul">
<li>Functions: shmget(), shmat(), ftok()</li>
</ul></li>

<li>Posix Shared Memory <span class="underline">shm</span>  (similar to mmap)
<ul class="org-ul">
<li>Functions: shm_open(), ftruncate(), mmap().</li>
</ul></li>
</ul>

<p>
On Linux, the POSIX shared memory is implemented as
/dev/shm/&lt;SHARED-MEMORY-NAME&gt; memory mapped file which is an ordinary
file created in the /dev/shm pseudo file system, that only exists in
the volatile RAM memory. Regardless of the shared memory API, they are
prone to race-condition problems if two processes attempt to write to
the memory simultaneously which can lead to data corruption and
unpredictable behavior. As a result, locks, semaphores and other
mutual-exclusion concurrency primitives are necessary to synchronize
the access to the shared memory in order to avoid race conditions and
data corruption. 
</p>

<p>
<b>Limitations and potential problems</b> 
</p>

<p>
The following limitation for objects allocation are noteworthy: 
</p>

<ul class="org-ul">
<li>Objects allocated in the shared memory should be contiguous and
have any internal indirection or any internal pointer, in other
words, they should be <span class="underline">POD</span> types, plain-old-data.</li>

<li>It is not possible to allocate objects containing STL containers
without special allocators.</li>

<li>It is also not possible to allocate polymorphic objects, objects
implemeting some C++ interface class with virtual member
functions.</li>
</ul>

<p>
<b>Headers</b> 
</p>

<ul class="org-ul">
<li>#include &lt;sys/mman.h&gt;</li>
<li>#include &lt;sys/types.h&gt;</li>
<li>#include &lt;sys/stat.h&gt;</li>
<li>#include &lt;fcntl.h&gt;</li>
<li>#include &lt;unistd.h&gt;</li>
</ul>

<p>
<b>Functions</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Open or create a new shared memory segment </span>
<span class="org-type">int</span> <span class="org-function-name">shm_open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span>, <span class="org-type">int</span> <span class="org-variable-name">oflag</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Remove shared memory segment </span>
<span class="org-type">int</span> <span class="org-function-name">shm_unlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Truncate or resize file to specific lenght </span>
<span class="org-type">int</span> <span class="org-function-name">ftruncate</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">off_t</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">Map a file to current process address space </span>
 <span class="org-type">void</span> *<span class="org-function-name">mmap</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">void</span>*  <span class="org-variable-name">addr</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Process virtual address where the file will be mapped </span>
            , <span class="org-type">size_t</span> <span class="org-variable-name">length</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Length in bytes of the file mapping </span>
            , <span class="org-type">int</span>    <span class="org-variable-name">prot</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Protection flags </span>
            , <span class="org-type">int</span>    <span class="org-variable-name">flags</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Read-Write type of access </span>
            , <span class="org-type">int</span>    <span class="org-variable-name">fd</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor to be mapped </span>
            , <span class="org-type">off_t</span>  <span class="org-variable-name">offset</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Offset from beginning of file to be mapped. </span>
          <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Unmap file mapping from current </span>
<span class="org-type">int</span> <span class="org-function-name">munmap</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">addr</span>, <span class="org-type">size_t</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<p>
<b>Documentation and Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.man7.org/linux/man-pages/man3/shm_open.3.html">shm_open(3) - Linux manual page</a></li>

<li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2) - Linux manual page</a></li>

<li><a href="https://www.man7.org/linux/man-pages/man2/ftruncate.2.html">ftruncate(2) - Linux manual page</a></li>

<li><a href="https://datacadamia.com/os/linux/shared_memory">Linux - Shared Memory (SHM) (/dev/shm)</a></li>

<li><a href="https://wiki.c2.com/?VirtualFunctionsAndSharedMemory">Virtual Functions And Shared Memory</a> - C2 Wiki</li>

<li><a href="https://northstar-www.dartmouth.edu/doc/idl/html_6.2/SHMMAP.html">SHMMAP</a> - Dartmouth</li>

<li><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/node27.html">IPC:Shared Memory</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgcde77bc" class="outline-4">
<h4 id="orgcde77bc"><span class="section-number-4">1.25.2</span> Sample Code</h4>
<div class="outline-text-4" id="text-1-25-2">
<p>
This sample code aims to experiment POSIX shared memory
subsystem. This sample program has two functionalities, a server
functionality, which allocates an object in the shared memory and a
client functionality which loads and modifies the object allocated in
the shared memory segment.
</p>

<p>
Sources available at: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/d5f8db63803859f6182e271e026498e3">https://gist.github.com/d5f8db63803859f6182e271e026498e3</a></li>
</ul>

<p>
File: <span class="underline">shmem1.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix and Posix headers ---//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Implementation of object allocated in Shared memory </span>
<span class="org-keyword">struct</span> <span class="org-type">Object</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>    <span class="org-variable-name">x</span> = 0;
    <span class="org-type">double</span> <span class="org-variable-name">y</span> = 26.2124214;
    <span class="org-type">char</span>   <span class="org-variable-name">dataset</span><span class="org-rainbow-delimiters-depth-2">[</span>400<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-string">"Hello world"</span>;

    <span class="org-function-name">Object</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Object created Ok \n"</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">set_x</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>      <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">this</span>-&gt;x = x; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">set_y</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">this</span>-&gt;y = y; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">set_str</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">value</span><span class="org-rainbow-delimiters-depth-2">)</span>  
    <span class="org-rainbow-delimiters-depth-2">{</span>
        mempcpy<span class="org-rainbow-delimiters-depth-3">(</span>dataset, value, 200<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">show</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>  
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Shared memory object =&gt;&gt; "</span>
                  &lt;&lt; <span class="org-string">" ; x = "</span>    &lt;&lt; x 
                  &lt;&lt; <span class="org-string">" ; y = "</span>    &lt;&lt; y 
                  &lt;&lt; <span class="org-string">" ; str =  "</span> &lt;&lt; dataset 
                  &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">constexpr</span> <span class="org-type">int</span>         <span class="org-variable-name">FAILURE</span>            = -1;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span>      <span class="org-variable-name">STORAGE_SIZE</span>       = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-1">(</span>Object<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shared_memory_name</span> = <span class="org-string">"/shared-data"</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Provides shared memory object.</span>
<span class="org-type">void</span> <span class="org-function-name">server_side</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shm_name</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Consumes shared memory object.</span>
<span class="org-type">void</span> <span class="org-function-name">client_side</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shm_name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Process Unique Identifier PID = "</span> &lt;&lt; ::getpid<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Storage size in bytes = "</span> &lt;&lt; STORAGE_SIZE &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Expected command argument. "</span> &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"server"</span> <span class="org-rainbow-delimiters-depth-2">){</span> server_side<span class="org-rainbow-delimiters-depth-3">(</span>shared_memory_name<span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"client"</span> <span class="org-rainbow-delimiters-depth-2">){</span> client_side<span class="org-rainbow-delimiters-depth-3">(</span>shared_memory_name<span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">========= I M P L E M E N  T A T I O N S =================//</span>

<span class="org-type">void</span> <span class="org-function-name">server_side</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shm_name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Remove shared memory segment if it already exists.</span>
    ::shm_unlink<span class="org-rainbow-delimiters-depth-2">(</span>shm_name<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Attempt to create shared  memory segment</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">On Linux this segment corresponds to the file: '/dev/shm/&lt;SHM-NAME&gt;'</span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = shm_open<span class="org-rainbow-delimiters-depth-2">(</span>  shm_name
                      , O_CREAT | O_EXCL | O_RDWR
                      , S_IRUSR | S_IWUSR
                      <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">assert =&gt; Placeholder for future error handling</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> fd != FAILURE &amp;&amp; <span class="org-string">"Failed to create shared memory segment"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Resize shared memory segment</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ::ftruncate<span class="org-rainbow-delimiters-depth-3">(</span>fd, STORAGE_SIZE<span class="org-rainbow-delimiters-depth-3">)</span> != FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Map shared memory segment into process address space</span>
    <span class="org-type">void</span>* <span class="org-variable-name">pmap</span> = ::mmap<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">nullptr</span>                  <span class="org-comment-delimiter">// </span><span class="org-comment">Most of the time set to nullptr </span>
                       , STORAGE_SIZE          <span class="org-comment-delimiter">// </span><span class="org-comment">Size of memory mapping</span>
                       , PROT_READ | PROT_WRITE   <span class="org-comment-delimiter">// </span><span class="org-comment">Allows reading and writing operations</span>
                       , MAP_SHARED               <span class="org-comment-delimiter">// </span><span class="org-comment">This flag makes this segment visible by other processes.</span>
                       , fd                       <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor</span>
                       , 0x00                     <span class="org-comment-delimiter">// </span><span class="org-comment">Offset from beggining of file</span>
                       <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">){</span> perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"mmap"</span><span class="org-rainbow-delimiters-depth-3">)</span>; exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Allocate object in shared memory segment</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">using placement 'new operator'</span>
    <span class="org-type">Object</span>* <span class="org-variable-name">pObj</span> = <span class="org-keyword">new</span> <span class="org-rainbow-delimiters-depth-2">(</span>pmap<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-type">Object</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> pObj != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [BEFORE] Before typing RETURN "</span> &lt;&lt; <span class="org-string">'\n'</span>;
    pObj-&gt;show<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n\n Type return to exit"</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::getchar<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [BEFORE] After typing RETURN "</span> &lt;&lt; <span class="org-string">'\n'</span>;
    pObj-&gt;show<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Mmap cleanup procedure </span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ::munmap<span class="org-rainbow-delimiters-depth-3">(</span>pmap, STORAGE_SIZE<span class="org-rainbow-delimiters-depth-3">)</span> != FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Remove shared memory segment </span>
    ::shm_unlink<span class="org-rainbow-delimiters-depth-2">(</span>shm_name<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">client_side</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shm_name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Attempt to create shared  memory segment</span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = ::shm_open<span class="org-rainbow-delimiters-depth-2">(</span> shm_name,  O_RDWR, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">assert =&gt; Placeholder for future error handling</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> fd != - 1 &amp;&amp; <span class="org-string">"Failed to open shared memory segment"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Map shared memory segment into process address space</span>
    <span class="org-type">void</span>* <span class="org-variable-name">pmap</span> = ::mmap<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">nullptr</span>                  <span class="org-comment-delimiter">// </span><span class="org-comment">Most of the time to NULL or nullptr </span>
                       , <span class="org-keyword">sizeof</span> STORAGE_SIZE      <span class="org-comment-delimiter">// </span><span class="org-comment">Size of memory mapping</span>
                       , PROT_READ | PROT_WRITE   <span class="org-comment-delimiter">// </span><span class="org-comment">Allows reading and writing operations</span>
                       , MAP_SHARED               <span class="org-comment-delimiter">// </span><span class="org-comment">This flag makes this segment visible by other processes.</span>
                       , fd                       <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor</span>
                       , 0x00                     <span class="org-comment-delimiter">// </span><span class="org-comment">Offset from beggining of file</span>
                       <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">){</span> perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"mmap"</span><span class="org-rainbow-delimiters-depth-3">)</span>; exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Load object from shared memory knowing only its interface </span>
<span class="org-comment">     * (pointer to interface class), without knowing its exact </span>
<span class="org-comment">     * implementation or type. </span>
<span class="org-comment">     */</span>
    <span class="org-type">Object</span>* <span class="org-variable-name">pObj</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Object</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>pmap<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Previous object value "</span> &lt;&lt; <span class="org-string">'\n'</span>;
    pObj-&gt;show<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-type">int</span> <span class="org-variable-name">x</span>; 
    <span class="org-type">double</span> <span class="org-variable-name">y</span>; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">str</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Enter x, y and str: "</span>;

    <span class="org-constant">std</span>::cin &gt;&gt; x &gt;&gt; y &gt;&gt; str;
    pObj-&gt;set_x<span class="org-rainbow-delimiters-depth-2">(</span>x<span class="org-rainbow-delimiters-depth-2">)</span>;
    pObj-&gt;set_y<span class="org-rainbow-delimiters-depth-2">(</span>y<span class="org-rainbow-delimiters-depth-2">)</span>;
    pObj-&gt;set_str<span class="org-rainbow-delimiters-depth-2">(</span>str.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    pObj-&gt;show<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">assert( ::munmap(pmap, STORAGE_SIZE) != FAILURE );</span>
<span class="org-rainbow-delimiters-depth-1">}</span>   
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ shmem1.cpp -o <span class="org-keyword">shmem1.bin</span> -std=c++1z -g -O0 -Wall -Wextra -lrt
</pre>
</div>

<p>
Run as a server in terminal 1: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./shmem1.bin server 
[INFO] Process Unique Identifier PID = 81749
[INFO] Storage size<span class="org-keyword"> in</span> bytes = 416
[TRACE] Object created Ok 

[BEFORE] Before typing RETURN 
[TRACE] Shared memory object =&gt;&gt;  ; x = 0 ; y = 26.2124 ; str =  Hello world


Type return to exit

[BEFORE] After typing RETURN 
[TRACE] Shared memory object =&gt;&gt;  ; x = 26234 ; y = 3.15156 ; str =  cpp-shared-memory-allocation-shared-object
</pre>
</div>

<p>
Run as a client in terminal 2: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./shmem1.bin client 
 [INFO] Process Unique Identifier PID = 81777
 [INFO] Storage size<span class="org-keyword"> in</span> bytes = 416
 Previous object value 
 [TRACE] Shared memory object =&gt;&gt;  ; x = 0 ; y = 26.2124 ; str =  Hello world
Enter x, y and str: 20 -90.25122 hello-world-cpp1z
 [TRACE] Shared memory object =&gt;&gt;  ; x = 20 ; y = -90.2512 ; str =  hello-world-cpp1z

 $ &gt;&gt; ./shmem1.bin client
 [INFO] Process Unique Identifier PID = 81811
 [INFO] Storage size<span class="org-keyword"> in</span> bytes = 416
 Previous object value 
 [TRACE] Shared memory object =&gt;&gt;  ; x = 20 ; y = -90.2512 ; str =  hello-world-cpp1z
Enter x, y and str: 26234 3.15156324 cpp-shared-memory-allocation-shared-object
 [TRACE] Shared memory object =&gt;&gt;  ; x = 26234 ; y = 3.15156 ; str =  cpp-shared-memory-allocation-shared-object

 $ &gt;&gt; ./shmem1.bin client
 [INFO] Process Unique Identifier PID = 81837
 [INFO] Storage size<span class="org-keyword"> in</span> bytes = 416
 Previous object value 
 [TRACE] Shared memory object =&gt;&gt;  ; x = 26234 ; y = 3.15156 ; str =  cpp-shared-memory-allocation-shared-object
Enter x, y and str: ^C&#9166;     
</pre>
</div>

<p>
While the server is running, the following command outputs can be
observed: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ls /dev/shm/shared-data
/dev/shm/shared-data

 $ &gt;&gt; file /dev/shm/shared-data
<span class="org-function-name">/dev/shm/shared-data</span>: data

 $ &gt;&gt; cat /dev/shm/shared-data 
<span class="org-variable-name">zf</span>=&#65533;&#65533;&#65533;f6        @cpp-shared-memory-allocation-shared-object1&#65533;y-allocation-s&#65533;&#65533;&#9166; 

<span class="org-comment-delimiter"># </span><span class="org-comment">---- Process mappings -------------------------// </span>

 $ &gt;&gt; pmap 81749
<span class="org-function-name">81749</span>:   ./shmem1.bin server
0000000000400000      8K r---- shmem1.bin
0000000000402000      4K r-x-- shmem1.bin
0000000000403000      4K r---- shmem1.bin
0000000000404000      4K r---- shmem1.bin
 .... ...  .... ...  .... ...  .... ...  .... ... 
 .... ...  .... ...  .... ...  .... ... 
00007faddd82f000     32K r---- ld-2.31.so
00007faddd837000      4K rw-s- shared-data
00007faddd838000      4K r---- ld-2.31.so
00007faddd839000      4K rw--- ld-2.31.so
00007faddd83a000      4K rw---   [ anon ]
00007ffe9af95000    136K rw---   [ stack ]
00007ffe9afc0000     16K r----   [ anon ]
00007ffe9afc4000      8K r-x--   [ anon ]
ffffffffff600000      4K r-x--   [ anon ]
 total             5944K
</pre>
</div>

<p>
Attempt to run application in client mode after the server process
is terminated. 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./shmem1.bin client
 [INFO] Process Unique Identifier PID = 82176
 [INFO] Storage size<span class="org-keyword"> in</span> bytes = 416
<span class="org-function-name">shmem1.bin</span>: shmem1.cpp:128: void client_side(const char*): Assertion <span class="org-sh-quoted-exec">`fd != - 1 &amp;&amp; "Failed to open shared memory segment"' failed.</span>
<span class="org-sh-quoted-exec">fish: &#8220;./shmem1.bin client&#8221; terminated by signal SIGABRT (Abort)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org254ec69" class="outline-3">
<h3 id="org254ec69"><span class="section-number-3">1.26</span> Syslog - System Message Logging</h3>
<div class="outline-text-3" id="text-1-26">
</div>
<div id="outline-container-org8be5677" class="outline-4">
<h4 id="org8be5677"><span class="section-number-4">1.26.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-26-1">
<p>
Several Unix-like operating systems provide a system message logging,
<span class="underline">syslog</span> system which allows applications, such as servers and daemons
(a.k.a system services) to send logging messages reporting events,
auditing and debugging information to a central location, a syslog
server which can be in the same machine as the application or in a
remote host. 
</p>

<p>
The syslog system has a client-server architecture, comprised of two
main parts, the client which is any application that sends the
logging message and the server which receives and consolidates client
messages via Unix Domain Sockets on local machine; UDP/IP or TCP/IP if
the server is located in a remote machine. 
</p>

<p>
Some motivations for using syslog are: 
</p>

<ul class="org-ul">
<li>Logging consolidation in a central location - which improves
discoverability and makes easier to debug, filter and audit
applications that runs without any graphical interface.</li>

<li>Logging persistence</li>

<li>Standard logging API, implemented by many Unix-like operating
systems such as GNU/Linux distributions; GNU/Linux with systemd;
FreeBSD; OpenBSD and MacOSX.</li>

<li>Operating system agnostic. The syslog server or daemon only relies
on TCP/UDP, TCP/IP or Unix-Domain sockets, which makes possible to
implement a syslog system, even on non-Unix-like operating system.</li>

<li>Familiarity of system administrators.</li>

<li>Integration to system-d on GNU/Linux distributions.</li>

<li>Network infrastructure equipment =&gt; Many common network equipment
provide facilities for sending auditing information to syslog
servers.</li>

<li>Multiple ways of visualization. =&gt; Unlike printf-like statements,
logging can be viewed and inspected from any terminal emulators,
graphical applications and also from remote machines. Even for
desktop applications, does not run in terminals, logging via
syslog is a more convenient way for diagnosing and debugging the
application control flow.</li>
</ul>

<p>
Potential use-cases: 
</p>

<ul class="org-ul">
<li>Logging for auditing and debugging in daemon (services)
applications that runs in background and do not have any graphical
user interface. Some of those applications are http servers, ftp
servers, ssh servers, authentication systems and so on.</li>
</ul>

<p>
<b>Syslog C API</b> 
</p>

<p>
API Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man3/syslog.3.html">syslog(3) - Linux manual page</a></li>
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=syslog&amp;sektion=3&amp;apropos=0&amp;manpath=FreeBSD+12.2-RELEASE+and+Ports">syslog(3)</a> - Free BSD</li>
<li><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/syslog.3.html">Mac OS X Manual Page For syslog(3)</a></li>
</ul>

<p>
Syslog Protocol Technical Standard: 
</p>

<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc3164">RFC 3164 - The BSD Syslog Protocol</a></li>
</ul>

<p>
Headers: 
</p>
<ul class="org-ul">
<li>#include &lt;syslog.h&gt;</li>
<li>#include &lt;stdarg.h&gt;</li>
</ul>

<p>
Functions: 
</p>

<ul class="org-ul">
<li>openlog() =&gt; Set logging configuration and attributes that affects
calls to the logging functions.
<ul class="org-ul">
<li><span class="underline">ident</span> =&gt; Unique tag name identifier which allows identifying and
filtering the application that logging messages belong.</li>
<li><span class="underline">logopt</span> =&gt; Logging options bitwise-or flags that speficy the
logging behavior.</li>
<li><span class="underline">facility</span> =&gt; Parameter the assigns thae default category that all
log messages will be related to. Some possible values are:
LOG_USER (default) - generic user-level messages ;LOG_AUTH - log
messages are related to login and authentication via ssh,
terminal and so on; LOG_CRON - Cron clock messages; LOG_FTP -
ftp daemon; LOG_KERN for Kernel messages.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>
<span class="org-function-name">openlog</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">ident</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">Application unique identifierr </span>
        , <span class="org-type">int</span>         <span class="org-variable-name">logopt</span>      
        , <span class="org-type">int</span>      <span class="org-variable-name">facility</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Gr</span>
       <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>closelog() =&gt; Disable logging messages.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">closelog</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>syslog() =&gt; Send logging messages to the syslog daemon.
<ul class="org-ul">
<li><span class="underline">priority</span> =&gt; Flag that indicates the logging severity. It can be:
LOG_INFO for informational messages; LOG_DEBUG for debugging
messages; LOG_WARNING for warnings; LOG_ERR for errros and so
on. See full documentation: <a href="https://man7.org/linux/man-pages/man3/syslog.3.html">syslog</a></li>
<li><span class="underline">message</span> =&gt; Logging message.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">syslog</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">priority</span>, <span class="org-keyword">const</span>  <span class="org-type">char</span>* <span class="org-variable-name">message</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">void</span> <span class="org-function-name">vsyslog</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">priority</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span>, <span class="org-type">va_list</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Syslog">Syslog - Wikipedia</a></li>

<li><a href="https://tools.ietf.org/html/rfc3164">RFC 3164 - The BSD Syslog Protocol</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Common_Log_Format">Common Log Format - Wikipedia</a></li>

<li><a href="https://www.loggly.com/ultimate-guide/linux-logging-basics/">Linux Logging Basics - The Ultimate Guide To Logging</a></li>

<li><a href="https://www.projectatomic.io/blog/2014/09/running-syslog-within-a-docker-container/">Running Syslog Within a Docker Container — Project Atomic</a></li>

<li><a href="https://www.syslog-ng.com/community/b/blog/posts/how-to-collect-windows-event-logs-with-syslog-ng-without-installing-an-agent">How to collect Windows Event Logs with syslog-ng without installing an agent</a></li>

<li><a href="https://www.winsyslog.com/">The original Windows Syslog Server - WinSyslog</a></li>

<li><a href="https://www.juniper.net/documentation/en_US/jsa7.3.3/jsa-configuring-dsm/topics/task/operational/jsa-dsm-configuring-syslog-on-your-apple.html">Configuring Syslog on Your Apple Mac OS X - TechLibrary - Juniper Networks</a></li>

<li><a href="https://www.howtogeek.com/356942/how-to-view-the-system-log-on-a-mac/">How to View the System Log on a Mac</a></li>

<li><a href="https://gist.github.com/darconeous/1b3aee893536c1de2401">Using OS X as a Syslog Server · GitHub</a></li>

<li><a href="https://golang.org/pkg/log/syslog/">syslog - The Go Programming Language</a></li>

<li><a href="https://medium.com/@yhjhoo/create-a-syslog-server-with-golang-8ffa0787437">syslog with golang | Medium</a></li>

<li>FreeBSD - <a href="https://www.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8">syslogd(8)</a> - Syslog Daemon</li>

<li>FreeBSD - <a href="https://www.freebsd.org/cgi/man.cgi?query=logger&amp;sektion=1&amp;apropos=0&amp;manpath=FreeBSD+12.2-RELEASE+and+Ports">logger(1)</a> - Command line tool for sending logging
messages to syslog server from terminal.</li>

<li>FreeBSD - <a href="https://www.freebsd.org/doc/handbook/configtuning-syslog.html">11.7. Configuring System Logging</a></li>

<li>FreeBSD - <a href="https://docs.freebsd.org/doc/7.3-RELEASE/usr/share/doc/handbook/network-syslogd.html">Remote Host Logging with syslogd</a></li>

<li><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/syslog.3.html">Mac OS X Manual Page For syslog(3)</a></li>

<li><a href="https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.16/administration-guide/8">syslog-ng Open Source Edition 3.16 - Administration Guide</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgb62098c" class="outline-4">
<h4 id="orgb62098c"><span class="section-number-4">1.26.2</span> Usage example</h4>
<div class="outline-text-4" id="text-1-26-2">
<p>
File: <span class="underline">syslog-test.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cmath</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Unix-specific headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">syslog.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">sleep() </span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unique identifier </span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">ident</span> = <span class="org-string">"MYSERVER"</span>;

    <span class="org-type">int</span> <span class="org-variable-name">logopt</span> =  <span class="org-comment-delimiter">// </span><span class="org-comment">Include PID (process unique identifier number)</span>
                  <span class="org-comment-delimiter">// </span><span class="org-comment">in the log messages</span>
                  LOG_PID    
                | LOG_ODELAY 
                <span class="org-comment-delimiter">// </span><span class="org-comment">Print log messages to console (terminal) stderr </span>
                | LOG_PERROR 
                ;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Configure logger  </span>
    openlog<span class="org-rainbow-delimiters-depth-2">(</span>ident, logopt, LOG_USER<span class="org-rainbow-delimiters-depth-2">)</span>;

    syslog<span class="org-rainbow-delimiters-depth-2">(</span>LOG_INFO, <span class="org-string">" Logging has started Ok."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    syslog<span class="org-rainbow-delimiters-depth-2">(</span>LOG_DEBUG, <span class="org-string">"Starting server main loop"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; 10; i++<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        syslog<span class="org-rainbow-delimiters-depth-3">(</span>LOG_INFO, <span class="org-string">"Loop counter value = %d - sqrt(%d) = %f"</span>
               , i, i, <span class="org-constant">std</span>::sqrt<span class="org-rainbow-delimiters-depth-4">(</span>i<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Sleep for 1 second </span>
        sleep<span class="org-rainbow-delimiters-depth-3">(</span>1<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    syslog<span class="org-rainbow-delimiters-depth-2">(</span>LOG_WARNING, <span class="org-string">"Main loop terminated."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Shutdown logging </span>
    closelog<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ syslog-test.cpp -o <span class="org-keyword">syslog-test</span> -Wall -Wextra -g -std=c++1z 
</pre>
</div>


<p>
<b>Running:</b> (Terminal 1)
</p>

<pre class="example">
 $ &gt;&gt; build/test-syslog 
MYSERVER[1668452]:  Logging has started Ok.
MYSERVER[1668452]: Starting server main loop
MYSERVER[1668452]: Loop counter value = 0 - sqrt(0) = 0.000000
MYSERVER[1668452]: Loop counter value = 1 - sqrt(1) = 1.000000
MYSERVER[1668452]: Loop counter value = 2 - sqrt(2) = 1.414214
MYSERVER[1668452]: Loop counter value = 3 - sqrt(3) = 1.732051
MYSERVER[1668452]: Loop counter value = 4 - sqrt(4) = 2.000000
MYSERVER[1668452]: Loop counter value = 5 - sqrt(5) = 2.236068
MYSERVER[1668452]: Loop counter value = 6 - sqrt(6) = 2.449490
MYSERVER[1668452]: Loop counter value = 7 - sqrt(7) = 2.645751
MYSERVER[1668452]: Loop counter value = 8 - sqrt(8) = 2.828427
MYSERVER[1668452]: Loop counter value = 9 - sqrt(9) = 3.000000
MYSERVER[1668452]: Main loop terminated.

</pre>

<p>
<b>Monitoring via journalctl:</b> (Terminal 2)
</p>

<p>
In a second terminal run the command '$ journalctl -f' that displays
the newest logging entries. 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; journalctl -f
-- Logs begin at Mon 2020-05-11 22:09:13 -03. --
Nov 27 14:20:39 localhost.localdomain dnf[1666375]: Fedora 32 - x86_64                               21 kB/s | 3.3 kB     00:00
Nov 27 14:20:40 localhost.localdomain dnf[1666375]: RPM Fusion for Fedora 32 - Nonfree - NVIDIA Dri  23 kB/s |  11 kB     00:00
  ...   ...   ...   ...   ...   ... 
  ...   ...   ...   ...   ...   ... 

Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]:  Logging has started Ok.
Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]: Starting server main loop
Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]: Loop counter value = 0 - sqrt(0) = 0.000000
Nov 27 14:50:45 localhost.localdomain MYSERVER[1668452]: Loop counter value = 1 - sqrt(1) = 1.000000
Nov 27 14:50:46 localhost.localdomain MYSERVER[1668452]: Loop counter value = 2 - sqrt(2) = 1.414214
Nov 27 14:50:47 localhost.localdomain MYSERVER[1668452]: Loop counter value = 3 - sqrt(3) = 1.732051
Nov 27 14:50:48 localhost.localdomain MYSERVER[1668452]: Loop counter value = 4 - sqrt(4) = 2.000000
Nov 27 14:50:49 localhost.localdomain MYSERVER[1668452]: Loop counter value = 5 - sqrt(5) = 2.236068
Nov 27 14:50:50 localhost.localdomain MYSERVER[1668452]: Loop counter value = 6 - sqrt(6) = 2.449490
Nov 27 14:50:51 localhost.localdomain MYSERVER[1668452]: Loop counter value = 7 - sqrt(7) = 2.645751
Nov 27 14:50:52 localhost.localdomain MYSERVER[1668452]: Loop counter value = 8 - sqrt(8) = 2.828427
Nov 27 14:50:53 localhost.localdomain MYSERVER[1668452]: Loop counter value = 9 - sqrt(9) = 3.000000
Nov 27 14:50:54 localhost.localdomain MYSERVER[1668452]: Main loop terminated.
</pre>
</div>

<p>
View only logging entries related to tag MYSERVER: (Approach 1)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; journalctl -f -t MYSERVER
-- Logs begin at Mon 2020-05-11 22:09:13 -03. --
Nov 27 14:50:45 localhost.localdomain MYSERVER[1668452]: Loop counter value = 1 - sqrt(1) = 1.000000
Nov 27 14:50:46 localhost.localdomain MYSERVER[1668452]: Loop counter value = 2 - sqrt(2) = 1.414214
Nov 27 14:50:47 localhost.localdomain MYSERVER[1668452]: Loop counter value = 3 - sqrt(3) = 1.732051
Nov 27 14:50:48 localhost.localdomain MYSERVER[1668452]: Loop counter value = 4 - sqrt(4) = 2.000000
Nov 27 14:50:49 localhost.localdomain MYSERVER[1668452]: Loop counter value = 5 - sqrt(5) = 2.236068
Nov 27 14:50:50 localhost.localdomain MYSERVER[1668452]: Loop counter value = 6 - sqrt(6) = 2.449490
Nov 27 14:50:51 localhost.localdomain MYSERVER[1668452]: Loop counter value = 7 - sqrt(7) = 2.645751
Nov 27 14:50:52 localhost.localdomain MYSERVER[1668452]: Loop counter value = 8 - sqrt(8) = 2.828427
Nov 27 14:50:53 localhost.localdomain MYSERVER[1668452]: Loop counter value = 9 - sqrt(9) = 3.000000
Nov 27 14:50:54 localhost.localdomain MYSERVER[1668452]: Main loop terminated.
</pre>
</div>

<p>
View only log entries related to tag MYSERVER: (Approach 2)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; journalctl <span class="org-variable-name">SYSLOG_IDENTIFIER</span>=MYSERVER
-- Logs begin at Mon 2020-05-11 22:09:13 -03, end at Fri 2020-11-27 14:52:01 -03. --
Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]:  Logging has started Ok.
Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]: Starting server main loop
Nov 27 14:50:44 localhost.localdomain MYSERVER[1668452]: Loop counter value = 0 - sqrt(0) = 0.000000
Nov 27 14:50:45 localhost.localdomain MYSERVER[1668452]: Loop counter value = 1 - sqrt(1) = 1.000000
Nov 27 14:50:46 localhost.localdomain MYSERVER[1668452]: Loop counter value = 2 - sqrt(2) = 1.414214
Nov 27 14:50:47 localhost.localdomain MYSERVER[1668452]: Loop counter value = 3 - sqrt(3) = 1.732051
Nov 27 14:50:48 localhost.localdomain MYSERVER[1668452]: Loop counter value = 4 - sqrt(4) = 2.000000
Nov 27 14:50:49 localhost.localdomain MYSERVER[1668452]: Loop counter value = 5 - sqrt(5) = 2.236068
Nov 27 14:50:50 localhost.localdomain MYSERVER[1668452]: Loop counter value = 6 - sqrt(6) = 2.449490
Nov 27 14:50:51 localhost.localdomain MYSERVER[1668452]: Loop counter value = 7 - sqrt(7) = 2.645751
Nov 27 14:50:52 localhost.localdomain MYSERVER[1668452]: Loop counter value = 8 - sqrt(8) = 2.828427
Nov 27 14:50:53 localhost.localdomain MYSERVER[1668452]: Loop counter value = 9 - sqrt(9) = 3.000000
Nov 27 14:50:54 localhost.localdomain MYSERVER[1668452]: Main loop terminated.
</pre>
</div>

<p>
View log messages in JSON format (machine readable): 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; journalctl <span class="org-variable-name">SYSLOG_IDENTIFIER</span>=MYSERVER -o <span class="org-keyword">json-pretty</span>
<span class="org-keyword">{</span>
        <span class="org-string">"_MACHINE_ID"</span> : <span class="org-string">"a1ac43b933e24659bba5edf2b9cec1e1"</span>,
        <span class="org-string">"_CMDLINE"</span> : <span class="org-string">"build/test-syslog"</span>,
        <span class="org-string">"_UID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_HOSTNAME"</span> : <span class="org-string">"localhost.localdomain"</span>,
        <span class="org-string">"_SYSTEMD_SLICE"</span> : <span class="org-string">"user-1000.slice"</span>,
        <span class="org-string">"PRIORITY"</span> : <span class="org-string">"6"</span>,
        <span class="org-string">"_COMM"</span> : <span class="org-string">"test-syslog"</span>,
        <span class="org-string">"_EXE"</span> : <span class="org-string">"/home/myunixuser/temp-projects/quickjs-project/build/test-syslog"</span>,
        <span class="org-string">"SYSLOG_FACILITY"</span> : <span class="org-string">"1"</span>,
        <span class="org-string">"MESSAGE"</span> : <span class="org-string">" Logging has started Ok."</span>,
        <span class="org-string">"_SOURCE_REALTIME_TIMESTAMP"</span> : <span class="org-string">"1606499444168590"</span>,
        <span class="org-string">"_GID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_SYSTEMD_CGROUP"</span> : <span class="org-string">"/user.slice/user-1000.slice/session-6.scope"</span>,
        <span class="org-string">"_SYSTEMD_USER_SLICE"</span> : <span class="org-string">"-.slice"</span>,
        <span class="org-string">"_AUDIT_LOGINUID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_SYSTEMD_SESSION"</span> : <span class="org-string">"6"</span>,
        <span class="org-string">"__CURSOR"</span> : <span class="org-string">"s=c5bc71b70e1e4196ad228c9854261d9a;i=a55c3;b=367eba6384324bf9a1b17ed43352d82e;m=218d3e06963;t=5b51a4cb397e2;x=ce1952db56e33f8b"</span>,
        <span class="org-string">"__REALTIME_TIMESTAMP"</span> : <span class="org-string">"1606499444168674"</span>,
        <span class="org-string">"_PID"</span> : <span class="org-string">"1668452"</span>,
        <span class="org-string">"_BOOT_ID"</span> : <span class="org-string">"367eba6384324bf9a1b17ed43352d82e"</span>,
        <span class="org-string">"_TRANSPORT"</span> : <span class="org-string">"syslog"</span>,
        <span class="org-string">"SYSLOG_IDENTIFIER"</span> : <span class="org-string">"MYSERVER"</span>,
        <span class="org-string">"_AUDIT_SESSION"</span> : <span class="org-string">"6"</span>,
        <span class="org-string">"__MONOTONIC_TIMESTAMP"</span> : <span class="org-string">"2305657170275"</span>,
        <span class="org-string">"_SYSTEMD_UNIT"</span> : <span class="org-string">"session-6.scope"</span>,
        <span class="org-string">"_CAP_EFFECTIVE"</span> : <span class="org-string">"0"</span>,
        <span class="org-string">"SYSLOG_PID"</span> : <span class="org-string">"1668452"</span>,
        <span class="org-string">"_SYSTEMD_OWNER_UID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"SYSLOG_TIMESTAMP"</span> : <span class="org-string">"Nov 27 14:50:44 "</span>,
        <span class="org-string">"_SYSTEMD_INVOCATION_ID"</span> : <span class="org-string">"b25ee3d518c54e5c805521823f22d60d"</span>
}
{
        <span class="org-string">"_SYSTEMD_OWNER_UID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"SYSLOG_IDENTIFIER"</span> : <span class="org-string">"MYSERVER"</span>,
        <span class="org-string">"_SOURCE_REALTIME_TIMESTAMP"</span> : <span class="org-string">"1606499444168718"</span>,
        <span class="org-string">"_PID"</span> : <span class="org-string">"1668452"</span>,
        <span class="org-string">"_UID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_CMDLINE"</span> : <span class="org-string">"build/test-syslog"</span>,
        <span class="org-string">"_GID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_AUDIT_SESSION"</span> : <span class="org-string">"6"</span>,
        <span class="org-string">"MESSAGE"</span> : <span class="org-string">"Starting server main loop"</span>,
        <span class="org-string">"__MONOTONIC_TIMESTAMP"</span> : <span class="org-string">"2305657481811"</span>,
        <span class="org-string">"PRIORITY"</span> : <span class="org-string">"7"</span>,
        <span class="org-string">"__CURSOR"</span> : <span class="org-string">"s=c5bc71b70e1e4196ad228c9854261d9a;i=a55c4;b=367eba6384324bf9a1b17ed43352d82e;m=218d3e52a53;t=5b51a4cb858d3;x=f796bcc2cb08f71e"</span>,
        <span class="org-string">"_HOSTNAME"</span> : <span class="org-string">"localhost.localdomain"</span>,
        <span class="org-string">"_SYSTEMD_INVOCATION_ID"</span> : <span class="org-string">"b25ee3d518c54e5c805521823f22d60d"</span>,
        <span class="org-string">"_MACHINE_ID"</span> : <span class="org-string">"a1ac43b933e24659bba5edf2b9cec1e1"</span>,
        <span class="org-string">"_BOOT_ID"</span> : <span class="org-string">"367eba6384324bf9a1b17ed43352d82e"</span>,
        <span class="org-string">"_SYSTEMD_CGROUP"</span> : <span class="org-string">"/user.slice/user-1000.slice/session-6.scope"</span>,
        <span class="org-string">"SYSLOG_FACILITY"</span> : <span class="org-string">"1"</span>,
        <span class="org-string">"_SYSTEMD_USER_SLICE"</span> : <span class="org-string">"-.slice"</span>,
        <span class="org-string">"_SYSTEMD_UNIT"</span> : <span class="org-string">"session-6.scope"</span>,
        <span class="org-string">"_SYSTEMD_SLICE"</span> : <span class="org-string">"user-1000.slice"</span>,
        <span class="org-string">"__REALTIME_TIMESTAMP"</span> : <span class="org-string">"1606499444480211"</span>,
        <span class="org-string">"_TRANSPORT"</span> : <span class="org-string">"syslog"</span>,
        <span class="org-string">"_EXE"</span> : <span class="org-string">"/home/myunixuser/temp-projects/quickjs-project/build/test-syslog"</span>,
        <span class="org-string">"_COMM"</span> : <span class="org-string">"test-syslog"</span>,
        <span class="org-string">"SYSLOG_PID"</span> : <span class="org-string">"1668452"</span>,
        <span class="org-string">"_CAP_EFFECTIVE"</span> : <span class="org-string">"0"</span>,
        <span class="org-string">"SYSLOG_TIMESTAMP"</span> : <span class="org-string">"Nov 27 14:50:44 "</span>,
        <span class="org-string">"_AUDIT_LOGINUID"</span> : <span class="org-string">"1000"</span>,
        <span class="org-string">"_SYSTEMD_SESSION"</span> : <span class="org-string">"6"</span>
}
 ... ... ... ... 
 ... ... ... 
</pre>
</div>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="https://serverfault.com/questions/754953/systemds-journalctl-how-to-filter-by-message">debian jessie - systemd's journalctl: how to filter by message? - Server Fault</a></li>

<li><a href="https://unix.stackexchange.com/questions/189647/pulling-log-messages-for-a-particular-log-in-systemd-journal">c - Pulling log messages for a particular log in systemd journal? - Unix &amp; Linux Stack Exchange</a></li>

<li><a href="https://net2.com/how-to-analyze-linux-systemd-logs-using-journalctl-advanced-filtering-options/">How to analyze Linux systemd logs using journalctl advanced filtering options</a></li>

<li><a href="https://sematext.com/blog/journald-logging-tutorial/">Logging w/ journald: Why use it &amp; how it performs vs syslog - Sematext</a></li>

<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs">How To Use Journalctl to View and Manipulate Systemd Logs | DigitalOcean</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1de310c" class="outline-3">
<h3 id="org1de310c"><span class="section-number-3">1.27</span> Sockets - TCP/IP and Unix Domain Sockets</h3>
<div class="outline-text-3" id="text-1-27">
</div>
<div id="outline-container-org561a6af" class="outline-4">
<h4 id="org561a6af"><span class="section-number-4">1.27.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-27-1">
<p>
Sockets are inter process communication mechanism, intruduced by Unix
BSD 4.1 circa 1982, which allows multiple processes running at
different machines to communicate across TCP/IP network.
</p>

<p>
<b>Main Implementations</b>
</p>

<ul class="org-ul">
<li>BSD Sockets =&gt; Pervarsive on Unix-like operating systems: BSD, Linux, MacOSX, &#x2026;.,</li>
<li>Winsocks    =&gt; Microsft Windows only (Windows NT and Windows CE families)</li>
</ul>

<p>
<b>Domain and Connection Type</b>
</p>

<p>
A socket endpoint is defined by its <span class="underline">domain</span> and connection <span class="underline">type</span>. 
</p>

<p>
Most common socket domains:
</p>

<ul class="org-ul">
<li>AF_INET   =&gt; IPv4 - Internet Protocol [Most used]</li>
<li>AF_INET6  =&gt; IPv6 - Intenert Protocol (IPv6)</li>
<li>AF_UNIX   =&gt; Unix Domain socket on local machine [Most used]</li>
</ul>

<p>
Most common connection Types: 
</p>

<ul class="org-ul">
<li>SOCK_STREAM =&gt; <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> - Transmission Control Protocol</li>
<li>SOCK_DGRAM  =&gt; <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> - User Datagram Protocol</li>
<li>SOCK_RAW    =&gt; Raw network protocol (Requires root permission)</li>
</ul>

<p>
Socket server or socket client: 
</p>

<ul class="org-ul">
<li>socket client
<ul class="org-ul">
<li>=&gt; Connects to socket server and always starts the
connection. Example: curl; web browser (http client); netcat</li>
</ul></li>

<li>socket server
<ul class="org-ul">
<li>=&gt; Listen some port and waits client connection. It can handle
one or more clients. Example: Http server, nginx, ssh server.</li>
</ul></li>
</ul>

<p>
TCP/IP connection tuple: 
</p>

<ul class="org-ul">
<li>Hostname or IP address (IPv4 or IPv6)
<ul class="org-ul">
<li>0.0.0.0     / address used by a socket server for listening all hosts.</li>
<li>127.0.0.1   / Localhost - refers to the local (current) machine</li>
<li>'localhost' / Localhost - refers to the local (current) machine, same as (127.0.0.1)</li>
</ul></li>
<li>Port number: 16 bits number</li>
</ul>

<p>
Common TCP/IP Ports: 
</p>

<ul class="org-ul">
<li>20, 21 - FTP server</li>
<li>22 - SSH server</li>
<li>23 - Telnet (SSH predecessor)</li>
<li>80 - HTTP server</li>
<li>443 - HTTPS (HTTP + SSL/TSL) - Http with SSL encryption</li>
<li>143 - IMAP - Mail</li>
<li>25  - SMTP - Simple Mail Transfer Protocol</li>
<li>More at: <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">List of TCP and UDP port numbers</a></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/xsh_chap02_10.html">Sockets - Unix Open Group Specification</a></li>

<li><a href="https://en.wikipedia.org/wiki/Berkeley_sockets">Berkeley sockets (BSD Sockets)</a></li>

<li><a href="https://www.networkworld.com/article/3327557/using-the-linux-ss-command-to-examine-network-and-socket-connections.html">Using the Linux ss command to examine network and socket connections</a></li>

<li><a href="http://www.qnx.com/developers/docs/qnx_4.25_docs/tcpip50/prog_guide/sock_ipc_tut.html">QNX - A socket-based IPC tutorial</a></li>

<li><a href="https://devblogs.microsoft.com/commandline/af_unix-comes-to-windows/">AF_UNIX comes to Windows | Windows Command Line / windows socket network</a></li>

<li><a href="https://blog.myhro.info/2017/01/how-fast-are-unix-domain-sockets">How fast are Unix Domain Sockets?</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0300261" class="outline-4">
<h4 id="org0300261"><span class="section-number-4">1.27.2</span> BSD Socket API</h4>
<div class="outline-text-4" id="text-1-27-2">
<p>
The BSD socket API is the reference-implementation for network sockets
inter-process communication mechanism, which powers the internet. The
BSD socket API was initially implemented on BSD Unix and nowadays is
used by the most Unix-based operating systems, namely, Linux,
BSD-variants (FreeBSD, NetBSD, OpenBSD) and MacOSX. The Windows
sockets (Winsocks) implementation is also based on BSD sockets API,
although one of the main differences is that on the Winsocks API,
sockets are not file descriptors and Unix read(),/write() calls or
windows equivalent APIs cannot be used with sockets.
</p>

<p>
Headers: 
</p>
<ul class="org-ul">
<li>#include &lt;sys/types.h&gt;</li>
<li>#include &lt;sys/socket.h&gt;</li>
<li>#include &lt;netdb.h&gt;</li>
</ul>

<p>
Functions for creating and disposing sockets:  
</p>

<ul class="org-ul">
<li><span class="underline">socket()</span>
<ul class="org-ul">
<li>Linux Manpage: "socket() creates an endpoint for communication
and returns a file descriptor that refers to that endpoint.  The
file descriptor returned by a successful call will be the
lowest-numbered file descriptor not currently open for the
process."</li>
<li>Note: returns -1 when an error happens and sets the <span class="underline">errno</span>
thread-local global variable.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">socket</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">domain</span>, <span class="org-type">int</span> <span class="org-variable-name">type</span>, <span class="org-type">int</span> <span class="org-variable-name">protocol</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">--------- Example ----------------------------// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for TCP/IPv4 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Placeholder for future error handling </span>
assert<span class="org-rainbow-delimiters-depth-1">(</span> sockfd != -1 &amp;&amp; <span class="org-string">"Unable to create socket."</span> <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Error handling: </span>
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>sockfd == -1<span class="org-rainbow-delimiters-depth-1">){</span> 
    perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failed to create a socket connect. Check errno"</span><span class="org-rainbow-delimiters-depth-2">)</span>; 
    exit<span class="org-rainbow-delimiters-depth-2">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Usages for instantiating sockets: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/************ </span><span class="org-comment">TCP / IP ******************************/</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for TCP/IPv4 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for TCP/IPv6 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET6, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">/************* </span><span class="org-comment">UDP / IP ******************************/</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for UDP/IPv4 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_DGRAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for UDP/IPv6 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET6, SOCK_DGRAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">/*********** </span><span class="org-comment">SCTP / IP *****************************/</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for SCTP / IPv4 - (SCTP - Stream Control Protocol)</span>
<span class="org-type">int</span> <span class="org-variable-name">fd</span>  = socket<span class="org-rainbow-delimiters-depth-1">(</span>PF_INET, SOCK_STREAM, IPPROTO_SCTP<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">/***** </span><span class="org-comment">Unix Domain Sockets (Only for local host) *****/</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for Unix socket with TCP </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_UNIX, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for Unix socket with UDP </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_UNIX, SOCK_DGRAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">close()</span> =&gt; Close file descriptor or socket file descriptor.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Functions for setting a socket as client-socket: 
</p>

<ul class="org-ul">
<li><span class="underline">connect()</span> =&gt; Connect a client socket to a given address. On error,
(-1) is returned. On success, 0 is returned.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span> *<span class="org-variable-name">addr</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<p>
<b>Functions for setting up a socket as a server socket</b> (aka passive  socket, listening socket)
</p>

<ul class="org-ul">
<li><span class="underline">bind()</span> [SOCKET SERVER] =&gt; Bind a given port for listening income
connections. (used for socket servers)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span>* <span class="org-variable-name">addr</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">sa_family_t</span> <span class="org-variable-name">sa_family</span>;
     <span class="org-type">char</span>        <span class="org-variable-name">sa_data</span><span class="org-rainbow-delimiters-depth-2">[</span>14<span class="org-rainbow-delimiters-depth-2">]</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>listen() [SOCKET SERVER]

<ul class="org-ul">
<li>Linux Manpage: "listen() marks the socket referred to by sockfd
as a passive socket, that is, as a socket that will be used to
accept incoming connection requests using accept(2)."</li>

<li>Linux Manpage: "The backlog argument defines the maximum length
to which the queue of pending connections for sockfd may grow.
If a connection request arrives when the queue is full, the
client may receive an error with an indication of ECONNRE‐ FUSED
or, if the underlying protocol supports retransmission, the
request may be ignored so that a later reattempt at connection
succeeds."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">listen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>setsockopt() =&gt; Manipulate socket options.
<ul class="org-ul">
<li>Doc: $ man setsockopt</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">setsockopt</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-type">int</span> <span class="org-variable-name">level</span>, <span class="org-type">int</span> <span class="org-variable-name">optname</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">optval</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">optlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Functions for sending and receiving messages</b> 
</p>

<p>
Functions send, and recev works on all implementations of sockets BSD
Sockets, used by Unix-based operating systems, and Windows sockets. 
</p>

<ul class="org-ul">
<li>send() =&gt; Send a buffer to a socket.
<ul class="org-ul">
<li>Doc: $ man send</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Returns number of bytes received </span>
<span class="org-type">ssize_t</span> <span class="org-function-name">send</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span>         <span class="org-variable-name">sockfd</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Socket file descriptor </span>
             , <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buf</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (any POD - Plain Old Data)</span>
             , <span class="org-type">size_t</span>      <span class="org-variable-name">len</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer length (or size) in bytes </span>
             , <span class="org-type">int</span>         <span class="org-variable-name">flags</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Flags (bitwise OR flags)</span>
            <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>recv() =&gt; Receive a message from a socket. Read 'len' bytes from
socket and store data in a buffer. Note: the buffer argument is a
pointer to any POD (Plain-Old Data) type, contiguos allocated data
without any internal pointer. 

<ul class="org-ul">
<li>Doc: $ man recv</li>

<li>This function returns the number of bytes read which the maximum
value is the buffer length.

<ul class="org-ul">
<li>The function returns (-1) on error and sets the <span class="underline">errno</span> global
variable for indicating the failure.</li>

<li>The return value (0) indicates that the connection was
closed either by the current calling code with close() function
applied on the socket file descriptor or by the counterpart
socket located in the remote host.</li>

<li>If a recev() call is made, and the counterpart socket did not
send any data with send() or write(), the call to recev()
blocks the current thread if the socket file descriptor is set
in blocking mode (default).</li>

<li>A call to recev() may not receive all bytes available, even
though the peer socket has send a message larger than the
buffer size. This situation is called partial-read that must
be handled by the calling code.</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">recv</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span>       <span class="org-variable-name">sockfd</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Socket file descriptor </span>
              , <span class="org-type">void</span>*    <span class="org-variable-name">buffer</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (POD type) </span>
              , <span class="org-type">size_t</span>   <span class="org-variable-name">len</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer length or size in bytes </span>
              , <span class="org-type">int</span>      <span class="org-variable-name">flags</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Flags (bitwise OR flags</span>
             <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Functions read(), write() also works with sockets file descriptors.
However this feature is not portable to windows sockets
implementation. 
</p>

<ul class="org-ul">
<li>read() =&gt; Similar as recev(), but it is only available with
BSD-style. The usage of read() is not portable to Windows
sockets.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span>    <span class="org-variable-name">fd</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor or socket file descriptor </span>
             , <span class="org-type">void</span>*  <span class="org-variable-name">buffer</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (any POD type)</span>
             , <span class="org-type">size_t</span> <span class="org-variable-name">size</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size in bytes </span>
            <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>write() =&gt; Similar to write(), but not portable to Windows
sockets. It writes data from buffer to any type of file
descriptor and returns the number of bytes sent to the peer
socket or returns (-1) on failure setting <span class="underline">errno</span> global variable.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">write</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">int</span>          <span class="org-variable-name">fd</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor or socket file descriptor </span>
              , <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (any POD type)</span>
              , <span class="org-type">size_t</span>      <span class="org-variable-name">size</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size in bytes </span>
              <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Endianess conversion for binary data exchange of numeric types</b>
</p>

<p>
One of the pitfalls of binary data exchange is the endianess, the
order which bytes of numeric types are placed in the memory. A code
assuming that the server and client side have the same endianess may
eventually fail and iterpret a numeric type in a incorrect way if the
server or client runs in a machine (computer architecture) with a
different endianess. In order to both socket communication endpoints
interpret the data in a correct way, both have to agree about the data
representation (_external representation_) which is the <span class="underline">big-endian</span> or
<span class="underline">network-byte-order</span>. See also: <a href="https://developer.ibm.com/technologies/systems/articles/au-endianc/">(IBM endian-independent code</a>)
</p>

<p>
The BSD socket API provides the following functions for converting
between machine (host) and network-order endianess of numeric
types. Note: those functions are not portable and are neither part of
C standard nor part of POSIX standard. 
</p>

<p>
Header: 
</p>
<ul class="org-ul">
<li>#include &lt;arpa/inet.h&gt;</li>
</ul>

<p>
Functions that converts from host to network endianess: 
</p>

<ul class="org-ul">
<li><span class="underline">htonl()</span> =&gt; Conversion from host (local machine) to
network-byte-order endianess. It takes a number in local machine
byte-order and returns a number with network-byte-order (big
endian) endianess. This function should be used whenever the
calling code needs to write to the network via write() or send()
calls. 

<ul class="org-ul">
<li>Mneumonic: h-to-n-l (Host to network long)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">  <span class="org-type">uint32_t</span> <span class="org-function-name">htonl</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint32_t</span> <span class="org-variable-name">hostlong</span><span class="org-rainbow-delimiters-depth-1">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Usage example ------------// </span>
  <span class="org-comment-delimiter">//                                     </span><span class="org-comment">// </span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">==&gt; Number in host (local machine) endianess. </span>
  <span class="org-type">uint32_t</span> <span class="org-variable-name">message_size</span> = 500; 
  <span class="org-comment-delimiter">// </span><span class="org-comment">==&gt; Number in network-byte-order (big-endian)</span>
  <span class="org-type">uint32_t</span> <span class="org-variable-name">data</span> = htonl<span class="org-rainbow-delimiters-depth-1">(</span>message_size<span class="org-rainbow-delimiters-depth-1">)</span>; 

 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> send<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;data, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint32_t<span class="org-rainbow-delimiters-depth-3">)</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">Handler error */</span> <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">OR: </span>

 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> write<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;data, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint32_t<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">Handler error */</span> <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">htons()</span> =&gt; Conversion from host to network-byte-order.
<ul class="org-ul">
<li>Mneumonic: h-to-n-s =&gt; (Host to network short)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">uint16_t</span> <span class="org-function-name">htons</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">hostshort</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">--------- Usage Example -------------// </span>
<span class="org-comment-delimiter">// </span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">==&gt; Number in host (local machine) endianess. </span>
  <span class="org-type">uint16_t</span> <span class="org-variable-name">message_size</span> = 500; 
  <span class="org-comment-delimiter">// </span><span class="org-comment">==&gt; Number in network-byte-order (big-endian)</span>
  <span class="org-type">uint16_t</span> <span class="org-variable-name">data</span> = htonl<span class="org-rainbow-delimiters-depth-1">(</span>message_size<span class="org-rainbow-delimiters-depth-1">)</span>; 

 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> send<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;data, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint16_t<span class="org-rainbow-delimiters-depth-3">)</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">Handler error */</span> <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Functions that converts from network to host endianess: 
</p>

<ul class="org-ul">
<li><span class="underline">ntohl()</span> =&gt; Takes a number in network-endianess as argument and
returns a number in local-machine endiness. This funtion should be
used whenever the calling code is reading data from the network
via read() or recev() calls. 
<ul class="org-ul">
<li>Mneumonic: n-to-h-l (Network to Host Long)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">uint32_t</span> <span class="org-function-name">ntohl</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint32_t</span> <span class="org-variable-name">netlong</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------ Usage example / Reading data from network  ----------// </span>
<span class="org-type">uint32_t</span> <span class="org-variable-name">buffer</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Buffer variable will receive the data network-byte-order </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">or big-endian.</span>
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> recv<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;buffer,  <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint32_t<span class="org-rainbow-delimiters-depth-3">)</span>, 0 <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-comment-delimiter">/** </span><span class="org-comment">Error handling ... here */</span>  <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">OR: </span>
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> read<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;buffer,  <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint32_t<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-comment-delimiter">/** </span><span class="org-comment">Error handling ... here */</span>  <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Number in host endiness (byte order)</span>
<span class="org-type">uint32_t</span> <span class="org-variable-name">message_size</span> = nothl<span class="org-rainbow-delimiters-depth-1">(</span>buffer<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::fprintf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" Message size in bytes: %u \n"</span>, message_size<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">ntohs()</span> =&gt; Similar to ntohl, but uses with short type, or 16 bit
integers.
<ul class="org-ul">
<li>Mneumonic: n-to-h-s (Network to Host Short)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">uint16_t</span> <span class="org-function-name">ntohs</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">netshort</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Usage -----------------// </span>

 <span class="org-type">uint16_t</span> <span class="org-variable-name">number</span>; 
 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> recv<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, &amp;number,  <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>uint32_t<span class="org-rainbow-delimiters-depth-3">)</span>, 0 <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-comment-delimiter">/** </span><span class="org-comment">Error handling ... here */</span>  <span class="org-rainbow-delimiters-depth-1">}</span>

 number = ntohs<span class="org-rainbow-delimiters-depth-1">(</span>number<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Functions for resolving hostnames (DNS Query)</b> 
</p>

<ul class="org-ul">
<li>gethostbyname()
<ul class="org-ul">
<li>Translate hostname or IPv4 into IPv4 address. This function
performs a DNS query.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">hostent</span>*  <span class="org-function-name">gethostbyname</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">struct</span> <span class="org-type">hostent</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>  *<span class="org-variable-name">h_name</span>;            <span class="org-comment-delimiter">/* </span><span class="org-comment">official name of host */</span>
    <span class="org-type">char</span> **<span class="org-variable-name">h_aliases</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">alias list */</span>
    <span class="org-type">int</span>    <span class="org-variable-name">h_addrtype</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">host address type */</span>
    <span class="org-type">int</span>    <span class="org-variable-name">h_length</span>;          <span class="org-comment-delimiter">/* </span><span class="org-comment">length of address */</span>
    <span class="org-type">char</span> **<span class="org-variable-name">h_addr_list</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">list of addresses */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">h_addr</span> h_addr_list<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">for backward compatibility */</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org09ab76a" class="outline-4">
<h4 id="org09ab76a"><span class="section-number-4">1.27.3</span> Network Programming Pitfalls [DRAFT]</h4>
<div class="outline-text-4" id="text-1-27-3">
<p>
There are many pitfalls and edge-cases that a network-related can fall
in to. This section aims to outline those issues that affect network
code.  
</p>

<ul class="org-ul">
<li><span class="underline">Lack of error checking</span> 
<ul class="org-ul">
<li>=&gt; Most BSD-socket APIs and Unix APIs return (-1) when an error
happens and sets the errno global variable. If error is not
properly checked, the calling code may be subject to silent and subtle
failure without any warning. During the development assertions, assert(),
statements can be used as temporary placeholders for error
checking.</li>
</ul></li>

<li><span class="underline">TCP message boundary</span>
<ul class="org-ul">
<li>=&gt; The TCP protocol does not have message boundary, instead TCP
is a byte stream oritend protocol. Threfore, there is no way to
determine where a message begins or ends. For instance, if a
sender sends three messages of 100 bytes via send() or write()
functions and the peer socket attempts to read using three
calls to read() or recev() using 1000 bytes long buffer, only a
single a message will be received and the second call read() or
recev() may block the current thread.</li>

<li>Solutions:

<ul class="org-ul">
<li>=&gt; Use a fixed size message (buffer with constant lenght) on
both communication endpoints.</li>

<li>=&gt; Use custom delimiters for distinguishing the beginning and
end of messages.</li>

<li>=&gt; Send messages prefixed with number of bytes to be read.</li>

<li>=&gt; Replace TCP with <a href="https://en.wikipedia.org/wiki/Stream_Control_Transmission_Protocol">SCTP</a> (Stream Control Transmission
Protocol) which combines the best features of TCP and UDP. It
provides both the TCP realibility and UDP message-boundary
feature.</li>
</ul></li>
</ul></li>

<li><span class="underline">Partial-Reads</span>
<ul class="org-ul">
<li>=&gt; Socket functions such recev() or read() may return the
number of bytes read smaller than the buffer size, even though
there is still bytes avaiable and data sent has a fixed size
agreed by both socket endpoints. This edge-case scenario is called
<span class="underline">partial-read</span>, a robust network code should be keeping reading
the file descriptor until the buffer is filled or the
connection is closed.</li>
</ul></li>

<li><span class="underline">Partial-Writes</span>
<ul class="org-ul">
<li>=&gt; Functions write() or send() may also be affected by similar
edge-case to partial-reads and the number of bytes written
returned by write() or send() may be smaller than the buffer
size. In this case, the calling code, should be keeping sending
the remaining parts of the buffer until all data sent over the
network.</li>
</ul></li>

<li><span class="underline">Endianess</span> (Byte order for numeric types)
<ul class="org-ul">
<li>=&gt; In order to proper exchange a numeric type, both ends of a
connection must agree about data endianess, or byte-order
representation, since different processor architectures may have
different byte order data representation of numeric types. In
order to avoid a data being read in a wrong way, both sides of
the connection must use the same endianess, which is the
<span class="underline">network-byte-order</span> (big endian). So, a numeric value in machine
endianess (default) should be converted to <span class="underline">network-byte-order</span>
(big-endian) before being sent to the over the network, or
written to the file descriptor. And a numeric value received
from the network (socket file descriptor) must be converted
<span class="underline">from network-byte-order</span> to the current machine endianess.</li>
</ul></li>

<li><span class="underline">Fix-width integers</span> 
<ul class="org-ul">
<li>The fundamental integer types in C and C++, int, long, short,
long long are not guaranteed to have the same size in all
machine. For an instance, on Windows NT 64 bits the type 'long'
has 32 bits, while on Linux, the type 'long' has 64 bits. If a
socket server running on Linux attempts to send a value with
long type to a client socket running on a Windows machine, the
value will be interpreted in a incorrect way in the Windows
machine. Data misinterpretation such as the previous mentioned one
can be avoided by using fixed width integers instead of
fundamental integer types as fix-width integers such as uint8_t,
uint16_t, uint32_t, uint64_t, int8_t and so on, are guaranteed
to have the same size in all machines</li>

<li>Summary: User fix-width integers (headers: &lt;cstdint&gt; for C++ or
&lt;stdint.h&gt; for C) instead of fundamental types for avoiding
data interpretation disagreement.</li>
</ul></li>

<li><span class="underline">Sending and receiving structured data_</span>
<ul class="org-ul">
<li>Structs or C++ classes should not be sent or received directly
via read(), recev(), write() or send() functions due to many
issues related to ABI, machine endianess, type-sizes and
message-boundary. The first shortcoming is that the buffer
argument of the mentioned functions can only be a pointer to
POD type, which is a contiguous allocated type without any
internal pointer. Other shortcoming are the machine endianess
and compilers ABIs (Application Binary Interfaces) which may
lead to the data to corruption and and data misinterpretation.</li>

<li>Solution: Convert and serialize each member of struct or class
to an external data representation agreed by both connection
endpoints.</li>
</ul></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/5660070/send-a-struct-over-a-socket-with-correct-padding-and-endianness-in-c">tcp - Send a struct over a socket with correct padding and endianness in C - Stack Overflow</a></li>

<li><a href="https://www.codeproject.com/Articles/11922/Solution-for-TCP-IP-client-socket-message-boundary">Solution for TCP/IP client socket message boundary problem - CodeProject</a></li>

<li><a href="https://developer.ibm.com/tutorials/l-sockpit/">Five pitfalls of Linux sockets programming – IBM Developer</a></li>

<li><a href="https://barrgroup.com/embedded-systems/how-to/big-endian-little-endian">How Endianness Works: Big-Endian vs. Little Endian</a></li>

<li><a href="https://www.openmymind.net/2012/1/12/Reading-From-TCP-Streams/">Reading from TCP streams</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge5a4bd2" class="outline-4">
<h4 id="orge5a4bd2"><span class="section-number-4">1.27.4</span> Command Line Tools for Network Debugging</h4>
<div class="outline-text-4" id="text-1-27-4">
<p>
<b>Show Routing Table</b> 
</p>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.1        0.0.0.0         UG    600    0        0 wlp2s0
10.0.0.0        0.0.0.0         255.255.255.0   U     600    0        0 wlp2s0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 wlp2s0
</pre>
</div>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.0.0.1        0.0.0.0         UG        0 0          0 wlp2s0
10.0.0.0        0.0.0.0         255.255.255.0   U         0 0          0 wlp2s0
169.254.0.0     0.0.0.0         255.255.0.0     U         0 0          0 wlp2s0
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ netstat -rn

Routing tables

<span class="org-function-name">Internet</span>:
Destination        Gateway            Flags        Netif Expire
default            10.0.2.2           UGSc           en0       
10.0.2/24          link#8             UCS            en0      !
10.0.2.2/32        link#8             UCS            en0      !
10.0.2.2           52:55:a:0:2:2      UHLWIir        en0   1161
10.0.2.3           link#8             UHLWIi         en0      !
10.0.2.15/32       link#8             UCS            en0      !
10.0.2.15          52:54:0:9:49:17    UHLWI          lo0       
127                127.0.0.1          UCS            lo0       
127.0.0.1          127.0.0.1          UH             lo0       
169.254            link#8             UCS            en0      !
224.0.0/4          link#8             UmCS           en0      !
224.0.0.251        1:0:5e:0:0:fb      UHmLWI         en0       
255.255.255.255/32 link#8             UCS            en0      !

<span class="org-function-name">Internet6</span>:
Destination                             Gateway                         Flags         Netif Expire
default                                 fe80::2%en0                     UGc             en0       
default                                 fe80::%utun0                    UGcI          utun0       
default                                 fe80::%utun1                    UGcI          utun1       
::1                                     ::1                             UHL             lo0       
<span class="org-function-name">fe80</span>::%lo0/64                           fe80::1%lo0                     UcI             lo0       
<span class="org-function-name">fe80</span>::1%lo0                             link#1                          UHLI            lo0       
<span class="org-function-name">fe80</span>::%en0/64                           link#8                          UCI             en0       
<span class="org-function-name">fe80</span>::2%en0                             52:56:0:0:0:2                   UHLWIir         en0       
<span class="org-function-name">fe80</span>::cb9:425:579:f7ca%en0              52:54:0:9:49:17                 UHLI            lo0       
<span class="org-function-name">fe80</span>::%utun0/64                         fe80::69e6:edfe:e4dc:ccb3%utun0 UcI           utun0       
<span class="org-function-name">fe80</span>::69e6:edfe:e4dc:ccb3%utun0         link#9                          UHLI            lo0       
<span class="org-function-name">fe80</span>::%utun1/64                         fe80::1b23:740d:d7d0:b07d%utun1 UcI           utun1       
<span class="org-function-name">fe80</span>::1b23:740d:d7d0:b07d%utun1         link#10                         UHLI            lo0       
<span class="org-function-name">fec0</span>::/64                               link#8                          UC              en0       
<span class="org-function-name">fec0</span>::2                                 52:56:0:0:0:2                   UHLWI           en0       
<span class="org-function-name">fec0</span>::cee:fd13:3be4:8411                52:54:0:9:49:17                 UHL             lo0       
<span class="org-function-name">fec0</span>::2d6d:1074:dc19:b28a               52:54:0:9:49:17                 UHL             lo0       
<span class="org-function-name">ff01</span>::%lo0/32                           ::1                             UmCI            lo0       
<span class="org-function-name">ff01</span>::%en0/32                           link#8                          UmCI            en0       
<span class="org-function-name">ff01</span>::%utun0/32                         fe80::69e6:edfe:e4dc:ccb3%utun0 UmCI          utun0       
<span class="org-function-name">ff01</span>::%utun1/32                         fe80::1b23:740d:d7d0:b07d%utun1 UmCI          utun1       
<span class="org-function-name">ff02</span>::%lo0/32                           ::1                             UmCI            lo0       
<span class="org-function-name">ff02</span>::%en0/32                           link#8                          UmCI            en0       
<span class="org-function-name">ff02</span>::%utun0/32                         fe80::69e6:edfe:e4dc:ccb3%utun0 UmCI          utun0       
<span class="org-function-name">ff02</span>::%utun1/32                         fe80::1b23:740d:d7d0:b07d%utun1 UmCI          utun1   
</pre>
</div>

<p>
<b>Network interfaces</b>
</p>

<p>
For newer Linux distributions: 
</p>

<ul class="org-ul">
<li>The following command shows that the current machine has three
network interfaces. <span class="underline">lo</span> is a virtual network interface that
corresponds to localhost (127.0.0.1); enps10 =&gt; corresponds to a
ethernet network card, wbhich is not active; and finally wlp2s0
which is a wifi network card, which the IPv4 address on the local
network is 10.0.0.175 and IPv6 address is
fe81::88a:6b9c:fcef:4e32.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ip addr

<span class="org-function-name">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever

<span class="org-function-name">2</span>: enp1s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN group default qlen 1000
    link/ether 9a:8b:8c:f2:b3:d4 brd ff:ff:ff:ff:ff:ff

<span class="org-function-name">3</span>: wlp2s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 9a:8c:8a:ef:ff:0c brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.175/24 brd 10.0.0.255 scope global dynamic noprefixroute wlp2s0
       valid_lft 84718sec preferred_lft 84718sec
    inet6 fe81::88a:6b9c:fcef:4e32/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
</pre>
</div>


<p>
For BSD, MacOSX and older Linux Distributions. 
</p>

<ul class="org-ul">
<li>Note: The ifconfig cli application is deprecated on most Linux
distributions and was replaced by the <span class="underline">ip</span> command..</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">On MacOSX VM </span>
$ ifconfig

<span class="org-function-name">lo0</span>: <span class="org-variable-name">flags</span>=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu 16384
        <span class="org-variable-name">options</span>=1203&lt;RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP&gt;
        inet 127.0.0.1 netmask 0xff000000 
        inet6 ::1 prefixlen 128 
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1 
        nd6 <span class="org-variable-name">options</span>=201&lt;PERFORMNUD,DAD&gt;

<span class="org-function-name">gif0</span>: <span class="org-variable-name">flags</span>=8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1280

<span class="org-function-name">stf0</span>: <span class="org-variable-name">flags</span>=0&lt;&gt; mtu 1280

<span class="org-function-name">UHC29</span>: <span class="org-variable-name">flags</span>=0&lt;&gt; mtu 0

<span class="org-function-name">UHC93</span>: <span class="org-variable-name">flags</span>=0&lt;&gt; mtu 0

<span class="org-function-name">EHC253</span>: <span class="org-variable-name">flags</span>=0&lt;&gt; mtu 0

<span class="org-function-name">UHC61</span>: <span class="org-variable-name">flags</span>=0&lt;&gt; mtu 0

<span class="org-function-name">en0</span>: <span class="org-variable-name">flags</span>=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        <span class="org-variable-name">options</span>=424&lt;VLAN_MTU,TSO4,CHANNEL_IO&gt;
        ether 51:53:2a:f8:49:27 
        inet6 fe20::cc9:4a5:549:f7ca%en0 prefixlen 64 secured scopeid 0x8 
        inet6 fec0::cab:f513:8be4:9251 prefixlen 64 autoconf secured 
        inet6 fec0::2c6a:1276:dc19:b29a prefixlen 64 autoconf temporary 
        inet 10.0.2.20 netmask 0xffffff00 broadcast 10.0.2.255
        nd6 <span class="org-variable-name">options</span>=201&lt;PERFORMNUD,DAD&gt;
        media: autoselect (1000baseT &lt;full-duplex&gt;)
        status: active

<span class="org-function-name">utun0</span>: <span class="org-variable-name">flags</span>=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1380
        inet6 fe80::69f6:edfe:84dc:acb3%utun0 prefixlen 64 scopeid 0x9 
        nd6 <span class="org-variable-name">options</span>=201&lt;PERFORMNUD,DAD&gt;

<span class="org-function-name">utun1</span>: <span class="org-variable-name">flags</span>=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 2000
        inet6 fe80::1b2c:7424:d7d0:ca7d%utun1 prefixlen 64 scopeid 0xa 
        nd6 <span class="org-variable-name">options</span>=201&lt;PERFORMNUD,DAD&gt;
</pre>
</div>


<p>
<b>Display all listening TCP sockets and open ports</b> (socket servers)
</p>

<div class="org-src-container">
<pre class="src src-text"> $ &gt;&gt; netstat --listening -tnp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:9000            0.0.0.0:*               LISTEN      142308/python       
tcp        0      0 192.168.100.1:53        0.0.0.0:*               LISTEN      -                   
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:9056            0.0.0.0:*               LISTEN      434583/./poll-serve 
tcp6       0      0 :::9070                 :::*                    LISTEN      131190/java         
tcp6       0      0 :::8080                 :::*                    LISTEN      100425/java         
tcp6       0      0 ::1:631                 :::*                    LISTEN      -                   
tcp6       0      0 :::9080                 :::*                    LISTEN      100272/java    
</pre>
</div>

<p>
<b>List all UDP connections</b> 
</p>

<pre class="example">
$ netstat --udp
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
udp        0      0 localhost.locald:bootpc _gateway:bootps         ESTABLISHED
</pre>

<p>
<b>Display all Listening TCP/IP, UDP/IP and Unix Domain Sockets</b> 
</p>

<pre class="example">
 $ &gt;&gt; netstat --listening -p
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:cslistener      0.0.0.0:*               LISTEN      142308/python       
tcp        0      0 localhost.locald:domain 0.0.0.0:*               LISTEN      -                   
tcp        0      0 localhost.locald:domain 0.0.0.0:*               LISTEN      -    
  ...   ...   ...   ...   ...   ...   ...   ...   ... 
  ...   ...   ...   ...   ...   ...   ...   ...   ...   ... 

unix  2      [ ACC ]     STREAM     LISTENING     45857    1720/systemd         /run/user/1000/systemd/private
unix  2      [ ACC ]     STREAM     LISTENING     116650   -                    @/tmp/.X11-unix/X0
unix  2      [ ACC ]     STREAM     LISTENING     125379   7281/Xorg            @/tmp/.X11-unix/X1
unix  2      [ ACC ]     STREAM     LISTENING     780071   7994/emacs           /run/user/1000/emacs/server
unix  2      [ ACC ]     STREAM     LISTENING     45863    1720/systemd         /run/user/1000/bus
unix  2      [ ACC ]     STREAM     LISTENING     45866    1720/systemd         /run/user/1000/pipewire-0
unix  2      [ ACC ]     STREAM     LISTENING     45868    1720/systemd         /run/user/1000/pulse/native
unix  2      [ ACC ]     STREAM     LISTENING     2443571  388596/code --no-sa  /run/user/1000/vscode-1d972a5c-1.45.1-main.sock
unix  2      [ ACC ]     STREAM     LISTENING     77108    3932/tmux            /tmp//tmux-1000/default
unix  2      [ ACC ]     STREAM     LISTENING     3152439  456731/code          /run/user/1000/vscode-git-be7a37b432.sock
unix  2      [ ACC ]     STREAM     LISTENING     36623    -                    @/tmp/dbus-00sao3pj

</pre>


<p>
<b>Show ARP table</b> 
</p>

<div class="org-src-container">
<pre class="src src-text">$ arp 
Address                  HWtype  HWaddress           Flags Mask            Iface
_gateway                 ether   21:fe:1d:78:d4:28   C                     wl_1s22f0u4
10.0.1.113               ether   7b:3f:24:57:2b:9c   C                     wlp1s22f0u4
10.0.1.156               ether   80:92:26:87:ab:8f   C  
</pre>
</div>
</div>
</div>

<div id="outline-container-org917df03" class="outline-4">
<h4 id="org917df03"><span class="section-number-4">1.27.5</span> Simple TCP/IP client socket</h4>
<div class="outline-text-4" id="text-1-27-5">
<p>
Description: 
</p>

<ul class="org-ul">
<li>This sample code contains a simple TCP/IP client socket
application that connects to a <span class="underline">netcat</span> running as server.</li>
</ul>

<p>
GIST Containing source: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/9ef302d0c813ecb609b0b43c454ed923">https://gist.github.com/9ef302d0c813ecb609b0b43c454ed923</a></li>
</ul>

<p>
File: <span class="underline">client-sock1.cpp</span>  
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Use: assert() for marking placeholders for future error handling.</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">std::string </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy, memset and so on</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">OPERATION_FAILURE</span> = -1;

<span class="org-comment-delimiter">// </span><span class="org-comment">Read buffer from file descriptor handling partial reads.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: It should only be used if the counterpart socket, sends </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">a buffer of equal to the size of this 'size' parameter.</span>
<span class="org-type">void</span> <span class="org-function-name">read_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Write buffer to file descriptor handling partial writes;</span>
<span class="org-type">void</span> <span class="org-function-name">write_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Send text with '\n' UNIX (EOL) end line character.</span>
<span class="org-type">void</span> <span class="org-function-name">write_line</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">======= Server port and hostname configuration ===========//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">The port should be a 16 bits number </span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">(Ports less than 1024 requires administrative/root privilege.)</span>
     <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span> = 8095;
     <span class="org-comment-delimiter">// </span><span class="org-comment">'127.0.0.1' for local host (LO Network interface)</span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = <span class="org-string">"127.0.0.1"</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">======= Create socket file descriptor =====================//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET       <span class="org-comment-delimiter">// </span><span class="org-comment">domain:   IPv4</span>
                          , SOCK_STREAM   <span class="org-comment-delimiter">// </span><span class="org-comment">type:     TCP </span>
                          , 0             <span class="org-comment-delimiter">// </span><span class="org-comment">protocol: (value 0) </span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure      </span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != OPERATION_FAILURE<span class="org-rainbow-delimiters-depth-2">)</span>;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">=========== Query Address (DNS query) =======================//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant). </span>
     <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">memset(&amp;sa, 0x00, sizeof(sa));</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">set address </span>
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">//</span><span class="org-comment">bcopy( h-&gt;h_addr, &amp;sa.sin_addr.s_addr, h-&gt;h_length );</span>

     sa.sin_family = AF_INET;
     <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format. </span>
     sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">======== Attempt connection to server ========================//</span>

    <span class="org-type">int</span> <span class="org-variable-name">conn_result</span> = connect<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Socket file descriptor </span>
                               sockfd
                               <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer sockaddr =&gt; Structure containing host address </span>
                             , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;sa<span class="org-rainbow-delimiters-depth-3">)</span>
                               <span class="org-comment-delimiter">// </span><span class="org-comment">Size of sockaddr buffer in bytes </span>
                             , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> conn_result == OPERATION_FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Unable to connect to server. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">//</span><span class="org-comment">============= Session Loop ===================================//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Send a buffer (untyped memory location) ----------// </span>
    <span class="org-type">char</span> <span class="org-variable-name">start_message</span><span class="org-rainbow-delimiters-depth-2">[</span>500<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-constant">std</span>::memset<span class="org-rainbow-delimiters-depth-2">(</span>start_message, <span class="org-string">'\0'</span>, 500<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::strcpy<span class="org-rainbow-delimiters-depth-2">(</span>start_message, <span class="org-string">" [CLIENT] &lt;MESSAGE 1&gt; Hi there, server, I am the client socket \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    write_buffer<span class="org-rainbow-delimiters-depth-2">(</span> sockfd, start_message, strlen<span class="org-rainbow-delimiters-depth-3">(</span>start_message<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Send text --------------------------------------//</span>
    write_line<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, <span class="org-string">" [CLIENT] &lt;MESSAGE 2&gt; Hi there, server, I was sent by the client-side \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Session Loop ------------------------------//</span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>        
        <span class="org-comment-delimiter">// </span><span class="org-comment">Clean buffer before each iteratiion </span>
        <span class="org-constant">std</span>::memset<span class="org-rainbow-delimiters-depth-3">(</span>buffer, 0x00, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [TRACE] Waiting for server input. "</span> 
                             <span class="org-string">" =&gt;&gt; Type something in the server netcat terminal and hit RETURN. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-type">ssize_t</span> <span class="org-variable-name">r</span> = read<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, buffer, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>r == 0<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [TRACE] Server has closed the connection. "</span> 
                               <span class="org-string">"User types CTRL + D in the server-side terminal. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> r == -1<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [TRACE] An error has happend Check ERRNO. "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span> 

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [SERVER DATA] Server has sent: %s \n"</span>, buffer<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Send data back to server </span>
        write_buffer<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, buffer, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of session loop ---------------------------//</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [INFO] Session shutdown OK \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------//</span>
    <span class="org-comment-delimiter">//          </span><span class="org-comment">I M P L E M E N T A T I O N S                //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">read_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Pre-condition </span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> size &lt;= SSIZE_MAX  <span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-type">size_t</span>  <span class="org-variable-name">len</span>  = size;
   <span class="org-type">ssize_t</span> <span class="org-variable-name">nr</span>   = -1;
   <span class="org-comment-delimiter">// </span><span class="org-comment">Note: std::byte (C++17) is a better replacement for char* or std::uint8_t </span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">as std::byte is more effective for conveying the intent.</span>
   <span class="org-keyword">auto</span> <span class="org-variable-name">pbuf</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">byte</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>; 

   <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Waiting input \n"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>  len != 0 &amp;&amp; <span class="org-rainbow-delimiters-depth-3">(</span> nr = read<span class="org-rainbow-delimiters-depth-4">(</span>fd, pbuf, len<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span> 
   <span class="org-rainbow-delimiters-depth-2">{</span>

       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1 &amp;&amp; errno == EINTR<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> 
           <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"An error has happened, check ERRNO "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
           <span class="org-keyword">break</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>
       len  = len - nr; 
       pbuf = pbuf + nr;

       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] len = "</span> &lt;&lt; len &lt;&lt; <span class="org-string">" ; nr = "</span> &lt;&lt; nr &lt;&lt; <span class="org-string">'\n'</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Loop finished. \n"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">write_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Pre-condition </span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> size &lt;= SSIZE_MAX  <span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-type">size_t</span>  <span class="org-variable-name">len</span>  = size;
   <span class="org-type">ssize_t</span> <span class="org-variable-name">nr</span>   = -1;
   <span class="org-keyword">auto</span> <span class="org-variable-name">pbuf</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">uint8_t</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>; 

  <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>  len != 0 &amp;&amp; <span class="org-rainbow-delimiters-depth-3">(</span> nr = write<span class="org-rainbow-delimiters-depth-4">(</span>fd, pbuf, len<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1 &amp;&amp; errno == EINTR<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> 
          <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"An error has happened, check ERRNO "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
      <span class="org-rainbow-delimiters-depth-3">}</span>
      len  = len - nr; 
      pbuf = pbuf + nr;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">write_line</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    write_buffer<span class="org-rainbow-delimiters-depth-2">(</span>fd, text.data<span class="org-rainbow-delimiters-depth-3">()</span>, text.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">char</span> <span class="org-variable-name">ch</span> = <span class="org-string">'\n'</span>;
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;ch, 1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ sock-client1.cpp -std=c++1z -Wall -Wextra -g -O0
</pre>
</div>

<p>
Run netcat as server in terminal 1 (server-side) listening port 8095:
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; nc -v -l 8095
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Listening on :::8095
<span class="org-function-name">Ncat</span>: Listening on 0.0.0.0:8095
<span class="org-function-name">Ncat</span>: Connection from 127.0.0.1.
<span class="org-function-name">Ncat</span>: Connection from 127.0.0.1:33180.
 [CLIENT] &lt;MESSAGE 1&gt; Hi there, server, I am the client socket 
 [CLIENT] &lt;MESSAGE 2&gt; Hi there, server, I was sent by the client-side 

Message to be sent to client-side
Message to be sent to client-side
Hello world client side
Hello world client side
I am the server - I provide network services such as tensor calculations
I am the server - I provide network services such as tensor calculations
I will type CTRL + D and shutdown the connection after this message
I will type CTRL + D and shutdown the connection after this message
</pre>
</div>

<p>
Run sock-client1.bin in terminal 2 connecting to port 8095 from local host:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./sock-client1.bin 
 [TRACE] Waiting for server input.  =&gt;&gt; Type something<span class="org-keyword"> in</span> the server netcat terminal and hit RETURN. 
 [SERVER DATA] Server has sent: Message to be sent to client-side

 [TRACE] Waiting for server input.  =&gt;&gt; Type something<span class="org-keyword"> in</span> the server netcat terminal and hit RETURN. 
 [SERVER DATA] Server has sent: Hello world client side

 [TRACE] Waiting for server input.  =&gt;&gt; Type something<span class="org-keyword"> in</span> the server netcat terminal and hit RETURN. 
 [SERVER DATA] Server has sent: I am the server - I provide network services such as tensor calculations

 [TRACE] Waiting for server input.  =&gt;&gt; Type something<span class="org-keyword"> in</span> the server netcat terminal and hit RETURN. 
 [SERVER DATA] Server has sent: I will type CTRL + D and shutdown the connection after this message

 [TRACE] Waiting for server input.  =&gt;&gt; Type something<span class="org-keyword"> in</span> the server netcat terminal and hit RETURN. 
 [TRACE] Server has closed the connection. User types CTRL + D<span class="org-keyword"> in</span> the server-side terminal. 
 [INFO] Session shutdown OK 

</pre>
</div>
</div>
</div>
<div id="outline-container-orgc2d2902" class="outline-4">
<h4 id="orgc2d2902"><span class="section-number-4">1.27.6</span> Simple TCP/IP socket echo server</h4>
<div class="outline-text-4" id="text-1-27-6">
<p>
Description: 
</p>

<ul class="org-ul">
<li>Sample code for a single-thread TCP/IP socket server listening at
port 8095.</li>
</ul>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/6337cd80b9eadad26f386320c1c67cc6">https://gist.github.com/6337cd80b9eadad26f386320c1c67cc6</a></li>
</ul>

<p>
File: socket-echo-server.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread. </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">The port should be a 16 bits number (Note: binding to some low port numbers </span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">requires administrative/root privilege.)</span>
     <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span> = 8095;

     <span class="org-comment-delimiter">// </span><span class="org-comment">The address can be: </span>
     <span class="org-comment-delimiter">//   </span><span class="org-comment">'0.0.0.0'   for listening all hosts </span>
     <span class="org-comment-delimiter">//   </span><span class="org-comment">'127.0.0.1' for local host </span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = <span class="org-string">"0.0.0.0"</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET       <span class="org-comment-delimiter">// </span><span class="org-comment">domain:   IPv4</span>
                          , SOCK_STREAM   <span class="org-comment-delimiter">// </span><span class="org-comment">type:     TCP </span>
                          , 0             <span class="org-comment-delimiter">// </span><span class="org-comment">protocol: (value 0) </span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure </span>
     assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant). </span>
     <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">memset(&amp;sa, 0x00, sizeof(sa));</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">set address </span>
     memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">//</span><span class="org-comment">bcopy( h-&gt;h_addr, &amp;sa.sin_addr.s_addr, h-&gt;h_length );</span>

     sa.sin_family = AF_INET;
     <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format. </span>
     sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>; 

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address </span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--------------- Server Main Loop --------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Infinite loop where client connections are handled</span>
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>  
         <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== BEGIN client loop =========== ]] */</span>

         <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">client_sa</span>; 
         <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span>; 

         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
              fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
              close<span class="org-rainbow-delimiters-depth-4">(</span>sock_client<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-keyword">continue</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>
         <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">welcome_msg</span> = <span class="org-string">"\n =&gt; [INFO] Hello world client side!! \n"</span>;     

         <span class="org-comment-delimiter">// </span><span class="org-comment">Send buffer content to client socket </span>
         send<span class="org-rainbow-delimiters-depth-3">(</span>sock_client, welcome_msg, strlen<span class="org-rainbow-delimiters-depth-4">(</span>welcome_msg<span class="org-rainbow-delimiters-depth-4">)</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>300<span class="org-rainbow-delimiters-depth-3">]</span>;

         <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-3">){</span>
             <span class="org-comment-delimiter">// </span><span class="org-comment">Read message from client socket </span>
             <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = recv<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, &amp;buffer, 300, 0<span class="org-rainbow-delimiters-depth-4">)</span>;
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

             <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [INFO] Received: "</span><span class="org-rainbow-delimiters-depth-4">)</span>;            
             ::write<span class="org-rainbow-delimiters-depth-4">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;

             <span class="org-comment-delimiter">// </span><span class="org-comment">Send content back </span>
             send<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, buffer, n, 0<span class="org-rainbow-delimiters-depth-4">)</span>;

             <span class="org-comment-delimiter">// </span><span class="org-comment">Compare 4 first bytes of buffer and 'quit' </span>
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> strncmp<span class="org-rainbow-delimiters-depth-5">(</span>buffer, <span class="org-string">"quit"</span>, 4<span class="org-rainbow-delimiters-depth-5">)</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">{</span>
                 fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Shutdown connection. Ok. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-comment-delimiter">// </span><span class="org-comment">Close client connection </span>
                 shutdown<span class="org-rainbow-delimiters-depth-5">(</span>sock_client, SHUT_RDWR<span class="org-rainbow-delimiters-depth-5">)</span>;
                 close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-keyword">break</span>;
             <span class="org-rainbow-delimiters-depth-4">}</span>          
         <span class="org-rainbow-delimiters-depth-3">}</span>

     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]] */</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here. </span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ socket-echo-server.cpp -o <span class="org-keyword">socket-echo-server.elf</span> -std=c++1z -Wall -Wextra
</pre>
</div>

<p>
Running server: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./socket-echo-server.elf 
 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Waiting for client connection. 
c++1z ada spark high performance
c++2z c++20 C++17 c++14 C89 c90 ancient unix
quit
 [TRACE] Shutdown connection. Ok. 
 [TRACE] Waiting for client connection. 

</pre>
</div>

<p>
Running client: (netcat tool)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc localhost 8095

 =&gt; [INFO] Hello world client side!! 
c++1z ada spark high performance
c++1z ada spark high performance
c++2z c++20 C++17 c++14 C89 c90 ancient unix
c++2z c++20 C++17 c++14 C89 c90 ancient unix
quit
quit

^C
</pre>
</div>
</div>
</div>
<div id="outline-container-org632e784" class="outline-4">
<h4 id="org632e784"><span class="section-number-4">1.27.7</span> Simple Unix-domain socket echo server</h4>
<div class="outline-text-4" id="text-1-27-7">
<p>
Unix domain-socket (not confuse with BSD socket) is an inter-process
mechanism that allows usage of socket communication on local machine
with less overhead than TCP/IP socket. A significat difference between
IP sockets and Unix sockets is that unlike IP-based sockets, Unix
domain sockets use file path or abstract namespace not bound to file
system as address instead of 
</p>

<p>
The most important usages of Unix-domain sockets are: 
</p>

<ul class="org-ul">
<li>Implementing network transparency.</li>

<li>IPC - Inter Process Network Communication,</li>

<li>Privilege separation (Security)</li>
</ul>


<p>
<b>Known usage</b> 
</p>

<ul class="org-ul">
<li><span class="underline">DBUS</span> - Linux DBUS</li>

<li><span class="underline">X11</span> - X Windows Systems uses Unix Domain Sockets locally for
enabling network transparency. A code using Unix Domain socket
needs does not need many changes for using IP-based sockets and
operate over the network.</li>

<li><span class="underline">Docker Container Engine</span> - Docker uses Unix Domain Sockets for
privilege separation and network transparency. The docker damenon,
running with root (administrative) privilege and the docker
client, running without administrative privilege, communicate via
Unix domain sockets on local machine and or via TCP/IP sockets
over the ĩnternt.</li>
</ul>

<p>
<b>See also</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man7/unix.7.html">unix(7) - Linux manual page</a></li>

<li><a href="https://en.wikipedia.org/wiki/Unix_domain_socket">Unix domain socket - Wikipedia</a></li>

<li><a href="https://serverfault.com/questions/124517/what-is-the-difference-between-unix-sockets-and-tcp-ip-sockets">networking - What is the difference between Unix sockets and TCP/IP sockets? - Server Fault</a></li>
</ul>

<p>
<b>Sample Code</b> 
</p>

<p>
GIST:  
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/ac308ab6a4cd8d92f02b4f9baeb910f3">https://gist.github.com/ac308ab6a4cd8d92f02b4f9baeb910f3</a></li>
</ul>

<p>
File: unix-domain-echo-server.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread. </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/un.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">unix_sock_file</span> = <span class="org-string">"/tmp/unix-socket-file"</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_UNIX, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_un</span> <span class="org-variable-name">sa</span>; 
     sa.sun_family = AF_UNIX; 
     strcpy<span class="org-rainbow-delimiters-depth-2">(</span> sa.sun_path, unix_sock_file<span class="org-rainbow-delimiters-depth-2">)</span>;  

     <span class="org-comment-delimiter">// </span><span class="org-comment">Remove file if it exists.   </span>
     unlink<span class="org-rainbow-delimiters-depth-2">(</span>unix_sock_file<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to unix domain socket and wait for client connections ---------//</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno; 
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] =&gt; %s"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>err<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address </span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>


     fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--------------- Server Main Loop --------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Infinite loop where client connections are handled</span>
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>  
           <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== BEGIN client loop =========== ]] */</span>

           <span class="org-keyword">struct</span> <span class="org-type">sockaddr_un</span> <span class="org-variable-name">client_sa</span>; 
           <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_un<span class="org-rainbow-delimiters-depth-3">)</span>; 

           fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-3">)</span>;

           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-3">)</span>
           <span class="org-rainbow-delimiters-depth-3">{</span>
                   fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                   close<span class="org-rainbow-delimiters-depth-4">(</span>sock_client<span class="org-rainbow-delimiters-depth-4">)</span>;
                   <span class="org-keyword">continue</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>
           <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">welcome_msg</span> = <span class="org-string">"\n =&gt; [INFO] Hello world client side!! \n"</span>;       

           <span class="org-comment-delimiter">// </span><span class="org-comment">Send buffer content to client socket </span>
           send<span class="org-rainbow-delimiters-depth-3">(</span>sock_client, welcome_msg, strlen<span class="org-rainbow-delimiters-depth-4">(</span>welcome_msg<span class="org-rainbow-delimiters-depth-4">)</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;

           <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>300<span class="org-rainbow-delimiters-depth-3">]</span>;

           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-3">){</span>
                 <span class="org-comment-delimiter">// </span><span class="org-comment">Read message from client socket </span>
                 <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = recv<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, &amp;buffer, 300, 0<span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

                 <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [INFO] Received: "</span><span class="org-rainbow-delimiters-depth-4">)</span>;            
                 ::write<span class="org-rainbow-delimiters-depth-4">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;

                 <span class="org-comment-delimiter">// </span><span class="org-comment">Send content back </span>
                 send<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, buffer, n, 0<span class="org-rainbow-delimiters-depth-4">)</span>;

                 <span class="org-comment-delimiter">// </span><span class="org-comment">Compare 4 first bytes of buffer and 'quit' </span>
                 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> strncmp<span class="org-rainbow-delimiters-depth-5">(</span>buffer, <span class="org-string">"quit"</span>, 4<span class="org-rainbow-delimiters-depth-5">)</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span>
                 <span class="org-rainbow-delimiters-depth-4">{</span>
                    fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Shutdown connection. Ok. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Close client connection </span>
                    shutdown<span class="org-rainbow-delimiters-depth-5">(</span>sock_client, SHUT_RDWR<span class="org-rainbow-delimiters-depth-5">)</span>;
                    close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                    <span class="org-keyword">break</span>;
                 <span class="org-rainbow-delimiters-depth-4">}</span>          
         <span class="org-rainbow-delimiters-depth-3">}</span>

   <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]] */</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here. </span>
   close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-domain-echo-server.cpp -o <span class="org-keyword">unix-domain-echo-server.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Run server: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-domain-echo-server.bin 
 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Waiting for client connection. 
unix irix posix linux macosx kernel
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp

quit
 [TRACE] Shutdown connection. Ok. 
 [TRACE] Waiting for client connection. 
</pre>
</div>

<p>
Run client (netcat) : 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v -U /tmp/unix-socket-file 
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connected to /tmp/unix-socket-file.

 =&gt; [INFO] Hello world client side!! 
unix irix posix linux macosx kernel
unix irix posix linux macosx kernel
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp


quit
quit
^C
</pre>
</div>

<p>
Check unix-socket file: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file /tmp/unix-socket-file 
<span class="org-function-name">/tmp/unix-socket-file</span>: socket

$ ls -l /tmp/unix-socket-file 
srwxrwxr-x 1 mxpkf8 mxpkf8 0 Jul  2 01:22 /tmp/unix-socket-file=
</pre>
</div>
</div>
</div>
<div id="outline-container-org754849d" class="outline-4">
<h4 id="org754849d"><span class="section-number-4">1.27.8</span> Telnet-like application</h4>
<div class="outline-text-4" id="text-1-27-8">
<p>
The following code is a sample telent-like application, which provide
remote access to interactive shells (REPLs read-eval-print-loop) from
local machine, where the application is running. The application can
work in server or client mode. When running in client mode, it
attempts to connect to remote netcat server. When running in server
mode, the application accepts connection from any netcat
server. Interactive shells are applications such as: irb (Ruby shell);
ash shell; TCL shell and so on. 
</p>

<p>
File: <span class="underline">rsh-server.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple telnet-like server.</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">UNIX_FAILURE</span> = -1;

<span class="org-comment-delimiter">// </span><span class="org-comment">Create server socket and return its file descriptor.</span>
<span class="org-type">int</span>  <span class="org-function-name">create_server</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Spawn a process and redirect its standard streams</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">to socket (stderr, stdin, stdout)</span>
<span class="org-type">void</span> <span class="org-function-name">spawn_redirect</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">executable</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Send text message to socket</span>
<span class="org-type">void</span> <span class="org-function-name">send_msg</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Connect to remote server and return client socket file descriptor.</span>
<span class="org-type">int</span> <span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Handle session between server and client.</span>
<span class="org-type">void</span> <span class="org-function-name">session_handler</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Placeholder for future error handling.</span>
     assert<span class="org-rainbow-delimiters-depth-2">(</span> argc == 4 &amp;&amp; <span class="org-string">" Requires at least three arguments. "</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = -1;
     <span class="org-keyword">auto</span> <span class="org-variable-name">command</span>  = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
     <span class="org-keyword">auto</span> <span class="org-variable-name">hostname</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
     <span class="org-type">int</span> <span class="org-variable-name">port</span>      = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Run as client mode =&gt; Forwarding the shell to the server.</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"client"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         sockfd = socket_connect<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, port<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> sockfd &gt; 0 <span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [OK   ] Connected to server. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">else</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Conncection failure. Retry. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         session_handler<span class="org-rainbow-delimiters-depth-3">(</span>sockfd<span class="org-rainbow-delimiters-depth-3">)</span>;
         sleep<span class="org-rainbow-delimiters-depth-3">(</span>2<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">---- End of client command ---- //</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Run in server mode =&gt; Liste connection.</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"server"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         sockfd = create_server<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, port, 5<span class="org-rainbow-delimiters-depth-3">)</span>;
         assert<span class="org-rainbow-delimiters-depth-3">(</span> sockfd != -1 <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-comment-delimiter">// </span><span class="org-comment">============= Server Event Loop =============//</span>
         <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">){</span>

             <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">client_sa</span>;
             <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-4">)</span>;

             fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
             <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-4">(</span>sockfd, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-5">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-4">)</span>;

             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">{</span>
                 fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                 close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-keyword">continue</span>;
             <span class="org-rainbow-delimiters-depth-4">}</span>

             session_handler<span class="org-rainbow-delimiters-depth-4">(</span>sock_client<span class="org-rainbow-delimiters-depth-4">)</span>;

         <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of for(;;) server loop ------//</span>

     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of server command ---//</span>


     <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here.</span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>


   <span class="org-comment-delimiter">// </span><span class="org-comment">=============================================//</span>
   <span class="org-comment-delimiter">//          </span><span class="org-comment">D E F I N I T I O N S               //</span>
   <span class="org-comment-delimiter">//</span><span class="org-comment">==============================================//</span>

<span class="org-type">int</span> <span class="org-function-name">create_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span> AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Future error handling.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure</span>
     assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant).</span>
     <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
     memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
     sa.sin_family = AF_INET;
     <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format.</span>
     sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address</span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">return</span> sockfd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> =  socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert() =&gt; Placeholder for future error handling.</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != UNIX_FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Query DNS</span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> h != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">int</span> <span class="org-variable-name">res</span> = connect<span class="org-rainbow-delimiters-depth-2">(</span> sockfd
                     , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;sa<span class="org-rainbow-delimiters-depth-3">)</span>
                     , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> res == -1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> -1; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> sockfd;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">send_msg</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    send<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, message, strlen<span class="org-rainbow-delimiters-depth-3">(</span>message<span class="org-rainbow-delimiters-depth-3">)</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">spawn_redirect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">executable</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-keyword">switch</span> <span class="org-rainbow-delimiters-depth-2">(</span>pid<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">case</span> -1:
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to fork process. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">break</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Child Process ------------//</span>
    <span class="org-keyword">case</span> 0: <span class="org-rainbow-delimiters-depth-3">{</span>

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stderr, <span class="org-string">" [TRACE] Spawning process (PID = %d ) shell: %s \n"</span>
                    , ::getpid<span class="org-rainbow-delimiters-depth-5">()</span>, executable<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect standard streams to socket file descriptor</span>
        dup2<span class="org-rainbow-delimiters-depth-4">(</span>sockfd, STDOUT_FILENO<span class="org-rainbow-delimiters-depth-4">)</span>;
        dup2<span class="org-rainbow-delimiters-depth-4">(</span>sockfd, STDIN_FILENO <span class="org-rainbow-delimiters-depth-4">)</span>;
        dup2<span class="org-rainbow-delimiters-depth-4">(</span>sockfd, STDERR_FILENO<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span> <span class="org-rainbow-delimiters-depth-4">[]</span> = <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-string">"rshell"</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Process name (arbitrary)</span>
            , <span class="org-constant">nullptr</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Sentinel value - (always NULL pointer)</span>
        <span class="org-rainbow-delimiters-depth-4">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Spawn a new process.</span>
        <span class="org-type">int</span> <span class="org-variable-name">status</span> = execvp<span class="org-rainbow-delimiters-depth-4">(</span> executable, <span class="org-keyword">const_cast</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">char</span>* <span class="org-keyword">const</span>*<span class="org-rainbow-delimiters-depth-5">&gt;(</span>args<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> status == UNIX_FAILURE <span class="org-rainbow-delimiters-depth-4">){</span>
            <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
            send_msg<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, <span class="org-string">" [SERVER ERROR] Unable to locate REPL \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            send_msg<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, strerror<span class="org-rainbow-delimiters-depth-6">(</span>err<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            close<span class="org-rainbow-delimiters-depth-5">(</span>sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;
            exit<span class="org-rainbow-delimiters-depth-5">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span>

    <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">break</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">----------- Parent Process ------------//</span>
    <span class="org-keyword">default</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination.</span>
        ::waitpid<span class="org-rainbow-delimiters-depth-3">(</span>pid, <span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">break</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">session_handler</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">SIZE</span> = 500;
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>500<span class="org-rainbow-delimiters-depth-2">]</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Always initialize buffer for avoiding undefined behavior.</span>
    <span class="org-constant">std</span>::memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, 0x00, SIZE<span class="org-rainbow-delimiters-depth-2">)</span>;

    send_msg<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, <span class="org-string">"Enter the shell to be spawned: "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::recv<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, buffer, SIZE, 0<span class="org-rainbow-delimiters-depth-3">)</span> &lt;= 0<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Connection error or peer closed connection \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Waiting for child process termination. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Remove '\n' end line character if it is found.</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-type">char</span>* <span class="org-variable-name">ptr_char</span> = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">)</span> ::memchr<span class="org-rainbow-delimiters-depth-3">(</span>buffer, <span class="org-string">'\n'</span>, SIZE<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> *ptr_char = <span class="org-string">'\0'</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fork a new process (run executable indicated by the buffer).</span>
    spawn_redirect<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Child process terminated Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Running on MacOSX</b> 
</p>

<p>
Building on MacOSX Catalina: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ rsh-server.cpp -o <span class="org-keyword">rsh-server.osx</span> -std=c++1z -Wall -Wextra -g

$ file rsh-server.osx
<span class="org-function-name">rsh-server.osx</span>: Mach-O 64-bit executable x86_64

$ otool -L rsh-server.osx
<span class="org-function-name">rsh-server.osx</span>:
        /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 902.1.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.100.1)
</pre>
</div>

<p>
Run terminal A =&gt; (Remote Linux Machine, netcat as server): 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; rlwrap netcat  -l 9070
Enter the shell to be spawned: sh

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ whoami  </span>
whoami 
unix

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ uname -a </span>
uname -a
Darwin ghosts-iMac-Pro.local 19.5.0 Darwin Kernel Version 19.5.0: Tue May 26 20:41:44 PDT 2020; root:xnu-6153.121.2~2/RELEASE_X86_64 x86_64

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ ls / </span>
ls /
Applications
Library
System
Users
Volumes
bin
cores
dev
etc
home
opt
private
sbin
tmp
usr
var

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ ls /Applications </span>
ls /Applications 
Safari.app
Utilities
iTerm.app

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed : '$ osalang' for listing all supported </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">OSA (Open Scripting Architecture) languages.</span>
osalang 
AppleScript
JavaScript
Generic Scripting System

<span class="org-comment-delimiter"># </span><span class="org-comment">User typeed: # osascript -e .... ... </span>
osascript -e <span class="org-string">'display dialog "My Dialog in OSA AppleScripting Automation!" '</span>
Unable to create basic Accelerated OpenGL renderer.
Unable to create basic Accelerated OpenGL renderer.
Core Image is now using the software OpenGL renderer. This will be slow.
button returned:OK

<span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ osascript -e .... </span>
osascript -e <span class="org-string">'tell app "Finder" to make new Finder window'</span>
Finder window id 117

 <span class="org-comment-delimiter"># </span><span class="org-comment">User typed: $ osascript -e .... </span>
osascript -e <span class="org-string">'display notification "Temperature 31 celsius." with title "Wheather report"'</span>


<span class="org-comment-delimiter"># </span><span class="org-comment">Type Ctrl + C to shutdown server </span>

</pre>
</div>

<p>
Run terminal B =&gt; (MacOSX, run rsh-server in client mode): 
</p>

<div class="org-src-container">
<pre class="src src-sh">./rsh-server.osx client 10.0.2.2 9070 
 [OK   ] Connected to server. 
 [TRACE] Waiting for child process termination. 
 [TRACE] Spawning process (PID = 1569 ) shell: sh 
 [TRACE] Child process terminated Ok. 
 [ERROR] Conncection failure. Retry. 
Connection error or peer closed connection 
 [ERROR] Conncection failure. Retry. 
Connection error or peer closed connection 
 [ERROR] Conncection failure. Retry. 
Connection error or peer closed connection 
 [OK   ] Connected to server. 
</pre>
</div>
</div>
</div>

<div id="outline-container-org512a4a5" class="outline-4">
<h4 id="org512a4a5"><span class="section-number-4">1.27.9</span> Telnet-like application with pseudo-terminal devices</h4>
<div class="outline-text-4" id="text-1-27-9">
<p>
The previous telnet-like application is not able to display colors or
handle interactive applications which expect to be running in a
terminal device, such as sudo, python and so on.
</p>

<p>
This rewrite of the previous code solves those shortcomings by using
UNIX pseudo-terminal device pair, comprised of master and slave pseudo
terminal devices.  In this new code version, the slave pseudo terminal
device is connected to the remote application's standard streams
stdin, stdout and stederr. The master pseudo terminal device is
connected to the socket. Any message received by the socket is
forwarded to the master pseudo-terminal device, then the slave
pseudo-terminal devices forwards this data to the process input. Any
process output, stderr or stdout, are relayed to the slave pseudo
terminal device, then the master pseudo terminal device forwards to
the socket that sends the data over the network.
</p>

<p>
The pseudo terminal devices application programming interface from
Unix-like systems is one of the most complex ones due to its long
history and sparse documentation. This API for instance, has RS232
UART baud rate parameters that dates back to the mainframe era where
terminals was a single unit comprised of a screen and a keyboard
attached to a mainframe via a serial cable.
</p>


<p>
<b>Concepts involved in the Terminal API</b>
</p>

<ul class="org-ul">
<li>UNIX signals</li>

<li>TTY</li>

<li>PTY - Pseudo terminal device</li>

<li>Shell
<ul class="org-ul">
<li>Interactive intepreter REPL (read-eval-print-loop), such as
bash or python.</li>
</ul></li>

<li>Controlling terminal</li>

<li>Terminal emulator (Example: Xterm, Gnome terminal)</li>

<li>Child process</li>

<li>Parent process</li>

<li>Session leader (often the shell)</li>

<li>Session - set of or one or more process groups.</li>

<li>Process group (also called 'job')</li>

<li>Foreground process</li>

<li>Background process</li>

<li>Pseudo-terminal modes:
<ul class="org-ul">
<li><span class="underline">Canonical mode</span> (default) =&gt; allso called non raw mode. Reads
line, by line. Provides default command line history, echoing
and allows moving the cursor forward.</li>
<li><span class="underline">Non-canonical</span> =&gt; also called raw mode =&gt; This mode does not
provide, history, character echoing, cursor backward movement
and so on. Used by Emacs and VI and other interactive terminal
applications.</li>
</ul></li>

<li>Applications that cannot work without pseudo terminals:
<ul class="org-ul">
<li>ssh</li>
<li>telnet =&gt; Predecessor of ssh</li>
<li>script =&gt; Records shell session to a file</li>
<li>rlogin</li>
<li>GNU screen</li>
<li>Tmux   =&gt; Terminal multiplexer</li>
<li>sudo   =&gt; For elevating user privilege.</li>
</ul></li>
</ul>

<p>
<b>File</b>: <span class="underline">rshell.cpp</span>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple telnet-like server using pseudo terminal devices.</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">poll.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-comment-delimiter">// </span><span class="org-comment">------ UNIX Pseudo Terminal Device API headers ---------//</span>
<span class="org-comment-delimiter">//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">termios.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#if</span> <span class="org-preprocessor">defined</span><span class="org-rainbow-delimiters-depth-1">(</span>__linux__<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">On Linux</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">pty.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#else</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">On BSDs =&gt;&gt; MacOSX, FreeBSD, OpenBSD</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">util.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/ioctl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#endif</span>


<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">UNIX_FAILURE</span> = -1;

<span class="org-comment-delimiter">// </span><span class="org-comment">Create server socket and return its file descriptor.</span>
<span class="org-type">int</span>  <span class="org-function-name">create_server</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Spawn a process and redirect its standard streams</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">to socket (stderr, stdin, stdout)</span>
<span class="org-type">void</span> <span class="org-function-name">spawn_redirect</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">executable</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Send text message to socket</span>
<span class="org-type">void</span> <span class="org-function-name">send_msg</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Connect to remote server and return client socket file descriptor.</span>
<span class="org-type">int</span> <span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Handle session between server and client.</span>
<span class="org-type">void</span> <span class="org-function-name">session_handler</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">executable</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">void</span> <span class="org-function-name">set_raw_terminal</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pty_fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc != 4<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage: $ %s client &lt;HOSTNAME&gt; &lt;PORT&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage: $ %s server &lt;HOSTNAME&gt; &lt;PORT&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = -1;
    <span class="org-keyword">auto</span> <span class="org-variable-name">command</span>  = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">hostname</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-type">int</span> <span class="org-variable-name">port</span>      = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">shell_executable</span> = <span class="org-string">"bash"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Run as client mode =&gt; Forwarding the shell to the server.</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"client"</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
          sockfd = socket_connect<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, port<span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> sockfd &gt; 0 <span class="org-rainbow-delimiters-depth-3">)</span>
               <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [OK   ] Connected to server. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">else</span>
                 <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Conncection failure. Retry. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

          session_handler<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, shell_executable<span class="org-rainbow-delimiters-depth-3">)</span>;
          sleep<span class="org-rainbow-delimiters-depth-3">(</span>2<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">---- End of client command ---- //</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Run in server mode =&gt; Liste connection.</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"server"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        sockfd = create_server<span class="org-rainbow-delimiters-depth-3">(</span>hostname.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, port, 5<span class="org-rainbow-delimiters-depth-3">)</span>;
        assert<span class="org-rainbow-delimiters-depth-3">(</span> sockfd != -1 <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">============= Server Event Loop =============//</span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">){</span>

            <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">client_sa</span>;
            <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-4">)</span>;

            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-4">(</span>sockfd, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-5">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            session_handler<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, shell_executable<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of for(;;) server loop ------//</span>

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of server command ---//</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here.</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;

 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">//  </span><span class="org-comment">--- End of main() ----- //</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">=============================================//</span>
<span class="org-comment-delimiter">//          </span><span class="org-comment">D E F I N I T I O N S               //</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">==============================================//</span>

<span class="org-type">int</span> <span class="org-function-name">create_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span> AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Future error handling.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant).</span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
    memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format.</span>
    sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address</span>
    <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> sockfd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> =  socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert() =&gt; Placeholder for future error handling.</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != UNIX_FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Query DNS</span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> h != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">int</span> <span class="org-variable-name">res</span> = connect<span class="org-rainbow-delimiters-depth-2">(</span> sockfd
                       , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;sa<span class="org-rainbow-delimiters-depth-3">)</span>
                       , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> res == -1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> -1; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> sockfd;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">send_msg</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    send<span class="org-rainbow-delimiters-depth-2">(</span>sockfd, message, strlen<span class="org-rainbow-delimiters-depth-3">(</span>message<span class="org-rainbow-delimiters-depth-3">)</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">session_handler</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">executable</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">[</span>500<span class="org-rainbow-delimiters-depth-2">]</span>;
    memset<span class="org-rainbow-delimiters-depth-2">(</span>name, 0x00, 500<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor of master pseudo terminal (PTY) pair.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">The master pseudo terminal is connected to the parent process.</span>
    <span class="org-type">int</span> <span class="org-variable-name">pty_master</span> = -1;

    <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor of slave pseudo terminal (PTY) pair.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">The slave pseudo terminal is connected to the child process (shell).</span>
    <span class="org-comment-delimiter">//</span>
    <span class="org-type">int</span> <span class="org-variable-name">pty_slave</span>  = -1;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> openpty<span class="org-rainbow-delimiters-depth-3">(</span>&amp;pty_master, &amp;pty_slave, &amp;name<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-constant">nullptr</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Slave  PTY fd = %d ; file = %s \n"</span>, pty_slave,  ttyname<span class="org-rainbow-delimiters-depth-3">(</span>pty_slave<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Master PTY fd = %d ; file = %s \n"</span>, pty_master, ttyname<span class="org-rainbow-delimiters-depth-3">(</span>pty_master<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">int</span> <span class="org-variable-name">flag</span> = 1;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: ioctl() returns 0 on success.</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ioctl<span class="org-rainbow-delimiters-depth-3">(</span>pty_master, TIOCPKT, &amp;flag <span class="org-rainbow-delimiters-depth-3">)</span> != -1<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert( ioctl(pty_master, FIONBIO, &amp;flag ) != -1);</span>
    set_raw_terminal<span class="org-rainbow-delimiters-depth-2">(</span>pty_slave<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">winsize</span> <span class="org-variable-name">win</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ioctl<span class="org-rainbow-delimiters-depth-3">(</span>pty_master, TIOCGWINSZ, &amp;win<span class="org-rainbow-delimiters-depth-3">)</span> != -1<span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Window size of cols = %d ; rows = %d \n"</span>, win.ws_col, win.ws_row<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fork a child process</span>
    <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-keyword">switch</span> <span class="org-rainbow-delimiters-depth-2">(</span>pid<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">case</span> -1:
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to fork process. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">break</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Child Process ------------//</span>
    <span class="org-keyword">case</span> 0: <span class="org-rainbow-delimiters-depth-3">{</span>

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stderr, <span class="org-string">" [TRACE] Spawning process (PID = %d ) pty = %s ; shell: %s \n"</span>
                      , ::getpid<span class="org-rainbow-delimiters-depth-5">()</span>, name, executable<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Turn the current terminal into the session leader of the child process.</span>
        assert<span class="org-rainbow-delimiters-depth-4">(</span> setsid<span class="org-rainbow-delimiters-depth-5">()</span> &gt; 0<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect process (stdin, stdout, stderr) to the pseudo terminal slave device (PTY).</span>
        assert<span class="org-rainbow-delimiters-depth-4">(</span> dup2<span class="org-rainbow-delimiters-depth-5">(</span>pty_slave, STDOUT_FILENO<span class="org-rainbow-delimiters-depth-5">)</span> != -1<span class="org-rainbow-delimiters-depth-4">)</span>;
        assert<span class="org-rainbow-delimiters-depth-4">(</span> dup2<span class="org-rainbow-delimiters-depth-5">(</span>pty_slave, STDIN_FILENO <span class="org-rainbow-delimiters-depth-5">)</span> != -1<span class="org-rainbow-delimiters-depth-4">)</span>;
        assert<span class="org-rainbow-delimiters-depth-4">(</span> dup2<span class="org-rainbow-delimiters-depth-5">(</span>pty_slave, STDERR_FILENO<span class="org-rainbow-delimiters-depth-5">)</span> != -1<span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span> <span class="org-rainbow-delimiters-depth-4">[]</span> = <span class="org-rainbow-delimiters-depth-4">{</span>
            executable    <span class="org-comment-delimiter">// </span><span class="org-comment">Process name (arbitrary)</span>
            , <span class="org-constant">nullptr</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Sentinel value - (always NULL pointer)</span>
        <span class="org-rainbow-delimiters-depth-4">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Spawn a new process.</span>
        <span class="org-type">int</span> <span class="org-variable-name">status</span> = execvp<span class="org-rainbow-delimiters-depth-4">(</span> executable, <span class="org-keyword">const_cast</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">char</span>* <span class="org-keyword">const</span>*<span class="org-rainbow-delimiters-depth-5">&gt;(</span>args<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> status == UNIX_FAILURE <span class="org-rainbow-delimiters-depth-4">){</span>
            <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
            send_msg<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, <span class="org-string">" [SERVER ERROR] Unable to locate REPL \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            send_msg<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, strerror<span class="org-rainbow-delimiters-depth-6">(</span>err<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            close<span class="org-rainbow-delimiters-depth-5">(</span>sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;
            exit<span class="org-rainbow-delimiters-depth-5">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span>

    <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">break</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">----------- Parent Process ------------//</span>
    <span class="org-keyword">default</span>:

        <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size in bytes.</span>
        <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 1024;
        <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">]</span>;

        <span class="org-keyword">constexpr</span>  <span class="org-type">size_t</span> <span class="org-variable-name">N</span> = 2;
        <span class="org-keyword">struct</span> <span class="org-type">pollfd</span> <span class="org-variable-name">pollv</span><span class="org-rainbow-delimiters-depth-3">[</span>N<span class="org-rainbow-delimiters-depth-3">]</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Register socket and pseudo-terminal master side.</span>
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>.fd      = sockfd;
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>.events  = POLLIN;
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>.revents = 0;
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>.fd      = pty_master;
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>.events  = POLLIN;
        pollv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>.revents = 0;

        <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Connection session loop -----------------------------//</span>
        <span class="org-comment-delimiter">//</span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Block current thread until any file descriptor becomes</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">ready for read operation.</span>
            <span class="org-type">int</span> <span class="org-variable-name">nfds</span> = ::poll<span class="org-rainbow-delimiters-depth-4">(</span> pollv, N, -1<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>nfds &lt; 0<span class="org-rainbow-delimiters-depth-4">){</span>
                fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] An error has happened. Abort. "</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::terminate<span class="org-rainbow-delimiters-depth-5">()</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>


            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when socket becomes ready (counterparty sends a message)</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> pollv<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>.revents &amp; POLLIN <span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-type">size_t</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, buffer, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>n == 0<span class="org-rainbow-delimiters-depth-5">){</span>
                    fprintf<span class="org-rainbow-delimiters-depth-6">(</span>stderr, <span class="org-string">" [TRACE] Peer closed connection \n"</span><span class="org-rainbow-delimiters-depth-6">)</span>;
                    close<span class="org-rainbow-delimiters-depth-6">(</span>pty_master<span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-keyword">break</span>;
                <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">Echoe command output to the server terminal</span>
                write<span class="org-rainbow-delimiters-depth-5">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Write socket remote input (stdin) to the master pseudo-terminal device (PTY)</span>
                assert<span class="org-rainbow-delimiters-depth-5">(</span> write<span class="org-rainbow-delimiters-depth-6">(</span>pty_master, buffer, n<span class="org-rainbow-delimiters-depth-6">)</span> &gt; 0<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when the process connected to the slave-end of pseudo</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">terminal (PTY) sends a message.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> pollv<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>.revents &amp; POLLIN <span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-type">size_t</span> <span class="org-variable-name">nn</span> = read<span class="org-rainbow-delimiters-depth-5">(</span>pty_master, buffer, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-5">)</span>;
                assert<span class="org-rainbow-delimiters-depth-5">(</span> nn &gt; 0 <span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Relay process output from master pseudo terminal to the socket file descriptor.</span>
                assert<span class="org-rainbow-delimiters-depth-5">(</span> write<span class="org-rainbow-delimiters-depth-6">(</span>sockfd, buffer, nn<span class="org-rainbow-delimiters-depth-6">)</span> &gt; 0<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

        <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of session loop ------//</span>

        <span class="org-keyword">break</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Set pseudo terminal device in raw mode (not cooked mode, default)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">The algorithm was extracted from the following Python code:</span>
<span class="org-comment-delimiter">//  </span><span class="org-comment">=&gt;&gt;  https://github.com/python/cpython/blob/711381dfb09fbd434cc3b404656f7fd306161a64/Lib/tty.py#L18</span>
<span class="org-type">void</span> <span class="org-function-name">set_raw_terminal</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pty_fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Saved terminal settings</span>
    <span class="org-keyword">struct</span> <span class="org-type">termios</span> <span class="org-variable-name">tty_old</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current terminal settings</span>
    <span class="org-keyword">struct</span> <span class="org-type">termios</span> <span class="org-variable-name">tty_new</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Save the default parameters of the slave side of the PTY</span>
    <span class="org-type">int</span> <span class="org-variable-name">rc</span> = tcgetattr<span class="org-rainbow-delimiters-depth-2">(</span>pty_fd, &amp;tty_old<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> rc != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

    tty_new = tty_old;
    cfmakeraw <span class="org-rainbow-delimiters-depth-2">(</span>&amp;tty_new<span class="org-rainbow-delimiters-depth-2">)</span>;
    tty_new.c_iflag = tty_new.c_iflag &amp; ~<span class="org-rainbow-delimiters-depth-2">(</span>BRKINT | ICRNL | INPCK | ISTRIP | IXON<span class="org-rainbow-delimiters-depth-2">)</span> ;
    tty_new.c_oflag = tty_new.c_oflag &amp; ~<span class="org-rainbow-delimiters-depth-2">(</span>OPOST<span class="org-rainbow-delimiters-depth-2">)</span>;
    tty_new.c_cflag = tty_new.c_cflag &amp; ~<span class="org-rainbow-delimiters-depth-2">(</span>CSIZE | PARENB<span class="org-rainbow-delimiters-depth-2">)</span>;
    tty_new.c_cflag = tty_new.c_cflag | CS8;
    tty_new.c_lflag = tty_new.c_lflag &amp; ~<span class="org-rainbow-delimiters-depth-2">(</span>ECHO | ICANON | IEXTEN | ISIG<span class="org-rainbow-delimiters-depth-2">)</span>;
    tty_new.c_cc<span class="org-rainbow-delimiters-depth-2">[</span>VMIN<span class="org-rainbow-delimiters-depth-2">]</span> = 1;
    tty_new.c_cc<span class="org-rainbow-delimiters-depth-2">[</span>VTIME<span class="org-rainbow-delimiters-depth-2">]</span> = 0;

    tcsetattr <span class="org-rainbow-delimiters-depth-2">(</span>pty_fd, TCSANOW, &amp;tty_new<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">tcsetattr (pty_slave, TCSANOW, &amp;tty_new);</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building</b>
</p>

<p>
This application is able to be build on Linux, BSD-variants or
MacOSX. In this case it was compiled on a MacOSX VM:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ rshell.cpp -o <span class="org-keyword">rshell-osx.bin</span> -std=c++1z -Wall -Wextra

$ file rshell-osx.bin
<span class="org-function-name">rshell.bin</span>: Mach-O 64-bit executable x86_64

$ otool -L rshell-osx.bin
<span class="org-function-name">rshell.bin</span>:
        /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 902.1.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.100.1)
</pre>
</div>

<p>
<b>Running</b>
</p>

<p>
Terminal 1: Run netcat as server in a Linux machine:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -l 9056

The default interactive shell is now zsh.
To update your account to use zsh, please run <span class="org-sh-quoted-exec">`chsh -s /bin/zsh`</span><span class="org-builtin">.</span>
For more details, please visit https://support.apple.com/kb/HT208050.
bash-3.2$
bash-3.2$ uname -a
Darwin ghosts-iMac-Pro.local 19.5.0 Darwin Kernel Version 19.5.0: ... ... 

bash-3.2$ pwd
/Volumes/data/macosx

bash-3.2$ ls /
Applications    Volumes         etc             sbin
Library         bin             home            tmp
System          cores           opt             usr
Users           dev             private         var
bash-3.2$


bash-3.2$ osascript -l JavaScript -i

&gt;&gt; ObjC.import(<span class="org-string">"Foundation"</span>)
<span class="org-function-name">ObjC.import</span>(<span class="org-string">"Foundation"</span>)
=&gt; undefined
&gt;&gt; ObjC.import(<span class="org-string">"Cocoa"</span>)
<span class="org-function-name">ObjC.import</span>(<span class="org-string">"Cocoa"</span>)
=&gt; undefined
&gt;&gt;

&gt;&gt; console.log(<span class="org-string">"Hello world - Hola mundo - Ola mundo"</span>)
<span class="org-function-name">console.log</span>(<span class="org-string">"Hello world - Hola mundo - Ola mundo"</span>)
Hello world - Hola mundo - Ola mundo
=&gt; undefined
&gt;&gt;

&gt;&gt; $.NSLog(<span class="org-string">"Mac OSX Objective C is awesome =&gt; GNUSTep"</span>)
$.NSLog(<span class="org-string">"Mac OSX Objective C is awesome =&gt; GNUSTep"</span>)
2020-12-22 14:19:01.001 osascript[8194:730902] Mac OSX Objective C is awesome =&gt; GNUSTep


&gt;&gt; z = $.NSNumber.numberWithFloat(10.2323)
z = $.NSNumber.numberWithFloat(10.2323)
=&gt; $(<span class="org-sh-quoted-exec">10.2322998046875</span>)

&gt;&gt;  $.NSLog(<span class="org-string">" z = %@"</span>, z)
 $.NSLog(<span class="org-string">" z = %@"</span>, z)
2020-12-22 14:20:47.164 osascript[8194:730902]  z = 10.2323


&gt;&gt;  alert = $.NSAlert.alloc.init
 alert = $.NSAlert.alloc.init
=&gt; [id NSAlert]

&gt;&gt;  alert.messageText = <span class="org-string">"Hello world Alert button"</span>
 alert.messageText = <span class="org-string">"Hello world Alert button"</span>
=&gt; <span class="org-string">"Hello world Alert button"</span>

&gt;&gt; alert.runModal(); $.NSLog(<span class="org-string">" Finished"</span>)
<span class="org-function-name">alert.runModal</span>(); $.NSLog(<span class="org-string">" Finished"</span>)
</pre>
</div>

<p>
Terminal 2: Run rshell as client in a MacOSX VM:
</p>

<div class="org-src-container">
<pre class="src src-sh">$  ./rshell-osx.bin client 10.0.2.2 9056 
[OK   ] Connected to server. 
[TRACE] Slave  PTY fd = 5 ; file = /dev/ttys021 
[TRACE] Master PTY fd = 4 ; file = (null) 
[TRACE] Window size of cols = 0 ; rows = 0 
[TRACE] Spawning process (PID = 8191 ) pty = /dev/ttys021 ; shell: bash 
 ... ..   ... ..   ... ..   ... ..   ... ..   ... .. 
  ... ..   ... ..   ... ..   ... ..   ... ..   ... ..   ... .. 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org18084eb" class="outline-3">
<h3 id="org18084eb"><span class="section-number-3">1.28</span> Sockets with SSL/TSL - Secure Communication</h3>
<div class="outline-text-3" id="text-1-28">
</div>
<div id="outline-container-org4a92c9c" class="outline-4">
<h4 id="org4a92c9c"><span class="section-number-4">1.28.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-28-1">
<p>
Many widely network protocols, such as HTTP, FTP, Telnet or SMTP, were
designed without any security considerations, without any type of
encryption which makes the data transmitted by those protocols
vulnerable to eavesdropping; tampering, the data can be changed by
third party during the transmission; spoofing (impersonation); MIT
(Man-In-The Middle attack) a third-party actor can impersonate both
sides and modify the data sent over the connection; and integrity
violation.
</p>

<p>
The TLS (Transport Layer Security) and its predecessor SSL (Secure
Socket Layer) are the bed rocks of internet security, they are network
protocol stacks designed for encapsulating the TCP protocol and solve
its major security shortcomings by providing <span class="underline">confidentiality</span> through
encryption, a third party will only be able to view obfuscated
non-readable binary data (blobs); <span class="underline">non-repudiation</span> and <span class="underline">authentication</span>
through certificates and public key infrastructure (PKI); <span class="underline">data
integrity</span> as property of encryption, both sides of communication
channel are able to detect any data tampering.
</p>

<p>
The TSL protcol stack is comprised of basically two parts, the <span class="underline">TLS
_handshake protocol</span>, that takes care of authentication, certificate
verification and shared key generation and exchange; and the <span class="underline">TLS
record protocol</span>, that takes care of encapsulating the TCP protocol and
providing encrypted communication. When the connection is opened, the
TSL hanshaking takes place and the following sequence of events
happen: both sides negotiate the TLS version; decides the ciphers that
will be used; the client checks server certificate by using a trusted
certificate authority; the server may also check the client
certificate, but this feature is semdom used; generate a shared
encryption key (symmetric encryption) for exchanging encryoted
data. After the TLS handshake, the <span class="underline">TLS record protocol</span> is used for
encapsulating TCP-based protocols, such as HTTP, FTP or SMTP by
providing data encryption by using the generated shared (symmetric)
key, which is unique for every connection. 
</p>

<p>
<b>Remarks</b> 
</p>

<ul class="org-ul">
<li>TLS and SSL are essential for internet security. Without it any
third party agent, including ISP (Internet Service Providers),
would be able to intercept and view the communication between the
web browser and web servers.</li>

<li>Despite being widely used for providing encryption for the http
protocol ( <code>https:/www.site.com</code> URLs, instead of
<code>http://www.site.com</code>), the TLS protocol can also encapsulate any
other TCP-based network protocol.</li>

<li>APIs based on OpenSSL or other implementation of the TLS protocol
stack provide encapsulation and transparent encryption and
decryption for TCP-based protocols where the calling code does not
need to care about encryption details.</li>

<li>The private key should never be disclosed, otherwise any third
party agent, that obtained the key, will be able to intercept and
decrypt the communication.</li>

<li>Always keep openSSL library updated with the latest security
fixes. This library is a fundamental piece of internet
security. Any OpenSSLL vulnerability will make anything that
depends on this library vulnerable.</li>

<li>Avoiding creating custom or proprietary encryption as cryptography
is business critical and requires deeper knowledge of number
theory, random numbers, discrete mathematics and abstract
algebra.</li>
</ul>

<p>
<b>Some network protocols that relies on TLS/SSL</b> 
</p>

<ul class="org-ul">
<li>HTTPS (HTTP + SSL/TLS), port 443 =&gt; Http protocol encapsulated
with TLS/SSL. Web sites with https URL, for instance
<a href="https://www.httpbin.org">https://www.httpbin.org</a>, are using TLS.</li>

<li>FTPS (FTP + SSL/TLS) =&gt; FTP encapsulated with TLS/SSL</li>

<li>OpenVPN</li>

<li>SSTP (Secure Socket Tunneling Protocol)</li>

<li>DoH (DNS over TLS)</li>
</ul>


<p>
<b>Some Implementation of TLS and SSL Protocol Stack</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.openssl.org/">OpenSSL</a>
<ul class="org-ul">
<li>Reference-implementation and first implementation of the SSL
and TLS network protocol stack. In addition to the shared
library provided by OpenSSL suite, it also provide command line
tools for creating and validating certificates; creating
self-signed certificates and check connection certificate;
creating digital signature and so on.</li>
<li>Note: OpenSSL is cross-platform and can be used on all
platforms, including Windows.</li>
<li>Note: In many cases, web applications use OpenSSL indirectly
through Nginx reverse proxy where Nginx is used for providing
TLS security.</li>
</ul></li>

<li><a href="https://www.gnutls.org/">GNU TLS</a>
<ul class="org-ul">
<li>License: LGPL</li>
<li>GNU Implementation of TLS protocol stack.</li>
</ul></li>

<li><a href="https://www.libressl.org/">LibreSSL</a>
<ul class="org-ul">
<li>Fork of OpenSSL created by OpenBSD developers.</li>
</ul></li>

<li><a href="https://boringssl.googlesource.com/boringssl/">BoringSSL</a> 
<ul class="org-ul">
<li>Google's implementation of TLS/SSL.</li>
</ul></li>

<li><a href="https://tls.mbed.org/">Mbed TLS</a> (Embedded Systems)
<ul class="org-ul">
<li>Lightweight implementation derived from Mbed operating system
for embedded systems.</li>
<li>Repository: <a href="https://github.com/ARMmbed/mbedtls">GitHub - ARMmbed/mbedtls</a></li>
</ul></li>

<li><a href="https://www.wolfssl.com/">wolfSSL</a> (Embedded Systems)
<ul class="org-ul">
<li>License: Dual license, GPL3 and commercial for closed source applications.</li>
<li>Highly secure implementation, designed for embedded
systems. Unlike other libraries, WolfSSL has certification for
meeting regulatory requirements.</li>
<li>Repository: <a href="https://github.com/wolfSSL/wolfssl">https://github.com/wolfSSL/wolfssl</a></li>
</ul></li>

<li><a href="https://botan.randombit.net/">Botan</a>
<ul class="org-ul">
<li>License: BSD</li>
<li>Repository: <a href="https://github.com/randombit/botan">https://github.com/randombit/botan</a></li>
<li>"Botan's goal is to be the best option for cryptography in C++
by offering the tools necessary to implement a range of
practical systems, such as TLS protocol, X.509 certificates,
modern AEAD ciphers, PKCS#11 and TPM hardware support, password
hashing, and post quantum crypto schemes. A Python binding is
included, and several other language bindings are available. It
is used in many open source and commercial products. The
library is accompanied by a featureful command line interface."</li>
</ul></li>

<li><a href="https://docs.rs/rustls/0.19.0/rustls/">Rust TLS</a>
<ul class="org-ul">
<li>TLS protocol stack implemented in Rust that conforms to OpenSSL API.</li>
</ul></li>

<li><a href="https://bearssl.org/">BearSSL - Main</a>
<ul class="org-ul">
<li>"BearSSL is an implementation of the SSL/TLS protocol
(RFC 5246) written in C. It aims at offering the following
features: Be correct and secure. In particular, insecure
protocol versions and choices of algorithms are not supported,
by design; cryptographic algorithm implementations are
constant-time by default. Be small, both in RAM and code
footprint. For instance, a minimal server implementation may
fit in about 20 kilobytes of compiled code and 25 kilobytes of
RAM. Be highly portable. BearSSL targets not only “big”
operating systems like Linux and Windows, but also small
embedded systems and even special contexts like bootstrap
code. Be feature-rich and extensible. SSL/TLS has many defined
cipher suites and extensions; BearSSL should implement most of
them, and allow extra algorithm implementations to be added
afterwards, possibly from third parties."</li>
</ul></li>

<li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/creating-a-secure-connection-using-schannel">Schannel</a> [WINDOWS-ONLY]
<ul class="org-ul">
<li>Microsft Windows-only implementation of SSL and TSL protocol stack.</li>
</ul></li>
</ul>

<p>
<b>Useful Terminology and Concepts</b> 
</p>

<ul class="org-ul">
<li><span class="underline">IETF</span> - Internet Engineering Task Force</li>

<li><span class="underline">RFC</span> - Request For Comment</li>

<li><span class="underline">SSL</span> - Socket Secure Layer (predecessor of TLS, first used by
Netscape Web Browser)</li>

<li><span class="underline">TLS</span> - Transport Layer Security (over TCP) - provides security for
TCP based protocols, such as HTTP, FTP, SMTP and so on.</li>

<li><span class="underline">DTLS</span> - Datagram Transport Layer Security (over UDP) - provides
security for UDP based protocols.</li>

<li><span class="underline">PKI</span> - Public Key Infrastructure</li>

<li><span class="underline">Non-Repudiation</span> (Used for digital signature and data integrity)
<ul class="org-ul">
<li>If the message recipient has the data received from the sender,
the data hash created by the sender's private key, the sender's
public key and the receiver is really sure about the public key
ownership validated by a CA - Certificate Authority. The sender,
owner of the private key, cannot deny that he or she really sent
the message and cannot deny anything about the message content.</li>
</ul></li>

<li><span class="underline">Shared-Key Cryptography</span> (a.k.a Symmetric Key Cryptography)
<ul class="org-ul">
<li>The same key is used for data encryption and decryption. The
usage of shared key cryptography is unsafe for communication
over an unsafe channels as the encryption keys need to be send
over an unsafe channel before the encrypted communication takes
place.</li>
<li>Applications and use-cases: bulk data encryption for hiding and
obfuscating data from unauthorized access; password file
encryption; file system encryption; disk encryption; encrypted
backup and private key encryption. Shared key cryptography can
be used for encrypted communication. However, before the
encrypted communication takes place, the key may be transmitted
in an unencrypted channel which makes the key vulnerable to
interception.</li>
</ul></li>

<li><span class="underline">Public-Key Cryptography</span> (a.k.a Asymmetric key cryptography)
<ul class="org-ul">
<li>Unlike the shared key cryptography, where the same key is used
for data encryption and decryption. The public-key cryptography
uses the <i>public key</i> for encryption and <i>private key</i> for
decryption. The publick-key cryptography allows communication
between two agents without them exchanging their encryption keys
(private keys), they only need the public key from each
other. Given two agents Alice and Bob, if Alice wants to send a
encryted message to Bob, she encrypts the message with Bob's
public key and he will be able to decrypt the encrypted data
using his private key, which only he owns and knows. If Bob
wants to send an encryted message, he encrypts the message with
Alice's public key and Bob will be able to decrypt the message
using his private key. Although, the public-key cyrptography is
safer than shared-key cryptogaphy, public-key algorithms are
more computationally expensive than shared key
algorithms. Public key cryptography is not enough for secure
communication. A third party agent can still impersonate Bob
and Alice by sending a bogus Alice's public key to Bob and a bogus
Bob's public key to Alice. Now the agent can intercept and decrypt the
communication between both sides. This situation is called MITM
(Man-In-The-Middle) attack. The MITM could be avoided if Bob was
sure that Alice's public really belongs to her and Alice was
sure that Bob's public key really belongs to him. What gives the
assurance about the public key ownership and identity bound to
the key is the PKI <span class="underline">public-key</span> infrastructure or the CAs
(Certificate Authorities).</li>
<li>Applications and use-cases: <span class="underline">secure communication</span> over unsafe
channels without disclosing private keys; <span class="underline">digital signature</span> for
legal documents and contracts; <span class="underline">data integrity detection</span>, any
data modification can be detected by both sides; <span class="underline">authentication</span>
using the private key, if the server has the client's public
key; <span class="underline">blockchain</span> is based on public-key cryptography;
cryptocurrencies such as Bitcon or Litecoin are also based on
public key cryptography; TLS and SSL uses public-key
cryptography for exchanging the shared key without disclosing it.</li>
</ul></li>

<li><span class="underline">X.509 Certificates</span> - The certificate encapsulates is standardized
format by <a href="https://tools.ietf.org/html/rfc5280">RFC 5280</a> that encapsulates the identification metadata,
server or client public key and digital signatures from
certificate authorities for validating the identification linked
to the certificate.  In order to a TLS communication to be
established, at least one side needs a TLS certificate, which is
in most of the cases only the server. However, client-isde
certificate can also be used for client authentication.</li>

<li><span class="underline">CA</span> - Certificate Authority (PKI - Public Key Infrastructure)
<ul class="org-ul">
<li>Provides <span class="underline">non-repudiation</span>, it allows the receiver of the message,
for instance a Web browser, to be sure about sender, which could
be a the http server, <span class="underline">identity</span> and the sender is really the
intended communication counterparty. The CA chain also solves
the MITM problem. Web browsers use a built-in set of certificate
authorities trusted by the browser vendor, which are used for
validating certificates from web sites (http servers).</li>
</ul></li>

<li><span class="underline">CHF</span> - <span class="underline">Crytography Hash Function</span> =&gt; Cryptography hash are
deterministic, <span class="underline">non-reversible</span> and one-way functions that uniquely
map any amount of data, taken as input, to a fixed-width output,
named <span class="underline">hash value</span>, <span class="underline">message-digest</span> or <span class="underline">checksum</span>. Some of those
algorithms are: MD5, SHA-1, SHA-2, SHA-3, SHA-256, Argon-2,
PBKDF2, Bcrypt and so on. Some applications of hash functions are:

<ul class="org-ul">
<li><span class="underline">Digital Signature</span></li>

<li><span class="underline">Uniquely identifying a file</span>: The computed hash value is unique
for each file, as a result it uniquely identifies a file. For
instance, when comparing two files at different machines, it is
faster to compare their hash values rather than downloading the
counterpart file and checking the equality of all bytes.</li>

<li><span class="underline">File integrity checking</span>: given a file and its
previously computed hash, an user can verify if the file is not
corrupted or was not tampered by comparing the previously
computed hash value and the current file hash value. If the
computed value and the already known hash matches, then the file
was not currupted and not tampered.</li>

<li><span class="underline">Data Checksum</span>: if a data is transmistted with its checksum (hash
value), it is possible to detect any data change or corruption
by computing the received data hash value (checksum) and
comparing with the received hash value.</li>

<li><span class="underline">Secure password storage</span> for web applications. If only the hash
value of user passwords are storead and the database is leaked,
whoever accesses the hashes will not be able to reuse it on
other websites.</li>
</ul></li>

<li><span class="underline">Digital Signature</span>
<ul class="org-ul">
<li>The digital signature of a file or data is produced by
generating the hash of this file or data through some hash
algorithm and them encryting the hash with the sender's <span class="underline">private</span>
<span class="underline">key</span>. Then, the data and digital signature is sent to the recipient which can
check the message data integrity and that the messsage was relly
sent by whom the recipient claims to be. The recipient can
verify the message by decrypting the digital signature with the
sender's public key for obtaining the message hash which is
compared with message hash computed by the recipient.</li>
<li>The digital signature can be used for ensuring <span class="underline">data integrity</span>,
and <span class="underline">non-repudiation</span> assurance which is only possible if the
recipient is really sure that public key really belongs to the
sender.</li>
<li>The recipient can veryify the ownership and authenticity of the
sender's public key by checking its digital signature signed by
a trusted CA - certificate authority.</li>
</ul></li>

<li><span class="underline">SRP</span> - Secure Remote Password</li>

<li><span class="underline">CRL</span> - Certificate Revocation List</li>

<li><span class="underline">RSA</span> - Rivest–Shamir–Adleman public-key algorithm.</li>

<li><span class="underline">ECC</span> - Elliptic Curve Cryptography</li>

<li><span class="underline">ECDSA</span> - Elliptic Curve Digital Signature Algorithm</li>

<li><span class="underline">MAC</span> - Message Authentication Code</li>

<li><span class="underline">HMAC</span> - Keyed-Hashing for Message Authentication</li>

<li><span class="underline">DES</span> - Data Encryption Standard</li>

<li><span class="underline">BER</span> - Basic Enconding Rules (Related to X509 Certificates)</li>

<li><span class="underline">DER</span> - Distinguished Encoding Rules (Related to X509 Certificates)</li>

<li><span class="underline">PEM</span> - Privacy Enhanced Mail</li>

<li><span class="underline">AES</span> - Advanced Encryption Standard</li>

<li><span class="underline">CBC</span> - Cipher Block Chaining  Mode</li>

<li><span class="underline">OFB</span> - Output FeedBack Mode</li>

<li><span class="underline">ECB</span> - Electronic Code Book Mode</li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<p>
Technical standards and specifications: 
</p>

<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc2246">RFC 2246 - The TLS Protocol Version 1.0</a>
<ul class="org-ul">
<li>"This document specifies Version 1.0 of the Transport Layer
Security (TLS) protocol. The TLS protocol provides
communications privacy over the Internet. The protocol allows
client/server applications to communicate in a way that is
designed to prevent eavesdropping, tampering, or message
forgery."</li>
</ul></li>

<li><a href="https://tools.ietf.org/html/rfc4346">RFC 4346 - The Transport Layer Security (TLS) Protocol Version 1.1</a></li>

<li><a href="https://datatracker.ietf.org/doc/rfc8446/">RFC 8446 - The Transport Layer Security (TLS) Protocol Version 1.3</a></li>

<li><a href="https://tools.ietf.org/html/rfc4680">RFC 4680 - TLS Handshake Message for Supplemental Data</a></li>

<li><a href="https://tools.ietf.org/html/rfc4681">RFC 4681 - TLS User Mapping Extension</a></li>

<li><a href="https://tools.ietf.org/html/rfc5746">RFC 5746 - Transport Layer Security (TLS) Renegotiation Indication Extension</a></li>

<li><a href="https://tools.ietf.org/html/rfc6476">RFC 6476 - Using Message Authentication Code (MAC) Encryption in the Cryptographic Message Syntax (CMS)</a></li>

<li><a href="https://tools.ietf.org/html/rfc5280">RFC 5280 - Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</a></li>

<li><a href="https://tools.ietf.org/html/rfc8484">RFC 8484 - DNS Queries over HTTPS (DoH)</a></li>
</ul>

<p>
SSL/TSL Concepts: 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Information_security">INFOSEC - Information security</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/X.509">X.509 Certificate</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Online_Certificate_Status_Protocol">Online Certificate Status Protocol</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/OpenSSL">OpenSSL</a> - Reference implementation of TSL and SSL protocols.</li>

<li><a href="https://www.thesslstore.com/blog/tls-1-3-approved/">TLS 1.3 is finally published by the IETF as RFC 8446 - Hashed Out</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Comparison_of_TLS_implementations">Comparison of TLS implementations</a></li>

<li><a href="https://www.cloudflare.com/learning/ssl/what-is-ssl/">What is SSL (Secure Sockets Layer)? | Cloudflare</a></li>

<li><a href="https://www.ssl.com/faqs/faq-what-is-ssl/">What is SSL? - SSL.com</a></li>

<li><a href="https://security.stackexchange.com/questions/14858/mac-vs-encryption">cryptography - MAC vs Encryption - Information Security Stack Exchange</a></li>

<li><a href="https://security.stackexchange.com/questions/2202/lessons-learned-and-misconceptions-regarding-encryption-and-cryptology/2206#2206">cryptography - Lessons learned and misconceptions regarding encryption and cryptology</a></li>

<li><a href="https://searchsecurity.techtarget.com/definition/message-authentication-code-MAC">What is message authentication code (MAC)? - Definition from WhatIs.com</a></li>

<li><a href="https://www.cloudflare.com/learning/ssl/what-happens-in-a-tls-handshake/">What Happens in a TLS Handshake? | SSL Handshake | Cloudflare</a></li>
</ul>

<p>
Cryptography Concepts: 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Public-key_cryptography">Public-key cryptography</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Symmetric-key_algorithm">Symmetric-key algorithm</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Web_of_trust">Web of trust</a></li>

<li>PKI - <a href="https://en.m.wikipedia.org/wiki/Public_key_infrastructure">Public key infrastructure</a></li>

<li><a href="https://www.acunetix.com/blog/articles/tls-ssl-terminology-basics-part-3/">TLS Security 3: SSL/TLS Terminology and Basics | Acunetix</a></li>

<li><a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm">Elliptic Curve Digital Signature Algorithm - Wikipedia</a></li>

<li><a href="https://en.bitcoin.it/wiki/Elliptic_Curve_Digital_Signature_Algorithm#:~:text=Elliptic%20Curve%20Digital%20Signature%20Algorithm%20or%20ECDSA%20is%20a%20cryptographic,the%20person%20that%20generated%20it.">Elliptic Curve Digital Signature Algorithm - Bitcoin Wiki</a></li>

<li><a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">ECDSA: The digital signature algorithm of a better internet</a></li>

<li><a href="https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/">A (Relatively Easy To Understand) Primer on Elliptic Curve Cryptography</a></li>
</ul>


<p>
Digital Signature: 
</p>

<ul class="org-ul">
<li><a href="https://inversegravity.net/2019/crypto-hash-digital-signature/">Crytography - Hash Functions &amp; Digital Signatures</a></li>

<li><a href="https://opensource.com/article/19/6/cryptography-basics-openssl-part-2">Opensource.com - How to use OpenSLL: Hahses, digital signature and more.</a></li>

<li><a href="https://www.ibm.com/docs/en/ztpf/1.1.0.14?topic=concepts-digital-signatures#:~:text=The%20digital%20signature%20is%20basically,with%20the%20signer's%20private%20key.&amp;text=The%20recipient%20then%20uses%20the,hash%20of%20the%20same%20data">IBM - Digital Signatures</a>.</li>

<li><a href="https://www.thesslstore.com/blog/digital-signatures-why-you-should-sign-everything/">Digital Signature - Why you should sign everything</a></li>

<li><a href="https://www.gnupg.org/gph/en/manual/x215.html">GNUPG - Digital Signature</a></li>
</ul>

<p>
OpenSSL API
</p>

<ul class="org-ul">
<li><a href="https://wiki.openssl.org/index.php/SSL/TLS_Client">SSL/TLS Client - OpenSSLWiki</a></li>

<li><a href="https://wiki.openssl.org/index.php/Simple_TLS_Server">Simple TLS Server - OpenSSLWiki</a></li>

<li><a href="https://linux.die.net/man/3/ssl">ssl(3) API Manpage</a></li>

<li><a href="https://manpages.ubuntu.com/manpages/bionic/man7/ssl.7ssl.html">Ubuntu Manpage: ssl - OpenSSL SSL/TLS library</a></li>

<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/security16_slides-yun.pdf">USENIX - APISan: Sanitizing API Usages through Semantic  Cross-checking</a></li>

<li><a href="https://www.informit.com/articles/article.aspx?p=22079">Securing Sockets with OpenSSL (Part 1) | Differentiating the Authorities | InformIT</a></li>

<li><a href="https://www.informit.com/articles/article.aspx?p=22078">Securing Sockets with OpenSSL (Part 2) | Writing an HTTPS Server | InformIT</a></li>

<li><a href="https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_load_verify_locations.html">/docs/man1.0.2/man3/SSL_CTX_load_verify_locations.html</a></li>

<li><a href="https://geekcabi.net/article/using-ssl-connections-over-ncat/">GeekCabinet – Using SSL Connections Over ncat</a></li>
</ul>

<p>
DoH - DNS over HTTPS (DNS over TLS)
</p>

<ul class="org-ul">
<li><a href="https://www.ssl.com/faqs/what-is-dns-over-https-doh/">What is DNS over HTTPS (DoH)? - SSL.com</a></li>

<li><a href="https://tools.ietf.org/html/rfc8484">RFC 8484 - DNS Queries over HTTPS (DoH)</a></li>

<li><a href="https://www.thesslstore.com/blog/what-is-dns-over-tls/#:~:text=DNS%20over%20TLS%20is%20a,is%20the%20successor%20to%20SSL.">What is DNS over TLS? Everything you need to know</a></li>

<li><a href="https://en.wikipedia.org/wiki/DNS_over_TLS">DNS over TLS - Wikipedia</a></li>
</ul>
</div>
</div>

<div id="outline-container-org24d42aa" class="outline-4">
<h4 id="org24d42aa"><span class="section-number-4">1.28.2</span> Open SSL commands</h4>
<div class="outline-text-4" id="text-1-28-2">
<p>
<b>View certificate of some sever, given its hostname</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; openssl s_client -showcerts -connect www.httpbin.org:443 &lt; /dev/null 

<span class="org-function-name">CONNECTED</span>(00000003)
<span class="org-variable-name">depth</span>=2 C = US, O = Amazon, CN = Amazon Root CA 1
verify return:1
<span class="org-variable-name">depth</span>=1 C = US, O = Amazon, OU = Server CA 1B, CN = Amazon
verify return:1
<span class="org-variable-name">depth</span>=0 CN = httpbin.org
verify return:1
---
Certificate chain
 0 s:CN = httpbin.org
   i:C = US, O = Amazon, OU = Server CA 1B, CN = Amazon
-----BEGIN CERTIFICATE-----
MIIFbjCCBFagAwIBAgIQC6tW9S/J9yHIw1v8WOnMPDANBgkqhkiG9w0BAQsFADBG
MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRUwEwYDVQQLEwxTZXJ2ZXIg
Q0EgMUIxDzANBgNVBAMTBkFtYXpvbjAeFw0yMDAxMTgwMDAwMDBaFw0yMTAyMTgx
MjAwMDBaMBYxFDASBgNVBAMTC2h0dHBiaW4ub3JnMIIBIjANBgkqhkiG9w0BAQEF
 .... ... ...
 ........ 

qPGwissH0W8HgYWhKVISkN2ui55RgbHXQHYDX0uYgGK6iRMxHHlOR1vOqRgEvVGF
5g8CcK3EzritKaHkD6bf0pnSE/E7cjKXzgB4l+58dsNcIVo9YgID4xYGS6paetso
<span class="org-variable-name">XHE</span>=
-----END CERTIFICATE-----

  ... ... ... ... ... . 
  ... ... ... ... ... ... 

---
Server certificate
<span class="org-variable-name">subject</span>=CN = httpbin.org

<span class="org-variable-name">issuer</span>=C = US, O = Amazon, OU = Server CA 1B, CN = Amazon

---
No client certificate CA names sent
Peer signing digest: SHA512
Peer signature type: RSA
Server Temp Key: ECDH, P-256, 256 bits
---
SSL handshake has read 5509 bytes and written 443 bytes
<span class="org-function-name">Verification</span>: OK
---
New, TLSv1.2, Cipher is ECDHE-RSA-AES128-GCM-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
<span class="org-function-name">Compression</span>: NONE
<span class="org-function-name">Expansion</span>: NONE
No ALPN negotiated
<span class="org-function-name">SSL-Session</span>:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES128-GCM-SHA256
    Session-ID: F63AEC9287D557EE6FE770BE0DB46CC0B26991704DEE81E9071377849356F0D6
    Session-ID-ctx: 
    Master-Key: 9FA0D73281EBBD07DEF167E5517207BDB80CCFC22D8C53DE9E0354D50A01B5279C51C3C55BE972497329E3E70BE73C43
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 43200 (seconds)
    TLS session ticket:
    0000 - d0 62 5a 94 f7 f7 a8 e1-c9 40 e9 ff bc ff e1 d2   .bZ......@......
    0010 - 02 08 f4 aa 80 60 d7 e3-1f 85 1e d1 ba e3 b8 75   .....<span class="org-sh-quoted-exec">`.........u</span>
<span class="org-sh-quoted-exec">    0020 - 20 8f 7f 21 62 b9 72 a1-23 f5 05 8d 61 db b2 2d    ..!b.r.#...a..-</span>
<span class="org-sh-quoted-exec">    0030 - 20 71 38 0d 70 30 30 3d-98 ed 64 b1 66 85 75 eb    q8.p00=..d.f.u.</span>
<span class="org-sh-quoted-exec">    0040 - a6 e2 fe 13 9d 86 aa f4-43 42 be b3 86 2c a2 30   ........CB...,.0</span>
<span class="org-sh-quoted-exec">    0050 - 7c 90 f1 1b 84 b8 58 31-72 3e c2 92 83 d2 4a 33   |.....X1r&gt;....J3</span>
<span class="org-sh-quoted-exec">    0060 - a1 76 f7 f4 c1 f1 6a a9-bc ce f7 c4 b6 81 28 2f   .v....j.......(/</span>
<span class="org-sh-quoted-exec">    0070 - 76 10 c1 ca a7 5f cf 16-0e 40 ee 09 ab b9 2b d1   v...._...@....+.</span>
<span class="org-sh-quoted-exec">    0080 - 05 85 ed 48 30 2b 84 2c-f4 1d b6 61 08 b5 66 ff   ...H0+.,...a..f.</span>
<span class="org-sh-quoted-exec">    0090 - c6 3c d3 ac e4 bb 8a de-70 73 af d9 d0 e4 f4 65   .&lt;......ps.....e</span>
<span class="org-sh-quoted-exec">    00a0 - 1e 42 74 0d 8b 71 a7 a1-58 84 a3 d1 3b 4e 8c 24   .Bt..q..X...;N.$</span>
<span class="org-sh-quoted-exec">    00b0 - 64 46 2f ce 5a a9 a3 a0-64 23 46 36 73 92 50 2f   dF/.Z...d#F6s.P/</span>

<span class="org-sh-quoted-exec">    Start Time: 1607966129</span>
<span class="org-sh-quoted-exec">    Timeout   : 7200 (sec)</span>
<span class="org-sh-quoted-exec">    Verify return code: 0 (ok)</span>
<span class="org-sh-quoted-exec">    Extended master secret: no</span>
<span class="org-sh-quoted-exec">---</span>
<span class="org-sh-quoted-exec">DONE</span>


</pre>
</div>

<p>
<b>Generate certificate</b> 
</p>

<ul class="org-ul">
<li>Generates the private key mykey.pem, which should never be
disclosed, and the certificate mycert.pem.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ openssl req -x509 -nodes -days 5000 -newkey rsa:1024 -keyout mykey.pem -out mycert.pem
</pre>
</div>

<p>
<b>View Certificate</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ openssl x509 -text -in mycert.pem
</pre>
</div>

<p>
More commands at: 
</p>
<ul class="org-ul">
<li><a href="https://wiki.openssl.org/index.php/Command_Line_Utilities">Command Line Utilities - OpenSSLWiki</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd9c4eab" class="outline-4">
<h4 id="orgd9c4eab"><span class="section-number-4">1.28.3</span> TCP/IP Client Socket with TLS (OpenSSL)</h4>
<div class="outline-text-4" id="text-1-28-3">
<p>
This sample code contains a TCP/IP client socket using TLS 
encapsulation for secure communication. 
</p>

<p>
OpenSSL Documentation: 
</p>
<ul class="org-ul">
<li><a href="https://www.openssl.org/docs">https://www.openssl.org/docs</a></li>
<li><a href="https://www.openssl.org/docs/manmaster/man3/">https://www.openssl.org/docs/manmaster/man3/</a></li>
</ul>

<p>
All codes and files available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/bb884fd36b8930cb7358133c2afe9b56">https://gist.github.com/bb884fd36b8930cb7358133c2afe9b56</a></li>
</ul>

<p>
<b>File:</b> <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Sample_SLL)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON )

<span class="org-comment">#----------- Set targets -------------------------------#</span>

<span class="org-function-name">find_package</span>( OpenSSL REQUIRED )

       <span class="org-function-name">add_executable</span>( ssl-test ssl-test.cpp    )
<span class="org-function-name">target_link_libraries</span>( ssl-test ${<span class="org-variable-name">OPENSSL_LIBRARIES</span>} )
</pre>
</div>

<p>
<b>File:</b> <span class="underline">ssl-test.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to #include &lt;string.h&gt; in C</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">assert() macro.</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">tuple</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- OpenSSL headers -------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">openssl/ssl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">openssl/bio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">openssl/err.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">FAILURE</span>     = -1;
<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">SSL_FAILURE</span> = -1;

<span class="org-keyword">using</span> <span class="org-type">SSL_Tuple</span> = <span class="org-constant">std</span>::<span class="org-type">tuple</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">SSL_CTX</span>*, <span class="org-type">SSL</span>*<span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Create and return a client socket and connecting to a hostname.</span>
<span class="org-type">int</span> <span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Instantiate SSL data structures.</span>
<span class="org-type">SSL_Tuple</span> <span class="org-function-name">setup_ssl</span><span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Shows certificate information. </span>
<span class="org-type">void</span> <span class="org-function-name">display_certificate</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">SSL</span>* <span class="org-variable-name">ssl</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage: %s &lt;HOSTNAME&gt; &lt;PORT&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">uint16_t</span>    <span class="org-variable-name">port</span>     = <span class="org-constant">std</span>::stod<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">trust_cert_path</span> = X509_get_default_cert_dir<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [TRACE] X509 Trust Certificate Directory: %s \n"</span>
                , trust_cert_path<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">=========== SSL/TSL Initialization ===============//</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Requires C++ 17</span>
    <span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-2">[</span>ctx, ssl<span class="org-rainbow-delimiters-depth-2">]</span> = setup_ssl<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">============ Connect to server =====================// </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">----------------------------------------------------//</span>

    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket_connect<span class="org-rainbow-delimiters-depth-2">(</span>hostname, port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulate TCP protcol </span>
    SSL_set_fd<span class="org-rainbow-delimiters-depth-2">(</span>ssl, sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> SSL_connect<span class="org-rainbow-delimiters-depth-3">(</span>ssl<span class="org-rainbow-delimiters-depth-3">)</span> == SSL_FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Failure to setup SSL/TSL connection"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        ERR_print_errors_fp<span class="org-rainbow-delimiters-depth-3">(</span>stderr<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] Connected to the server Ok. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">From OpenSSL library</span>
    display_certificate<span class="org-rainbow-delimiters-depth-2">(</span>ssl<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Check certifcate </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> SSL_get_verify_result<span class="org-rainbow-delimiters-depth-3">(</span>ssl<span class="org-rainbow-delimiters-depth-3">)</span> == X509_V_OK <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [INFO] Certificate validated. Ok. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [ERROR] Certificate validation. =&gt; May be self signed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        ERR_print_errors_fp<span class="org-rainbow-delimiters-depth-3">(</span>stderr<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">========= Session Loop =============================//</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------------//</span>

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Null character '\0' initialized buffer </span>
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>0<span class="org-rainbow-delimiters-depth-2">}</span>; 

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = SSL_read<span class="org-rainbow-delimiters-depth-3">(</span>ssl, buffer, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Return 0 bytes when peer (server) closes connection.</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>size == 0<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [INFO] Peer closed the connection. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>size == -1<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] Failed to read socket. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [SERVER] "</span> + <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span>buffer, buffer + size<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; msg &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Write back message to server.</span>
        SSL_write<span class="org-rainbow-delimiters-depth-3">(</span>ssl, msg.data<span class="org-rainbow-delimiters-depth-4">()</span>, msg.size<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">========= Dispose Resources ========================//</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Dispose resource (file descriptor)</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release SSL context </span>
    SSL_CTX_free<span class="org-rainbow-delimiters-depth-2">(</span>ctx<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

    <span class="org-comment-delimiter">//</span><span class="org-comment">==================================================//</span>
    <span class="org-comment-delimiter">//          </span><span class="org-comment">I M P L E M E N T A T I O N S           // </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">==================================================// </span>

<span class="org-type">int</span> 
<span class="org-function-name">socket_connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span>, <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> =  socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">assert() =&gt; Placeholder for future error handling.</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != FAILURE <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Query DNS </span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> h != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>; 
    <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-type">int</span> <span class="org-variable-name">res</span> = connect<span class="org-rainbow-delimiters-depth-2">(</span>  sockfd
                      , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">sockaddr</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>&amp;sa<span class="org-rainbow-delimiters-depth-3">)</span>
                      , <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> res != FAILURE &amp;&amp; <span class="org-string">"Failure to connect =&gt; Check errno. "</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> sockfd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">SSL_Tuple</span>
<span class="org-function-name">setup_ssl</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    SSL_load_error_strings<span class="org-rainbow-delimiters-depth-2">()</span>;
    ERR_load_BIO_strings<span class="org-rainbow-delimiters-depth-2">()</span>;
    OpenSSL_add_all_algorithms<span class="org-rainbow-delimiters-depth-2">()</span>;
    SSL_library_init<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Instantiate SSL method </span>
    <span class="org-keyword">const</span> <span class="org-type">SSL_METHOD</span>* <span class="org-variable-name">method</span> = SSLv23_method<span class="org-rainbow-delimiters-depth-2">()</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> method != <span class="org-constant">nullptr</span> &amp;&amp; <span class="org-string">"Failure to load SSL method."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Create SSL context (ctx)</span>
    <span class="org-type">SSL_CTX</span>* <span class="org-variable-name">ctx</span> = SSL_CTX_new<span class="org-rainbow-delimiters-depth-2">(</span> method <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ctx == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Failed to create SSL context \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        ERR_print_errors_fp<span class="org-rainbow-delimiters-depth-3">(</span>stderr<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::abort<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>SSL_CTX_set_default_verify_paths<span class="org-rainbow-delimiters-depth-3">(</span>ctx<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Failure to set default trusted CA paths"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        ERR_print_errors_fp<span class="org-rainbow-delimiters-depth-3">(</span>stderr<span class="org-rainbow-delimiters-depth-3">)</span>;
        exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">SSL</span>* <span class="org-variable-name">ssl</span> = SSL_new<span class="org-rainbow-delimiters-depth-2">(</span>ctx<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> ssl != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> SSL_Tuple<span class="org-rainbow-delimiters-depth-2">{</span> ctx, ssl <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> 
<span class="org-function-name">display_certificate</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">SSL</span>* <span class="org-variable-name">ssl</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">X509</span>* <span class="org-variable-name">cert</span> = SSL_get_peer_certificate<span class="org-rainbow-delimiters-depth-2">(</span>ssl<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> cert == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Failed to get certificate \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        ERR_print_errors_fp<span class="org-rainbow-delimiters-depth-3">(</span>stderr<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    

    <span class="org-type">char</span>* <span class="org-variable-name">out</span>  = <span class="org-constant">nullptr</span>;

    <span class="org-type">long</span> <span class="org-variable-name">version</span> = X509_get_version<span class="org-rainbow-delimiters-depth-2">(</span>cert<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [CERTIFICATE] version = %d \n"</span>, version<span class="org-rainbow-delimiters-depth-2">)</span>;

    out = X509_NAME_oneline<span class="org-rainbow-delimiters-depth-2">(</span> X509_get_subject_name<span class="org-rainbow-delimiters-depth-3">(</span>cert<span class="org-rainbow-delimiters-depth-3">)</span>, 0, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [CERTIFICATE] name = %s \n"</span>, out<span class="org-rainbow-delimiters-depth-2">)</span>;
    free<span class="org-rainbow-delimiters-depth-2">(</span>out<span class="org-rainbow-delimiters-depth-2">)</span>;

    out = X509_NAME_oneline<span class="org-rainbow-delimiters-depth-2">(</span> X509_get_issuer_name<span class="org-rainbow-delimiters-depth-3">(</span>cert<span class="org-rainbow-delimiters-depth-3">)</span>, 0, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [CERTIFICATE] issuer = %s \n"</span>, out<span class="org-rainbow-delimiters-depth-2">)</span>;
    free<span class="org-rainbow-delimiters-depth-2">(</span>out<span class="org-rainbow-delimiters-depth-2">)</span>;

    X509_free<span class="org-rainbow-delimiters-depth-2">(</span>cert<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Install OpenSSL Dependency</b> 
</p>

<p>
Debian and Ubuntu Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sudo apt-get install libssl-dev
</pre>
</div>

<p>
Fedora Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sudo dnf install -y openssl-devel.x86_64
</pre>
</div>

<p>
<b>Building</b> 
</p>

<p>
Building manually: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; git clone https://gist.github.com/bb884fd36b8930cb7358133c2afe9b56 proj &amp;&amp; <span class="org-builtin">cd</span> proj 
$ &gt;&gt; g++ ssl-test.cpp -o <span class="org-keyword">ssl-test</span> -std=c++1z -Wall -Wextra -lssl -lcrypto
</pre>
</div>

<p>
Building with CMake: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; git clone https://gist.github.com/bb884fd36b8930cb7358133c2afe9b56 proj &amp;&amp; <span class="org-builtin">cd</span> proj 

 $ &gt;&gt; ls
cert.pem  CMakeLists.txt  key.pem  ssl-test.cpp

 $ &gt;&gt; cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug
 $ &gt;&gt; cmake --build _build --target

 $ &gt;&gt; file _build/ssl-test 
<span class="org-function-name">_build/ssl-test</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), 
dynamically linked, interpreter /lib64/ld-linux-x86-64.so.
2, <span class="org-variable-name">BuildID</span>[sha1]=ff0d3e3765841a53a13dab7b700726fcbd92fe56, for GNU/Linux 3.2.0, with debug_info, not stripped
</pre>
</div>

<p>
<b>Generate a sample certificate for testing purposes</b> 
</p>

<p>
Create a certificate (cert.pem) and private key (key.pem) and answer the prompt. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ openssl req -x509 -nodes -days 5000 -newkey rsa:1024 -keyout key.pem -out cert.pem
</pre>
</div>

<p>
View certificate: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; openssl x509 -text -in cert.pem

<span class="org-function-name">Certificate</span>:
    Data:
        Version: 3 (0x2)
        Serial Number:
            57:5b:cc:50:94:fe:5f:e8:cb:7e:44:43:80:50:76:27:47:61:ba:7e
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = UK, ST = Bristol, L = Yorkshire, O = some company, OU = dummy department, CN = www.myserver.com, emailAddress = company@mail.co.de
        Validity
            Not Before: Dec  9 22:25:09 2020 GMT
            Not After : Aug 18 22:25:09 2034 GMT
        Subject: C = UK, ST = Bristol, L = Yorkshire, O = some company, OU = dummy department, CN = www.myserver.com, emailAddress = company@mail.co.de
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (1024 bit)
                Modulus:
                    00:f3:73:c4:8c:86:6e:d5:06:a7:86:5d:1d:2f:f3:
                    e7:7e:cd:f5:30:b5:c7:21:47:c2:8b:3f:f4:f3:09:
                    30:27:7e:5f:9d:a9:44:b9:5d:e4:50:4b:fe:d7:41:
                    d0:17:da:72:a6:99:f7:25:c5:e1:f1:1f:ee:47:69:
                    d0:c2:47:63:f7:f1:4a:ff:aa:3c:66:57:29:35:a4:
                    c8:9d:b2:cf:44:e4:c4:15:21:8b:4d:25:61:c3:ee:
                    c4:47:50:88:b6:19:d7:77:06:39:d8:6f:34:f0:51:
                    9f:86:78:2e:5c:d9:a5:e6:33:c4:29:a4:f8:8e:01:
                    c0:c7:27:fe:73:bf:ea:3d:2f
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                52:48:8A:A3:78:49:BD:65:A5:E2:C9:EC:86:FF:05:93:D1:7F:A4:C4
            X509v3 Authority Key Identifier: 
                keyid:52:48:8A:A3:78:49:BD:65:A5:E2:C9:EC:86:FF:05:93:D1:7F:A4:C4

            X509v3 Basic Constraints: critical
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
         b8:ee:be:e6:17:5f:9f:be:61:9f:05:c8:d2:58:f7:86:70:84:
         5f:4b:0c:2a:e8:e5:19:03:20:62:6f:93:34:0c:65:af:68:ac:
         95:ac:33:84:7e:3e:04:54:69:26:a3:f6:60:61:25:38:f2:0c:
         24:94:fc:68:5a:f4:02:e1:61:8c:a7:bd:63:1d:39:e0:b9:f7:
         d7:77:ea:1e:5b:10:13:29:85:26:bf:a0:dc:e6:7d:4f:ff:73:
         26:e4:d7:92:f3:be:6c:5b:55:c9:6f:e3:4e:1a:a6:b0:a8:ce:
         59:e8:4c:21:b3:b7:03:7c:26:71:a4:61:8d:24:9b:cf:d8:d4:
         8a:4b
-----BEGIN CERTIFICATE-----
MIIDJDCCAo2gAwIBAgIUV1vMUJT+X+jLfkRDgFB2J0dhun4wDQYJKoZIhvcNAQEL
BQAwgaMxCzAJBgNVBAYTAlVLMRAwDgYDVQQIDAdCcmlzdG9sMRIwEAYDVQQHDAlZ
b3Jrc2hpcmUxFTATBgNVBAoMDHNvbWUgY29tcGFueTEZMBcGA1UECwwQZHVtbXkg
ZGVwYXJ0bWVudDEZMBcGA1UEAwwQd3d3Lm15c2VydmVyLmNvbTEhMB8GCSqGSIb3
DQEJARYSY29tcGFueUBtYWlsLmNvLmRlMB4XDTIwMTIwOTIyMjUwOVoXDTM0MDgx
ODIyMjUwOVowgaMxCzAJBgNVBAYTAlVLMRAwDgYDVQQIDAdCcmlzdG9sMRIwEAYD
VQQHDAlZb3Jrc2hpcmUxFTATBgNVBAoMDHNvbWUgY29tcGFueTEZMBcGA1UECwwQ
ZHVtbXkgZGVwYXJ0bWVudDEZMBcGA1UEAwwQd3d3Lm15c2VydmVyLmNvbTEhMB8G
CSqGSIb3DQEJARYSY29tcGFueUBtYWlsLmNvLmRlMIGfMA0GCSqGSIb3DQEBAQUA
A4GNADCBiQKBgQDzc8SMhm7VBqeGXR0v8+d+zfUwtcchR8KLP/TzCTAnfl+dqUS5
XeRQS/7XQdAX2nKmmfclxeHxH+5HadDCR2P38Ur/qjxmVyk1pMidss9E5MQVIYtN
JWHD7sRHUIi2Gdd3BjnYbzTwUZ+GeC5c2aXmM8QppPiOAcDHJ/5zv+o9LwIDAQAB
o1MwUTAdBgNVHQ4EFgQUUkiKo3hJvWWl4snshv8Fk9F/pMQwHwYDVR0jBBgwFoAU
UkiKo3hJvWWl4snshv8Fk9F/pMQwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0B
AQsFAAOBgQC47r7mF1+fvmGfBcjSWPeGcIRfSwwq6OUZAyBib5M0DGWvaKyVrDOE
fj4EVGkmo/ZgYSU48gwklPxoWvQC4WGMp71jHTnguffXd+oeWxATKYUmv6Dc5n1P
/3Mm5NeS875sW1XJb+<span class="org-variable-name">NOGqawqM5Z6Ewhs7cDfCZxpGGNJJvP2NSKSw</span>==
-----END CERTIFICATE-----
</pre>
</div>

<p>
<b>Run Netcat server as TLS server using the generated certificate</b> 
</p>

<p>
Netcat terminal emulator: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; nc --verbose  --ssl-key key.pem --ssl-cert cert.pem --listen 9051
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Listening on :::9051
<span class="org-function-name">Ncat</span>: Listening on 0.0.0.0:9051
<span class="org-function-name">Ncat</span>: Connection from 127.0.0.1.
<span class="org-function-name">Ncat</span>: Connection from 127.0.0.1:60202.
User types message<span class="org-keyword"> in</span> server terminal, the client sends them back to server
 [SERVER] User types message<span class="org-keyword"> in</span> server terminal, the client sends them back to server
Turn on control valve 
 [SERVER] Turn on control valve
Shutdown cooling system
 [SERVER] Shutdown cooling system
Solve control equations
 [SERVER] Solve control equations
Type Ctrl + C at server terminal to shutdown the connection.^C&#9166;   
</pre>
</div>

<p>
TLS Client terminal emulator: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./build/ssl-test localhost 9051 
 [TRACE] X509 Trust Certificate Directory: /etc/pki/tls/certs 
 [INFO] Connected to the server Ok.  [CERTIFICATE] version = 2 
 [CERTIFICATE] name = /C=UK/ST=Bristol/L=Yorkshire/O=some company/OU=dummy department/CN=www.myserver.com/emailAddress=company@mail.co.de 
 [CERTIFICATE] issuer = /C=UK/ST=Bristol/L=Yorkshire/O=some company/OU=dummy department/CN=www.myserver.com/emailAddress=company@mail.co.de 
 [ERROR] Certificate validation. =&gt; May be self signed. 
 [SERVER] User types message<span class="org-keyword"> in</span> server terminal, the client sends them back to server

 [SERVER] Turn on control valve

 [SERVER] Shutdown cooling system

 [SERVER] Solve control equations

 [INFO] Peer closed the connection. 
</pre>
</div>

<p>
<b>Attempt to connect to web sites using HTTPS - HTTP/TLS (port 443)</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; build/ssl-test www.yahoo.com 443
 [TRACE] X509 Trust Certificate Directory: /etc/pki/tls/certs 
 [INFO] Connected to the server Ok.  [CERTIFICATE] version = 2 
 [CERTIFICATE] name = /C=US/ST=California/L=Sunnyvale/O=Oath Inc/CN=*.www.yahoo.com 
 [CERTIFICATE] issuer = /C=US/O=DigiCert Inc/OU=www.digicert.com/CN=DigiCert SHA2 High Assurance Server CA 
 [INFO] Certificate validated. Ok. 
^C^C&#9166;  

 $ &gt;&gt; build/ssl-test www.bing.com 443
 [TRACE] X509 Trust Certificate Directory: /etc/pki/tls/certs 
 [INFO] Connected to the server Ok.  [CERTIFICATE] version = 2 
 [CERTIFICATE] name = /CN=www.bing.com 
 [CERTIFICATE] issuer = /C=US/O=Microsoft Corporation/CN=Microsoft RSA TLS CA 02 
 [INFO] Certificate validated. Ok. 
^C&#9166; 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf142a6a" class="outline-3">
<h3 id="orgf142a6a"><span class="section-number-3">1.29</span> Sockets with Multiplexed IO APIs (poll, epoll) [DRAFT]</h3>
<div class="outline-text-3" id="text-1-29">
</div>
<div id="outline-container-org118b0b3" class="outline-4">
<h4 id="org118b0b3"><span class="section-number-4">1.29.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-29-1">
<p>
A recurrent need in network socket programming is to handle multiple
incoming client socket connections that need to be managed
simultaneously. For instance, if a blocking read operation is
performed on a client socket from a http(web) server, the server will
not be able to serve the remaining client sockets while the read
operation is ongoing. Several solutions have adopted for solving this
issue, such as: 
</p>

<ul class="org-ul">
<li><span class="underline">Blocking IO (+) One process per connection</span>
<ul class="org-ul">
<li>Peform fork() system call, creating a child process wich is a
copy of current process and let it manage the socket file
descriptor.</li>
<li>Drawbacks: Complex, expensive and slow. A process has lots of operating
system resources associated with it, including virtual memory,
file descriptors and so on. Another issue is the complexity from
IPC - Inter-Process Communication.</li>
</ul></li>

<li><span class="underline">Blocking IO (+) One thread per connection</span>
<ul class="org-ul">
<li>Spawn/create a new thread for every connection.</li>
<li>Drawbacks: Although, this approach is less expensive than
open-process-per-connection method, it is still expensive and
non-scalable, specially for handling thousands of connections.</li>
</ul></li>

<li><span class="underline">Blocking IO (+) Thread Pool</span>
<ul class="org-ul">
<li>Reuse a set of pre-existing threads for managing each
connection and avoid the overhead of creating and destroying too
many threads.</li>
<li>Drawbacks: Long running connections should have a timeout in
order to not block a thread pool and make it unable to server
the remaining client socket requests. This method is less
scalable than multiplexed IO.</li>
</ul></li>

<li><span class="underline">Multiplexed IO</span> [BEST]
<ul class="org-ul">
<li>Many operating systems provide multiplexed IO facilities, such
as <span class="underline">select</span>, <span class="underline">poll</span> and <span class="underline">epoll</span> on Linux, <span class="underline">keque</span> on BSD-variants and
Mac-OSX and <span class="underline">IOCP</span> on Windows. Multiplexed IO allow managing
multiple file descriptors of any type in a single thread,
consequently this feature allows handling multiple client
socket connetions with far less overhead than using one thread
for every connection. This type IO API is that makes the
scalability of Nginx web server and NodeJS.</li>

<li>Multiplexed IO works in the following way: first the
application register the file descriptors it is interested in
monitoring; then the calling code calls a multiplexed IO
function that blocks the current thread during some amount of
time or indefinitely, the IO multiplexing function only
returns when any of the file descriptors are ready to be read
or written. The calling code handles each file descriptor by
iterating over the data structure returned by the IO
multiplexing function which contains the file descriptors
events.</li>

<li>Note: It is possible to run multiple multiplexed-IO event loops
in different threads for increasing responsiveness and
scalability.</li>

<li>Drawbacks:
<ul class="org-ul">
<li>Event-driven with possible callback hell which can be avoided
with <span class="underline">user-space threads</span> (aka: coroutines, goroutines, green
threads).</li>
<li>Any operation which takes a significant time needs to be run
in another thread, otherwise the threads handling the
connection will be blocked and unable to server any other
client request.</li>
</ul></li>

<li>Wrappers:
<ul class="org-ul">
<li>Multiplexed IO APIs are not standardized. As a result,
several high level wrappers have been created for providing
an uniform and cross-platform API for multiplexed IO. Some of
those wrapper libraries are:
<ul class="org-ul">
<li><i>Boost.ASIO</i> - C++ library for scalable and cross-platform network programming.</li>
<li><i>libUV</i>      - C library used by NodeJS; Julia language and so on.</li>
<li><i>libev</i></li>
<li><i>libEvent</i></li>
</ul></li>
</ul></li>

<li>Note: Many documents also calls multiplexed IO as <span class="underline">event-driven</span>
<span class="underline">IO</span>, <span class="underline">non-blocking IO</span> and so on.</li>

<li>Note: The EPool API cannot monitor file descriptors of regular
files. For this case, the Linux kernel provides the <span class="underline">iNotify</span> API.</li>
</ul></li>
</ul>

<p>
See: 
</p>

<ul class="org-ul">
<li><a href="https://eklitzke.org/blocking-io-nonblocking-io-and-epoll">Blocking I/O, Nonblocking I/O, And Epoll</a></li>

<li><a href="https://medium.com/@copyconstruct/the-method-to-epolls-madness-d9d2d6378642">The method to epoll’s madness. My previous post covered the… | by Cindy Sridharan | Medium</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc3c8776" class="outline-4">
<h4 id="orgc3c8776"><span class="section-number-4">1.29.2</span> Poll()  multiplexed IO API</h4>
<div class="outline-text-4" id="text-1-29-2">
<p>
Poll is a standardized multiplexing IO API common to a wide variety of
Unix-like operating systems, including Linux-based operating systems,
BSD variants and MacOSX. Poll() API is able to monitor multiple
file descriptors in a single thread without any wasteful polling. The
API blocks the current thread for a certain amount of time and
returns until any monitored file descriptor is ready for read or
write IO operations. 
</p>

<p>
Observations: 
</p>

<ul class="org-ul">
<li>Multiplexed IO is often also called (there is no a standard terminology yet):
<ul class="org-ul">
<li>multiplexed IO (Input/Output)</li>
<li>asynchronous IO</li>
<li>async IO</li>
<li>event-driven IO</li>
<li>event-based IO</li>
<li>non-blocking IO (although, it really do blocks the current thread.)</li>
</ul></li>

<li>Poll() is able to monitor:
<ul class="org-ul">
<li>Standard terminal IO file descriptors (STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO)</li>
<li>socket file descriptors</li>
<li>terminal file descriptors</li>
<li>anonymous pipes</li>
<li>named pipes</li>
<li>character device files</li>
</ul></li>

<li>Poll() is not able to monitor file descriptor for <span class="underline">regular</span>
<span class="underline">files</span>. In this case, the poll() should be used alongside <span class="underline">inotify</span>
(Linux-only).</li>
</ul>

<p>
<b>Comparison with Epoll</b> 
</p>

<ul class="org-ul">
<li>The Poll() API is less scalable and less efficient than the
Epoll() API since that, the Poll API requires client code
iterating over all monitored file descriptors in order to find
which ones are ready for IO operation. Despite Poll() API
shortcomings, the advantage of this API over its comparison
counterpat is the higher availability on a broad range of
Unix-like operating systems such as MacOSX, BSD variants, QNX and
so on. While Epoll API is only available on Linux kernel.</li>
</ul>

<p>
<b>Header</b> 
</p>

<ul class="org-ul">
<li>#include &lt;poll.h&gt;</li>
</ul>

<p>
<b>Functions</b> 
</p>

<ul class="org-ul">
<li>poll() =&gt; Blocks the current thread for a certain amount time
until one or more file descriptor is ready for IO operations. If
the timeout parameter is (-1), the calling thread is blocked
indefinitely until some IO event happens.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">poll</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">struct</span> <span class="org-type">pollfd</span> *<span class="org-variable-name">fds</span>, <span class="org-type">nfds_t</span> <span class="org-variable-name">nfds</span>, <span class="org-type">int</span> <span class="org-variable-name">timeout</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">poll</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Array containing monitored file descriptors.   </span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Array alllocated by the caller. </span>
          <span class="org-keyword">struct</span> <span class="org-type">pollfd</span>* <span class="org-variable-name">fds</span>     
          <span class="org-comment-delimiter">// </span><span class="org-comment">Number of monitored file descriptors                                     </span>
          , <span class="org-type">nfds_t</span>         <span class="org-variable-name">nfds</span>    
          <span class="org-comment-delimiter">// </span><span class="org-comment">Timeout for which poll() blocks the current thread.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">in milliseconds. If the timeout is (-1), the current </span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">thread is blocked indefinitely. </span>
          , <span class="org-type">int</span>            <span class="org-variable-name">timeout</span>                                     
        <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Data Structures</b> 
</p>

<ul class="org-ul">
<li>See: event and rvents flags at (<a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll(2) - Linux manual page</a>).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">pollfd</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">[INPUT] fd =&gt; Monitored file descriptor. </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">can be set to (-1) when the calling code </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">is no longer interested in the file descriptor. </span>
        <span class="org-type">int</span> <span class="org-variable-name">fd</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">[INPUT] Flags (bitwise-OR) that selects the types of IO events that  </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">will be monitored for this file descriptor.</span>
        <span class="org-type">short</span> <span class="org-variable-name">events</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">[OUTPUT] Flags (bitwise-OR) which contains the IO events</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">that happened to the file descriptor. Those flags are </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">set by the function poll(). </span>
        <span class="org-type">short</span> <span class="org-variable-name">revents</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>Usage</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">nfds</span> = 10;

 <span class="org-comment-delimiter">// </span><span class="org-comment">Caller allocates arrays containing the monitored file descriptors.</span>
 <span class="org-keyword">struct</span> <span class="org-type">pollfd</span> <span class="org-variable-name">pollv</span><span class="org-rainbow-delimiters-depth-1">[</span>nfds<span class="org-rainbow-delimiters-depth-1">]</span>; 
 memset<span class="org-rainbow-delimiters-depth-1">(</span>pollv, 0x00, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>pollfd<span class="org-rainbow-delimiters-depth-2">)</span> * nfds<span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">=== Caller register file descriptors and events it is interested ======// </span>
 <span class="org-comment-delimiter">// </span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Register STDIN (Standard terminal input)</span>
 pollv<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.fd     = STDIN_FILENO; 
 pollv<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.events = POLLIN | POLLER | POLLHUP; 

 <span class="org-comment-delimiter">// </span><span class="org-comment">Register socket server </span>
 pollv<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.fd     = server_socket_fd; 
 pollv<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>.events = POLLIN | POLLER | POLLHUP | POLLOUT; 

 ... .... ... ...  

<span class="org-comment-delimiter">//</span><span class="org-comment">===================================================// </span>
<span class="org-comment-delimiter">//   </span><span class="org-comment">Run event loop / IO-multiplexing loop           // </span>
<span class="org-comment-delimiter">//</span><span class="org-comment">===================================================//</span>

<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span>;;<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">This thread is blocked indefintely until an IO event happens.</span>
   <span class="org-type">int</span> <span class="org-variable-name">ret</span> = poll<span class="org-rainbow-delimiters-depth-2">(</span>pollv, nfds, -1<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">--- Check return value -------//</span>
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ret == 0<span class="org-rainbow-delimiters-depth-2">){</span>
      fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Timeout \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-keyword">continue</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
   <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ret == -1<span class="org-rainbow-delimiters-depth-2">){</span>
      fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Non recoverable error happened. Check ERRNO. Abort() \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      exit<span class="org-rainbow-delimiters-depth-3">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">Iterate over IO events </span>
   <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span> = 0; n &lt; nfds ; n++<span class="org-rainbow-delimiters-depth-2">)</span>
   <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">pfd</span> = pollv<span class="org-rainbow-delimiters-depth-3">[</span>n<span class="org-rainbow-delimiters-depth-3">]</span>;
       <span class="org-comment-delimiter">// </span><span class="org-comment">Skip elements for which any event happened. </span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pfd.revents == 0<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pfd.fd == STDIN_FILENO &amp;&amp; pfd.revents &amp; POLLIN<span class="org-rainbow-delimiters-depth-3">)</span>
       <span class="org-rainbow-delimiters-depth-3">{</span>
           <span class="org-comment-delimiter">// </span><span class="org-comment">.... User typed something in the console. </span>
           <span class="org-keyword">continue</span>; 
       <span class="org-rainbow-delimiters-depth-3">}</span>

       <span class="org-comment-delimiter">// </span><span class="org-comment">A remote machine (client-side) attempts to connect to server. </span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pfd.fd == server_socket_fd<span class="org-rainbow-delimiters-depth-3">)</span>
       <span class="org-rainbow-delimiters-depth-3">{</span>
           <span class="org-comment-delimiter">// </span><span class="org-comment">.... Income request for connecting to server ... // </span>
           <span class="org-comment-delimiter">// </span><span class="org-comment">Register client socket </span>
           <span class="org-keyword">continue</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

       <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when client socket is ready for read() operation. </span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pfd &amp; POLLIN<span class="org-rainbow-delimiters-depth-3">){</span>
             <span class="org-comment-delimiter">// </span><span class="org-comment">Read bytes from client socket file descriptor. </span>
             <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-4">(</span>pfd.fd, buffer, 500<span class="org-rainbow-delimiters-depth-4">)</span>;
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 1<span class="org-rainbow-delimiters-depth-4">){</span>  perror<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"read() error"</span><span class="org-rainbow-delimiters-depth-5">)</span>; exit<span class="org-rainbow-delimiters-depth-5">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span>  
                 fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Client socket closed connection. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                 close<span class="org-rainbow-delimiters-depth-5">(</span>pfd.fd<span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-comment-delimiter">// </span><span class="org-comment">The file descriptor is set to (-1) when the calling code </span>
                 <span class="org-comment-delimiter">// </span><span class="org-comment">is no longer interested in monitoring the descriptor. </span>
                 pfd.fd = -1;
              <span class="org-rainbow-delimiters-depth-4">}</span>

             <span class="org-comment-delimiter">// </span><span class="org-comment">....  Write to STDOUT ... // </span>
             write<span class="org-rainbow-delimiters-depth-4">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>
   <span class="org-rainbow-delimiters-depth-2">}</span>
</pre>
</div>

<p>
<b>References</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll(2) - Linux manual page</a></li>

<li><a href="https://man.openbsd.org/poll.2">poll(2) - OpenBSD manual pages</a></li>

<li><a href="https://afterthoughtsoftware.com/posts/Polling-on-stdin-with-systemd">Using C poll() on stdin with systemd | Afterthought Software</a></li>

<li><a href="https://www.ibm.com/support/knowledgecenter/ssw_ibm_i_73/rzab6/poll.htm">Using poll() instead of select()</a></li>
</ul>
</div>
</div>

<div id="outline-container-org27c17c3" class="outline-4">
<h4 id="org27c17c3"><span class="section-number-4">1.29.3</span> Poll() sample code</h4>
<div class="outline-text-4" id="text-1-29-3">
<p>
In the following sample code, the Poll() API is used for monitoring IO
events from standard terminal input (stdin); socket server and
connected client sockets. Anything typed by the user on ther terminal
is immediately forwarded to the client sockets.
</p>

<ul class="org-ul">
<li>GIST with sources at:
<ul class="org-ul">
<li><a href="https://gist.github.com/43901ae8724abba8fdbec7f5319b19d1">https://gist.github.com/43901ae8724abba8fdbec7f5319b19d1</a></li>
</ul></li>
</ul>

<p>
File: <span class="underline">poll-server.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/ioctl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">poll.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-keyword">struct</span> <span class="org-type">sresult</span><span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span>;
    <span class="org-type">ssize_t</span>     <span class="org-variable-name">size</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">sresult</span> <span class="org-function-name">read_string</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>    <span class="org-function-name">write_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>    <span class="org-function-name">write_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>    <span class="org-function-name">write_string</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">UNIX_FAILURE</span> = -1;
<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">BLOCK_INFINITE_TIMEOUT</span> = -1;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Process Unique Identifier  PID = %d \n"</span>, ::getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">======= Server configuration =========// </span>
    <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>     = 9056;
     <span class="org-keyword">const</span> <span class="org-type">char</span>*  <span class="org-variable-name">hostname</span> = <span class="org-string">"0.0.0.0"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">====== Create Socket File Descriptor =============// </span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET       <span class="org-comment-delimiter">// </span><span class="org-comment">domain:   IPv4</span>
                          , SOCK_STREAM   <span class="org-comment-delimiter">// </span><span class="org-comment">type:     TCP </span>
                          , 0             <span class="org-comment-delimiter">// </span><span class="org-comment">protocol: (value 0) </span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] sockfd = %d \n"</span>, sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Placeholder for future error handling. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure </span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: t 'struct' is redundant. </span>
     <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>; 
     memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
     sa.sin_family = AF_INET;
     sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>; 

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address </span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != UNIX_FAILURE &amp;&amp; <span class="org-string">" Non-recoverable failure. Check errno. "</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">================ Server Main Loop ===============//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">This heap-allocated array contains all file </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">descriptors that will be monitored. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">pollv</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">struct</span> <span class="org-type">pollfd</span><span class="org-rainbow-delimiters-depth-2">&gt;{}</span>;    

    <span class="org-keyword">struct</span> <span class="org-type">pollfd</span> <span class="org-variable-name">pfd</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register STDIN file descriptor </span>
    pfd.fd      = STDIN_FILENO;
    pfd.events  = POLLIN;
    pfd.revents = 0;
    pollv.push_back<span class="org-rainbow-delimiters-depth-2">(</span>pfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register socket server file descriptor </span>
    pfd.fd      = sockfd;
    pfd.events  = POLLIN;
    pfd.revents = 0;
    pollv.push_back<span class="org-rainbow-delimiters-depth-2">(</span>pfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] pollv.size() = "</span> &lt;&lt; pollv.size<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">======= Server Event Loop / IO Multiplexing Loop =======//</span>
    <span class="org-comment-delimiter">//</span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Waiting IO events. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">poll() Blocks the current thread until any of the file descriptors become ready </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">for IO (Input/Output) operations. On failure, the function returns -1 setting ERRNO.</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">On success, the function poll() returns the number of file descriptors (nfds)</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">ready to be written or read. </span>
        <span class="org-comment-delimiter">// </span>
        <span class="org-type">int</span> <span class="org-variable-name">nfds</span> = ::poll<span class="org-rainbow-delimiters-depth-3">(</span> &amp;pollv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>, pollv.size<span class="org-rainbow-delimiters-depth-4">()</span>, BLOCK_INFINITE_TIMEOUT<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] File descriptors ready. OK =&gt; nfds = %d \n"</span>, nfds<span class="org-rainbow-delimiters-depth-3">)</span>;        

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nfds == UNIX_FAILURE<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] errno = %d / %s \n"</span>, errno, strerror<span class="org-rainbow-delimiters-depth-5">(</span>errno<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>;
            exit<span class="org-rainbow-delimiters-depth-4">(</span>EXIT_FAILURE<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        assert<span class="org-rainbow-delimiters-depth-3">(</span>nfds &gt; 0 &amp;&amp; <span class="org-string">"Nfds supposed to be greater than zero."</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Iterate over ready file descriptors </span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">pf</span> : pollv<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>   
            <span class="org-comment-delimiter">// </span><span class="org-comment">Skip entries for which there is no IO event.          </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>pf.revents == 0<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when user types something in the console.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>pf.fd == STDIN_FILENO<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
                <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stdout, <span class="org-string">" [EVENT] User entered: %s \n"</span>, line.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Send STDIN message to all connected socket clients.</span>
                <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 2; i &lt; pollv.size<span class="org-rainbow-delimiters-depth-6">()</span>; i++<span class="org-rainbow-delimiters-depth-5">){</span>
                    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = pollv<span class="org-rainbow-delimiters-depth-6">[</span>i<span class="org-rainbow-delimiters-depth-6">]</span>.fd;
                    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-6">(</span>fd == -1<span class="org-rainbow-delimiters-depth-6">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-6">}</span>
                    write_string<span class="org-rainbow-delimiters-depth-6">(</span>fd, <span class="org-string">" [STDIN] "</span> + line + <span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-6">)</span>;
                <span class="org-rainbow-delimiters-depth-5">}</span>

                <span class="org-comment-delimiter">// </span><span class="org-comment">Skip the parts below this statement. </span>
                <span class="org-keyword">continue</span>;   
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event happens when a socket client attempts to connect. </span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">// if(pf.fd == sockfd &amp;&amp; ((pf.revents &amp; POLLIN) == POLLIN)  )</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> pf.fd == sockfd <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>   
                <span class="org-type">sockaddr_in</span> <span class="org-variable-name">client_sa</span>;     
                <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-5">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-type">int</span> <span class="org-variable-name">client_fd</span> = accept<span class="org-rainbow-delimiters-depth-5">(</span>sockfd, <span class="org-constant">nullptr</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">//</span><span class="org-comment">if(client_fd == UNIX_FAILURE){ break; }</span>
                assert<span class="org-rainbow-delimiters-depth-5">(</span> client_fd != UNIX_FAILURE &amp;&amp; <span class="org-string">" Non recoverable failure. \n"</span> <span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Received client connection =&gt; client_fd = %d \n"</span>, client_fd<span class="org-rainbow-delimiters-depth-5">)</span>;     

                <span class="org-comment-delimiter">// </span><span class="org-comment">Register client socket file descriptor </span>
                <span class="org-keyword">struct</span> <span class="org-type">pollfd</span> <span class="org-variable-name">pfd</span>;
                pfd.fd      = client_fd;
                pfd.events  = POLLIN | POLLHUP;
                pfd.revents = 0;
                pollv.push_back<span class="org-rainbow-delimiters-depth-5">(</span>pfd<span class="org-rainbow-delimiters-depth-5">)</span>;            

                <span class="org-comment-delimiter">// </span><span class="org-comment">Greet client socket</span>
                write_string<span class="org-rainbow-delimiters-depth-5">(</span>client_fd, <span class="org-string">" [SERVER] Hi, client socket. Welcome to the server. \n\n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when any client socket sends a message.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>pf.revents &amp; POLLIN<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">auto</span> <span class="org-rainbow-delimiters-depth-5">[</span>msg, size<span class="org-rainbow-delimiters-depth-5">]</span> = read_string<span class="org-rainbow-delimiters-depth-5">(</span>pf.fd, 500<span class="org-rainbow-delimiters-depth-5">)</span>;            
                assert<span class="org-rainbow-delimiters-depth-5">(</span> size &gt;= 0 &amp;&amp; <span class="org-string">"  Number of bytes returned supposed to be grater or equal to zero "</span> <span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Socket returns 0 bytes when disconnected </span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>size == 0<span class="org-rainbow-delimiters-depth-5">){</span>
                    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-6">(</span>stdout, <span class="org-string">" [EVENT] Client socket fd = %d closed connection \n"</span>, pf.fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable file descriptor </span>
                    close<span class="org-rainbow-delimiters-depth-6">(</span>pf.fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                    pf.fd = -1;
                    <span class="org-keyword">continue</span>;
                <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stdout, <span class="org-string">" [EVENT] fd = %d ; message = %s "</span>, pf.fd, msg.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                write_string<span class="org-rainbow-delimiters-depth-5">(</span>pf.fd, <span class="org-string">"\n [ECHO] fd = "</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-6">(</span>pf.fd<span class="org-rainbow-delimiters-depth-6">)</span> + <span class="org-string">" / "</span> + msg + <span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

        <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">---- End of for() pf iterations --------//</span>

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">-------- End of server pf loop -----------------------//</span>

    close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------//</span>
    <span class="org-comment-delimiter">//          </span><span class="org-comment">I M P L E M E N T A T I O N S                //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------//</span>

<span class="org-type">sresult</span>
<span class="org-function-name">read_string</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a string initialized with null characters </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">str</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer_size, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span>  = read<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;str<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, buffer_size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>n &gt; 0<span class="org-rainbow-delimiters-depth-2">){</span> str.resize<span class="org-rainbow-delimiters-depth-3">(</span>n<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> sresult<span class="org-rainbow-delimiters-depth-2">{</span> str, n <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">write_buffer</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">buffer</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Pre-condition </span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> size &lt;= SSIZE_MAX  <span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-type">size_t</span>  <span class="org-variable-name">len</span>  = size;
   <span class="org-type">ssize_t</span> <span class="org-variable-name">nr</span>   = -1;
   <span class="org-keyword">auto</span> <span class="org-variable-name">pbuf</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">uint8_t</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>; 

  <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>  len != 0 &amp;&amp; <span class="org-rainbow-delimiters-depth-3">(</span> nr = write<span class="org-rainbow-delimiters-depth-4">(</span>fd, pbuf, len<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span> 
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1 &amp;&amp; errno == EINTR<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>nr == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> 
          <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"An error has happened, check ERRNO "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          <span class="org-keyword">break</span>;
      <span class="org-rainbow-delimiters-depth-3">}</span>
      len  = len - nr; 
      pbuf = pbuf + nr;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">write_string</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    write_buffer<span class="org-rainbow-delimiters-depth-2">(</span>fd, text.data<span class="org-rainbow-delimiters-depth-3">()</span>, text.length<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> 
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ poll-server.cpp -o <span class="org-keyword">poll-server.bin</span> -std=c++1z -Wall -Wextra -g -O0
</pre>
</div>

<p>
Running server in terminal 1: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./poll-server.bin 
 [TRACE] Process Unique Identifier  PID = 434583 
 [TRACE] sockfd = 3 
 [TRACE] pollv.size() = 2
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [TRACE] Received client connection =&gt; client_fd = 4 
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [TRACE] Received client connection =&gt; client_fd = 5 
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [EVENT] fd = 4 ; message = I am the client from the terminal 1
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] fd = 5 ; message = I am the client from the terminal 2
 [TRACE] Waiting IO events. 
This message typed<span class="org-keyword"> in</span> the server terminal (stdin) will be set to all client sockets.
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] User entered: This message typed<span class="org-keyword"> in</span> the server terminal (stdin) will be set to all client sockets. 
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [EVENT] fd = 4 ; message = Turn on valve control system right away.
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] fd = 5 ; message = Shutdown colling system right away.
 [TRACE] Waiting IO events. 
Operation failure (typed by user)
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] User entered: Operation failure (typed by user) 
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [EVENT] fd = 4 ; message = Typed CTRL + C after this message
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] Client socket fd = 4 closed connection 
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
 [EVENT] fd = 5 ; message = Type Ctrl+C for disconnecting from server (terminal 2)
 [TRACE] Waiting IO events. 
 [TRACE] File descriptors ready. OK =&gt; nfds = 1 
  [EVENT] Client socket fd = 5 closed connection 
 [TRACE] Waiting IO events. 

</pre>
</div>

<p>
Running netcat client (TCP client socket) in terminal 2: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc localhost 9056
 [SERVER] Hi, client socket. Welcome to the server. 

I am the client from the terminal 1

 [ECHO] fd = 4 / I am the client from the terminal 1

 [STDIN] This message typed<span class="org-keyword"> in</span> the server terminal (stdin) will be set to all client sockets.
Turn on valve control system right away.

 [ECHO] fd = 4 / Turn on valve control system right away.

 [STDIN] Operation failure (typed by user)
Typed CTRL + C after this message

 [ECHO] fd = 4 / Typed CTRL + C after this message

^C

</pre>
</div>

<p>
Running netcat client (TCP client socket) in terminal 3: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc localhost 9056
 [SERVER] Hi, client socket. Welcome to the server. 

I am the client from the terminal 2

 [ECHO] fd = 5 / I am the client from the terminal 2

 [STDIN] This message typed<span class="org-keyword"> in</span> the server terminal (stdin) will be set to all client sockets.
Shutdown colling system right away.

 [ECHO] fd = 5 / Shutdown colling system right away.

 [STDIN] Operation failure (typed by user)
Type Ctrl+C for disconnecting from server (terminal 2)

 [ECHO] fd = 5 / Type Ctrl+C for disconnecting from server (terminal 2)

^C

</pre>
</div>
</div>
</div>
<div id="outline-container-org30f3247" class="outline-4">
<h4 id="org30f3247"><span class="section-number-4">1.29.4</span> Epoll() multiplexed IO API</h4>
<div class="outline-text-4" id="text-1-29-4">
<p>
Epoll is a highly scalable and efficient Linux-only multiplexed IO API
which allows monitoring an unlimted amount of file descriptors, and
consequentely file descriptors related to regular files, device files
and sockets. This API is that makes the scalability of NodeJS and
Nginx web server possible. 
</p>

<p>
Manpage: 
</p>
<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/epoll_create.2.html">epoll_create()</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">epoll_ctl()</a></li>
</ul>

<p>
Header file: 
</p>
<ul class="org-ul">
<li>#include &lt;sys/epoll.h&gt;</li>
</ul>

<p>
Structs: 
</p>

<ul class="org-ul">
<li>The events is a Or bitmaks, some of the flags are:
<ul class="org-ul">
<li>EPOLLIN  =&gt; "The associated file is available for read(2) operations."</li>
<li>EPOLLOUT =&gt; "The associated file is available for write(2) operations."</li>
<li>EPOLLHUP =&gt; "Hang up happened on the associated file descriptor."</li>
<li>EPOLLET =&gt; "Requests edge-triggered notification for the
associated file descriptor.  The default behavior for epoll is
level-triggered.  See epoll(7) for more detailed information
about edge triggered and level-triggered notification."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-keyword">union</span> <span class="org-type">epoll_data</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>        *<span class="org-variable-name">ptr</span>;
    <span class="org-type">int</span>          <span class="org-variable-name">fd</span>;
    <span class="org-type">uint32_t</span>     <span class="org-variable-name">u32</span>;
    <span class="org-type">uint64_t</span>     <span class="org-variable-name">u64</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">epoll_data_t</span>;

<span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">uint32_t</span>     <span class="org-variable-name">events</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">Epoll events */</span>
    <span class="org-type">epoll_data_t</span> <span class="org-variable-name">data</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">User data variable */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Functions: 
</p>

<ul class="org-ul">
<li><span class="underline">epoll_create1(int)</span> =&gt; Creates epoll object, returns epoll file descriptor.
<ul class="org-ul">
<li>"If flags is 0, then, other than the fact that the obsolete size
argument is dropped, epoll_create1() is the same as
epoll_create().  The following value can be included in flags to
obtain different behavior:"</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-type">int</span> <span class="org-function-name">epoll_create1</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">------ Usage ---------------------//</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descriptor </span>
 <span class="org-type">int</span> <span class="org-variable-name">epfd</span>; 
 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-rainbow-delimiters-depth-2">(</span>epfd = epoll_create1<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span> 
    perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Unable to get epoll file descriptor. Check ERRNO variable."</span><span class="org-rainbow-delimiters-depth-2">)</span>; 
    exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">.... Use Epoll ....</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Close when no longer needed. </span>
close<span class="org-rainbow-delimiters-depth-1">(</span>epfd<span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">epoll_ctl()</span> =&gt; Modify, remove or add file descriptors to the
<i>interest list</i>, set of monitored file descriptors.
<ul class="org-ul">
<li>Doc: $ man epoll_ctl</li>
<li>Doc: <a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">Manpage</a></li>

<li>Some values of 'op':</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">epoll_ctl</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span> <span class="org-variable-name">epfd</span>                     <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descriptor (Epoll object)</span>
              , <span class="org-type">int</span> <span class="org-variable-name">op</span>                       <span class="org-comment-delimiter">// </span><span class="org-comment">Operation to be performed </span>
              , <span class="org-type">int</span> <span class="org-variable-name">fd</span>                       <span class="org-comment-delimiter">// </span><span class="org-comment">File descritor </span>
              , <span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> *<span class="org-variable-name">event</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to epoll_event </span>
             <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Usage example for registering file descriptor     //</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">add file descriptor to interest list.             // </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-type">int</span> <span class="org-variable-name">fd</span> = STDIN_FILENO; <span class="org-comment-delimiter">// </span><span class="org-comment">Stdin, console </span>
<span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor when file descriptor is available for read operations.</span>
ev.events  = EPOLLIN;
<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor when file descriptor is available for write operations.</span>
ev.events  = EPOLLIN | EPOLLOUT;
ev.data.fd = fd; 
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> epoll_ctrl<span class="org-rainbow-delimiters-depth-2">(</span>epfd, EPOLL_CTL_ADD, fd, &amp;ev <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failure. Check errno."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Usage example for removing file descriptor        //</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">--------------------------------------------------//</span>
<span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
ev.events  = EPOLLIN;
ev.data.fd = fd; 
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> epoll_ctrl<span class="org-rainbow-delimiters-depth-2">(</span>epfd, EPOLL_CTL_DEL, fd,  <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failure. Check errno."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">epoll_wait()</span> - IO multiplexing function - blocks the current
thread for some amount of time until an event related to a
monitored file descriptor has happened.
<ul class="org-ul">
<li>Manpage: "wait for an I/O event on an epoll file descriptor"</li>

<li><i>epfd</i> =&gt; Epoll file descriptor</li>

<li><i>events</i> =&gt; (Output) Pointer to array containing the events
related to the monitored file descriptors. This array is
allocated by the calling code.</li>

<li><i>maxevents</i> =&gt; Maximum number of monitored events (often the size
of events array).</li>

<li><i>timeout</i> =&gt; Number of milliseconds that epoll_wait() blocks the
current thread. If this value is (-1), the calling thread is
indefinitely until some IO event happens.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">epoll_wait</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epfd</span>, <span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> *<span class="org-variable-name">events</span>,
               <span class="org-type">int</span> <span class="org-variable-name">maxevents</span>, <span class="org-type">int</span> <span class="org-variable-name">timeout</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Usage example of epoll_wait() with level triggered.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">============ Usage for servers ===================// </span>
<span class="org-comment-delimiter">// </span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_fd_option</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">int</span> <span class="org-variable-name">events</span><span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
     ev.events  = events;
     ev.data.fd = fd; 
     <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>res == -1<span class="org-rainbow-delimiters-depth-2">){</span>
         perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: EPoll / unable to register file descritor"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_EVENTS</span> = 10;     
<span class="org-type">int</span> <span class="org-variable-name">server</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;
 .. .... ... ...

<span class="org-comment-delimiter">// </span><span class="org-comment">Create epoll object </span>
<span class="org-type">int</span> epfd = epoll_create1<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">epoll_event</span> <span class="org-variable-name">notifications</span><span class="org-rainbow-delimiters-depth-1">[</span><span class="org-constant">MAX_EVENTS</span><span class="org-rainbow-delimiters-depth-1">]</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor incoming connections </span>
Epoll_fd_option<span class="org-rainbow-delimiters-depth-1">(</span>epfd, server, EPOLLIN<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor stdin (console file descriptor)</span>
Epoll_fd_option<span class="org-rainbow-delimiters-depth-1">(</span>epfd, STDIN_FILENO, EPOLLIN<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">charr</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-1">[</span>300<span class="org-rainbow-delimiters-depth-1">]</span>;

<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span>;;<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Current thread blocked until any event happens.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns number of evetns </span>
     <span class="org-type">int</span> <span class="org-variable-name">nfsd</span> = epoll_wait<span class="org-rainbow-delimiters-depth-2">(</span>epfd, notifications, MAX_EVENTS, -1<span class="org-rainbow-delimiters-depth-2">)</span>; 

     <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; nfsd; i++<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span> = notifications<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-constant">i</span><span class="org-rainbow-delimiters-depth-3">]</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.data.fd == server<span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Accept connection return a client socket </span>
              <span class="org-type">int</span> <span class="org-variable-name">client_fd</span> = accept<span class="org-rainbow-delimiters-depth-4">(</span>server, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-5">)</span> &amp;client.sa, &amp;addrlen<span class="org-rainbow-delimiters-depth-4">)</span>;
              Epoll_fd_option<span class="org-rainbow-delimiters-depth-4">(</span>epfdm, client_fd, EPOLLIN<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-keyword">continue</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Client socket ready for reading operations.</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.events &amp; EPOLLIN<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Read 300 bytes from client socket file descriptor to buffer </span>
            <span class="org-type">int</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-4">(</span>ev.dada.fd, buffer, 300<span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> close<span class="org-rainbow-delimiters-depth-5">(</span>ev.data.fd<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Send back n bytes to client socket </span>
            write<span class="org-rainbow-delimiters-depth-4">(</span>ev.data.fd, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">continue</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.events &amp; EPOLLOUT<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> 
           <span class="org-comment-delimiter">// </span><span class="org-comment">Perform write operations </span>
           ... ... .... ...                 
        <span class="org-rainbow-delimiters-depth-3">}</span>

     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End for --- //</span>

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End for --- //</span>

close<span class="org-rainbow-delimiters-depth-1">(</span>epfd<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org8ac500d" class="outline-4">
<h4 id="org8ac500d"><span class="section-number-4">1.29.5</span> Epoll() example - sample code</h4>
<div class="outline-text-4" id="text-1-29-5">
<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/f88892ac263b96ba9d989c582dc3ccf1">https://gist.github.com/f88892ac263b96ba9d989c582dc3ccf1</a></li>
</ul>

<p>
Description: 
</p>
<ul class="org-ul">
<li>Sample TCP/IPv4 network server using epoll() multiplexed IO API
for managing STDIN (console input) and multiple client sockets in
a single thread. The server also sends any message typed in server
console to all connected clients.</li>
<li>Note: It uses level triggered IO.</li>
</ul>

<p>
File: multiplex-epoll-server.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread.</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">signal.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Only available on Linux</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/epoll.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-keyword">struct</span> <span class="org-type">Socket</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>           <span class="org-variable-name">sockfd</span>; 
    <span class="org-type">sockaddr_in</span>   <span class="org-variable-name">sa</span>;     
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">RecvMsg</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">ssize_t</span>     <span class="org-variable-name">size</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">socket_close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">void</span>    <span class="org-function-name">fd_write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">RecvMsg</span> <span class="org-function-name">fd_read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_max</span> = 500<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Make a server socket */</span>
<span class="org-type">Socket</span> <span class="org-function-name">socket_make_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = <span class="org-string">"0.0.0.0"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">/** </span><span class="org-comment">Accept connetion from a server socket and returns a client socket */</span>
<span class="org-type">Socket</span> <span class="org-function-name">socket_accept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">server</span><span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">/** </span><span class="org-comment">Register file descriptor to be monitored by Epoll */</span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_register_fd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
    ev.events  = EPOLLIN;
    ev.data.fd = fd; 
    <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>res == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: EPoll / unable to register file descritor"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Remove file descriptor from monitoring list. */</span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_remove_fd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>;
    <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_DEL, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/*  </span><span class="org-comment">Multiplex IO - Blocks current thread until any of monitored file descriptors </span>
<span class="org-comment"> *  has </span>
<span class="org-comment"> */</span>
<span class="org-type">int</span> <span class="org-function-name">Epoll_wait</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">max_events</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">epoll_event</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>&amp; <span class="org-variable-name">events</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns number of events received </span>
    <span class="org-type">int</span> <span class="org-variable-name">nfd</span> = epoll_wait<span class="org-rainbow-delimiters-depth-2">(</span> epoll_fd     <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descripotr </span>
                        , &amp;events<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">[output] Array containing received events </span>
                        , max_events   <span class="org-comment-delimiter">// </span><span class="org-comment">Maximum number of events </span>
                        , -1           <span class="org-comment-delimiter">// </span><span class="org-comment">Timeout (-1) =&gt; Block indefinitely</span>
                        <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> nfd;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> **<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>
    <span class="org-type">Socket</span> <span class="org-variable-name">server</span> = socket_make_server<span class="org-rainbow-delimiters-depth-2">(</span>9026, <span class="org-string">"0.0.0.0"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_EVENTS</span> = 10;     
    <span class="org-type">int</span> <span class="org-variable-name">epfd</span> = epoll_create1<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>epfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">events</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">epoll_event</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>MAX_EVENTS<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register stdin </span>
    Epoll_register_fd<span class="org-rainbow-delimiters-depth-2">(</span>epfd, STDIN_FILENO<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register socket server </span>
    Epoll_register_fd<span class="org-rainbow-delimiters-depth-2">(</span>epfd, server.sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Contains client sockets file descriptors </span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Socket</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">clients</span>; 


    <span class="org-comment-delimiter">// </span><span class="org-comment">Server-accept infinite loop </span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Epoll waiting for events \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-type">int</span> <span class="org-variable-name">nfsd</span> = Epoll_wait<span class="org-rainbow-delimiters-depth-3">(</span>epfd, MAX_EVENTS, events<span class="org-rainbow-delimiters-depth-3">)</span>;            
        assert<span class="org-rainbow-delimiters-depth-3">(</span> nfsd != - 1<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Epoll events arrived =&gt; nfsd = %d \n"</span>, nfsd<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; nfsd; i++<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">ev</span> = events<span class="org-rainbow-delimiters-depth-4">[</span>i<span class="org-rainbow-delimiters-depth-4">]</span>;

            <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">" ----------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-rainbow-delimiters-depth-5">(</span>ev.events &amp; EPOLLERR<span class="org-rainbow-delimiters-depth-5">)</span> || <span class="org-rainbow-delimiters-depth-5">(</span>ev.events &amp; EPOLLHUP<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [ERROR] Epoll error has happened. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">STDIN event =&gt; It happens after user types something and</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">hit RETURN on terminal.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> ev.data.fd == STDIN_FILENO <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [TRACE] Received STDIN event \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
                <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" \n STDIN = "</span> + line &lt;&lt; <span class="org-string">"\n"</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Send typed message to all client sockets</span>
                <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">cli</span>: clients<span class="org-rainbow-delimiters-depth-5">)</span>
                    fd_write<span class="org-rainbow-delimiters-depth-5">(</span>cli.sockfd, <span class="org-string">" STDIN = "</span> + line + <span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Quit server </span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>line == <span class="org-string">"exit"</span><span class="org-rainbow-delimiters-depth-5">){</span> 
                    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">" [INFO] Shutdown server OK."</span><span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-keyword">return</span> EXIT_SUCCESS;
                <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when there is a new connection.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>ev.data.fd == server.sockfd<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>                
                <span class="org-type">Socket</span> <span class="org-variable-name">client</span> = socket_accept<span class="org-rainbow-delimiters-depth-5">(</span>server<span class="org-rainbow-delimiters-depth-5">)</span>;        
                Epoll_register_fd<span class="org-rainbow-delimiters-depth-5">(</span>epfd, client.sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [TRACE] Accept client connection =&gt; ID = %d \n"</span>, client.sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;                
                fd_write<span class="org-rainbow-delimiters-depth-5">(</span>client.sockfd,  <span class="org-string">"\n =&gt; [SERVER INFO] Hello world client side!! \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-comment-delimiter">// </span><span class="org-comment">socket_nonblock(client);</span>
                clients.push_back<span class="org-rainbow-delimiters-depth-5">(</span>client<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when some client socket sends data. </span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">EPOLIN event means that the file descriptor is ready for input. </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>ev.events &amp; EPOLLIN<span class="org-rainbow-delimiters-depth-4">)</span>            
            <span class="org-rainbow-delimiters-depth-4">{</span>
               <span class="org-type">int</span> <span class="org-variable-name">fd</span> = ev.data.fd;
               <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"\n [TRACE] Receive client event =&gt; ID = %d \n"</span>, fd<span class="org-rainbow-delimiters-depth-5">)</span>;
               <span class="org-type">RecvMsg</span> <span class="org-variable-name">resp</span> = fd_read<span class="org-rainbow-delimiters-depth-5">(</span>fd, 500<span class="org-rainbow-delimiters-depth-5">)</span>;                                             
               <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>resp.size == 0<span class="org-rainbow-delimiters-depth-5">)</span>
               <span class="org-rainbow-delimiters-depth-5">{</span>
                   <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"\n [CLIENT ID = %d] =&gt;&gt; Disconnected from server. \n"</span>, fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                   close<span class="org-rainbow-delimiters-depth-6">(</span>fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                   <span class="org-keyword">continue</span>;
               <span class="org-rainbow-delimiters-depth-5">}</span>
               <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"\n [CLIENT ID = %d] =&gt;&gt; size = %d ; msg = %s \n"</span>, fd, resp.size, resp.msg.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>;
               fd_write<span class="org-rainbow-delimiters-depth-5">(</span>fd, <span class="org-string">" [SERVER ECHO] =&gt; ID = "</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-6">(</span>fd<span class="org-rainbow-delimiters-depth-6">)</span> + <span class="org-string">" =&gt; "</span> + resp.msg<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

        <span class="org-rainbow-delimiters-depth-3">}</span>


    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]] */</span>

    socket_close<span class="org-rainbow-delimiters-depth-2">(</span>server<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() -------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Function Implementations ----------------------------------------//</span>

<span class="org-type">void</span> 
<span class="org-function-name">socket_close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    ::close<span class="org-rainbow-delimiters-depth-2">(</span>sock.sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    sock.sockfd = -1;    
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">fd_write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    ::write<span class="org-rainbow-delimiters-depth-2">(</span>fd, text.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, text.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">RecvMsg</span> <span class="org-function-name">fd_read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_max</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer_max, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, buffer_max<span class="org-rainbow-delimiters-depth-2">)</span>;
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>n<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> RecvMsg<span class="org-rainbow-delimiters-depth-2">{</span>n, buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">Socket</span> 
<span class="org-function-name">socket_make_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-2">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span>sockfd != -1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant).</span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span> *<span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
    memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format.</span>
    sa.sin_port = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span>&amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>            
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address</span>
    <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore SIGPIPE signal which would cause abnormal termination of socket server</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Requires: #include &lt;signal.h&gt; header.</span>
    signal<span class="org-rainbow-delimiters-depth-2">(</span>SIGPIPE, SIG_IGN<span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> Socket<span class="org-rainbow-delimiters-depth-2">{</span> sockfd, sa <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">Socket</span> 
<span class="org-function-name">socket_accept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">server</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">Socket</span> <span class="org-variable-name">client</span>;
    <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-2">)</span>;
    client.sockfd = accept<span class="org-rainbow-delimiters-depth-2">(</span>server.sockfd, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-3">)</span> &amp;client.sa, &amp;addrlen<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>client.sockfd == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        close<span class="org-rainbow-delimiters-depth-3">(</span>client.sockfd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> client;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">g++ multiplex-epoll-server.cpp -o <span class="org-keyword">out.bin</span> -std=c++1z -Wall -Wextra 
</pre>
</div>

<p>
Running: (Server - terminal 1)
</p>

<div class="org-src-container">
<pre class="src src-sh"> ./out.bin 

 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Accept client connection =&gt; ID = 7 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 7 

 [CLIENT ID = 7] =&gt;&gt; size = 19 ; msg = hello world server

 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Accept client connection =&gt; ID = 8 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 8 

 [CLIENT ID = 8] =&gt;&gt; size = 30 ; msg = connect server from client 2 

 [TRACE] Epoll waiting for events 
message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Received STDIN event 

 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 8 

 [CLIENT ID = 8] =&gt;&gt; size = 24 ; msg = from client 2 to server

 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
</pre>
</div>

<p>
Running: (Client 1 netcat from terminal 2)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; nc -v localhost 9026
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connection to ::1 failed: Connection refused.
<span class="org-function-name">Ncat</span>: Trying next address...
<span class="org-function-name">Ncat</span>: Connected to 127.0.0.1:9026.

 =&gt; [SERVER INFO] Hello world client side!! 
hello world server
 [SERVER ECHO] =&gt; ID = 7 =&gt; hello world server
 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
from client 1 to server
 [SERVER ECHO] =&gt; ID = 7 =&gt; from client 1 to server
^C&#9166;   
</pre>
</div>

<p>
Running: (Client 2 netcat from terminal 3)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v localhost  9026
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connection to ::1 failed: Connection refused.
<span class="org-function-name">Ncat</span>: Trying next address...
<span class="org-function-name">Ncat</span>: Connected to 127.0.0.1:9026.

 =&gt; [SERVER INFO] Hello world client side!! 
connect server from client 2 
 [SERVER ECHO] =&gt; ID = 8 =&gt; connect server from client 2 
 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
from client 2 to server
 [SERVER ECHO] =&gt; ID = 8 =&gt; from client 2 to server
^C

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgac516b7" class="outline-3">
<h3 id="orgac516b7"><span class="section-number-3">1.30</span> Ptrace - system call</h3>
<div class="outline-text-3" id="text-1-30">
</div>
<div id="outline-container-org627ee36" class="outline-4">
<h4 id="org627ee36"><span class="section-number-4">1.30.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-30-1">
<p>
Ptrace is common system-call implemented by many Unix-like operating
systems, such as Linux and FreeBSD, which provides facilities for
manipulating and observing other processes. The purpose of this sytem
call is to support the implementation of debuggers such as GDB (GNU
Debugger), that use this sytem call for examining, modifying and
manipulating the memory of debugged processes. Besides GDB, the ptrace
system call is also used by the other tools like <span class="underline">ltrace</span>, for tracing
library calls, and by <span class="underline">strace</span>, for tracing system calls. Although,
ptrace has similar capabilities among many different Unix-based
operating systems, ptrace is not a standardized system call, therefore
there are many specific details such as type signature and request
parameters that are operating-system dependent.
</p>

<p>
<b>Documentation</b>  
</p>

<ul class="org-ul">
<li><a href="https://www.man7.org/linux/man-pages/man2/ptrace.2.html">PTrace / Linux Manpage</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ptrace">Ptrace / FreeBSD Manpage</a>
<ul class="org-ul">
<li>=&gt; Note: Ptrace from FreeBSD is different than Linux's Ptrace.</li>
</ul></li>
</ul>

<p>
<b>Ptrace capabilities</b>
</p>

<ul class="org-ul">
<li>Attach to forked child process.</li>
<li>Attach to an already running process.</li>
<li>Read/write tracee process' virtual memory ( represented by the file /proc/&lt;PID&gt;/mem )</li>
<li>Get/Set tracee's process CPU registers.</li>
<li>Red/Write tracee's process virtual memory</li>
<li>Intercept and modify systems calls invoked by the monitored process.</li>
<li>Trace library calls</li>
<li>Set breaking points</li>
</ul>

<p>
<b>Known usage</b>
</p>

<ul class="org-ul">
<li>GDB (GNU Debugger)</li>
<li>strace =&gt; Utility for tracing system calls.</li>
<li>ltrace =&gt; Utility for tracing library calls.</li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.man7.org/linux/man-pages/man2/ptrace.2.html">PTrace / Linux Manpage</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=ptrace">Ptrace / FreeBSD Manpage</a></li>

<li><a href="https://lwn.net/Articles/446593/">Ptrace documentation, draft #6 -LWN.net</a> (Linux)</li>

<li><a href="https://www.linuxjournal.com/article/6100">Playing with ptrace, Part I | Linux Journal</a></li>

<li><a href="https://ops.tips/gists/using-c-to-inspect-linux-syscalls/">Using C to inspect Linux syscalls | OpsTips</a></li>

<li><a href="https://eng.uber.com/pyflame-python-profiler/">Pyflame: Uber Engineering's Profiler for Python | Uber Engineering Blog</a></li>

<li><a href="https://gist.github.com/yamnikov-oleg/454f48c3c45b735631f2">Linux Syscalls Reference · GitHub</a></li>

<li><a href="https://filippo.io/linux-syscall-table/">Searchable Linux Syscall Table for x86 and x86_64 | PyTux</a></li>

<li><a href="https://blog.packagecloud.io/eng/2016/04/05/the-definitive-guide-to-linux-system-calls/">The Definitive Guide to Linux System Calls - Packagecloud Blog</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/X86_calling_conventions#x86-64_calling_conventions">x86 calling conventions - Wikipedia</a></li>

<li><a href="http://www.brendangregg.com/blog/2015-03-17/linux-performance-analysis-perf-tools.html">Linux Performance Analysis: New Tools and Old Secrets</a> - Brendan Gregg</li>
</ul>
</div>
</div>
<div id="outline-container-orga63cca8" class="outline-4">
<h4 id="orga63cca8"><span class="section-number-4">1.30.2</span> Linux Ptrace-related functions</h4>
<div class="outline-text-4" id="text-1-30-2">
<p>
Function: <span class="underline">waitpid()</span>:  
</p>

<ul class="org-ul">
<li>Wait for state change of some process. This function returns (-1)
on failure.</li>
<li>Manpage:
<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/waitpid.2.html">waitpid (Linux)</a></li>
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=waitpid">waitpid (FreeBSD)</a></li>
</ul></li>
<li>Headers:
<ul class="org-ul">
<li>#include &lt;sys/types.h&gt;</li>
<li>#include &lt;sys/wait.h&gt;</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">waitpid</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">(Process ID) Unique numeric idefier of monitored process.</span>
              , <span class="org-type">int</span>*  <span class="org-variable-name">wstatus</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Allocated by caller. </span>
              , <span class="org-type">int</span>   <span class="org-variable-name">options</span>
            <span class="org-rainbow-delimiters-depth-1">)</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">==== U S A G E -  E X A M P L E S ============ //</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Wait until any child process terminated. </span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">-------------------------------------------</span>
 <span class="org-type">int</span> <span class="org-variable-name">status</span> = 0;
 waitpid<span class="org-rainbow-delimiters-depth-1">(</span>-1, &amp;status, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

 <span class="org-comment-delimiter">// </span><span class="org-comment">Check whether process has terminated normally. </span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------</span>
 <span class="org-type">int</span> <span class="org-variable-name">status</span> = 0;
 waitpid<span class="org-rainbow-delimiters-depth-1">(</span>8922, &amp;status, 0<span class="org-rainbow-delimiters-depth-1">)</span>;    
 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> WIFEXITED<span class="org-rainbow-delimiters-depth-2">(</span>status<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">){</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">Process terminated normally. */</span> <span class="org-rainbow-delimiters-depth-1">}</span>


</pre>
</div>

<p>
Function <span class="underline">ptrace()</span>: 
</p>

<ul class="org-ul">
<li>Allows observing and manipulating other processes, such as
forked child processes or processes already running.</li>

<li>Manpage:
<ul class="org-ul">
<li><a href="https://www.man7.org/linux/man-pages/man2/ptrace.2.html">PTrace / Linux Manpage</a></li>
</ul></li>

<li>Headers: 
<ul class="org-ul">
<li>&lt;sys/ptrace.h&gt;</li>
<li>&lt;linux/ptrace.h&gt;</li>
<li>&lt;linux/tracehook.h&gt;</li>
</ul></li>

<li>Parameters:
<ul class="org-ul">
<li><i>request</i> =&gt; Determines the action to be performed.</li>
<li><i>pid</i>  =&gt; Pid of tracee (monitored) process.</li>
<li><i>addr</i> =&gt; Address within the tracee virtual memory. This
parameter is null (nullptr in C++, or NULL in C) for most of
request parameters</li>
<li><i>data</i> =&gt; Data send to tracee's process virtual memory. For most
<span class="underline">request</span> parameters, this parameter is null.</li>
<li><i>RETURN</i>
<ul class="org-ul">
<li>=&gt; Return value, returns (-1) on failure setting <span class="underline">errno</span>
variable. The meaning of the return value depends on the
<span class="underline">request</span> parameter that was used.</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure. </span>
<span class="org-type">long</span>  <span class="org-function-name">ptrace</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span>    <span class="org-variable-name">request</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Request or command </span>
             , <span class="org-type">pid_t</span>  <span class="org-variable-name">pid</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">PID of tracee or monitored pro ess </span>
             , <span class="org-type">void</span>*  <span class="org-variable-name">addr</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Address within the tracee's process virtual memory.        </span>
             , <span class="org-type">void</span>*  <span class="org-variable-name">data</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Data parameter, used by some Ptrace </span>
          <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Summary for some possible values for the <span class="underline">ptrace</span>'s request parameters: 
</p>

<ul class="org-ul">
<li>PTRACE_ATTACH
<ul class="org-ul">
<li>Attach to an already running process given its PID (Unique numeric id identifier)</li>
</ul></li>

<li>PTRACE_DETACH
<ul class="org-ul">
<li>Detach from attached process.</li>
</ul></li>

<li>PTRACE_TRACEME 
<ul class="org-ul">
<li>Used for tracing a child process spawned with fork()
library-call. (Note: fork() on Linux is not a system call)</li>
</ul></li>

<li>PTRACE_PEEKDATA
<ul class="org-ul">
<li>Read data from tracee's process memory.</li>
</ul></li>

<li>PTRACE_POKEDATA
<ul class="org-ul">
<li>Write/set data to some tracee's process location (addr parameter)</li>
</ul></li>

<li>PTRACE_GETREGS
<ul class="org-ul">
<li>Obtain current CPU registers from tracee process.</li>
</ul></li>

<li>PTRACE_SETREGS 
<ul class="org-ul">
<li>Set tracee process' CPU registers.</li>
</ul></li>

<li>PTRACE_SYSCALL
<ul class="org-ul">
<li>Used for tracing and modifying tracee process' system calls.</li>
</ul></li>
</ul>

<p>
Struct: <b>user_regs_struct</b> 
</p>

<ul class="org-ul">
<li>=&gt; Contains CPU registers (context) of monitored process. The
fields struct 'user_regs_struct', which represents the CPU
registers used by the monitored process, are dependent on the
current ISA (Instruction Set Architecture) of current machine.</li>

<li>Headers:
<ul class="org-ul">
<li>&lt;sys/user.h&gt;</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Fields of user_regs_struct for x86-64 ISA (AMD64 ISA)</span>
<span class="org-keyword">struct</span> <span class="org-type">user_regs_struct</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r15</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r14</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r13</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r12</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rbp</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rbx</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r11</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r10</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r9</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">r8</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rax</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rcx</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rdx</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rsi</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rdi</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">orig_rax</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rip</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">cs</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">eflags</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">rsp</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">ss</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">fs_base</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">gs_base</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">ds</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">es</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">fs</span>;
  __extension__ <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-type">long</span> <span class="org-type">int</span> <span class="org-variable-name">gs</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org8b46cbf" class="outline-4">
<h4 id="org8b46cbf"><span class="section-number-4">1.30.3</span> Example - trace system calls of a running process</h4>
<div class="outline-text-4" id="text-1-30-3">
<p>
The following sample code, traces system and logs system calls
performed by an already running process. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/339b00fc8ab1b3d1d46ed9167ccbaeeb">https://gist.github.com/339b00fc8ab1b3d1d46ed9167ccbaeeb</a></li>
</ul>

<p>
File: <span class="underline">ptrace-attach.cpp</span> 
</p>

<ul class="org-ul">
<li>Note A: the function <span class="underline">ptrace_get_string()</span> reads a string buffer
(character array) from the tracee's process virtual memory. The
buffer is defined by memory address  the initial character and
the buffer size as number of bytes.</li>

<li>Note B: the function <span class="underline">ptrace_get_string_null</span> obtains a
null-terminated ('\0') character array from the tracee's process
virtual memory.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy, memset, ...</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">assert() statement </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">map</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix-specific headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/ptrace.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/reg.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/syscall.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/user.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">int</span> <span class="org-variable-name">FAILURE</span> = -1;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">WaitResult</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-variable-name">STOPPED</span>     = 0
    , <span class="org-variable-name">TERMINATED</span>  = 1
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Ptrace wrapper that terminates the current process there is any error. */</span>
<span class="org-type">long</span> <span class="org-function-name">_ptrace</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">request</span>, <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-type">void</span>* <span class="org-variable-name">addr</span>, <span class="org-type">void</span>* <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">WaitResult</span>     <span class="org-function-name">ptrace_wait_syscall</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::string      ptrace_get_string<span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-constant">std</span>::<span class="org-type">uintptr_t</span> <span class="org-variable-name">addr</span>, <span class="org-constant">std</span>::<span class="org-type">size_t</span> <span class="org-variable-name">size</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::string ptrace_get_string_null<span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-constant">std</span>::<span class="org-type">uintptr_t</span> <span class="org-variable-name">addr</span> <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage: $ %s  &lt;PID&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Next line: throws exception. </span>
    <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>  = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Attempt to attach to process. </span>
    _ptrace<span class="org-rainbow-delimiters-depth-2">(</span>PTRACE_ATTACH, pid, <span class="org-constant">nullptr</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Attached to process. Ok \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fix PTRACE sigrap problem. That happens after attaching to child </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">process with PTRACE_ATTACH and the child process receives a SIGTRAP signal.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">See: https://stackoverflow.com/questions/44630382</span>
    _ptrace<span class="org-rainbow-delimiters-depth-2">(</span> PTRACE_SETOPTIONS, pid, <span class="org-constant">nullptr</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-3">)</span> PTRACE_O_TRACECLONE<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Makes possible to distinguish system-call related stops from other</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">types of stops. </span>
    _ptrace<span class="org-rainbow-delimiters-depth-2">(</span> PTRACE_SETOPTIONS, pid, <span class="org-constant">nullptr</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-3">)</span> PTRACE_O_TRACESYSGOOD<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">CPU registers (context) of the monitored process </span>
    <span class="org-keyword">struct</span> <span class="org-type">user_regs_struct</span> <span class="org-variable-name">regs</span>; 

    <span class="org-comment-delimiter">/// </span><span class="org-comment">========== Ptrace event loop ==============//</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Start event loop. Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Intercept system call entry </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>  ptrace_wait_syscall<span class="org-rainbow-delimiters-depth-4">(</span>pid<span class="org-rainbow-delimiters-depth-4">)</span> == <span class="org-constant">WaitResult</span>::TERMINATED<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> 
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] (1) Monitored process has terminated. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Intercept system call exit </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ptrace_wait_syscall<span class="org-rainbow-delimiters-depth-4">(</span>pid<span class="org-rainbow-delimiters-depth-4">)</span> == <span class="org-constant">WaitResult</span>::TERMINATED<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>                  
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] (2) Monitored process has terminated. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">break</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Get  CPU register for the current process. </span>
        _ptrace<span class="org-rainbow-delimiters-depth-3">(</span> PTRACE_GETREGS, pid, <span class="org-constant">nullptr</span>, &amp;regs<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Get system call number</span>
        <span class="org-type">int</span> <span class="org-variable-name">syscall</span> = regs.orig_rax;

        <span class="org-comment-delimiter">// </span><span class="org-comment">System call =&gt; open() </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">int openat( int dirfd              // Register RDI (1st syscall arg.)</span>
        <span class="org-comment-delimiter">//           </span><span class="org-comment">, const char *pathname   // Register RSI (2nd syscall arg.) </span>
        <span class="org-comment-delimiter">//           </span><span class="org-comment">, int flags              // Register RSI (3rd syscall arg.)</span>
        <span class="org-comment-delimiter">//           </span><span class="org-comment">);</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>syscall == SYS_openat<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>   
            <span class="org-keyword">auto</span> <span class="org-variable-name">ptr</span>  = uintptr_t<span class="org-rainbow-delimiters-depth-4">{</span>regs.rsi<span class="org-rainbow-delimiters-depth-4">}</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">file</span> = ptrace_get_string_null<span class="org-rainbow-delimiters-depth-4">(</span>pid, regs.rsi<span class="org-rainbow-delimiters-depth-4">)</span>;  
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] openat() system call found =&gt; file = %s \n"</span>, file.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">continue</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt; Note: Linux system calls for x64 is the System V x86-64/ calling convention. </span>
        <span class="org-comment-delimiter">// </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">System call: write(   int fd        // register RDI (1st syscall argument)</span>
        <span class="org-comment-delimiter">//                     </span><span class="org-comment">, void* buffer  // register RSI (2nd syscall argument)</span>
        <span class="org-comment-delimiter">//                     </span><span class="org-comment">, size_t size   // register RDX (3rd syscall argument)</span>
        <span class="org-comment-delimiter">//                    </span><span class="org-comment">) </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>syscall == SYS_write<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>

            <span class="org-type">int</span>       <span class="org-variable-name">write_fd</span>   = regs.rdi; <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor of write system call </span>
            <span class="org-type">uintptr_t</span> <span class="org-variable-name">write_ptr</span>  = regs.rsi; <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer.             </span>
            <span class="org-type">size_t</span>    <span class="org-variable-name">write_size</span> = regs.rdx; <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer size.              </span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">buffer_text</span> = ptrace_get_string<span class="org-rainbow-delimiters-depth-4">(</span>pid, write_ptr, write_size<span class="org-rainbow-delimiters-depth-4">)</span>;  

            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span> stderr
                            , <span class="org-string">" [TRACE] Write system (syscall = %d ) "</span> 
                            <span class="org-string">" fd = %d ; buffer_ptr = 0x%x ; size = %zu ; \n =&gt; buffer_text = '%s' \n\n"</span>
                            , syscall
                            , write_fd, write_ptr, write_size, buffer_text.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;    

            <span class="org-keyword">continue</span>;        
        <span class="org-rainbow-delimiters-depth-3">}</span>   


    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">====== End of ptrace event loop ====// </span>

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ------- //</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">============================================== //</span>
        <span class="org-comment-delimiter">//       </span><span class="org-comment">I M P L E M E N T A T I O N S            //</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">------------------------------------------------//</span>

<span class="org-type">long</span> 
<span class="org-function-name">_ptrace</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">request</span>, <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-type">void</span>* <span class="org-variable-name">addr</span>, <span class="org-type">void</span>* <span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">long</span> <span class="org-variable-name">r</span> = ptrace<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">__ptrace_request</span><span class="org-rainbow-delimiters-depth-3">)</span> request, pid, addr, data<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>r == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
        ss  &lt;&lt; <span class="org-string">" [PTRACE FAILURE] "</span> 
            &lt;&lt; <span class="org-string">" ; errno = "</span> &lt;&lt; errno 
            &lt;&lt; <span class="org-string">" ; msg = '"</span> &lt;&lt; strerror<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span> 
            &lt;&lt; <span class="org-string">"' \n"</span>;        
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span>ss.str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> r;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">WaitResult</span> 
<span class="org-function-name">ptrace_wait_syscall</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">long</span> <span class="org-variable-name">result</span>;
    <span class="org-type">int</span>  <span class="org-variable-name">status</span>;

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">){</span>
        result = _ptrace<span class="org-rainbow-delimiters-depth-3">(</span>PTRACE_SYSCALL, pid, <span class="org-constant">nullptr</span>, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        waitpid<span class="org-rainbow-delimiters-depth-3">(</span>pid, &amp;status, 0<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">This predicate holds when the monitored process</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">has terminated.</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> WIFEXITED<span class="org-rainbow-delimiters-depth-4">(</span>status<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> <span class="org-constant">WaitResult</span>::TERMINATED; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Credits and further reading:  </span>
        <span class="org-comment-delimiter">//   </span><span class="org-comment">=&gt; https://ops.tips/gists/using-c-to-inspect-linux-syscalls</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> WIFSTOPPED<span class="org-rainbow-delimiters-depth-4">(</span>status<span class="org-rainbow-delimiters-depth-4">)</span> &amp;&amp; WSTOPSIG<span class="org-rainbow-delimiters-depth-4">(</span>status<span class="org-rainbow-delimiters-depth-4">)</span> &amp; 0x80 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> <span class="org-constant">WaitResult</span>::STOPPED; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string
ptrace_get_string<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-constant">std</span>::<span class="org-type">uintptr_t</span> <span class="org-variable-name">addr</span>, <span class="org-constant">std</span>::<span class="org-type">size_t</span> <span class="org-variable-name">size</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">long_size</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">long</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">union</span> <span class="org-type">ptrace_data</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">long</span> <span class="org-variable-name">data</span>;
        <span class="org-type">char</span> <span class="org-variable-name">bytes</span><span class="org-rainbow-delimiters-depth-3">[</span>long_size<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-type">int</span>   <span class="org-variable-name">n</span>      = 0;
    <span class="org-type">int</span>   <span class="org-variable-name">steps</span>  = size / <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">long</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span>  <span class="org-variable-name">pdata</span>  = ptrace_data<span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-keyword">auto</span>  <span class="org-variable-name">result</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>size + 1, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">char</span>* <span class="org-variable-name">paddr</span>  = &amp;result<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span>result.length<span class="org-rainbow-delimiters-depth-3">()</span> == size + 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>n &lt; steps<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        pdata.data = _ptrace<span class="org-rainbow-delimiters-depth-3">(</span> PTRACE_PEEKDATA, pid
                            , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>addr + n * long_size<span class="org-rainbow-delimiters-depth-4">)</span>
                            , <span class="org-constant">nullptr</span>
                            <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::memcpy<span class="org-rainbow-delimiters-depth-3">(</span>paddr, pdata.bytes, long_size<span class="org-rainbow-delimiters-depth-3">)</span>;
        n++;
        paddr = paddr + long_size;

    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">'%' integer remainder </span>
    steps = size % long_size;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> steps != 0 <span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        pdata.data = _ptrace<span class="org-rainbow-delimiters-depth-3">(</span> PTRACE_PEEKDATA, pid
                            , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>addr + n * long_size<span class="org-rainbow-delimiters-depth-4">)</span>
                            , <span class="org-constant">nullptr</span>
                            <span class="org-rainbow-delimiters-depth-3">)</span>;
        memcpy<span class="org-rainbow-delimiters-depth-3">(</span>paddr, pdata.bytes, steps<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    result<span class="org-rainbow-delimiters-depth-2">[</span>size<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-string">'\0'</span>;

    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string
ptrace_get_string_null<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-constant">std</span>::<span class="org-type">uintptr_t</span> <span class="org-variable-name">addr</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">long_size</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">long</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">union</span> <span class="org-type">ptrace_data</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">long</span> <span class="org-variable-name">data</span>;
        <span class="org-type">char</span> <span class="org-variable-name">bytes</span><span class="org-rainbow-delimiters-depth-3">[</span>long_size<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-type">int</span>   <span class="org-variable-name">nread</span>  = 0;
    <span class="org-keyword">auto</span>  <span class="org-variable-name">pdata</span>  = ptrace_data<span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-keyword">auto</span>  <span class="org-variable-name">result</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-constant">std</span>::memset<span class="org-rainbow-delimiters-depth-2">(</span>&amp;pdata.bytes<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, 0x00, <span class="org-type">long_size</span> * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        pdata.data = _ptrace<span class="org-rainbow-delimiters-depth-3">(</span> PTRACE_PEEKDATA
                            , pid
                            , <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">void</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>addr + nread<span class="org-rainbow-delimiters-depth-4">)</span>
                            , <span class="org-constant">nullptr</span>
                            <span class="org-rainbow-delimiters-depth-3">)</span>;                

        result.resize<span class="org-rainbow-delimiters-depth-3">(</span>result.size<span class="org-rainbow-delimiters-depth-4">()</span> + long_size + 1<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-type">char</span>* <span class="org-variable-name">pinit</span> = &amp;result<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>;
        memcpy<span class="org-rainbow-delimiters-depth-3">(</span>pinit + nread, &amp;pdata.data, 1 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">long</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        nread += long_size;

        <span class="org-comment-delimiter">//  </span><span class="org-comment">If the null terminating character '\0' (0x00) is found</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">, then exit the current loop.</span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0; i &lt; long_size; i++<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> pdata.bytes<span class="org-rainbow-delimiters-depth-4">[</span>i<span class="org-rainbow-delimiters-depth-4">]</span> == <span class="org-string">'\0'</span> <span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">goto</span> <span class="org-constant">exit_loop</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span> 

<span class="org-function-name">exit_loop</span>:
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/339b00fc8ab1b3d1d46ed9167ccbaeeb gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ g++ ptrace-attach.cpp -o <span class="org-keyword">ptrace-attach.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
(TERMINAL EMULATOR 1) =&gt; Run python3 interactive interpreter on
terminal emulator 1, the run the <span class="underline">patrace-attach.bin</span> applicaton on
terminal 2 and attach to the PID of Python interpreter. After the
ptrace monitor application is attached to the current process, the
ptrace monitor application will log <span class="underline">open()</span> and <span class="underline">write()</span> system calls
performed by the python process.
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; python
Python 3.8.5 (default, Aug 12 2020, 00:00:00) 
[GCC 10.2.1 20200723 (Red Hat 10.2.1-1)] on linux
Type <span class="org-string">"help"</span>, <span class="org-string">"copyright"</span>, <span class="org-string">"credits"</span> or <span class="org-string">"license"</span> for more information.

&gt;&gt;&gt; import os
&gt;&gt;&gt; os.getpid() <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt;&gt; Get Process ID unique identifier and attach to it from other terminal</span>
2073259

&gt;&gt;&gt; print(<span class="org-string">"Hello world Ptrace"</span>)
Hello world Ptrace

&gt;&gt;&gt; import dbus

&gt;&gt;&gt; fd = open(<span class="org-string">"/tmp/logging.txt"</span>, <span class="org-string">"w"</span>)
&gt;&gt;&gt; 

&gt;&gt;&gt; fd = open(<span class="org-string">"/tmp/logging.txt"</span>, <span class="org-string">"w"</span>)
&gt;&gt;&gt; fd.write(<span class="org-string">"Hello world Python logging"</span>); fd.flush()
26
&gt;&gt;&gt; 

</pre>
</div>

<p>
(TERMINAL EMULATOR 2) =&gt; Run <span class="underline">ptrace-attach.bin</span> on terminal emulator 2
and attach to the Python interpreter process.
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./ptrace-attach.bin 2073259
 [TRACE] Attached to process. Ok 
 [TRACE] Start event loop. Ok. 

 [TRACE] Write system (syscall = 1 )  fd = 1 ; buffer_ptr = 0xf75f7010 ; size = 1 ; 
 =&gt; buffer_text = <span class="org-string">'</span>
<span class="org-string">'</span> 

 [TRACE] Write system (syscall = 1 )  fd = 1 ; buffer_ptr = 0xf751a6d0 ; size = 19 ; 
 =&gt; buffer_text = <span class="org-string">'Hello world Ptrace</span>
<span class="org-string">'</span> 

 [TRACE] Write system (syscall = 1 )  fd = 1 ; buffer_ptr = 0xf75f7010 ; size = 4 ; 
 =&gt; buffer_text = <span class="org-string">'&gt;&gt;&gt; '</span> 

  ... ... .. ...   ... ... .. ...   ... ... .. ... 
  ... ... .. ...   ... ... .. ...   ... ... .. ... 

 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/dbus/__pycache__/__init__.cpython-38.pyc 
 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/dbus 
 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/dbus/__pycache__/_compat.cpython-38.pyc 
 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/dbus/__pycache__/exceptions.cpython-38.pyc 
 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/dbus/__pycache__/types.cpython-38.pyc 
 [TRACE] openat() system call found =&gt; file = /usr/lib64/python3.8/site-packages/_dbus_bindings.so 
 [TRACE] openat() system call found =&gt; file = /home/mxpkf8/dlang/dmd-2.092.0/linux/lib64/libdbus-1.so.3 
 [TRACE] openat() system call found =&gt; file = /etc/ld.so.cache 
 [TRACE] openat() system call found =&gt; file = /lib64/libdbus-1.so.3 
 [TRACE] openat() system call found =&gt; file = /home/mxpkf8/dlang/dmd-2.092.0/linux/lib64/libsystemd.so.0 
 [TRACE] openat() system call found =&gt; file = /lib64/libsystemd.so.0 
 [TRACE] openat() system call found =&gt; file = /home/mxpkf8/dlang/dmd-2.092.0/linux/lib64/librt.so.1 
 [TRACE] openat() system call found =&gt; file = /lib64/librt.so.1 
 [TRACE] openat() system call found =&gt; file = /home/mxpkf8/dlang/dmd-2.092.0/linux/lib64/liblzma.so.5 
 [TRACE] openat() system call found =&gt; file = /lib64/liblzma.so.5 
   ....    ....    ....    ....    .... 
   ....    ....    ....    ....    ....    .... 

 [TRACE] openat() system call found =&gt; file = /tmp/logging.txt 
 [TRACE] Write system (syscall = 1 )  fd = 1 ; buffer_ptr = 0xf75f7010 ; size = 4 ; 
 =&gt; buffer_text = <span class="org-string">'&gt;&gt;&gt; '</span> 

  ... ... ... ... ... ... ... ... ... ... 
  ... ... ... .. ... ... ... ... .. ... .. . .. . . 

 [TRACE] Write system (syscall = 1 )  fd = 3 ; buffer_ptr = 0xf7643390 ; size = 26 ; 
 =&gt; buffer_text = <span class="org-string">'Hello world Python logging'</span> 

 [TRACE] Write system (syscall = 1 )  fd = 1 ; buffer_ptr = 0xf75f7010 ; size = 4 ; 
 =&gt; buffer_text = <span class="org-string">'&gt;&gt;&gt; '</span> 

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb2afd46" class="outline-3">
<h3 id="orgb2afd46"><span class="section-number-3">1.31</span> X11 - X Windows System</h3>
<div class="outline-text-3" id="text-1-31">
</div>
<div id="outline-container-org49a82e5" class="outline-4">
<h4 id="org49a82e5"><span class="section-number-4">1.31.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-31-1">
<p>
Most Unix-like operating systems, including Linux and BSD variants,
except Apple's MacOSX, use X-Windows System, also called <b>X11</b>, which
is a <span class="underline">network-transparent</span> window system developed at project Athena
(MIT) in 1984 and nowadays it is led by the <a href="https://www.x.org/wiki/">X.Org</a> foundation. 
</p>

<p>
The <span class="underline">server</span> or <span class="underline">display server</span> (XServer) draws windows and widgets on
the human operator display and receives input events from mouse and
keyboard on behalf of one or more local or remote client applications
(XClients). This architecture enables <span class="underline">network transparency</span>, which is
the ability to operate either locally or over network. In practical
terms, network transparency makes possible to interact with windows
from graphics applications (x11 clients) running on remote servers as
they were local applications and local windows. A X11 client
appplication communicates with the XServer by using the X Windows
System (X11) network protocol via unix socket if the client
application is running on the user machine or via TCP/IP sockets if
the client application is running on a remote server.
</p>

<p>
<b>Main parts:</b>
</p>

<ul class="org-ul">
<li><span class="underline">X Server</span> (Server-side, located at user's machine, draws on user's Monitor/Screen)
<ul class="org-ul">
<li>=&gt; Runs on the user (human operator) machine, draws windows and
widgets for connected applications <span class="underline">x-clients</span> running on local or
remote machines.</li>
</ul></li>

<li><span class="underline">X Client</span> =&gt; Application running on user machine or remote server.
<ul class="org-ul">
<li>=&gt; Initiates the connection and makes network requests to the
server, which draws the application's widgets.</li>
</ul></li>

<li><span class="underline">X11 - Network Protocol</span>
<ul class="org-ul">
<li>=&gt; Techinical specification or <span class="underline">technical</span> <span class="underline">standard</span> about how
x-server and x-clients should communicate.</li>
</ul></li>
</ul>

<p>
The X-Client (local or remote application) can communicate with the
X-Server by using:
</p>

<ul class="org-ul">
<li>Direct X11 protocol network requests via TCP/IP socket or
Unix-sockets, in case of applications running on the local
machine.</li>

<li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">XLib</a> C Library =&gt; Encapsulates the X11 network protocol.</li>

<li><a href="https://xcb.freedesktop.org/">XCb</a> C Library =&gt; (Lower level than XLib) Similar to XLib, but has
a smaller footprint and lower latency, better suport for thread.</li>
</ul>

<p>
<b>Notes and considerations:</b>
</p>

<ul class="org-ul">
<li>Unlike on Windows and Mac-OSX, the graphics interface is not part
of neither Linux kernel nor BSD-variants' kernels. The ability to
run headless, without any graphics, makes Linux-based operating
systems suitable for network server and embedded systems where a
built-in GUI could cause higher overhead and system footprint.</li>

<li>X11 protocol does not specify styling, widgets (menu, buttons and
so on). Those features are provided by <a href="https://en.wikipedia.org/wiki/Comparison_of_X_window_managers">window managers</a> and GUI
Graphical User Interface toolkits such as, <a href="https://en.wikipedia.org/wiki/GTK">GTK</a>,  <a href="https://en.wikipedia.org/wiki/Qt_(software)">Qt</a>, <a href="https://en.wikipedia.org/wiki/Motif_(software)">Motif</a>, <a href="https://en.wikipedia.org/wiki/FLTK">FLTK</a>, 
and <a href="https://en.wikipedia.org/wiki/Swing_(Java)">Java Swing</a> (Java Only).</li>

<li>X11 is not widely used on Embedded Linux systems as it is on Linux
desktop systems. Instead many embedded linux operate directly on
top of <a href="https://developer.toradex.com/knowledge-base/framebuffer-linux">Framebuffer</a>. The following approaches can be used for
creating graphical user interfaces on top of framebuffer: in-house
libraries, EGL (Embedded OpenGL), SDL or <a href="https://doc.qt.io/qt-5/embedded-linux.html">Qt toolkit</a> on top of
frambebuffer.</li>

<li>Although <span class="underline">Android</span> operating system is based on Linux kernel, unlike
the desktop GNU/Linux distribution counterparts, Android user
interface is built directly on top of framebuffer.</li>

<li>It is not worth developing any application on top of the X-Windows
System Protocol as it is low level, lacks widget abstractions and
may eventually be replaced by <a href="https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)">Wayland</a> on major Linux
distributions. A better approach is to use higher level libraries
such as Qt Widgets, Qt/Quick QML, KDE Libraries (Qt variants),
Gtk, Gnome (Gtk variants) or Java Swing as any application built
on top of those libraries will be able to work in any operating
system using <span class="underline">Wayland</span>.</li>

<li>Despite being network transparent, X11 protocol is unsafe for
usage over the network dut to the protocol be unencrypted which
makes it vulnerable to MITM, snooping, spoofing and so on. A
workaround for safer usage over the network is to use X11 via SSH
forwarding.</li>
</ul>

<p>
<b>See also:</b> 
</p>

<p>
X11 X Windows System 
</p>

<ul class="org-ul">
<li><a href="http://xwindow.angelfire.com/">X Window System Internals</a></li>

<li><a href="https://docstore.mik.ua/orelly/unix3/upt/ch35_08.htm">The DISPLAY Environment Variable (Unix Power Tools, 3rd Edition)</a></li>

<li><a href="https://askubuntu.com/questions/432255/what-is-the-display-environment-variable">xorg - What is the $DISPLAY environment variable? - Ask Ubuntu</a></li>

<li><a href="https://ajaxnwnk.blogspot.com/2020/10/on-abandoning-x-server.html">deleted code is tested code: on abandoning the X server</a></li>

<li><a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=XServer-Abandonware">It's Time To Admit It: The X.Org Server Is Abandonware - Phoronix</a></li>
</ul>

<p>
Wayland (Future Replacemente for X11)
</p>

<ul class="org-ul">
<li><a href="https://wayland-book.com/introduction.html">Introduction - The Wayland Protocol</a></li>

<li><a href="https://wayland.freedesktop.org/">Wayland</a> - Freedesktop Foundation</li>

<li><a href="https://wayland.freedesktop.org/xserver.html">XWayland</a> - Freedesktop Foundation  - Backward Compatibility layer for X11.</li>

<li><a href="https://github.com/varmd/wine-wayland">GitHub - varmd/wine-wayland</a> - Wine-wayland allows playing
DX9/DX11 and Vulkan games using pure wayland and Wine/DXVK.</li>
</ul>

<p>
X11 client alternative Implementations: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/python-xlib/python-xlib">python-xlib</a> (Python) - Alternative implentation for X11 client in pure Python.</li>

<li><a href="https://github.com/BurntSushi/xgb">xgb</a> (Go, Golang) - Alternative implementation for X11 client in
pure GO, aka Golang language.</li>
</ul>
</div>
</div>

<div id="outline-container-org0d5c703" class="outline-4">
<h4 id="org0d5c703"><span class="section-number-4">1.31.2</span> X11 Utilities</h4>
<div class="outline-text-4" id="text-1-31-2">
<p>
The following X11 utilities are widely used on many Linux
distributions for a wide variety of purposes, including configuration,
window manipulation, debugging and desktop automation. 
</p>

<p>
Authentication and authorization: 
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/Xinit">xinit</a> - Program that allows starting Xorg (X Server) manually from
command line.</li>

<li><a href="https://linux.die.net/man/1/xauth">xauth</a> - Display X server authorization information.</li>

<li><a href="https://wiki.archlinux.org/index.php/Xhost">xhost</a> - Arch wiki: "The xhost program is used to add and delete
host names or user names to the list allowed to make connections
to the X server. In the case of hosts, this provides a rudimentary
form of privacy control and security. It is only sufficient for a
workstation (single user) environment, although it does limit the
worst abuses. Environments which require more sophisticated
measures should implement the user-based mechanism or use the
hooks in the protocol for passing other authentication data to the
server."</li>
</ul>

<p>
Monitor Configuration: 
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/xrandr">xrandr</a> - utility for configuring screen/monitor orientation,
resolution, dual monitor and so on. By default, it shows the
current displays resolutions.</li>

<li><a href="http://xcalib.sourceforge.net/">xcalib</a> - Allows inverting monitor/screen color. Useful for
avoiding eye strain due to long hours starring on screens.
<ul class="org-ul">
<li>Usage: $ xcalib -i -a</li>
</ul></li>

<li><a href="https://github.com/zoltanp/xrandr-invert-colors">xrandr-invert-colors</a> - Similar to <span class="underline">xcalib</span>, but works with multiple
screens. Note: it is not available on most Linux distributions,
thus this utility must be installed from source.</li>
</ul>


<p>
Window manipulation and Desktop Automation: 
</p>

<ul class="org-ul">
<li><a href="https://www.semicomplete.com/projects/xdotool/">xdotool</a> - Utility application for manipulating and automating x11
windows, similar to Microsft Windows' <a href="https://www.autohotkey.com/">Autohotkey</a> tool for desktop
automation.</li>

<li><a href="http://tripie.sweb.cz/utils/wmctrl/">wmctrl</a> - A command line tool to interact with an EWMH/NetWM
compatible X Window Manager.</li>

<li><a href="https://github.com/ReimuNotMoe/ydotool">ydotool</a> - Similar to xdotool, but for Wayland.</li>

<li><a href="https://github.com/astrand/xclip">xclip</a> - Copy and paste from/to terminal to clipboard.</li>

<li><a href="https://wiki.archlinux.org/index.php/Xpra">Xpra</a> - "Xpra is 'GNU Screen for X': it allows you to run X
programs, usually on a remote host, direct their display to your
local machine, and then to disconnect from these programs and
reconnect from the same or another machine, without losing any
state. It gives you remote access to individual applications."</li>
</ul>

<p>
General Utilities: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Xterm">xterm</a> - Reference implementation for X11 terminal emulators.</li>

<li><a href="https://en.wikipedia.org/wiki/Xkill">xkill</a> - command line application that allows forcefully
terminating any graphical program by calling $ xkill from command
line and clicking at the window whose process will be terminated.</li>

<li><a href="https://linux.die.net/man/1/cxdg-open">xdg-open</a> - Open file or directory from command line with default
system application. For instance, $ xdg-open file.xls, where
file.xls is a Excel spreadsheet, opens the file with Libreoffice,
if this application is available in the sytem.</li>

<li><a href="https://linux.die.net/man/1/xclip">xclip</a> - Allows copying stdin contents to clipboard and pasting
contents from clibpboard to stdout.</li>
</ul>


<p>
X11 Preference and configuration: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/1/xset">xset</a> - X-Server user preference and display power management.
<ul class="org-ul">
<li>Disable display power management and stop screen from  blanking:
<ul class="org-ul">
<li>$ xset dpms 0 0 0 &amp;&amp; xset s noblank  &amp;&amp; xset s off</li>
</ul></li>
</ul></li>

<li><a href="https://linux.die.net/man/1/xmodmap">xmodmap</a> - Modify keymaps and pointer buttons mapping in X Windows System X11.</li>

<li><a href="https://linux.die.net/man/1/setxkbmap">setxkbmap</a> - Modify Keyboard - allows changing the keyboard to
English, Portuguese, Greek, Cyrillic and so on.</li>

<li><a href="https://linux.die.net/man/1/xinput">xinput</a> - Configure and test X input devices such as keyboard,
mouse, touchpad and etc.</li>

<li><a href="https://www.x.org/releases/X11R7.7/doc/man/man1/xev.1.xhtml">xev</a> (X event monitor) "Xev creates a window and then asks the X server to send it
events whenever anything happens to the window (such as it being
moved, resized, typed in, clicked in, etc.). You can also attach
it to an existing window. It is useful for seeing what causes
events to occur and to display the information that they contain;
it is essentially a debugging and development tool, and should not
be needed in normal usage."
<ul class="org-ul">
<li>Source code: <a href="https://gitlab.freedesktop.org/xorg/app/xev">https://gitlab.freedesktop.org/xorg/app/xev</a></li>
<li>See also:
<ul class="org-ul">
<li><a href="http://www.rahul.net/kenton/events.html">X Application Software Engineering: Debugging X Input Events</a></li>
</ul></li>
</ul></li>

<li><a href="https://linux.die.net/man/1/xwininfo">xwinfo</a> - Utility for getting display information about windows. It
provides a cursor that shows information about any window that
user clicks at.</li>

<li><a href="https://linux.die.net/man/1/xsetroot">xsetroot</a> - Root window parametter settings.</li>

<li><a href="https://linux.die.net/man/1/xprop">xprop</a> - Similar to xwinfo, but displays font property.</li>

<li><a href="https://linux.die.net/man/1/xvinfo">xvinfo</a> - Display capabilities of video adapters.</li>

<li><a href="https://linux.die.net/man/1/xdriinfo">xdriinfo</a> - Get confituration of DRI (direct rendering interface)
device drivers.</li>
</ul>

<p>
X11 protocol message tracing/monitor tools (Note: most non-standard
tools, non commonly available in most distros.)
</p>

<ul class="org-ul">
<li><a href="https://gitlab.freedesktop.org/xorg/app/xscope">xscope</a> - "XSCOPE is a program to monitor the connections between
the X11 window server and a client program.  xscope runs as a
separate process.  By adjusting the host and/or display number
that a X11 client attaches to, the client is attached to xscope
instead of X11.  xscope attaches to X11 as if it were the client.
All bytes from the client are sent to xscope which passes them on
to X11; All bytes from X11 are sent to xscope which sends them on
to the client.  xscope is transparent to the client and X11.".</li>
</ul>


<ul class="org-ul">
<li><a href="https://x11vis.org/">x11vis</a> - "x11vis aims to be a useful tool for debugging X11
clients. Its main focus is on being as visual and interactive as
possible. Replacing X11 atom, window, font or pixmap IDs with
human readable names is the most basic functionality. Contrary to
other tools like xtrace, x11vis will display human readable IDs on
all requests, no matter at which point in time the information
gets available. To help you cope with lots of data, x11vis
displays only the most important information by default,
automatically folds sequences of boring requests, allows you to
filter by packet type or client and provides so-called markers
between you can navigate. Also, instead of just assigning a number
to each connection, x11vis displays the command line with which
that client was started. To learn more, please see the manual.".</li>

<li><a href="https://sourceforge.net/projects/xmon/">xmon</a> - "A monitor for the X Window System core protocol. Xmon
monitors the messages sent between an X11 server and a number of
X11 clients and displays the contents of the messages in an
interactively selectable level of detail."</li>

<li><a href="https://www.chiark.greenend.org.uk/~sgtatham/xtruss/">xtruss</a> - Tool for tracing/monitoring X11 network protocol.</li>

<li><a href="https://www.wireshark.org/">Wireshark</a> - Tool that allows debugging and tracing any network
protocol and also allows inspecting USB protocol. (Note:
scriptable in Lua programming language.)</li>
</ul>

<p>
Animation: 
</p>

<ul class="org-ul">
<li><a href="https://www.x.org/archive/X11R6.8.1/doc/xclock.1.html">xclock</a> - Clock animation.</li>

<li><a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xeyes.1.html">xeyes</a> - Eye animation that follows the mouse pointer.</li>

<li><a href="https://linux.die.net/man/1/xlogo">xlogo</a> - X windows System "X" logo picture.</li>
</ul>
</div>
</div>

<div id="outline-container-org8a7b935" class="outline-4">
<h4 id="org8a7b935"><span class="section-number-4">1.31.3</span> Setting  keyboard mode via setxkbmap</h4>
<div class="outline-text-4" id="text-1-31-3">
<p>
There many cases where there is the need for changing the keyboard
settings, such as testing a Live-CD linux distribution, that oftens
uses the American keyboard settings by default, even though the
keyboard model is non-English; type in languages that does not uses
the lantin script or practice foreign languages that uses a different
type of keyboard configuration. The command line tool setxkbmap is
useful for setting the keyboard language mode in X11 X Windows System
environment. 
</p>

<p>
Note: The setxkmap does not work on Wayland environment. This tool
only works on X11 (X Windows System).
</p>

<p>
Some commands for changing keyboard layout: 
</p>

<ul class="org-ul">
<li>Swap Ctrl and Capslock (Friendly to Emacs users):
<ul class="org-ul">
<li><i>$ setxkbmap -option ctrl:swapcaps</i></li>
</ul></li>

<li>Swap ESC (Escape) and Capslock (Friendly to Vi Users):
<ul class="org-ul">
<li>$ <i>setxkbmap -option caps:swapescape</i></li>
</ul></li>

<li>APL Keyboard Layout (for APL Programming Language)
<ul class="org-ul">
<li>$ <i>setxkbmap apl</i></li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/British_and_American_keyboards">American</a> English keyboard layout:
<ul class="org-ul">
<li><i>$ setxkbmap us</i></li>
</ul></li>

<li>American English keyboard layout with dvorak keyboard:
<ul class="org-ul">
<li><i>$ setxkbmap us -variant dvorak</i></li>
</ul></li>

<li>American and Greek keyboard layouts. (use-case: typing math formulas)
<ul class="org-ul">
<li><i>$ setxkbmap -layout us,gr -option grp:alt_shift_toggle</i></li>
<li>Type Shift + Alt for toggling the layout to Greek keyboard layout. This
configuration is useful for typing math formulas.</li>
</ul></li>

<li>American and Greek keyboard layout. (use-case: typing math formulas)
<ul class="org-ul">
<li><i>$ setxkbmap -layout us,gr -option grp:win_switch</i></li>
<li>Hold Windows-key and the corresponding key to type in Greek. For
instance, by holding Windows-Key and typing A, the letter alpha
(α) is typed instead of (a). If the same steps is applied to the
letter (b), the letter beta (β) is typed. Finally, release the
Windows key for switching back to American keyboard layout.</li>
</ul></li>

<li>American English and APL keyboard Layout (use-case: type APL symbols)
<ul class="org-ul">
<li><i>$ setxkbmap -layout us,apl -option grp:win_switch</i></li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/AZERTY">French</a> language keyboard layout:
<ul class="org-ul">
<li><i>$ setxkbmap fr</i></li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/German_keyboard_layout">German</a> language keyboard layout. 
<ul class="org-ul">
<li><i>$ setxkbmap de</i></li>
<li>Note: German umlaut letters (ö, ä, ü, ß) are hard to type without this layout.)</li>
</ul></li>

<li><a href="https://help.keyman.com/keyboard/grkpoly2/2.0.1/grkpoly2">Greek</a> language keyboard layout: (α, β, η, κ, λ, ς, ε, σ, Σ)
<ul class="org-ul">
<li><i>$ setxkbmap gr</i></li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/APL_(programming_language)#/media/File:APL-keybd2.svg">APL</a> keyboard Layout (For APL programming language)
<ul class="org-ul">
<li><i>$ setxkbmap apl</i></li>
<li>APL symbols, such as ⍺, ⌈, ⌊, ⊂, ⊃, ∩, ⊥, ⊤, ○,≠,∇ ,are hard to
type without this layout.</li>
</ul></li>

<li>Polish languag keyboard layout
<ul class="org-ul">
<li>$ setxkbmap pl</li>
</ul></li>

<li><a href="http://kbdlayout.info/KBDBU/">Bulgarian</a> language keyboard layout (Cyrillic Script):
<ul class="org-ul">
<li>$ setxkbmap bg</li>
</ul></li>

<li><a href="https://commons.wikimedia.org/wiki/Category:Ukrainian_keyboard_layouts">Ukranian</a> language keyboard layout (Cyrillic Script):
<ul class="org-ul">
<li><i>$ setxkmap ua</i></li>
</ul></li>

<li><a href="https://commons.wikimedia.org/wiki/File:KB_Russian.svg">Russian</a> language keyboard layout (Cyrillic Script):
<ul class="org-ul">
<li><i>$ setxkmap ru</i></li>
</ul></li>

<li><a href="https://en.wikipedia.org/wiki/Hebrew_keyboard">Hebrew</a> language keyboard layout:
<ul class="org-ul">
<li><i>$ setxkbmap il</i></li>
</ul></li>

<li>Turkish Language keyboard layout:
<ul class="org-ul">
<li>$ <i>setxkbmap tr</i></li>
</ul></li>

<li><a href="https://commons.wikimedia.org/wiki/File:KB_Spanish.svg">Spanish</a> language - Latin America keyboard layout:
<ul class="org-ul">
<li><i>$ setxkbmap latam</i></li>
<li>Makes easier to type Spanish grammar symbols (?, ¿, ¡)</li>
</ul></li>

<li>Portuguese language ABNT2: 
<ul class="org-ul">
<li><i>$ setxkbmap -model abnt2 -layout br -variant abnt2</i></li>
</ul></li>

<li>Portuguese language ABNT2 and APL, switching layout is similar to American keyboard.
<ul class="org-ul">
<li><i>$ setxkbmap -model abnt2 -layout br,apl -variant abnt2 -option grp:win_switch</i></li>
</ul></li>

<li>Portuguese language ABNT2 and Greek (For typing math formulas)
<ul class="org-ul">
<li><i>$ setxkbmap -model abnt2 -layout br,gr -variant abnt2 -option grp:win_switch</i></li>
</ul></li>
</ul>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/jatcwang/ae3b7019f219b8cdc6798329108c9aee">List of all setxkbmap configuration options (including models/layout/etc) · GitHub</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3e27a1" class="outline-4">
<h4 id="orgf3e27a1"><span class="section-number-4">1.31.4</span> Sample X11 Window via Xlib</h4>
<div class="outline-text-4" id="text-1-31-4">
<p>
This sample Xlib applications draw a window with a rectangle and a
string. Note: Xlib lacks widgets. 
</p>

<p>
Code available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/f7f0b892011ad987bfed531336dbae89">https://gist.github.com/f7f0b892011ad987bfed531336dbae89</a></li>
</ul>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">find_package</span>(X11 REQUIRED)

<span class="org-comment">#========== Targets Configurations ============#</span>

       <span class="org-function-name">add_executable</span>( xlib-demo xlib-demo.cpp )
<span class="org-function-name">target_link_libraries</span>( xlib-demo ${<span class="org-variable-name">X11_LIBRARIES</span>} )

<span class="org-comment"># add_executable(app2 application2.cpp)</span>
</pre>
</div>

<p>
File: <span class="underline">xlib-demo.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">X11/Xlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdlib</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">abort_on_failure</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span> <span class="org-variable-name">predicate</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Abort runtime."</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>predicate<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [ABORT] %s"</span>, message<span class="org-rainbow-delimiters-depth-2">)</span>;
    abort<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">/** </span><span class="org-comment">If the value passed to XOpenDisplay is null, the XClient (Xlib) attempts </span>
<span class="org-comment">     * to connect to the display server designated by the environment variable  </span>
<span class="org-comment">     * $DISPLAY, which is often set to the :1.0 or the local machine. </span>
<span class="org-comment">     *------------------------------------------------------------------------*/</span>
    <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span> = XOpenDisplay<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    abort_on_failure<span class="org-rainbow-delimiters-depth-2">(</span>dpy != <span class="org-constant">nullptr</span>, <span class="org-string">"Cannot open display."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">----- Query Information about display server ------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">version</span> = XProtocolVersion<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 protocol version = "</span> &lt;&lt; version &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">vendor</span> = XServerVendor<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 XServer vendor = "</span> &lt;&lt; vendor &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">disp_str</span> = XDisplayString<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 Display string = "</span> &lt;&lt; disp_str &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-type">int</span> <span class="org-variable-name">n_screen</span> = XScreenCount<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Number of screens = "</span> &lt;&lt; n_screen &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">----- Draw Screen ------------------------------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">screen</span> = DefaultScreen<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">Window</span> <span class="org-variable-name">wnd</span> = XCreateSimpleWindow<span class="org-rainbow-delimiters-depth-2">(</span>
                     dpy                         <span class="org-comment-delimiter">// </span><span class="org-comment">Display </span>
                   , RootWindow<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Parent Window </span>
                   , 10, 20                      <span class="org-comment-delimiter">// </span><span class="org-comment">Position (x - horizontal, y - vertical) from top-left corner </span>
                   , 400, 500                    <span class="org-comment-delimiter">// </span><span class="org-comment">Dimensions (width, height)</span>
                   , 1                           <span class="org-comment-delimiter">// </span><span class="org-comment">Border width </span>
                   , BlackPixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Border </span>
                   , WhitePixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Background color </span>
                   <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Casting void means that the return value (type int) is being ignored. */</span>
    <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">)</span> XStoreName<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, <span class="org-string">"X Windows-System X11"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Makes window visible </span>
    XMapWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;
    XFlush<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">XEvent</span> <span class="org-variable-name">event</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Select events that the application is interested in. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Only those events will notify the application. (XClient)</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">mask</span>  =   ExposureMask        
                | ButtonPressMask     <span class="org-comment-delimiter">// </span><span class="org-comment">Event: mouse button press</span>
                | KeyPressMask        <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key press (keyboard)</span>
                | KeyReleaseMask      <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key release (keyboard)</span>
                <span class="org-comment-delimiter">//</span><span class="org-comment">| PointerMotionMask   // Event: Mouse Move</span>
                ;
    XSelectInput<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, mask<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Process window close event in X11 event loop for(;;)</span>
    <span class="org-type">Atom</span> <span class="org-variable-name">wnd_del</span> = XInternAtom<span class="org-rainbow-delimiters-depth-2">(</span>dpy, <span class="org-string">"WM_DELETE_WINDOW"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    XSetWMProtocols<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, &amp;wnd_del, 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Draw some string on X11 - X windows system."</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">------- X11 (X Windows System) - Event loop ------------ */</span>

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"\n [TRACE] Waiting event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;;

         <span class="org-comment-delimiter">// </span><span class="org-comment">Get next X11 event      </span>
         XNextEvent<span class="org-rainbow-delimiters-depth-3">(</span>dpy, &amp;event<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ClientMessage<span class="org-rainbow-delimiters-depth-3">){</span>
                 fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [Event] User closed window. =&gt; Shutdown \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == Expose<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Expose event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == KeyPress<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Key pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ButtonPress<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == PointerMotionMask<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;     

         <span class="org-comment-delimiter">// </span><span class="org-comment">X11 Graphics context, useful for drawing </span>
         <span class="org-type">GC</span> <span class="org-variable-name">gctx</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;

         XFillRectangle<span class="org-rainbow-delimiters-depth-3">(</span> dpy, wnd, gctx
                        , 20, 50    <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) position from top-left corner origin </span>
                        , 100, 200  <span class="org-comment-delimiter">// </span><span class="org-comment">width and height </span>
                        <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">GC</span> <span class="org-variable-name">gctx2</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;                    

         XDrawString<span class="org-rainbow-delimiters-depth-3">(</span>  dpy     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to display object </span>
                      , wnd     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to window </span>
                      , gctx    <span class="org-comment-delimiter">// </span><span class="org-comment">Graphics context </span>
                      , 90, 300 <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) Position where string will be drawn (from top-left corner)</span>
                      , message
                      , strlen<span class="org-rainbow-delimiters-depth-4">(</span>message<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">----- End of event loop -------- // </span>

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] User closed window. Shutdown application. Ok \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    XDestroyWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close display </span>
    XCloseDisplay<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ git clone https://gist.github.com/f7f0b892011ad987bfed531336dbae89 temp &amp;&amp; <span class="org-builtin">cd</span> temp 
 $ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug -G Ninja
 $ cmake --build _build --target 
[2/2] Linking CXX executable xlib-demo
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; _build/xlib-demo 
[INFO] X11 protocol version = 11
[INFO] X11 XServer vendor = Fedora Project
[INFO] X11 Display string = :1.0
[INFO] Number of screens = 1

[TRACE] Waiting event. 
[Event] Expose event. 

[TRACE] Waiting event. 

[TRACE] Waiting event. 
[Event] Mouse button pressed. 
... ...     ... ...     ... ...     ... ...    
... ...     ... ...     ... ...    
</pre>
</div>

<p>
User Interface Screenshot: 
</p>


<div class="figure">
<p><a href="images/x11-gui-sample1.png"><img src="images/x11-gui-sample1.png" alt="x11-gui-sample1.png" /></a>
</p>
<p><span class="figure-number">Figure 4: </span>Xlib GUI User Interface.</p>
</div>
</div>
</div>
<div id="outline-container-orge29ac61" class="outline-4">
<h4 id="orge29ac61"><span class="section-number-4">1.31.5</span> Query X11 information via Xlib</h4>
<div class="outline-text-4" id="text-1-31-5">
<p>
The following sample application uses Xlib for querying X11 windows,
window information and terminating the Window process. 
</p>

<p>
Documentation of relevant functions and further reading: 
</p>

<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">Xlib - C Language X Interface</a></li>

<li><a href="https://www.remlab.net/op/xlib.shtml">Remlab: I hate Xlib and so should you</a></li>

<li><a href="https://stackoverflow.com/questions/15692275/how-to-kill-a-process-tree-programmatically-on-linux-using-c/15692619">How to kill a process tree programmatically on Linux using C </a></li>

<li><a href="https://tronche.com/gui/x/xlib/display/XCloseDisplay.html">Xlib Programming Manual: Closing the Display</a></li>

<li><a href="https://tronche.com/gui/x/xlib/window-information/XQueryTree.html">Xlib Programming Manual: XQueryTree</a></li>

<li><a href="https://tronche.com/gui/x/xlib/ICC/client-to-window-manager/XFetchName.html">Xlib Programming Manual: XFetchName</a></li>

<li><a href="https://tronche.com/gui/x/xlib/window-information/XGetWindowAttributes.html">Xlib Programming Manual: XGetWindowAttributes</a></li>
</ul>


<p>
<b>Files</b> 
</p>

<p>
All files available at: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/639df76864d014ead12936fbd361be73">https://gist.github.com/639df76864d014ead12936fbd361be73</a></li>
</ul>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(X11-Xtoll-Project)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">find_package</span>(X11 REQUIRED)

<span class="org-comment">#========== Targets Configurations ============#</span>

       <span class="org-function-name">add_executable</span>( x11-tool x11-tool.cpp )
<span class="org-function-name">target_link_libraries</span>( x11-tool ${<span class="org-variable-name">X11_LIBRARIES</span>} )
</pre>
</div>

<p>
File: <span class="underline">x11-tool.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">------ Unix Headers (needed by read_symlink) ------// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">signal.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">------ X11 Headers  ------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">X11/Xlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">X11/Xatom.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdlib</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-function-name">std</span>::string  read_symlink      <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span>          <span class="org-function-name">x11_get_property_int32</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">property_name</span>, <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">root_window</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::string  x11_get_property_str  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">property_name</span>, <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">root_window</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Window_Consumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">x11_iterate_child_windows</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>
                               , <span class="org-type">Window</span> <span class="org-variable-name">root_window</span>
                               , <span class="org-type">Window_Consumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-function-name">std</span>::string  x11_window_name<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span>          <span class="org-function-name">x11_window_get_pid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">bool</span>         <span class="org-function-name">x11_show_window_attributes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>         <span class="org-function-name">x11_show_window_properties</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Print booleans as 'true' or 'false' instead of 1 or 0</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;

    <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span> = XOpenDisplay<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-comment-delimiter">// </span><span class="org-comment">Placeholder for future error checking in non-prototype code. </span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> dpy != <span class="org-constant">nullptr</span> &amp;&amp; <span class="org-string">"Cannot open display"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">disp_str</span> = XDisplayString<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> disp_str != <span class="org-constant">nullptr</span> &amp;&amp; <span class="org-string">"Failed to get display string"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 Display string = "</span> &lt;&lt; disp_str &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get root window </span>
    <span class="org-type">Window</span> <span class="org-variable-name">root</span> = DefaultRootWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">assert( root != nullptr &amp;&amp; "Failed to get root window");</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [USAGE] $ "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;COMMAND&gt; "</span> &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">List all windows and their window ids (unique identifiers)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"list"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        x11_iterate_child_windows<span class="org-rainbow-delimiters-depth-3">(</span>dpy, root,<span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span>, <span class="org-type">int</span> <span class="org-variable-name">index</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>x11_show_window_attributes<span class="org-rainbow-delimiters-depth-6">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            x11_show_window_properties<span class="org-rainbow-delimiters-depth-5">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-5">)</span>;  
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;    
        <span class="org-keyword">return</span> EXIT_SUCCESS;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"winfo"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">WARNING: Throws std::invalid_argument exception on parsing failure.</span>
        <span class="org-type">int</span> <span class="org-variable-name">window_id</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        x11_show_window_attributes<span class="org-rainbow-delimiters-depth-3">(</span>dpy, window_id<span class="org-rainbow-delimiters-depth-3">)</span>;
        x11_show_window_properties<span class="org-rainbow-delimiters-depth-3">(</span>dpy, window_id<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_SUCCESS;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Kill window given its unique identifier (window id)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"kill"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">WARNING: Throws std::invalid_argument exception on parsing failure.</span>
        <span class="org-type">int</span> <span class="org-variable-name">window_id</span> = <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Attempt to get window process ID </span>
        <span class="org-type">int</span> <span class="org-variable-name">pid</span> = x11_window_get_pid<span class="org-rainbow-delimiters-depth-3">(</span>dpy, window_id<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>pid &lt; 0<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Unable to determine window process ID"</span> &lt;&lt; <span class="org-string">'\n'</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Kill process with PID = "</span> &lt;&lt; pid &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Force process termination </span>
        kill<span class="org-rainbow-delimiters-depth-3">(</span>pid, SIGTERM<span class="org-rainbow-delimiters-depth-3">)</span>;
        kill<span class="org-rainbow-delimiters-depth-3">(</span>pid, SIGKILL<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_SUCCESS;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    XCloseDisplay<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/*</span><span class="org-comment">================================================================*\</span>
<span class="org-comment"> *             I M P L E M E N T A T I O N S                      *</span>
<span class="org-comment"> *================================================================*/</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Get absolute path to file or symbolic link </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Requires: #&lt;unistd.h&gt;, &lt;limits.h&gt;</span>
<span class="org-function-name">std</span>::string 
read_symlink<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to read symbolic link"</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> 
<span class="org-function-name">x11_get_property_int32</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">property_name</span>, <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">root_window</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">Atom</span> <span class="org-variable-name">p</span> = XInternAtom<span class="org-rainbow-delimiters-depth-2">(</span>dpy, property_name, <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Atom</span> <span class="org-variable-name">actual_type</span>;
    <span class="org-type">int</span> <span class="org-variable-name">format</span>;
    <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">num_items</span>, <span class="org-variable-name">bytes_after</span>;
    <span class="org-type">unsigned</span> <span class="org-type">char</span>* <span class="org-variable-name">data</span> = <span class="org-constant">nullptr</span>;

    <span class="org-type">int</span> <span class="org-variable-name">status</span> = XGetWindowProperty<span class="org-rainbow-delimiters-depth-2">(</span>  dpy, root_window, p, 0L, 1024L
                                    , <span class="org-constant">false</span>,   XA_CARDINAL, &amp;actual_type                                         
                                    , &amp;format, &amp;num_items, &amp;bytes_after                                 
                                    , &amp;data 
                                    <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> status != 0 || num_items &lt; 1<span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">throw std::runtime_error("Error: failed to get property");        </span>
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">int</span> <span class="org-variable-name">value</span> =   data<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span> | <span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; 8<span class="org-rainbow-delimiters-depth-2">)</span> 
                | <span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; 16<span class="org-rainbow-delimiters-depth-2">)</span> | <span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; 24<span class="org-rainbow-delimiters-depth-2">)</span>;
    XFree<span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> value;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">std</span>::string 
x11_get_property_str<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">property_name</span>, <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">root_window</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">Atom</span> <span class="org-variable-name">p</span> = XInternAtom<span class="org-rainbow-delimiters-depth-2">(</span>dpy, property_name, <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Atom</span> <span class="org-variable-name">actual_type</span>;
    <span class="org-type">int</span> <span class="org-variable-name">format</span>;
    <span class="org-type">unsigned</span> <span class="org-type">long</span> <span class="org-variable-name">num_items</span>, <span class="org-variable-name">bytes_after</span>;
    <span class="org-type">unsigned</span> <span class="org-type">char</span>* <span class="org-variable-name">data</span> = <span class="org-constant">nullptr</span>;

    <span class="org-type">int</span> <span class="org-variable-name">status</span> = XGetWindowProperty<span class="org-rainbow-delimiters-depth-2">(</span>  dpy, root_window, p, 0L, 1024L
                                    , <span class="org-constant">false</span>,   XA_STRING, &amp;actual_type                                         
                                    , &amp;format, &amp;num_items, &amp;bytes_after                                 
                                    , &amp;data 
                                    <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> status != 0 || num_items &lt; 1<span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">throw std::runtime_error("Error: failed to get property");        </span>
        <span class="org-keyword">return</span> <span class="org-string">"&lt;NONE&gt;"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>data, data + num_items<span class="org-rainbow-delimiters-depth-2">)</span>;
    XFree<span class="org-rainbow-delimiters-depth-2">(</span>data<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> value;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Window_Consumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">x11_iterate_child_windows</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">Display</span>*          <span class="org-variable-name">dpy</span>
                               ,<span class="org-type">Window</span>            <span class="org-variable-name">root_window</span>
                               ,<span class="org-type">Window_Consumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">----- Return parameters of function XQueryTree() -------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the memory is allocated and owned by the calling code.</span>
    <span class="org-comment-delimiter">//       </span><span class="org-comment">function.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: '{}' curly brackets gurantees default initialization as 'nullptr'</span>
    <span class="org-type">Window</span> <span class="org-variable-name">root_return</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-type">Window</span> <span class="org-variable-name">parent_return</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">List of childre window to be returned </span>
    <span class="org-type">Window</span>* <span class="org-variable-name">children_return</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Number of children windows </span>
    <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">nchildren_return</span><span class="org-rainbow-delimiters-depth-2">{}</span>;

    <span class="org-type">int</span> <span class="org-variable-name">result</span> =  XQueryTree<span class="org-rainbow-delimiters-depth-2">(</span> 
                    dpy                <span class="org-comment-delimiter">// </span><span class="org-comment">Display </span>
                  , root_window        <span class="org-comment-delimiter">// </span><span class="org-comment">Root window</span>
                  , &amp;root_return       <span class="org-comment-delimiter">// </span><span class="org-comment">Root window return </span>
                  , &amp;parent_return     <span class="org-comment-delimiter">// </span><span class="org-comment">Return paramameter for pointer to parent window </span>
                  , &amp;children_return   <span class="org-comment-delimiter">// </span><span class="org-comment">List of children to be returned </span>
                  , &amp;nchildren_return  <span class="org-comment-delimiter">// </span><span class="org-comment">Number of children elements in (children_return )</span>
                <span class="org-rainbow-delimiters-depth-2">)</span> ;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> result != 0 &amp;&amp; <span class="org-string">"Failed to query windows"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Number of children  windows = "</span> &lt;&lt; nchildren_return &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = 0; n &lt; nchildren_return; n++ <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        consumer<span class="org-rainbow-delimiters-depth-3">(</span>dpy, children_return<span class="org-rainbow-delimiters-depth-4">[</span>n<span class="org-rainbow-delimiters-depth-4">]</span>, n<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Dispose, release memory allocated for children windows return </span>
    XFree<span class="org-rainbow-delimiters-depth-2">(</span>children_return<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Get Window name </span>
<span class="org-function-name">std</span>::string 
x11_window_name<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>* <span class="org-variable-name">window_name</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>XFetchName<span class="org-rainbow-delimiters-depth-3">(</span>dpy, wnd, &amp;window_name<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">output</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span>window_name<span class="org-rainbow-delimiters-depth-2">}</span>;
    XFree<span class="org-rainbow-delimiters-depth-2">(</span>window_name<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> output;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Note: It only works for X-client applications running on local machine.</span>
<span class="org-type">int</span> <span class="org-function-name">x11_window_get_pid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> x11_get_property_int32<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"_NET_WM_PID"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">x11_show_window_attributes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">XWindowAttributes</span> <span class="org-variable-name">attr</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>XGetWindowAttributes<span class="org-rainbow-delimiters-depth-3">(</span>dpy, wnd, &amp;attr<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error, failed to get window (wnd = %zu) attribute \n"</span>
                            , wnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">exit(EXIT_FAILURE);</span>
        <span class="org-keyword">return</span> <span class="org-constant">false</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>  

    <span class="org-keyword">auto</span> <span class="org-variable-name">window_name</span> = x11_window_name<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>window_name == <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">is_visible</span> = attr.map_state == IsViewable;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n\n [INFO] "</span> 
                &lt;&lt; <span class="org-string">" ; window_id = "</span> &lt;&lt; wnd 
                &lt;&lt; <span class="org-string">" ; Visible = "</span> &lt;&lt; is_visible  
                &lt;&lt; <span class="org-string">" ; Width  = "</span>  &lt;&lt; attr.width 
                &lt;&lt; <span class="org-string">" ; Height = "</span>  &lt;&lt; attr.height                 
                &lt;&lt; <span class="org-string">'\n'</span>;  
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Window Name = "</span> &lt;&lt; window_name &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">return</span> <span class="org-constant">true</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">x11_show_window_properties</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Display</span>* <span class="org-variable-name">dpy</span>, <span class="org-type">Window</span> <span class="org-variable-name">wnd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">pid</span> = x11_get_property_int32<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"_NET_WM_PID"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Window PID (Process ID) = "</span>        
                &lt;&lt; pid 
                &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-keyword">try</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">path_to_executable_procfs</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/"</span><span class="org-rainbow-delimiters-depth-3">)</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-3">(</span>pid<span class="org-rainbow-delimiters-depth-3">)</span> + <span class="org-string">"/exe"</span>;            
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; Window program (executable) = "</span> 
                  &lt;&lt; read_symlink<span class="org-rainbow-delimiters-depth-3">(</span>path_to_executable_procfs<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;            
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] "</span> &lt;&lt;  ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; WM_NAME = "</span> 
                &lt;&lt; x11_get_property_str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WM_NAME"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span> 
                &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; WM_CLASS = "</span> 
                &lt;&lt; x11_get_property_str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WM_CLASS"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span> 
                &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; WM_COMMAND = "</span> 
                &lt;&lt; x11_get_property_str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WM_COMMAND"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span> 
                &lt;&lt; <span class="org-string">'\n'</span>;                  

    <span class="org-comment-delimiter">// </span><span class="org-comment">Hostname of machine where the window application is located. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">A window may belong to an application (X-client) running in a </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">remote machine.</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; WM_CLIENT_MACHINE = "</span> 
                &lt;&lt; x11_get_property_str<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"WM_CLIENT_MACHINE"</span>, dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span> 
                &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/639df76864d014ead12936fbd361be73 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug 
$ cmake --build _build --target 

$ &gt;&gt; _build/x11-tool 
[INFO] X11 Display string = :1.0
[USAGE] $ _build/x11-tool &lt;COMMAND&gt; 
</pre>
</div>

<p>
List Windows: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; _build/x11-tool list
[INFO] X11 Display string = :1.0
[INFO] Number of children  windows = 116


[INFO]  ; window_id = 2097153 ; Visible = false ; Width  = 10 ; Height = 10
=&gt; Window Name = xfce4-session
=&gt; Window PID (Process ID) = 1715
=&gt; Window program (executable) = /usr/bin/xfce4-session
=&gt; WM_NAME = xfce4-session
=&gt; WM_CLASS = xfce4-sessionXfce4-session
=&gt; WM_COMMAND = xfce4-session
=&gt; WM_CLIENT_MACHINE = localhost.localdomain

 ... ....   ... ....   ... .... 
 ... ....   ... ....   ... .... 

[INFO]  ; window_id = 69206017 ; Visible = false ; Width  = 10 ; Height = 10
=&gt; Window Name = Terminal
=&gt; Window PID (Process ID) = 778969
=&gt; Window program (executable) = /usr/libexec/gnome-terminal-server
=&gt; WM_NAME = Terminal
=&gt; WM_CLASS = gnome-terminal-serverGnome-terminal-server
=&gt; WM_COMMAND = gnome-terminal-server
=&gt; WM_CLIENT_MACHINE = localhost.localdomain


[INFO]  ; window_id = 69206018 ; Visible = false ; Width  = 10 ; Height = 10
=&gt; Window Name = Terminal
=&gt; Window PID (Process ID) = 778969
=&gt; Window program (executable) = /usr/libexec/gnome-terminal-server
=&gt; WM_NAME = Terminal
=&gt; WM_CLASS = &lt;NONE&gt;
=&gt; WM_COMMAND = &lt;NONE&gt;
=&gt; WM_CLIENT_MACHINE = localhost.localdomain
</pre>
</div>

<p>
List information for a single window: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; _build/x11-tool winfo 69206017 
[INFO] X11 Display string = :1.0


[INFO]  ; window_id = 69206017 ; Visible = false ; Width  = 10 ; Height = 10
=&gt; Window Name = Terminal
=&gt; Window PID (Process ID) = 778969
=&gt; Window program (executable) = /usr/libexec/gnome-terminal-server
=&gt; WM_NAME = Terminal
=&gt; WM_CLASS = gnome-terminal-serverGnome-terminal-server
=&gt; WM_COMMAND = gnome-terminal-server
=&gt; WM_CLIENT_MACHINE = localhost.localdomain
</pre>
</div>

<p>
Check information via <span class="underline">xprop</span> x11 utility tools: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; xprop -id 69206017 
<span class="org-function-name">WM_CLASS</span>(STRING) = <span class="org-string">"gnome-terminal-server"</span>, <span class="org-string">"Gnome-terminal-server"</span>
<span class="org-function-name">WM_COMMAND</span>(STRING) = { <span class="org-string">"gnome-terminal-server"</span> }
<span class="org-function-name">WM_CLIENT_LEADER</span>(WINDOW): window id <span class="org-comment-delimiter"># </span><span class="org-comment">0x4200001</span>
<span class="org-function-name">_NET_WM_PID</span>(CARDINAL) = 778969
<span class="org-function-name">WM_LOCALE_NAME</span>(STRING) = <span class="org-string">"en_US.UTF-8"</span>
<span class="org-function-name">WM_CLIENT_MACHINE</span>(STRING) = <span class="org-string">"localhost.localdomain"</span>
<span class="org-function-name">WM_NORMAL_HINTS</span>(WM_SIZE_HINTS):
                program specified size: 10 by 10
<span class="org-function-name">WM_PROTOCOLS</span>(ATOM): protocols  WM_DELETE_WINDOW, WM_TAKE_FOCUS, _NET_WM_PING
<span class="org-function-name">WM_ICON_NAME</span>(STRING) = <span class="org-string">"Terminal"</span>
<span class="org-function-name">_NET_WM_ICON_NAME</span>(UTF8_STRING) = <span class="org-string">"Terminal"</span>
<span class="org-function-name">WM_NAME</span>(STRING) = <span class="org-string">"Terminal"</span>
<span class="org-function-name">_NET_WM_NAME</span>(UTF8_STRING) = <span class="org-string">"Terminal"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Get the executable that created this window </span>
 $ &gt;&gt; readlink -f /proc/778969/exe 
/usr/libexec/gnome-terminal-server
</pre>
</div>

<p>
Terminate process that created the previous window: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; _build/x11-tool kill 69206017 
[INFO] X11 Display string = :1.0
Kill process with PID = 778969
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bfbcce" class="outline-4">
<h4 id="org4bfbcce"><span class="section-number-4">1.31.6</span> Further reading and references</h4>
<div class="outline-text-4" id="text-1-31-6">
<p>
<b>X11 Windows System Client Libraries</b>
</p>

<ul class="org-ul">
<li><b>Xlib - C Language X Interface</b> - X Consortium Standard
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html</a></li>
</ul></li>

<li><b>XCB X11 Client C Library</b> - Freedeskop foundation
<ul class="org-ul">
<li><a href="https://xcb.freedesktop.org/">https://xcb.freedesktop.org/</a></li>
</ul></li>

<li><b>Python-Xlib Client</b> (alternative inplentations, X11 client in pure Python)
<ul class="org-ul">
<li><a href="https://github.com/python-xlib/python-xlib">https://github.com/python-xlib/python-xlib</a></li>
</ul></li>
</ul>

<p>
<b>X Windows System</b>
</p>

<ul class="org-ul">
<li><b>Documentation for the X Window System</b> - Version 11 Release 7.7
(X11R7.7) [MUST-READ]
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/">https://www.x.org/releases/X11R7.7/doc/</a></li>
</ul></li>

<li><b>X Window System Protocol</b> - X consortium Standard. [MUST-READ]
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html">https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html</a></li>
<li>Summary: Formal specification of X-Windows System Network Protocol.</li>
</ul></li>

<li><b>X WINDOW SYSTEM PROTOCOL, VERSION 11</b> - Alpha Update - April 1987
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc1013">https://tools.ietf.org/html/rfc1013</a></li>
</ul></li>

<li><b>X Window System core protocol</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/X_Window_System_core_protocol">https://en.wikipedia.org/wiki/X_Window_System_core_protocol</a></li>
<li>"The X Window System core protocol[1][2][3] is the base
protocol of the X Window System, which is a networked windowing
system for bitmap displays used to build graphical user
interfaces on Unix, Unix-like, and other operating systems. The
X Window System is based on a client–server model: a single
server controls the input/output hardware, such as the screen,
the keyboard, and the mouse; all application programs act as
clients, interacting with the user and with the other clients
via the server. .."</li>
</ul></li>

<li><b>Telnet Forwarding of X Window System Session Data</b>
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/draft-altman-telnet-fwdx-01">https://tools.ietf.org/html/draft-altman-telnet-fwdx-01</a></li>
</ul></li>

<li><b>Xming X Server for Windows</b>
<ul class="org-ul">
<li><a href="http://www.straightrunning.com/XmingNotes/">http://www.straightrunning.com/XmingNotes/</a></li>
<li>Summary: X Server implementation for Microsft Windows NT
operating system which allows using remote Linux or BSD
graphical applications via X11 X Windows System network
protocol.</li>
</ul></li>

<li><b>XWindows Utility Description</b>
<ul class="org-ul">
<li><a href="https://www.distributednetworks.com/redhat-linux-admin/module2/xwindows-utility-description.php">https://www.distributednetworks.com/redhat-linux-admin/module2/xwindows-utility-description.php</a></li>
</ul></li>

<li><b>X Server Source Code</b> / Gitlab
<ul class="org-ul">
<li><a href="https://gitlab.freedesktop.org/xorg/xserver">https://gitlab.freedesktop.org/xorg/xserver</a></li>
<li>"The X server accepts requests from client applications to
create windows, which are (normally rectangular) "virtual
screens" that the client program can draw into. Windows are
then composed on the actual screen by the X server (or by a
separate composite manager) as directed by the window manager,
which usually communicates with the user via graphical controls
such as buttons and draggable titlebars and borders."</li>
</ul></li>

<li><b>The XFree86 - Project Inc</b> - Major implementation of XServer for X11
<ul class="org-ul">
<li><a href="https://www.xfree86.org/">https://www.xfree86.org/</a></li>
<li>"The XFree86 Project, Inc is a global volunteer organization
which produces XFree86®, the freely redistributable open-source
implementation of the X Window System continuously
since 1992. XFree86 runs primarily on UNIX® and UNIX-like
operating systems like Linux, all of the BSD variants, Sun
Solaris both native 32 and 64 bit support, Solaris x86, Mac OS
X (via Darwin) as well as other platforms like OS/2 and
Cygwin. What XFree86 does, is provide a client/server interface
between the display hardware (those physical things like the
mouse, keyboard, and video displays) and the desktop
environment, (this is typically called a window manager as it
deals with how X is displayed i.e. the overall appearance). Yet
X it goes beyond that and also gives the infrastructure and a
standardized application interface (API). All of this which
makes XFree86 platform-independent, network-transparent and
fully extensible. In short, XFree86 is the premier open source
X11-based desktop infrastructure.</li>
</ul></li>

<li><b>Athena Widget Set - C Language Interface</b> (libXaw Version 1.0.13) - X Consortium Standard
<ul class="org-ul">
<li><a href="https://www.x.org/releases/current/doc/libXaw/libXaw.html">https://www.x.org/releases/current/doc/libXaw/libXaw.html</a></li>
<li>"The X Toolkit is made up of two distinct pieces, the Xt
Intrinsics and a widget set. The Athena widget set is a sample
implementation of a widget set built upon the Intrinsics. In
the X Toolkit, a widget is the combination of an X window or
subwindow and its associated input and output
semantics. Because the Intrinsics provide the same basic
functionality to all widget sets it may be possible to use
widgets from the Athena widget set with other widget sets based
upon the Intrinsics. Since widget sets may also implement
private protocols, all functionality may not be available when
mixing and matching widget sets. For information about the
Intrinsics, see the X Toolkit Intrinsics - C Language
Interface. The Athena widget set is a library package layered
on top of the Intrinsics and Xlib that provides a set of user
interface tools sufficient to build a wide variety of
applications. This layer extends the basic abstractions
provided by X and provides the next layer of functionality
primarily by supplying a cohesive set of sample
widgets. Although the Intrinsics are a Consortium standard,
there is no standard widget set."</li>
</ul></li>
</ul>


<p>
<b>X11 - X Windows System Concepts</b>
</p>

<ul class="org-ul">
<li><b>Window manager</b> - Arch Linux Wiki
<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/window_manager">https://wiki.archlinux.org/index.php/window_manager</a></li>
<li>Summary: Outlines several possible window systems for X Windows
Systems, such as 2bwm, 9wm, compiz, blackbox, i3, awesome,
qtile, xmonad &#x2026;</li>
</ul></li>
</ul>

<p>
<b>Low Level Graphics Stack - kernel and embedded Linux systems</b>
</p>

<ul class="org-ul">
<li><b>Linux Graphics Demystified</b> - Martin Fiedler - Dream Chip Techonologies GMHB
<ul class="org-ul">
<li><a href="https://keyj.emphy.de/files/linuxgraphics_en.pdf">https://keyj.emphy.de/files/linuxgraphics_en.pdf</a></li>
<li><a href="https://web.archive.org/web/20200426101542/https://keyj.emphy.de/files/linuxgraphics_en.pdf">https://web.archive.org/web/20200426101542/https://keyj.emphy.de/files/linuxgraphics_en.pdf</a></li>
<li>Summary: Explains about Linux low level graphics stack,
including framebuffer, X-Server.</li>
</ul></li>

<li><b>Linux Framebuffer</b> ( /dev/fb0 )
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Linux_framebuffer">https://en.wikipedia.org/wiki/Linux_framebuffer</a></li>
<li>"The Linux framebuffer (fbdev) is a graphic hardware-independent
abstraction layer to show graphics on a computer monitor,
typically on the system console.[1] It allows direct access to
the framebuffer (the part of a computer's video memory
containing a current video frame) using only the Linux kernel's
own basic facilities and its device file system interface."</li>
</ul></li>

<li><b>Linux Framebuffer</b> - Nicolas Caramelli
<ul class="org-ul">
<li><a href="https://github.com/caramelli/higfxback/wiki/Linux-Framebuffer">https://github.com/caramelli/higfxback/wiki/Linux-Framebuffer</a></li>
<li>Summary: Detailed explanation about Linux kernel framebuffer
infrastructure.</li>
</ul></li>

<li><b>Frmebuffer (Linux)</b> - Toradex Developer resources
<ul class="org-ul">
<li><a href="https://developer.toradex.com/knowledge-base/framebuffer-linux">https://developer.toradex.com/knowledge-base/framebuffer-linux</a></li>
<li>"The framebuffer (fbdev) is a character device providing access
to graphics hardware. Beside the framebuffer, other interfaces
exist to access graphics hardware such as the DRI (direct
rendering interface) or proprietary interfaces (NVIDIA
drivers). Typically, the framebuffer doesn't support any 2D/3D
hardware acceleration. &#x2026;"</li>
</ul></li>

<li><b>DRI - Direct Rendering Infrastructure</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Direct_Rendering_Infrastructure">https://en.wikipedia.org/wiki/Direct_Rendering_Infrastructure</a></li>
<li>"The Direct Rendering Infrastructure (DRI) is a framework for
allowing direct access to graphics hardware under the X Window
System in a safe, efficient way.[6] The main use of DRI is to
provide hardware acceleration for the Mesa implementation of
OpenGL. DRI has also been adapted to provide OpenGL acceleration
on a framebuffer console without a display server running. &#x2026;"</li>
</ul></li>

<li><b>Mesa 3D and Direct Rendering Infrastructure wiki</b>
<ul class="org-ul">
<li><a href="https://dri.freedesktop.org/wiki/">https://dri.freedesktop.org/wiki/</a></li>
<li>"The Direct Rendering Infrastructure, also known as the DRI, is
a framework for allowing direct access to graphics hardware
under the X Window System in a safe and efficient manner. It
includes changes to the X server, to several client libraries,
and to the kernel (DRM, Direct Rendering Manager). The most
important use for the DRI is to create fast OpenGL
implementations providing hardware acceleration for
Mesa. Several 3D accelerated drivers have been written to the
DRI specification, including drivers for chipsets produced by
3DFX, AMD (formerly ATI), Intel and Matrox."</li>
</ul></li>

<li><b>Linux GPU Driver Developer's Guide</b>
<ul class="org-ul">
<li><a href="https://01.org/linuxgraphics/gfx-docs/drm/gpu/index.html">https://01.org/linuxgraphics/gfx-docs/drm/gpu/index.html</a></li>
<li>"The Linux DRM layer contains code intended to support the needs
of complex graphics devices, usually containing programmable
pipelines well suited to 3D graphics acceleration. Graphics
drivers in the kernel may make use of DRM functions to make
tasks like memory management, interrupt handling and DMA easier,
and provide a uniform interface to applications. A note on
versions: this guide covers features found in the DRM tree,
including the TTM memory manager, output configuration and mode
setting, and the new vblank internals, in addition to all the
regular features found in current kernels."</li>
</ul></li>

<li><b>Displaying and Rendering Graphics with Linux Training</b> - Bootlin
<ul class="org-ul">
<li><a href="https://bootlin.com/doc/training/graphics/graphics-slides.pdf">https://bootlin.com/doc/training/graphics/graphics-slides.pdf</a></li>
<li><a href="https://web.archive.org/web/20201018160609/https://bootlin.com/doc/training/graphics/graphics-slides.pdf">https://web.archive.org/web/20201018160609/https://bootlin.com/doc/training/graphics/graphics-slides.pdf</a></li>
</ul></li>

<li><b>Inside Linux - graphics Understanding the components, upgrading drivers, and advanced use cases</b> - Intel
<ul class="org-ul">
<li><a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/inside-linux-graphics-paper.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/inside-linux-graphics-paper.pdf</a></li>
</ul></li>

<li><b>EGL (API)</b> - Embedded OpenGL
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/EGL_(API)">https://en.wikipedia.org/wiki/EGL_(API)</a></li>
</ul></li>

<li><b>Qt for Embedded Linux</b> (Also covers Qt directly on top of Framebuffer device)
<ul class="org-ul">
<li><a href="https://doc.qt.io/qt-5/embedded-linux.html#linuxfb">https://doc.qt.io/qt-5/embedded-linux.html#linuxfb</a></li>
</ul></li>

<li><b>The Virtual Framebuffer</b> - Qt Company
<ul class="org-ul">
<li><a href="https://doc.qt.io/archives/qt-4.8//qvfb.html">https://doc.qt.io/archives/qt-4.8//qvfb.html</a></li>
<li>"Qt for Embedded Linux applications write directly to the
framebuffer, eliminating the need for the X Window System and
saving memory. For development and debugging purposes, a virtual
framebuffer can be used, allowing Qt for Embedded Linux programs
to be developed on a desktop machine, without switching between
consoles and X11."</li>
</ul></li>

<li><b>Writing to the Framebuffer</b> - Seena Burns
<ul class="org-ul">
<li><a href="http://seenaburns.com/2018/04/04/writing-to-the-framebuffer/">http://seenaburns.com/2018/04/04/writing-to-the-framebuffer/</a></li>
</ul></li>

<li><b>Writing to the Framebuffer</b> (Forum Discussion)
<ul class="org-ul">
<li><a href="https://news.ycombinator.com/item?id=16755552">https://news.ycombinator.com/item?id=16755552</a></li>
</ul></li>

<li><b>The DRM/KMS subsystem from a newbie’s point of view</b> - Boris Brezilion 
<ul class="org-ul">
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf">https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf</a></li>
<li><a href="https://web.archive.org/web/20191031122549/https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf">https://web.archive.org/web/20191031122549/https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf</a></li>
</ul></li>

<li><b>DRM Driver Development For Embedded Systems</b> - Inki Dae, Software Platform Lab - Samsung
<ul class="org-ul">
<li><a href="https://elinux.org/images/7/71/Elce11_dae.pdf">https://elinux.org/images/7/71/Elce11_dae.pdf</a></li>
<li><a href="https://web.archive.org/web/20201018154836/https://elinux.org/images/7/71/Elce11_dae.pdf">https://web.archive.org/web/20201018154836/https://elinux.org/images/7/71/Elce11_dae.pdf</a></li>
</ul></li>

<li><b>drm - Direct Rendering Manager (DRI kernel support)</b> - Device Drivers Manual (NetBSD)
<ul class="org-ul">
<li><a href="https://www.daemon-systems.org/man/drm.4.html">https://www.daemon-systems.org/man/drm.4.html</a></li>
</ul></li>

<li><b>CS574 presentation: Linux OpenGL drivers: Direct Rendering  Infrastructure</b>
<ul class="org-ul">
<li><a href="https://www.cs.nmsu.edu/~joshagam/archive/cs574/3-dri.html">https://www.cs.nmsu.edu/~joshagam/archive/cs574/3-dri.html</a></li>
</ul></li>

<li><b>Platform specifics: Linux</b> - OpenGL - Kronos Group
<ul class="org-ul">
<li><a href="https://www.khronos.org/opengl/wiki/Platform_specifics:_Linux">https://www.khronos.org/opengl/wiki/Platform_specifics:_Linux</a></li>
<li>"This Section explains how to install Drivers to make OpenGL
Programs run under Linux and how to use different
Libraries/Toolkits to create Opengl Programs. Mesa is an
open-source OpenGL implementation, continually updated to
support the latest OpenGL specification. Direct Rendering
Infrastructure, also known as the DRI, is a framework for
allowing direct access to graphics hardware under the X Window
System in a safe and efficient manner."</li>
</ul></li>

<li><b>DRM(Direct Rendering Manager) of Tizen Kernel</b>
<ul class="org-ul">
<li><a href="https://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf">https://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf</a></li>
<li><a href="https://web.archive.org/web/20161109195212/http://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf">https://web.archive.org/web/20161109195212/http://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf</a></li>
</ul></li>

<li><b>Direct Rendering Infrastructure: Architecture</b> - José Manual Rios Fonseca
<ul class="org-ul">
<li><a href="https://paginas.fe.up.pt/~mei04010/dri-architecture.pdf">https://paginas.fe.up.pt/~mei04010/dri-architecture.pdf</a></li>
</ul></li>
</ul>


<p>
<b>Wayland (Note: Eventually may replace X Windows System)</b>
</p>

<ul class="org-ul">
<li><b>Wayland v/s Xorg : How Are They Similar &amp; How Are They Different</b>
<ul class="org-ul">
<li><a href="https://www.secjuice.com/wayland-vs-xorg/">https://www.secjuice.com/wayland-vs-xorg/</a></li>
</ul></li>

<li><b>Wayland (display server protocol)</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)">https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)</a></li>
</ul></li>

<li>Book: <b>The Wayland Protocol</b>
<ul class="org-ul">
<li><a href="https://wayland-book.com/introduction.html">https://wayland-book.com/introduction.html</a></li>
<li>"Wayland is the next-generation display server for Unix-like
systems, designed and built by the alumni of the venerable Xorg
server, and is the best way to get your application windows onto
your user's screens. Readers who have worked with X11 in the
past will be pleasantly surprised by Wayland's improvements, and
those who are new to graphics on Unix will find it a flexible
and powerful system for building graphical applications and
desktops. This book will help you establish a firm understanding
of the concepts, design, and implementation of Wayland, and
equip you with the tools to build your own Wayland client and
server applications. Over the course of your reading, we'll
build a mental model of Wayland and establish the rationale that
went into its design. Within these pages you should find many
"aha!" moments as the intuitive design choices of Wayland become
clear, which should help to keep the pages turning. Welcome to
the future of open source graphics!"</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2021-05-04 Tue 19:58</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
