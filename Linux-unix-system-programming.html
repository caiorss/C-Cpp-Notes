<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-06-30 Tue 04:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux and Unix system programming</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="Linux, unix and posix system programming"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux and Unix system programming</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb9493cb">1. Unix System Programming focused on Linux</a>
<ul>
<li><a href="#org29fe590">1.1. Unix-like Operating Systems</a></li>
<li><a href="#orgeb0b819">1.2. Creating Portable Binaries for Linux / GLIBC hell</a>
<ul>
<li><a href="#orgaff806f">1.2.1. Overview</a></li>
<li><a href="#org56c9bae">1.2.2. The GLIBC Problem</a></li>
<li><a href="#orgaf0f33b">1.2.3. Solution 1 - via linking against older GLIBC</a></li>
<li><a href="#orgb5fa7a7">1.2.4. Solution 2 - via linking against MUSL libC</a></li>
</ul>
</li>
<li><a href="#org54d3407">1.3. Low level IO functions overview</a></li>
<li><a href="#orgc4869d6">1.4. Low level IO - open(), read(), write() syscall functions</a></li>
<li><a href="#org97dccdd">1.5. Low level IO - creat()</a></li>
<li><a href="#orgbde6cb7">1.6. Information about current process</a></li>
<li><a href="#org74199fd">1.7. Dynamic Loading Shared Libraries / dlopen() API</a>
<ul>
<li><a href="#orgeab836a">1.7.1. Overview</a></li>
<li><a href="#orgb67e3c2">1.7.2. GTK3/GTK2 GUI using dynamic loading - low level</a></li>
<li><a href="#orgb771b9a">1.7.3. GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</a></li>
</ul>
</li>
<li><a href="#orgb6aa8a5">1.8. Launching processes with exec and fork system-call wrappers</a></li>
<li><a href="#orgdc16d40">1.9. Reading subprocess output via Popen()</a></li>
<li><a href="#org429d4fa">1.10. Unix Pipes - Inter Process Communication</a></li>
<li><a href="#org86b9cc1">1.11. Reading/Listings directory contents</a></li>
<li><a href="#org4c18809">1.12. Memory Mapped Files - mmap</a>
<ul>
<li><a href="#org2eaeca4">1.12.1. Overview</a></li>
<li><a href="#org3d5879c">1.12.2. Example (C) - mmap for reading Windows PE32 files</a></li>
<li><a href="#orgb4a18c0">1.12.3. Example (C++) - mmap for reading Windows PE32 files</a></li>
<li><a href="#org444f15b">1.12.4. Example (C++) - mmap for reading Windows PE32 with class</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgb9493cb" class="outline-2">
<h2 id="orgb9493cb"><span class="section-number-2">1</span> Unix System Programming focused on Linux</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org29fe590" class="outline-3">
<h3 id="org29fe590"><span class="section-number-3">1.1</span> Unix-like Operating Systems</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Unix-like operating system are a family of operating system based on
the AT&amp;T Unix operating system, developed in the 1970's by <a href="https://en.m.wikipedia.org/wiki/Ken_Thompson">Ken Thompson</a>, 
<a href="https://en.m.wikipedia.org/wiki/Dennis_Ritchie">Dennis Ritchie</a> and others. Later AT&amp;T licensed Unix to third-party
vendors, what lead to many proprietary Unix variants. 
</p>

<p>
<b>Some Unix-like operating systems are</b>
</p>

<p>
Desktop or Server:
</p>

<ul class="org-ul">
<li><span class="underline">Mac OSX</span> / Apple [Most Used]</li>

<li><span class="underline">Linux-based or GNU-Linux based</span> operating systems (Note: Linux is
just the kernel) 
<ul class="org-ul">
<li>Debian Linux</li>
<li>Ubuntu Linux</li>
<li>Fedora Linux</li>
<li>Gentoo Linux</li>
<li>Arch   Linux</li>
<li>&#x2026; &#x2026; &#x2026;</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/FreeBSD">FreeBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/OpenBSD">OpenBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/DragonFly_BSD">DragonFly BSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a> - Open source small operating system created for teaching
about operating system concepts.</li>

<li><a href="https://en.m.wikipedia.org/wiki/Solaris_(operating_system)">Solaris</a> (from Sun Microsystems)</li>

<li><a href="https://en.m.wikipedia.org/wiki/Z/OS">z/OS</a> / IBM - Unix-variant for mainframes.</li>

<li>AIX / IBM</li>

<li><a href="https://en.m.wikipedia.org/wiki/HP-UX">HP-UX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/IRIX">IRIX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Xenix">Xenix</a></li>
</ul>

<p>
Mobile: 
</p>

<ul class="org-ul">
<li>Android (Linux-based OS, but without GNU on the userland)</li>

<li>iOS / Apple</li>
</ul>

<p>
Embedded Systems: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/QNX">QNX</a></li>

<li>Linux (called Embedded-Linux)</li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/LynxOS">LynxOS</a></li>
</ul>


<p>
<b>Common Features of Unix-like Operating Systems</b>
</p>


<p>
Nowadays, there may be many difference between Unix-like operating
systems, but they still have the following features in common: 
</p>

<ul class="org-ul">
<li><span class="underline">Command line shell</span>
<ul class="org-ul">
<li>In the early days of computing, the shell or command line
interpreter was the primary means of interaction between users
and computers. A unix shell is used both as a scripting language
and as an interactive command line interpreter for
user interaction, launching processes, launching daemons (aka
services), manipulating files and controlling the operating system.</li>

<li>Common Unix shells:
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Almquist_shell">ash</a>  (Almiquistt Shell)</li>
<li><a href="https://en.wikipedia.org/wiki/C_shell">c-shell</a></li>
<li><a href="https://en.wikipedia.org/wiki/Debian_Almquist_shell">dash</a> (Debian Almiquist Shell)</li>
<li>tcsh</li>
<li>ksh  (Korn Shell)</li>
<li>Tcl</li>
<li><a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">bash</a> (Bourn Shell) [Most used, most popular]</li>
<li>zsh                [Most popular]</li>
<li>fish               [Most popular]</li>
</ul></li>
</ul></li>

<li><span class="underline">Command Line Applications</span> (Command-Line Centric)
<ul class="org-ul">
<li>mv; cp; rm; mkdir; ls; telnet; ssh; &#x2026; and so on.</li>
</ul></li>

<li><span class="underline">Terminal Emulation</span>
<ul class="org-ul">
<li>Early Unix-like operating systems only ran in big and expensive
<span class="underline">mainframe</span> computers that were simultaneously shared by many
users via physical dumb terminals attached through serial cables
(RS232 - UART). The first terminals were <span class="underline">teletype printers</span> (tty)
where users could type commands and the teletype printer would
print the the command output in a paper type. Later, dumb CRT
(Cathode-Ray Tube) terminals were adopted. Those machines were
comprised of a keyboard attached to a CRT video display as
single unit attached to a mainframe via a serial cable. Physical
Terminals, such as the once popular <a href="https://en.wikipedia.org/wiki/VT100">DEC VT100</a>, are long gone,
but the are still <span class="underline">emulated</span> by unix-based operating systems. For
instance, most of those systems provide the following types of
terminal emulation:</li>

<li>=&gt; <i>Virtual console</i> =&gt; Kernel built-in terminal emulator, which can
be accessed without any graphical user interface by typing
Ctrl + Alt + F1, Ctrl + Alt + F[N] on Linux. BSD has different
keybinds for the <i>virtual console</i>. Note: Mac-OSX does not have
virtual console.</li>

<li>=&gt; <i>Graphical Terminal Emulator</i> =&gt; Example: Xterm (X11); Gnome
Terminal; Terminator; iTerm (MacOSX).</li>

<li>=&gt; <i>Serial console</i> =&gt; Allows accessing a command line shell
(bash, for instance) through a serial cable (RS232 /
UART). Serial console is still used for accessing servers or
embedded systems.</li>
</ul></li>
</ul>


<ul class="org-ul">
<li><span class="underline">Text-centric</span>

<ul class="org-ul">
<li>Unix-like operating system has the tradition of storing
configuration in human-readable text files, instead of binary files as
Windows does. The benefits of using text files are the better
reusability, searchability and reproducibility of
configurations. All that one needs to reproduce the configuration
in another machine is to copy the configuration file.</li>

<li>Many applications also use text for configuration instead of
graphical user interfaces.</li>

<li>Examples:
<ul class="org-ul">
<li>Linux-based operating system store many of their configuration
as text files in the '/etc' directory. For instance, the file
'/etc/fstab' controls the disk partitions mounted during boot
time. As opposite to Unix-tradition, Windows and most of its
applications store configuration in the registry file which
is a binary file.</li>

<li>Applications such as bash, vi, emacs store configuration in
text files placed in default locations which are read during
the initialization.</li>
</ul></li>
</ul></li>

<li><span class="underline">POSIX Features</span> / <a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX</a> - (Portable Operating System Interface) standard

<ul class="org-ul">
<li>POSIX System Calls
<ul class="org-ul">
<li>open(), read(), close() &#x2026;</li>
</ul></li>

<li>POSIX Functions encapsulating system calls 
<ul class="org-ul">
<li>open(), read(), close(), mmap(), dlopen(), dlclose() &#x2026;</li>
</ul></li>

<li>POSIX Threads (_PThreads_) - Thread C API</li>

<li>POSIX Shells</li>
</ul></li>

<li><span class="underline">BSD TCP/IP Sockets</span>  =&gt; TCP/IP networks were first implemented on Unix.</li>

<li><span class="underline">Hierarchical file system</span>
<ul class="org-ul">
<li>File system with paths like: '/' (root directory); '.' (dot) as
the current directory; '/home/user/data' (Linux);
'/home/Users/somthing' (MacOSX) and so on.</li>
</ul></li>

<li><span class="underline">Dynamic Link</span> (Symlink)
<ul class="org-ul">
<li>Allows file and directories to be accessed from other
directories as they were in that location.</li>
</ul></li>

<li><span class="underline">Virtual File Systems</span>
<ul class="org-ul">
<li>Many unix-like operating system provide virtual file-system
(in-memory file systems) which exposes kernel and system
information to user-space applications as human-readable text
files. For instance, Linux has the <span class="underline">PROCFS</span> (/proc directory) file
system which exposes information about all the running
processes. PROCFS also has the file <span class="underline">/proc/cpuinfo</span> which contains
information about the current machine microprocessor, such as:
CPU cores; number of hyper threads; CPU features and
capabilities.</li>
</ul></li>

<li><span class="underline">Everything is a file</span> (or better everything is a file descriptor)
<ul class="org-ul">
<li>Many operating such as reading/writing sockets, pipes and so on,
use the same read/write system-calls for file descriptors.</li>
<li>Hardware represented as device-files</li>
<li>Kernel exposes information as text files (Linux)</li>
<li>Disk partitions are represented as files /dev/sda, /dev/sdb1,
/dev/sdb2 &#x2026;</li>
<li>see: <a href="https://en.wikipedia.org/wiki/File_descriptor">file descriptor</a></li>
</ul></li>

<li><span class="underline">Device Files</span> (a.k.a device nodes)
<ul class="org-ul">
<li>Device files are pseudo-files created in virtual file systems
which allows user-space applications to interact with the
<span class="underline">hardware peripherals</span> by using reading and writing system-calls
or just by reading and writing files. This feature is
particularly important for industrial and embedded system
applications as it allows reading sensor data, such as ADC  -
Analog-To-Digital Converters or digital input, just by reading
files and controlling actuators, such as motors, solenoids or
valves just by writing to files.</li>

<li>Note A: On Linux-based, operating systems, most device files are
in the virtual file systems <span class="underline">devfs</span> (/dev) and and <span class="underline">sysfs</span> (/sys)
directory.</li>

<li>Note B: Not all device files are associated to real hardware
devices. The device-files /dev/null, /dev/zero, /dev/random,
/dev/urandom, /dev/kmsg, /dev/tty0 are not associated to any
real hardware.</li>

<li>Example 1: It allows user-space application to read and write
from/to serial port devices by just reading or writing to the
device file /dev/ttyS1, /dev/ttyUSB0, &#x2026;</li>

<li>Example 2: In single-board computers SBCs (embedded systems)
such as Beagle Bone Black or Raspberry PI, both which contains
SOC (System-On-Chip) embedded processors, it is possible to
control GPIOs (General Purpose IO) which are digital IOs, and
consequently any device attached to them, such as lights, LEDs,
motors or valves, just by writing to the corresponding GPIO
device file (/sys/class/gpio/gpio10/value). By writing 1 to the
this file, the LED is turned on, by writing 0, the LED is turned
off. The device-file feature allows controlling the hardware
with any programming language, including, shell scripts, python,
ruby, standard C++ (without volatile and embedded bare-metal
restrictions) and so on.</li>

<li>Common Linux Device Files associated to hardware 
<ul class="org-ul">
<li>/dev/lp0, /dev/lp1 =&gt; Parallel ports</li>
<li>/dev/ttyS0, /dev/ttyS1, &#x2026; =&gt; Serial Ports</li>
<li>/dev/ttyUSB0, /dev/ttyUSB1, &#x2026; =&gt; USB-to-serial converters such as FTDI</li>
<li>/dev/sys/class/gpio/gpio10/export =&gt; GPIO / General Purpose Digital IO</li>
<li>/dev/sys/class/gpio/gpio10/value</li>
<li>&#x2026; &#x2026; &#x2026;</li>
<li>/dev/input/mice =&gt; Binary file contains mouse position, mouse
buttons and and so on. The mouse position can be obtained by
reading this file, without any special API.</li>
<li>/dev/fb0, /dev/fb1 &#x2026; =&gt; <a href="https://www.kernel.org/doc/Documentation/fb/framebuffer.txt">Framebuffer</a> - allows user-space
applications to control the graphics card and draw on the
screen by just writing to a file. The framebuffer is the
lowest level GUI in Linux kernel. Most embedded linux
applications draw directly on framebuffer without X11
(X-Windows System).</li>
</ul></li>

<li>Linux Device Files not associated to hardware:
<ul class="org-ul">
<li>/dev/kmsg =&gt; pseudo-text file containing kernel messages.</li>
<li>/dev/stdout =&gt; Console stdout</li>
<li>/dev/stdin  =&gt; Console stdin</li>
<li>/dev/stderr =&gt; Console stderr</li>
<li>/dev/random =&gt; file which generate random numbers</li>
<li>/dev/urandom</li>
<li>/dev/null   =&gt; File used to discard stdout or stderr of
command line applications.</li>
<li>/dev/zero</li>
</ul></li>
</ul></li>
</ul>

<p>
<b>See also</b> 
</p>

<p>
General Unix Concepts: 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Unix">Unix concept</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix-like">Unix-like operating systems</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX - Portable Operating System Interface</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix_philosophy">Unix philosophy</a></li>

<li><a href="https://en.wikipedia.org/wiki/Unix_shell">Unix Shell Scripting</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Symbolic_link">Symbolic Link / symlink</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Pipeline, Pipes - IPC (Inter Process Communication)</a></li>

<li><a href="https://www.bottomupcs.com/file_descriptors.xhtml">Unix File Descriptors</a></li>

<li><a href="https://en.wikipedia.org/wiki/File_descriptor">File Descriptors</a></li>

<li><a href="https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/12_FileSystemImplementation.html">Operating Systems - File System Implementation</a></li>
</ul>

<p>
Papers and mail lists: 
</p>

<ul class="org-ul">
<li><a href="https://people.eecs.berkeley.edu/~brewer/cs262/unix.pdf">The UNIX Time Sharing System</a> - Dennis M. Ritchie and Ken Thompson - Bell Laboratories</li>

<li><a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix03/tech/freenix03/full_papers/appavoo/appavoo_html/node18.html">Files, file descriptors, and name space</a></li>

<li><a href="https://yarchive.net/comp/linux/everything_is_file.html">Linux kernel mail list discussion - Everything is a file</a></li>
</ul>

<p>
Usage of <span class="underline">Linux Device Files</span> for controlling hardware (reading Sensors
and manipulating actuators):
</p>

<ul class="org-ul">
<li><a href="https://unix.stackexchange.com/questions/101759/difference-between-device-file-and-device-drivers">Difference between Device file and device drivers</a></li>

<li><a href="http://ibgwww.colorado.edu/~lessem/psyc5112/usail/peripherals/devices/devintro.html">Introduction to device drivers and device nodes</a></li>

<li><a href="https://thehackerdiary.wordpress.com/2017/04/21/exploring-devinput-1/">The hacker diary - exploring /dev/input</a> =&gt; Shows how to read the
device file /dev/input/mice which contains mouse information such
as position and buttons state.</li>

<li><a href="https://www.ics.com/blog/how-control-gpio-hardware-c-or-c">How to Control GPIO Hardware from C or C++</a>
<ul class="org-ul">
<li>Note: It only works in PCs with <span class="underline">industrial IO cards</span> or systems
with SOC processors (System-On-Chip) with GPIO devices; SBC -
Single Board Computers, which are PCBs - printed circuit boards
containin SOC microprocessors or MCU - Microcontrollers and all
necessary supporting ICs (Integrated Circuits) such as RAM
memory chips; flash memory chips; voltage regulators; USB
connectors; &#x2026;</li>
</ul></li>

<li><a href="https://blog.mbedded.ninja/programming/operating-systems/linux/linux-serial-ports-using-c-cpp/">Linux Serial Ports Using C/C++</a></li>

<li><a href="https://stackoverflow.com/questions/6947413/how-to-open-read-and-write-from-serial-port-in-c">How to open, read, and write from serial port in C?</a></li>

<li><a href="https://www.iot-programmer.com/index.php/books/22-raspberry-pi-and-the-iot-in-c/chapters-raspberry-pi-and-the-iot-in-c/57-raspberry-pi-and-the-iot-in-c-sysfs-the-linux-way-to-gpio?start=1">Raspberry Pi And The IoT In C - SYSFS The Linux Way To GPIO</a></li>
</ul>


<p>
Terminal Emulation and Serial Console
</p>

<ul class="org-ul">
<li><a href="https://www.ttwin.com/blog/270-history-terminal-emulation">A Brief History of Terminal Emulation</a></li>

<li><a href="https://en.wikipedia.org/wiki/VT100">DEC VT100 CRT Terminal</a></li>

<li><a href="https://en.wikipedia.org/wiki/Computer_terminal">Computer Terminal</a></li>

<li><a href="https://www.kernel.org/doc/html/v4.15/admin-guide/serial-console.html">Linux Kernel Docs / Linux Serial Console</a></li>

<li><a href="https://www.tldp.org/HOWTO/Remote-Serial-Console-HOWTO/intro-why.html">Remote Serial Console HOWTO Prev / Chapter 1. Introduction</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Working_with_the_serial_console">Arch Linux / Working with the serial console</a></li>

<li><a href="https://elinux.org/Serial_console">Elinux - Serial Console</a></li>

<li><a href="https://bootlin.com/doc/legacy/serial-drivers/linux-serial-drivers.pdf">Bootlin - Linux Serial Driver</a></li>

<li><a href="https://developer.toradex.com/knowledge-base/how-to-disable-enable-debug-messages-in-linux">Configuring Serial Port Debug Console (Linux/U-Boot)</a></li>

<li><a href="https://wiki.alpinelinux.org/wiki/Enable_Serial_Console_on_Boot">Alpine Linux - Enable Serial Console</a></li>

<li><a href="https://www.linuxjournal.com/article/7206">Linux Serial Consoles for Servers and Clusters</a></li>

<li><a href="https://roll.urown.net/server/serial-console.html">Roll Your Own Network / Serial Console</a> (for servers, data-centers)</li>
</ul>
</div>
</div>

<div id="outline-container-orgeb0b819" class="outline-3">
<h3 id="orgeb0b819"><span class="section-number-3">1.2</span> Creating Portable Binaries for Linux / GLIBC hell</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orgaff806f" class="outline-4">
<h4 id="orgaff806f"><span class="section-number-4">1.2.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
One of the greatest challenges of Linux desktop is building and
deploying portable applications and native executable which work on
any Linux distribution. Even if an application totally statically
linked against all dependencies or it is bundled with all its shared
libraries dependencies via LD_LIBRARY_PATH environment variable or
RPATH, the program may still fail to run in other Linux distribution
due to the GLIBC (GNU C library runtime) dependency. A GLIBC is <span class="underline">forward</span>
<span class="underline">compatible</span>, but not <span class="underline">backward compatible</span>, the GLIBC runtime failure is
more likely to happen if the application was built on a Linux
distribution using a newer version of GLIBC, but the program is
deployed in a distribution using an older version of GLIBC.
</p>

<ul class="org-ul">
<li>Side Note 1:
<ul class="org-ul">
<li>Applications built with GO (Golang) programming
language are less likely to be affected by the GLIBC-issue, as GO
compiler often does not link against the GLIBC and builds
statically linked binaries which can be deployed everywhere.</li>
</ul></li>

<li>Side Note 2:
<ul class="org-ul">
<li>The GLIBC issue do not only affect C++, all programming
languages which generates native Linux executables, for
instance, D-lang, Rust, OCaml, Haskell are also affected
by the GLIBC compability problem.</li>
</ul></li>

<li>Side Note 3:
<ul class="org-ul">
<li>Even <a href="https://appimage.org/">AppImage</a>, which is a solution for distributing binaries on
Linux is affected by the GLIBC-problem. As a result, the
AppImage documentation recommends building AppImage on Linux
distributions with older versions of GlibC.</li>
</ul></li>
</ul>

<p>
Possible Solutions: 
</p>

<ol class="org-ol">
<li>Link against an older version of GLIBC
<ul class="org-ul">
<li>Build the application in a system with the oldest possible version
of GLIBC. <span class="underline">System</span> in this context means: a linux virtual machine; a
chroot environment or a docker image with an older version of
GLIBC.</li>
</ul></li>

<li>Link against MUSL (CRT - C Runtime Library)
<ul class="org-ul">
<li>The MUSL library, is an alternative to GLIBC, which was
designed for embedded systems and static linking, allows
building statically linked binaries that does not suffer from
the GLIBC compatibility problems. The drawback of this
procedure is that dynamic loading with <span class="underline">dlopen</span> API (dlopen,
dlclose, dlsym functions) is still not supported.</li>
</ul></li>

<li>Deploy via Docker
<ul class="org-ul">
<li>Deploy the application via docker image. While this solution is
acceptable for compilers, building environments, servers and
command line applications, Docker is not suitable for games or
Desktop GUI (Graphical User Interface) applications intended
to be used by non-technical users.</li>
<li>Advantage:
<ul class="org-ul">
<li>Pack application, dependencies and configuration.</li>
<li>The deployment environment can be reproduced everywhere.</li>
</ul></li>
</ul></li>

<li>Distribute as source and recompile from source on every
deployment machine.</li>

<li>Distribute the application via Linux distribution repositories
<ul class="org-ul">
<li>Distribute the application via official Linux distribution
repositories by creating distribution-specific packages for
every supported distribution. It means creating (.deb) Debian packages for
Debian-based distributions; (.rpm) packages for Fedora and
Centos; (.apk) alpine packages for Alpine.</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org56c9bae" class="outline-4">
<h4 id="org56c9bae"><span class="section-number-4">1.2.2</span> The GLIBC Problem</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
<b>GLIBC - Problem Illustration with a Sample Project</b> 
</p>

<p>
GIST Containing all files used in this experiment: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">https://gist.github.com/0557cd0fa1d5370723b015e443a7c036</a></li>
</ul>

<p>
File: Makefile
</p>

<div class="org-src-container">
<pre class="src src-make">build:
        cmake --config Debug -H. -B_build2
        cmake --build _build2 --target 
</pre>
</div>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment">#========== Targets Configurations ============#</span>
        <span class="org-function-name">add_executable</span>( filesys filesys.cpp )
<span class="org-function-name">target_link_libraries</span>( filesys stdc++fs)
</pre>
</div>

<p>
File: filesys.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iterator</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Range</span>, <span class="org-keyword">typename</span> <span class="org-type">Function</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">dotimes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span>, <span class="org-type">Range</span>&amp;&amp; <span class="org-variable-name">iterable</span>, <span class="org-type">Function</span> <span class="org-variable-name">fun</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0;
    <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = <span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">end</span> = <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>i &lt; n &amp;&amp; it != end <span class="org-rainbow-delimiters-depth-2">){</span>
            fun<span class="org-rainbow-delimiters-depth-3">(</span>it<span class="org-rainbow-delimiters-depth-3">)</span>;
            ++it;
            i++;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
     dotimes<span class="org-rainbow-delimiters-depth-2">(</span>10, <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-3">)</span>,
             <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span>
                  <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p-&gt;path<span class="org-rainbow-delimiters-depth-4">()</span>;
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                            &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>0<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-4">()</span>.string<span class="org-rainbow-delimiters-depth-4">()</span>
                            &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>35<span class="org-rainbow-delimiters-depth-4">)</span>
                            &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>40<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path
                            &lt;&lt; <span class="org-constant">std</span>::endl;               
             <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Steps for reproducing the problem</b> 
</p>

<p>
STEP 1: Get current machine infomation. 
</p>

<ul class="org-ul">
<li>GLIBC Version is: 2.34-2.fc32</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Current machine </span>
$ cat /etc/fedora-release 
Fedora release 32 (Thirty Two)

<span class="org-comment-delimiter"># </span><span class="org-comment">Current GLIBC Version </span>
$ ld --version
GNU ld version 2.34-2.fc32
... ... ... ... 
</pre>
</div>

<p>
STEP 2: Build the application. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake --config Debug -H. -B_build1
$ cmake --build _build1 --target 

$ file _build1/filesys 
<span class="org-function-name">_build1/filesys</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, 
interpreter /lib64/ld-linux-x86-64.so.2, <span class="org-variable-name">BuildID</span>[sha1]=d1a3628f794c66bcfb29303cfa4a528910f4e3e2
, for GNU/Linux 3.2.0, not stripped
</pre>
</div>

<p>
STEP 3: Run in the current machine (newer version of GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build1/filesys 

 ===== Listing directory /etc =====
chrony.conf                       <span class="org-string">"/etc/chrony.conf"</span>
xl2tpd                            <span class="org-string">"/etc/xl2tpd"</span>
group                             <span class="org-string">"/etc/group"</span>
profile.d                         <span class="org-string">"/etc/profile.d"</span>
kde4rc                            <span class="org-string">"/etc/kde4rc"</span>
resolv.conf.8LUAL0                <span class="org-string">"/etc/resolv.conf.8LUAL0"</span>
geoclue                           <span class="org-string">"/etc/geoclue"</span>
bash_completion.d                 <span class="org-string">"/etc/bash_completion.d"</span>
cups                              <span class="org-string">"/etc/cups"</span>
mime.types                        <span class="org-string">"/etc/mime.types"</span>
</pre>
</div>

<p>
STEP 4: Attempt to run the binary in a distribution using an older
version of GLIBC. The distribution used was a QEMU-KVM virtual
machine running MX-Linux 19.2, distribution based on Debian, with
GLIBC version .
</p>

<p>
GLIBC Failure on MX-Linux Virtual Machine: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">---------- Failure!! GLIC Incompa ------------------------------------#</span>
 $ _build1/filesys 
 _build1/filesys: /lib/x86_64-linux-gnu/libstdc++.so.6: version 
  <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)
</pre>
</div>

<p>
Virtual Machine Information: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">----------- Machine Info (MX Linux 19.2) -------------#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kernel version </span>
$ uname -r
4.19.0-9-amd64

<span class="org-comment-delimiter"># </span><span class="org-comment">Distro name </span>
$ cat /etc/issue 
Welcome to MX 19.2 (patito feo) 64-bit! Powered by Debian.
... ... ... ... ............ .... ... ... .. 

$ ld --version
GNU ld (GNU Binutils for Debian) 2.31.1
... ... ... ... ... ... ... ... ... ... ... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf0f33b" class="outline-4">
<h4 id="orgaf0f33b"><span class="section-number-4">1.2.3</span> Solution 1 - via linking against older GLIBC</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
As GLIBC is <span class="underline">forward compatible</span>, but not <span class="underline">backward compatible</span>. The
solution for this issue is to build the application on a <span class="underline">system</span> with
the oldest possible version of GLIBC. System in this context, means: a
Linux virtual machine; a Chroot environment; or Docker image with an
older version of GLIBC. Other alternative is to replace GLIBC with
<span class="underline">MUSL</span> CRT (C Runtime library), but the drawback is that MUSL does not
support dynamic loading (_dlopen_, <span class="underline">dlsym</span> APIs). 
</p>

<p>
The solution adopted for solving this issue was to use a Docker image
based on <a href="https://github.com/phusion/holy-build-box">holy-build-box</a>, which is a Docker image based on Centos 6
Linux distribution containing a modern version of GCC compiler, CMake
and an older version of GLIBC.
</p>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/phusion/holy-build-box">https://github.com/phusion/holy-build-box</a></li>
</ul>

<p>
<span class="underline">File: Dockerfile</span> (Available at <a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">gist url</a>)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ docker run -it --rm -v $PWD:/work -w /work phusion/holy-build-box-64:latest bash </span>
FROM phusion/holy-build-box-64:latest

ENTRYPOINT [ <span class="org-string">"/hbb_exe/activate-exec"</span>, <span class="org-string">"bash"</span>  ]
</pre>
</div>

<p>
Build docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run at the directory where is Dockerfile </span>
$ docker build -f Dockerfile -t linux-build . 
</pre>
</div>

<p>
Enter in the docker image shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd linux-build 
Holy build box activated
<span class="org-function-name">Prefix</span>: /hbb_exe
<span class="org-function-name">CFLAGS/CXXFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++
<span class="org-function-name">STATICLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++

[root@88c9630a2008 cwd]# ls
_build1  CMakeLists.txt   Dockerfile   filesys.cpp   Makefile
</pre>
</div>

<p>
Building the application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@88c9630a2008 cwd]# make 
cmake --config Debug -H. -B_build2
-- Configuring done
-- Generating done
-- Build files have been written to: /cwd/_build2
cmake --build _build2 --target 
<span class="org-function-name">gmake</span>[<span class="org-compilation-line-number">1</span>]: Entering directory <span class="org-string">'/cwd/_build2'</span>
/hbb/bin/cmake -S/cwd -B/cwd/_build2 --check-build-system CMakeFiles/Makefile.cmake 0
... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 

[root@88c9630a2008 cwd]# ls _build2
CMakeCache.txt  CMakeFiles  cmake_install.cmake  filesys  Makefile
</pre>
</div>

<p>
Running the application _build2/filesys in MX-Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Built on Fedora 32 with newer version of GLIBC [FAILURE]</span>
$ _build1/filesys
<span class="org-function-name">_build1/filesys</span>: /lib/x86_64-linux-gnu/libstdc++.so.6: 
version <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)


<span class="org-comment-delimiter"># </span><span class="org-comment">Built on Centos6 docker with older version of GLIBC [OK, WORKS]</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------</span>
$ _build2/filesys

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb5fa7a7" class="outline-4">
<h4 id="orgb5fa7a7"><span class="section-number-4">1.2.4</span> Solution 2 - via linking against MUSL libC</h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
Other alternative to avoid the GLIBC dependency problem is to build
the application statically linking against <a href="https://www.musl-libc.org/">MUSL - LibC</a> which is an CRT
(C runtime library), initially developed for embedded systems, but that has
become an alternative to GLIBC. The easiest way to build statically
linking against MUSL is to use an Alpine docker image: 
</p>

<ul class="org-ul">
<li>Note: CRT - is a central component of Unix-like operating
systems. It encapsulates system-calls and other operating system
services for user-space applications.</li>
</ul>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Musl">Musl - Wikipedia</a></li>
<li><a href="https://wiki.debian.org/musl">Musl - Debian</a></li>
<li><a href="https://www.arangodb.com/2018/04/static-binaries-c-plus-plus-application/">Static Binaries for a C++ Application - ArangoDB</a></li>
<li><a href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/musl-support-for-fully-static-binaries.html">MUSL support for fully static binaries - Rust Docs</a></li>
<li><a href="http://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a></li>
<li><a href="https://elinux.org/images/8/8b/Room_For_Cooperation-_Bionic_and_musl.pdf">Elinux/Linaro - Bionic and musl - room for cooperation?</a></li>
</ul>

<p>
File: MuslBuilder.docker (<a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">Available at gist</a>)
</p>

<div class="org-src-container">
<pre class="src src-docker">FROM alpine:latest
RUN apk add musl cmake make g++
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<p>
Buildilg the docker containing MUSL and development tools:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 &amp;&amp; <span class="org-builtin">cd</span> gist 
$ docker build -f MuslBuilder.docker -t musl-builder . 
</pre>
</div>

<p>
Running a container of this docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -it --rm -v $(<span class="org-sh-quoted-exec">pwd</span>):/cwd -w /cwd -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) musl-builder 
/cwd $ cmake --config Debug -H. -B_build-musl -DCMAKE_EXE_LINKER_FLAGS=<span class="org-string">"-static -Os"</span>
/cwd <span class="org-comment-delimiter"># </span><span class="org-comment">cmake --build _build-musl --target </span>
</pre>
</div>

<p>
Exiting from the container and check the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ du -h _build-musl/filesys 
8.7M    _build-musl/filesys
8.7M    total

$ file _build-musl/filesys 
<span class="org-function-name">_build-musl/filesys</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
, statically linked, with debug_info, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check dependencies </span>
$ ldd _build-musl/filesys 
        statically linked
</pre>
</div>

<p>
Attempt to run from MX-Linux 19.2 (Older GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-musl/filesys 

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org54d3407" class="outline-3">
<h3 id="org54d3407"><span class="section-number-3">1.3</span> Low level IO functions overview</h3>
<div class="outline-text-3" id="text-1-3">
<p>
C-Library functions which encapsulates file-related systems calls.
</p>

<p>
Headers: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
</pre>
</div>

<p>
<b>Special File Descriptors</b> 
</p>

<ul class="org-ul">
<li>STDOUT_FILENO =&gt; File descritor for stdout (process standard output)</li>
<li>STDERR_FILENO =&gt; File descritor for stderr (process standard error output)</li>
<li>STDIN_FILENO =&gt; File descritor for stdin (process standard input)</li>
</ul>

<p>
<b>Functions</b> 
</p>

<ul class="org-ul">
<li>close() =&gt; Close a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 close</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>open() =&gt; Encapsulates open system call =&gt; Returns a file descritor
number. When fails, it returns (-1) setting the global variable
<span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 open</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>creat() =&gt; Create file
<ul class="org-ul">
<li>Doc: $ man 2 creat</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">creat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<ul class="org-ul">
<li>read() =&gt; Read bytes from a file descriptor into a buffer, returning the
number of bytes read. If there is an error, the functions returns
(-1) setting the global variable <span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 read</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>write() =&gt; Write N bytes from a buffer to a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 write</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4869d6" class="outline-3">
<h3 id="orgc4869d6"><span class="section-number-3">1.4</span> Low level IO - open(), read(), write() syscall functions</h3>
<div class="outline-text-3" id="text-1-4">
<p>
This code demonstrates the usage of the open(), read(), write(),
close() low-level IO library-calls for file descriptors which
encapsulates system-calls with the same name. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae">https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae</a></li>
</ul>

<p>
File: unix-low-level-io.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-keyword">const</span> <span class="org-type">char</span>* 
<span class="org-function-name">errno_to_cstring</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">No such file or directory </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == ENOENT<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"ENOENT"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Operation not permitted </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Onput/Output error </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EIO<span class="org-rainbow-delimiters-depth-2">)</span>    <span class="org-keyword">return</span> <span class="org-string">"EIO"</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EAGAIN<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"EAGAIN"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPIPE<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPIPE"</span>;

    <span class="org-keyword">return</span> <span class="org-string">"&lt;UNKNOWN&gt;"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>   


<span class="org-comment-delimiter">/** </span><span class="org-comment">Check whether file descriptor is regular file */</span>
<span class="org-type">bool</span> <span class="org-function-name">fd_is_regular_file</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>       
     <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
     <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> S_ISREG<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">fd_is_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
    <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> S_ISDIR<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                          <span class="org-string">"\n   =&gt;    errno(str) = %s"</span>
                          <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                          , err, errno_to_cstring<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage:                             \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read a file:                \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file &lt;FILE&gt;                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read stdin (console input): \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file -stdin                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> 0;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Compare two c-strings return 0 (zero) when they are equal.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">int strcmp(const char *s1, const char *s2)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"file"</span><span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Expected command file. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Variable for holding a file descriptor </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">The library-call open() attempts to open a file  and returns a "file-descriptor" </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(integer number ) when the operation is successful. The library-call </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">returns (-1) when the operation fails. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It encapsulates the 'open' system call. </span>
    <span class="org-comment-delimiter">//  </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"-stdin"</span><span class="org-rainbow-delimiters-depth-3">)</span> == 0<span class="org-rainbow-delimiters-depth-2">)</span>
            fd = STDIN_FILENO; 
    <span class="org-keyword">else</span> 
            fd = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Get error flag 'errno' to get more details about current error.</span>
            <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr ,<span class="org-string">" [ERROR] Failed to open file. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is regular file = %s \n"</span>
                              , fd_is_regular_file<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is directory file = %s \n"</span>
                              , fd_is_directory<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;                
    <span class="org-comment-delimiter">// </span><span class="org-comment">Flush file =&gt; Force changes to be immeditely written.</span>
    <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stdout<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer maximum size in bytes </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_MAX_SIZE</span> = 200;     
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Stream BUFFER_MAX_SIZE bytes from file descriptor </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to STDOUT_FILENO (file descriptor).</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">ret</span>; 
    <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            ret = read<span class="org-rainbow-delimiters-depth-3">(</span>fd, buffer, BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;        
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ret == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                    <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno; 
                    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] An error has happened =&gt; "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                    print_errno_details<span class="org-rainbow-delimiters-depth-4">(</span>err<span class="org-rainbow-delimiters-depth-4">)</span>;
                    close<span class="org-rainbow-delimiters-depth-4">(</span>fd<span class="org-rainbow-delimiters-depth-4">)</span>;
                    <span class="org-keyword">return</span> EXIT_FAILURE;
            <span class="org-rainbow-delimiters-depth-3">}</span>       
            ::write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, ret<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> ret != 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close the file descriptor.</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-low-level-io.cpp -o <span class="org-keyword">unix-low-level-io.bin</span> -std=c++1z -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<ul class="org-ul">
<li>Run 1</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin 
[INFO] Program started. 
<span class="org-function-name">Usage</span>:                             
 =&gt; To read a file:                
   $ ./unix-low-level-io.bin file &lt;FILE&gt;                
 =&gt; To read stdin (console input): 
   $ ./unix-low-level-io.bin file -stdin                
</pre>
</div>

<ul class="org-ul">
<li>Run 2:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-low-level-io.bin file /proc/filesystems 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
nodev   sysfs
nodev   tmpfs
nodev   bdev
nodev   proc
nodev   cgroup
nodev   cgroup2
... ... ... 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/resolv.conf 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
<span class="org-comment-delimiter"># </span><span class="org-comment">Generated by NetworkManager</span>
nameserver 194.165.12.10
</pre>
</div>

<ul class="org-ul">
<li>Run 3: (Error)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin file /etc/resosad
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 2
  =&gt;    errno(str) = ENOENT
  =&gt; errno message = No such file or directory 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/shadow
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 13
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Permission denied 

$ &gt;&gt; ./unix-low-level-io.bin file /
[INFO] Program started. 
[INFO] ?? File is regular file = FALSE 
[INFO] ?? File is directory file = TRUE 
[ERROR] An error has happened =&gt; 
  =&gt;    errno(int) = 21
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Is a directory 
</pre>
</div>

<ul class="org-ul">
<li>Run 4 - read stdin file descriptor <span class="underline">STDIN_FILENO</span></li>
</ul>

<pre class="example">
 $ &gt;&gt; ./unix-low-level-io.bin file -stdin
 [INFO] Program started. 
 [INFO] ?? File is regular file = FALSE 
 [INFO] ?? File is directory file = FALSE 


Hello world
Hello world
 Unix-linux file descriptors - Low level IO
 Unix-linux file descriptors - Low level IO

# User types Ctrl+D to close STDIN 
</pre>
</div>
</div>

<div id="outline-container-org97dccdd" class="outline-3">
<h3 id="org97dccdd"><span class="section-number-3">1.5</span> Low level IO - creat()</h3>
<div class="outline-text-3" id="text-1-5">
<p>
Creates a file using Unix-low level IO function creat() which
encapsulates the creat() system-call.
</p>

<p>
File: unix-creat.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">File is created with read, write permissions for owner </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">,groups and others</span>
    <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span> = S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = creat<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/tmp/my-sample-file.txt"</span>, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd  == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fill the whole buffer with '\0' null char characters</span>
    memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'\0'</span>, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">strcpy =&gt; Copy string literal to buffer. </span>
    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 0] Write this message to buffer\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer content = '%s' \n"</span>, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Ruires: #include &lt;string&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                              <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-creat.cpp -o <span class="org-keyword">unix-creat.bin</span> -std=c++1z -Wall -Wextra -g 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-creat.bin 
 Buffer size (non blank chars) = 39 
 Buffer size (non blank chars) = 44 
 Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span>
</pre>
</div>

<p>
Content of generated file: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; cat /tmp/my-sample-file.txt 
[LINE 0] Write this message to buffer
[LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX
[LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX
</pre>
</div>

<p>
Trace library-calls with <span class="underline">ltrace</span> application: 
</p>

<ul class="org-ul">
<li>$ ltrace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ltrace ./unix-creat.bin

<span class="org-function-name">_ZNSt8ios_base4InitC1Ev</span>(0x4040a9, 0xffff, 0x7ffcfe326598, 224) = 0
<span class="org-function-name">__cxa_atexit</span>(0x4010e0, 0x4040a9, 0x402008, 6)                  = 0
<span class="org-function-name">creat</span>(0x402010, 420, 0x7ffcfe326598, 256)                      = 3
<span class="org-function-name">memset</span>(0x7ffcfe326280, <span class="org-string">'\0'</span>, 500)                              = 0x7ffcfe326280
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 39 Buffer size (non blank chars) = 39 
) = 37
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39)            = 39
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 44 Buffer size (non blank chars) = 44 
) = 37
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer content = '%s' \n"</span>, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>... Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span> 
) = 66
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44)            = 44
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>...)                  = 50
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50)            = 50
<span class="org-function-name">close</span>(3)                                                       = 0
<span class="org-function-name">_ZNSt8ios_base4InitD1Ev</span>(0x4040a9, 0, 0x4010e0, 1)              = 0x7f95f2965e40
+++ exited (status 0) +++

</pre>
</div>

<p>
Trace system-calls with <span class="underline">strace</span> application: 
</p>

<ul class="org-ul">
<li>$ strace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ strace ./unix-creat.bin 

<span class="org-function-name">execve</span>(<span class="org-string">"./unix-creat.bin"</span>, [<span class="org-string">"./unix-creat.bin"</span>], 0x7fff489b8e40 /* 83 vars */) = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">arch_prctl</span>(0x3001 /* ARCH_??? */, 0x7fff751bd910) = -1 EINVAL (Invalid argument)
<span class="org-function-name">access</span>(<span class="org-string">"/etc/ld.so.preload"</span>, R_OK)      = -1 ENOENT (No such file or directory)
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...

<span class="org-function-name">mprotect</span>(0x7fed4e032000, 4096, PROT_READ) = 0
<span class="org-function-name">munmap</span>(0x7fed4dfe4000, 136250)          = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">brk</span>(0x59d000)                           = 0x59d000
<span class="org-function-name">creat</span>(<span class="org-string">"/tmp/my-sample-file.txt"</span>, 0644)  = 3
<span class="org-function-name">fstat</span>(1, {<span class="org-variable-name">st_mode</span>=S_IFCHR|0620, <span class="org-variable-name">st_rdev</span>=makedev(0x88, 0xc), ...}) = 0
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39) = 39
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer content = ' [LINE 1] Uni"</span>..., 63) = 63
<span class="org-function-name">write</span>(1, <span class="org-string">"' \n"</span>, 3)                     = 3
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44) = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50) = 50
<span class="org-function-name">close</span>(3)                                = 0
<span class="org-function-name">exit_group</span>(0)                           = ?
+++ exited with 0 +++
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbde6cb7" class="outline-3">
<h3 id="orgbde6cb7"><span class="section-number-3">1.6</span> Information about current process</h3>
<div class="outline-text-3" id="text-1-6">
<p>
File: current-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">PATH_MAX constant (macro)</span>

<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Unique process ID (identifier) number </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">PID for parent process</span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getppid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"\n Change the curren directory to /etc \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    set_cwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It only works on Linux. The directory /proc/self is a pseudo-directory </span>
    <span class="org-comment-delimiter">//       </span><span class="org-comment">whith pseudo-files containing information about the current process. </span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">the file /proc/self/exe is a symbolic link to the current executable.</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_file</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/exe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Absolute Path of current executable = %s \n"</span>, exe_file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_dir</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/cwd"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Current directory of this executable = %s \n"</span>, exe_dir.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] Finish Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Functions Implementations ------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Get current working directory of current process */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>* <span class="org-variable-name">buffer</span> = ::getcwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">cwd</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note buffer was allocated with malloc </span>
    free<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> cwd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Set current working directory for current process. */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = ::chdir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>status &lt; 0<span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Failed to change directory."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Read value of symbolic link </span>
<span class="org-comment"> *  </span>
<span class="org-comment"> * Requires: &lt;limits.h&gt;, &lt;sys/types.h&gt;, &lt;sys/stats.h&gt;</span>
<span class="org-comment"> */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: %s \n"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>errno<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to read symlink. Check 'errno' variable"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ current-process.cpp -o <span class="org-keyword">current-process.elf</span> -Wall -Wextra -ggdb
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./current-process.elf 
  =&gt; Process PID = 719155 
  =&gt; Process PID = 678179 
  =&gt; Current directory = /home/mxpkf8/temp-projects/unix-explore 

Change the curren directory to /etc 
  =&gt; Current directory = /etc 
 =&gt; Absolute Path of current executable = /home/mxpkf8/temp-projects/unix-explore/current-process.elf 
 =&gt; Current directory of this executable = /etc 
[INFO] Finish Ok.
</pre>
</div>
</div>
</div>

<div id="outline-container-org74199fd" class="outline-3">
<h3 id="org74199fd"><span class="section-number-3">1.7</span> Dynamic Loading Shared Libraries / dlopen() API</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-orgeab836a" class="outline-4">
<h4 id="orgeab836a"><span class="section-number-4">1.7.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
The dlopen API provide access to the <span class="underline">dynamic linker</span> services allowing
the current process to load and unload shared objects or shared
libraries in its address space (virtual memory).
</p>

<p>
This API for loading shared libraries is not only available on Linux,
it also can be found in FreeBSD, NetBSD, MacOSX, Android and so on.
</p>

<p>
Use cases: 
</p>

<ul class="org-ul">
<li>Load new code at-runtime</li>

<li>Load third-party code a runtime</li>

<li>Plugin systems, extensions or addons.</li>

<li>Load native code extensions in languages with interpreters written
in C, such as Python, Ruby, Lua and so on. Note: Python native
extensions are shared libraries.</li>
</ul>

<p>
The Dlopen() API is available on most Unix-like operating systems,
such as: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>MacOSX</li>
<li>FreeBDS</li>
<li>NetBSD</li>
<li>OpenBSD</li>
<li>QNX</li>
</ul>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="http://gnu.wiki/man3/dlopen.3.php">http://gnu.wiki/man3/dlopen.3.php</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/dlopen.3.html">Dlopen API - Linux Manpages</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dlopen&amp;apropos=0&amp;sektion=0&amp;manpath=SuSE+Linux%2Fi386+7.3&amp;format=html">Free BSD - dlopen API documentation</a></li>

<li><a href="https://docs.oracle.com/cd/E19048-01/chorus5/806-7014/6jftsjfdq/index.html">Dlopen - Oracle Documentation</a></li>

<li><a href="http://www.qnx.com/developers/docs/6.5.0SP1.update/com.qnx.doc.neutrino_lib_ref/d/dlopen.html">Dlopen - QNX documentation</a></li>

<li><a href="https://dwheeler.com/program-library/Program-Library-HOWTO/x172.html">Dynamically Loaded (DL) Libraries</a></li>
</ul>


<p>
Further Reading: 
</p>

<ul class="org-ul">
<li><a href="https://cseweb.ucsd.edu/~gbournou/CSE131/the_inside_story_on_shared_libraries_and_dynamic_loading.pdf">Inside the history on shared libraries and dynamic loading</a></li>

<li><a href="https://hackaday.com/2018/07/12/its-all-in-the-libs-building-a-plugin-system-using-dynamic-loading/">It 's all in the libs - Building a Plugin system using Dynamic Loading</a></li>

<li><a href="http://docencia.ac.upc.edu/FIB/USO/Bibliografia/unix-c-libraries.html">Building And Using Static And Shared "C" Libraries</a></li>

<li><a href="https://www.informit.com/articles/article.aspx?p=22435">More Shared Libraries-Dynamic Loading and Unloading</a></li>

<li><a href="https://grugq.github.io/docs/subversiveld.pdf">https://grugq.github.io/docs/subversiveld.pdf</a></li>

<li><a href="https://github.com/mgood7123/universal-dynamic-loader">universal-dynamic-loader</a> for Linux - "min-dl: minimal dynamic linker implementation"</li>
</ul>


<p>
Headers and libraries: 
</p>

<ul class="org-ul">
<li>Header:  #include &lt;dlfcn.h&gt;</li>
<li>Linking: (-ldl) flag</li>
</ul>

<p>
<span class="underline">Function dlopen()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlopen</li>
<li>Loads a shared library and returns a <span class="underline">handle</span> or <span class="underline">opaque pointer</span>
casted as void pointer. The term <span class="underline">opaque</span> means that the
implementation is hidden and the pointer is only meant to be
passed around to other functions.</li>
<li>Note: When this function fails, it returns null pointer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlsym</li>
<li>Obtains address of a shared library symbol from <span class="underline">handle</span> (from
dlopen).</li>
<li>Params:
<ul class="org-ul">
<li>handle =&gt; Shared library handle obtained from <span class="underline">dlopen</span></li>
<li>symbol  =&gt; Name of symbol to be loaded.</li>
</ul></li>
<li>Return:
<ul class="org-ul">
<li>Address of symbol casted as void*. It can be a function-pointer
or a pointer to global variable. If the symbol is not found, the
function returns a null pointer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlvsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlvsym
<ul class="org-ul">
<li>Loads a specific version of a symbol.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlclose()</span>: 
</p>

<ul class="org-ul">
<li>Doc: $ man dlclose()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlerror()</span> 
</p>
<ul class="org-ul">
<li>Obtaines error messages from dlopen API.</li>
<li>Doc: $ man dlerror()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">dlerror</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Simplified type signatures with a C++-friendly notation</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">HND</span>  <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>   <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>  <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Usage example</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">void</span> <span class="org-function-name">load_library</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Load shared library </span>
    <span class="org-type">HND</span> <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/path/to/shared-library.so"</span>, RTLD_LAZY | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [ERROR] "</span> &lt;&lt; dlerror<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to load shared library"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load symbol </span>
    <span class="org-type">SYM</span> <span class="org-variable-name">hsym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"name_of_function"</span><span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">if(!hsym)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hsym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: symbol not found"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in modern C++ </span>
    <span class="org-comment-delimiter">//  </span><span class="org-comment">=&gt; Note: The function to be loaded can only have C-linkage. </span>
    <span class="org-keyword">using</span> <span class="org-type">name_of_function_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in old C++ (C++98)</span>
    <span class="org-keyword">typedef</span> <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;       

    <span class="org-keyword">auto</span> <span class="org-variable-name">name_of_function_ptr</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call loaded function (Function pointer)</span>
    name_of_function_ptr<span class="org-rainbow-delimiters-depth-2">(</span>100, 2.51, <span class="org-string">"string"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unload shared library </span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb67e3c2" class="outline-4">
<h4 id="orgb67e3c2"><span class="section-number-4">1.7.2</span> GTK3/GTK2 GUI using dynamic loading - low level</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
The following sample code is a GTk3 or GTK2 GUI graphical user
interface application with GTK functions loaded from a GTK shared
library, without any compile-time linking. The advantage of this
approach is the greater portability across different versions of GTk
and the ability to switch between GT3 and GT2.
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf">https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf</a></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-sample)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

       <span class="org-function-name">add_executable</span>( gtk-dlopen gtk-dlopen.cpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dlopen dl )   
</pre>
</div>

<p>
File: gtk-dlopen.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Copied from GTK headers ------// </span>
<span class="org-keyword">typedef</span> <span class="org-type">char</span>            <span class="org-type">gchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">short</span>           <span class="org-type">gshort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">long</span>            <span class="org-type">glong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">int</span>             <span class="org-type">gint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">gint</span>            <span class="org-type">gboolean</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">char</span>   <span class="org-type">guchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">short</span>  <span class="org-type">gushort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">long</span>   <span class="org-type">gulong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">int</span>    <span class="org-type">guint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">float</span>           <span class="org-type">gfloat</span>;
<span class="org-keyword">typedef</span> <span class="org-type">double</span>          <span class="org-type">gdouble</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*           <span class="org-type">gpointer</span>;
<span class="org-keyword">typedef</span> <span class="org-keyword">const</span> <span class="org-type">void</span>*     <span class="org-type">gconstpointer</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
    <span class="org-variable-name">GTK_WINDOW_POPUP</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-variable-name">G_CONNECT_AFTER</span>   = 1 &lt;&lt; 0,
  <span class="org-variable-name">G_CONNECT_SWAPPED</span> = 1 &lt;&lt; 1
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">TFun</span> <span class="org-function-name">load_symbol</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">hnd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, symbol.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hSym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [Error] symbol not found: "</span><span class="org-rainbow-delimiters-depth-3">)</span> + symbol;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque type (aka incomplete type)</span>
<span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------- Function Pointers type aliases -------------------//</span>
<span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">gpointer</span> <span class="org-variable-name">instance</span>
                                              , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                              , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                              , <span class="org-type">gpointer</span>        <span class="org-variable-name">data</span>
                                              , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                              , <span class="org-type">GConnectFlags</span>   <span class="org-variable-name">connect_flags</span>
                                          <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-comment-delimiter">//  </span><span class="org-comment">void *dlopen(const char *filename, int flags);</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to shared library </span>
    <span class="org-type">void</span>* <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span>shared_lib.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span> fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"%s\n"</span>, dlerror<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> hnd != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = <span class="org-constant">nullptr</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Load gtk_init_check function pointer ------- // </span>
    hSym = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>hSym != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_init_check</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Load remaining function pointers (symbols) --------// </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">opaque pointer </span>
    <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;

    <span class="org-keyword">using</span> <span class="org-type">gkt_window_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_new</span>  = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gkt_window_new_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_new"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_show</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>*<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_show"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main</span>        = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_set_title</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_widget_set_size_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>*, gint, gint<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_set_size</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_widget_set_size_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_set_size_request"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main_quit</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_signal_connect_data</span> 
          = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">g_signal_connect_data_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"g_signal_connect_data"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">------- Build Window GUI - Graphical User Interface ----------**/</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call function pointer </span>
    gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span> = gtk_window_new<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-constant">GtkWindowType</span>::GTK_WINDOW_TOPLEVEL<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_set_size<span class="org-rainbow-delimiters-depth-2">(</span>window, 400, 500<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_window_set_title<span class="org-rainbow-delimiters-depth-2">(</span>window, <span class="org-string">"My GTK Window"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_show<span class="org-rainbow-delimiters-depth-2">(</span>window<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk_signal_connect_data<span class="org-rainbow-delimiters-depth-2">(</span>  window         <span class="org-comment-delimiter">// </span><span class="org-comment">Widget </span>
                            , <span class="org-string">"destroy"</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Event name </span>
                            , gtk_main_quit  <span class="org-comment-delimiter">// </span><span class="org-comment">Callback                             </span>
                            , <span class="org-constant">nullptr</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to data (closure )</span>
                            , <span class="org-constant">nullptr</span> 
                            , <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GConnectFlags</span><span class="org-rainbow-delimiters-depth-3">)</span> 0 <span class="org-comment-delimiter">// </span><span class="org-comment">GConnect flags </span>
                            <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Window running. OK! "</span> &lt;&lt; <span class="org-string">"\n"</span>;
    gtk_main<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close shared library handler.</span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf &amp;&amp; <span class="org-builtin">cd</span> gist 
$ g++ gtk-dlopen.cpp -o <span class="org-keyword">gtk-dlopen.bin</span> -std=c++1z -ldl -ggdb -Wall -Wextra   
</pre>
</div>

<p>
Checking the dependencies of gtk-dlopen.bin 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ldd gtk-dlopen.bin 
       linux-vdso.so.1 (0x00007ffd23fc4000)
       libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6a78428000)
       libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007f6a78238000)
       libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f6a780f2000)
       libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f6a780d7000)
       libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6a77f0d000)
       /lib64/ld-linux-x86-64.so.2 (0x00007f6a78453000)
</pre>
</div>

<p>
Running: (load GTK shared library /lib64/libgtk-3.so.0)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin 
[INFO] Loading shared library: /lib64/libgtk-3.so.0
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Running: (load GK2 shared library )
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin /usr/lib64/libgtk-x11-2.0.so 
[INFO] Loading shared library: /usr/lib64/libgtk-x11-2.0.so
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Verify exported symbols by gtk3 shared library: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; nm -D /lib64/libgtk-3.so.0 | grep init
       ... ... ... ... ..
       ... ... ... ... ..
       U g_async_initable_new_async
       U g_async_initable_new_finish
       U g_datalist_init
       U g_hash_table_iter_init
       U g_initable_get_type
       U g_initable_new
       U g_initially_unowned_get_type
       U g_mutex_init
       U g_once_init_enter
      ... ... ... ... ..
      ... ... ... ... ..
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb771b9a" class="outline-4">
<h4 id="orgb771b9a"><span class="section-number-4">1.7.3</span> GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</h4>
<div class="outline-text-4" id="text-1-7-3">
<p>
This proof-of-concept code contains a high-level wrapper class
SharedLibrary for abstracting away the dlopen() API. This class is
used for loading GTK3 or GTk2 shared library at runtime and then
showing modal notifications dialogs. The advantage of the dynamic
loading approach is the flexibility, portability and easier deployment
as the binary does not depends on any particular GTK shared library
version.
</p>

<p>
Note: 
</p>

<ul class="org-ul">
<li>The code of the class SharedLibrary can be reused on any other
unix-like operating system with dlopen() API, such as FreeBDS,
NetBSD, MacOSX and so on.</li>

<li>The Windows API for dynamic loading is LoadLibrary(),
GetProcAddress().</li>
</ul>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b">https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b</a></li>
</ul>

<p>
<b>Project Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-dynamic-load-dialog)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment"># ---- TARGETS Configuration ---------------#</span>
       <span class="org-function-name">add_executable</span>( gtk-dialog gtk-dialog.cpp gtk_types.hpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dialog dl ) 
</pre>
</div>

<p>
File: gtk-dialog.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string">"gtk_types.hpp"</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Requires header: &lt;dlfcn.h&gt; and linking flag (-ldl) */</span>
<span class="org-keyword">class</span> <span class="org-type">SharedLibrary</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">using</span> <span class="org-type">HND</span>  = <span class="org-type">void</span>*; 
    <span class="org-keyword">using</span> <span class="org-type">HSYM</span> = <span class="org-type">void</span>*;
<span class="org-function-name">private</span>:
    <span class="org-type">HND</span>         <span class="org-variable-name">m_hnd</span>  = <span class="org-constant">nullptr</span>; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_lib</span> = <span class="org-string">""</span> ; 
    <span class="org-type">int</span>         <span class="org-variable-name">m_flags</span> = 0;
<span class="org-function-name">public</span>:
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){}</span>    
    ~<span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Constructor delegation </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : SharedLibrary<span class="org-rainbow-delimiters-depth-2">(</span>library, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>library, flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor and copy-assignment operator </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move constructor </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move assignment operator </span>
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">HND</span>         <span class="org-function-name">handler</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-type">bool</span>        <span class="org-function-name">is_loaded</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd != <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">library</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_lib; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Retrieve symbol from shared library */</span>
    <span class="org-type">HSYM</span> <span class="org-function-name">symbol_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Get symbol from shared library</span>
<span class="org-comment">     * Note: The caller is resposible for checking if the symbol is (null) nullptr.</span>
<span class="org-comment">     */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Attempts to load symbol and throws exception, if symbol is not found. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol_or_fail</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>sym<span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] Dlopen / dlsym() =&gt; unable find symbol"</span>;
            msg = msg + <span class="org-string">" &lt;"</span> + name + <span class="org-string">"&gt;"</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">load</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        m_lib   = library;
        m_flags = flags;
        m_hnd = dlopen<span class="org-rainbow-delimiters-depth-3">(</span>library.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] DlopenError: "</span>;
            msg = msg + dlerror<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>    

    <span class="org-type">void</span> <span class="org-function-name">reload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">unload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        ::dlclose<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;        
        m_hnd = <span class="org-constant">nullptr</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class SharedLibrary() ---- //</span>

<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">fpointer</span>;
<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">enums</span>;

<span class="org-keyword">struct</span> <span class="org-type">GtkLib</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">SharedLibrary</span> <span class="org-variable-name">slib</span>;

    <span class="org-function-name">GtkLib</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : slib<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-3">(</span>SharedLibrary<span class="org-rainbow-delimiters-depth-4">(</span>library<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        gtk_init_check         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-3">)</span>;       
        gtk_main_quit          = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_main_quit_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main               = slib.symbol_or_fail&lt;void (*) ()&gt;("gtk_main");</span>
        gtk_message_dialog_new = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_message_dialog_new_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_message_dialog_new"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_widget_destroy     = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_widget_destroy_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_widget_destroy"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_dialog_run         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_dialog_run_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_dialog_run"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_window_set_title   = slib.symbol<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">gtk_init_check_t</span>         <span class="org-variable-name">gtk_init_check</span>; 
    <span class="org-type">gtk_main_quit_t</span>          <span class="org-variable-name">gtk_main_quit</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main_t               gtk_main;</span>
    <span class="org-type">gtk_message_dialog_new_t</span> <span class="org-variable-name">gtk_message_dialog_new</span>;
    <span class="org-type">gtk_widget_destroy_t</span>     <span class="org-variable-name">gtk_widget_destroy</span>;
    <span class="org-type">gtk_dialog_run_t</span>         <span class="org-variable-name">gtk_dialog_run</span>;
    <span class="org-type">gtk_window_set_title_t</span>   <span class="org-variable-name">gtk_window_set_title</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Message box notification </span>
    <span class="org-type">void</span> <span class="org-function-name">msgbox</span><span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">title</span>
                , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> 
                , <span class="org-type">GtkMessageType</span> <span class="org-variable-name">mtype</span> = <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO 
                <span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-type">GtkWidget</span>* <span class="org-variable-name">dialog</span> = <span class="org-keyword">this</span>-&gt;gtk_message_dialog_new<span class="org-rainbow-delimiters-depth-3">(</span>  <span class="org-constant">nullptr</span> 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkDialogFlags</span>::GTK_DIALOG_MODAL
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> mtype 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkButtonsType</span>::GTK_BUTTONS_OK
                                                , text.c_str<span class="org-rainbow-delimiters-depth-4">()</span>
                                                <span class="org-rainbow-delimiters-depth-3">)</span>;                                            
        assert<span class="org-rainbow-delimiters-depth-3">(</span> dialog != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;    
        <span class="org-keyword">this</span>-&gt;gtk_window_set_title<span class="org-rainbow-delimiters-depth-3">(</span>dialog, title.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">this</span>-&gt;gtk_dialog_run<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Dialog destroyed OK "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">this</span>-&gt;gtk_widget_destroy<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;   
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>        
    <span class="org-comment-delimiter">// </span><span class="org-comment">User can select his own GTK shared library, if it is not </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">found. He can also select GTK2 shared library. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;   
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk</span> = GtkLib<span class="org-rainbow-delimiters-depth-2">{</span>shared_lib<span class="org-rainbow-delimiters-depth-2">}</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Alwas start the library before calling any GTK function </span>
    gtk.gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"User notification"</span>, <span class="org-string">"Download completed. Ok."</span>,     <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO <span class="org-rainbow-delimiters-depth-2">)</span>;    
    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Runtime error"</span>,     <span class="org-string">"KERNEL PANIC!! Reboot NOW!!"</span>, <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_ERROR <span class="org-rainbow-delimiters-depth-2">)</span>;        

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: gtk_types.hpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ C++ Wrappers for dynamically loading GTK ----- //</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _GTK_TYPES_HPP
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_GTK_TYPES_HPP</span>

<span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">base</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-type">gchar</span>    = <span class="org-type">char</span>;
        <span class="org-keyword">using</span> <span class="org-type">gshort</span>   = <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">glong</span>    = <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">gint</span>     = <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gboolean</span> = gint;
        <span class="org-keyword">using</span> <span class="org-type">guchar</span>   = <span class="org-type">unsigned</span> <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">gulong</span>   = <span class="org-type">unsigned</span> <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">guint</span>    = <span class="org-type">unsigned</span> <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gfloat</span>   = <span class="org-type">float</span>;
        <span class="org-keyword">using</span> <span class="org-type">gdouble</span>  = <span class="org-type">double</span>;
        <span class="org-keyword">using</span> <span class="org-type">gpointer</span> = <span class="org-type">void</span>*;          
        <span class="org-keyword">using</span> <span class="org-type">gconstpointer</span> = <span class="org-keyword">const</span> <span class="org-type">void</span>*;

    <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Opaque Types / incomplete types ---------//</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">widget</span> <span class="org-rainbow-delimiters-depth-2">{</span>        
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWindow</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkDialog</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">namespace</span> <span class="org-constant">enums</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
            <span class="org-variable-name">GTK_WINDOW_POPUP</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">G_CONNECT_AFTER</span> = 1 &lt;&lt; 0,
        <span class="org-variable-name">G_CONNECT_SWAPPED</span>   = 1 &lt;&lt; 1
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkMessageType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_MESSAGE_INFO</span>,
        <span class="org-variable-name">GTK_MESSAGE_WARNING</span>,
        <span class="org-variable-name">GTK_MESSAGE_QUESTION</span>,
        <span class="org-variable-name">GTK_MESSAGE_ERROR</span>,
        <span class="org-variable-name">GTK_MESSAGE_OTHER</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkButtonsType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_BUTTONS_NONE</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK</span>,
        <span class="org-variable-name">GTK_BUTTONS_CLOSE</span>,
        <span class="org-variable-name">GTK_BUTTONS_CANCEL</span>,
        <span class="org-variable-name">GTK_BUTTONS_YES_NO</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK_CANCEL</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkDialogFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_DIALOG_MODAL</span>               = 1 &lt;&lt; 0,
        <span class="org-variable-name">GTK_DIALOG_DESTROY_WITH_PARENT</span> = 1 &lt;&lt; 1,
        <span class="org-variable-name">GTK_DIALOG_USE_HEADER_BAR</span>      = 1 &lt;&lt; 2
        <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Function pointers type aliases  */</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">fpointer</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">base</span>;
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">widget</span>;
        <span class="org-keyword">using</span> <span class="org-constant">enums</span>::<span class="org-type">GConnectFlags</span>;

        <span class="org-keyword">using</span> <span class="org-type">GtkDialogFlags_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkMessageType_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkButtonsType_t</span> = <span class="org-type">int</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_dialog_run_t</span>       = gint <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>* <span class="org-variable-name">dialog</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_widget_destroy_t</span>   = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">widget</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_main_quit_t</span>        = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">gpointer</span>        <span class="org-variable-name">instance</span>
                                                    , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                                    , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                                    , <span class="org-type">gpointer</span>          <span class="org-variable-name">data</span>
                                                    , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                                    , <span class="org-type">GConnectFlags</span> <span class="org-variable-name">connect_flags</span>
                                                    <span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">gtk_message_dialog_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">GtkWindow</span>       *<span class="org-variable-name">parent</span>,
                                                          <span class="org-type">GtkDialogFlags_t</span>  <span class="org-variable-name">flags</span>,
                                                          <span class="org-type">GtkMessageType_t</span>  <span class="org-variable-name">type</span>,
                                                          <span class="org-type">GtkButtonsType_t</span>  <span class="org-variable-name">buttons</span>,
                                                          <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">message_format</span>
                                                        <span class="org-rainbow-delimiters-depth-3">)</span>;


    <span class="org-rainbow-delimiters-depth-2">}</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-preprocessor">#endif</span> 
</pre>
</div>

<p>
Building and running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Download </span>
$ &gt;&gt; git clone https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b gtk-dialog &amp;&amp; <span class="org-builtin">cd</span> gtk-dialog 

<span class="org-comment-delimiter"># </span><span class="org-comment">Configure </span>
$ &gt;&gt; cmake --config Debug -H. -B_build

<span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ &gt;&gt; cmake --build _build --target 

<span class="org-comment-delimiter"># </span><span class="org-comment">Run </span>
$ &gt;&gt; _build/gtk-dialog 
[INFO] Loading shared library: libgtk-3.so.0
[INFO] Dialog destroyed OK 
[INFO] Dialog destroyed OK 
[INFO] Shutdown gracefully. Ok. 

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb6aa8a5" class="outline-3">
<h3 id="orgb6aa8a5"><span class="section-number-3">1.8</span> Launching processes with exec and fork system-call wrappers</h3>
<div class="outline-text-3" id="text-1-8">
<p>
This code demonstrates the usage of exec and fork system-calls wrapper
functions, namely, execvp() and fork() functions. 
</p>

<p>
<b>Relevant functions signature</b> 
</p>

<p>
Fork
</p>
<ul class="org-ul">
<li>Linux Manpage: "fork() creates a new process by duplicating the
calling process.  The new process is referred to as the child
process.  The calling process is referred to as the parent
process."</li>
<li>Note: The function 'fork' is not the system call fork, but a
C wrapper around this sytem call provided by the C runtime
library. (GLIBC - GNU C library in the machine where this was tested.)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">fork</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Execvp (wraps exec system call)
</p>
<ul class="org-ul">
<li>The exec system calls is always called when a new process is
launched/created. It replaces the process image of the current
process with a new one from the launched executable.</li>
<li>Note: In addition to native executables, on Unix-like operating
systems, an executable can also be any scripting file starting
with shebang as first line such as "#!/usr/bin/env sh"</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">execvp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">file</span>, <span class="org-type">char</span> *<span class="org-keyword">const</span> <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Waitpid =&gt; Waits for a state of change of a process.
</p>
<ul class="org-ul">
<li>It can be used for waiting for process termination.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">waitpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-type">int</span> *<span class="org-variable-name">wstatus</span>, <span class="org-type">int</span> <span class="org-variable-name">options</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork() Linux Manpage</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=execvp">Execvp() =&gt; FreeBSD Manpage</a></li>
</ul>

<p>
<b>Further Reading</b>
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Fork_(system_call)">Fork (system call) - Wikipedia</a></li>

<li><a href="http://people.cs.pitt.edu/~aus/cs449/ts-lecture14.pdf">Fork() System Calland ProcessesCS449 Spring 2016</a></li>

<li><a href="https://www.cs.columbia.edu/~junfeng/11sp-w4118/lectures/unix.pdf">Chapter 0 - Operating system interfaces {PDF}</a></li>
</ul>

<p>
<b>Sample Code</b> 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/133e91ba3732718cb228310173368674">https://gist.github.com/133e91ba3732718cb228310173368674</a></li>
</ul>

<p>
File: unix-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ File: unix-process.cpp -----------------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Description: Shows hows to launch processes on Unix with Exec and Fork syscall wrappers.</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------------------------//</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------- Declarations --------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Launch a new process without terminate this process. </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It combines fork + exec system-calls. </span>
<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Usage:  ./unix-process &lt;OPTION&gt;"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">opt</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"0"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
        execvp_test<span class="org-rainbow-delimiters-depth-3">()</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Test execvp </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"thunar"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"/etc"</span> <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Fork-exec </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"2"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fork_exec<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"konsole"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"-e"</span>, <span class="org-string">"tmux"</span>, <span class="org-string">"a"</span><span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>  

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Finish execution. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">------------- Definitions ------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr ,<span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                             <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Test exec system-call wrapper function (execvp)</span>
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span>    = <span class="org-string">"thunar"</span>;

        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>  app     <span class="org-comment-delimiter">// </span><span class="org-comment">Process name, can be anything </span>
                               , <span class="org-string">"/etc"</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments passed to the process </span>
                               , <span class="org-constant">nullptr</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Always terminate the argument array with null pointer </span>
                              <span class="org-rainbow-delimiters-depth-2">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulates execv system call. </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">int execvp(const char *file, char *const argv[]);</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
              <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
              print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
              <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">C++ wrapper for the exevp() library-call </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It replaces the current process image with a new one </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">from other executable. </span>
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>
                , <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">const</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">pargs</span>;
     pargs.reserve<span class="org-rainbow-delimiters-depth-2">(</span>args.size<span class="org-rainbow-delimiters-depth-3">()</span> + 1<span class="org-rainbow-delimiters-depth-2">)</span>;
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">a</span>: args<span class="org-rainbow-delimiters-depth-2">){</span> pargs.push_back<span class="org-rainbow-delimiters-depth-3">(</span>a.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Signature: int execvp(const char *file, char *const argv[]);</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">execvp(app.c_str(), execvp(app.c_str(), (char* const *) pargs.data() )</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = execvp<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>* <span class="org-keyword">const</span>*<span class="org-rainbow-delimiters-depth-3">)</span> pargs.data<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> status == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;BEFORE FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">PID of child process (copy of this process)</span>
     <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == 0<span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Running on child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  

          <span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptors, in order to disconnect the process from the terminal.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">This procedure allows the process to be launched as a daemon (aka service).</span>
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDERR_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Execvp system call, replace the image of this process with a new one</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">from an executable. </span>
          execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span>app, args<span class="org-rainbow-delimiters-depth-3">)</span>;        
          <span class="org-keyword">return</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">pid_t waitpid(pid_t pid, int *wstatus, int options);</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process to finish. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">From header: #include &lt;sys/wait.h&gt;</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>waitpid<span class="org-rainbow-delimiters-depth-3">(</span>pid, &amp;status, 0<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: cannot wait for child process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Child process has been terminated Ok."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">-------- Parent process ----------------//</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ unix-process.cpp -o <span class="org-keyword">unix-process.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 0
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 1
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 2
[INFO] Program started. 
[TRACE] &lt;BEFORE FORK&gt; PID of parent process = 774929 
[TRACE] &lt;AFTER FORK&gt; PID of parent process = 774929 
[TRACE] Running on child process =&gt; PID_CHILD = 774930 
[TRACE] Waiting for child process to finish.  [TRACE] Child process has been terminated Ok. [TRACE] Finish execution. 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdc16d40" class="outline-3">
<h3 id="orgdc16d40"><span class="section-number-3">1.9</span> Reading subprocess output via Popen()</h3>
<div class="outline-text-3" id="text-1-9">
<p>
The convenience function popen(), which is a combination of fork() +
exec() and pipe() functions, allows reading a subprocess
output. Note: this function is also available on Windows.
</p>

<p>
Header: 
</p>
<ul class="org-ul">
<li>&lt;stdio.h&gt; in C</li>
<li>&lt;cstdio&gt; in C++</li>
</ul>

<p>
<b>Documentation</b>
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/popen.html">Popen - opengroup()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=popen&amp;sektion=3&amp;manpath=freebsd-release-ports">FreeBSD Documentation</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Ppeline (Unix)</a></li>
</ul>

<p>
<b>Functions</b>
</p>

<p>
Popen: 
</p>
<ul class="org-ul">
<li>This function executes: 'sh -c &lt;COMMAND&gt;' via, fork() + exec()
and pipe(), returning a file stream. Note: sh is a unix-shell.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FILE</span>* <span class="org-function-name">popen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">command</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Pclose
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span>  <span class="org-function-name">pclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FILE</span>* <span class="org-variable-name">stream</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Application</b> 
</p>

<p>
File: popen-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Provides; popen(), pclose()</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdio</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 1 - popen() using buffer ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to: fork() + exec() + pipe()</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ls /"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>fd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">"Error: failed to run command. Check ERRNO variable. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
         <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer initialized with null char </span>
         <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">]</span> = <span class="org-rainbow-delimiters-depth-3">{</span>0<span class="org-rainbow-delimiters-depth-3">}</span>;

         <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> fgets<span class="org-rainbow-delimiters-depth-4">(</span>buffer, BUFFER_SIZE, fd<span class="org-rainbow-delimiters-depth-4">)</span> != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">"%s"</span>, buffer<span class="org-rainbow-delimiters-depth-4">)</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;        
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 2 - popen() reading line-by-line ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ps -ef"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-type">char</span>*   <span class="org-variable-name">pline</span> = <span class="org-constant">nullptr</span>; 
         <span class="org-type">size_t</span>  <span class="org-variable-name">size</span>  = 0; 
         <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
         <span class="org-type">int</span>     <span class="org-variable-name">count</span> = 0;
         <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-3">{</span>
            nread = getdelim<span class="org-rainbow-delimiters-depth-4">(</span>&amp;pline, &amp;size, <span class="org-string">'\n'</span>, fd<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; count++ &lt;&lt; <span class="org-string">"]"</span> &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; pline;
         <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> nread != -1 &amp;&amp; count &lt; 8<span class="org-rainbow-delimiters-depth-3">)</span>;
         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ popen-test.cpp -o <span class="org-keyword">popen-test</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">  $ ./popen-test 

   === EXPERIMENT 1 - popen() using buffer ========

  bin
  boot
  dev
  etc
  home
<span class="org-builtin">.</span> .... ... ... ... 
  ... ... ... ... ...
  usr
  var

   === EXPERIMENT 2 - popen() reading line-by-line ========

    [0] =&gt; UID          PID    PPID  C STIME TTY          TIME CMD
    [1] =&gt; root           1       0  0 Jun08 ?        00:48:25 /usr/lib/systemd/systemd ... ... ...
    [2] =&gt; root           2       0  0 Jun08 ?        00:00:00 [kthreadd]
    [3] =&gt; root           3       2  0 Jun08 ?        00:00:00 [rcu_gp]
    [4] =&gt; root           4       2  0 Jun08 ?        00:00:00 [rcu_par_gp]
    [5] =&gt; root           6       2  0 Jun08 ?        00:00:00 [kworker/0:0H-events_highpri]
    [6] =&gt; root           9       2  0 Jun08 ?        00:00:00 [mm_percpu_wq]
    [7] =&gt; root          10       2  0 Jun08 ?        00:00:54 [ksoftirqd/0]
</pre>
</div>
</div>
</div>

<div id="outline-container-org429d4fa" class="outline-3">
<h3 id="org429d4fa"><span class="section-number-3">1.10</span> Unix Pipes - Inter Process Communication</h3>
<div class="outline-text-3" id="text-1-10">
<p>
Unix pipe is an inter-process communication facility which allows the
output of a process to be the input of a another. It can be used for
reading the output of a subprocess. 
</p>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?pipe(2)">FreeBSD - pipe()</a></li>

<li><a href="https://linuxhint.com/dup2_system_call_c/">Dup2 - system call</a></li>

<li><a href="https://en.wikipedia.org/wiki/Dup_(system_call)">Dup (system call)</a></li>

<li><a href="https://www.gnu.org/software/libc/manual/html_node/Duplicating-Descriptors.html">Duplicating Descriptors - GNU GlibC</a></li>

<li><a href="https://www-users.cs.umn.edu/~kauffman/4061/05-io-files-pipes.pdf">CSCI 4061: Input/Output with Files, Pipes</a></li>

<li><a href="http://unixwiz.net/techtips/remap-pipe-fds.html">http://unixwiz.net/techtips/remap-pipe-fds.html</a></li>

<li><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/node23.html">Inter Process Communication (IPC), pipes</a></li>

<li><a href="http://perugini.cps.udayton.edu/teaching/books/SPUC/www/lecture_notes/pipes.html">IPC - I/O Redirection &amp; IPC, &amp; Special Files: Unamed &amp; Named Pipes, FIFOs</a></li>

<li><a href="https://www.cs.purdue.edu/homes/grr/SystemsProgrammingBook/Book/Chapter5-WritingYourOwnShell.pdf">Chapter 5 - Writing Your Own Shell</a></li>
</ul>

<p>
<b>Main Functions</b> 
</p>

<p>
Function pipe()
</p>

<ul class="org-ul">
<li>Encapsulates: pipe() system-call</li>

<li>Linux Manpage: "pipe() creates a pipe, a unidirectional data
channel that can be used for interprocess communication.  The
array pipefd is used to return two file descriptors referring to
the ends of the pipe.  pipefd[0] refers to the read end of the
pipe.  pipefd[1] refers to the write end of the pipe."</li>

<li>pipefd[0] =&gt; File descriptor for reading the pipe.</li>

<li>pipefd[1] =&gt; File descriptor for writing to the pipe.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">pipe</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pipefd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Function dup2()
</p>

<ul class="org-ul">
<li>Encapsulates: dup2() system-call</li>

<li>Duplicate file descriptor, used for IO redirection.</li>

<li>dup2( fd1, STDOUT_FILENO ) =&gt; Example: redirect current process'
stdout to file descriptor fd1.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dup2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">oldfd</span>, <span class="org-type">int</span> <span class="org-variable-name">newfd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Code</b> 
</p>

<p>
This code spawns a subprocess using fork() + exec() and uses pipes to
read the subprocess output which are stdout and stderr of the "ls -l -a /".  
</p>

<p>
File: pipe-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Unix headers --------// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Application to be called or its absolute path */</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span> = <span class="org-string">"ls"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments ('-l' '-a' '/') for ls -l -a /</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">First argument - process name (can be anything)   */</span>  
                             <span class="org-string">"ls"</span> 
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Arguments passed to application */</span>
                            , <span class="org-string">"-l"</span>, <span class="org-string">"-a"</span>, <span class="org-string">"/"</span>
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Sentinel value - always nullptr */</span>
                            , <span class="org-constant">nullptr</span>  
                         <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_READ</span> = 0;
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_WRITE</span> = 1;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Create pipe IPC channel --------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> pipe<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">){</span>
       <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: cannot create pipe \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Fork() ----------------//</span>

    <span class="org-type">pid_t</span> <span class="org-variable-name">cpid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;         
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == 0<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">/** </span><span class="org-comment">------- BEGIN of child process ------ **/</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;       

        <span class="org-comment-delimiter">// </span><span class="org-comment">Connect child process' stdin to read-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stdout (STDOUT_FILENO) to the write-end of the pipe. </span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDOUT_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stderr to write-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDERR_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Run process - exec() syscall =&gt; the new process image </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">has the same PID as the child process. </span>
        execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> 0;          
        <span class="org-comment-delimiter">/** </span><span class="org-comment">------- END of child process ------ **/</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">---- Continue parent process ---------//</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFSIZE</span> = 200;
     <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
     <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFSIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Close unnused end of the pipe.</span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Write bytes read from the pipe (write-end), written by child process</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">, to the stdout.</span>
     <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>   
          nread = read<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;buffer, BUFSIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
          write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, nread<span class="org-rainbow-delimiters-depth-3">)</span>;      
     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span> nread &gt; 0<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process termination. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination </span>
     ::wait<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;

     <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">-- End of main() --- //</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ &gt;&gt; g++ pipe-test.cpp -o <span class="org-keyword">pipe-test.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">
<pre class="src src-cpp"> $ &gt;&gt; ./pipe-test.bin 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">AFTER</span> <span class="org-variable-name">FORK</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> PID of parent process = 1352693 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Child process =&gt; PID_CHILD = 1352694 
total 72
dr-xr-xr-x.  18 root root  4096 May 17 21:36 .
dr-xr-xr-x.  18 root root  4096 May 17 21:36 ..
-rw-r--r--    1 root root     0 May 17 21:36 .autorelabel
lrwxrwxrwx.   1 root root     7 Jan 28 15:30 bin -&gt; usr/bin
dr-xr-xr-x.   6 root root  4096 May 17 15:17 boot
drwxr-xr-x   21 root root  4200 Jun 28 19:22 dev
... ... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 
lrwxrwxrwx.   1 root root     8 Jan 28 15:30 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root  4096 May 12 14:50 srv
dr-xr-xr-x   13 root root     0 Jun  8 11:58 sys
drwxrwxrwt   31 root root   680 Jun 30 04:02 tmp
drwxr-xr-x.  12 root root  4096 Apr 22 19:35 usr
drwxr-xr-x.  22 root root  4096 Apr 22 19:39 var
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Waiting <span class="org-keyword">for</span> child process termination. 
</pre>
</div>
</div>
</div>

<div id="outline-container-org86b9cc1" class="outline-3">
<h3 id="org86b9cc1"><span class="section-number-3">1.11</span> Reading/Listings directory contents</h3>
<div class="outline-text-3" id="text-1-11">
<p>
API Documentations: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man3/opendir.3.html">Linux Manpage - opendir()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=opendir&amp;sektion=3">FreeBSD manpage - opendir()</a></li>

<li><a href="https://www.man7.org/linux/man-pages/man3/readdir.3.html">Linux manpage - readdir()</a></li>
</ul>

<p>
Functions used: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DIR</span> *<span class="org-function-name">opendir</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">readdir</span><span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">fd</span>
             , <span class="org-keyword">struct</span> <span class="org-type">old_linux_dirent</span>* <span class="org-variable-name">dirp</span>,
             , <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
File: unix-readdir.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;string&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dirent.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Get function opendir</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">errno.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Callback</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">iterate_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">Callback</span>&amp;&amp; <span class="org-variable-name">callback</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DIR</span> *<span class="org-variable-name">dir</span>;
    <span class="org-keyword">struct</span> <span class="org-type">dirent</span> *<span class="org-variable-name">dp</span>;

    dir = opendir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> ;

    <span class="org-comment-delimiter">// </span><span class="org-comment">To determine the cause of error - It is necessary to check the error code.</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>dir == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: Cannot read directory"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>dp = readdir<span class="org-rainbow-delimiters-depth-4">(</span>dir<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>path == <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-3">)</span>
            callback<span class="org-rainbow-delimiters-depth-3">(</span>dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">else</span> 
            callback<span class="org-rainbow-delimiters-depth-3">(</span>path + <span class="org-string">"/"</span> + dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;      
    <span class="org-rainbow-delimiters-depth-2">}</span>;
    closedir<span class="org-rainbow-delimiters-depth-2">(</span>dir<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" List directory contents "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Usage: ./unix-readdir &lt;DIRECTORY&gt;"</span> &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-type">int</span> <span class="org-variable-name">idx</span> = 0;
     iterate_directory<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">idx</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">)</span>
     <span class="org-rainbow-delimiters-depth-3">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; idx++  &lt;&lt; <span class="org-string">"] path =&gt; "</span> &lt;&lt; path &lt;&lt; <span class="org-string">"\n"</span>;
     <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-readdir.cpp -o <span class="org-keyword">unix-readdir.bin</span> -std=c++1z -g -Wall -Wextra 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-readdir.bin /
 List directory contents 
  [0] path =&gt; srv
  [1] path =&gt; sys
  [2] path =&gt; ..
  [3] path =&gt; opt
  [4] path =&gt; .
  [5] path =&gt; run
  [6] path =&gt; media
  ... ... ... 
  [18] path =&gt; lib
  [19] path =&gt; usr
  [20] path =&gt; boot
  [21] path =&gt; mnt
  [22] path =&gt; sbin
... .. .... ... ... 

 $ &gt;&gt; ./unix-readdir.bin /boot 
 List directory contents 
  [0] path =&gt; /boot/..
  [1] path =&gt; /boot/.
  [2] path =&gt; /boot/initramfs-5.6.12-300.fc32.x86_64.img
  [3] path =&gt; /boot/grub2
  [4] path =&gt; /boot/vmlinuz-0-rescue-a1ac43b933e24659bba5edf2b9cec1e1
  [5] path =&gt; /boot/memtest86+-5.01
  [6] path =&gt; /boot/initramfs-5.6.6-300.fc32.x86_64.img
   ... ... ...     ... ... ...     ... ... ...     ... ... ...     
</pre>
</div>
</div>
</div>


<div id="outline-container-org4c18809" class="outline-3">
<h3 id="org4c18809"><span class="section-number-3">1.12</span> Memory Mapped Files - mmap</h3>
<div class="outline-text-3" id="text-1-12">
</div>
<div id="outline-container-org2eaeca4" class="outline-4">
<h4 id="org2eaeca4"><span class="section-number-4">1.12.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
File mapping is an operating system mechanism which maps a disk file
to a process virtual memory. This operating system feature allows
accessing the file as it was in the process memory. 
</p>

<p>
Benefits: 
</p>

<ul class="org-ul">
<li>Transparent access to file, allows accessing the file as it was an
ordinary memory. (the file is accessible by pointer)</li>

<li>Good for processing large files which does not fit in the machine
RAM memory.</li>
</ul>

<p>
Use-cases: 
</p>

<ul class="org-ul">
<li>Read large files</li>

<li>IPC - Inter-Process Communication</li>

<li>Process complicated binary files</li>

<li>Modify complex binary files. The file can be modified by just
changing a memory, in other words, modifying the contents of a
memory address.</li>

<li>Implement JIT - Just-In-Time compiler and execute assembly code at runtime.</li>
</ul>

<p>
The <span class="underline">mmap API</span> is available in most Unix-like operating systems: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>BSD-family: MacOSX, FreeBDS, NetBSD, OpenBSD</li>
<li>Solaris</li>
<li>QNX, AIX</li>
</ul>

<p>
<b>Mmap API functions</b>
</p>

<p>
File descriptors: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Returns file descriptor of a disk-file </span>
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptor (release resource)</span>
<span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Mmap: 
</p>

<ul class="org-ul">
<li>Doc: $ man mmap</li>
<li>Linux Manpage Description: "mmap() creates a new mapping in the
virtual address space of the calling process.  The starting
address for the new mapping is specified in addr.  The length
argument speci fies the length of the mapping (which must be
greater than 0)"</li>

<li>Argument: <span class="underline">prot</span> (Memory Protection)
<ul class="org-ul">
<li>PROT_READ  =&gt; Pages may be written (most used)</li>
<li>PROT_WRITE =&gt; Pages may be written (allows changing the file by writing to the mapped memory)</li>
<li>PROT_NONE  =&gt; Pages may not be accessed</li>
<li>PROT_EXEC  =&gt; Pages may be executed =&gt; Allows executing machine
code (assembly) at runtime. Use case: JIT - Just-In-Time
compiler</li>
</ul></li>

<li>Argument: <span class="underline">flags</span>
<ul class="org-ul">
<li>MAP_SHARED  =&gt; Multiple processes can share the same <span class="underline">file</span>
<span class="underline">mapping</span>. This flag is used for IPC - Inter Process
Communication.</li>
<li>MAP_PRIVATE =&gt; Only the current process can access the file mapping.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>* <span class="org-function-name">mmap</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">void</span>*   <span class="org-variable-name">addr</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">(often nullptr) Address that the file will be mapped </span>
           , <span class="org-type">size_t</span>  <span class="org-variable-name">length</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Length of file mapping (often the file size)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">prot</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for memory protection </span>
           , <span class="org-type">int</span>     <span class="org-variable-name">flags</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for process access conttrol (private | shared)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">fd</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor to be mapped into virtual memory</span>
           , <span class="org-type">off_t</span>   <span class="org-variable-name">offset</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">(often zero) Offset from the beginning of the file </span>
          <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
munmap:
</p>

<ul class="org-ul">
<li>Doc: $ man munmap</li>
<li>Linux Manpage doc: "The munmap() system call deletes the mappings
for the specified address range, and causes further references to
addresses within the range to generate invalid memory ref
erences.  The region is also automatically unmapped when the
process is terminated.  On the other hand, closing the file
descriptor does not unmap the region."</li>

<li>Param <span class="underline">addr</span>: Address of memory mapping (value returned by mmap)</li>

<li>Param <span class="underline">length:</span> length of file mapping, often it is the file size.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">For mmap and munmap </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>     

<span class="org-type">int</span> <span class="org-function-name">munmap</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">void</span> *<span class="org-variable-name">addr</span>, <span class="org-type">size_t</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Hyperlinks to manpage documentation of related-functions: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/2/mmap">mmap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/remap_file_pages">remap_file_pages</a></li>

<li><a href="https://linux.die.net/man/2/mremap">mremap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/msync">msync</a></li>
</ul>


<p>
<b>References and further reading</b> 
</p>

<p>
General: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Mmap">mmap - Wikipedia</a></li>

<li><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemAdvancedPT/MappingFilesIntoMemory/MappingFilesIntoMemory.html">Apple - Mapping Files Into Memory</a></li>

<li><a href="https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Programmation SystmeCours 5  Memory Mapping</a> (<a href="http://web.archive.org/web/20200622232258/https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Web Archive</a>)</li>

<li><a href="https://unix.stackexchange.com/questions/474926/how-does-memory-mapping-a-file-have-significant-performance-increases-over-the-s/475014">How does memory mapping a file have significant performance increases over the standard I/O system calls?</a></li>

<li><a href="https://courses.engr.illinois.edu/cs241/sp2014/lecture/27-IPC.pdf">Interprocess Communication: Memory mapped files and pipes</a></li>

<li><a href="http://web.cs.ucla.edu/honors/UPLOADS/kousha/thesis.pdf">Linux Memory Mapped System Call Performance</a></li>

<li><a href="https://w3.cs.jmu.edu/kirkpams/OpenCSF/Books/csf/html/MMap.html">Shared Memory with Memory-Mapped Files</a></li>

<li><a href="https://www.sublimetext.com/blog/articles/use-mmap-with-care">Use mmap With Care - Sublime HQ</a></li>

<li><a href="http://www.idryman.org/blog/2017/06/28/opic-a-memory-allocator-for-fast-serialization/">Writing a Memory Allocator for Fast Serialization</a></li>

<li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2044.html">Paper: Memory Mapped Files And Shared Memory For C++</a></li>

<li><a href="https://indico.cern.ch/event/658060/contributions/2898569/attachments/1622526/2582399/pivarski-serialization.pdf">Overview of Serialization Technologies</a> - CERN</li>

<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/hotstorage17_slides_choi.pdf">Efficient Memory Mapped File I/O for In-Memory File Systems</a></li>

<li><a href="https://engineering.mongodb.com/post/getting-storage-engines-ready-for-fast-storage-devices">Getting storage engines ready for fast storage devices</a></li>

<li><a href="http://blogs.networkingfutures.co.uk/post/2015/12/28/Windows-Services-Implementing-Non-Persisted-Memory-Mapped-Files-Exposing-IPC-Style-Communications.aspx">Introduction to Memory Mapped Files</a> (.NET Specific)</li>
</ul>


<p>
MMAP - File Memory Mapping for other programming languages
</p>

<ul class="org-ul">
<li><a href="https://docs.rs/flatdata/0.5.0/flatdata/">https://docs.rs/flatdata/0.5.0/flatdata/</a> (Rust library for mmap)</li>

<li><a href="https://www.red-gate.com/simple-talk/dotnet/net-development/sharing-caring-using-memory-mapped-files-net/">Sharing is Caring: Using Memory Mapped Files in .NET</a></li>

<li><a href="https://coders-corner.net/2013/03/22/inter-process-communication-with-memory-mapped-files-part-01-transfer-a-data-structure-and-an-object/">Inter-Process Communication with Memory-Mapped Files, Part 01</a></li>

<li><a href="https://github.com/jampp/sharedbuffers/">Python SharedBuffer - library for mmap</a></li>

<li><a href="https://docs.julialang.org/en/v1/stdlib/Mmap/">https://docs.julialang.org/en/v1/stdlib/Mmap/</a> - Julia Language library for mmap (memory-mapped files)</li>

<li><a href="https://engineering.indeedblog.com/blog/2015/02/memory-mapping-with-util-mmap/">Memory Mapping with util-mmap</a> - mmap for Java.</li>
</ul>
</div>
</div>
<div id="outline-container-org3d5879c" class="outline-4">
<h4 id="org3d5879c"><span class="section-number-4">1.12.2</span> Example (C) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-12-2">
<p>
This code uses mmap API (memory mapped files) for reading metadata
from PE (Portable Executable) - Windows native executable files or
windows object-code. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.c 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdint.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">assert.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span>            8
<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span>  16

<span class="org-keyword">typedef</span> <span class="org-type">int32_t</span>  <span class="org-type">LONG</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint16_t</span> <span class="org-type">WORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">DWORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint8_t</span>  <span class="org-type">BYTE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint64_t</span> <span class="org-type">ULONGLONG</span>;;

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">IMAGE_DOS_HEADER</span>;

 <span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">PE_HEADER</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> -1;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>size == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get file size \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">NULL</span>        <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-type">unsigned</span> <span class="org-type">char</span>* <span class="org-variable-name">bmap</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap + dos_header-&gt;e_lfanew;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ gcc unix-mmap.c -o <span class="org-keyword">unix-mmap-c.bin</span> -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-c.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 

</pre>
</div>
</div>
</div>
<div id="outline-container-orgb4a18c0" class="outline-4">
<h4 id="orgb4a18c0"><span class="section-number-4">1.12.3</span> Example (C++) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-12-3">
<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">nullptr</span>     <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> bmap = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-3">)</span> fmap + dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ unix-mmap.cpp -o <span class="org-keyword">unix-mmap.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap.bin ipconfig.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xE8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 6 


$ ./unix-mmap.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
<div id="outline-container-org444f15b" class="outline-4">
<h4 id="org444f15b"><span class="section-number-4">1.12.4</span> Example (C++) - mmap for reading Windows PE32 with class</h4>
<div class="outline-text-4" id="text-1-12-4">
<p>
This code uses a class FileMapping for encapsulating Unix
memory-mapped files which simplifies the usage of the mmap feature and
makes the code cleaner and safer. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap-class.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">/** </span><span class="org-comment">Class for encapsulating memory mapped files*/</span>
<span class="org-keyword">class</span> <span class="org-type">FileMapping</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>   <span class="org-variable-name">m_fd</span>      = -1; 
    <span class="org-type">void</span>* <span class="org-variable-name">m_addr</span>    = <span class="org-constant">nullptr</span>; 
    <span class="org-type">ssize_t</span> <span class="org-variable-name">m_size</span>  = -1;

    <span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> fstat<span class="org-rainbow-delimiters-depth-4">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-4">)</span> == -1 <span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> file_stat.st_size;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">public</span>: 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor </span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy assignment operator </span>
    <span class="org-type">FileMapping</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;    

    <span class="org-comment-delimiter">/** </span>
<span class="org-comment">     * @param file_path - File to be memory-mapped to current process. </span>
<span class="org-comment">     */</span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file_path</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
        m_fd = open<span class="org-rainbow-delimiters-depth-3">(</span>file_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_fd == -1<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Unable to open file"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>      

        m_size = get_file_size<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_size == -1<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        m_addr = ::mmap<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">nullptr</span>     
                        , m_size       
                        , PROT_READ   
                        , MAP_PRIVATE 
                        , m_fd        
                        , 0x00        
                    <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> m_addr == MAP_FAILED<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: failed to map file to memory"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span>

    ~<span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
        munmap<span class="org-rainbow-delimiters-depth-3">(</span>m_addr, m_size<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
        close<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;

        m_fd = -1;
        m_addr = <span class="org-constant">nullptr</span>;
        m_size = -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief Returns pointer file mapping address. */</span>
    <span class="org-type">void</span>* <span class="org-function-name">addr</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_addr; <span class="org-rainbow-delimiters-depth-2">}</span>  

    <span class="org-comment-delimiter">/** </span><span class="org-comment">@brief  Get casted pointer to an offset of the file mapping address. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">T</span> <span class="org-function-name">addr_rel</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">ptrdiff_t</span> <span class="org-variable-name">offset</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>m_addr<span class="org-rainbow-delimiters-depth-4">)</span> + offset<span class="org-rainbow-delimiters-depth-3">)</span>;  
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class FileMapping ---- //</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">FileMapping</span> <span class="org-variable-name">fmap</span><span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> bmap = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-mmap-class.cpp -o <span class="org-keyword">unix-mmap-class.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-class.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2020-06-30 Tue 04:17</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
