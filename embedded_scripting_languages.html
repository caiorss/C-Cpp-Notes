<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-09-16 Fri 07:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Embedded Scripting Languages</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="cpp/c++ embedded scripting languages survey"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Embedded Scripting Languages</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02db74f">1. Embedded Scripting Languages</a>
<ul>
<li><a href="#org3744919">1.1. Overview</a></li>
<li><a href="#orgac60a86">1.2. Embedded Scripting Languages Selection</a></li>
<li><a href="#org0dde064">1.3. MuParser - Math expression parser</a></li>
<li><a href="#org6ebf8f3">1.4. Exprtk - Math expression parser</a></li>
<li><a href="#org4a3e277">1.5. Lua scripting engine</a>
<ul>
<li><a href="#org57ee89d">1.5.1. Overview</a></li>
<li><a href="#orgf76553a">1.5.2. Further Reading</a></li>
<li><a href="#org112ef02">1.5.3. Example project with Sol2 C++ binding library</a></li>
</ul>
</li>
<li><a href="#org78aa0a7">1.6. Squirrel Scripting Language</a>
<ul>
<li><a href="#org48fbe81">1.6.1. Overview</a></li>
<li><a href="#orge667407">1.6.2. Building Squirrel standalone REPL interpreter</a></li>
<li><a href="#orgb85461c">1.6.3. Example - embedding Squirrel with Squall Library</a></li>
</ul>
</li>
<li><a href="#org6384dd3">1.7. Duktape - Embeddable Javascript Engine</a>
<ul>
<li><a href="#orgc75584e">1.7.1. Overview</a></li>
<li><a href="#orgdebcb0c">1.7.2. Example project with DukGlue C++ binding library</a></li>
<li><a href="#org12f6ed0">1.7.3. Example project with Duktape-CC binding library</a></li>
</ul>
</li>
<li><a href="#org17348cd">1.8. QuickJS - ES20 Javascript Engine</a></li>
<li><a href="#org9888893">1.9. Chaiscript</a></li>
<li><a href="#org9d8d4d6">1.10. Python Engine via Pybind11</a></li>
<li><a href="#orgd61f66d">1.11. Writing a Scheme-like lisp interpreter in C++</a>
<ul>
<li><a href="#org24f41ad">1.11.1. Overview</a></li>
<li><a href="#org60e11e8">1.11.2. Code</a></li>
<li><a href="#org69da843">1.11.3. Further Reading</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org02db74f" class="outline-2">
<h2 id="org02db74f"><span class="section-number-2">1</span> Embedded Scripting Languages</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3744919" class="outline-3">
<h3 id="org3744919"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
<b>Reasonable Features of Embedded Scripting Languages</b>
</p>

<p>
This section lsits some reasonable features that a language designed
to be embedded should have:
</p>

<ul class="org-ul">
<li><span class="underline">Ligthweight</span> -  Small footprint, small size and memory requirements.</li>

<li><span class="underline">Scripting Engine as a library</span>:
<ul class="org-ul">
<li>Must be available as C or C++ library which exposes the
interpreter API allowing the client code to evaluate scripting
code from strings or files and also to retrieve objects from the
virtual machine memory.</li>
</ul></li>

<li><span class="underline">Sandboxing or capability limitations</span>
<ul class="org-ul">
<li>A reasonable requirement for an embedded scripting language is
limiting the capabilities and APIs which can be used possibly
allowing the execution of non-trusted scripts. Example: the
Javascript engines of most web browsers do not allow the script
to interact with file systems or operating system APIs.</li>
</ul></li>

<li><span class="underline">Permissive License for static linking</span></li>

<li><span class="underline">Use Cases</span>
<ul class="org-ul">
<li>DSL - Domain Specific Languages</li>
<li>Game Engines</li>
<li>Configuration files =&gt; Data Description language.</li>
<li>User content</li>
<li>Allow application runtime changes without recompilation.</li>
<li>User extension without modification of source code.</li>
</ul></li>
</ul>

<p>
<b>Examples of embedded scripting languages usage and use-cases</b>
</p>

<ul class="org-ul">
<li>TCL - Tool Command Language =&gt; Used by many EDA - Electronic
Design Automation Sofware in electronic engineering.</li>

<li>JavaScript =&gt; Used in Web Browsers, which are written mostly in
C++, for controlling user interaction, animation and etc.</li>

<li>TinyScheme =&gt; Used by GNU GIMP drawing application ans Apple's
MacOSX sandbox configuration.</li>

<li>Lua language =&gt; Used by many game engines and also by
applications such as: Nginx web server; Linux Conky; Geany
Editor; NMap editor and so on.</li>

<li>Squirrel Language =&gt; Used in game engines</li>

<li>Python
<ul class="org-ul">
<li>=&gt; Python is used as embedded scripting language by GDB - GNU
Debugger ; WinDBG  - Windows Debugger; IDA - Debugger for
Reverse Engineering.</li>
<li>Disadvantages: Python has a large footprint; it was not
designed as an embedded scripting language and it is not
possible to forbid the interpreter from calling file system
and process creation APIs.</li>
</ul></li>

<li>AutoLisp [proprietary] =&gt; Lisp-like language used in Autocad.</li>

<li>SQL (Structured Query Language) =&gt; Many databases are
implemented in C or C++ uses SQL as scripting language and
domain specific language (DSL) for querying and storing
data. Example: SQLite, Postgres SQL, &#x2026;</li>

<li>Emacs Lisp =&gt; Emacs core, including the LISP
engine/interpreter, is written in C and other parts are
written in Emacs Lisp. This lisp dialect allows extending Emacs
at with custom extensions (plugins) and also modifying the
application behavior at runtime.</li>

<li>VBA - Visual Basic for Application [proprietary] =&gt; Used in
Microsft Office Suite, specially in Microsft Excel.</li>
</ul>

<p>
<b>Considerations for choosing embedded scripting languages</b>
</p>

<ul class="org-ul">
<li>Small footprint and small overhead</li>

<li>Stability of C or C++ API</li>

<li>C++ API bindings</li>

<li>Permissive license for static linking or option of dual license
for static linking.</li>

<li>Documentation and of C or C++ binding APIs, examples about binding
code</li>

<li>Garbage collector implementation</li>

<li>Heavy duty computations with significant overhead should be
performed on the C++-side, specially loops.</li>

<li>JIT - Just-In-Time compiler =&gt; can increase the performance by
translating bytecodes into machine code.
<ul class="org-ul">
<li>Example: Lua JIT, Javascript V8 engine used by Chrome browser.</li>
</ul></li>

<li>Features for running untrusted scripts or configuration: 

<ul class="org-ul">
<li>Ability for restricting capabilities such as creating process,
accessing the file system and so on.</li>

<li>Non-turing complete =&gt; better for configuration</li>
</ul></li>

<li>Familiarity of the targe audience

<ul class="org-ul">
<li>Lua is pervasive in Games</li>

<li>TCL is pervasive on Electronic Design Automation Software</li>

<li>Javascript is widely used on the Web, NodeJS and also as
embedded scripting language of web browsers.</li>
</ul></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://accu.org/index.php/journals/351">ACCU - Embedded Scripting Languages</a></li>

<li><a href="https://github.com/dbohdan/embedded-scripting-languages">GitHub - dbohdan/embedded-scripting-languages: A list of embedded scripting languages</a></li>

<li><a href="https://articles.emptycrate.com/2016/03/26/so-you-want-to-embed-a-scripting-language.html">EmptyCrate.com: So You Want to Embed A Scripting Language in Your Application</a></li>

<li><a href="https://softwareengineering.stackexchange.com/questions/403911/what-makes-a-scripting-language-embeddable">What makes a scripting language "embeddable"? - Software Engineering Stack Exchange</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgac60a86" class="outline-3">
<h3 id="orgac60a86"><span class="section-number-3">1.2</span> Embedded Scripting Languages Selection</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Selection of embedded scripting languages and engines available as  libraries:
</p>

<p>
<b>Non categorized:</b>
</p>

<ul class="org-ul">
<li><a href="http://tcl-lang.org/">TCL</a> - Tool Command Language
<ul class="org-ul">
<li>License: akin to BSD</li>
<li>Implementation: C</li>
<li>Syntax Type: N/A</li>
<li>Note: pervasive in EDA - Electronic Design Automation software.</li>
<li>See:
<ul class="org-ul">
<li><a href="https://wiki.tcl-lang.org/page/How+to+embed+Tcl+in+C+applications">How to embed Tcl in C applications</a></li>
</ul></li>
</ul></li>

<li><a href="https://github.com/mruby/mruby">mruby</a> (Embeddable Ruby implementation)
<ul class="org-ul">
<li>License: BSD</li>
<li>Implementation: C</li>
<li>Syntax type: Ruby</li>
</ul></li>

<li><a href="https://github.com/munificent/wren">Wren</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C</li>
<li>Syntax Type: N/A</li>
</ul></li>

<li><a href="https://www.jinx-lang.org/">Jinx</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C++17</li>
<li>Syntax Type: N/A</li>
</ul></li>

<li><a href="https://marcobambini.github.io/gravity">Gravity</a>
<ul class="org-ul">
<li>License: -</li>
<li>Implementation: C</li>
<li>Syntax type: Apple's SWIFT language</li>
</ul></li>

<li><a href="https://github.com/GaijinEntertainment/daScript">DaScript</a> 
<ul class="org-ul">
<li>License: -</li>
<li>Implementation: C++14</li>
<li>Syntax type: Akin to Python</li>
</ul></li>
</ul>

<p>
<b>Lua or similar to Lua (mimics Lua syntax)</b>
</p>

<ul class="org-ul">
<li><a href="http://lua.org/">Lua</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C</li>
<li>Syntax Type: syntax inspired by scheme.</li>
</ul></li>

<li><a href="http://luajit.org/">LuaJIT</a> (Lua with JIT - Just-in-Time compiler which translates
bytecodes to native machine code for better performance.)
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C</li>
<li>Syntax type:  lua</li>
</ul></li>

<li><a href="http://www.gmscript.com/">GameMonkey Script</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C++</li>
<li>Syntax type: Akin to Lua</li>
</ul></li>

<li><a href="http://squirrel-lang.org/">Squirrel</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C++</li>
<li>Syntax type:    Lua-like</li>
<li>Note: Despite be implemented in C++, does not expose a C++ API,
it exposes a C API.</li>
</ul></li>

<li><a href="https://github.com/mingodad/squilu">Squilu</a> (Squirrel fork)
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C++</li>
<li>Syntax type: Lua-like</li>
</ul></li>
</ul>

<p>
<b>Similar to C++ (syntax that mimics C++)</b>
</p>

<ul class="org-ul">
<li><a href="http://www.angelcode.com/angelscript/">AngelScript</a>  (Note: statically typed)
<ul class="org-ul">
<li>License: Zlib</li>
<li>Implementation: C++</li>
<li>Syntax type: C++-like</li>
</ul></li>
</ul>


<p>
<b>Smiliar to Javascript or subset of Javascript (ECMAScript)</b>
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/SpiderMonkey">SpiderMonkey</a> - Java Script Engine (VM - Virtual Machine)
used by Mozzila Firefox. 
<ul class="org-ul">
<li>License: MPL 2.0</li>
<li>Implementation: C and C++</li>
<li>Syntax tyope: JavScript (ECMAscript)</li>
<li>Used by:
<ul class="org-ul">
<li>Firefox Web Browser</li>
<li>MongoDB Document Database</li>
<li><a href="https://blog.couchdb.org/2020/02/26/the-road-to-couchdb-3-0-update-to-javascript-engine/">CoucheDB</a></li>
<li>Adobe Acrobat Reader</li>
</ul></li>
<li>See:
<ul class="org-ul">
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/How_to_embed_the_JavaScript_engine">Mozilla - How to embed the JavaScript engine</a></li>
</ul></li>
<li>Repository:
<ul class="org-ul">
<li><a href="https://github.com/ricardoquesada/Spidermonkey/">https://github.com/ricardoquesada/Spidermonkey/</a></li>
</ul></li>
</ul></li>

<li><a href="http://duktape.org/">Duktape</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C</li>
<li>Syntax type: Javascript (aka ECMAScript) E5/E5.1</li>
</ul></li>

<li><a href="https://github.com/espruino/Espruino">Espruino</a>
<ul class="org-ul">
<li>License: MPL 2</li>
<li>Implementation: C</li>
<li>Syntax type: ES5 - Javascript (ECMaScript)</li>
</ul></li>

<li><a href="https://github.com/jerryscript-project/jerryscript">JerryScript</a>
<ul class="org-ul">
<li>License: Apache v2</li>
<li>Implementation: C</li>
<li>Syntax type: Javascript (ECMAScript)</li>
</ul></li>

<li><a href="http://chaiscript.com/">ChaiScript</a> 
<ul class="org-ul">
<li>License: BSD</li>
<li>Implementation: C++</li>
<li>Syntax type: Javascript-like</li>
</ul></li>
</ul>

<p>
<b>Similar to Lisp or Scheme</b>
</p>

<ul class="org-ul">
<li><a href="https://gitlab.com/embeddable-common-lisp/ecl">ECL - Embeddable Common Lisp</a>
<ul class="org-ul">
<li>License: LGPL - 2</li>
<li>Implementation: C</li>
<li>Syntax type:    Lisp, Common Lisp</li>
</ul></li>

<li><a href="http://tinyscheme.sourceforge.net/">TinyScheme</a>
<ul class="org-ul">
<li>License: BSD</li>
<li>Implementation: C</li>
<li>Syntax tyope: scheme, lisp</li>
<li>Note: Used in GNU GIMP as scripting language and Apple MacOSX's
sandbox as configuration language.</li>
</ul></li>

<li><a href="https://ccrma.stanford.edu/software/snd/snd/s7.html">S7 Scheme</a> (Variant of TinyScheme)
<ul class="org-ul">
<li>License: BSD</li>
<li>Implementation: C</li>
<li>Syntax type: C</li>
</ul></li>

<li><a href="https://github.com/ashinn/chibi-scheme">Chibi Scheme</a>
<ul class="org-ul">
<li>Implementation: C</li>
<li>Syntax type: Scheme, Lisp</li>
</ul></li>

<li><a href="https://janet-lang.org/">Janet Language</a>
<ul class="org-ul">
<li>License: MIT</li>
<li>Implementation: C</li>
<li>Syntax type: Clojure, Lisp</li>
</ul></li>

<li><a href="https://github.com/SuperFola/Ark">ArkScript</a>  
<ul class="org-ul">
<li>License: MPL license</li>
<li>Implementation: C</li>
<li>Syntax type: Lisp-like, more clojure-like</li>
</ul></li>
</ul>

<p>
License obligations and requirements:
</p>

<ul class="org-ul">
<li><b>LGPL</b> allows dynamically linking of closed source
applications, but static linking requires source code disclosure
and release under the same license. Some LGPL libraries, such as
QT, allows static linking via commercial license.</li>

<li>MIT, BSD, APACHE and so on =&gt; Add a copy of the license; Give credit.</li>
</ul>
</div>
</div>

<div id="outline-container-org0dde064" class="outline-3">
<h3 id="org0dde064"><span class="section-number-3">1.3</span> MuParser - Math expression parser</h3>
<div class="outline-text-3" id="text-1-3">
<p>
MuParser is a non-turing complete embedded scripting engine for
evaluating math expressions. 
</p>

<p>
Web Site: 
</p>
<ul class="org-ul">
<li><a href="https://beltoforion.de/article.php?a=muparser">https://beltoforion.de/article.php?a=muparser</a></li>
</ul>

<p>
Repository: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/beltoforion/muparser/">https://github.com/beltoforion/muparser/</a></li>
</ul>

<p>
Conan Reference: 
</p>
<ul class="org-ul">
<li><a href="https://bintray.com/conan-community/conan/muparser%3Aconan/2.2.6%3Astable">muparser/2.2.6@conan/stable</a></li>
</ul>

<p>
<b>Sample Project</b>
</p>

<p>
File: <b>CMakeLists.txt</b>
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(cppexperiments)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment"># ============= Conan Bootstrap =============================#</span>

<span class="org-comment"># Download automatically, you can also just copy the conan.cmake file</span>
<span class="org-keyword">if</span>(NOT EXISTS <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/conan.cmake"</span>)
   <span class="org-function-name">message</span>(STATUS <span class="org-string">"Downloading conan.cmake from https://github.com/conan-io/cmake-conan"</span>)
   <span class="org-function-name">file</span>(DOWNLOAD <span class="org-string">"https://github.com/conan-io/cmake-conan/raw/v0.13/conan.cmake"</span>
                 <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/conan.cmake"</span>)
<span class="org-keyword">endif</span>()

<span class="org-function-name">include</span>(${<span class="org-variable-name">CMAKE_BINARY_DIR</span>}/conan.cmake)

<span class="org-comment"># Possible values "default" and "llvm8"</span>
<span class="org-function-name">set</span>(CONAN_PROFILE default)

<span class="org-function-name">conan_cmake_run</span>(REQUIRES
                muparser/2.2.6@conan/stable
                BASIC_SETUP
                BUILD missing)

 <span class="org-comment">#======= Targets Settings ===============+#</span>

<span class="org-function-name">add_executable</span>(muparser1_formula muparser1_formula.cpp)
<span class="org-function-name">target_link_libraries</span>(muparser1_formula muparser)
</pre>
</div>

<p>
File: <b>muparser1_formula.cpp</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cmath</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">muParser.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Defined for UNIX-like: Linux, Mac OSX, QNX, ...</span>
<span class="org-preprocessor">#if</span> __unix__
<span class="org-preprocessor">  #include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#endif</span>

<span class="org-type">bool</span> <span class="org-function-name">isTTY_terminal</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-preprocessor">   #if</span> __unix__
      <span class="org-keyword">return</span> ::ttyname<span class="org-rainbow-delimiters-depth-2">(</span>STDIN_FILENO<span class="org-rainbow-delimiters-depth-2">)</span> != <span class="org-constant">nullptr</span>;
<span class="org-preprocessor">   #else</span>
      <span class="org-keyword">return</span> <span class="org-constant">false</span>;
<span class="org-preprocessor">   #endif</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">double</span> <span class="org-function-name">future_value</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">PV</span>, <span class="org-type">double</span> <span class="org-variable-name">rate</span>, <span class="org-type">double</span> <span class="org-variable-name">nper</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> PV * <span class="org-constant">std</span>::pow<span class="org-rainbow-delimiters-depth-2">(</span>1 + rate / 100.0, nper<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-constant">mu</span>::<span class="org-type">Parser</span> <span class="org-variable-name">p1</span>;

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== EXPERIMENT 1 - Simple math expression ======="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    p1.SetExpr<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"2^1 + 2^3 + 2^4"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] p1-A value: "</span>
              &lt;&lt; p1.GetExpr<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; p1.Eval<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    p1.SetExpr<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"3.5 * 10 - sin(3.1415) * 2.0 + sqrt(10) / 100.0 + 2^3"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] p1-B value: "</span>
              &lt;&lt; p1.GetExpr<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; p1.Eval<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== EXPERIMENT 2 - Expression with variables ======="</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    p1.DefineConst<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"pi"</span>, 3.1415<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">double</span> <span class="org-variable-name">x</span> = 10.0, <span class="org-variable-name">y</span> = 4.5;
    p1.DefineVar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"x"</span>, &amp;x<span class="org-rainbow-delimiters-depth-2">)</span>;
    p1.DefineVar<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"y"</span>, &amp;y<span class="org-rainbow-delimiters-depth-2">)</span>;
    p1.SetExpr<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" 3 * pi + sin(pi) + 4 * x + y - 5"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] p1-C value: "</span>
              &lt;&lt; p1.GetExpr<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; p1.Eval<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== EXPERIMENT 3 - Expression with custom function ======="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    p1.DefineFun<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"fv"</span>, &amp;future_value<span class="org-rainbow-delimiters-depth-2">)</span>;

    p1.DefineFun<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"payoff"</span>, <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">double</span> <span class="org-variable-name">S</span>, <span class="org-type">double</span> <span class="org-variable-name">K</span><span class="org-rainbow-delimiters-depth-3">){</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::max<span class="org-rainbow-delimiters-depth-4">(</span>S - K, 0.0<span class="org-rainbow-delimiters-depth-4">)</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    p1.SetExpr<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"fv(100, 2, 8) + payoff(100, 90)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] p1-D value: "</span> &lt;&lt; p1.GetExpr<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">" = "</span> &lt;&lt; p1.Eval<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;


    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== EXPERIMENT 4 - Parser error handling ======="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">When an error happens it throws an exception: mu::ParserError</span>
    <span class="org-keyword">try</span><span class="org-rainbow-delimiters-depth-2">{</span>
        p1.SetExpr<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"10.2 * 5.0 + a * 3"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-type">double</span> <span class="org-variable-name">value</span> = p1.Eval<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] p1-E value: "</span> &lt;&lt; value &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">mu</span>::<span class="org-type">ParserError</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] p1-C Parser error: "</span> &lt;&lt; ex.GetMsg<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n====== EXPERIMENT 5 - Calutor Interactive Shell ======"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>isTTY_terminal<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" === Calculator Started OK. ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;

        <span class="org-constant">mu</span>::<span class="org-type">Parser</span> <span class="org-variable-name">p2</span>;
        <span class="org-type">double</span> <span class="org-variable-name">ans</span> = 0.0;
        p2.DefineVar<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ans"</span>, &amp;ans<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;

        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::cin.good<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" EXPR =&gt; "</span>;
            <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>line == <span class="org-string">""</span><span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-keyword">continue</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>line == <span class="org-string">"quit"</span><span class="org-rainbow-delimiters-depth-4">)</span>
                <span class="org-keyword">break</span>;

            p2.SetExpr<span class="org-rainbow-delimiters-depth-4">(</span>line<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-4">{</span>
                ans = p2.Eval<span class="org-rainbow-delimiters-depth-5">()</span>;
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; ans = "</span> &lt;&lt; ans &lt;&lt; <span class="org-string">"\n\n"</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">mu</span>::<span class="org-type">ParserError</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Parser error "</span> &lt;&lt; ex.GetMsg<span class="org-rainbow-delimiters-depth-5">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
            <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-preprocessor">#if</span> _WIN32
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Enter RETURN to exit. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-constant">std</span>::cin.get<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-preprocessor">#endif</span>
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Program output:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./muparser1_formula 

====== EXPERIMENT 1 - Simple math expression =======
 [*] p1-A value: 2^1 + 2^3 + 2^4  = 26
 [*] p1-B value: 3.5 * 10 - sin(3.1415) * 2.0 + sqrt(10) / 100.0 + 2^3  = 43.0314

====== EXPERIMENT 2 - Expression with variables =======
 [*] p1-C value:  3 * pi + sin(pi) + 4 * x + y - 5  = 48.9246

====== EXPERIMENT 3 - Expression with custom <span class="org-keyword">function</span> =======
 [*] p1-D value: fv(100, 2, 8) + payoff(100, 90)  = 127.166

====== EXPERIMENT 4 - Parser error handling =======
 [ERROR] p1-C Parser error: Unexpected token <span class="org-string">"a"</span> found at position 13.

====== EXPERIMENT 5 - Calutor Interactive Shell ======
 === Calculator Started OK. =====
 EXPR =&gt; 9.81 * sin(3.1415 / 2.0) + 100 * sqrt(285.6) + exp(3.65)
 =&gt; ans = 1738.26

 EXPR =&gt; ans / 100.0 - 80.0
 =&gt; ans = -62.6174

 EXPR =&gt; ans * ans
 =&gt; ans = 3920.94

 EXPR =&gt; 

</pre>
</div>
</div>
</div>

<div id="outline-container-org6ebf8f3" class="outline-3">
<h3 id="org6ebf8f3"><span class="section-number-3">1.4</span> Exprtk - Math expression parser</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Exprtk is a MIT-license single-header, header-only and turing-complete
math expression parsing engine.
</p>

<p>
Official Web Site: 
</p>

<ul class="org-ul">
<li><a href="http://www.partow.net/programming/exprtk/">http://www.partow.net/programming/exprtk/</a></li>
</ul>

<p>
Official repository: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/ArashPartow/exprtk/">https://github.com/ArashPartow/exprtk/</a></li>
</ul>

<p>
Features: 
</p>

<ul class="org-ul">
<li>Header-only library in  a single file.</li>
<li>Turing-complete</li>
<li>Sandboxed</li>
<li>Supports binding to defined-functions in C++-side.</li>
<li>Functions can operate on vectors</li>
<li>Control structures: for-loop; if-else; ternary operator.</li>
</ul>

<p>
Drawbacks: 
</p>

<ul class="org-ul">
<li>The library exprtk.hpp has one megabyte (1 mb) in a single header
file which significantly slows down the compile-time. Header-only
design should only be used for small libraries.</li>
</ul>


<p>
<b>Sample Project</b> 
</p>

<ul class="org-ul">
<li>GIST: <a href="https://gist.github.com/2ff870b653b2ec1519bf0423165db1c5">https://gist.github.com/2ff870b653b2ec1519bf0423165db1c5</a></li>

<li>Note: The static library target 'mparser' makes the compile-time
of the client code 'main.cpp' faster by using the PIMPL
(Pointer-To-Implementation) design pattern and not exposing
exprtk.hpp in the library header file.</li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(exprk-parser)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)
<span class="org-function-name">set</span>(CMAKE_CXX_EXTENSIONS OFF)

<span class="org-comment">#----------- Add dependencies --------------------------#</span>

<span class="org-comment">#============= Functions and macros ===========================#</span>
<span class="org-keyword">macro</span>(Download_Single_Headerlib FILE URL)
    <span class="org-function-name">file</span>(DOWNLOAD ${<span class="org-variable-name">URL</span>} ${<span class="org-variable-name">CMAKE_BINARY_DIR</span>}/include/${<span class="org-variable-name">FILE</span>})
    <span class="org-keyword">IF</span>(NOT Download_Single_Headerlib_flag)
       <span class="org-function-name">include_directories</span>(${<span class="org-variable-name">CMAKE_BINARY_DIR</span>}/include)
       <span class="org-function-name">set</span>(Download_Single_Headerlib_flag TRUE)
    <span class="org-keyword">ENDIF</span>()
<span class="org-keyword">endmacro</span>()

<span class="org-function-name">Download_Single_Headerlib</span>( exprtk.hpp 
                           https://github.com/ArashPartow/exprtk/raw/d81ac1a2ddd9877a7981d32c731fd9a75544ec68/exprtk.hpp )

<span class="org-comment">#-----------  Target settings -------------------------------#</span>

          <span class="org-function-name">add_library</span>( mparser mparser.cpp mparser.hpp )
       <span class="org-function-name">add_executable</span>( main main.cpp )
<span class="org-function-name">target_link_libraries</span>( main mparser )
</pre>
</div>

<p>
File: mparser.hpp  (cmake target: mparser static library)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _MPARSER_HPP_
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_MPARSER_HPP_</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Unique-ownership smart pointer for implementing PimPl</span>
<span class="org-comment-delimiter">// </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: It was created because std::uniqe_ptr does </span>
<span class="org-comment-delimiter">//       </span><span class="org-comment">not support 'incomplete types'.</span>
<span class="org-comment-delimiter">//  </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Note: PimPl (Pointer-To-Implementation) idiom </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">is a technique for reducing compile-time and </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">maintaining ABI stability which mitigates the </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">fragile-ABI problem.</span>
<span class="org-comment-delimiter">// </span>
<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span>, <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-function-name">disposer</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span>*<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">pimpl_ptr</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">T</span>*       <span class="org-variable-name">m_hnd</span>;    
<span class="org-function-name">public</span>:
    <span class="org-function-name">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">()</span>
        : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">, m_disp(disp) </span>
        <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span>* <span class="org-variable-name">hnd</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : m_hnd<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    ~<span class="org-function-name">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;release<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor </span>
    <span class="org-function-name">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">pimpl_ptr</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy-</span>
    <span class="org-type">pimpl_ptr</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">pimpl_ptr</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move Ctor </span>
    <span class="org-function-name">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">pimpl_ptr</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move assignment operator </span>
    <span class="org-type">pimpl_ptr</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">pimpl_ptr</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">T</span>* <span class="org-function-name">get</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">release</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: it is not possible to delete incomplete type </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">in this way: 'delete m_hnd;'</span>
        disposer<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        m_hnd = <span class="org-constant">nullptr</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">reset</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span>* <span class="org-variable-name">hnd</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;release<span class="org-rainbow-delimiters-depth-3">()</span>;
        m_hnd = hnd;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">bool</span> <span class="org-function-name">empty</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd == <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">T</span>&amp;   <span class="org-keyword">operator</span><span class="org-function-name">*</span> <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> *m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">T</span>*   <span class="org-keyword">operator</span><span class="org-function-name">-&gt;</span> <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-keyword">class</span> <span class="org-type">MathEvaluator</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">impl</span>;
    <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">dispose</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">impl</span>* <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">pimpl_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">impl</span>, <span class="org-constant">MathEvaluator</span>::dispose<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">m_pimpl</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">MathEvaluator</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    ~<span class="org-function-name">MathEvaluator</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-type">MathEvaluator</span>&amp; <span class="org-function-name">add_var</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">double</span>&amp; <span class="org-variable-name">ref</span><span class="org-rainbow-delimiters-depth-2">)</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register function pointer callback or non-capture lambda </span>
    <span class="org-type">MathEvaluator</span>&amp; <span class="org-function-name">add_function</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-type">double</span> <span class="org-function-name">fptr</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Register function of two variables </span>
    <span class="org-type">MathEvaluator</span>&amp; <span class="org-function-name">add_function</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-type">double</span> <span class="org-function-name">fptr</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">double</span>, <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">double</span>  <span class="org-function-name">eval_code</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-type">bool</span>    <span class="org-function-name">compile</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">double</span>  <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">void</span>    <span class="org-function-name">repl</span><span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-preprocessor">#endif</span>
</pre>
</div>

<p>
File: mparser.cpp (cmake target: mparser static library)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string">"mparser.hpp"</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">exprtk.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--------------------------------------------------// </span>

<span class="org-keyword">struct</span> <span class="org-constant">MathEvaluator</span>::<span class="org-type">impl</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">exprtk</span>::<span class="org-type">expression</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>   <span class="org-variable-name">expr</span>;
    <span class="org-constant">exprtk</span>::<span class="org-type">symbol_table</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">symbol_table</span>;
    <span class="org-constant">exprtk</span>::<span class="org-type">parser</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>       <span class="org-variable-name">parser</span>;     
    <span class="org-constant">std</span>::<span class="org-type">string</span>                  <span class="org-variable-name">code</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Println function </span>
    <span class="org-constant">exprtk</span>::<span class="org-constant">rtl</span>::<span class="org-constant">io</span>::<span class="org-type">println</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">println</span><span class="org-rainbow-delimiters-depth-2">{}</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">static method </span>
<span class="org-type">void</span> 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">dispose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">impl</span>* <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">delete</span> p;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-function-name">MathEvaluator</span>::MathEvaluator<span class="org-rainbow-delimiters-depth-1">()</span>: m_pimpl<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">impl</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
    m_pimpl-&gt;symbol_table.add_constants<span class="org-rainbow-delimiters-depth-2">()</span>;
    m_pimpl-&gt;expr.register_symbol_table<span class="org-rainbow-delimiters-depth-2">(</span>m_pimpl-&gt;symbol_table<span class="org-rainbow-delimiters-depth-2">)</span>;    
    m_pimpl-&gt;symbol_table.add_function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"println"</span>, m_pimpl-&gt;println<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">MathEvaluator</span>&amp; 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">add_var</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">double</span>&amp; <span class="org-variable-name">ref</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    m_pimpl-&gt;symbol_table.add_variable<span class="org-rainbow-delimiters-depth-2">(</span>name, ref<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">MathEvaluator</span>&amp; 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">add_function</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">double</span> <span class="org-function-name">fptr</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    m_pimpl-&gt;symbol_table.add_function<span class="org-rainbow-delimiters-depth-2">(</span>name, fptr<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">MathEvaluator</span>&amp; 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">add_function</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">double</span> <span class="org-function-name">fptr</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span>, <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    m_pimpl-&gt;symbol_table.add_function<span class="org-rainbow-delimiters-depth-2">(</span>name, fptr<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">compile</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">bool</span> <span class="org-variable-name">r</span> = m_pimpl-&gt;parser.compile<span class="org-rainbow-delimiters-depth-2">(</span>code, m_pimpl-&gt;expr<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>r<span class="org-rainbow-delimiters-depth-2">){</span> 
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">err</span> = <span class="org-string">"Error: "</span>;
        err = err + m_pimpl-&gt;parser.error<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" Error: "</span> &lt;&lt; err &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [PARSER] Unable to parse expression."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> r;
 <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">double</span> 
<span class="org-function-name">MathEvaluator</span>::<span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> m_pimpl-&gt;expr.value<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-constant">MathEvaluator</span>::<span class="org-function-name">repl</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>; 
    <span class="org-type">double</span> <span class="org-variable-name">result</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::cin.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" EXPRTK $ &gt;&gt; "</span>;
        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>line.empty<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">continue</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>line == <span class="org-string">"exit"</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span>;
        <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">this</span>-&gt;compile<span class="org-rainbow-delimiters-depth-4">(</span>line<span class="org-rainbow-delimiters-depth-4">)</span>;            
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-keyword">this</span>-&gt;value<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">runtime_error</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"Error: "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: main.cpp  (cmake target: main)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string">"mparser.hpp"</span>

<span class="org-type">double</span> <span class="org-function-name">myfun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-type">double</span> <span class="org-variable-name">b</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span>   <span class="org-function-name">test_engine</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MathEvaluator</span>&amp; <span class="org-variable-name">engine</span>, <span class="org-type">double</span>&amp; <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] I am up and running Ok. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">MathEvaluator</span> <span class="org-variable-name">engine</span>;    
    <span class="org-type">double</span> <span class="org-variable-name">x</span> = 1.0, <span class="org-variable-name">y</span> = 2.0, <span class="org-variable-name">z</span> = 3.0;
    engine.add_var<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"x"</span>, x<span class="org-rainbow-delimiters-depth-2">)</span>
        .add_var<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"y"</span>, y<span class="org-rainbow-delimiters-depth-2">)</span>
        .add_var<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"z"</span>, z<span class="org-rainbow-delimiters-depth-2">)</span>
        .add_function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"myfun"</span>, &amp;myfun<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span>argc == 2<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"test"</span> <span class="org-rainbow-delimiters-depth-2">){</span> test_engine<span class="org-rainbow-delimiters-depth-3">(</span>engine, x<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"repl"</span> <span class="org-rainbow-delimiters-depth-2">){</span> engine.repl<span class="org-rainbow-delimiters-depth-3">()</span>;          <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] Shutdown engine Ok. "</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-----------------------------------------//</span>


<span class="org-type">double</span> <span class="org-function-name">myfun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-type">double</span> <span class="org-variable-name">b</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [TRACE] a = "</span> &lt;&lt; a &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [TRACE] b = "</span> &lt;&lt; b &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-type">double</span> <span class="org-variable-name">r</span> =  3.0 * a + 5.0 * b;
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [TRACE] result = "</span> &lt;&lt; r &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"---------------------------------\n"</span>;
    <span class="org-keyword">return</span> r;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">test_engine</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MathEvaluator</span>&amp; <span class="org-variable-name">engine</span>, <span class="org-type">double</span>&amp; <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span> = R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">        // Define local variables </span>
<span class="org-string">        var a := 2.0 / exp(x) * x^2 + y;</span>
<span class="org-string">        var b := 10.0 * sqrt(x) + z;</span>

<span class="org-string">        // println('\n =&gt; x = ', x);</span>
<span class="org-string">        // println('\n =&gt; y = ', y);</span>

<span class="org-string">        // Call custom function</span>
<span class="org-string">        var k := myfun(x, y);</span>

<span class="org-string">        // Comment: the last expression is returned </span>
<span class="org-string">        4.0 * a + 3 * b + 10 * z + k;        </span>
<span class="org-string">    )</span><span class="org-default">"</span>;        
    engine.compile<span class="org-rainbow-delimiters-depth-2">(</span>code<span class="org-rainbow-delimiters-depth-2">)</span>;

    x = 3.0;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; engine = "</span> &lt;&lt; engine.value<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

    x = 5.0;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; engine = "</span> &lt;&lt; engine.value<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

    x = 15.0;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; engine = "</span> &lt;&lt; engine.value<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

    x = -15.0;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; engine = "</span> &lt;&lt; engine.value<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

    x = 20.0;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; engine = "</span> &lt;&lt; engine.value<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;


    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code2</span> = R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">        // Vector/array variable </span>
<span class="org-string">        var xs [6] := {  2.0, 10.2,   -2.50,  9.256, 100.0,  25.0 };</span>
<span class="org-string">        var ys [6] := { -2.0,  1.225, -5.56, 19.000, 125.0, 125.0 };</span>

<span class="org-string">        println(' =&gt; xs =', xs);</span>
<span class="org-string">        println(' =&gt; ys = ', ys);</span>
<span class="org-string">        println(' =&gt; 3 * xs + 4 * ys = ', 3 * xs + 4 * ys);</span>
<span class="org-string">        println(' =&gt; sum(xs) = ', sum(ys) );</span>
<span class="org-string">        println(' =&gt; sum(ys) = ', sum(xs) );</span>

<span class="org-string">    )</span><span class="org-default">"</span>;
    engine.compile<span class="org-rainbow-delimiters-depth-2">(</span>code2<span class="org-rainbow-delimiters-depth-2">)</span>;
    engine.value<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/2ff870b653b2ec1519bf0423165db1c5 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake --config Debug -H. -B_build  
$ cmake --build _build --target 
</pre>
</div>

<p>
<b>Running</b> 
</p>

<p>
Running 'test' subcommand. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Redirect std::cerr or stderr to file </span>
$ _build/main test 2&gt; out.log
 [TRACE] I am up and running Ok. 
 =&gt; x = 3 ; engine = 121.546
 =&gt; x = 5 ; engine = 140.43
 =&gt; x = 15 ; engine = 218.19
 =&gt; x = -15 ; engine = -nan
 =&gt; x = 20 ; engine = 251.164
 =&gt; xs =   2.00000   10.20000   -2.50000    9.25600  100.00000   25.00000
 =&gt; ys =   -2.00000    1.22500   -5.56000   19.00000  125.00000  125.00000
 =&gt; 3 * xs + 4 * ys =   -2.00000   35.50000  -29.74000  103.76800  800.00000  575.00000
 =&gt; sum(xs) =  262.66500
 =&gt; sum(ys) =  143.95600

<span class="org-comment-delimiter"># </span><span class="org-comment">View log file </span>
$ _build/main test 2&gt; out.log
 [TRACE] I am up and running Ok. 
 =&gt; x = 3 ; engine = 121.546
 =&gt; x = 5 ; engine = 140.43
 =&gt; x = 15 ; engine = 218.19
 =&gt; x = -15 ; engine = -nan
 =&gt; x = 20 ; engine = 251.164
 =&gt; xs =   2.00000   10.20000   -2.50000    9.25600  100.00000   25.00000
 =&gt; ys =   -2.00000    1.22500   -5.56000   19.00000  125.00000  125.00000
 =&gt; 3 * xs + 4 * ys =   -2.00000   35.50000  -29.74000  103.76800  800.00000  575.00000
 =&gt; sum(xs) =  262.66500
 =&gt; sum(ys) =  143.95600
</pre>
</div>

<p>
Running 'repl' subcommand for interactive shell.
</p>

<div class="org-src-container">
<pre class="src src-sh"> rlwrap _build/main repl 
 [TRACE] I am up and running Ok. 
 EXPRTK $ &gt;&gt; sin(pi) * 2.0  + 5.3 * cos(3/2 * pi)
-7.28665e-16
 EXPRTK $ &gt;&gt; exp(3.1)
22.198
 EXPRTK $ &gt;&gt; var a := exp(2.5); var b := a * 3.0 + 10.0; 3 * a + b
83.095
 EXPRTK $ &gt;&gt; 
 EXPRTK $ &gt;&gt; println(<span class="org-string">' x = '</span>, x)
 x =    1.00000
0
 EXPRTK $ &gt;&gt; myfun(5.1, 2.56)
  [TRACE] a = 5.1
  [TRACE] b = 2.56
  [TRACE] result = 28.1
---------------------------------
28.1
 EXPRTK $ &gt;&gt; 
 EXPRTK $ &gt;&gt; myfun(5.1, 2.0 * pi + 10.0)
  [TRACE] a = 5.1
  [TRACE] b = 16.2832
  [TRACE] result = 96.7159
---------------------------------
96.7159
 EXPRTK $ &gt;&gt; 
 EXPRTK $ &gt;&gt; exit
 [TRACE] Shutdown engine Ok. 

</pre>
</div>
</div>
</div>
<div id="outline-container-org4a3e277" class="outline-3">
<h3 id="org4a3e277"><span class="section-number-3">1.5</span> Lua scripting engine</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-org57ee89d" class="outline-4">
<h4 id="org57ee89d"><span class="section-number-4">1.5.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
Lua (moon in Portuguese) is a ligthweight multi paradigm scripting
language written in C. Due to Lua be available as small footprint
libraryn this language is widely used as embedded scripting by many
applications for scripting and as configuration or data description
language.
</p>

<p>
Use cases: 
</p>

<ul class="org-ul">
<li>Scripting for C or C++ applications</li>

<li>Extension language =&gt; Add new functionality and updates without
recompilation.</li>

<li>Provide interactive REPL or shell to C or C++ applications.</li>

<li>Program configuration (settings)</li>

<li>Data description language</li>
</ul>

<p>
Some applications using Lua: 
</p>

<ul class="org-ul">
<li><a href="https://nmap.org/book/nse-language.html">Nmap</a> network scanner</li>
<li>MediaWiki (engine used by Wikipedia)</li>
<li>Nginx Web Server</li>
<li>Redis Database</li>
<li>Linux Conky</li>
<li>LuaTex</li>
<li>NetBSD</li>
<li>Cheat Engine</li>
<li>Geany text editor</li>
<li><a href="https://github.com/xmake-io/xmake">Xmake</a> building system for C, C++, Objective-C, Swift, Assembly,
Golang, Rust, Dlang and Cuda</li>
<li><a href="https://en.wikipedia.org/wiki/Category:Lua-scripted_video_games">Lots of games</a> use lua for scripting and allow non-programmers,
such as end-users and game artists to contribute to the game
development, create animations, movements, finite state machines
and so on.</li>
<li>&#x2026; &#x2026;</li>
</ul>

<p>
More at: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/List_of_applications_using_Lua">List of applications using Lua - Wikipedia</a></li>

<li><a href="https://web.archive.org/web/20180322033939/https://en.wikipedia.org/wiki/Category:Lua-scripted_video_games">Category:Lua-scripted video games - Wikipedia</a></li>
</ul>


<p>
<b>Repository and  C++ Binding Libraries</b> 
</p>

<ul class="org-ul">
<li>Official Repository Mirror
<ul class="org-ul">
<li><a href="https://github.com/lua/lua">https://github.com/lua/lua</a></li>
</ul></li>

<li>Lua Bind
<ul class="org-ul">
<li><a href="https://www.rasterbar.com/products/luabind/docs.html">https://www.rasterbar.com/products/luabind/docs.html</a></li>
<li><a href="https://sourceforge.net/projects/luabind/">https://sourceforge.net/projects/luabind/</a></li>
<li><a href="https://github.com/luabind/luabind">https://github.com/luabind/luabind</a></li>
</ul></li>

<li>Sol2 (means 'sun' 2 in Portuguese)
<ul class="org-ul">
<li><a href="https://github.com/ThePhD/sol2">https://github.com/ThePhD/sol2</a></li>
<li><a href="https://sol2.readthedocs.io/en/latest/">https://sol2.readthedocs.io/en/latest/</a></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf76553a" class="outline-4">
<h4 id="orgf76553a"><span class="section-number-4">1.5.2</span> Further Reading</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.lua.org/manual/5.1/manual.html">Lua 5.1 Reference Manual</a> - Documentation</li>

<li><a href="https://en.wikipedia.org/wiki/Lua_(programming_language)">Lua (programming language) - Wikipedia</a></li>
</ul>

<p>
<b>Lua C API</b>
</p>

<ul class="org-ul">
<li><a href="https://www.lua.org/pil/24.1.html">Programming in Lua : 24.1</a></li>

<li><a href="http://lua-users.org/wiki/BindingCodeToLua">lua-users wiki: Binding Code To Lua</a></li>

<li><a href="http://lua-users.org/wiki/SimpleLuaApiExample">lua-users wiki: Simple Lua Api Example</a></li>

<li><a href="http://webserver2.tecgraf.puc-rio.br/lua/local/pil/24.html">Programming in Lua : 24</a></li>

<li><a href="https://chsasank.github.io/lua-c-wrapping.html">Exposing C functions to Lua</a></li>
</ul>

<p>
<b>Lua embedded in Geany Text Editor</b> 
</p>

<ul class="org-ul">
<li><a href="https://plugins.geany.org/geanylua/geanylua-intro.html">https://plugins.geany.org/geanylua/geanylua-intro.html</a></li>

<li><a href="https://github.com/geany/geany-plugins/tree/master/geanylua/examples">https://github.com/geany/geany-plugins/tree/master/geanylua/examples</a></li>

<li><a href="https://github.com/DGivney/geany-lua-scripts">https://github.com/DGivney/geany-lua-scripts</a>
<ul class="org-ul">
<li>Collection of Lua scripts for Geany text editor</li>
</ul></li>

<li><a href="https://github.com/geany/geany-plugins/tree/master/geanylua">https://github.com/geany/geany-plugins/tree/master/geanylua</a></li>
</ul>

<p>
<b>Lua scripting in NMap Network Scanner</b> 
</p>

<ul class="org-ul">
<li><a href="https://nmap.org/book/nse-language.html">Script Language | Nmap Network Scanning</a>
<ul class="org-ul">
<li>"The core of the Nmap Scripting Engine <b>is an embeddable Lua</b>
<b>interpreter</b>. <span class="underline">Lua is a lightweight language designed for</span>
<span class="underline">extensibility. It offers a powerful and well-documented API for</span>
interfacing with other software such as Nmap. The second part of
<span class="underline">the Nmap Scripting Engine is the NSE Library, which connects Lua</span>
<span class="underline">and Nmap</span>. This layer handles issues such as initialization of
the Lua interpreter, scheduling of parallel script execution,
script retrieval and more. It is also the heart of the NSE
network I/O framework and the exception handling mechanism. It
also includes utility libraries to make scripts more powerful
and convenient. The utility library modules and extensions are
described in the section called 'NSE Libraries'."</li>
</ul></li>

<li><a href="https://github.com/nmap/nmap/tree/master/nselib">Nmap Scripting Engine Source Code</a> / GITHUB</li>

<li><a href="https://dev.to/citizen428/extending-nmap-withlua-bpa">Extending Nmap WithLua - DEV</a></li>
</ul>


<p>
<b>Lua Scripting in Wireshark - Network Capture Application</b>
</p>

<ul class="org-ul">
<li><a href="https://wiki.wireshark.org/Lua">Lua - The Wireshark Wiki</a></li>

<li><a href="https://sharkfestus.wireshark.org/sharkfest.09/DT06_Bjorlykke_Lua%20Scripting%20in%20Wireshark.pdf">Lua Scripting in Wireshark</a></li>
</ul>

<p>
<b>Lua Scripting in XMake Building System</b> 
</p>

<ul class="org-ul">
<li><a href="https://github.com/xmake-io/xmake">https://github.com/xmake-io/xmake</a></li>

<li><a href="https://github.com/xmake-io/xmake/search?l=C%2B%2B&amp;q=lua&amp;type=">Search for usages of Lua C API in Xmake source code</a></li>
</ul>

<p>
<b>Lua scripting on NetBSD Kernel</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.netbsd.org/gallery/presentations/mbalmer/fosdem2012/kernel_mode_lua.pdf">Lua in teh NetBSD Kernel</a></li>

<li><a href="https://2018.eurobsdcon.org/static/slides/Fast,%20Flexible%20Packet%20Filtering%20in%20NetBSD%20using%20Lua%20Kernel%20Scripts%20-%20Andrew%20von%20Dollen.pdf">Lua Kernel Scripting in NetBSD - Fast, Flexible Packet Filtering</a></li>

<li><a href="https://www.lua.org/wshop13/Cormack.pdf">Towards a Lua scripted operating system</a></li>

<li><a href="https://www.slideshare.net/eurobsdcon/lneto-npf-scripting">NPF scripting with Lua by Lourival Vieira Neto</a></li>
</ul>


<p>
<b>Lua scripting on Redis Database</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.slideshare.net/itamarhaber/redis-lua-scripts">Redis Lua Scripts</a></li>

<li><a href="https://www.slideshare.net/RedisLabs/redis-lua-scripts-a-primer-and-use-cases">Redis: Lua scripts - a primer and use cases</a></li>
</ul>


<p>
<b>Lua scripting on Nginx Web Server</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.nginx.com/resources/wiki/modules/lua/">Lua on NGINX web server</a></li>

<li><a href="https://blog.cloudflare.com/pushing-nginx-to-its-limit-with-lua/">Pushing Nginx to its limit with Lua</a> - CloudFlare</li>

<li><a href="https://www.slideshare.net/gakhov/implementing-a-fileserver-with-nginx-and-lua">Implementing a Fileserver with Nginx and Lua</a></li>
</ul>


<p>
<b>Lua scripting on Unreal Engine / game engine</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.slideshare.net/Codemotion/roberto-de-ioris-scriptiamo-unreal-engine-con-lua-codemotion-rome-2019">Roberto De Ioris - Scriptiamo Unreal Engine con Lua - Codemotion Rome</a></li>

<li><a href="https://github.com/rdeioris/LuaMachine">GitHub - rdeioris/LuaMachine: Unreal Engine 4 Plugin for Lua APIs implementation</a></li>

<li><a href="https://www.unrealengine.com/marketplace/en-US/product/luamachine">LuaMachine by Roberto De Ioris in Code Plugins - UE4 Marketplace</a>
<ul class="org-ul">
<li>"Unreal Engine 4 Plugin for adding Lua scripting to your
projects: If you want modders to customize your game/project, or
you need to allow game designers to script parts of the logic,
this plugin is for you; Contrary to the other Unreal Engine 4
Lua plugins, this one does not try to expose the Unreal Engine 4
api, but completely hides it exposing to the user/scripter only
the features the developer decided to include (via Blueprints or
C++); Currently Windows 64bit, Mac, Linux x86_64 (both Runtime
and Editor), Linux AArch64, Android 32bit, Android 64bit, iOS
(Runtime only) are supported."</li>
</ul></li>
</ul>

<p>
<b>Lua for DSL - Domain Specific Language</b>  
</p>

<ul class="org-ul">
<li><a href="http://lua-users.org/wiki/LuaDataFormats">lua-users wiki: Lua Data Formats</a>
<ul class="org-ul">
<li>"Lua can be used as a language to represent data, not just as a
general programming language.  Different languages have been
devised for different types of data representation in text
format."</li>
</ul></li>

<li><a href="https://leafo.net/guides/dsl-in-lua.html">Writing a DSL in Lua</a></li>

<li><a href="https://www.slideshare.net/agladysh/luaws13-ag">A visual DSL toolkit in Lua: Past, present and future</a></li>

<li><a href="https://dnaeon.github.io/choosing-lua-as-the-ddl-and-config-language/">Choosing Lua as the data description and configuration language</a></li>

<li><a href="https://www.lua.org/wshop11/luaws11_ag.pdf">Declarative Internal DSLs in Lua / A Game-Changing Experience</a></li>

<li><a href="https://en.m.wikibooks.org/wiki/Lua_Programming/Tables">Lua Programming/Tables - Wikibooks, open books for an open world</a></li>

<li><a href="https://en.m.wikiversity.org/wiki/Lua/Tables">Lua/Tables - Wikiversity</a></li>

<li><a href="https://sudonull.com/post/184529-Lua-declarative-programming-basics">Lua declarative programming basics / Sudo Null IT News</a></li>

<li><a href="https://www.slideshare.net/ShuaiYuan/the-basics-and-design-of-lua-table">The basics and design of lua table</a></li>
</ul>

<p>
<b>Videos</b>
</p>

<ul class="org-ul">
<li><a href="https://www.youtube.com/watch?v=pfwHCiP1HFM">CppCon 2017: Andreas Weis "Howling at the Moon: Lua for C++ Programmers"</a>
<ul class="org-ul">
<li>"C++ is a great tool for solving complex problems in a thorough
way. But every once in a while, the desire for a simpler
language emerges. For those parts of our code where performance
is of secondary concern, but the ability to perform rapid
iterations over the code is paramount, a scripting language
might be a tempting choice. But integrating a second language
besides C++ and managing the interaction between the two is also
scary. Lua is a lightweight, dynamic language that was designed
to be used as an embedded language within existing
applications. It is easy to learn, has very reasonable runtime
performance, and a memory footprint small enough that it is
usable even on embedded systems. Furthermore, it is almost
trivial to integrate with C++. This talk will give a brief
introduction to the Lua scripting language, highlighting
specifically how it can complement C++'s language features to
enrich a developer's toolbox. In the second part of the talk, we
will look at Lua's C API and give suggestions how to integrate
it with a modern C++17 codebase. In particular we will focus on
how to interface with the dynamic language Lua without
compromising the benefits of C++'s strong type system."</li>
</ul></li>

<li><a href="https://www.youtube.com/watch?v=xQAmGBfKnas">CppCon 2018: JeanHeyd Meneide Scripting at the Speed of Thought: Lua and C++ with sol3</a>
<ul class="org-ul">
<li>"A big part of accelerating development and promoting
collaboration often translates to deferring a lot of the typical
programmer work to a scripting language, to allow for those with
more design-oriented ideas and experience to handle some of the
workload. What happens, then, when you have to bind a scripting
language like Lua into C++ to allow for this workflow? This
session is going to be all about how you enable non-developers
and developers alike to rapidly increase their development
productivity by turning routines and algorithms into data that
can be shipped alongside your product in Lua. We will talk
primarily how you can use the library sol2 to abstract away the
muck of working with the Lua C API and instead focus on using
and describing both Lua and C++ with each other in a simple
manner. We will demonstrate some of the more interesting
properties of sol such as Overloading Support, Container
Support, Usertypes &#x2013; C++ classes made available with automatic
support for unique/shared pointers &#x2013; and Tables. By the time
this session is over, you will have a firm grasp over what a
good Lua Binding can offer you, and how you can accelerate your
C++ development with it."</li>
</ul></li>
</ul>

<p>
<b>General</b> 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/List_of_applications_using_Lua">List of applications using Lua - Wikipedia</a></li>

<li><a href="https://en.wikipedia.org/wiki/Category:Lua-scripted_video_games">Category:Lua-scripted video games - Wikipedia</a></li>

<li><a href="http://www.godpatterns.com/2005/07/using-lua-scripting-for-games.html">Godpatterns: Using Lua Scripting For Games</a></li>

<li><a href="https://gamedev.stackexchange.com/questions/73728/how-does-lua-work-as-a-scripting-language-in-games">c++ - How does Lua work as a scripting language in games? - Game Development Stack Exchange</a></li>

<li><a href="https://steamcommunity.com/sharedfiles/filedetails/?id=398177770">Steam Community - Guide - GameGuru LUA scripting summary and guide.</a></li>
</ul>
</div>
</div>

<div id="outline-container-org112ef02" class="outline-4">
<h4 id="org112ef02"><span class="section-number-4">1.5.3</span> Example project with Sol2 C++ binding library</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
This sample project builds a C++ statically linked executable
embedding the Lua scripting engine using the Sol2 binding library,
which is header only. Neither Sol2 nor Lua libraries need to be
installed before building this sample project as the CMake scripts
take care of downloading and building all dependencies.
</p>

<p>
Lua repostiory mirror: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/lua/lua">https://github.com/lua/lua</a></li>
</ul>

<p>
Sol2 library repository: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/ThePhD/sol2">https://github.com/ThePhD/sol2</a></li>
</ul>

<p>
Sol2 library documentation: 
</p>

<ul class="org-ul">
<li><a href="https://sol2.readthedocs.io/en/latest/">https://sol2.readthedocs.io/en/latest/</a></li>
</ul>


<p>
<b>Sample Project</b> 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/17a37d905d3d71c0ae66661a189481b5">https://gist.github.com/17a37d905d3d71c0ae66661a189481b5</a></li>
</ul>


<p>
File: <span class="underline">CMakeLists.txt</span>
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(duktape-cc-trial)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">include</span>(lua-lib.cmake)

<span class="org-comment">#-----  Target Definitions ----------------------------#</span>

       <span class="org-function-name">add_executable</span>( embed-lua-sol embed-lua-sol.cpp)
<span class="org-function-name">target_link_libraries</span>( embed-lua-sol lua::lualib )

<span class="org-comment"># Lua REPL executable built from static library liblua.a (Linux)</span>
<span class="org-comment"># Note: the main() function is in the file main.c in the lua sources directory</span>
       <span class="org-function-name">add_executable</span>( lua-repl $&lt;TARGET_OBJECTS:lua::lualib&gt; )
<span class="org-function-name">target_link_libraries</span>( lua-repl m pthread )
</pre>
</div>


<p>
File: <span class="underline">lua-lib.cmake</span>
</p>

<ul class="org-ul">
<li>CMake Script for downloading sol2 binding library and lua library
sources.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">include</span>(FetchContent)

<span class="org-comment"># Note: the 'add_subriectory' line was commented becuyase </span>
<span class="org-comment">#       library that will be downloaded does not have </span>
<span class="org-comment">#       a CMakeListst.txt file at the root directory. </span>
<span class="org-keyword">macro</span>(Download_Library_Git  NAME TAG REPOSITORY_URL)
    <span class="org-function-name">FetchContent_Declare</span>(
        ${<span class="org-variable-name">NAME</span>}
        GIT_REPOSITORY  ${<span class="org-variable-name">REPOSITORY_URL</span>}
        GIT_TAG         ${<span class="org-variable-name">TAG</span>}
    )
    <span class="org-function-name">FetchContent_GetProperties</span>(${<span class="org-variable-name">NAME</span>})
    <span class="org-keyword">if</span>(NOT cpputest_POPULATED)
        <span class="org-function-name">FetchContent_Populate</span>(${<span class="org-variable-name">NAME</span>})
        <span class="org-function-name">message</span>(<span class="org-string">"${</span><span class="org-variable-name">NAME</span><span class="org-string">}_SOURCE_DIR} = ${${</span><span class="org-variable-name">NAME</span><span class="org-string">}_SOURCE_DIR}"</span>)        

        <span class="org-comment"># =&gt; Disable following line: the library does not have a CMakeLists.txt</span>
        <span class="org-comment">#    at the root directory.</span>
        <span class="org-comment"># add_subdirectory(${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_SOURCE_DIR} ${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_BINARY_DIR})</span>
    <span class="org-keyword">endif</span>()
<span class="org-keyword">endmacro</span>()


<span class="org-comment"># ====&gt;&gt; Download Lua library &lt;&lt;==========================#</span>

<span class="org-function-name">Download_Library_Git</span>( lua                       
                      v5.3.5
                      https://github.com/lua/lua
                    )

<span class="org-function-name">file</span>(GLOB_RECURSE lua_sources <span class="org-string">"${</span><span class="org-variable-name">lua_SOURCE_DIR</span><span class="org-string">}/*.c"</span>)
<span class="org-function-name">file</span>(GLOB_RECURSE lua_headers<span class="org-string">" ${</span><span class="org-variable-name">lua_SOURCE_DIR</span><span class="org-string">}/*.h"</span>)

<span class="org-function-name">message</span>( [TRACE] <span class="org-string">" lua_SOURCE_DIR = ${</span><span class="org-variable-name">lua_SOURCE_DIR</span><span class="org-string">} "</span>)

               <span class="org-function-name">add_library</span>( lua STATIC ${<span class="org-variable-name">lua_sources</span>} ${<span class="org-variable-name">lua_headers</span>} )
<span class="org-function-name">target_include_directories</span>( lua PUBLIC ${<span class="org-variable-name">lua_SOURCE_DIR</span>} )

<span class="org-function-name">add_library</span>( lua::lualib  ALIAS lua)

<span class="org-comment"># ====&gt;&gt; Download Sol C++ binding library &lt;&lt;====================#</span>

<span class="org-function-name">FetchContent_Declare</span>( sol2 
                      GIT_REPOSITORY  https://github.com/ThePhD/sol2
                      GIT_TAG         v3.2.0
                    )

<span class="org-function-name">FetchContent_MakeAvailable</span>( sol2 )
<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">sol2_SOURCE_DIR</span>}/include )

</pre>
</div>

<p>
File: <span class="underline">xmake.lua</span>  
</p>

<ul class="org-ul">
<li>Building script for <a href="https://xmake.io">XMake</a> building system, which uses lua as
embedded scripting language and as a building system DSL (Domain
Specific Language) .</li>
<li>Xmake packages: <a href="https://github.com/xmake-io/xmake-repo/blob/master/packages/s/sol2/xmake.lua">sol2</a>, <a href="https://github.com/xmake-io/xmake-repo/blob/master/packages/l/lua/xmake.lua">lua</a>, <a href="https://github.com/xmake-io/xmake-repo/blob/master/packages/l/luajit/xmake.lua">luajit</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-lua">add_rules(<span class="org-string">"mode.debug"</span>, <span class="org-string">"mode.release"</span>)

includes_lua = <span class="org-constant">false</span> 

add_requires(<span class="org-string">"sol2 v3.2.1"</span>)

target(<span class="org-string">"embed-lua-sol"</span>)
  set_kind(<span class="org-string">"binary"</span>)
  set_languages(<span class="org-string">"c++17"</span>)
  add_files(<span class="org-string">"./embed-lua-sol.cpp"</span>)
  add_packages(<span class="org-string">"sol2"</span>)  
</pre>
</div>


<p>
File: <span class="underline">embed-lua-sol.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sol/sol.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">class</span> <span class="org-type">Counter</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>: 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_name</span>;
    <span class="org-type">int</span>         <span class="org-variable-name">m_counter</span>;

<span class="org-function-name">public</span>: 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ctor [1] =&gt; Default ctor </span>
    <span class="org-function-name">Counter</span><span class="org-rainbow-delimiters-depth-2">()</span>: Counter<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"untitled"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ctor [2]</span>
    <span class="org-function-name">Counter</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">int</span> <span class="org-variable-name">counter</span><span class="org-rainbow-delimiters-depth-2">)</span>
      : m_name<span class="org-rainbow-delimiters-depth-2">{</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-3">(</span>name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">}</span>, m_counter<span class="org-rainbow-delimiters-depth-2">{</span>counter<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Counter created with =&gt;  { "</span> 
                  &lt;&lt;   <span class="org-string">" name = "</span> &lt;&lt; m_name 
                  &lt;&lt; <span class="org-string">" ; counter = "</span> &lt;&lt; m_counter 
                  &lt;&lt; <span class="org-string">" } \n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span> <span class="org-function-name">getCounter</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_counter; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">setCounter</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>       
      m_counter = n; 
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] I was set to value "</span> &lt;&lt; n &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">increment</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span>       
      m_counter++; 
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] increment event =&gt;&gt; counter = {  "</span> 
                &lt;&lt; m_name &lt;&lt; <span class="org-string">" ; "</span> &lt;&lt; m_counter 
                &lt;&lt; <span class="org-string">" } "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">double</span> <span class="org-function-name">add_fun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-type">double</span> <span class="org-variable-name">b</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] addfun() =&gt; a = "</span> &lt;&lt; a 
              &lt;&lt; <span class="org-string">" ; b = "</span> &lt;&lt; b &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-keyword">return</span> a + b;             
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">sol_eval</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">sol</span>::<span class="org-type">state</span>&amp; <span class="org-variable-name">ctx</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        ctx.script<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-4">(</span>code<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;        
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">sol</span>::<span class="org-type">error</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [SOL ERROR] "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create an instance of lua Engine (aka virtual Machine)</span>
    <span class="org-constant">sol</span>::<span class="org-type">state</span> <span class="org-variable-name">ctx</span><span class="org-rainbow-delimiters-depth-2">{}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load basic libraries (such as print)</span>
    ctx.open_libraries<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">sol</span>::<span class="org-constant">lib</span>::base, <span class="org-constant">sol</span>::<span class="org-constant">lib</span>::coroutine, <span class="org-constant">sol</span>::<span class="org-constant">lib</span>::string, <span class="org-constant">sol</span>::<span class="org-constant">lib</span>::io<span class="org-rainbow-delimiters-depth-2">)</span>;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register function pointer </span>
    ctx.set_function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"add_fun"</span>, &amp;add_fun<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register lambda object </span>
    ctx.set_function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"make_vector"</span>, <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">int</span> <span class="org-variable-name">n</span> <span class="org-rainbow-delimiters-depth-3">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">vec</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>n<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; n; i++ <span class="org-rainbow-delimiters-depth-4">)</span> vec<span class="org-rainbow-delimiters-depth-4">[</span>i<span class="org-rainbow-delimiters-depth-4">]</span>= i * 3;
        <span class="org-keyword">return</span> vec;
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Set variables in the Lua engine </span>
    ctx<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"points"</span><span class="org-rainbow-delimiters-depth-2">]</span>    = 2000;
    ctx.set<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"character"</span>, <span class="org-string">"&lt;Marcus Tulius Cicero&gt;"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">===========&gt;&gt;&gt; E X P E  R I M E N T / 1  &lt;&lt;=========*/</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 1] ==&gt;&gt; Evaluating string as code "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">===&gt;&gt;&gt; Eval code as string &lt;&lt;=== </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Throws exception sol::error </span>
        ctx.script<span class="org-rainbow-delimiters-depth-3">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">            print(" [LUA] Hello world lua "); </span>

<span class="org-string">            x = add_fun(10, 20);</span>
<span class="org-string">            print("\n  [LUA] result =  " .. x);</span>

<span class="org-string">            v = make_vector(5);</span>
<span class="org-string">            print("\n  [LUA] Printing a vector ");</span>

<span class="org-string">            for i = 1, 5 do </span>
<span class="org-string">                print("   -&gt; v[" .. i .. " ] = " .. v[i] );</span>
<span class="org-string">            end </span>

<span class="org-string">            print("  [LUA] VAR points    = " .. points );</span>
<span class="org-string">            print("  [LUA] VAR character = " .. character );</span>
<span class="org-string">        )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">===========&gt;&gt;&gt; E X P E  R I M E N T / 2  &lt;&lt;=========*/</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n\n [EXPERIMENT 2] ==&gt;&gt; Reading configuration "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-rainbow-delimiters-depth-2">{</span>
        ctx.script<span class="org-rainbow-delimiters-depth-3">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">            -- Simulation of user configuration from script     </span>
<span class="org-string">            asset_path   = "C:\\\\Users\\myuser\\data\\files\\";</span>
<span class="org-string">            user_credits = 2000;</span>
<span class="org-string">            width        = 200.561;        </span>
<span class="org-string">        )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">asset_path</span> = ctx.get<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"asset_path"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-type">int</span> <span class="org-variable-name">user_credits</span> = ctx<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"user_credits"</span><span class="org-rainbow-delimiters-depth-3">]</span>;

        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] =&gt; asset_path = "</span> &lt;&lt; asset_path &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] =&gt; user_credits = "</span> &lt;&lt; user_credits &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">===========&gt;&gt;&gt; E X P E  R I M E N T / 3  &lt;&lt;=========*/</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n\n [EXPERIMENT 3] ==&gt;&gt; Register C++ classes "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">struct</span> <span class="org-type">StatefulFunctor</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">int</span> <span class="org-variable-name">state</span> = 0;
        <span class="org-function-name">StatefulFunctor</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">state</span><span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-function-name">state</span><span class="org-rainbow-delimiters-depth-3">(</span>state<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-type">int</span> <span class="org-keyword">operator</span><span class="org-function-name"><span class="org-rainbow-delimiters-depth-3">()</span></span><span class="org-rainbow-delimiters-depth-3">(){</span> 

            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  *=&gt;&gt; [StatefulFunctor] My new state is = "</span> 
                      &lt;&lt; <span class="org-keyword">this</span>-&gt;state &lt;&lt; <span class="org-string">"\n"</span>;
            <span class="org-keyword">return</span> state++; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">stateful</span> = StatefulFunctor<span class="org-rainbow-delimiters-depth-2">(</span>10<span class="org-rainbow-delimiters-depth-2">)</span>;
    ctx.set_function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"stateful"</span>, stateful<span class="org-rainbow-delimiters-depth-2">)</span>;

    ctx.script<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        stateful();</span>
<span class="org-string">        stateful();</span>
<span class="org-string">        stateful();</span>
<span class="org-string">    )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


    ctx.new_usertype<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Counter</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Class name </span>
         <span class="org-string">"Counter"</span>          

        <span class="org-comment-delimiter">//  </span><span class="org-comment">--- Register methods  ------ //</span>
        ,<span class="org-string">"getCounter"</span>, &amp;<span class="org-constant">Counter</span>::getCounter
        ,<span class="org-string">"setCounter"</span>, &amp;<span class="org-constant">Counter</span>::setCounter
        ,<span class="org-string">"increment"</span>,  &amp;<span class="org-constant">Counter</span>::increment

        <span class="org-comment-delimiter">// </span><span class="org-comment">--- Register properties  ---- //</span>
        , <span class="org-string">"value"</span>,     <span class="org-constant">sol</span>::property<span class="org-rainbow-delimiters-depth-3">(</span> &amp;<span class="org-constant">Counter</span>::getCounter
                                    , &amp;<span class="org-constant">Counter</span>::setCounter<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;


    sol_eval<span class="org-rainbow-delimiters-depth-2">(</span>ctx, R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        print("\n -----&gt;&gt;&gt; Calling C++ classes from Lua &lt;----- ");</span>

<span class="org-string">        -- Create new instance (object) of C++ class Counter </span>
<span class="org-string">        counter = Counter.new();</span>
<span class="org-string">        counter:increment();</span>
<span class="org-string">        counter:increment(); </span>
<span class="org-string">        counter:increment();</span>

<span class="org-string">        x = counter:getCounter(); </span>
<span class="org-string">        print("  [*] value of counter is equal to = " .. x);</span>

<span class="org-string">        counter.value = 2000;</span>
<span class="org-string">        print(" [*] Counter value is equal to = " .. counter.value );</span>
<span class="org-string">    )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">Counter</span>* <span class="org-variable-name">ptr</span> = ctx.get<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Counter</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"counter"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [FROM C++] counter value = "</span> 
              &lt;&lt; ptr-&gt;getCounter<span class="org-rainbow-delimiters-depth-2">()</span> 
              &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
Building =&gt; Debug build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/17a37d905d3d71c0ae66661a189481b5 lua-sol &amp;&amp; <span class="org-builtin">cd</span> lua-sol 
$ cmake --config Debug -H. -B_build 
$ cmake --build _build --target 
</pre>
</div>

<p>
Building =&gt; Release build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/17a37d905d3d71c0ae66661a189481b5 lua-sol &amp;&amp; <span class="org-builtin">cd</span> lua-sol 
$ cmake --config Release -H. -B_build 
$ cmake --build _build --target 
</pre>
</div>

<p>
Check executable: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Confirm whether the executable is statically linked against LuaLib </span>
$ ldd _build/embed-lua-sol 
       linux-vdso.so.1 (0x00007ffdf0fc4000)
       libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fe4490e6000)
       libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fe448fa0000)
       libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fe448f85000)
       libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fe448dbb000)
       /lib64/ld-linux-x86-64.so.2 (0x00007fe4492fa000)

  <span class="org-comment-delimiter"># </span><span class="org-comment">Static library </span>
  $ file _build/liblua.a 
 _build/liblua.a: current ar archive
</pre>
</div>

<p>
Program output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/embed-lua-sol 

[EXPERIMENT 1] ==&gt;&gt; Evaluating string as code 
[LUA] Hello world lua 
[TRACE] addfun() =&gt; a = 10 ; b = 20

 [LUA] result =  30.0

 [LUA] Printing a vector 
  -&gt; v[1 ] = 0
  -&gt; v[2 ] = 3
  -&gt; v[3 ] = 6
  -&gt; v[4 ] = 9
  -&gt; v[5 ] = 12
 [LUA] VAR points    = 2000
 [LUA] VAR character = &lt;Marcus Tulius Cicero&gt;


[EXPERIMENT 2] ==&gt;&gt; Reading configuration 
 [*] =&gt; asset_path = C:<span class="org-string">\\</span>Users\myuser\data\files<span class="org-sh-escaped-newline">\</span>
 [*] =&gt; user_credits = 2000


[EXPERIMENT 3] ==&gt;&gt; Register C++ classes 
 *=&gt;&gt; [StatefulFunctor] My new state is = 10
 *=&gt;&gt; [StatefulFunctor] My new state is = 11
 *=&gt;&gt; [StatefulFunctor] My new state is = 12

-----&gt;&gt;&gt; Calling C++ classes from Lua &lt;----- 
[TRACE] Counter created with =&gt;  {  name = untitled ; counter = 0 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 1 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 2 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 3 } 
 [*] value of counter is equal to = 3
[TRACE] I was set to value 2000
[*] Counter value is equal to = 2000
[FROM C++] counter value = 2000

</pre>
</div>

<p>
Run Lua repl executable (defined in CMake): 
</p>

<div class="org-src-container">
<pre class="src src-js">$ rlwrap  _build/lua-repl 
Lua 5.3.5  Copyright (C) 1994-2018 Lua.org, PUC-Rio
&gt; 
&gt; 

&gt; print(<span class="org-string">" Hello world Lua / Luna / Moon REPL "</span>)
 Hello world Lua / Luna / Moon REPL 

&gt; <span class="org-keyword">for</span> i = 1, 5 <span class="org-keyword">do</span> print(<span class="org-string">" i = "</span> .. i ) end
 i = 1
 i = 2
 i = 3
 i = 4
 i = 5


<span class="org-keyword">function</span> <span class="org-function-name">myfunction</span>(<span class="org-variable-name">a</span>, <span class="org-variable-name">b</span>) 
  <span class="org-keyword">return</span> math.sin(a) * math.exp(b) / a - a * b 
end 

&gt; myfunction(3.5, 2.0)
-7.7405591279893

<span class="org-keyword">function</span> <span class="org-function-name">add</span> (<span class="org-variable-name">a</span>)
   local sum = 0
   <span class="org-keyword">for</span> i,v <span class="org-keyword">in</span> ipairs(a) <span class="org-keyword">do</span>
      sum = sum + v
   end
   <span class="org-keyword">return</span> sum
end

&gt; add({ 2.5, 10.2, -2.51, 8.251, 10.56})
29.001

<span class="org-keyword">function</span> <span class="org-function-name">add</span> (<span class="org-variable-name">a</span>)
      local sum = 0
      <span class="org-keyword">for</span> i,v <span class="org-keyword">in</span> ipairs(a) <span class="org-keyword">do</span>
        sum = sum + v
      end
<span class="org-keyword">return</span> su
</pre>
</div>

<p>
<b>Building and running with Xmake</b>
</p>

<p>
Building with Xmake: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; xmake build -P . -v 

[ 25%]: ccache compiling.release embed-lua-sol.cpp
/usr/bin/gcc -c -m64 -fvisibility=hidden -fvisibility-inlines-hidden -O3 -std=c++17 <span class="org-sh-escaped-newline">\</span>
        -isystem /home/user/.xmake/packages/s/sol2/v3.2.1/5fa1980e381b40ed942748bdef09488a/include <span class="org-sh-escaped-newline">\</span>
        -isystem /home/user/.xmake/packages/l/lua/v5.4.4/4de5c31814a64c0d9242d1e524082873/include/lua <span class="org-sh-escaped-newline">\</span>
         -DNDEBUG -o <span class="org-keyword">build/.objs/embed-lua-sol/linux/x86_64/release/embed-lua-sol.cpp.o</span> embed-lua-sol.cpp

[ 50%]: linking.release embed-lua-sol
/usr/bin/g++ -o <span class="org-keyword">build/linux/x86_64/release/embed-lua-sol</span> build/.objs/embed-lua-sol/linux/x86_64/release/embed-lua-sol.cpp.o <span class="org-sh-escaped-newline">\</span>
     -m64 -L/home/user/.xmake/packages/l/lua/v5.4.4/4de5c31814a64c0d9242d1e524082873/lib -s -llua -ldl -lm
[100%]: build ok!
</pre>
</div>

<p>
Generating a CMakeLists.txt file:
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; xmake project -v -k cmake -P . <span class="org-comment-delimiter"># </span><span class="org-comment">Overrides CMakeLists.txt if it already exists</span>

configure
{
    plat = linux
    buildir = build
    arch = x86_64
    mode = release
    ccache = true
    ndk_stdcxx = true
    host = linux
    kind = static
}
create ok!


</pre>
</div>

<p>
Running the application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; xmake run -P .

[EXPERIMENT 1] ==&gt;&gt; Evaluating string as code 
[LUA] Hello world lua 
[TRACE] addfun() =&gt; a = 10 ; b = 20

 [LUA] result =  30.0

 [LUA] Printing a vector 
  -&gt; v[1 ] = 0
  -&gt; v[2 ] = 3
  -&gt; v[3 ] = 6
  -&gt; v[4 ] = 9
  -&gt; v[5 ] = 12
 [LUA] VAR points    = 2000
 [LUA] VAR character = &lt;Marcus Tulius Cicero&gt;


[EXPERIMENT 2] ==&gt;&gt; Reading configuration 
 [*] =&gt; asset_path = C:<span class="org-string">\\</span>Users\myuser\data\files<span class="org-sh-escaped-newline">\</span>
 [*] =&gt; user_credits = 2000


[EXPERIMENT 3] ==&gt;&gt; Register C++ classes 
 *=&gt;&gt; [StatefulFunctor] My new state is = 10
 *=&gt;&gt; [StatefulFunctor] My new state is = 11
 *=&gt;&gt; [StatefulFunctor] My new state is = 12

-----&gt;&gt;&gt; Calling C++ classes from Lua &lt;----- 
[TRACE] Counter created with =&gt;  {  name = untitled ; counter = 0 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 1 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 2 } 
[TRACE] increment event =&gt;&gt; counter = {  untitled ; 3 } 
 [*] value of counter is equal to = 3
[TRACE] I was set to value 2000
[*] Counter value is equal to = 2000
[FROM C++] counter value = 2000
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org78aa0a7" class="outline-3">
<h3 id="org78aa0a7"><span class="section-number-3">1.6</span> Squirrel Scripting Language</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org48fbe81" class="outline-4">
<h4 id="org48fbe81"><span class="section-number-4">1.6.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-6-1">
<ul class="org-ul">
<li>Squirrel is a embedded scripting language, similar to Lua, but with
C-like syntax, designed to be embedded in larger C or C++
applications such as game engines. Squirrel is written in C++, but
it only exposes a C API, which makes binding C++ code
cumbersome. However, there are many libraries which simplifies the
embedding of squirrel in C++ codebases.</li>
</ul>

<p>
<b>Official Web Site</b>
</p>

<ul class="org-ul">
<li><a href="http://www.squirrel-lang.org/">http://www.squirrel-lang.org/</a></li>
</ul>

<p>
<b>Official Repository</b> 
</p>

<ul class="org-ul">
<li><a href="https://github.com/albertodemichelis/squirrel">https://github.com/albertodemichelis/squirrel</a></li>
</ul>

<p>
<b>Squirrel fork with a more C++-like syntax</b>
</p>

<ul class="org-ul">
<li><a href="https://github.com/mingodad/squilu">https://github.com/mingodad/squilu</a></li>
</ul>

<p>
<b>Articles about squirrel language</b>
</p>

<ul class="org-ul">
<li><a href="https://developer.electricimp.com/squirrel/squirrelcrib">Squirrel Programming Guide | Dev Center</a></li>

<li><a href="https://www.ibm.com/developerworks/aix/library/au-spunix_squirrel/index.html">Speaking UNIX: The Squirrel portable shell and scripting language</a></li>

<li><a href="http://wiki.ogre3d.org/Squirrel+Scripting+Language">http://wiki.ogre3d.org/Squirrel+Scripting+Language</a></li>
</ul>

<p>
<b>Applications using Squirrel</b>
</p>

<ul class="org-ul">
<li>CodeBlocks IDE for C and C++</li>

<li>OpenTTD Game - <a href="http://www.openttd.org/en/">http://www.openttd.org/en/</a></li>
</ul>


<p>
<b>Libraries for simplifying embedding squirrel in C++ code</b> 
</p>

<p>
Libraries for simplifying squirrel embedding in C++ code (binding
C++ code):
</p>

<ul class="org-ul">
<li><b>SQPlus</b>
<ul class="org-ul">
<li><a href="http://wiki.squirrel-lang.org/default.aspx/SquirrelWiki/SqPlus.html">http://wiki.squirrel-lang.org/default.aspx/SquirrelWiki/SqPlus.html</a></li>
</ul></li>

<li><b>SQrat</b>
<ul class="org-ul">
<li><a href="http://scrat.sourceforge.net/">http://scrat.sourceforge.net/</a></li>
</ul></li>

<li><b>Squal</b>
<ul class="org-ul">
<li><a href="https://github.com/jonigata/squall">https://github.com/jonigata/squall</a></li>
</ul></li>

<li><b>SimpleSquirrel</b>
<ul class="org-ul">
<li><a href="https://github.com/matusnovak/simplesquirrel">https://github.com/matusnovak/simplesquirrel</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orge667407" class="outline-4">
<h4 id="orge667407"><span class="section-number-4">1.6.2</span> Building Squirrel standalone REPL interpreter</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
Download and build: 
</p>


<div class="org-src-container">
<pre class="src src-sh">$ mkdir ~/build &amp;&amp; <span class="org-builtin">cd</span> build 
$ git clone https://github.com/albertodemichelis/squirrel
$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug 
$ cmake --build _build --target
</pre>
</div>

<p>
Play with squirrel interactive shell (REPL):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/bin/sq
Squirrel 3.1 stable Copyright (C) 2003-2017 Alberto Demichelis (64 bits)

sq&gt; print(<span class="org-string">" === Hello world Squirrel === "</span>)
 === Hello world Squirrel === 

sq&gt; <span class="org-keyword">function</span> <span class="org-function-name">add_to_10</span>(x){ <span class="org-keyword">return</span> x + 10; }

sq&gt;print(add_to_10(25))
35

sq&gt; x &lt;- cos(3.1415 / 2) + 10 

sq&gt;print(<span class="org-string">" x = "</span> + x.tostring())
 x = 10

sq&gt; for(<span class="org-builtin">local</span> i = 0; i &lt; 5; i++) print(<span class="org-string">" \n [TRACE] i = "</span> + i.tostring());

 [TRACE] i = 0 
 [TRACE] i = 1 
 [TRACE] i = 2 
 [TRACE] i = 3 
 [TRACE] i = 4
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb85461c" class="outline-4">
<h4 id="orgb85461c"><span class="section-number-4">1.6.3</span> Example - embedding Squirrel with Squall Library</h4>
<div class="outline-text-4" id="text-1-6-3">
<p>
This example demonstrates how to embed the Squirrel programming
language in a C++ application using the Squall header-only library. 
</p>

<ul class="org-ul">
<li>Squal Repository: <a href="https://github.com/jonigata/squall">https://github.com/jonigata/squall</a></li>

<li>Note: This project is self-contained, no library needs to be
installed on the system as Squall automatically fetches Squirrel
sources using Cmake FetchContent.</li>
</ul>

<p>
<b>Sample Project</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span> (VERSION 3.11)
<span class="org-function-name">project</span>(squirrel_squall_test)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD_REQUIRED on)
<span class="org-function-name">set</span>(BUILD_EXAMPLES off)

<span class="org-comment"># -----------------------------------------------#</span>
<span class="org-function-name">include</span>(FetchContent)

<span class="org-function-name">FetchContent_Declare</span>(
  squall 
  URL      https://github.com/jonigata/squall/archive/master.zip
  )

<span class="org-function-name">FetchContent_MakeAvailable</span>(squall)

<span class="org-comment">#-------- TARGET DEFINITIONS --------------------#</span>
<span class="org-function-name">message</span>([TRACE] <span class="org-string">" squall_SOURCE_DIR = ${</span><span class="org-variable-name">squall_SOURCE_DIR</span><span class="org-string">}/squall  "</span>)

            <span class="org-function-name">add_executable</span> ( squirrel-test squirrel_test.cpp)
     <span class="org-function-name">target_link_libraries</span> ( squirrel-test squirrel_static sqstdlib_static)
<span class="org-function-name">target_include_directories</span> ( squirrel-test PUBLIC
                               ${<span class="org-variable-name">squirrel_SOURCE_DIR</span>}/include
                               ${<span class="org-variable-name">squall_SOURCE_DIR</span>}
                               )
</pre>
</div>

<p>
File: squirrel_test.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">squall/squall_vmstd.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">squall/squall_klass.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">some_cpp_fun</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; n; i++<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n   [some_cpp_function] =&gt; i = %d "</span>, i<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class="org-type">ChartXY</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">m_width</span>; 
    <span class="org-type">int</span> <span class="org-variable-name">m_height</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">ChartXY</span><span class="org-rainbow-delimiters-depth-2">()</span>: m_width<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span>, m_height<span class="org-rainbow-delimiters-depth-2">(</span>50<span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [ChartXY] Ctor() - I was created!. OK. "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">set_width</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">){</span> m_width = x; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">set_height</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">){</span> m_height = x; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">draw</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [ChartXY] draw() =&gt; Draw chart with: width = %d ; height = %d"</span>
                    , m_width, m_height<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a virtual-machine object for Squirrel language </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: throws squall::squirrel_error</span>
    <span class="org-constant">squall</span>::<span class="org-type">VMStd</span> <span class="org-variable-name">vm</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">[EXPERIMENT 1] Evaluate scripts provided as strings                     //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------//</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" =&gt;&gt; [EXPERIMENT] 1 - Evaluating code as string. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ---------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-2">{</span>

        vm.dostring<span class="org-rainbow-delimiters-depth-3">(</span>R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">            // --- Squirrel Comment ----- // </span>
<span class="org-string">            print(" &lt;SQUIRREL&gt;  =&gt;&gt; Hello world squirrel!");</span>

<span class="org-string">            function myfunc(x) {  </span>
<span class="org-string">                local a = x + 5;</span>
<span class="org-string">                local b = 7 * a + x;</span>
<span class="org-string">                return b - a + 10;  </span>
<span class="org-string">            }</span>

<span class="org-string">            function myfunc2() {</span>
<span class="org-string">                print(" \n  &lt;SQUIRREL&gt; I was called by the C++ code ");</span>
<span class="org-string">            }</span>

<span class="org-string">            print("\n &lt;SQUIRREL&gt; =&gt;&gt; myfunc(4) = " + myfunc(4).tostring() );</span>

<span class="org-string">            print("\n\n &lt;SQUIRREL&gt; --- For Loop test ---- ");</span>
<span class="org-string">            for(local i = 0; i &lt; 5; i++) { </span>
<span class="org-string">                 print("\n   i = " + i.tostring() );  </span>
<span class="org-string">            }</span>
<span class="org-string">        )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">squall</span>::<span class="org-type">squirrel_error</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"\n [SQUIRREL ERROR] Error =&gt;  "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;        
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">[EXPERIMENT 2] Evaluate scripts provided as strings                     //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------//</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n =&gt;&gt; [EXPERIMENT] 2 - Getting variables defined in the code."</span><span class="org-rainbow-delimiters-depth-2">)</span>;  
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" -----------------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-rainbow-delimiters-depth-2">{</span>
        vm.dostring<span class="org-rainbow-delimiters-depth-3">(</span>R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">            // ---- Global varibles for configuration ------ // </span>
<span class="org-string">            ::myvar_width &lt;- 100;</span>
<span class="org-string">            ::myvar_float &lt;- 122.56161;</span>
<span class="org-string">            ::myvar_string &lt;- "/path/to/interpreter.exe"; </span>
<span class="org-string">        )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-constant">squall</span>::<span class="org-type">TableBase</span> <span class="org-variable-name">table</span> = vm.root_table<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">myvar_float</span> = table.get<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">float</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"myvar_float"</span><span class="org-rainbow-delimiters-depth-3">)</span>;       
        <span class="org-keyword">auto</span> <span class="org-variable-name">myvar_width</span> = table.get<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"myvar_width"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">myvar_string</span> = table.get<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"myvar_string"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  myvar_width = "</span> &lt;&lt; myvar_width &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  myvar_float = "</span> &lt;&lt; myvar_float &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt; myvar_string = "</span> &lt;&lt; myvar_string &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">[EXPERIMENT 3] Call functions defined in the script (Virtual Machine )  //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------//    </span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n\n =&gt;&gt; [EXPERIMENT] 3 - Calling functions defined in the script (VM)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ------------------------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-comment-delimiter">// </span><span class="org-comment">Throws: 'squall::squirrel_error' </span>
    <span class="org-type">int</span> <span class="org-variable-name">result</span> = vm.call<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"myfunc"</span>, 10<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"   =&gt;&gt;&gt; myfunc(4) = "</span> &lt;&lt; result &lt;&lt; <span class="org-constant">std</span>::endl;

    vm.call<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"myfunc2"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">[EXPERIMENT 4] Call C++ functions from the script                       //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------//    </span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n\n =&gt;&gt; [EXPERIMENT] 4 - Calling functions defined in the script (VM)"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ------------------------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register C++ function pointer </span>
    vm.defun<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"some_cpp_fun"</span>, &amp;some_cpp_fun<span class="org-rainbow-delimiters-depth-2">)</span>;

    vm.dostring<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        print(" \n [SQUIRREL] =&gt; Call C++ function some_cpp_fun() ");</span>
<span class="org-string">        some_cpp_fun(5);</span>
<span class="org-string">     )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">Register C++ lambda object </span>
    vm.defun<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"call_me"</span>, <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">param</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n [TRACE] call_me() Parameter = "</span> &lt;&lt; param &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">return</span>  <span class="org-string">" name = "</span> + param;
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    vm.dostring<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        local x = call_me("&lt;SQUIRREL-INTERPRETER&gt;");</span>
<span class="org-string">        print(" [SQUIRREL] \n x &lt;- " + x);</span>
<span class="org-string">     )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">------------------------------------------------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">[EXPERIMENT 5] Call C++ classes from Squirrel-side                     //</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------//    </span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n\n =&gt;&gt; [EXPERIMENT] 5 - Calling C++ classes from Squirrel        "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ------------------------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Create metaobject 'k' that describes ChartXY class </span>
    <span class="org-constant">squall</span>::<span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">ChartXY</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">k</span><span class="org-rainbow-delimiters-depth-2">(</span>vm, <span class="org-string">"ChartXY"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    k.func<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"set_width"</span>,  &amp;<span class="org-constant">ChartXY</span>::set_width<span class="org-rainbow-delimiters-depth-2">)</span>;
    k.func<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"set_height"</span>, &amp;<span class="org-constant">ChartXY</span>::set_height<span class="org-rainbow-delimiters-depth-2">)</span>;
    k.func<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"draw"</span>,       &amp;<span class="org-constant">ChartXY</span>::draw<span class="org-rainbow-delimiters-depth-2">)</span>;

    vm.dostring<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">        function manipulate_chart(ch){           </span>
<span class="org-string">            ch.set_width(25);</span>
<span class="org-string">            ch.set_height(10);</span>
<span class="org-string">            ch.draw();</span>
<span class="org-string">        }</span>

<span class="org-string">        function draw_with(ch, w, h)</span>
<span class="org-string">        {</span>
<span class="org-string">            print(" \n [SQUIRREL LOG] Function draw_with called. OK. \n");</span>
<span class="org-string">            ch.set_width(w);</span>
<span class="org-string">            ch.set_height(h);</span>
<span class="org-string">            ch.draw();</span>
<span class="org-string">        }</span>
<span class="org-string">     )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">ChartXY</span> <span class="org-variable-name">mychart</span>;
    vm.call<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"manipulate_chart"</span>, &amp;mychart<span class="org-rainbow-delimiters-depth-2">)</span>;
    vm.call<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"draw_with"</span>, &amp;mychart, 100, 200<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n\n"</span>;

    <span class="org-constant">squall</span>::<span class="org-type">TableBase</span> <span class="org-variable-name">table</span> = vm.root_table<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Pass object to Squirrel side </span>
    table.set<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"mychart"</span>, mychart<span class="org-rainbow-delimiters-depth-2">)</span>;

    vm.dostring<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        mychart.set_width(250);</span>
<span class="org-string">        mychart.set_width(600);</span>
<span class="org-string">        mychart.draw();</span>
<span class="org-string">    )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


<span class="org-preprocessor">#if</span> 0  
    <span class="org-comment-delimiter">// </span><span class="org-comment">Segmentation Falt Coredump if the C++ object </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">is created on the Squirrel-side.</span>
    vm.dostring<span class="org-rainbow-delimiters-depth-2">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        local c = ChartXY();</span>
<span class="org-string">        c.set_width(150);</span>
<span class="org-string">        c.set_height(175);</span>
<span class="org-string">        c.draw();</span>
<span class="org-string">    )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-preprocessor">#endif</span> 

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug 
$ cmake --build _build --target 
</pre>
</div>

<p>
Check executable dependencies: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ldd _build/squirrel-test 
       linux-vdso.so.1 (0x00007ffe34dd6000)
       libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fd3ebd2a000)
       libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fd3ebbe4000)
       libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fd3ebbc9000)
       libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fd3eb9ff000)
       /lib64/ld-linux-x86-64.so.2 (0x00007fd3ebf3e000)
</pre>
</div>

<p>
Run application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/squirrel-test 

=&gt;&gt; [EXPERIMENT] 1 - Evaluating code as string. 
---------------------------------------------

&lt;SQUIRREL&gt;  =&gt;&gt; Hello world squirrel!
&lt;SQUIRREL&gt; =&gt;&gt; myfunc(4) = 68

&lt;SQUIRREL&gt; --- For Loop test ---- 
  i = 0
  i = 1
  i = 2
  i = 3
  i = 4
=&gt;&gt; [EXPERIMENT] 2 - Getting variables defined<span class="org-keyword"> in</span> the code.
-----------------------------------------------------------

 =&gt;&gt;  myvar_width = 100
 =&gt;&gt;  myvar_float = 122.562
 =&gt;&gt; myvar_string = /path/to/interpreter.exe


=&gt;&gt; [EXPERIMENT] 3 - Calling functions defined<span class="org-keyword"> in</span> the script (VM)
------------------------------------------------------------------

  =&gt;&gt;&gt; myfunc(4) = 110

 &lt;SQUIRREL&gt; I was called by the C++ code 

=&gt;&gt; [EXPERIMENT] 4 - Calling functions defined<span class="org-keyword"> in</span> the script (VM)
------------------------------------------------------------------


[SQUIRREL] =&gt; Call C++ <span class="org-keyword">function</span> <span class="org-function-name">some_cpp_fun</span>() 
  [some_cpp_function] =&gt; i = 0 
  [some_cpp_function] =&gt; i = 1 
  [some_cpp_function] =&gt; i = 2 
  [some_cpp_function] =&gt; i = 3 
  [some_cpp_function] =&gt; i = 4 
[TRACE] call_me() Parameter = &lt;SQUIRREL-INTERPRETER&gt;
[SQUIRREL] 
x &lt;-  name = &lt;SQUIRREL-INTERPRETER&gt;

=&gt;&gt; [EXPERIMENT] 5 - Calling C++ classes from Squirrel        
------------------------------------------------------------------

[ChartXY] Ctor() - I was created!. OK. 
[ChartXY] draw() =&gt; Draw chart with: width = 25 ; height = 10 
[SQUIRREL LOG] Function draw_with called. OK. 
[ChartXY] draw() =&gt; Draw chart with: width = 100 ; height = 200

[ChartXY] draw() =&gt; Draw chart with: width = 600 ; height = 200


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6384dd3" class="outline-3">
<h3 id="org6384dd3"><span class="section-number-3">1.7</span> Duktape - Embeddable Javascript Engine</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-orgc75584e" class="outline-4">
<h4 id="orgc75584e"><span class="section-number-4">1.7.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-7-1">
<ul class="org-ul">
<li>Duktape is a small footprint embeddable Javascript (ECMAScript)
engine, written in C, which can be used for providing scripting
capabilities for C or C++ applications.</li>

<li>License: MIT</li>

<li>Possible Use Cases:
<ul class="org-ul">
<li>Configuration</li>
<li>Data description language</li>
<li>User plugins</li>
<li>User extensions</li>
<li>Scripting for games</li>
</ul></li>

<li>Features:
<ul class="org-ul">
<li>Embeddable, portable, compact: can run on platforms with 160kB
flash and 64kB RAM</li>
<li>Built-in debugger</li>
<li>Built-in regular expression engine</li>
<li>Minimal, retargetable platform dependencies</li>
<li>Combined reference counting and mark-and-sweep garbage
collection with finalization</li>
<li>Bytecode dump/load for caching compiled functions</li>
<li>Distributable includes an optional logging framework,
CommonJS-based module loading implementations, etc</li>
</ul></li>
</ul>

<p>
<b>Official Website</b> 
</p>

<ul class="org-ul">
<li><a href="https://duktape.org/">https://duktape.org/</a></li>

<li><a href="https://duktape.org/download.html">https://duktape.org/download.html</a></li>
</ul>

<p>
<b>Official Repository</b> 
</p>

<ul class="org-ul">
<li><a href="https://github.com/svaarala/duktape">https://github.com/svaarala/duktape</a></li>
</ul>

<p>
<b>C++ Binding Libraries</b>  
</p>

<ul class="org-ul">
<li><a href="https://github.com/Aloshi/dukglue/">https://github.com/Aloshi/dukglue/</a></li>

<li><a href="https://github.com/stfwi/duktape-cc">https://github.com/stfwi/duktape-cc</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgdebcb0c" class="outline-4">
<h4 id="orgdebcb0c"><span class="section-number-4">1.7.2</span> Example project with DukGlue C++ binding library</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
This following project CMakeLists.txt automatically downloads <span class="underline">dukglue</span>
binding library and <span class="underline">duktape</span> engine sources and builds a C++ demonstration
code embedding duktape JavaScript engine. 
</p>

<ul class="org-ul">
<li>DukGlue Binding Library: <a href="https://github.com/Aloshi/dukglue">https://github.com/Aloshi/dukglue</a>
<ul class="org-ul">
<li>Advantage:
<ul class="org-ul">
<li>Easy to use and lots of examples.</li>
</ul></li>
<li>Drawbacks:
<ul class="org-ul">
<li>Lack of namespaces which enhances API discoverability</li>
<li>Lack of C++ wrappers to some Duktape C-types</li>
<li>Lack of a CMakeLists.txt at the top directory.</li>
</ul></li>
</ul></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(duktap-embed)

<span class="org-function-name">include</span>(FetchContent)

<span class="org-comment"># Download library archive (zip, *.tar.gz, ...) from URL</span>
<span class="org-keyword">macro</span>(Download_Library_Url NAME URL)
  <span class="org-function-name">FetchContent_Declare</span>(${<span class="org-variable-name">NAME</span>} URL  ${<span class="org-variable-name">URL</span>})
  <span class="org-function-name">FetchContent_GetProperties</span>(${<span class="org-variable-name">NAME</span>})
  <span class="org-keyword">if</span>(NOT ${<span class="org-variable-name">NAME</span>}_POPULATED)
    <span class="org-function-name">FetchContent_Populate</span>(${<span class="org-variable-name">NAME</span>})
   <span class="org-comment"># add_subdirectory(${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_SOURCE_DIR} ${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_BINARY_DIR})</span>
  <span class="org-keyword">endif</span>()
<span class="org-keyword">endmacro</span>()


<span class="org-comment"># ====&gt;&gt; Duktape JavaScript Engine Configuration &lt;&lt;===========#</span>

<span class="org-function-name">Download_Library_Url</span>(duktape
  <span class="org-string">"https://duktape.org/duktape-2.5.0.tar.xz"</span>
  )

<span class="org-comment"># FetchContent_MakeAvailable(duktape)</span>

<span class="org-function-name">message</span>( [TRACE] <span class="org-string">" =&gt;&gt; duktape_SOURCE_DIR = ${</span><span class="org-variable-name">duktape_SOURCE_DIR</span><span class="org-string">} "</span>)


<span class="org-function-name">file</span>(GLOB_RECURSE duktape_sources <span class="org-string">"${</span><span class="org-variable-name">duktape_SOURCE_DIR</span><span class="org-string">}/src/*.c"</span>)
<span class="org-function-name">file</span>(GLOB_RECURSE duktape_headers <span class="org-string">"${</span><span class="org-variable-name">duktape_SOURCE_DIR</span><span class="org-string">}/src/*.h"</span>)

<span class="org-function-name">message</span>( [TRACE] <span class="org-string">" duktape_sources = ${</span><span class="org-variable-name">duktape_sources</span><span class="org-string">} "</span>)

              <span class="org-function-name">add_library</span> (duktape ${<span class="org-variable-name">duktape_sources</span>} ${<span class="org-variable-name">duktape_headers</span>} )
<span class="org-function-name">target_include_directories</span>(duktape PUBLIC ${<span class="org-variable-name">duktape_SOURCE_DIR</span>}/src  )

<span class="org-comment"># ----------- DukGlue Library ----------------------------#</span>

<span class="org-function-name">FetchContent_Declare</span>(
  dukglue 
  URL       https://github.com/Aloshi/dukglue/archive/master.zip
  )

<span class="org-function-name">FetchContent_MakeAvailable</span>(dukglue)

<span class="org-comment">#----- Main Target Definition ----------------------------#</span>
<span class="org-function-name">add_executable</span>(duktape-embed duktape-embed.cpp)
<span class="org-function-name">target_link_libraries</span>(duktape-embed duktape dukglue)

</pre>
</div>

<p>
File: duktape-embed.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Repository: https://github.com/Aloshi/dukglue</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dukglue/dukglue.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">print_number</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] number passed is = "</span> &lt;&lt; x &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">log_text</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt;  <span class="org-string">" =&gt;&gt; [C++-LOG] - "</span> &lt;&lt; text &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">eval_code</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">duk_context</span>* <span class="org-variable-name">ctx</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> duk_peval_string<span class="org-rainbow-delimiters-depth-2">(</span>ctx, code.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">plot_points</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">float</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">points</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt; [TRACE] Plot points  =&gt;&gt; "</span>;
  <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">x</span>: points<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" x = "</span> &lt;&lt; x; <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" \n"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class="org-type">Counter</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>: 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_name</span>;
    <span class="org-type">int</span>         <span class="org-variable-name">m_counter</span>;

<span class="org-function-name">public</span>: 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ctor [1] =&gt; Default ctor </span>
    <span class="org-function-name">Counter</span><span class="org-rainbow-delimiters-depth-2">()</span>: Counter<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"untitled"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ctor [2]</span>
    <span class="org-function-name">Counter</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">int</span> <span class="org-variable-name">counter</span><span class="org-rainbow-delimiters-depth-2">)</span>
      : m_name<span class="org-rainbow-delimiters-depth-2">{</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-3">(</span>name<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">}</span>, m_counter<span class="org-rainbow-delimiters-depth-2">{</span>counter<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Counter created with =&gt;  { "</span> 
                  &lt;&lt;   <span class="org-string">" name = "</span> &lt;&lt; m_name 
                  &lt;&lt; <span class="org-string">" ; counter = "</span> &lt;&lt; m_counter 
                  &lt;&lt; <span class="org-string">" } \n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span> <span class="org-function-name">getCounter</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_counter; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">setCounter</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>       
      m_counter = n; 
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] I was set to value "</span> &lt;&lt; n &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">increment</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span>       
      m_counter++; 
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] increment event =&gt;&gt; counter = {  "</span> 
                &lt;&lt; m_name &lt;&lt; <span class="org-string">" ; "</span> &lt;&lt; m_counter 
                &lt;&lt; <span class="org-string">" } "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>    

<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Create Duktape Virtual machine </span>
      <span class="org-type">duk_context</span>* <span class="org-variable-name">ctx</span> = duk_create_heap_default<span class="org-rainbow-delimiters-depth-2">()</span>;

      <span class="org-comment-delimiter">/* </span><span class="org-comment">========================== EXPERIMENT 1 =============*/</span>
      <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === [EXPERIMENT 1] ==&gt;&gt; Register and call C++ functions &lt;&lt;===== "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">Register pointer to functions function (function pointer) in </span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">the JS engine (aka virtual machine)</span>
          dukglue_register_function<span class="org-rainbow-delimiters-depth-3">(</span>ctx, &amp;print_number, <span class="org-string">"print_number"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
          dukglue_register_function<span class="org-rainbow-delimiters-depth-3">(</span>ctx, log_text, <span class="org-string">"log_text"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          dukglue_register_function<span class="org-rainbow-delimiters-depth-3">(</span>ctx, plot_points, <span class="org-string">"plot_points"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">code1</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">              print_number(10);</span>
<span class="org-string">              log_text(" Hello world from Javascript" ); </span>
<span class="org-string">              log_text(" Toke is equal to " + 100 ); </span>
<span class="org-string">              log_text( " " + 1000 );      </span>

<span class="org-string">              plot_points( [ 20.5, 100.23, -125.254, 8.251, 100.0 ]);</span>
<span class="org-string">          )</span><span class="org-default">"</span>;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluate code, returns false on error </span>
          <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = eval_code<span class="org-rainbow-delimiters-depth-3">(</span>ctx, code1<span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>n<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] A duktape evaluation error has happened. "</span>  &lt;&lt; <span class="org-constant">std</span>::endl; <span class="org-rainbow-delimiters-depth-3">}</span>

      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-comment-delimiter">/* </span><span class="org-comment">========================== EXPERIMENT 2 ====================*/</span>
      <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === [EXPERIMENT 2] ==&gt;&gt; Register and call C++ classes &lt;&lt;===== \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">Register class counter </span>
          dukglue_register_constructor<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Counter</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, <span class="org-string">"Counter"</span><span class="org-rainbow-delimiters-depth-3">)</span>;      
          dukglue_register_constructor<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Counter</span>, <span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx,  <span class="org-string">"Counter"</span><span class="org-rainbow-delimiters-depth-3">)</span>;     
          dukglue_register_method<span class="org-rainbow-delimiters-depth-3">(</span>ctx, &amp;<span class="org-constant">Counter</span>::getCounter , <span class="org-string">"getCounter"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          dukglue_register_method<span class="org-rainbow-delimiters-depth-3">(</span>ctx, &amp;<span class="org-constant">Counter</span>::setCounter , <span class="org-string">"setCounter"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          dukglue_register_method<span class="org-rainbow-delimiters-depth-3">(</span>ctx, &amp;<span class="org-constant">Counter</span>::increment , <span class="org-string">"increment"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

          dukglue_register_property<span class="org-rainbow-delimiters-depth-3">(</span>ctx                   <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to engine (VM)</span>
                                  , &amp;<span class="org-constant">Counter</span>::getCounter  <span class="org-comment-delimiter">// </span><span class="org-comment">Getter </span>
                                  , &amp;<span class="org-constant">Counter</span>::setCounter  <span class="org-comment-delimiter">// </span><span class="org-comment">Setter </span>
                                  , <span class="org-string">"number"</span>              <span class="org-comment-delimiter">// </span><span class="org-comment">Property name </span>
                                  <span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-type">int</span> <span class="org-variable-name">ret</span> = eval_code<span class="org-rainbow-delimiters-depth-3">(</span>ctx, R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">              var counter = new Counter("mycounter", 10); </span>

<span class="org-string">              for(i = 0 ; i &lt; 5; i++) { counter.increment(); }</span>

<span class="org-string">              var n = counter.getCounter(); </span>
<span class="org-string">              log_text(" [BEFORE] Counter value = " + n );</span>

<span class="org-string">              counter.setCounter(100);</span>
<span class="org-string">              log_text(" [AFTER 1 ] Counter value = " + counter.getCounter() );</span>

<span class="org-string">              counter.number = 400;</span>
<span class="org-string">              log_text(" [AFTER 2] Counter value = " + counter.number );</span>
<span class="org-string">          )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          assert<span class="org-rainbow-delimiters-depth-3">(</span> ret == 0 <span class="org-rainbow-delimiters-depth-3">)</span>;

      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-comment-delimiter">/* </span><span class="org-comment">======= Calling Javascript Engine from C++ ====================*/</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It is useful for reading data or user configuration </span>
      <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === [EXPERIMENT 3] ==&gt;&gt; Calling engine objects from C++ &lt;&lt;===== \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">code</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">            // Global variables for configuration </span>
<span class="org-string">            points = 200; </span>
<span class="org-string">            asset_path = "C:\\\\Users\\dummy\\data\\graphics";</span>

<span class="org-string">            function my_js_function(n){</span>
<span class="org-string">                log_text( " &lt;my_js_function&gt; =&gt;&gt; n = " + n );</span>
<span class="org-string">                var k = 20 * n + 100;</span>
<span class="org-string">                return k; </span>
<span class="org-string">            }</span>

<span class="org-string">          )</span><span class="org-default">"</span>;
          eval_code<span class="org-rainbow-delimiters-depth-3">(</span>ctx, code<span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Throws error: DukErrorException</span>
          <span class="org-keyword">auto</span> <span class="org-variable-name">points</span> = dukglue_peval<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, <span class="org-string">"points"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] =&gt;&gt; points = "</span> &lt;&lt; points &lt;&lt; <span class="org-constant">std</span>::endl;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Throws error: DukErrorException</span>
          <span class="org-keyword">auto</span> <span class="org-variable-name">asset_path</span> = dukglue_peval<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, <span class="org-string">"asset_path"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] =&gt;&gt; asset_path = "</span> &lt;&lt; asset_path &lt;&lt; <span class="org-constant">std</span>::endl;

          <span class="org-keyword">auto</span> <span class="org-variable-name">jsexpr</span> = dukglue_peval<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, <span class="org-string">"3.51 * 10.52 - 8.251 / 100"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] jsexpr = "</span> &lt;&lt; jsexpr &lt;&lt; <span class="org-constant">std</span>::endl;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Call Javascript function from C++ </span>
          <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = dukglue_peval<span class="org-rainbow-delimiters-depth-3">&lt;</span>DukValue<span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, <span class="org-string">"my_js_function"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-type">int</span> <span class="org-variable-name">res</span> = dukglue_pcall<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>ctx, func, 20<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] res = "</span> &lt;&lt; res &lt;&lt; <span class="org-constant">std</span>::endl;

      <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Release Javascript engine object (aka virtual machine)</span>
    ::duk_destroy_heap<span class="org-rainbow-delimiters-depth-2">(</span>ctx<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build --target 
</pre>
</div>

<p>
Program output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./build/duktape-embed 

=== [EXPERIMENT 1] ==&gt;&gt; Register and call C++ functions &lt;&lt;===== 
[TRACE] number passed is = 10
=&gt;&gt; [C++-LOG] -  Hello world from Javascript
=&gt;&gt; [C++-LOG] -  Toke is equal to 100
=&gt;&gt; [C++-LOG] -  1000
 =&gt;&gt; [TRACE] Plot points  =&gt;&gt;  x = 20.5 x = 100.23 x = -125.254 x = 8.251 x = 100 

=== [EXPERIMENT 2] ==&gt;&gt; Register and call C++ classes &lt;&lt;===== 

[TRACE] Counter created with =&gt;  {  name = mycounter ; counter = 10 } 
[TRACE] increment event =&gt;&gt; counter = {  mycounter ; 11 } 
[TRACE] increment event =&gt;&gt; counter = {  mycounter ; 12 } 
[TRACE] increment event =&gt;&gt; counter = {  mycounter ; 13 } 
[TRACE] increment event =&gt;&gt; counter = {  mycounter ; 14 } 
[TRACE] increment event =&gt;&gt; counter = {  mycounter ; 15 } 
=&gt;&gt; [C++-LOG] -  [BEFORE] Counter value = 15
[TRACE] I was set to value 100
=&gt;&gt; [C++-LOG] -  [AFTER 1 ] Counter value = 100
[TRACE] I was set to value 400
=&gt;&gt; [C++-LOG] -  [AFTER 2] Counter value = 400

=== [EXPERIMENT 3] ==&gt;&gt; Calling engine objects from C++ &lt;&lt;===== 

 [*] =&gt;&gt; points = 200
 [*] =&gt;&gt; asset_path = C:<span class="org-string">\\</span>Users\dummy\data\graphics
 [*] jsexpr = 36.8427
=&gt;&gt; [C++-LOG] -  &lt;my_js_function&gt; =&gt;&gt; n = 20
 [*] res = 500


</pre>
</div>
</div>
</div>
<div id="outline-container-org12f6ed0" class="outline-4">
<h4 id="org12f6ed0"><span class="section-number-4">1.7.3</span> Example project with Duktape-CC binding library</h4>
<div class="outline-text-4" id="text-1-7-3">
<ul class="org-ul">
<li>Duktape-CC binding library: <a href="https://github.com/stfwi/duktape-cc/">https://github.com/stfwi/duktape-cc/</a>
<ul class="org-ul">
<li>Benefits 
<ul class="org-ul">
<li>Namespace</li>
<li>RAII for duktape C-API</li>
<li>Javascript common known APIs such as console.log()</li>
</ul></li>
<li>Disadvantage:
<ul class="org-ul">
<li>No possible to bind lambda function.</li>
<li>No possible to bind C++ classes or objects</li>
<li>No CMakeLists.txt at top directory, which makes the library
usage easier, but the following cmake scripts solves this
problem.</li>
</ul></li>
</ul></li>
</ul>


<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(duktape-cc-trial)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">include</span>(duktape.cmake)

<span class="org-comment">#----- Main Target Definition ----------------------------#</span>
       <span class="org-function-name">add_executable</span>( duktape-script duktape-script.cpp)
<span class="org-function-name">target_link_libraries</span>( duktape-script duktape-cc )
</pre>
</div>

<p>
File: duktape.cmake 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">include</span>(FetchContent)

<span class="org-comment"># Note: the 'add_subriectory' line was commented becuyase </span>
<span class="org-comment">#       library that will be downloaded does not have </span>
<span class="org-comment">#       a CMakeListst.txt file at the root directory. </span>
<span class="org-keyword">macro</span>(Download_Library_Git  NAME TAG REPOSITORY_URL)
    <span class="org-function-name">FetchContent_Declare</span>(
        ${<span class="org-variable-name">NAME</span>}
        GIT_REPOSITORY  ${<span class="org-variable-name">REPOSITORY_URL</span>}
        GIT_TAG         ${<span class="org-variable-name">TAG</span>}
    )
    <span class="org-function-name">FetchContent_GetProperties</span>(${<span class="org-variable-name">NAME</span>})
    <span class="org-keyword">if</span>(NOT cpputest_POPULATED)
        <span class="org-function-name">FetchContent_Populate</span>(${<span class="org-variable-name">NAME</span>})
        <span class="org-function-name">message</span>(<span class="org-string">"${</span><span class="org-variable-name">NAME</span><span class="org-string">}_SOURCE_DIR} = ${${</span><span class="org-variable-name">NAME</span><span class="org-string">}_SOURCE_DIR}"</span>)        

        <span class="org-comment"># =&gt; Disable following line: the library does not have a CMakeLists.txt</span>
        <span class="org-comment">#    at the root directory.</span>
        <span class="org-comment"># add_subdirectory(${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_SOURCE_DIR} ${${</span><span class="org-variable-name">NAME</span><span class="org-comment">}_BINARY_DIR})</span>
    <span class="org-keyword">endif</span>()
<span class="org-keyword">endmacro</span>()


<span class="org-comment"># ====&gt;&gt; Duktape JavaScript Engine Configuration &lt;&lt;===========#</span>

<span class="org-function-name">Download_Library_Git</span>( duktape-cc 
                      51fed200b0c3353a60fa560aa8a13a480f0ec0c7
                      https://github.com/stfwi/duktape-cc/
                    )

<span class="org-function-name">file</span>(GLOB_RECURSE duktape_sources <span class="org-string">"${</span><span class="org-variable-name">duktape-cc_SOURCE_DIR</span><span class="org-string">}/duktape/*.c"</span>)
<span class="org-function-name">file</span>(GLOB_RECURSE duktape_headers1 <span class="org-string">"${</span><span class="org-variable-name">duktape-cc_SOURCE_DIR</span><span class="org-string">}/duktape/*.hh"</span>)
<span class="org-function-name">file</span>(GLOB_RECURSE duktape_headers2 <span class="org-string">"${</span><span class="org-variable-name">duktape-cc_SOURCE_DIR</span><span class="org-string">}/duktape/*.h"</span>)

               <span class="org-function-name">add_library</span>( duktape-cc ${<span class="org-variable-name">duktape_sources</span>} ${<span class="org-variable-name">duktape_headers1</span>} ${<span class="org-variable-name">duktape_headers2</span>} )
<span class="org-function-name">target_include_directories</span>( duktape-cc PUBLIC ${<span class="org-variable-name">duktape-cc_SOURCE_DIR</span>} )

</pre>
</div>

<p>
File: duktape-script.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">duktape/duktape.hh</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">duktape/mod/mod.stdio.hh</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Program started Ok. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Create Duktape Engine object (Virtual Machine)</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">ctx</span> = <span class="org-constant">duktape</span>::engine<span class="org-rainbow-delimiters-depth-2">{}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load all functions from stdio module </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">==&gt; Note: It is necessary for console.log() work </span>
    <span class="org-constant">duktape</span>::<span class="org-constant">mod</span>::<span class="org-constant">stdio</span>::define_in<span class="org-rainbow-delimiters-depth-2">(</span>ctx<span class="org-rainbow-delimiters-depth-2">)</span>;   


    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 1] ======= Evaluate string as code ========"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    ctx.eval<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">        console.log(" [INFO] Hello world Javascript Engine ");</span>

<span class="org-string">        var i = 0;</span>
<span class="org-string">        while(i &lt; 5) {</span>
<span class="org-string">            console.log(" [TRACE] &lt;ducktape&gt;  i = " + i);</span>
<span class="org-string">            i++;</span>
<span class="org-string">        }</span>
<span class="org-string">    )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 2] == Read/write values to the engine the engine ="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Write or pass values to the engine. </span>
    ctx.define<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"app.version"</span>, <span class="org-string">"0.251"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    ctx.define<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"user.points"</span>, 1000<span class="org-rainbow-delimiters-depth-2">)</span>;
    ctx.define<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"array1"</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;{</span> 4.51, 9.25, -25.154, 205.2 <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    ctx.define<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"array2"</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">&gt;{</span> <span class="org-string">"C++"</span>, <span class="org-string">"ADA-Spark"</span>, <span class="org-string">"Rust"</span>, <span class="org-string">"Dlang"</span>, <span class="org-string">"OCaml"</span> <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">script_file</span> = <span class="org-string">"/tmp/myscript.js"</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">script_code</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        console.log("  =&gt; app.version = " + app.version );</span>
<span class="org-string">        console.log("  =&gt; user.points = " + user.points );</span>
<span class="org-string">        console.log("  =&gt; array1 = " + array1);</span>
<span class="org-string">        console.log("  =&gt; array2 = " + array2);</span>

<span class="org-string">        myconfig_path = "/Users/data/osx/config";</span>
<span class="org-string">        user_credits = 1020; </span>
<span class="org-string">        vector = [100.25, 90.251, -120.5150];</span>
<span class="org-string">    )</span><span class="org-default">"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Write script code to file     </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">fs</span> = <span class="org-constant">std</span>::ofstream<span class="org-rainbow-delimiters-depth-2">(</span>script_file<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Flush forces writing to the IO</span>
    fs &lt;&lt; script_code &lt;&lt; <span class="org-constant">std</span>::flush;          
    <span class="org-comment-delimiter">// </span><span class="org-comment">Execute script from file </span>
    ctx.include<span class="org-rainbow-delimiters-depth-2">(</span>script_file<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ---- Read configuration from file "</span> &lt;&lt; <span class="org-constant">std</span>::endl; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Throws exception: duktape::detail::basic_script_error&lt;void&gt;</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">myconfig_path</span> = ctx.eval<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"myconfig_path"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">credits</span>       = ctx.eval<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"user_credits"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">vec</span>           = ctx.eval<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"vector"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n\n[*] my_config_path = "</span> &lt;&lt; myconfig_path &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"[*]   user_credits = "</span> &lt;&lt; credits &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"[*] vec[0] = "</span> &lt;&lt; vec<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span> &lt;&lt; <span class="org-string">" ; vec[1] = "</span> &lt;&lt; vec<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span> &lt;&lt; <span class="org-string">"\n"</span>;    

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build --target 
</pre>
</div>

<p>
Program output: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ _build/duktape-script 
 [TRACE] Program started Ok. 

 [EXPERIMENT 1] ======= Evaluate string as code ========

 [EXPERIMENT 2] == Read/write values to the engine the engine =
 [INFO] Hello world Javascript Engine 
 [TRACE] &lt;ducktape&gt;  i = 0
 [TRACE] &lt;ducktape&gt;  i = 1
 [TRACE] &lt;ducktape&gt;  i = 2
 [TRACE] &lt;ducktape&gt;  i = 3
 [TRACE] &lt;ducktape&gt;  i = 4
  =&gt; app.version = 0.251
  =&gt; user.points = 1000
  =&gt; array1 = 4.51,9.25,-25.154,205.2
  =&gt; array2 = C++,ADA-Spark,Rust,Dlang,OCaml
 ---- Read configuration from file 


[*] my_config_path = /Users/data/osx/config
[*]   user_credits = 1020
[*] vec[0] = 100.25 ; vec[1] = 90.251

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org17348cd" class="outline-3">
<h3 id="org17348cd"><span class="section-number-3">1.8</span> QuickJS - ES20 Javascript Engine</h3>
<div class="outline-text-3" id="text-1-8">
<p>
QuickJS is small and lightweight embeddable Javascript engine, written
in C, which supports ES2020 technical specification. This engine was
created by Fabrice Bellard, creator of many widely used open source
projects, namely, QEMU emulator used for emulation of operating
systems and embedded systems hardware; FFmpeg tool for video and audio
conversion; TCC (Tiny C Compiler). Some features supported by the
engine are: modules, proxies, BigInt and asynchronous generators.
</p>

<ul class="org-ul">
<li>QuickJS Web Site:
<ul class="org-ul">
<li><a href="https://bellard.org/quickjs/quickjs.html">https://bellard.org/quickjs/quickjs.html</a></li>
</ul></li>

<li>QuickJS Repository:
<ul class="org-ul">
<li><a href="https://github.com/bellard/quickjs">https://github.com/bellard/quickjs</a></li>
</ul></li>

<li>QuickJSpp C++ Wrapper Repository (License: CC0)
<ul class="org-ul">
<li><a href="https://github.com/ftk/quickjspp">https://github.com/ftk/quickjspp</a></li>
</ul></li>
</ul>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="https://dev.to/carlillo/es2020-features-in-simple-examples-1513">ES2020 Features in simple examples - DEV</a></li>

<li><a href="https://gist.github.com/revolunet/537a3448cff850231a74">Python VS JavaScript ES6 syntax comparison  GitHub</a></li>
</ul>

<p>
<b>Sample CMake project</b> 
</p>

<p>
The following sample CMake projects demonstrates how to embed QuickJS
engine in a C++ code by using the QuickJSpp C++ wrapper. The CMake
script (CMakeLists.txt) downloads the QuickJS source code from its
repository and creates static library target for the JavaScript engine
which is then linked against the sample application embedding
QuickJS. This CMakeLists.txt script fully automates all steps, which relieves
the library user from installing QuickJS manually by using GNU make,
which is the original building system used by the engine. 
</p>

<p>
GIST Containing all sources: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/1abdd1d36cd3e973cd1f11f5c20ef7eb">https://gist.github.com/1abdd1d36cd3e973cd1f11f5c20ef7eb</a></li>
</ul>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(QuickJS-Experiment)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>( CMAKE_CXX_STANDARD     17 )
<span class="org-function-name">set</span>( CMAKE_VERBOSE_MAKEFILE ON )
<span class="org-function-name">set</span>( CMAKE_CXX_EXTENSIONS   OFF)

<span class="org-comment"># ------------ Download CPM CMake Script ----------------#</span>

<span class="org-comment">## Automatically donwload and use module CPM.cmake</span>
<span class="org-function-name">file</span>(DOWNLOAD https://raw.githubusercontent.com/TheLartians/CPM.cmake/v0.26.2/cmake/CPM.cmake
                 <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)
<span class="org-function-name">include</span>(<span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)

<span class="org-comment">#----------- Add dependencies --------------------------#</span>

<span class="org-function-name">CPMAddPackage</span>(
    NAME               quickjs 
    GITHUB_REPOSITORY  bellard/quickjs
    GIT_TAG            204682fb87ab9312f0cf81f959ecd181180457bc
    <span class="org-comment"># DOWNLOAD_ONLY YES</span>
    )


<span class="org-comment"># Add this directory where is this file (CMakeLists.txt) to include path. </span>
<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">CMAKE_CURRENT_LIST_DIR</span>} )

<span class="org-comment"># =============== QuickJS settings ====================================#</span>

<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/ )
<span class="org-function-name">message</span>([TRACE] <span class="org-string">" quickjs source = ${</span><span class="org-variable-name">quickjs_SOURCE_DIR</span><span class="org-string">} "</span>)

<span class="org-function-name">file</span>(GLOB quickjs_hpp ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/*.h )

<span class="org-function-name">file</span>(GLOB quickjs_src ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/quickjs.c 
                      ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/libregexp.c 
                      ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/libunicode.c  
                      ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/cutils.c 
                      ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/quickjs-libc.c 
                      ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/libbf.c 
                      )


               <span class="org-function-name">add_library</span>( qjs-engine ${<span class="org-variable-name">quickjs_src</span>} ${<span class="org-variable-name">quickjs_hpp</span>} )
    <span class="org-function-name">target_compile_options</span>( qjs-engine PRIVATE
                                -MMD -MF
                                -Wno-sign-compare 
                                -Wno-missing-field-initializers 
                                -Wundef -Wuninitialized 
                                -Wundef -Wuninitialized -Wwrite-strings -Wchar-subscripts
                          )
<span class="org-function-name">target_compile_definitions</span>( qjs-engine PUBLIC 
                                       CONFIG_BIGNUM=y
                                       CONFIG_VERSION=<span class="org-string">"2020-11-08"</span>
                                       _GNU_SOURCE
                           )

<span class="org-keyword">if</span>(UNIX)
    <span class="org-function-name">target_link_libraries</span>( qjs-engine PRIVATE m pthread dl)
<span class="org-keyword">endif</span>()

<span class="org-comment"># =========== Target Settings =========================================#</span>

            <span class="org-comment"># QuickJS compiler. </span>
            <span class="org-function-name">add_executable</span>( qjsc ${<span class="org-variable-name">quickjs_SOURCE_DIR</span>}/qjsc.c )
<span class="org-function-name">target_compile_definitions</span>( qjsc  PUBLIC  CONFIG_BIGNUM=y  CONFIG_VERSION=<span class="org-string">"2020-11-08"</span>  _GNU_SOURCE )            
     <span class="org-function-name">target_link_libraries</span>( qjsc  qjs-engine )

            <span class="org-comment"># Sample application that embeds the quickJS Javascript engine. </span>
       <span class="org-function-name">add_executable</span>( main main.cpp   )
<span class="org-function-name">target_link_libraries</span>( main qjs-engine )
</pre>
</div>

<p>
File: <span class="underline">main.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">quickjspp.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">class</span> <span class="org-type">ChartXY</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-type">double</span> <span class="org-variable-name">x</span> = 0.0, <span class="org-variable-name">y</span> = 0.0;
    <span class="org-type">double</span> <span class="org-variable-name">width</span> = 100.0, <span class="org-variable-name">height</span> = 100.0;
<span class="org-function-name">public</span>:
    <span class="org-function-name">ChartXY</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">ChartXY</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">w</span>, <span class="org-type">double</span> <span class="org-variable-name">h</span><span class="org-rainbow-delimiters-depth-2">)</span>: width<span class="org-rainbow-delimiters-depth-2">(</span>w<span class="org-rainbow-delimiters-depth-2">)</span>, height<span class="org-rainbow-delimiters-depth-2">(</span>h<span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">show</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [&#262;hartXY Object] x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; y = "</span> &lt;&lt; y 
                &lt;&lt; <span class="org-string">" ; width = "</span> &lt;&lt; width &lt;&lt; <span class="org-string">" height = "</span> &lt;&lt; height 
                &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">set_width</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">width</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>  
        <span class="org-keyword">this</span>-&gt;width = width; 
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [ChartXY] Width set to %f \n"</span>, width<span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">set_height</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">height</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-keyword">this</span>-&gt;height = height; 
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stdout, <span class="org-string">" [ChartXY] Height set to %f \n"</span>, height<span class="org-rainbow-delimiters-depth-3">)</span>;        
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">double</span> <span class="org-function-name">get_height</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-keyword">this</span>-&gt;height; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span> <span class="org-function-name">get_width</span> <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-keyword">this</span>-&gt;width; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">plot_points</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">points</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [ChartXY] Plotting points =&gt;&gt; "</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span> : points<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" "</span> &lt;&lt; p; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-function-name">qjs</span>::Value
try_eval_module<span class="org-rainbow-delimiters-depth-1">(</span>
             <span class="org-constant">qjs</span>::<span class="org-type">Context</span>&amp; <span class="org-variable-name">context</span>
           , <span class="org-constant">qjs</span>::<span class="org-type">Runtime</span>&amp; <span class="org-variable-name">runtime</span>
           , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">try</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">return</span> context.eval<span class="org-rainbow-delimiters-depth-3">(</span>code, <span class="org-string">"&lt;eval&gt;"</span>, JS_EVAL_TYPE_MODULE<span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-keyword">const</span> <span class="org-constant">qjs</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-comment-delimiter">//</span><span class="org-comment">js_std_dump_error(ctx);</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">exc</span> = context.getException<span class="org-rainbow-delimiters-depth-3">()</span>;
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>exc.isError<span class="org-rainbow-delimiters-depth-4">()</span> ? <span class="org-string">"Error: "</span> : <span class="org-string">"Throw: "</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span>exc &lt;&lt; <span class="org-constant">std</span>::endl;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-4">)</span>exc<span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"stack"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span>exc<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"stack"</span><span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-constant">std</span>::endl;

            js_std_free_handlers<span class="org-rainbow-delimiters-depth-3">(</span>runtime.rt<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> context.newObject<span class="org-rainbow-delimiters-depth-3">()</span>;
      <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Started Ok"</span> &lt;&lt; <span class="org-constant">std</span>::endl; 

    <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">qjs</span>;

    <span class="org-type">Runtime</span> <span class="org-variable-name">runtime</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">JSRuntime* rt = runtime.rt;</span>

    <span class="org-type">Context</span> <span class="org-variable-name">context</span><span class="org-rainbow-delimiters-depth-2">(</span>runtime<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">JSContext* ctx = context.ctx;</span>

    js_std_init_handlers<span class="org-rainbow-delimiters-depth-2">(</span>runtime.rt<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">loader for ES6 modules */</span>
    JS_SetModuleLoaderFunc<span class="org-rainbow-delimiters-depth-2">(</span>runtime.rt, <span class="org-constant">nullptr</span>, js_module_loader, <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    js_std_add_helpers<span class="org-rainbow-delimiters-depth-2">(</span>context.ctx, argc - 1, argv + 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">system modules */</span>
    js_init_module_std<span class="org-rainbow-delimiters-depth-2">(</span>context.ctx, <span class="org-string">"std"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    js_init_module_os<span class="org-rainbow-delimiters-depth-2">(</span>context.ctx, <span class="org-string">"os"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Before loading code. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">str</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">            /*</span>
<span class="org-string">            import * as std from 'std';</span>
<span class="org-string">            import * as os from 'os';</span>
<span class="org-string">            globalThis.std = std;</span>
<span class="org-string">            globalThis.os = os;</span>
<span class="org-string">            */</span>

<span class="org-string">            console.log(" [QUICJS] =&gt; =&gt;&gt; Script loaded. Ok. \n");</span>

<span class="org-string">            for(n = 1; n &lt;= 5; n++){</span>
<span class="org-string">                console.log(` [QUICKJS-TRACE] n = ${n}/5 `);</span>
<span class="org-string">            }</span>

<span class="org-string">            // ----- Define user variables here ----</span>

<span class="org-string">            asset_path = "/Users/mydir-macosx/data/blackjack.txt";</span>
<span class="org-string">            game_score = 0.25156;</span>

<span class="org-string">            let x = 10.352;</span>
<span class="org-string">            datapoints = [ 0.251, 19.2363, 9.262, 100.125 ];</span>

<span class="org-string">            console.log(`\n  [QUICKJS] asset_path = ${asset_path}` );</span>
<span class="org-string">            console.log(`   [QUICKJS] score = ${100.0 * game_score} (in percent) \n`);</span>
<span class="org-string">            console.log(`   [QUICKJS] data points = ${datapoints} `)</span>
<span class="org-string">      )</span><span class="org-default">"</span>;

    <span class="org-keyword">try</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         context.eval<span class="org-rainbow-delimiters-depth-3">(</span>str<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">, "", JS_EVAL_TYPE_MODULE);</span>
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-keyword">const</span> <span class="org-constant">qjs</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-comment-delimiter">//</span><span class="org-comment">js_std_dump_error(ctx);</span>
          <span class="org-keyword">auto</span> <span class="org-variable-name">exc</span> = context.getException<span class="org-rainbow-delimiters-depth-3">()</span>;
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>exc.isError<span class="org-rainbow-delimiters-depth-4">()</span> ? <span class="org-string">"Error: "</span> : <span class="org-string">"Throw: "</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span>exc &lt;&lt; <span class="org-constant">std</span>::endl;
          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-4">)</span>exc<span class="org-rainbow-delimiters-depth-4">[</span><span class="org-string">"stack"</span><span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>
              <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">)</span>exc<span class="org-rainbow-delimiters-depth-3">[</span><span class="org-string">"stack"</span><span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-constant">std</span>::endl;

          js_std_free_handlers<span class="org-rainbow-delimiters-depth-3">(</span>runtime.rt<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">return</span> 1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] After loading code. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-type">int</span> <span class="org-variable-name">number</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span> context.eval<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" 10 * (3 + 1 + 10 ) - 1000 * 2"</span><span class="org-rainbow-delimiters-depth-2">)</span>;                               
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [RESULT] number = "</span> &lt;&lt; number &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [*] ===== Read configuration variables defined in the js code. ====\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">var_asset_path</span> = context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"asset_path"</span><span class="org-rainbow-delimiters-depth-3">]</span>.as<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    =&gt;&gt; asset_path = "</span> &lt;&lt; var_asset_path &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">score</span> = context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"game_score"</span><span class="org-rainbow-delimiters-depth-3">]</span>.as<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    =&gt;&gt; game_score (%) = "</span> &lt;&lt; 100.0 * score &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">points</span> = context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"datapoints"</span><span class="org-rainbow-delimiters-depth-3">]</span>.as<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    ==&gt;&gt; datapoints = ["</span> &lt;&lt; points.size<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"]( "</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span> : points<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>  <span class="org-constant">std</span>::cout &lt;&lt; p &lt;&lt; <span class="org-string">' '</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ) \n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [*] ===== Define variables in C++-side  ====\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-rainbow-delimiters-depth-2">{</span> 

        context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"user_name"</span><span class="org-rainbow-delimiters-depth-3">]</span>   = context.newValue<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Gaius Julius Caesar"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"user_points"</span><span class="org-rainbow-delimiters-depth-3">]</span> = context.newValue<span class="org-rainbow-delimiters-depth-3">(</span>101235<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">data</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;{</span> <span class="org-string">"ADA"</span>, <span class="org-string">"RUST"</span>, <span class="org-string">"C++11"</span>, <span class="org-string">"C++17"</span>, <span class="org-string">"C++20"</span>
                                            , <span class="org-string">"Dlang"</span>, <span class="org-string">"OCaml"</span>, <span class="org-string">"C#(Csharp)"</span> <span class="org-rainbow-delimiters-depth-3">}</span>;

        context.global<span class="org-rainbow-delimiters-depth-3">()[</span><span class="org-string">"user_data"</span><span class="org-rainbow-delimiters-depth-3">]</span> = context.newValue<span class="org-rainbow-delimiters-depth-3">(</span>data<span class="org-rainbow-delimiters-depth-3">)</span>;         

        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: This code should be within an exception handler. </span>
        context.eval<span class="org-rainbow-delimiters-depth-3">(</span>R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">            console.log(` [STEP 2] user_name = ${user_name} ; points = ${user_points} `);</span>
<span class="org-string">            console.log(` [STEP 2] user_data = ${user_data} ; type = ${ typeof(user_data) } `);</span>
<span class="org-string">            console.log(` [STEP 2] user_data[5] = ${ user_data[5] } `)</span>

<span class="org-string">            // Iterate over the array </span>
<span class="org-string">            for(let x in user_data){ console.log(user_data[x]); }</span>
<span class="org-string">        )</span><span class="org-default">"</span><span class="org-rainbow-delimiters-depth-3">)</span>;          

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [*] ===== Register class ChartXY   ====\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    

    <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">module</span> = context.addModule<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"chart"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    module.class_<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">ChartXY</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"ChartXY"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      .constructor<span class="org-rainbow-delimiters-depth-2">()</span> 
      .constructor<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span>, <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>
      .fun<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::show<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"show"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      .fun<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::set_height<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"set_height"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      .fun<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::set_width<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"set_width"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      .fun<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::plot_points<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"plot_points"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      .property<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::get_width,  &amp;<span class="org-constant">ChartXY</span>::set_width<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"width"</span><span class="org-rainbow-delimiters-depth-2">)</span>      
      .property<span class="org-rainbow-delimiters-depth-2">&lt;</span>&amp;<span class="org-constant">ChartXY</span>::get_height, &amp;<span class="org-constant">ChartXY</span>::set_height<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"height"</span><span class="org-rainbow-delimiters-depth-2">)</span>      
      ;  

    module.add<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"user_path"</span>, <span class="org-string">"/Users/data/assets/game/score/marks"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    module.add<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"user_points"</span>, 1023523<span class="org-rainbow-delimiters-depth-2">)</span>;

    module.function<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"myfunc"</span>, <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> 4.61 * x + 10 * y * y; <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">module_code</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        import { ChartXY } from "chart";</span>

<span class="org-string">        import * as chart from "chart"</span>

<span class="org-string">        console.log(` [SCRIPT] chart.user_path = ${chart.user_path} \n\n`);</span>
<span class="org-string">        console.log(` [SCRIPT] chart.user_points = ${chart.user_points} \n\n`);</span>

<span class="org-string">        console.log(` [SCRIPT] Result = ${ chart.myfunc(5.61, 9.821) } \n`);</span>

<span class="org-string">        let ch = new ChartXY(200, 600);</span>
<span class="org-string">        ch.show();</span>

<span class="org-string">        ch.set_width(800.0);</span>
<span class="org-string">        ch.set_height(700.0)</span>
<span class="org-string">        ch.show();</span>

<span class="org-string">        console.log("   [QUICKJS] Change chart dimensions using properties ");</span>
<span class="org-string">        ch.width = 500;</span>
<span class="org-string">        ch.height = 660;</span>

<span class="org-string">        console.log(`\n   &lt;QUICKJS&gt; Chart width = ${ch.width} ; Chart height = ${ch.height} \n`);</span>

<span class="org-string">        ch.plot_points( [ 10.522, 8.261, -100.24, 7.2532, 56.123, 89.23 ] );</span>
<span class="org-string">    )</span><span class="org-default">"</span>;

    try_eval_module<span class="org-rainbow-delimiters-depth-2">(</span>context, runtime, module_code<span class="org-rainbow-delimiters-depth-2">)</span>;

    js_std_loop<span class="org-rainbow-delimiters-depth-2">(</span>context.ctx<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Shutdown virtual machine ---------------// </span>
    js_std_free_handlers<span class="org-rainbow-delimiters-depth-2">(</span>runtime.rt<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Building and Running</b> 
</p>

<p>
Download sources: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ git clone https://gist.github.com/1abdd1d36cd3e973cd1f11f5c20ef7eb qqjs &amp;&amp; <span class="org-builtin">cd</span> qqjs 

 $ ls
CMakeLists.txt  main.cpp  quickjspp.hpp
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug 
$ cmake --build _build --target
</pre>
</div>

<p>
Running qjsc (QuickJS - transpiler or C code generator)
</p>

<div class="org-src-container">
<pre class="src src-text"> $ _build/qjsc 
QuickJS Compiler version 2020-11-08
usage: qjsc [options] [files]

options are:
-c          only output bytecode in a C file
-e          output main() and bytecode in a C file (default = executable output)
-o output   set the output filename
-N cname    set the C name of the generated data
-m          compile as Javascript module (default=autodetect)
-D module_name         compile a dynamically loaded module or worker
-M module_name[,cname] add initialization code for an external C module
-x          byte swapped output
-p prefix   set the prefix of the generated C names
-S n        set the maximum stack size to 'n' bytes (default=262144)
</pre>
</div>

<p>
Running <span class="underline">main</span> application, which embeds QuickJS JS engine:  
</p>

<div class="org-src-container">
<pre class="src src-text"> $ &gt;&gt; _build/main 
 [INFO] Started Ok
 [TRACE] Before loading code. 
 [QUICJS] =&gt; =&gt;&gt; Script loaded. Ok. 

 [QUICKJS-TRACE] n = 1/5 
 [QUICKJS-TRACE] n = 2/5 
 [QUICKJS-TRACE] n = 3/5 
 [QUICKJS-TRACE] n = 4/5 
 [QUICKJS-TRACE] n = 5/5 

  [QUICKJS] asset_path = /Users/mydir-macosx/data/blackjack.txt
   [QUICKJS] score = 25.156 (in percent) 

   [QUICKJS] data points = 0.251,19.2363,9.262,100.125 
 [TRACE] After loading code. 
 [RESULT] number = -1860

 [*] ===== Read configuration variables defined in the js code. ====

    =&gt;&gt; asset_path = /Users/mydir-macosx/data/blackjack.txt
    =&gt;&gt; game_score (%) = 25.156
    ==&gt;&gt; datapoints = [4]( 0.251 19.2363 9.262 100.125  ) 

 [*] ===== Define variables in C++-side  ====

 [STEP 2] user_name = Gaius Julius Caesar ; points = 101235 
 [STEP 2] user_data = ADA,RUST,C++11,C++17,C++20,Dlang,OCaml,C#(Csharp) ; type = object 
 [STEP 2] user_data[5] = Dlang 
ADA
RUST
C++11
C++17
C++20
Dlang
OCaml
C#(Csharp)

 [*] ===== Register class ChartXY   ====

 [SCRIPT] chart.user_path = /Users/data/assets/game/score/marks 


 [SCRIPT] chart.user_points = 1023523 


 [SCRIPT] Result = 990.3825099999999 

 [&#262;hartXY Object] x = 0 ; y = 0 ; width = 200 height = 600
 [ChartXY] Width set to 800.000000 
 [ChartXY] Height set to 700.000000 
 [&#262;hartXY Object] x = 0 ; y = 0 ; width = 800 height = 700
   [QUICKJS] Change chart dimensions using properties 
 [ChartXY] Width set to 500.000000 
 [ChartXY] Height set to 660.000000 

   &lt;QUICKJS&gt; Chart width = 500 ; Chart height = 660 

 [ChartXY] Plotting points =&gt;&gt;  10.522 8.261 -100.24 7.2532 56.123 89.23

</pre>
</div>
</div>
</div>

<div id="outline-container-org9888893" class="outline-3">
<h3 id="org9888893"><span class="section-number-3">1.9</span> Chaiscript</h3>
<div class="outline-text-3" id="text-1-9">
<p>
Scripting engine available as a header-only library that has
Javascript-like syntax and easy integration to C++ codebases.
</p>

<p>
Drawbacks: 
</p>
<ul class="org-ul">
<li>Header-only =&gt; Slow compile-time and large executable size due to
the intesive use of templates. <a href="https://arne-mertz.de/2019/02/extern-template-reduce-compile-times/">Extern templates</a> C++ language
feature could reduce the compile time.</li>
</ul>

<p>
Repository: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/ChaiScript/ChaiScript">https://github.com/ChaiScript/ChaiScript</a></li>
</ul>

<p>
Web site: 
</p>
<ul class="org-ul">
<li><a href="https://chaiscript.com/examples.html">https://chaiscript.com/examples.html</a></li>
</ul>


<p>
<b>Files</b> 
</p>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.0)
<span class="org-function-name">project</span>(chaiscript-eval)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">include</span>( FetchContent )

<span class="org-function-name">set</span>( BUILD_SAMPLES  OFF CACHE BOOL  <span class="org-string">""</span>) 
<span class="org-function-name">set</span>( BUILD_SAMPLES  OFF CACHE BOOL  <span class="org-string">""</span>) 
<span class="org-function-name">set</span>( RUN_FUZZY_TESTS OFF CACHE BOOL <span class="org-string">""</span>)
<span class="org-function-name">set</span>( RUN_PERFORMANCE_TESTS  OFF CACHE BOOL <span class="org-string">""</span>)

<span class="org-function-name">FetchContent_Declare</span>(
     chaiscript 
     GIT_REPOSITORY  https://github.com/ChaiScript/ChaiScript/
     GIT_TAG         v6.1.0     
)
<span class="org-function-name">FetchContent_MakeAvailable</span>(chaiscript)
<span class="org-function-name">include_directories</span>( chaiscript-runtime PUBLIC ${<span class="org-variable-name">chaiscript_SOURCE_DIR</span>}/include )    

<span class="org-function-name">add_executable</span>( runner chaiscript-eval.cpp)

<span class="org-keyword">if</span>(UNIX)
    <span class="org-function-name">target_link_libraries</span>( runner PUBLIC pthread dl )
<span class="org-keyword">endif</span>()
</pre>
</div>

<p>
File: <span class="underline">chaiscript-eval.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">chaiscript/chaiscript.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">scriptable_function</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">label</span>, <span class="org-type">int</span> <span class="org-variable-name">w</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n [CALLED] label = "</span> &lt;&lt; label &lt;&lt; <span class="org-string">" ; w = "</span> &lt;&lt; w &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class="org-type">Robot</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>;
    <span class="org-type">float</span> <span class="org-variable-name">x</span> = 0, <span class="org-variable-name">y</span> = 0;
<span class="org-function-name">public</span>:

    <span class="org-function-name">Robot</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">Robot</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">float</span> <span class="org-variable-name">x</span>, <span class="org-type">float</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">){}</span>

    <span class="org-type">void</span> <span class="org-function-name">setPosition</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">float</span> <span class="org-variable-name">x</span>, <span class="org-type">float</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;x = x;
        <span class="org-keyword">this</span>-&gt;y = y;
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [INFO] Robot moved to x = %f ; y = %f \n"</span>, x, y<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   

    <span class="org-type">void</span> <span class="org-function-name">showPosition</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [INFO] Robot position (x = %f, y = %f ) \n"</span>, x, y<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>

  <span class="org-comment-delimiter">// </span><span class="org-comment">Create script engine object </span>
  <span class="org-constant">chaiscript</span>::<span class="org-type">ChaiScript</span> <span class="org-variable-name">chai</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Register user function   </span>
  chai.add<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">chaiscript</span>::fun<span class="org-rainbow-delimiters-depth-3">(</span>&amp;scriptable_function<span class="org-rainbow-delimiters-depth-3">)</span>
          , <span class="org-string">"scriptable_function"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  chai.add<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">chaiscript</span>::constructor<span class="org-rainbow-delimiters-depth-3">&lt;</span>Robot<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>, <span class="org-string">"Robot"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
  chai.add<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">chaiscript</span>::fun<span class="org-rainbow-delimiters-depth-3">(</span>&amp;<span class="org-constant">Robot</span>::showPosition<span class="org-rainbow-delimiters-depth-3">)</span>, <span class="org-string">"showPosition"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  chai.add<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">chaiscript</span>::fun<span class="org-rainbow-delimiters-depth-3">(</span>&amp;<span class="org-constant">Robot</span>::setPosition<span class="org-rainbow-delimiters-depth-3">)</span>,  <span class="org-string">"setPosition"</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">code</span> = R<span class="org-default">"</span><span class="org-string">(</span>
<span class="org-string">        // It supports C++-like syntax </span>
<span class="org-string">        for(var i = 0; i &lt; 5; ++i)</span>
<span class="org-string">        { </span>
<span class="org-string">            print(i);</span>
<span class="org-string">        }</span>

<span class="org-string">        puts(" ========= Line ================= \n");</span>
<span class="org-string">        scriptable_function("Moon", 200);</span>
<span class="org-string">        scriptable_function("Mars", 500);</span>

<span class="org-string">        var robot = Robot();</span>
<span class="org-string">        robot.setPosition(200, 400);</span>
<span class="org-string">        robot.showPosition();</span>

<span class="org-string">        // User configuration function will be called </span>
<span class="org-string">        // by the script engine. </span>

<span class="org-string">        def on_init_hook()</span>
<span class="org-string">        {</span>
<span class="org-string">            puts("\n [TRACE] User function called. Ok.");</span>
<span class="org-string">        }</span>

<span class="org-string">    )</span><span class="org-default">"</span>;

  <span class="org-comment-delimiter">// </span><span class="org-comment">Attempt to evaluate code </span>
  <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
      chai.eval<span class="org-rainbow-delimiters-depth-3">(</span>code<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">chaiscript</span>::<span class="org-constant">exception</span>::<span class="org-type">eval_error</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Exception = "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ==== Get robot object from script ========="</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-keyword">auto</span> <span class="org-variable-name">robot</span> = chai.eval<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Robot</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"robot"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  robot-&gt;showPosition<span class="org-rainbow-delimiters-depth-2">()</span>;
  robot-&gt;setPosition<span class="org-rainbow-delimiters-depth-2">(</span>400, 1000<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">---- End of main() ----------// </span>
</pre>
</div>

<p>
<b>Check Executable</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ du -h build/runner
23M     build/runner

<span class="org-comment-delimiter"># </span><span class="org-comment">Remove debugging symbols </span>
$ strip build/runner
$ du -h build/runner
7.6M    build/runner

$ file build/runner
<span class="org-function-name">build/runner</span>: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2
</pre>
</div>

<p>
<b>Running</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./runner 
0
1
2
3
4
 ========= Line ================= 

 [CALLED] label = Moon ; w = 200

 [CALLED] label = Mars ; w = 500
 [INFO] Robot moved to x = 200.000000 ; y = 400.000000 
 [INFO] Robot position (x = 200.000000, y = 400.000000 ) 
 ==== Get robot object from script =========
 [INFO] Robot position (x = 200.000000, y = 400.000000 ) 
 [INFO] Robot moved to x = 400.000000 ; y = 1000.000000 
</pre>
</div>
</div>
</div>
<div id="outline-container-org9d8d4d6" class="outline-3">
<h3 id="org9d8d4d6"><span class="section-number-3">1.10</span> Python Engine via Pybind11</h3>
<div class="outline-text-3" id="text-1-10">
<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://pybind11.readthedocs.io/en/stable/advanced/embedding.html">Pybind11 Embedding</a></li>
</ul>

<p>
Advantages: 
</p>
<ul class="org-ul">
<li>High popularity</li>
<li>Lost of libraries</li>
<li>Easy usage</li>
</ul>

<p>
Drawbacks: 
</p>
<ul class="org-ul">
<li>Hard to static link</li>
<li>Not ligthweight and designed to be embedded as Lua.</li>
<li>It is not possible to run multiple instances of the Python
interpreter.</li>
<li>It is not possible to sandbox the interpreter and restrict
accessing files or process manipulation APIs.</li>
<li>Requires pre-installation of Python development headers. But, it
can be mitigated by using Anaconda or miniconda Python distributions.</li>
</ul>

<p>
Known Cases: 
</p>
<ul class="org-ul">
<li>GDB - GNU Debugger</li>
<li>IDA Debugger</li>
<li>Sublime Text Editor</li>
</ul>

<p>
<b>Sample Project</b> 
</p>

<p>
GIST containing the sources: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/d7fda02034757374a0b0114e54c7daff">https://gist.github.com/d7fda02034757374a0b0114e54c7daff</a></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(embed-python-scripting)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)
<span class="org-function-name">set</span>(CMAKE_CXX_EXTENSIONS OFF)

<span class="org-comment"># ------------ Download CPM CMake Script ----------------#</span>

<span class="org-comment">## Automatically donwload and use module CPM.cmake</span>
<span class="org-function-name">file</span>(DOWNLOAD https://raw.githubusercontent.com/TheLartians/CPM.cmake/v0.26.2/cmake/CPM.cmake
                 <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)
<span class="org-function-name">include</span>(<span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)

<span class="org-comment">#----------- Add dependencies --------------------------#</span>

<span class="org-function-name">find_package</span>(PythonLibs REQUIRED)

<span class="org-function-name">CPMAddPackage</span>(
    NAME pybind11 
    URL  https://github.com/pybind/pybind11/archive/v2.5.zip    
    DOWNLOAD_ONLY true  
)

<span class="org-comment"># add_subdirectory( {pybind11_SOURCE_DIR} )</span>
<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">pybind11_SOURCE_DIR</span>}/include
                     ${<span class="org-variable-name">PYTHON_INCLUDE_PATH</span>} )

<span class="org-function-name">message</span>( [TRACE] <span class="org-string">"  pybind11_SOURCE_DIR = ${</span><span class="org-variable-name">pybind11_SOURCE_DIR</span><span class="org-string">} "</span>)

<span class="org-comment"># configure_file(script.py ${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-comment">} COPYONLY )</span>

<span class="org-comment">#----------- Set targets -------------------------------#</span>

<span class="org-function-name">add_executable</span>(app1 app1.cpp)
<span class="org-function-name">target_link_libraries</span>( app1 ${<span class="org-variable-name">PYTHON_LIBRARIES</span>} )

<span class="org-function-name">add_custom_command</span>(
        TARGET app1 POST_BUILD
        COMMAND ${<span class="org-variable-name">CMAKE_COMMAND</span>} -E copy
                ${<span class="org-variable-name">CMAKE_SOURCE_DIR</span>}/script.py 
                ${<span class="org-variable-name">CMAKE_CURRENT_BINARY_DIR</span>}/script.py)

</pre>
</div>

<p>
File: app.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">pybind11/embed.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">namespace</span> <span class="org-constant">py</span> = pybind11;

<span class="org-comment-delimiter">// </span><span class="org-comment">Requires: &lt;string&gt;, &lt;stream&gt;, &lt;sstream&gt;</span>
<span class="org-function-name">std</span>::string readFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">is</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span>file<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>is.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stream has errors."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
    ss &lt;&lt; is.rdbuf<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> ss.str<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">extern</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">pycode</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">guard</span> = <span class="org-constant">py</span>::scoped_interpreter<span class="org-rainbow-delimiters-depth-2">{}</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">------ EXPERIMENT 1 ------------------------------------// </span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [EXPERIMENT 1] ===== Execute Python code ======================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">code</span> = readFile<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"./script.py"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">std::cout &lt;&lt; " code = " &lt;&lt; code &lt;&lt; "\n";</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">g</span> = <span class="org-constant">py</span>::globals<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Define global variables for the interpreter global scope </span>
    g<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"game_assets"</span><span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-string">"/Users/myuser/game_assets"</span>;
    g<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"speed"</span><span class="org-rainbow-delimiters-depth-2">]</span>       = 20.151;
    g<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"z_value"</span><span class="org-rainbow-delimiters-depth-2">]</span>     = 100;    

    <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluate Python code</span>
    <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-2">{</span>        
        <span class="org-constant">py</span>::exec<span class="org-rainbow-delimiters-depth-3">(</span> code, g <span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">pybind11</span>::<span class="org-type">error_already_set</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [PYBIND11 ERROR] "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------ EXPERIMENT 2 ------------------------------------// </span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n [EXPERIMENT 2] == Read user defined configuration variables ===\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">v_x</span>    = g<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"x"</span><span class="org-rainbow-delimiters-depth-2">]</span>.cast<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">v_path</span> = g<span class="org-rainbow-delimiters-depth-2">[</span><span class="org-string">"path"</span><span class="org-rainbow-delimiters-depth-2">]</span>.cast<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*]    v_x = "</span> &lt;&lt; v_x &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] v_path = "</span> &lt;&lt; v_path &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Internal Python Embedded Module ---------------------------// </span>


<span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-function-name">version</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> <span class="org-string">"SampleModule Version 3.451-ZETA"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Sample "function-object class"</span>
<span class="org-keyword">class</span> <span class="org-type">LinearFunctor</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-type">double</span> <span class="org-variable-name">A</span> = 0, <span class="org-variable-name">B</span> = 0;

    <span class="org-function-name">LinearFunctor</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-function-name">LinearFunctor</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-type">double</span> <span class="org-variable-name">b</span><span class="org-rainbow-delimiters-depth-2">)</span>: A<span class="org-rainbow-delimiters-depth-2">(</span>a<span class="org-rainbow-delimiters-depth-2">)</span>, B<span class="org-rainbow-delimiters-depth-2">(</span>b<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">double</span> <span class="org-function-name">GetA</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>   <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> A; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span>   <span class="org-function-name">SetA</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> A = a; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span> <span class="org-function-name">GetB</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>   <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> B; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span>   <span class="org-function-name">SetB</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">b</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> B = b; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">show</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" LinearFunction: y(x) = A * x + B"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; A = "</span> &lt;&lt; <span class="org-keyword">this</span>-&gt;A &lt;&lt; <span class="org-string">" ; B = "</span> &lt;&lt; <span class="org-keyword">this</span>-&gt;B &lt;&lt; <span class="org-constant">std</span>::endl;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">toString</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
        ss &lt;&lt; <span class="org-string">" LinearFunction: y(x) = A * x + B"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        ss &lt;&lt; <span class="org-string">" =&gt; A = "</span> &lt;&lt; <span class="org-keyword">this</span>-&gt;A &lt;&lt; <span class="org-string">" ; B = "</span> &lt;&lt; <span class="org-keyword">this</span>-&gt;B &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> ss.str<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Function-call operator</span>
    <span class="org-type">double</span> <span class="org-keyword">operator</span><span class="org-function-name"><span class="org-rainbow-delimiters-depth-2">()</span></span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> A * x + B;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Internal Module -----------------------// </span>

<span class="org-function-name">PYBIND11_EMBEDDED_MODULE</span><span class="org-rainbow-delimiters-depth-1">(</span>SampleModule, m<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">optional module docstring</span>
    m.doc<span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-string">"Sample Python built with C++ CeePlusPlus "</span>;
    m.def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"version"</span>, &amp;version, <span class="org-string">"Show Library Version"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    m.def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"cppLambda"</span>
          ,<span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> 3.0 * x + y;<span class="org-rainbow-delimiters-depth-3">}</span>
          ,<span class="org-string">"A C++ lambda object or functor"</span>
          <span class="org-comment-delimiter">//</span><span class="org-comment">,py::arg("x"), py::args("y") = 15</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register LinearFunction</span>
    <span class="org-constant">py</span>::class_<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">LinearFunctor</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>m, <span class="org-string">"LinearFunctor"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">py</span>::init<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span>, <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span><span class="org-rainbow-delimiters-depth-2">)</span>             <span class="org-comment-delimiter">// </span><span class="org-comment">Register overloaded consructor</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"GetA"</span>, &amp;<span class="org-constant">LinearFunctor</span>::GetA<span class="org-rainbow-delimiters-depth-2">)</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">Reister method GetA()</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"GetB"</span>, &amp;<span class="org-constant">LinearFunctor</span>::GetB<span class="org-rainbow-delimiters-depth-2">)</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">Register method GetB()</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SetA"</span>, &amp;<span class="org-constant">LinearFunctor</span>::SetA<span class="org-rainbow-delimiters-depth-2">)</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">Reister method GetA()</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"SetB"</span>, &amp;<span class="org-constant">LinearFunctor</span>::SetB<span class="org-rainbow-delimiters-depth-2">)</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">Register method GetB()</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"show"</span>, &amp;<span class="org-constant">LinearFunctor</span>::show<span class="org-rainbow-delimiters-depth-2">)</span>            <span class="org-comment-delimiter">// </span><span class="org-comment">Register method show</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"call"</span>, &amp;<span class="org-constant">LinearFunctor</span>::<span class="org-keyword">operator</span><span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Register function-call operator with name 'call'</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"__call__"</span>, &amp;<span class="org-constant">LinearFunctor</span>::<span class="org-keyword">operator</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Register fun-call operator</span>
            .def<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"__repr__"</span>, &amp;<span class="org-constant">LinearFunctor</span>::toString<span class="org-rainbow-delimiters-depth-2">)</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Register strin representation</span>
            .def_readwrite<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"A"</span>, &amp;<span class="org-constant">LinearFunctor</span>::A<span class="org-rainbow-delimiters-depth-2">)</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">Register field A</span>
            .def_readwrite<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"B"</span>, &amp;<span class="org-constant">LinearFunctor</span>::B<span class="org-rainbow-delimiters-depth-2">)</span>;       <span class="org-comment-delimiter">// </span><span class="org-comment">Register field B</span>

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">/** </span><span class="org-comment">--- End of PYBIND11_MODULE registration --- */</span>

</pre>
</div>

<p>
File: script.py 
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">print</span>(<span class="org-string">"   =&gt; game_assets = "</span>, game_assets)
<span class="org-keyword">print</span>(<span class="org-string">"   =&gt;       speed = "</span>, speed)
<span class="org-keyword">print</span>(<span class="org-string">"   =&gt;     z_value = "</span>, z_value)

<span class="org-function-name">x</span>: <span class="org-builtin">float</span> = 10.0 * 20.51 / 200

<span class="org-variable-name">path</span> = <span class="org-string">"C:\\\\Users\\dummy\\Documents\\data"</span>

<span class="org-keyword">print</span>(<span class="org-string">" [PYTHON] The value of x = "</span>, x)

<span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(5):
    <span class="org-keyword">print</span>(<span class="org-string">"   [PYTHON] i = "</span>, i)

<span class="org-comment-delimiter"># </span><span class="org-comment">It is not possible to restrict the interpreter!</span>
<span class="org-keyword">import</span> os 
<span class="org-keyword">print</span>(<span class="org-string">" [*] Current path = "</span>, os.getcwd() )

<span class="org-keyword">print</span>(<span class="org-string">"\n ------------------------------------------"</span>)
<span class="org-keyword">print</span>(<span class="org-string">"\n =&gt;&gt;&gt; Test Python Internal Module (C++) &lt;&lt;=\n"</span>)

<span class="org-keyword">import</span> SampleModule <span class="org-keyword">as</span> m 
<span class="org-keyword">from</span> SampleModule <span class="org-keyword">import</span> LinearFunctor 

<span class="org-keyword">print</span>(f<span class="org-string">"    -&gt;   Module Information = [{m.__doc__}] "</span>)
<span class="org-keyword">print</span>( <span class="org-string">"    -&gt;       Module Version = "</span>, m.version())
<span class="org-keyword">print</span>( <span class="org-string">"    -&gt; m.cppLambda(100, 25) = "</span>, m.cppLambda(100, 25) )

<span class="org-variable-name">functor</span> = LinearFunctor(8.0, -10.0)
<span class="org-keyword">print</span>(f<span class="org-string">"\n C++ Functor -&gt; ${functor} "</span>)

<span class="org-keyword">print</span>(<span class="org-string">" functor(5.0) = "</span>, functor(5.0))
<span class="org-keyword">print</span>(<span class="org-string">" functor(8.0) = "</span>, functor(8.0))

</pre>
</div>

<p>
Build and running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd /tmp 
$ git clone https://gist.github.com/d7fda02034757374a0b0114e54c7daff python-embed-script 
$ cd python-embed-script

$ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug
$ cmake --build _build --target 
</pre>
</div>

<p>
Program output: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/app1 

 [EXPERIMENT 1] ===== Execute Python code ======================

   =&gt; game_assets =  /Users/myuser/game_assets
   =&gt;       speed =  20.151
   =&gt;     z_value =  100
 [PYTHON] The value of x =  1.0255
   [PYTHON] i =  0
   [PYTHON] i =  1
   [PYTHON] i =  2
   [PYTHON] i =  3
   [PYTHON] i =  4
 [*] Current path =  /home/mxpkf8/temp-projects/python-embed-script

 ------------------------------------------

 =&gt;&gt;&gt; Test Python Internal Module (C++) &lt;&lt;=

    -&gt;   Module Information = [Sample Python built with C++ CeePlusPlus ] 
    -&gt;       Module Version =  SampleModule Version 3.451-ZETA
    -&gt; m.cppLambda(100, 25) =  325.0

 C++ Functor -&gt; $ LinearFunction: y(x) = A * x + B
 =&gt; A = 8 ; B = -10

 functor(5.0) =  30.0
 functor(8.0) =  54.0

 [EXPERIMENT 2] == Read user defined configuration variables ===

 [*]    v_x = 1.0255
 [*] v_path = C:<span class="org-string">\\</span>Users\dummy\Documents\data

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd61f66d" class="outline-3">
<h3 id="orgd61f66d"><span class="section-number-3">1.11</span> Writing a Scheme-like lisp interpreter in C++</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-org24f41ad" class="outline-4">
<h4 id="org24f41ad"><span class="section-number-4">1.11.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-11-1">
<p>
Scheme is a simple dialect of lisp with several functional-programming
features. Functions are first class citizens, they can be passed as
argument to other functions and returned from functions. Everything is
an expression and evaluates to something, even assignments and if-else
statements. Some versions of scheme also feature tail-call
optimization that allow writing tail-recursive functions to be
converted to loop without creating excessive stack frames.
</p>

<p>
This section presents a lisp-like interpreter based on <span class="underline">Scheme</span>,
implemented using modern C++ features and object oriented design
patterns with a handwritten parser and lexer. This lisp interpreter is
based on <a href="https://norvig.com/lispy.html">lispy</a>, a lisp interpreter written in Python. Just like lispy,
this implementation is easy to understand and can be easily be embedded in
C++ applications for adding scripting capabilities or ursing
S-expressions as a DSL (Domain-Specific Language) or data description
language. 
</p>


<p>
Techniques used in this implementation: 
</p>

<ul class="org-ul">
<li>Smart pointers are used for memory managment.</li>

<li><span class="underline">Composite design pattern</span> for representing the AST</li>

<li>Visitor design pattern is used for traversing the AST and
implementing AST printing. In a functional programming language
with proper sum types (also known as variants or discriminated
unions), the visitor could be replaced by <span class="underline">pattern matching</span>.</li>

<li>Inheritance is used for representing <span class="underline">sum types</span> or <span class="underline">discriminated</span>
<span class="underline">unitons</span>, common in functional programming languages.  The AST
(Abstract Syntax Tree) nodes, including atoms and lists, are
represented by classes inheriting from <span class="underline">IEXpr</span> abstract class.</li>

<li>The interpreter uses direct recursive evaluation of the AST just
like the inspiration <a href="https://norvig.com/lispy.html">lispy</a>.</li>

<li>Lists are not implemented using linked lists, instead they are
implemented using std::vector container.</li>

<li>Besides the recursive abstract syntax tree evaluation
implementation, the interpreter could also be implemented using a
SECD (stack-environment-control-dump) virtual machine.</li>

<li>This implementation uses the <span class="underline">fn</span> keyword instead of <span class="underline">lambda</span>; <span class="underline">def</span>
instead of <span class="underline">define</span> for creating named functions; and <span class="underline">set</span> instead of
<span class="underline">define</span> for defining variables.</li>
</ul>


<p>
Possible implementation techniques of Lisp-like languages: 
</p>

<ul class="org-ul">
<li>Recursive AST (Abstract Syntax Tree) evaluation</li>

<li>SECD (stack-environment-control-dump) virtual/abstract machine</li>

<li><span class="underline">Meta-circular evaluator</span> =&gt; Implement lisp-like dialects on top of
an existing lisp implementation such as Common Lisp.</li>

<li>Compile lisp dialect to bytecodes of an existing virtual machine
including, JVM (Java Virtual Machine); CLR (Common Language
Runtime) - .NET virtual machine; parrot virtual machine or WASM -
Web Assembly.</li>

<li>JIT (Just-In-Time) compiler =&gt; Compile itself to machine code at
runtime for improving performance and speed. This technique is
used by several common lisp implementations.</li>

<li>Transpile S-expressions to another language, including C or C++.</li>
</ul>

<p>
Lisp terminology:
</p>

<ul class="org-ul">
<li>Sexp - S-Expression  
<ul class="org-ul">
<li>Stands for symbolic expressions</li>
</ul></li>

<li>Homoiconicity
<ul class="org-ul">
<li>Code is data. The lisp code represents the AST (Abstract Syntax
Tree) that is just nested lists of lists or atoms.</li>
</ul></li>

<li>atoms
<ul class="org-ul">
<li>Everything that is not a list is an atom. An indivisible value,
including strings, symbols, keywords, numbers and so on.</li>
</ul></li>

<li>car - comes from 'Contents of the Address part of the Register'</li>

<li>cdr - comes from 'Contents of the Decrement part of the Register'</li>

<li>cons -  abbreviation of the word 'construct'</li>

<li>Special forms
<ul class="org-ul">
<li>They are forms or primitives not evaluated as functions
arguments may not be evaluated. Most special forms are control
structures and keyword such as 'if', 'set', 'define', 'lambda'
and so on.</li>
</ul></li>

<li>DSL - Domain Specific Lanaguage</li>

<li>(if &lt;PREDICATE&gt; &lt;THEN-EXPR&gt; &lt;ELSE-EXPR&gt; )
<ul class="org-ul">
<li>The &lt;THEN-EXPR&gt; or then-expression is evaluated if the predicate
evaulates to true that happens when the predicate does not
evaluate to #f or nil. If the predicate is evaluated to any
other value, the else-expression is evaluated.</li>
</ul></li>

<li>User-defined procedures
<ul class="org-ul">
<li>User-defined functions using the keyword <span class="underline">fn</span> (equivalent to
lambda) or <span class="underline">def</span> equivalent to Scheme's define keyword.</li>
</ul></li>

<li>Primitive procedures 
<ul class="org-ul">
<li>Built-in functions or procedures, for instance (+), (*), apply,
map, list and so on.</li>
</ul></li>

<li>Literals
<ul class="org-ul">
<li>Boolean literals =&gt; #t or #f - in this implementation</li>
<li>nil literal: nil =&gt; For designating empty return value.</li>
<li>symbol literal: 'a-symbol</li>
<li>keyword literal: :keyword1, :keyword2</li>
<li>String literal - between quotes:  "my string"</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org60e11e8" class="outline-4">
<h4 id="org60e11e8"><span class="section-number-4">1.11.2</span> Code</h4>
<div class="outline-text-4" id="text-1-11-2">
<p>
File: <span class="underline">code.lisp</span>
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="org-comment-delimiter">; </span><span class="org-comment">Lisp test code </span>
<span class="org-comment-delimiter">;</span><span class="org-comment">--------------------------------</span>

(comment <span class="org-string">"Comment special form is evaluated to nil and discarded."</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">Create a sample list </span>
(set mylist (list 10 #t #f <span class="org-string">"hello world"</span> 
              'hello 'world
              <span class="org-comment">; Operation 1</span>
              <span class="org-builtin">:keyword1</span> (+ 10 25 6) '(+ 10 25 6) 
              <span class="org-comment">; Operation 2</span>
              <span class="org-builtin">:keyword2</span> (* 4 2 6)  '(* 4 2 6) 

              ))

<span class="org-comment-delimiter">; </span><span class="org-comment">Factorial function </span>
(set code-fact <span class="org-string">"</span>
<span class="org-string">      ; Factorial function </span>
<span class="org-string">      (def fact (n)</span>
<span class="org-string">          (if (= n 1)</span>
<span class="org-string">              1                    ;; Base case </span>
<span class="org-string">              (* n (fact (- n 1))) ;; Recursion case </span>
<span class="org-string">           )) </span>
<span class="org-string">    "</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">S-expression for fibbonaci function</span>
(def fib(n)
   (<span class="org-keyword">if</span> (&lt; n 2)
     n 
     (+ (fib (- n 1))  (fib (- n 2)) )
    ))

(def make-adder (k)
    (fn (x) (+ k x)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Define a function that adds 10 to a number </span>
(set add10 (make-adder 10))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Defines a function that adds 10 to a number </span>
(set add50 (make-adder 50))


(set func 
  (<span class="org-keyword">let</span> (
          (a (sqrt 125))
          (b (+ 20 a))
          (c (* a b))
        )
        (comment <span class="org-string">"Create  a function using lexical scope. </span>
<span class="org-string">                  The variable (a, b and c) are not visible outside the function. </span>
<span class="org-string">                  "</span>)
        (fn (x) (/ (+ a b x) c))
   )
 )

<span class="org-comment-delimiter">;; </span><span class="org-comment">Compute many trigonometric properties of an angle </span>
(def compute-trig (angle-degrees)
    (<span class="org-keyword">let</span> (
          (angle (/ (* angle-degrees PI) 180) )
         )
        (list <span class="org-builtin">:angle</span> angle-degrees <span class="org-builtin">:cos</span> (cos angle) <span class="org-builtin">:sin</span> (sin angle) <span class="org-builtin">:tan</span> (tan angle))
     )
 )

</pre>
</div>

<p>
File: <span class="underline">cpplisp.cpp</span> (Lisp-like interpreter)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cctype</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">optional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor"> #include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">map</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cmath</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stack</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">TokenType</span> <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-variable-name">SYM</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Symbol </span>
    , <span class="org-variable-name">KEYW</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Keyword  Examples =&gt; :keyword, :x</span>
    , <span class="org-variable-name">STR</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">String literal </span>
    , <span class="org-variable-name">NUM</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Number literal </span>
    , <span class="org-variable-name">BOOL</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Boolean </span>
    , <span class="org-variable-name">QUOTE</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Quote  </span>
    , <span class="org-variable-name">RPAREN</span> <span class="org-comment-delimiter">// </span><span class="org-comment">'(' Right parenthesis  </span>
    , <span class="org-variable-name">LPAREN</span> <span class="org-comment-delimiter">// </span><span class="org-comment">')' Left parenthesis </span>
    , <span class="org-variable-name">EOFF</span>   <span class="org-comment-delimiter">//  </span><span class="org-comment">End of File (It was named 'EOFF' since it conflicts with #define 'EOF')</span>
    , <span class="org-variable-name">ERR</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Indicates error </span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">Token</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">TokenType</span>   <span class="org-variable-name">type</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span>;
    <span class="org-type">int</span> <span class="org-variable-name">pos</span>;
    <span class="org-type">int</span> <span class="org-variable-name">lin</span>;
    <span class="org-type">int</span> <span class="org-variable-name">col</span>;

    <span class="org-function-name">Token</span><span class="org-rainbow-delimiters-depth-2">()</span>: 
     type<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">TokenType</span>::ERR<span class="org-rainbow-delimiters-depth-2">)</span>, text<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">""</span><span class="org-rainbow-delimiters-depth-2">)</span>, pos<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, lin<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>, col<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{}</span>

    <span class="org-function-name">Token</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">TokenType</span> <span class="org-variable-name">type_</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text_</span>, <span class="org-type">int</span> <span class="org-variable-name">pos_</span>, <span class="org-type">int</span> <span class="org-variable-name">lin_</span>, <span class="org-type">int</span> <span class="org-variable-name">col_</span><span class="org-rainbow-delimiters-depth-2">)</span>:
        type<span class="org-rainbow-delimiters-depth-2">(</span>type_<span class="org-rainbow-delimiters-depth-2">)</span>, text<span class="org-rainbow-delimiters-depth-2">(</span>text_<span class="org-rainbow-delimiters-depth-2">)</span>, pos<span class="org-rainbow-delimiters-depth-2">(</span>pos_<span class="org-rainbow-delimiters-depth-2">)</span>, lin<span class="org-rainbow-delimiters-depth-2">(</span>lin_<span class="org-rainbow-delimiters-depth-2">)</span>, col<span class="org-rainbow-delimiters-depth-2">(</span>col_<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">bool</span> <span class="org-function-name">isEOF</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> type == <span class="org-constant">TokenType</span>::EOFF; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">bool</span> <span class="org-function-name">isNumber</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> text<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> != <span class="org-string">'-'</span> &amp;&amp; <span class="org-negation-char">!</span><span class="org-constant">std</span>::isdigit<span class="org-rainbow-delimiters-depth-3">(</span>text<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = text.length<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">size_t</span> <span class="org-variable-name">k</span> = 1; k &lt; n; k++<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span><span class="org-constant">std</span>::isdigit<span class="org-rainbow-delimiters-depth-4">(</span> text<span class="org-rainbow-delimiters-depth-5">[</span>k<span class="org-rainbow-delimiters-depth-5">]</span> <span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>;<span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> <span class="org-constant">true</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class="org-type">Tokenizer</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">istream</span>&amp; <span class="org-variable-name">_is</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Position of cursor in the inout stream </span>
    <span class="org-type">int</span> <span class="org-variable-name">_pos</span> = 0;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Current line in the input stream </span>
    <span class="org-type">int</span> <span class="org-variable-name">_lin</span> = 0;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Column in the input stream </span>
    <span class="org-type">int</span> <span class="org-variable-name">_col</span> = 0; 
<span class="org-function-name">public</span>:
    <span class="org-function-name">Tokenizer</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">istream</span>&amp; <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">_is</span><span class="org-rainbow-delimiters-depth-2">(</span>is<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Read a single character and consumes it from the stream  </span>
    <span class="org-type">char</span> <span class="org-function-name">next</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-type">char</span> <span class="org-variable-name">chr</span> = _is.get<span class="org-rainbow-delimiters-depth-3">()</span>; 
        _pos++;
        _col++;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Assumes that the new line character is just '\n'</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> chr == <span class="org-string">'\n'</span> <span class="org-rainbow-delimiters-depth-3">){</span>
            _col = 0;
            _lin++;    
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> chr;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Read next character from input string without reading it </span>
    <span class="org-type">char</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">(){</span> 
        <span class="org-keyword">return</span> _is.peek<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-type">bool</span> <span class="org-function-name">isBlankChar</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-type">char</span> <span class="org-variable-name">ch</span> = peek<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">return</span> ch == <span class="org-string">' '</span> || ch == <span class="org-string">'\t'</span> || ch == <span class="org-string">'\r'</span> || ch == <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">bool</span> <span class="org-function-name">isParenthesis</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-type">char</span> <span class="org-variable-name">ch</span> = peek<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">return</span> ch == <span class="org-string">'('</span> || ch == <span class="org-string">')'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Is end of line     </span>
    <span class="org-type">bool</span> <span class="org-function-name">isEOL</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">return</span> peek<span class="org-rainbow-delimiters-depth-3">()</span> == <span class="org-string">'\n'</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">bool</span> <span class="org-function-name">isEOF</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">return</span> _is.eof<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">skipBlankChars</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> isBlankChar<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span> next<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">skipLineComment</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-type">char</span> <span class="org-variable-name">ch</span> = peek<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> ch != <span class="org-string">'\n'</span> &amp;&amp; <span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;isEOF<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span> ch = next<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Consume stream until a blank character is found </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">consumeUntilBlank</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Consuming until blank \n");</span>
        <span class="org-type">char</span> <span class="org-variable-name">ch</span> = peek<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span>;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;isBlankChar<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;isParenthesis<span class="org-rainbow-delimiters-depth-4">()</span>  &amp;&amp; <span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;isEOF<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            ch = <span class="org-keyword">this</span>-&gt;next<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">fprintf(stderr, " [TRACE] ConsumeUntilBlank ch = %d \n", ch);</span>
            text = text + ch;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] consumeUntilBlank = %s \n", text.c_str());</span>
        <span class="org-keyword">return</span> text;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Token</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">readTokens</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Token</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">out</span><span class="org-rainbow-delimiters-depth-3">{}</span>;
        <span class="org-type">Token</span> <span class="org-variable-name">tok</span>; 
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>tok.isEOF<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span>
            tok = <span class="org-keyword">this</span>-&gt;nextToken<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>tok.isEOF<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">){</span> out.push_back<span class="org-rainbow-delimiters-depth-5">(</span>tok<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">stack</span> = <span class="org-constant">std</span>::<span class="org-type">stack</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Token</span><span class="org-rainbow-delimiters-depth-3">&gt;{}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Check if parentheses are balanced </span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">tok</span>: out<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Push left parentheses to the stack </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>tok.type == <span class="org-constant">TokenType</span>::LPAREN<span class="org-rainbow-delimiters-depth-4">){</span> stack.push<span class="org-rainbow-delimiters-depth-5">(</span>tok<span class="org-rainbow-delimiters-depth-5">)</span>;  <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">If the stack is not empty and current parenthesis is a </span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">right parentheses, if the top of stack is left parentheses </span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">then pop the stack.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>tok.type == <span class="org-constant">TokenType</span>::RPAREN <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>stack.empty<span class="org-rainbow-delimiters-depth-6">()</span> &amp;&amp; stack.top<span class="org-rainbow-delimiters-depth-6">()</span>.type == <span class="org-constant">TokenType</span>::LPAREN <span class="org-rainbow-delimiters-depth-5">)</span>
                     <span class="org-rainbow-delimiters-depth-5">{</span> stack.pop<span class="org-rainbow-delimiters-depth-6">()</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: unbalanced parentheses."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>
        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>stack.empty<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-keyword">auto</span> <span class="org-variable-name">tok</span> = stack.top<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] Unbalanced parentheses at line %d and column %d \n"</span>, tok.lin, tok.col<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: unbalanced parentheses."</span><span class="org-rainbow-delimiters-depth-4">)</span>; 
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">return</span> out;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">Token</span> <span class="org-function-name">nextToken</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Removing blank characters \n");</span>
        skipBlankChars<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-type">char</span> <span class="org-variable-name">ch</span> = next<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] nextChar = %c \n", ch);</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-keyword">this</span>-&gt;isEOF<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::EOFF, <span class="org-string">""</span>, _pos, _lin, _col<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Skip comments </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">';'</span> <span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Skiping comment \n");</span>
            skipLineComment<span class="org-rainbow-delimiters-depth-4">()</span>; 

            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Skiping comment 2 \n");</span>
            <span class="org-keyword">return</span> nextToken<span class="org-rainbow-delimiters-depth-4">()</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">'('</span><span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::LPAREN, <span class="org-string">"("</span>, _pos, _lin, _col<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">')'</span><span class="org-rainbow-delimiters-depth-3">)</span>  <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::RPAREN, <span class="org-string">")"</span>, _pos, _lin, _col<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">'\''</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::QUOTE, <span class="org-string">"'"</span>,  _pos, _lin, _col<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Boolean value </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">'#'</span><span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">c</span> = <span class="org-keyword">this</span>-&gt;next<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">text</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"#"</span><span class="org-rainbow-delimiters-depth-4">)</span> + c;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> c!= <span class="org-string">'f'</span> &amp;&amp; c !=<span class="org-string">'t'</span> <span class="org-rainbow-delimiters-depth-4">){</span>
                <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::ERR, <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error - invalid boolean literal =&gt; "</span><span class="org-rainbow-delimiters-depth-6">)</span> + text, _pos, _lin, _col<span class="org-rainbow-delimiters-depth-5">)</span>; 
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::BOOL, text,  _pos, _lin, _col<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">String literal </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> ch == <span class="org-string">'"'</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> 
            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Reading string literal \n");</span>
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">out</span> = <span class="org-string">""</span>;
            <span class="org-type">int</span> <span class="org-variable-name">col</span> = _col;
            <span class="org-type">int</span> <span class="org-variable-name">pos</span> = _pos;
            <span class="org-type">int</span> <span class="org-variable-name">lin</span> = _lin;
            <span class="org-type">char</span> <span class="org-variable-name">c</span> = <span class="org-string">'x'</span>;
            <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-4">(</span> c != <span class="org-string">'"'</span> &amp;&amp; c != <span class="org-string">'\0'</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                c  = <span class="org-keyword">this</span>-&gt;next<span class="org-rainbow-delimiters-depth-5">()</span>;
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>c == <span class="org-string">'"'</span><span class="org-rainbow-delimiters-depth-5">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
                out = out + c;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> c!= <span class="org-string">'"'</span><span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::ERR, <span class="org-string">"Error - non closed quote."</span>, _pos, _lin, _col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">else</span>        <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::STR, out, pos, lin, col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">assert(  )</span>

        <span class="org-type">int</span> <span class="org-variable-name">col</span> = _col;
        <span class="org-type">int</span> <span class="org-variable-name">pos</span> = _pos;
        <span class="org-type">int</span> <span class="org-variable-name">lin</span> = _lin;
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> = ch + <span class="org-keyword">this</span>-&gt;consumeUntilBlank<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> text == <span class="org-string">":"</span><span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::ERR, <span class="org-string">"illegal terminating character after a colon:"</span> ,pos, lin, col<span class="org-rainbow-delimiters-depth-4">)</span>; 
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Keyworkd </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> text<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> == <span class="org-string">':'</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Tokenizer =&gt;&gt; keyword = %s \n", text.c_str() );</span>
            <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::KEYW, text, pos, lin, col<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> text == <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">TokenType</span>::SYM, text, pos, lin, col<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::isdigit<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">text</span><span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> isNumber<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">text</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
                 <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::NUM, <span class="org-type">text</span>, pos, lin, col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span> 
            <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::ERR, <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error - invalid number =&gt; "</span><span class="org-rainbow-delimiters-depth-6">)</span> + text, pos, lin, col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> text<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> == <span class="org-string">'-'</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> isNumber<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">text</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
                 <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::NUM, <span class="org-type">text</span>, pos, lin, col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span> 
            <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">TokenType</span>::ERR, <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error - invalid number =&gt; "</span><span class="org-rainbow-delimiters-depth-6">)</span> + text, pos, lin, col<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Anything else is a symbpl </span>
        <span class="org-keyword">return</span> Token<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">TokenType</span>::SYM, <span class="org-type">text</span>, pos, lin, col<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-function-name">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-keyword">operator</span>&lt;&lt;<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span>, <span class="org-variable-name">TokenType</span> type<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::BOOL<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[BOOL]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::EOFF<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[EOF]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::STR<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[STR]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::LPAREN<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[LPAREN]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::RPAREN<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[RPAREN]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::NUM<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[NUM]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::SYM<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[SYM]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">TokenType</span>::ERR<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> os &lt;&lt; <span class="org-string">"[ERR]"</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> os;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">ExprType</span> <span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-variable-name">ERR</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Error  </span>
    , <span class="org-variable-name">NUM</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Number literal </span>
    , <span class="org-variable-name">STR</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">String literal </span>
    , <span class="org-variable-name">BOOL</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Boolean literal </span>
    , <span class="org-variable-name">SYM</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Symbol </span>
    , <span class="org-variable-name">KEY</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Keyword </span>
    , <span class="org-variable-name">NIL</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Nil or Null value </span>
    , <span class="org-variable-name">FUN</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Function  </span>
    , <span class="org-variable-name">LST</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">List literal </span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Forward declaration </span>
<span class="org-keyword">struct</span> <span class="org-type">ExprNil</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprStr</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprNum</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprSym</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprKey</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprErr</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprBool</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprFun</span>;
<span class="org-keyword">struct</span> <span class="org-type">ExprLst</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Visitor design pattern </span>
<span class="org-keyword">struct</span> <span class="org-type">IVisitor</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IVisitor</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNil</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprStr</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNum</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprSym</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprKey</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprBool</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprErr</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprFun</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprLst</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Lisp-like AST - Abstract syntax tree </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">IEXpr stands for Interface Expression </span>
<span class="org-keyword">struct</span> <span class="org-type">IExpr</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IExpr</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-keyword">virtual</span> <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> = 0;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is ATOM</span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isAtom</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is list  </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isList</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is error  </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isErr</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is symbol </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isSym</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is string</span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isStr</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is keyword</span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isKey</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is number  </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isNum</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is boolean </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isBool</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is nil   </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isNil</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns true if AST node is function </span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>     <span class="org-function-name">isFun</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-comment-delimiter">/// </span><span class="org-comment">Returns the string value of a node </span>
    <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> = 0;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluates to false if nil or #f and evaluates to true if it is anything else.</span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Method for accepting visitor (Related to visitor design pattern)</span>
    <span class="org-keyword">virtual</span> <span class="org-type">void</span>     <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluate AST node and return a value (AST Node) </span>
    <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a null value (empty value) equivalent to void </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">In Lisp just as other functional-like programming languages</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">everything is evaluated to something and can be replaced be a value.</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprNil</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-function-name">ExprNil</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::NIL; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isNil</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> 0;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>;<span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a string literal </span>
<span class="org-keyword">struct</span> <span class="org-type">ExprStr</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">ExprStr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::STR; <span class="org-rainbow-delimiters-depth-2">}</span> 


    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>        <span class="org-function-name">isStr</span><span class="org-rainbow-delimiters-depth-2">()</span>      <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprStr</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span>-&gt;value<span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a number </span>
<span class="org-keyword">struct</span> <span class="org-type">ExprNum</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">double</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">ExprNum</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::NUM; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isNum</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span>-&gt;value<span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a boolean literal (logical value)</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprBool</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>  
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">bool</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">ExprBool</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">bool</span> <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::BOOL; <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-type">bool</span> <span class="org-function-name">isBool</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span>-&gt;value<span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a lisp symbol</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprSym</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>  
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">ExprSym</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::SYM; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isSym</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = env.find<span class="org-rainbow-delimiters-depth-3">(</span>value<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>it == env.end<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">" [ERROR] Unbound variable "</span> + value<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">return std::make_shared&lt;ExprErr&gt;(10, "Error - unbound variable " + value);</span>
           <span class="org-comment-delimiter">// </span><span class="org-comment">return nullptr;</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> it-&gt;second;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a lisp keyword such as :x, :y, :keyword1</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprKey</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>  
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">ExprKey</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::KEY; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isKey</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprKey</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span>-&gt;value<span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;



<span class="org-comment-delimiter">// </span><span class="org-comment">Represents an Error (Reserved for future use)</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprErr</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>  
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>         <span class="org-variable-name">code</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">info</span>;

    <span class="org-function-name">ExprErr</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
    <span class="org-function-name">ExprErr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">code_</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">info_</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : code<span class="org-rainbow-delimiters-depth-2">(</span>code_<span class="org-rainbow-delimiters-depth-2">)</span>, info<span class="org-rainbow-delimiters-depth-2">(</span>info_<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::ERR; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isErr</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> info;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>;<span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprErr</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>code, info<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-keyword">using</span> <span class="org-type">LispFunc</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;
<span class="org-keyword">using</span> <span class="org-type">LispEnv</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>; 


<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a function</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprFun</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">doc</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">std::vector&lt;std::string&gt; args;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">std::shared_ptr&lt;IExpr&gt;   body;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">ExprFun(std::vector&lt;std::string&gt; const&amp; args_): args(args_) { }</span>
    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::FUN; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isFun</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">virtual</span> <span class="org-type">bool</span> <span class="org-function-name">isNativeFun</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;

    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>  <span class="org-function-name">call</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">params</span>
                                        , <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env_</span><span class="org-rainbow-delimiters-depth-2">)</span> = 0;

    ~<span class="org-function-name">ExprFun</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Non-native lisp function implemented in lisp </span>
<span class="org-keyword">struct</span> <span class="org-type">ExprFunLisp</span>: <span class="org-keyword">public</span> <span class="org-type">ExprFun</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span>;
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>  <span class="org-variable-name">body</span>;
    <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">env</span>;

    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">"(function) "</span> + <span class="org-keyword">this</span>-&gt;name;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isNativeFun</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
    <span class="org-function-name">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args_</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">body_</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : args<span class="org-rainbow-delimiters-depth-2">(</span>args_<span class="org-rainbow-delimiters-depth-2">)</span>, body<span class="org-rainbow-delimiters-depth-2">(</span>body_<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>

         <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Invoke copy constructor </span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> 
    <span class="org-function-name">call</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">params</span>
         ,<span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env_</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> params.size<span class="org-rainbow-delimiters-depth-4">()</span> != args.size<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: Function call error. "</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Create local environment </span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">envv</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;{}</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Copy global environment to temporary environment </span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">k</span> : env_<span class="org-rainbow-delimiters-depth-3">){</span> envv<span class="org-rainbow-delimiters-depth-4">[</span>k.first<span class="org-rainbow-delimiters-depth-4">]</span> = k.second; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Copy local environment to temporary environment </span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">k</span> : env<span class="org-rainbow-delimiters-depth-3">){</span> envv<span class="org-rainbow-delimiters-depth-4">[</span>k.first<span class="org-rainbow-delimiters-depth-4">]</span> = k.second; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Pass parameters to local environment </span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span> = 0; n &lt; args.size<span class="org-rainbow-delimiters-depth-4">()</span>; n++ <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">a</span> = args<span class="org-rainbow-delimiters-depth-4">[</span>n<span class="org-rainbow-delimiters-depth-4">]</span>;
            envv<span class="org-rainbow-delimiters-depth-4">[</span>a<span class="org-rainbow-delimiters-depth-4">]</span> = params<span class="org-rainbow-delimiters-depth-4">[</span>n<span class="org-rainbow-delimiters-depth-4">]</span>;   
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">N</span> = body.size<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span> = 0; n &lt; N - 1; n ++ <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            body<span class="org-rainbow-delimiters-depth-4">[</span>n<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>envv<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = body<span class="org-rainbow-delimiters-depth-3">[</span>N - 1<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-3">(</span>envv<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> result-&gt;isFun<span class="org-rainbow-delimiters-depth-4">()</span> 
            &amp;&amp; <span class="org-negation-char">!</span><span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprFun</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>result<span class="org-rainbow-delimiters-depth-4">)</span>-&gt;isNativeFun<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>result<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span> = 0; n &lt; args.size<span class="org-rainbow-delimiters-depth-5">()</span>; n++ <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">a</span> = args<span class="org-rainbow-delimiters-depth-5">[</span>n<span class="org-rainbow-delimiters-depth-5">]</span>;
                func-&gt;env<span class="org-rainbow-delimiters-depth-5">[</span>a<span class="org-rainbow-delimiters-depth-5">]</span> = params<span class="org-rainbow-delimiters-depth-5">[</span>n<span class="org-rainbow-delimiters-depth-5">]</span>;   
            <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">return</span> result;
    <span class="org-rainbow-delimiters-depth-2">}</span>
                                
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Native function implemented in C or C++</span>
<span class="org-keyword">struct</span> <span class="org-type">ExprFunNative</span>: <span class="org-keyword">public</span> <span class="org-type">ExprFun</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">LispFunc</span> <span class="org-variable-name">func</span>; 
    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">"(native function) "</span> + <span class="org-keyword">this</span>-&gt;name;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isNativeFun</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-function-name">ExprFunNative</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">LispFunc</span> <span class="org-variable-name">func_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-2">(</span>func_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Invoke copy constructor </span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprFunNative</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>func<span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> 
    <span class="org-function-name">call</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">params</span>
         ,<span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env_</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Calling native function \n");</span>
        <span class="org-keyword">return</span> <span class="org-keyword">this</span>-&gt;func<span class="org-rainbow-delimiters-depth-3">(</span>params<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Represents a list </span>
<span class="org-keyword">struct</span> <span class="org-type">ExprLst</span>: <span class="org-keyword">public</span> <span class="org-type">IExpr</span>  
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">lst</span>; 

    <span class="org-function-name">ExprLst</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">lst_</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : lst<span class="org-rainbow-delimiters-depth-2">(</span>lst_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-type">ExprType</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">ExprType</span>::LST; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isAtom</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isList</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-function-name">strValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>;<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">double</span>       <span class="org-function-name">numValue</span><span class="org-rainbow-delimiters-depth-2">()</span>  <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> -1;   <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span>         <span class="org-function-name">boolValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;<span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">accept</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IVisitor</span>&amp; <span class="org-variable-name">v</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span> v.visit<span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">env</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>lst.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">type</span> = lst<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span> type != <span class="org-constant">ExprType</span>::SYM &amp;&amp; type != <span class="org-constant">ExprType</span>::LST  <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">" [ERROR] =&gt;&gt; Object is not applicable."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">symbol</span> = lst<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore comment special form</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>symbol == <span class="org-string">"comment"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>symbol == <span class="org-string">"set"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>lst.size<span class="org-rainbow-delimiters-depth-5">()</span> != 3<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for SET special form"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::SYM<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for SET special form. Expected symbol. "</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>; 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] Defining symbol = %s . \n"</span>, name.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            env<span class="org-rainbow-delimiters-depth-4">[</span>name<span class="org-rainbow-delimiters-depth-4">]</span> = res; <span class="org-comment-delimiter">//</span><span class="org-comment">;std::make_shared&lt;EnvVal&gt;(res);</span>
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle special form (if &lt;cond&gt; &lt;then-expr&gt;) or (if &lt;cond&gt; &lt;then-expr&gt; &lt;else-expr&gt;)</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"if"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> != 3 &amp;&amp; lst.size<span class="org-rainbow-delimiters-depth-5">()</span> != 4<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for IF special form"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">cond</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">cond_result</span> = cond-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> == 3 &amp;&amp; <span class="org-negation-char">!</span>cond_result-&gt;boolValue<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span> 
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-5">&gt;()</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> == 4 &amp;&amp; <span class="org-negation-char">!</span>cond_result-&gt;boolValue<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluate the else-expr </span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = lst<span class="org-rainbow-delimiters-depth-5">[</span>3<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-5">(</span>env<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">this-&gt;eval( *lst[3] );</span>
                <span class="org-keyword">return</span> res;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            assert<span class="org-rainbow-delimiters-depth-4">(</span> cond_result-&gt;boolValue<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">this-&gt;eval( *lst[2] );</span>
            <span class="org-keyword">return</span> res;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle quote special form </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"quote"</span> || symbol == <span class="org-string">"$q"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> != 2 <span class="org-rainbow-delimiters-depth-4">)</span> 
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for QUOTE special form"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">arg</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>;
            <span class="org-keyword">return</span> arg;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to scheme or lisp lambda or scheme lambda </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">(fn (a0 a1 ... a[N-1]) (expr1) (expr2) ... (expr[K-1]) )</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"fn"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>lst.size<span class="org-rainbow-delimiters-depth-5">()</span> &lt; 3<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for lambda special form"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for lambda. Expected arguments."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Function/lambda arguments   </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">args</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Function/lambda body (list of expressions)</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">body</span> = lst;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element ('lambda' symbol)</span>
            body.erase<span class="org-rainbow-delimiters-depth-4">(</span>body.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>; 
            <span class="org-comment-delimiter">// </span><span class="org-comment">Remove frst element - function arguments </span>
            body.erase<span class="org-rainbow-delimiters-depth-4">(</span>body.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>; 

            <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-4">&gt;</span> <span class="org-variable-name">_args</span><span class="org-rainbow-delimiters-depth-4">{}</span>;

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">a</span>: args-&gt;lst<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>a-&gt;isSym<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>            
                <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Ill-formed syntax for lamba. Arguments must be strings."</span><span class="org-rainbow-delimiters-depth-6">)</span>;  <span class="org-rainbow-delimiters-depth-5">}</span>
                _args.push_back<span class="org-rainbow-delimiters-depth-5">(</span> a-&gt;strValue<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">fun</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>_args, body<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> fun;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">/** </span><span class="org-comment">Sepcial form def </span>
<span class="org-comment">         * (def function (a0 a1 ... a[N-1]) (expr1) (expr2) ... (expr[K-1]) )</span>
<span class="org-comment">         * </span>
<span class="org-comment">         *  Example: </span>
<span class="org-comment">         *   (def addxy(x  y )</span>
<span class="org-comment">         *             (disp x) </span>
<span class="org-comment">         *             (disp y)</span>
<span class="org-comment">         *              (+ x y))</span>
<span class="org-comment">         * </span>
<span class="org-comment">         */</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"def"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>lst.size<span class="org-rainbow-delimiters-depth-5">()</span> &lt; 4<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for def() special form"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;isSym<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for def(). Expected function name."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>2<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Ill-formed syntax for def(). Expected arguments."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Function name </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">name</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Function/lambda arguments   </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">args</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>2<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Function/lambda body (list of expressions)</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">body</span> = lst;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element ('lambda' symbol)</span>
            body.erase<span class="org-rainbow-delimiters-depth-4">(</span>body.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>; 
            body.erase<span class="org-rainbow-delimiters-depth-4">(</span>body.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>; 
            body.erase<span class="org-rainbow-delimiters-depth-4">(</span>body.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>; 

            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [TRACE] Defining function = %s . \n"</span>, name.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-4">&gt;</span> <span class="org-variable-name">_args</span><span class="org-rainbow-delimiters-depth-4">{}</span>;

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">a</span>: args-&gt;lst<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>a-&gt;isSym<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>            
                <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Ill-formed syntax for lamba. Arguments must be strings."</span><span class="org-rainbow-delimiters-depth-6">)</span>;  <span class="org-rainbow-delimiters-depth-5">}</span>
                _args.push_back<span class="org-rainbow-delimiters-depth-5">(</span> a-&gt;strValue<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">fun</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>_args, body<span class="org-rainbow-delimiters-depth-4">)</span>;
            fun-&gt;name = name;

            env<span class="org-rainbow-delimiters-depth-4">[</span>name<span class="org-rainbow-delimiters-depth-4">]</span> = fun;

            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Handle special form (begin (action1 ....) (action 2) (action N-1)) </span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"begin"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">arguments </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">args</span> = lst;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element </span>
            args.erase<span class="org-rainbow-delimiters-depth-4">(</span>args.begin<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> args.size<span class="org-rainbow-delimiters-depth-5">()</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-5">&gt;()</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span> = 0; n &lt; args.size<span class="org-rainbow-delimiters-depth-5">()</span> - 1; n++<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>  args<span class="org-rainbow-delimiters-depth-5">[</span>n<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-5">(</span>env<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Revaluate last element </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = args<span class="org-rainbow-delimiters-depth-4">[</span> args.size<span class="org-rainbow-delimiters-depth-5">()</span> -1 <span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> result;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        
        <span class="org-comment-delimiter">/** </span><span class="org-comment">(let (binding lists) (exp1) (exp2) .... (expN-1) )</span>
<span class="org-comment">         *     </span>
<span class="org-comment">         *  (let ( (a 20)</span>
<span class="org-comment">         *         (b 30 )) </span>
<span class="org-comment">         *        (display a) (display b) (+ a b) )</span>
<span class="org-comment">         *  </span>
<span class="org-comment">         *  The previous expression evaluates to 30.</span>
<span class="org-comment">         */</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"let"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> &lt; 3 <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: ill-formed sytax for let expression."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: ill-formed sytax for let expression. Expected list of bindings."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">bindings</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span>-&gt;lst;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Create a new temporary environment </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">envv</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-5">&gt;</span><span class="org-rainbow-delimiters-depth-4">&gt;{}</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">envs</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-5">&gt;</span><span class="org-rainbow-delimiters-depth-4">&gt;{}</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Copy environment     </span>
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span>&amp; <span class="org-variable-name">k</span> : env<span class="org-rainbow-delimiters-depth-4">){</span> envv<span class="org-rainbow-delimiters-depth-5">[</span>k.first<span class="org-rainbow-delimiters-depth-5">]</span> = k.second; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">b</span>: bindings<span class="org-rainbow-delimiters-depth-4">){</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>b-&gt;isList<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
                    <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: ill-formed sytax for let expression. Expected list as binding argument."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">bb</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span>b<span class="org-rainbow-delimiters-depth-5">)</span>-&gt;lst;
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> bb.size<span class="org-rainbow-delimiters-depth-6">()</span> != 2<span class="org-rainbow-delimiters-depth-5">)</span>
                    <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: ill-formed sytax for let expression."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>bb<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isSym<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span> 
                    <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: ill-formed sytax for let expression. Expected symbol."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">sym</span> = bb<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-5">()</span>;
                <span class="org-keyword">auto</span> <span class="org-variable-name">val</span> = bb<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-5">(</span>envv<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-comment-delimiter">// </span><span class="org-comment">Add symbols from let binding to the new temporary environment</span>
                envv<span class="org-rainbow-delimiters-depth-5">[</span>sym<span class="org-rainbow-delimiters-depth-5">]</span> = val;
                envs<span class="org-rainbow-delimiters-depth-5">[</span>sym<span class="org-rainbow-delimiters-depth-5">]</span> = val;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">size_t</span> <span class="org-variable-name">k</span> = 2; k &lt; lst.size<span class="org-rainbow-delimiters-depth-5">()</span> - 1; k ++<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> lst<span class="org-rainbow-delimiters-depth-5">[</span>k<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-5">(</span>envv<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>lst.size<span class="org-rainbow-delimiters-depth-5">()</span> - 1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>envv<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Implement closure - function cature variables from local environment </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> result-&gt;isFun<span class="org-rainbow-delimiters-depth-5">()</span> 
                &amp;&amp; <span class="org-negation-char">!</span><span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprFun</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span>result<span class="org-rainbow-delimiters-depth-5">)</span>-&gt;isNativeFun<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprFunLisp</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span>result<span class="org-rainbow-delimiters-depth-5">)</span>;
                func-&gt;env = envs;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">return</span> result;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">/** </span><span class="org-comment">For-loop similar to common lisp =&gt; (repeat 10 n (action n)) */</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> symbol == <span class="org-string">"repeat"</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> lst.size<span class="org-rainbow-delimiters-depth-5">()</span> != 4 <span class="org-rainbow-delimiters-depth-4">)</span> 
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: ill-formed syntax for repeat special form. Expected 4 arguments"</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>lst<span class="org-rainbow-delimiters-depth-5">[</span>2<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;isSym<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: ill-formed syntax for repeat special form. Expected symbol."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span>n-&gt;isNum<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: expected number as first argument."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">ntimes</span> = <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> n-&gt;numValue<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> ntimes &lt; 0<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: ill-formed syntax for repeat special form . Iterations cannot be negative."</span><span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-keyword">auto</span> <span class="org-variable-name">sym</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-4">()</span>;

            <span class="org-keyword">auto</span> <span class="org-variable-name">action</span> = lst<span class="org-rainbow-delimiters-depth-4">[</span>3<span class="org-rainbow-delimiters-depth-4">]</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Copy environment </span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">envv</span> = env;

            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span> <span class="org-variable-name">k</span> = 0; k &lt; ntimes; k++<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                envv<span class="org-rainbow-delimiters-depth-5">[</span>sym<span class="org-rainbow-delimiters-depth-5">]</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span>k<span class="org-rainbow-delimiters-depth-5">)</span>;
                action-&gt;eval<span class="org-rainbow-delimiters-depth-5">(</span>envv<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>


        <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Function Application --------------------//</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = lst<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;eval<span class="org-rainbow-delimiters-depth-3">(</span>env<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>it-&gt;isFun<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error - object not callable."</span><span class="org-rainbow-delimiters-depth-4">)</span>;  <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">function</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>it<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Function arguments</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">args</span> = lst;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element</span>
        args.erase<span class="org-rainbow-delimiters-depth-3">(</span>args.begin<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">evaluatedArgs</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">evaluatedArgs.reserve(args.size());</span>
        <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span> &amp;<span class="org-variable-name">arg</span> : args<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = arg-&gt;eval<span class="org-rainbow-delimiters-depth-4">(</span>env<span class="org-rainbow-delimiters-depth-4">)</span>; 
            evaluatedArgs.push_back<span class="org-rainbow-delimiters-depth-4">(</span>res<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = function-&gt;call<span class="org-rainbow-delimiters-depth-3">(</span>evaluatedArgs, env<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> result;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Parser </span>
<span class="org-keyword">auto</span> <span class="org-function-name">readTokens</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Token</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>&amp; <span class="org-variable-name">tokens</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">auto tokens = tokens_;</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tokens.size<span class="org-rainbow-delimiters-depth-3">()</span> == 0<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: Unexpected EOF - End of File"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-variable-name">tok</span> = tokens<span class="org-rainbow-delimiters-depth-2">[</span>0<span class="org-rainbow-delimiters-depth-2">]</span>;    
    <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element of vector </span>
    tokens.erase<span class="org-rainbow-delimiters-depth-2">(</span>tokens.begin<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">std::cout &lt;&lt; " [readToken] " &lt;&lt; tok.type &lt;&lt; " ; " &lt;&lt; tok.text </span>
    <span class="org-comment-delimiter">//           </span><span class="org-comment">&lt;&lt; " ; line = " &lt;&lt; tok.lin &lt;&lt; " ; col = " &lt;&lt; tok.col </span>
    <span class="org-comment-delimiter">//           </span><span class="org-comment">&lt;&lt; "\n";</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::ERR <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"[ERROR] "</span> + tok.text<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::QUOTE <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;{}</span>;
        lst.push_back<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprSym</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span><span class="org-string">"quote"</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">next</span> = readTokens<span class="org-rainbow-delimiters-depth-3">(</span>tokens<span class="org-rainbow-delimiters-depth-3">)</span>;
        lst.push_back<span class="org-rainbow-delimiters-depth-3">(</span>next<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::LPAREN  <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;{}</span>;

        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> tokens<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>.type != <span class="org-constant">TokenType</span>::RPAREN <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = readTokens<span class="org-rainbow-delimiters-depth-4">(</span>tokens<span class="org-rainbow-delimiters-depth-4">)</span>;
            lst.push_back<span class="org-rainbow-delimiters-depth-4">(</span> expr <span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Drop off ')' right parentheis</span>
        tokens.erase<span class="org-rainbow-delimiters-depth-3">(</span>tokens.begin<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::RPAREN  <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: Unexpected ')' right parenthesis "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::NUM<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> <span class="org-constant">std</span>::stoi<span class="org-rainbow-delimiters-depth-4">(</span>tok.text<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::SYM &amp;&amp; tok.text == <span class="org-string">"nil"</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::SYM <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprSym</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> tok.text <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::KEYW <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprKey</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> tok.text <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::BOOL <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> tok.text == <span class="org-string">"#t"</span> ? <span class="org-constant">true</span> : <span class="org-constant">false</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> tok.type == <span class="org-constant">TokenType</span>::STR <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprStr</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> tok.text <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">ExprErr</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>-1, <span class="org-string">"Edge found in the parser"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Parse Lisp-like (scheme-like) S-Expression by reading a string source code </span>
<span class="org-keyword">auto</span> <span class="org-function-name">parseSexp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>; 
    ss &lt;&lt; code; 
    <span class="org-type">Tokenizer</span> <span class="org-variable-name">tokenizer</span><span class="org-rainbow-delimiters-depth-2">(</span>ss<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">tokens</span> = tokenizer.readTokens<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = readTokens<span class="org-rainbow-delimiters-depth-2">(</span>tokens<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Parse Lisp-like (scheme-like) S-Expression by reading an input stream </span>
<span class="org-keyword">auto</span> <span class="org-function-name">parseSexp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">istream</span>&amp; <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">Tokenizer</span> <span class="org-variable-name">tokenizer</span><span class="org-rainbow-delimiters-depth-2">(</span>is<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">tokens</span> = tokenizer.readTokens<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = readTokens<span class="org-rainbow-delimiters-depth-2">(</span>tokens<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> result;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">class</span> <span class="org-type">PrintVisitor</span>: <span class="org-keyword">public</span> <span class="org-type">IVisitor</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:

    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNil</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"nil"</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprStr</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\""</span> &lt;&lt; expr.value &lt;&lt; <span class="org-string">"\""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNum</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprBool</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>expr.value ? <span class="org-string">"#t"</span> : <span class="org-string">"#f"</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprSym</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprKey</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprErr</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"&lt;&lt; [ERROR] "</span> &lt;&lt; expr.info; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprFun</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-constant">std</span>::cout &lt;&lt; expr.strValue<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprLst</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">override</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"( "</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-variable-name">node</span> : expr.lst<span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" "</span>; node-&gt;accept<span class="org-rainbow-delimiters-depth-4">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" )"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">WriterVisitor</span>: <span class="org-keyword">public</span> <span class="org-type">IVisitor</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">out</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">WriterVisitor</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">out</span><span class="org-rainbow-delimiters-depth-2">(</span>os_<span class="org-rainbow-delimiters-depth-2">){}</span>

    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNil</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; <span class="org-string">"nil"</span>; <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprStr</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; <span class="org-string">"\""</span> &lt;&lt; expr.value &lt;&lt; <span class="org-string">"\""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprNum</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprBool</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>expr.value ? <span class="org-string">"#t"</span> : <span class="org-string">"#f"</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprSym</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprKey</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; expr.value; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprErr</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; <span class="org-string">"&lt;&lt; [ERROR] "</span> &lt;&lt; expr.info; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprFun</span>&amp;  <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span> out &lt;&lt; expr.strValue<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">visit</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ExprLst</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">override</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">out &lt;&lt; "\n ( ";</span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">node</span> : expr.lst<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> 
            out &lt;&lt; <span class="org-string">" "</span>; node-&gt;accept<span class="org-rainbow-delimiters-depth-4">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">if( node-&gt;isList() ){ out &lt;&lt; '\n'; }</span>
         <span class="org-rainbow-delimiters-depth-3">}</span>
        out &lt;&lt; <span class="org-string">" )"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-comment-delimiter">// </span><span class="org-comment">Print S-Expression </span>
<span class="org-type">void</span> <span class="org-function-name">printSexp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">IExpr</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">PrintVisitor</span> <span class="org-variable-name">visitor</span>;
    expr.accept<span class="org-rainbow-delimiters-depth-2">(</span>visitor<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-keyword">struct</span> <span class="org-type">IEnvType</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span> <span class="org-function-name">isFunction</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">bool</span> <span class="org-function-name">isVariable</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">getValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IEnvType</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">EnvVal</span>: <span class="org-keyword">public</span> <span class="org-type">IEnvType</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">value</span>;
    <span class="org-function-name">EnvVal</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">value_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">value</span><span class="org-rainbow-delimiters-depth-2">(</span>value_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isFunction</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isVariable</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>;  <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">getValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> value; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">EnvFun</span>: <span class="org-keyword">public</span> <span class="org-type">IEnvType</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">LispFunc</span> <span class="org-variable-name">func</span>; 
    <span class="org-function-name">EnvFun</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">LispFunc</span> <span class="org-variable-name">func_</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">func</span><span class="org-rainbow-delimiters-depth-2">(</span>func_<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-type">bool</span> <span class="org-function-name">isFunction</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">bool</span> <span class="org-function-name">isVariable</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">false</span>;  <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">getValue</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">/// </span><span class="org-comment">Lisp interpreter's primitive functions </span>
<span class="org-keyword">namespace</span> <span class="org-constant">primitives</span> <span class="org-rainbow-delimiters-depth-1">{</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">All Lisp functions passed to the interpreter must have this type signature </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Lisp function primitive 'list' =&gt; Example: (list 10 20 (+ 1 2 5) "Hello" #f #t nil)</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">list</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>args<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Return the number of elements of alist </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">length</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: length() requires 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: length() expects 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">node</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-3">&gt;(</span> *args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = node.lst;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lst.size<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">//  </span><span class="org-comment">car =&gt; Returns first element of the list or nil </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">car</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: car() requires 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: car() expects 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">node</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-3">&gt;(</span> *args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = node.lst;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> lst.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0 <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> lst<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">cdr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: cdr() requires 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: cdr() expects 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">node</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-3">&gt;(</span> *args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = node.lst;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> lst.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0 <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first list argument </span>
        lst.erase<span class="org-rainbow-delimiters-depth-3">(</span>lst.begin<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">cons =&gt; List constructor </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">cons</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 2 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: cons() requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNil<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: pairs construction not allowed. Second argument can only be a list or nil."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span>  = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span> args<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span> <span class="org-rainbow-delimiters-depth-4">)</span>-&gt;lst;
            lst.insert<span class="org-rainbow-delimiters-depth-4">(</span>lst.begin<span class="org-rainbow-delimiters-depth-5">()</span>, args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        assert<span class="org-rainbow-delimiters-depth-3">(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNil<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> =  <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;{</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span> <span class="org-rainbow-delimiters-depth-3">}</span>;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lst<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get the nth element of a list</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">nth</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 2 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: cons() requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span> 
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: Expected number "</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNil<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: Expected list or nil."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNil<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-4">&gt;()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;    
        <span class="org-keyword">auto</span> <span class="org-variable-name">lst</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>-&gt;lst;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> n &lt; lst.size<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; n &gt;= 0 <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> lst<span class="org-rainbow-delimiters-depth-4">[</span>n<span class="org-rainbow-delimiters-depth-4">]</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">(= 10 20) =&gt; #f ; (= 10 10) =&gt; #t</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">equal_number</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 2 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: = requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span> 
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: Expected number "</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">a</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;    
        <span class="org-keyword">auto</span> <span class="org-variable-name">b</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;    
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>a == b<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">less_than</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 2 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: = requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span> 
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: Expected number "</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">a</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;    
        <span class="org-keyword">auto</span> <span class="org-variable-name">b</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;    
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>a &lt; b<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Parse a string returning a S-Expression </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: read() requires 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> != <span class="org-constant">ExprType</span>::STR <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: read() expects 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span>  = args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = parseSexp<span class="org-rainbow-delimiters-depth-3">(</span>code<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> result;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function list? =&gt; Return true if the argument is of type list </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_list</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: list?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function symbol? =&gt; Return true if the argument is of type symbol</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_symbol</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: symbol?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> == <span class="org-constant">ExprType</span>::SYM <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_keyword</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: keyword?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> == <span class="org-constant">ExprType</span>::KEY <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function number? =&gt; Return true if the argument is of type number</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_number</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: number?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNum<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function boolean? =&gt; Return true if the argument is of type number</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_boolean</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: boolean?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> == <span class="org-constant">ExprType</span>::BOOL <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function nil? =&gt; Return true if the argument is of type nil</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_nil</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: nil?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;isNil<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate function string? =&gt; Return true if the argument is of type string</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">is_string</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: string?() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprBool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> == <span class="org-constant">ExprType</span>::STR <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Display an S-Expression </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">disp</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> != 1 <span class="org-rainbow-delimiters-depth-3">){</span>
           <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: function disp() requires 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span> 
        <span class="org-type">PrintVisitor</span> <span class="org-variable-name">visitor</span>;
        args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;accept<span class="org-rainbow-delimiters-depth-3">(</span>visitor<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-3">&gt;()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Lisp function (+) =&gt; Example: (+ 1 2 3 4 5) = 15</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">add</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0 <span class="org-rainbow-delimiters-depth-3">){</span>
           <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: this function requires at least 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span> 
       <span class="org-type">double</span> <span class="org-variable-name">acc</span> = 0.0;
       <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">a</span>: args<span class="org-rainbow-delimiters-depth-3">){</span>
           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> a-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">){</span>
               <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Invalid argument. Expected a number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
           <span class="org-rainbow-delimiters-depth-4">}</span>
           acc = acc + a-&gt;numValue<span class="org-rainbow-delimiters-depth-4">()</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>acc<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Lisp function (*) =&gt; Example: (* 1 2 3 4 5) = 120</span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">mul</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0 <span class="org-rainbow-delimiters-depth-3">){</span>
           <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: this function requires at least 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span> 
       <span class="org-type">double</span> <span class="org-variable-name">acc</span> = 1.0;
       <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">a</span>: args<span class="org-rainbow-delimiters-depth-3">){</span>
           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> a-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">){</span>
               <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Invalid argument. Expected a number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
           <span class="org-rainbow-delimiters-depth-4">}</span>
           acc = acc * a-&gt;numValue<span class="org-rainbow-delimiters-depth-4">()</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>
       <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>acc<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">List function (-) =&gt; Example: (- 100 20 30 ) = 100 - 20 - 30 = 50 </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">sub</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Called Lispfun sub() \n "); </span>
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: this function requires at least 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 1<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: invalid argument type. Expected number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            assert<span class="org-rainbow-delimiters-depth-4">(</span>args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> == <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>-args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: invalid argument type. Expected number"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-type">double</span> <span class="org-variable-name">acc</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] acc = %f \n", acc);</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">args_</span> = args;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element</span>
        args_.erase<span class="org-rainbow-delimiters-depth-3">(</span>args_.begin<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span> &amp;<span class="org-variable-name">a</span> : args_<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>a-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Invalid argument. Expected a number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-type">double</span> <span class="org-variable-name">x</span> = a-&gt;numValue<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] x = %f \n", x);</span>
            acc = acc - x; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>acc<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">div</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] Called Lispfun sub() \n "); </span>
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: this function requires at least 1 argument."</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args.size<span class="org-rainbow-delimiters-depth-4">()</span> == 1<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Error: invalid argument type. Expected number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            assert<span class="org-rainbow-delimiters-depth-4">(</span>args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> == <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>1.0 / args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: invalid argument type. Expected number"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-type">double</span> <span class="org-variable-name">acc</span> = args<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>-&gt;numValue<span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] acc = %f \n", acc);</span>

        <span class="org-keyword">auto</span> <span class="org-variable-name">args_</span> = args;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove first element</span>
        args_.erase<span class="org-rainbow-delimiters-depth-3">(</span>args_.begin<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">for</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span> &amp;<span class="org-variable-name">a</span> : args_<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-4">(</span>a-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"Invalid argument. Expected a number"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-type">double</span> <span class="org-variable-name">x</span> = a-&gt;numValue<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">std::fprintf(stderr, " [TRACE] x = %f \n", x);</span>
            acc = acc / x; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>acc<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>


<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class="org-type">Eval</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Reference to itself in oder to provide code completion</span>
    <span class="org-type">Eval</span>&amp; <span class="org-variable-name">self</span> = *<span class="org-keyword">this</span>;

<span class="org-function-name">public</span>:
    <span class="org-keyword">using</span> <span class="org-type">Env</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Lisp environment </span>
    <span class="org-type">Env</span> <span class="org-variable-name">_env</span>;

    <span class="org-function-name">Eval</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"disp"</span>,    &amp;<span class="org-constant">primitives</span>::disp<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive list functions </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"list"</span>,    &amp;<span class="org-constant">primitives</span>::list<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"length"</span>,  &amp;<span class="org-constant">primitives</span>::length<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"car"</span>,     &amp;<span class="org-constant">primitives</span>::car<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"cdr"</span>,     &amp;<span class="org-constant">primitives</span>::cdr<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"cons"</span>,    &amp;<span class="org-constant">primitives</span>::cons<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"nth"</span>,     &amp;<span class="org-constant">primitives</span>::nth<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Primitive predicate functions  </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"number?"</span>,  &amp;<span class="org-constant">primitives</span>::is_number<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"boolean?"</span>, &amp;<span class="org-constant">primitives</span>::is_boolean<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"symbol?"</span>,  &amp;<span class="org-constant">primitives</span>::is_symbol<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"nil?"</span>,     &amp;<span class="org-constant">primitives</span>::is_nil<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"keyword?"</span>, &amp;<span class="org-constant">primitives</span>::is_keyword<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"list?"</span>,    &amp;<span class="org-constant">primitives</span>::is_list<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Primtive math functions </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"="</span>,       &amp;<span class="org-constant">primitives</span>::equal_number<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"&lt;"</span>,       &amp;<span class="org-constant">primitives</span>::less_than<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"+"</span>,       &amp;<span class="org-constant">primitives</span>::add<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"*"</span>,       &amp;<span class="org-constant">primitives</span>::mul<span class="org-rainbow-delimiters-depth-3">)</span>; 
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-"</span>,       &amp;<span class="org-constant">primitives</span>::sub<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/"</span>,       &amp;<span class="org-constant">primitives</span>::div<span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addMath1ArgFun<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"sin"</span>, <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span> <span class="org-rainbow-delimiters-depth-5">(</span>*<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>&amp;<span class="org-constant">std</span>::sin<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addMath1ArgFun<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"cos"</span>, <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span> <span class="org-rainbow-delimiters-depth-5">(</span>*<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>&amp;<span class="org-constant">std</span>::cos<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addMath1ArgFun<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"tan"</span>, <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span> <span class="org-rainbow-delimiters-depth-5">(</span>*<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>&amp;<span class="org-constant">std</span>::tan<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addMath1ArgFun<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"sqrt"</span>, <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span> <span class="org-rainbow-delimiters-depth-5">(</span>*<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-5">)</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>&amp;<span class="org-constant">std</span>::sqrt<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addMath1ArgFun<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"inv"</span>, <span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">return</span> 1.0 / x; <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        self.addVariable<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"PI"</span>, 3.1415<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Parse string into a SExp - S-Expression </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"read"</span>, &amp;<span class="org-constant">primitives</span>::read<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Evaluate a List (AST - Abstract Syntax Tree) or SEXP returning a SEXP (S-Expression)</span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"eval"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 1 <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: eval(sexp) requires 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: eval(sexpr) expects 1 argument of type list."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprLst</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-5">&gt;(</span> *args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span> <span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">return</span> expr.eval<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">this</span>-&gt;_env<span class="org-rainbow-delimiters-depth-5">)</span>; 
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">load a file </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"load-file"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 1  &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isStr<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: load-file() requires 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">auto</span> <span class="org-variable-name">file</span> = args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-5">()</span>; 
            <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = <span class="org-keyword">this</span>-&gt;evalFile<span class="org-rainbow-delimiters-depth-5">(</span>file<span class="org-rainbow-delimiters-depth-5">)</span>; 
            <span class="org-keyword">return</span> expr;
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Read a single S-Expression from file without evaluating it </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"read-file"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 1  &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isStr<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: eval(sexp) requires 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">auto</span> <span class="org-variable-name">file</span> = args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-5">()</span>; 
            <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span>  = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-5">(</span>file<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">sexp</span>  = parseSexp<span class="org-rainbow-delimiters-depth-5">(</span>ifs<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">return</span> sexp;
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Write a single S-Expression to a file </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"write-file"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 2  &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isStr<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: eval(sexp) requires 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">auto</span> <span class="org-variable-name">file</span> = args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-5">()</span>; 
            <span class="org-keyword">auto</span> <span class="org-variable-name">ofs</span>  = <span class="org-constant">std</span>::ofstream<span class="org-rainbow-delimiters-depth-5">(</span>file<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-type">WriterVisitor</span> <span class="org-variable-name">visitor</span><span class="org-rainbow-delimiters-depth-5">(</span>ofs<span class="org-rainbow-delimiters-depth-5">)</span>; 
            args<span class="org-rainbow-delimiters-depth-5">[</span>1<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;accept<span class="org-rainbow-delimiters-depth-5">(</span>visitor<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-5">&gt;()</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Read a multiple S-Expression from file without evaluating it </span>
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"read-file-multiple"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 1  &amp;&amp; <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isStr<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: eval(sexp) requires 1 argument of type string."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">auto</span> <span class="org-variable-name">file</span> = args<span class="org-rainbow-delimiters-depth-5">[</span>0<span class="org-rainbow-delimiters-depth-5">]</span>-&gt;strValue<span class="org-rainbow-delimiters-depth-5">()</span>; 
            <span class="org-constant">std</span>::<span class="org-type">ifstream</span> <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-5">(</span>file<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>is.good<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: stream has errors."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
            ss &lt;&lt; is.rdbuf<span class="org-rainbow-delimiters-depth-5">()</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">code</span> = <span class="org-string">"( \n"</span> +  ss.str<span class="org-rainbow-delimiters-depth-5">()</span> + <span class="org-string">"\n )"</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">sexp</span> = parseSexp<span class="org-rainbow-delimiters-depth-5">(</span>code<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">return</span> sexp;
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"apply"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 2 <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: apply() requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isFun<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: expected function as first argument."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>1<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: expected list as second argument."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprFun</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span><span class="org-type">args</span><span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">params</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span><span class="org-type">args</span><span class="org-rainbow-delimiters-depth-6">[</span>1<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>; 
            <span class="org-keyword">return</span> func-&gt;call<span class="org-rainbow-delimiters-depth-5">(</span>params-&gt;lst, <span class="org-keyword">this</span>-&gt;_env<span class="org-rainbow-delimiters-depth-5">)</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  
        self.addFunction<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"map"</span>, <span class="org-rainbow-delimiters-depth-4">[</span>=<span class="org-rainbow-delimiters-depth-4">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> args.size<span class="org-rainbow-delimiters-depth-6">()</span> != 2 <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: apply() requires 2 arguments."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span> 
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isFun<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: expected function as first argument."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> <span class="org-negation-char">!</span>args<span class="org-rainbow-delimiters-depth-6">[</span>1<span class="org-rainbow-delimiters-depth-6">]</span>-&gt;isList<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>
            <span class="org-rainbow-delimiters-depth-5">{</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"Error: expected list as second argument."</span><span class="org-rainbow-delimiters-depth-6">)</span>; <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprFun</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span><span class="org-type">args</span><span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">params</span> = <span class="org-constant">std</span>::static_pointer_cast<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span><span class="org-type">args</span><span class="org-rainbow-delimiters-depth-6">[</span>1<span class="org-rainbow-delimiters-depth-6">]</span><span class="org-rainbow-delimiters-depth-5">)</span>; 

            <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;{}</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">args_</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-6">&gt;</span><span class="org-rainbow-delimiters-depth-5">&gt;{</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-6">&lt;</span><span class="org-type">ExprNil</span><span class="org-rainbow-delimiters-depth-6">&gt;()</span> <span class="org-rainbow-delimiters-depth-5">}</span>;
            result.reserve<span class="org-rainbow-delimiters-depth-5">(</span> params-&gt;lst.size<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">p</span>: params-&gt;lst<span class="org-rainbow-delimiters-depth-5">){</span>
                args_<span class="org-rainbow-delimiters-depth-6">[</span>0<span class="org-rainbow-delimiters-depth-6">]</span> = p; 
                result.push_back<span class="org-rainbow-delimiters-depth-6">(</span> func-&gt;call<span class="org-rainbow-delimiters-depth-7">(</span> args_, <span class="org-keyword">this</span>-&gt;_env <span class="org-rainbow-delimiters-depth-7">)</span> <span class="org-rainbow-delimiters-depth-6">)</span>;
            <span class="org-rainbow-delimiters-depth-5">}</span>
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">ExprLst</span><span class="org-rainbow-delimiters-depth-5">&gt;(</span>result<span class="org-rainbow-delimiters-depth-5">)</span>;

        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">addVariable</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span>, <span class="org-type">double</span> <span class="org-variable-name">value</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>value<span class="org-rainbow-delimiters-depth-3">)</span>;
        _env<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = expr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">addVariable</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span>, <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        _env<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = expr;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">addFunction</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span>, <span class="org-type">LispFunc</span> <span class="org-variable-name">func</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">fn</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprFunNative</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>func<span class="org-rainbow-delimiters-depth-3">)</span>;
        fn-&gt;name = name;
        _env<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = fn;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Func</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">void</span> <span class="org-function-name">addMath1ArgFun</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">name</span>, <span class="org-type">Func</span> <span class="org-variable-name">funcMath</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">auto</span> <span class="org-variable-name">func</span> = <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-5">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-5">&gt;</span><span class="org-rainbow-delimiters-depth-4">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> args.size<span class="org-rainbow-delimiters-depth-5">()</span> != 1<span class="org-rainbow-delimiters-depth-4">){</span>
               <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [ERROR] This function requires exactly one argument."</span><span class="org-rainbow-delimiters-depth-5">)</span>;
           <span class="org-rainbow-delimiters-depth-4">}</span>
           <span class="org-keyword">auto</span> <span class="org-variable-name">x</span> = args<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span>;
           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> x-&gt;type<span class="org-rainbow-delimiters-depth-5">()</span> != <span class="org-constant">ExprType</span>::NUM <span class="org-rainbow-delimiters-depth-4">){</span>
               <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [ERROR] Invalid arguument type. Number required. "</span><span class="org-rainbow-delimiters-depth-5">)</span>;
           <span class="org-rainbow-delimiters-depth-4">}</span>
           <span class="org-type">double</span> <span class="org-variable-name">res</span> = funcMath<span class="org-rainbow-delimiters-depth-4">(</span>x-&gt;numValue<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
           <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">ExprNum</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>res<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-rainbow-delimiters-depth-3">}</span>;
       <span class="org-keyword">auto</span> <span class="org-variable-name">val</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">ExprFunNative</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>func<span class="org-rainbow-delimiters-depth-3">)</span>;
       val-&gt;name = name;
       _env<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = val;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-function-name">eval</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IExpr</span>&amp; <span class="org-variable-name">expr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> expr.eval<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-keyword">this</span>-&gt;_env <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Interactive read-print eval loop0 </span>
    <span class="org-type">void</span> <span class="org-function-name">repl</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>; 
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">arg</span>, <span class="org-variable-name">command</span>; 

        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span>;;<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" $ lisp&gt;&gt; "</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-negation-char">!</span><span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> line == <span class="org-string">""</span> <span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-4">(</span>line<span class="org-rainbow-delimiters-depth-4">)</span>;
            ss &gt;&gt; command &gt;&gt; arg;
            <span class="org-keyword">try</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> command == <span class="org-string">":file"</span><span class="org-rainbow-delimiters-depth-5">)</span>
                <span class="org-rainbow-delimiters-depth-5">{</span>
                    <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = <span class="org-keyword">this</span>-&gt;evalFile<span class="org-rainbow-delimiters-depth-6">(</span>arg<span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-keyword">continue</span>;
                <span class="org-rainbow-delimiters-depth-5">}</span>

                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span> command == <span class="org-string">":block"</span><span class="org-rainbow-delimiters-depth-5">)</span>
                <span class="org-rainbow-delimiters-depth-5">{</span>
                    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-6">(</span>stderr, <span class="org-string">" [INFO] Type a multi-line s-expression and type (;;) as the last line when you are done. \n"</span><span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">code</span>;

                    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-6">(</span> line != <span class="org-string">";;"</span> <span class="org-rainbow-delimiters-depth-6">){</span> 
                        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-7">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-7">)</span>;
                        code = code + <span class="org-string">"\n"</span> + line;
                     <span class="org-rainbow-delimiters-depth-6">}</span>
                    <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = <span class="org-keyword">this</span>-&gt;evalCode<span class="org-rainbow-delimiters-depth-6">(</span>code<span class="org-rainbow-delimiters-depth-6">)</span>;
                    self.addVariable<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"ans"</span>, res<span class="org-rainbow-delimiters-depth-6">)</span>;
                    printSexp<span class="org-rainbow-delimiters-depth-6">(</span>*res<span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-keyword">continue</span>;

                <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = <span class="org-keyword">this</span>-&gt;evalCode<span class="org-rainbow-delimiters-depth-5">(</span>line<span class="org-rainbow-delimiters-depth-5">)</span>;
                self.addVariable<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"ans"</span>, res<span class="org-rainbow-delimiters-depth-5">)</span>;
                printSexp<span class="org-rainbow-delimiters-depth-5">(</span>*res<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>
            <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">e</span><span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; e.what<span class="org-rainbow-delimiters-depth-5">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/// </span><span class="org-comment">Eval lisp-like code given as string </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>  
    <span class="org-function-name">evalCode</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">code</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = parseSexp<span class="org-rainbow-delimiters-depth-3">(</span>code<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = expr-&gt;eval<span class="org-rainbow-delimiters-depth-3">(</span>_env<span class="org-rainbow-delimiters-depth-3">)</span>; 
        <span class="org-keyword">return</span> result;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IExpr</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>  
    <span class="org-function-name">evalFile</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">ifstream</span> <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-3">(</span>file<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-negation-char">!</span>is.good<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: stream has errors."</span><span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
        ss &lt;&lt; is.rdbuf<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">code</span> = <span class="org-string">"(begin \n"</span> +  ss.str<span class="org-rainbow-delimiters-depth-3">()</span> + <span class="org-string">"\n )"</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = parseSexp<span class="org-rainbow-delimiters-depth-3">(</span>code<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">result</span> = expr-&gt;eval<span class="org-rainbow-delimiters-depth-3">(</span>_env<span class="org-rainbow-delimiters-depth-3">)</span>; 
        <span class="org-keyword">return</span> result;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Testing "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">text</span> = R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">         ; comment1</span>
<span class="org-string">         ;   comment 2  </span>
<span class="org-string">         ; comment 3 </span>
<span class="org-string">     (  print-&gt;list </span>
<span class="org-string">         ; comment 4</span>
<span class="org-string">          " Hello world" A8 B100</span>
<span class="org-string">          ; Next comment </span>
<span class="org-string">          #t #f </span>
<span class="org-string">             (+  20 30 -200(* 20 -20 x y z 8000)) ) </span>
<span class="org-string">    )</span><span class="org-default">"</span>;

    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
   
<span class="org-preprocessor">    #if</span> 0 
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =========== Tokenizer  ======================== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    ss &lt;&lt; text; 
    ss &lt;&lt; <span class="org-string">"100"</span>;
    
    <span class="org-type">Tokenizer</span> <span class="org-variable-name">tokenizer</span><span class="org-rainbow-delimiters-depth-2">(</span>ss<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Token</span> <span class="org-variable-name">tok</span>;
    
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>tok.isEOF<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span>
        tok = tokenizer.nextToken<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; tok.type &lt;&lt; <span class="org-string">" ; "</span> &lt;&lt; tok.text 
                  &lt;&lt; <span class="org-string">" ; line = "</span> &lt;&lt; tok.lin &lt;&lt; <span class="org-string">" ; col = "</span> &lt;&lt; tok.col 
                  &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-preprocessor">    #endif</span> 

    <span class="org-keyword">auto</span> <span class="org-variable-name">expr</span> = parseSexp<span class="org-rainbow-delimiters-depth-2">(</span>text<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-constant">std</span>::cout &lt;&lt;  <span class="org-constant">std</span>::boolalpha &lt;&lt; <span class="org-string">" [TRACE] expr-&gt;isList() = "</span> &lt;&lt; expr-&gt;isList<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

    printSexp<span class="org-rainbow-delimiters-depth-2">(</span>*expr<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ====== Evaluate Code  ======================== "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">code1</span> = R<span class="org-default">"</span><span class="org-string">( </span>
<span class="org-string">        (list 10 #t #f "hello world" </span>
<span class="org-string">            ; Operation 1</span>
<span class="org-string">            (+ 10 25 6) </span>
<span class="org-string">            ; Operation 2</span>
<span class="org-string">            (* 4 2 6) )</span>
<span class="org-string">     )</span><span class="org-default">"</span>;

    <span class="org-type">Eval</span> <span class="org-variable-name">eval</span>; 

    <span class="org-keyword">auto</span> <span class="org-variable-name">res</span> = eval.evalCode<span class="org-rainbow-delimiters-depth-2">(</span>code1<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Result = "</span>;
    printSexp<span class="org-rainbow-delimiters-depth-2">(</span>*res<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"============ Start LISP REPL ======================"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
    eval.repl<span class="org-rainbow-delimiters-depth-2">()</span>; 


    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Building  the lisp interpreter: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$  g++ cpplisp.cpp -o <span class="org-keyword">cpplisp.bin</span> -g -Wall -Wextra -std=c++1z
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-lisp">$ &gt;&gt; rlwrap ./cpplisp.bin
 [TRACE] Testing 
 [TRACE] expr-&gt;isList() = true
(  print-&gt;list <span class="org-string">" Hello world"</span> A8 B100 #t #f (  + 20 30 -200 (  * 20 -20 x y z 8000 ) ) )
 ====== Evaluate Code  ======================== 
 [TRACE] Result = (  10 #t #f <span class="org-string">"hello world"</span> 41 48 )
============ Start LISP REPL ======================

 $ lisp&gt;&gt; (list '(+ 1 2 3 4 5) (+ 1 2 3 4 5) '(* 4 100) (* 4 100) <span class="org-builtin">:keyword</span> #t #f nil <span class="org-string">"Hello world"</span>)
(  (  + 1 2 3 4 5 ) 15 (  * 4 100 ) 400 <span class="org-builtin">:keyword</span> #t #f nil <span class="org-string">"Hello world"</span> )

 $ lisp&gt;&gt; '(list (+ 1 2 3 4 5) (+ 1 2 3 4 5) '(* 4 100) (* 4 100) <span class="org-builtin">:keyword</span> #t #f nil <span class="org-string">"Hello world"</span>)
(  list (  + 1 2 3 4 5 ) (  + 1 2 3 4 5 ) (  quote (  * 4 100 ) ) (  * 4 100 ) <span class="org-builtin">:keyword</span> #t #f nil <span class="org-string">"Hello world"</span> )



 $ lisp&gt;&gt; (+ 1 2 3 4 5 6)
21
 $ lisp&gt;&gt; (* 1 2 3 4 5 6)
720

 $ lisp&gt;&gt; (list 1 2 3 5 6 7 8)
(  1 2 3 5 6 7 8 )

 $ lisp&gt;&gt; ( (<span class="org-keyword">if</span> (&lt; x  5) + *)  100 20)
2000

 $ lisp&gt;&gt; ( (<span class="org-keyword">if</span> (&lt; x  50) + *)  100 20)
120

$ lisp&gt;&gt; (set code <span class="org-string">"(apply + (list 1 3 4 5 6 7))"</span>)
 [TRACE] Defining symbol = code . 
nil

 $ lisp&gt;&gt; code
<span class="org-string">"(apply + (list 1 3 4 5 6 7))"</span>

 $ lisp&gt;&gt; (set expr (read code))<span class="org-comment">; read SExp - S-Expression from string</span>
 [TRACE] Defining symbol = expr . 
nil
 $ lisp&gt;&gt; expr
(  apply + (  list 1 3 4 5 6 7 ) )

 $ lisp&gt;&gt; (eval expr) <span class="org-comment-delimiter">;; </span><span class="org-comment">Evaluate S-Expression </span>
26

$ lisp&gt;&gt; <span class="org-builtin">:block</span>
 [INFO] Type a multi-line s-expression and type (<span class="org-comment-delimiter">;;</span><span class="org-comment">) as the last line when you are done. </span>
<span class="org-comment-delimiter">; </span><span class="org-comment">Execute a let-binding expression</span>
(<span class="org-keyword">let</span> (
      (a 10)
      (b (+ (* a a) 10))
      (c (sqrt (+ a b)))
     )
   (disp a) (disp b) (disp c)
   (list <span class="org-builtin">:x</span> a <span class="org-builtin">:y</span> b <span class="org-builtin">:result3</span> c <span class="org-builtin">:z</span> (+ a b c)))
<span class="org-comment-delimiter">;;</span>
10
110
10.9545
(  <span class="org-builtin">:x</span> 10 <span class="org-builtin">:y</span> 110 <span class="org-builtin">:result3</span> 10.9545 <span class="org-builtin">:z</span> 130.954 )

 $ lisp&gt;&gt; a
 [ERROR] Unbound variable a

 $ lisp&gt;&gt; b
 [ERROR] Unbound variable b

 $ lisp&gt;&gt; c
 [ERROR] Unbound variable c
 $ lisp&gt;&gt; 

 $ lisp&gt;&gt; (load-file <span class="org-string">"code.lisp"</span>) <span class="org-comment">; Load a lisp file</span>
 [TRACE] Defining symbol = mylist . 
 [TRACE] Defining symbol = code-fact . 
 [TRACE] Defining function = fib . 
 [TRACE] Defining function = make-adder . 
 [TRACE] Defining symbol = add10 . 
 [TRACE] Defining symbol = add50 . 
 [TRACE] Defining symbol = func . 
 [TRACE] Defining function = compute-trig . 
nil
 $ lisp&gt;&gt; 

 $ lisp&gt;&gt; mylist
(  10 #t #f <span class="org-string">"hello world"</span> hello world <span class="org-builtin">:keyword1</span> 41 (  + 10 25 6 ) <span class="org-builtin">:keyword2</span> 48 (  * 4 2 6 ) )

 $ lisp&gt;&gt; (car mylist)
10

 $ lisp&gt;&gt; (cdr mylist)
(  #t #f <span class="org-string">"hello world"</span> hello world <span class="org-builtin">:keyword1</span> 41 (  + 10 25 6 ) <span class="org-builtin">:keyword2</span> 48 (  * 4 2 6 ) )

 $ lisp&gt;&gt; (car (cdr mylist))
#t

$ lisp&gt;&gt; (nth 5 mylist)
world

 $ lisp&gt;&gt; (add10 20)
30

 $ lisp&gt;&gt; (add50 80)
130

 $ lisp&gt;&gt; (map add10 (list 1 2 3 4 5 6 7 ))
(  11 12 13 14 15 16 17 )

 $ lisp&gt;&gt; (map add50 (list 1 2 3 4 5 6 7 ))
(  51 52 53 54 55 56 57 )

 $ lisp&gt;&gt; (map (fn (x) (* x x)) (list 1 2 3 4 5 6 7 )) <span class="org-comment">; Map a lambda</span>
(  1 4 9 16 25 36 49 )

 $ lisp&gt;&gt; (compute-trig 45)
(  <span class="org-builtin">:angle</span> 45 <span class="org-builtin">:cos</span> 0.707123 <span class="org-builtin">:sin</span> 0.70709 <span class="org-builtin">:tan</span> 0.999954 )

 $ lisp&gt;&gt; (compute-trig 90)
(  <span class="org-builtin">:angle</span> 90 <span class="org-builtin">:cos</span> 4.63268e-05 <span class="org-builtin">:sin</span> 1 <span class="org-builtin">:tan</span> 21585.8 )

 $ lisp&gt;&gt; (compute-trig 30)
(  <span class="org-builtin">:angle</span> 30 <span class="org-builtin">:cos</span> 0.866033 <span class="org-builtin">:sin</span> 0.499987 <span class="org-builtin">:tan</span> 0.57733 )

 $ lisp&gt;&gt; (map compute-trig (list 30 90 45))
(  (  <span class="org-builtin">:angle</span> 30 <span class="org-builtin">:cos</span> 0.866033 <span class="org-builtin">:sin</span> 0.499987 <span class="org-builtin">:tan</span> 0.57733 ) (  <span class="org-builtin">:angle</span> 90 <span class="org-builtin">:cos</span> 4.63268e-05 <span class="org-builtin">:sin</span> 1 <span class="org-builtin">:tan</span> 21585.8 ) (  <span class="org-builtin">:angle</span> 45 <span class="org-builtin">:cos</span> 0.707123 <span class="org-builtin">:sin</span> 0.70709 <span class="org-builtin">:tan</span> 0.999954 ) )
</pre>
</div>
</div>
</div>

<div id="outline-container-org69da843" class="outline-4">
<h4 id="org69da843"><span class="section-number-4">1.11.3</span> Further Reading</h4>
<div class="outline-text-4" id="text-1-11-3">
<p>
Scheme and Lisp Introduction:
</p>

<ul class="org-ul">
<li><a href="https://beautifulracket.com/appendix/glossary.html#reader">Beautiful Racket: Glossary</a></li>

<li><a href="https://spritely.institute/static/papers/scheme-primer.html">A Scheme Primer</a>
<ul class="org-ul">
<li>Introduction to Scheme programming language.</li>
</ul></li>

<li><a href="http://axisofeval.blogspot.com/2010/08/three-principles-of-lisp.html">The Axis of Eval: Three Principles of Lisp</a></li>

<li><a href="http://calculist.org/blog/2012/04/17/homoiconicity-isnt-the-point/">Homoiconicity isnt the point</a></li>

<li><a href="https://beautifulracket.com/appendix/why-racket-why-lisp.html">Beautiful Racket: Why Racket? Why Lisp?</a></li>

<li><a href="http://www.paulgraham.com/rootsoflisp.html">The Roots of Lisp</a></li>

<li><a href="http://www.cs.virginia.edu/~evans/cs655/readings/steele.pdf">Growing a Language - Guy L. Steele Jr.</a></li>
</ul>

<p>
About how to implement Lisp-like dialects:
</p>

<ul class="org-ul">
<li><a href="https://norvig.com/lispy.html">(How to Write a (Lisp) Interpreter (in Python))</a></li>

<li><a href="http://norvig.com/lispy2.html">(An ((Even Better) Lisp) Interpreter (in Python))</a></li>

<li><a href="http://fogus.me/fun/lithp/">Lithp - A interpreter for John McCarthy's original Lisp.</a>
<ul class="org-ul">
<li>Interpreter written in Python in literate programming style.</li>
</ul></li>

<li>BOOK: <a href="https://en.m.wikibooks.org/wiki/Write_Yourself_a_Scheme_in_48_Hours">Write Yourself a Scheme in 48 Hours - Wikibooks, open books for an open world</a>
<ul class="org-ul">
<li>Scheme implementation in Haskell programming language, that can
be hard to understand for people not acquainted with Haskell.</li>
</ul></li>

<li>BOOK: <a href="https://wespiser.com/writings/wyas/00_overview.html">Write You A Scheme, Version 2.0</a>
<ul class="org-ul">
<li>Scheme implementation in Haskell.</li>
</ul></li>

<li>BOOK: <a href="https://www.buildyourownlisp.com">Learn C  Build Your Own Lisp</a></li>

<li>BOOK: <a href="http://t3x.org/lfn/">Lisp from nothing</a> 
<ul class="org-ul">
<li>Presents how to build a metacircular LISP interpreter in common
lisp; a metacircular lisp interpreter in Scheme; a self-hosting
lisp compiler and garbage collector.</li>
</ul></li>

<li>BOOK: <a href="https://lispcookbook.github.io/cl-cookbook/">The Common Lisp Cookbook</a></li>

<li>BOOK: <a href="https://sarabander.github.io/sicp/html/">Structure and Interpretation of Computer Programs, 2e: Top</a></li>

<li>BOOK: <a href="https://en.m.wikipedia.org/wiki/Structure_and_Interpretation_of_Classical_Mechanics">Structure and Interpretation of Classical Mechanics</a></li>

<li>BOOK: <a href="https://www.cs.cmu.edu/~dst/LispBook/">Common Lisp: A Gentle Introduction to Symbolic Computation</a></li>

<li><a href="https://kseo.github.io/posts/2016-12-30-write-you-an-interpreter.html">Kwang's Haskell Blog - Write you an interpreter</a>
<ul class="org-ul">
<li>Scheme implementation in Haskell.</li>
</ul></li>

<li><a href="http://kflu.github.io/2018/04/15/2018-04-15-implement-scheme/">How to write a Scheme interpreter  hello world </a> 
<ul class="org-ul">
<li>Implementation in .NET</li>
<li>Repository: <a href="https://github.com/Microsoft/schemy">https://github.com/Microsoft/schemy</a></li>
</ul></li>

<li><a href="http://peter.michaux.ca/articles/scheme-from-scratch-introduction">Scheme from Scratch - Introduction</a></li>

<li><a href="https://swatson555.github.io/posts/2022-05-06-make-a-lisp-2.html">Roll A Lisp In C - Evaluation</a></li>

<li><a href="https://github.com/rzubek/CSLisp">rzubek/CSLisp: C# Scheme - Lisp implementation for embedding in .NET projects</a></li>

<li><a href="https://brianmckenna.org/blog/sexp_scala">S-expression Compiler in Scala</a></li>

<li><a href="http://www.elizas.website/seax/implementation/secd.html">The SECD Abstract Machine</a></li>

<li><a href="https://eli.thegreenplace.net/2022/why-is-it-easy-to-implement-a-lisp/">Why is it easy to implement a Lisp? - Eli Bendersky's website</a></li>

<li><a href="https://www.cs.umd.edu/class/spring2022/cmsc430/Notes.html">CMSC 430:  Design and Implementation of Programming Languages</a></li>
</ul>


<p>
Lisp Variants: 
</p>

<ul class="org-ul">
<li><a href="https://janet-lang.org">Janet Programming Language</a> (akin to Clojure)</li>

<li><a href="https://github.com/picolisp/pil21">GitHub - picolisp/pil21: PicoLisp dialect</a></li>

<li><a href="https://github.com/programming-nu/nu">NU Lisp</a>
<ul class="org-ul">
<li>"Nu is an interpreted Lisp that builds on the Objective-C runtime and Foundation framework."</li>
</ul></li>

<li><a href="http://www.ulisp.com/show?2XZH">uLisp - ARM Assembler in Lisp</a></li>

<li><a href="http://lush.sourceforge.net/">http://lush.sourceforge.net/</a></li>

<li><a href="https://ccrma.stanford.edu/software/snd/snd/s7.html">s7 Scheme - Embedded Scripting Language</a></li>

<li>[PDF] <a href="https://3e8.org/pub/scheme/doc/lisp-pointers/v6i3/p71-petrus.pdf">SKILL: a Lisp Based Extension Language</a></li>

<li>[PDF] <a href="https://community.cadence.com/cfs-file/__key/telligent-evolution-components-attachments/00-28-01-00-00-01-04-75/CadScriptingLanguages_5F00_skill.pdf">A quick tour to skill programming language - Cadence CAD / Lisp.</a></li>

<li>PDF: <a href="https://perun.pmf.uns.ac.rs/radovanovic/publications/2002-prim-lisp.pdf">An implementation of LISPKIT Lisp in Java</a> (SECD Abstract Machine)</li>

<li><a href="http://www.lispme.de/lispme/doc/lm_hood.htm">LispMe internals</a>
<ul class="org-ul">
<li>This implementation uses a SECD Virtual Machine instead of a
recursive AST evaluator. The code is compiled to SECD machine
bytecodes and later executed by a SECD virtual machine.</li>
</ul></li>

<li><a href="http://kflu.github.io/2018/04/15/2018-04-15-implement-scheme/">How to write a Scheme interpreter  hello world </a> 
<ul class="org-ul">
<li>Implementation in .NET</li>
<li>Repository: <a href="https://github.com/Microsoft/schemy">https://github.com/Microsoft/schemy</a></li>
</ul></li>

<li>PDF: <a href="https://www.dreamsongs.com/Files/Timrep.pdf">Performance and Evaluation of Lisp Systems</a></li>

<li><a href="https://paulhammant.com/2013/03/28/interface-builders-alternative-lisp-timeline/">Interface Builder's Alternative Lisp timeline</a></li>

<li><a href="https://www.softwarepreservation.org/projects/LISP/le_lisp">Le_Lisp  Software Preservation Group</a></li>

<li><a href="https://gitlab.com/embeddable-common-lisp/ecl/">Embeddable Common-Lisp / ECL  GitLab</a></li>

<li><a href="https://www.isi.edu/isd/LOOM/Stella/index.html">STELLA Programming Language / Lisp that compiles to Java or C++ ; lisp</a></li>

<li><a href="https://github.com/kanaka/mal">GitHub - kanaka/mal: mal - Make a Lisp</a>
<ul class="org-ul">
<li>"Each implementation of mal is separated into 11 incremental,
self-contained (and testable) steps that demonstrate core
concepts of Lisp. The last step is capable of self-hosting
(running the mal implementation of mal). See the make-a-lisp
process guide. Mal is implemented in 87 languages (93 different
implementations and 115 runtime modes)."</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/Game_Oriented_Assembly_Lisp">Game Oriented Assembly Lisp - Wikipedia</a></li>

<li><a href="https://opengoal.dev">OpenGOAL | OpenGOAL</a></li>

<li><a href="https://www.gamedeveloper.com/design/postmortem-naughty-dog-s-i-jak-and-daxter-the-precursor-legacy-i-">Postmortem: Naughty Dog's Jak and Daxter: the Precursor Legacy</a></li>

<li><a href="https://all-things-andy-gavin.com/2011/03/12/making-crash-bandicoot-gool-part-9/">Making Crash Bandicoot  GOOL  part 9 - All Things Andy Gavin</a></li>
</ul>


<p>
Common Lisp:
</p>

<ul class="org-ul">
<li><a href="http://www.n-a-n-o.com/lisp/cmucl-tutorials/LISP-tutorial.html">Common LISP Hints - 1993</a></li>

<li><a href="https://mikelevins.github.io/posts/2020-12-18-repl-driven/">On repl-driven programming - by mikel evins</a></li>

<li><a href="https://journal.infinitenegativeutility.com/structurally-typed-condition-handling">Structurally-Typed Condition Handling  Infinite Negative Utility</a></li>

<li><a href="http://www.nhplace.com/kent/Papers/Condition-Handling-2001.html">Condition Handling in the Lisp Language Family'' c by Kent Pitman</a></li>

<li><a href="https://lisper.in/restarts">Common Lisp: A Tutorial on Conditions and Restarts</a></li>

<li><a href="https://www.kazimirmajorinc.com/Documents/On-Pitmans-Special-forms-in-Lisp/index.html">On Pitman's Special forms in Lisp</a></li>

<li><a href="https://ostash.dev/posts/2021-06-24-edn-data-notation/">Data notation in Clojure - Ostash.Dev</a></li>

<li><a href="http://www.lispworks.com/documentation/lw71/COM/html/com-11.htm#pgfId-889564">LispWorks - 1.7 Calling COM interface methods</a></li>

<li><a href="https://courses.cs.northwestern.edu/325/readings/clos.php">The Common Lisp Object System</a></li>

<li><a href="https://lisper.in/reader-macros">Reader Macros in Common Lisp</a></li>

<li><a href="https://gist.github.com/chaitanyagupta/9324402">Reader Macros in Common Lisp  GitHub</a></li>

<li><a href="https://www.lurklurk.org/cpp_clos.html">C++ and Lisp / multiple dispatch, multimethod, visitor design pattern</a></li>

<li><a href="https://borodust.org/delivering-common-lisp">Delivering games written in Common Lisp</a></li>

<li><a href="https://texdraft.github.io/lisp-compiler/internals.html">Lisp Compiler</a></li>
</ul>


<p>
S-Expression Parsing:
</p>

<ul class="org-ul">
<li><a href="https://wiki.c2.com/?EssExpressions">Wiki C2 - ESS Expressions</a></li>

<li><a href="https://rosettacode.org/w/index.php?title=S-expressions&amp;useformat=mobile">S-expressions - Rosetta Code</a></li>

<li><a href="https://learnxinyminutes.com/docs/edn/">Clojure EDN - Learn edn in Y Minutes</a></li>

<li><a href="https://gist.github.com/DmitrySoshnikov/2a434dda67019a4a7c37">S-expression parser  GitHub</a> (JavaScript)</li>

<li><a href="https://wiki.c2.com/?XmlIsaPoorCopyOfEssExpressions">WIKI C2 - Xml Isa Poor Copy Of Ess Expressions</a></li>

<li><a href="https://eli.thegreenplace.net/2012/03/04/some-thoughts-on-json-vs-s-expressions">Some thoughts on JSON vs. S-expressions</a></li>

<li><a href="https://wiki.c2.com/?ExampleOfGreenspunsTenthAtWork">Example Of Greenspuns Tenth At Work</a></li>

<li><a href="https://kitchingroup.cheme.cmu.edu/blog/2017/05/04/An-emacs-lisp-dsl-for-gnuplot/">An Emacs Lisp DSL for GNU Plot</a></li>

<li><a href="https://macoy.me/blog/programming/CakelispIntro">Cakelisp: a programming language for games</a></li>

<li><a href="https://people.csail.mit.edu/rivest/Sexp.txt">S-expressions data structure - Ron Rivest</a></li>

<li><a href="https://github.com/janestreet/sexplib">GitHub - janestreet/sexplib: Automated S-expression conversion</a>
<ul class="org-ul">
<li>OCaml S-Expression parser</li>
</ul></li>

<li><a href="https://dev.realworldocaml.org/data-serialization.html">Data Serialization with S-Expressions - Real World OCaml</a></li>

<li><a href="https://github.com/BitPuffin/sexpresso">https://github.com/BitPuffin/sexpresso</a>
<ul class="org-ul">
<li>C++ S-Expression parser library</li>
</ul></li>

<li><a href="https://github.com/SuperTux/sexp-cpp">https://github.com/SuperTux/sexp-cpp</a>
<ul class="org-ul">
<li>C++ S-Expression parser library (GPL 3)</li>
</ul></li>

<li><a href="https://hackage.haskell.org/package/s-cargot">s-cargot: A flexible, extensible s-expression library</a>
<ul class="org-ul">
<li>Haskell S-Expression parser. The description of this page also
tells how SExp can be used as storage format, serialization
format and data description language.</li>
</ul></li>

<li><a href="https://github.com/drslump/sexp-php">GitHub - drslump/sexp-php: S-expression parser and serializer for PHP</a></li>

<li><a href="https://srfi.schemers.org/srfi-110/srfi-110.html">SRFI 110: Sweet-expressions (t-expressions)</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2022-09-16 Fri 07:36</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
